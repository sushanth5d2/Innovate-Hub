<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Messages ‚Ä¢ Innovate</title>
  <link rel="stylesheet" href="/css/instagram.css">
</head>
<body class="ig-messages-page">
  <!-- Top Navigation -->
  <nav class="ig-top-nav">
    <div class="ig-nav-container">
      <a href="/home" class="ig-logo">Innovate</a>
      
      <div class="ig-search-box">
        <input type="text" class="ig-search-input" placeholder="Search messages" id="searchMessages">
      </div>
      
      <div class="ig-nav-icons">
        <div class="ig-nav-icon" onclick="window.location.href='/home'">
          <svg aria-label="Home" fill="none" height="24" viewBox="0 0 24 24" width="24">
            <path d="M9.005 16.545a2.997 2.997 0 0 1 2.997-2.997A2.997 2.997 0 0 1 15 16.545V22h7V11.543L12 2 2 11.543V22h7.005Z" fill="none" stroke="currentColor" stroke-linejoin="round" stroke-width="2"></path>
          </svg>
        </div>
        
        <div class="ig-nav-icon" onclick="window.location.href='/notifications'">
          <svg aria-label="Notifications" fill="none" height="24" viewBox="0 0 24 24" width="24" stroke="currentColor" stroke-width="2">
            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9M13.73 21a2 2 0 0 1-3.46 0" stroke-linecap="round" stroke-linejoin="round"></path>
          </svg>
        </div>
        
        <div class="ig-nav-icon" onclick="window.location.href='/profile/' + getCurrentUserId()">
          <img id="navProfilePic" src="" alt="Profile" style="width: 24px; height: 24px; border-radius: 50%; object-fit: cover;">
        </div>
      </div>
    </div>
  </nav>

  <!-- Messages Container -->
  <div class="ig-messages-container">
    <!-- Conversations List -->
    <div class="ig-conversations">
      <!-- Mobile Header -->
      <div class="ig-messages-mobile-header">
        <button class="ig-mobile-back" onclick="window.location.href='/home'">
          <svg fill="currentColor" height="24" viewBox="0 0 24 24" width="24">
            <path d="M21 11.25H5.81l6.22-6.22a.75.75 0 0 0-1.06-1.06l-7.5 7.5a.75.75 0 0 0 0 1.06l7.5 7.5a.75.75 0 0 0 1.06-1.06L5.81 12.75H21a.75.75 0 0 0 0-1.5Z"></path>
          </svg>
        </button>
        <div style="display: flex; align-items: center; gap: 8px; flex: 1;">
          <span class="ig-messages-username" id="currentUsername" style="font-size: 18px; font-weight: 600;">Loading...</span>
          <svg fill="currentColor" height="12" viewBox="0 0 24 24" width="12">
            <path d="M21 7.5l-9 9-9-9" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="3"></path>
          </svg>
        </div>
        <button class="ig-new-message-btn" onclick="newMessage()">
          <svg aria-label="New message" fill="none" height="24" viewBox="0 0 24 24" width="24" stroke="currentColor" stroke-width="2">
            <path d="M3 3h12l6 6v10a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z" stroke-linecap="round" stroke-linejoin="round"></path>
            <path d="M9 9h6M9 13h3" stroke-linecap="round" stroke-linejoin="round"></path>
          </svg>
        </button>
        <button class="ig-new-message-btn" onclick="newGroup()" title="New Group" style="margin-left: 8px;">
          <svg fill="none" height="24" viewBox="0 0 24 24" width="24" stroke="currentColor" stroke-width="2">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2M9 11a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75" stroke-linecap="round" stroke-linejoin="round"></path>
          </svg>
        </button>
      </div>

      <!-- Search Bar -->
      <div class="ig-messages-search">
        <svg aria-label="Search" fill="currentColor" height="16" viewBox="0 0 24 24" width="16" style="margin-right: 8px; color: var(--ig-secondary-text);">
          <path d="M19 10.5A8.5 8.5 0 1 1 10.5 2a8.5 8.5 0 0 1 8.5 8.5Z" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
          <line fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" x1="16.511" x2="22" y1="16.511" y2="22"></line>
        </svg>
        <input type="text" placeholder="Ask Meta AI or search" id="searchMessages" style="background: none; border: none; outline: none; color: var(--ig-primary-text); flex: 1; font-size: 14px;">
      </div>

      <!-- Messages/Requests Tabs -->
      <div class="ig-messages-tabs">
        <div class="ig-messages-tab active" id="messagesTab" onclick="switchMessagesTab('messages')">Messages</div>
        <div class="ig-messages-tab" id="requestsTab" onclick="switchMessagesTab('requests')">Requests</div>
      </div>
      
      <div class="ig-conversations-list" id="conversationsList">
        <div class="ig-spinner"></div>
      </div>
    </div>

    <!-- Chat Window -->
    <div class="ig-chat" id="chatWindow">
      <div class="ig-chat-header">
        <button class="ig-chat-back" onclick="closeChat()">
          <svg aria-label="Back" fill="currentColor" height="24" viewBox="0 0 24 24" width="24">
            <path d="M21 11.25H5.81l6.22-6.22a.75.75 0 0 0-1.06-1.06l-7.5 7.5a.75.75 0 0 0 0 1.06l7.5 7.5a.75.75 0 0 0 1.06-1.06L5.81 12.75H21a.75.75 0 0 0 0-1.5Z"></path>
          </svg>
        </button>
        <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
          <div id="chatAvatarContainer" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: var(--ig-secondary-background); border-radius: 50%;">
            <svg id="chatAvatarIcon" fill="none" height="24" viewBox="0 0 24 24" width="24" stroke="var(--ig-secondary-text)" stroke-width="2">
              <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <img id="chatAvatar" src="" alt="" class="ig-chat-avatar" style="display: none;">
          </div>
          <div style="flex: 1;">
            <div class="ig-chat-username" id="chatUsername">Select a conversation</div>
            <div class="ig-chat-status" id="chatStatus"></div>
          </div>
        </div>
        <div class="ig-chat-actions">
          <button class="ig-chat-action-btn" title="Details">
            <svg fill="none" height="24" viewBox="0 0 24 24" width="24" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10" stroke-linecap="round" stroke-linejoin="round"></circle>
              <path d="M12 16v-4M12 8h.01" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
          </button>
          <button class="ig-chat-action-btn" onclick="startVoiceCall()" title="Voice Call">
            <svg fill="none" height="24" viewBox="0 0 24 24" width="24" stroke="currentColor" stroke-width="2">
              <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
          </button>
          <button class="ig-chat-action-btn" onclick="startVideoCall()" title="Video Call">
            <svg fill="none" height="24" viewBox="0 0 24 24" width="24" stroke="currentColor" stroke-width="2">
              <path d="M23 7l-7 5 7 5V7z" stroke-linecap="round" stroke-linejoin="round"></path>
              <rect x="1" y="5" width="15" height="14" rx="2" ry="2" stroke-linecap="round" stroke-linejoin="round"></rect>
            </svg>
          </button>
        </div>
      </div>
      
      <div class="ig-chat-messages" id="chatMessages">
        <div style="text-align: center; color: var(--ig-secondary-text); padding: 60px 40px; display: flex; flex-direction: column; align-items: center; gap: 24px;">
          <div style="width: 96px; height: 96px; border-radius: 50%; background: var(--ig-secondary-background); display: flex; align-items: center; justify-content: center;">
            <svg fill="none" height="56" viewBox="0 0 24 24" width="56" stroke="var(--ig-secondary-text)" stroke-width="1.5">
              <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" stroke-linecap="round" stroke-linejoin="round"></path>
              <path d="M8 10h.01M12 10h.01M16 10h.01" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
            </svg>
          </div>
          <div>
            <div style="font-size: 20px; font-weight: 600; color: var(--ig-primary-text); margin-bottom: 8px;">Your messages</div>
            <div style="font-size: 14px;">Select a conversation to start messaging</div>
          </div>
        </div>
      </div>
      
      <!-- Reply/Edit Preview Container -->
      <div id="messagePreviewContainer" style="padding: 0 16px;"></div>
      
      <div class="ig-chat-input-container">
        <button class="ig-input-action-btn" onclick="toggleAttachMenu()" title="Add">
          <svg fill="none" height="24" viewBox="0 0 24 24" width="24" stroke="currentColor" stroke-width="2.5">
            <circle cx="12" cy="12" r="10" stroke-linecap="round"></circle>
            <path d="M12 8v8M8 12h8" stroke-linecap="round"></path>
          </svg>
        </button>
        
        <button class="ig-input-action-btn" onclick="openCamera()" title="Camera">
          <svg fill="none" height="24" viewBox="0 0 24 24" width="24" stroke="currentColor" stroke-width="2">
            <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z" stroke-linecap="round" stroke-linejoin="round"></path>
            <circle cx="12" cy="13" r="4" stroke-linecap="round" stroke-linejoin="round"></circle>
          </svg>
        </button>
        
        <input type="text" class="ig-chat-input" placeholder="Message..." id="messageInput" onkeypress="handleMessageKeyPress(event)">
        
        <label class="ig-input-action-btn" title="Gallery">
          <svg fill="none" height="24" viewBox="0 0 24 24" width="24" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2" stroke-linecap="round" stroke-linejoin="round"></rect>
            <circle cx="8.5" cy="8.5" r="1.5" fill="currentColor"></circle>
            <path d="M21 15l-5-5L5 21" stroke-linecap="round" stroke-linejoin="round"></path>
          </svg>
          <input type="file" accept="image/*" onchange="sendFile(this.files[0])" style="display: none;">
        </label>
        
        <button class="ig-input-action-btn" onclick="openEmojiPicker()" title="Emoji" id="emojiBtn">
          <svg fill="none" height="24" viewBox="0 0 24 24" width="24" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10" stroke-linecap="round" stroke-linejoin="round"></circle>
            <path d="M8 14s1.5 2 4 2 4-2 4-2M9 9h.01M15 9h.01" stroke-linecap="round" stroke-linejoin="round"></path>
          </svg>
        </button>
        
        <button class="ig-input-action-btn ig-voice-btn" onmousedown="startVoiceRecording()" onmouseup="stopVoiceRecording()" ontouchstart="startVoiceRecording()" ontouchend="stopVoiceRecording()" title="Voice" id="voiceBtn">
          <svg fill="none" height="24" viewBox="0 0 24 24" width="24" stroke="currentColor" stroke-width="2">
            <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z" stroke-linecap="round" stroke-linejoin="round"></path>
            <path d="M19 10v2a7 7 0 0 1-14 0v-2M12 19v4M8 23h8" stroke-linecap="round" stroke-linejoin="round"></path>
          </svg>
        </button>
        
        <div class="ig-attach-menu" id="attachMenu" style="display: none;">
          <button class="ig-attach-option" onclick="openMapPicker()">
            <svg fill="none" height="22" viewBox="0 0 24 24" width="22" stroke="currentColor" stroke-width="2">
              <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" stroke-linecap="round" stroke-linejoin="round"></path>
              <circle cx="12" cy="10" r="3" stroke-linecap="round" stroke-linejoin="round"></circle>
            </svg>
            Location
          </button>
          <label class="ig-attach-option">
            <svg fill="none" height="22" viewBox="0 0 24 24" width="22" stroke="currentColor" stroke-width="2">
              <path d="M23 7l-7 5 7 5V7z" stroke-linecap="round" stroke-linejoin="round"></path>
              <rect x="1" y="5" width="15" height="14" rx="2" ry="2" stroke-linecap="round" stroke-linejoin="round"></rect>
            </svg>
            Video
            <input type="file" accept="video/*" onchange="sendFile(this.files[0])" style="display: none;">
          </label>
          <label class="ig-attach-option">
            <svg fill="none" height="22" viewBox="0 0 24 24" width="22" stroke="currentColor" stroke-width="2">
              <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z" stroke-linecap="round" stroke-linejoin="round"></path>
              <path d="M13 2v7h7" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            Document
            <input type="file" accept=".pdf,.doc,.docx,.txt" onchange="sendFile(this.files[0])" style="display: none;">
          </label>
          <button class="ig-attach-option" onclick="openGifPicker()">
            <svg fill="none" height="22" viewBox="0 0 24 24" width="22" stroke="currentColor" stroke-width="2">
              <rect x="2" y="2" width="20" height="20" rx="2.18" ry="2.18" stroke-linecap="round" stroke-linejoin="round"></rect>
              <path d="M7 8h3v8H7zM14 8v4h3M14 16h3" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            GIF
          </button>
          <button class="ig-attach-option" onclick="openTodoCreator()">
            <svg fill="none" height="22" viewBox="0 0 24 24" width="22" stroke="currentColor" stroke-width="2">
              <path d="M9 11l3 3L22 4" stroke-linecap="round" stroke-linejoin="round"></path>
              <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            TODO List
          </button>
          <button class="ig-attach-option" onclick="openTimerPicker()">
            <svg fill="none" height="22" viewBox="0 0 24 24" width="22" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="13" r="9" stroke-linecap="round" stroke-linejoin="round"></circle>
              <path d="M12 7v6l4 2M10 2h4" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            Timer
          </button>
        </div>
        
        <button class="ig-send-btn" onclick="sendMessage()" style="display: none;" id="sendBtn">
          <svg aria-label="Send" fill="currentColor" height="24" viewBox="0 0 24 24" width="24">
            <path d="M1.464 12.986 23.963.863a.5.5 0 0 1 .71.627l-5.24 20.618a.5.5 0 0 1-.925.114l-5.14-9.47-9.472-5.138a.5.5 0 0 1 .115-.925l-.547.297Z" stroke="currentColor" fill="none" stroke-linejoin="round"></path>
          </svg>
        </button>
      </div>
      
      <!-- Message Context Menu -->
      <div id="messageContextMenu" class="ig-message-context-menu">
        <button class="ig-message-context-item" onclick="replyToMessage(event)">
          <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path d="M3 10h10a8 8 0 0 1 8 8v2M3 10l6 6m-6-6l6-6" stroke-linecap="round" stroke-linejoin="round"></path>
          </svg>
          Reply
        </button>
        <button class="ig-message-context-item" onclick="copyMessage(event)">
          <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <rect x="9" y="9" width="13" height="13" rx="2" ry="2" stroke-linecap="round" stroke-linejoin="round"></rect>
            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" stroke-linecap="round" stroke-linejoin="round"></path>
          </svg>
          Copy
        </button>
        <button class="ig-message-context-item" onclick="forwardMessage(event)">
          <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path d="M21 10h-10a8 8 0 0 0-8 8v2M21 10l-6 6m6-6l-6-6" stroke-linecap="round" stroke-linejoin="round"></path>
          </svg>
          Forward
        </button>
        <button class="ig-message-context-item" onclick="pinMessage(event)">
          <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path d="M12 17v5m-7-5l7-7 7 7M9 4v3l3 3 3-3V4" stroke-linecap="round" stroke-linejoin="round"></path>
          </svg>
          Pin
        </button>
        <button class="ig-message-context-item" onclick="starMessage(event)">
          <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" stroke-linecap="round" stroke-linejoin="round"></path>
          </svg>
          Star
        </button>
        <div class="ig-message-context-divider"></div>
        <button class="ig-message-context-item" onclick="editMessage(event)">
          <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" stroke-linecap="round" stroke-linejoin="round"></path>
          </svg>
          Edit
        </button>
        <button class="ig-message-context-item" onclick="messageInfo(event)">
          <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10" stroke-linecap="round" stroke-linejoin="round"></circle>
            <path d="M12 16v-4M12 8h.01" stroke-linecap="round" stroke-linejoin="round"></path>
          </svg>
          Info
        </button>
        <div class="ig-message-context-divider"></div>
        <button class="ig-message-context-item danger" onclick="deleteMessage(event)">
          <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2M10 11v6M14 11v6" stroke-linecap="round" stroke-linejoin="round"></path>
          </svg>
          Delete
        </button>
      </div>
      
      <!-- Message Actions Modal -->
      <div id="messageActionsModal" class="ig-modal" style="display: none;">
        <div class="ig-modal-backdrop" onclick="closeMessageActions()"></div>
        <div class="ig-message-actions-menu">
          <button class="ig-message-action" onclick="replyToMessage()">
            <svg fill="currentColor" height="20" viewBox="0 0 24 24" width="20">
              <path d="M10 9V5l-7 7 7 7v-4.1c5 0 8.5 1.6 11 5.1-1-5-4-10-11-11z"></path>
            </svg>
            Reply
          </button>
          <button class="ig-message-action" onclick="copyMessage()">
            <svg fill="currentColor" height="20" viewBox="0 0 24 24" width="20">
              <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"></path>
            </svg>
            Copy
          </button>
          <button class="ig-message-action" onclick="forwardMessage()">
            <svg fill="currentColor" height="20" viewBox="0 0 24 24" width="20">
              <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"></path>
            </svg>
            Forward
          </button>
          <button class="ig-message-action" onclick="deleteMessage()">
            <svg fill="currentColor" height="20" viewBox="0 0 24 24" width="20">
              <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"></path>
            </svg>
            Delete
          </button>
          <button class="ig-message-action" onclick="editMessage()

" id="editBtn" style="display: none;">
            <svg fill="currentColor" height="20" viewBox="0 0 24 24" width="20">
              <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"></path>
            </svg>
            Edit
          </button>
          <button class="ig-message-action" onclick="unsendMessage()" id="unsendBtn" style="display: none;">
            <svg fill="currentColor" height="20" viewBox="0 0 24 24" width="20">
              <path d="M12.5 8c-2.65 0-5.05.99-6.9 2.6L2 7v9h9l-3.62-3.62c1.39-1.16 3.16-1.88 5.12-1.88 3.54 0 6.55 2.31 7.6 5.5l2.37-.78C21.08 11.03 17.15 8 12.5 8z"></path>
            </svg>
            Unsend
          </button>
        </div>
      </div>

      <!-- Emoji Picker Modal -->
      <div id="emojiModal" class="ig-modal" style="display: none; z-index: 99999;">
        <div class="ig-modal-backdrop" onclick="closeEmojiPicker()" style="z-index: 99998;"></div>
        <div class="ig-emoji-picker" style="z-index: 99999;">
          <div class="ig-emoji-header" style="display: flex; align-items: center; padding: 12px; border-bottom: 1px solid var(--ig-border);">
            <button id="emojiTab" class="ig-emoji-tab active" onclick="switchEmojiTab('emoji')" style="flex: 1; padding: 8px; background: none; border: none; color: var(--ig-primary-text); font-weight: 600; cursor: pointer; border-bottom: 2px solid var(--ig-blue);">Emojis</button>
            <button id="gifTab" class="ig-emoji-tab" onclick="switchEmojiTab('gif')" style="flex: 1; padding: 8px; background: none; border: none; color: var(--ig-secondary-text); font-weight: 600; cursor: pointer; border-bottom: 2px solid transparent;">GIFs</button>
            <button onclick="closeEmojiPicker()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--ig-primary-text); margin-left: 8px;">&times;</button>
          </div>
          <div id="emojiContent" style="display: block;">
            <div class="ig-emoji-grid" id="emojiGrid"></div>
          </div>
          <div id="gifContent" style="display: none;">
            <input type="text" id="gifSearchInPicker" placeholder="Search GIFs..." onkeyup="searchGifsInPicker(this.value)" style="width: calc(100% - 24px); margin: 12px; padding: 8px 12px; border: 1px solid var(--ig-border); border-radius: 8px; background: var(--ig-secondary-background); color: var(--ig-primary-text);">
            <div id="gifGridInPicker" style="padding: 0 12px 12px 12px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; overflow-y: auto; max-height: 300px;">
              <div style="text-align: center; padding: 40px; grid-column: 1/-1; color: var(--ig-secondary-text);">Search for GIFs...</div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Camera Modal -->
      <div id="cameraModal" class="ig-modal" style="display: none;">
        <div class="ig-modal-content" style="max-width: 600px;">
          <div class="ig-modal-header">
            <h3>Take Photo</h3>
            <button onclick="closeCameraModal()">&times;</button>
          </div>
          <video id="cameraPreview" autoplay playsinline style="width: 100%; border-radius: 8px;"></video>
          <canvas id="cameraCanvas" style="display: none;"></canvas>
          <div style="padding: 16px; display: flex; gap: 12px; justify-content: center;">
            <button class="ig-btn-secondary" onclick="closeCameraModal()">Cancel</button>
            <button class="ig-btn-primary" onclick="capturePhoto()">Capture</button>
          </div>
        </div>
      </div>

      <!-- GIF Picker Modal -->
      <div id="gifModal" class="ig-modal" style="display: none;">
        <div class="ig-modal-backdrop" onclick="closeGifPicker()"></div>
        <div class="ig-emoji-picker" style="max-height: 500px;">
          <div class="ig-emoji-header">
            <h3>Choose a GIF</h3>
            <input type="text" id="gifSearch" placeholder="Search GIFs..." onkeyup="searchGifs(this.value)" style="flex: 1; margin: 0 12px; padding: 8px 12px; border: 1px solid var(--ig-border); border-radius: 8px; background: var(--ig-secondary-background); color: var(--ig-primary-text);">
            <button onclick="closeGifPicker()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--ig-primary-text);">&times;</button>
          </div>
          <div id="gifGrid" style="padding: 12px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; overflow-y: auto; max-height: 350px;">
            <div style="text-align: center; padding: 40px; grid-column: 1/-1; color: var(--ig-secondary-text);">Search for GIFs...</div>
          </div>
        </div>
      </div>

      <!-- TODO List Creator Modal -->
      <div id="todoModal" class="ig-modal" style="display: none;">
        <div class="ig-modal-backdrop" onclick="closeTodoCreator()"></div>
        <div class="ig-modal-content" style="max-width: 400px;">
          <div class="ig-modal-header">
            <h3>Create TODO List</h3>
            <button onclick="closeTodoCreator()">&times;</button>
          </div>
          <div style="padding: 16px;">
            <input type="text" id="todoTitle" placeholder="List title..." style="width: 100%; padding: 12px; border: 1px solid var(--ig-border); border-radius: 8px; background: var(--ig-secondary-background); color: var(--ig-primary-text); margin-bottom: 12px;">
            <div id="todoItems" style="margin-bottom: 12px;"></div>
            <button onclick="addTodoItem()" style="width: 100%; padding: 10px; background: var(--ig-secondary-background); border: 1px dashed var(--ig-border); border-radius: 8px; cursor: pointer; color: var(--ig-primary-text); margin-bottom: 12px;">+ Add Item</button>
            <div style="display: flex; gap: 12px;">
              <button class="ig-btn-secondary" onclick="closeTodoCreator()" style="flex: 1;">Cancel</button>
              <button class="ig-btn-primary" onclick="sendTodoList()" style="flex: 1;">Send</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Timer Picker Modal -->
      <div id="timerModal" class="ig-modal" style="display: none;">
        <div class="ig-modal-backdrop" onclick="closeTimerPicker()"></div>
        <div class="ig-modal-content" style="max-width: 350px;">
          <div class="ig-modal-header">
            <h3>Disappearing Message</h3>
            <button onclick="closeTimerPicker()">&times;</button>
          </div>
          <div style="padding: 16px;">
            <p style="color: var(--ig-secondary-text); margin-bottom: 16px; font-size: 14px;">Message will disappear after:</p>
            <div style="display: grid; gap: 8px;">
              <button class="ig-timer-option" onclick="setMessageTimer(10)">10 seconds</button>
              <button class="ig-timer-option" onclick="setMessageTimer(30)">30 seconds</button>
              <button class="ig-timer-option" onclick="setMessageTimer(60)">1 minute</button>
              <button class="ig-timer-option" onclick="setMessageTimer(300)">5 minutes</button>
              <button class="ig-timer-option" onclick="setMessageTimer(3600)">1 hour</button>
              <button class="ig-timer-option" onclick="setMessageTimer(86400)">24 hours</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Map Location Picker Modal -->
      <div id="mapModal" class="ig-modal" style="display: none;">
        <div class="ig-modal-backdrop" onclick="closeMapPicker()"></div>
        <div class="ig-modal-content" style="max-width: 600px;">
          <div class="ig-modal-header">
            <h3>Share Location</h3>
            <button onclick="closeMapPicker()">&times;</button>
          </div>
          <div style="padding: 16px;">
            <div id="mapContainer" style="width: 100%; height: 300px; background: var(--ig-secondary-background); border-radius: 8px; margin-bottom: 12px; position: relative; overflow: hidden; cursor: crosshair;" onclick="selectPointOnMap(event)">
              <div id="mapPin" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 32px;">üìç</div>
              <div id="mapCoords" style="position: absolute; bottom: 8px; left: 8px; background: rgba(0,0,0,0.7); color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;"></div>
            </div>
            <div style="display: flex; gap: 12px; margin-bottom: 12px;">
              <button class="ig-btn-secondary" onclick="useCurrentLocation()" style="flex: 1;">Use Current Location</button>
            </div>
            <div style="display: flex; gap: 12px;">
              <button class="ig-btn-secondary" onclick="closeMapPicker()" style="flex: 1;">Cancel</button>
              <button class="ig-btn-primary" onclick="sendSelectedLocation()" style="flex: 1;">Send Location</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom Navigation -->
  <nav class="ig-bottom-nav">
    <a href="/home" class="ig-bottom-nav-item">
      <svg aria-label="Home" viewBox="0 0 24 24" width="24">
        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
        <polyline points="9 22 9 12 15 12 15 22" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <span class="ig-bottom-nav-label">Home</span>
    </a>
    <a href="/communities" class="ig-bottom-nav-item">
      <svg aria-label="Communities" viewBox="0 0 24 24" width="24">
        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
        <circle cx="9" cy="7" r="4" stroke="currentColor" stroke-width="2" fill="none"/>
        <path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <span class="ig-bottom-nav-label">Communities</span>
    </a>
    <a href="/events" class="ig-bottom-nav-item">
      <svg aria-label="Events" viewBox="0 0 24 24" width="24">
        <rect x="3" y="4" width="18" height="18" rx="2" ry="2" stroke="currentColor" stroke-width="2" fill="none"/>
        <line x1="16" y1="2" x2="16" y2="6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <line x1="8" y1="2" x2="8" y2="6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <line x1="3" y1="10" x2="21" y2="10" stroke="currentColor" stroke-width="2"/>
      </svg>
      <span class="ig-bottom-nav-label">Events</span>
    </a>
    <a href="/home" class="ig-bottom-nav-item" onclick="event.preventDefault(); openCreatePostModal();">
      <svg aria-label="Create" viewBox="0 0 24 24" width="24">
        <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"/>
      </svg>
      <span class="ig-bottom-nav-label">Create</span>
    </a>
    <a href="/social-service" class="ig-bottom-nav-item">
      <svg aria-label="Social Service" viewBox="0 0 24 24" width="24">
        <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <span class="ig-bottom-nav-label">Service</span>
    </a>
    <a href="/search" class="ig-bottom-nav-item">
      <svg aria-label="Search" viewBox="0 0 24 24" width="24">
        <circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2" fill="none"/>
        <line x1="21" y1="21" x2="16.65" y2="16.65" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
      <span class="ig-bottom-nav-label">Search</span>
    </a>
    <a href="#" class="ig-bottom-nav-item" id="profileNavLink" onclick="navigateToProfile(event)">
      <svg aria-label="Profile" viewBox="0 0 24 24" width="24">
        <circle cx="12" cy="7" r="4" stroke="currentColor" stroke-width="2" fill="none"/>
        <path d="M5.5 21v-2a7.5 7.5 0 0 1 13 0v2" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/>
      </svg>
      <span class="ig-bottom-nav-label">Profile</span>
    </a>
  </nav>

  <script>
    function navigateToProfile(e) {
      e.preventDefault();
      const user = InnovateAPI.getCurrentUser();
      if (user && user.id) {
        window.location.href = `/profile/${user.id}`;
      }
    }
  </script>

  <!-- Call Modals -->
  <!-- Incoming Call Modal -->
  <div id="incomingCallModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 999999; align-items: center; justify-content: center;">
    <div style="background: var(--ig-primary-background); border-radius: 20px; padding: 40px; text-align: center; max-width: 400px; width: 90%;">
      <img id="incomingCallAvatar" src="" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; margin-bottom: 20px;">
      <h2 id="incomingCallName" style="margin-bottom: 10px; color: var(--ig-primary-text);">User</h2>
      <p id="incomingCallType" style="color: var(--ig-secondary-text); margin-bottom: 40px;">Incoming call...</p>
      <div style="display: flex; gap: 20px; justify-content: center;">
        <button onclick="rejectCall()" style="width: 60px; height: 60px; border-radius: 50%; background: #ed4956; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center;">
          <svg fill="white" height="30" viewBox="0 0 24 24" width="30">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm0-4h-2V7h2v8z"/>
          </svg>
        </button>
        <button onclick="acceptCall()" style="width: 60px; height: 60px; border-radius: 50%; background: #0095f6; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center;">
          <svg fill="white" height="30" viewBox="0 0 24 24" width="30">
            <path d="M20.01 15.38c-1.23 0-2.42-.2-3.53-.56-.35-.12-.74-.03-1.01.24l-1.57 1.97c-2.83-1.35-5.48-3.9-6.89-6.83l1.95-1.66c.27-.28.35-.67.24-1.02-.37-1.11-.56-2.3-.56-3.53 0-.54-.45-.99-.99-.99H4.19C3.65 3 3 3.24 3 3.99 3 13.28 10.73 21 20.01 21c.71 0 .99-.63.99-1.18v-3.45c0-.54-.45-.99-.99-.99z"/>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <!-- Active Call Modal -->
  <div id="activeCallModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #000; z-index: 999999; flex-direction: column;">
    <div style="flex: 1; position: relative; display: flex; align-items: center; justify-content: center;">
      <video id="remoteVideo" autoplay playsinline style="width: 100%; height: 100%; object-fit: cover;"></video>
      <video id="localVideo" autoplay playsinline muted style="position: absolute; bottom: 20px; right: 20px; width: 150px; height: 200px; border-radius: 12px; object-fit: cover; border: 2px solid white;"></video>
      
      <!-- Call info overlay -->
      <div id="callInfoOverlay" style="position: absolute; top: 40px; left: 50%; transform: translateX(-50%); text-align: center; color: white; background: rgba(0,0,0,0.5); padding: 20px 30px; border-radius: 12px;">
        <img id="activeCallAvatar" src="" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; margin-bottom: 12px;">
        <h3 id="activeCallName" style="margin-bottom: 8px;">User</h3>
        <p id="callDuration" style="opacity: 0.8; font-size: 14px;">00:00</p>
      </div>
    </div>
    
    <!-- Call controls -->
    <div style="padding: 30px; display: flex; gap: 20px; justify-content: center; align-items: center; background: rgba(0,0,0,0.8);">
      <button id="muteBtn" onclick="toggleMute()" style="width: 60px; height: 60px; border-radius: 50%; background: rgba(255,255,255,0.2); border: none; cursor: pointer; display: flex; align-items: center; justify-content: center;" title="Mute">
        <svg fill="white" height="24" viewBox="0 0 24 24" width="24">
          <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
          <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
        </svg>
      </button>
      <button id="videoBtn" onclick="toggleVideo()" style="width: 60px; height: 60px; border-radius: 50%; background: rgba(255,255,255,0.2); border: none; cursor: pointer; display: flex; align-items: center; justify-content: center;" title="Video">
        <svg fill="white" height="24" viewBox="0 0 24 24" width="24">
          <path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/>
        </svg>
      </button>
      <button onclick="endCall()" style="width: 70px; height: 70px; border-radius: 50%; background: #ed4956; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center;" title="End Call">
        <svg fill="white" height="32" viewBox="0 0 24 24" width="32">
          <path d="M12 9c-1.6 0-3.15.25-4.6.72v3.1c0 .39-.23.74-.56.9-.98.49-1.87 1.12-2.66 1.85-.18.18-.43.28-.7.28-.28 0-.53-.11-.71-.29L.29 13.08c-.18-.17-.29-.42-.29-.7 0-.28.11-.53.29-.71C3.34 8.78 7.46 7 12 7s8.66 1.78 11.71 4.67c.18.18.29.43.29.71 0 .28-.11.53-.29.71l-2.48 2.48c-.18.18-.43.29-.71.29-.27 0-.52-.11-.7-.28-.79-.74-1.69-1.36-2.67-1.85-.33-.16-.56-.5-.56-.9v-3.1C15.15 9.25 13.6 9 12 9z"/>
        </svg>
      </button>
      <button onclick="toggleSpeaker()" style="width: 60px; height: 60px; border-radius: 50%; background: rgba(255,255,255,0.2); border: none; cursor: pointer; display: flex; align-items: center; justify-content: center;" title="Speaker">
        <svg fill="white" height="24" viewBox="0 0 24 24" width="24">
          <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/>
        </svg>
      </button>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script src="/js/app.js"></script>
  <script src="/js/instagram-theme.js"></script>
  <script>
    InnovateAPI.requireAuth();
    InnovateAPI.initializePage();
    InnovateAPI.initSocket();

    const user = InnovateAPI.getCurrentUser();
    let currentContactId = null;
    let conversations = [];

    function getCurrentUserId() {
      return user.id;
    }

    // Load user info
    async function loadUserInfo() {
      try {
        const data = await InnovateAPI.apiRequest(`/users/${user.id}`);
        const avatar = InnovateAPI.getUserAvatar(data.user.profile_picture);
        const navProfilePic = document.getElementById('navProfilePic');
        if (navProfilePic) navProfilePic.src = avatar;
        const currentUsernameEl = document.getElementById('currentUsername');
        if (currentUsernameEl && data.user.username) {
          currentUsernameEl.textContent = data.user.username;
        }
        // Update profile link in navigation
        const profileLink = document.querySelector('.ig-bottom-nav-item[href^="/profile/"]');
        if (profileLink) {
          profileLink.href = `/profile/${user.id}`;
        }
      } catch (error) {
        console.error('Error loading user info:', error);
      }
    }

    // Load conversations
    async function loadConversations() {
      try {
        const data = await InnovateAPI.apiRequest('/messages/conversations');
        conversations = data.conversations;
        console.log('Conversations loaded and rendering:', conversations.length);
        renderConversations(conversations);
        return conversations;
      } catch (error) {
        console.error('Error loading conversations:', error);
        document.getElementById('conversationsList').innerHTML = 
          '<div style="text-align: center; padding: 40px; color: var(--ig-secondary-text);">Error loading conversations</div>';
        return [];
      }
    }

    // Format message preview based on type
    function formatMessagePreview(message, type, filename) {
      if (!message) return 'Start a conversation';
      
      switch(type) {
        case 'image':
          return 'üì∑ Photo';
        case 'video':
          return 'üé¨ Video';
        case 'voice':
          return 'üé§ Voice message';
        case 'gif':
          return 'üéûÔ∏è GIF';
        case 'location':
          return 'üìç Location';
        case 'file':
          if (filename) {
            if (filename.match(/\.(pdf)$/i)) return 'üìÑ PDF';
            if (filename.match(/\.(doc|docx)$/i)) return 'üìù Document';
            if (filename.match(/\.(xls|xlsx)$/i)) return 'üìä Spreadsheet';
            if (filename.match(/\.(txt)$/i)) return 'üìÉ Text file';
          }
          return 'üìé File';
        case 'todo':
          try {
            const todo = JSON.parse(message);
            return `‚úì ${todo.title || 'Todo list'}`;
          } catch {
            return '‚úì Todo list';
          }
        default:
          // For text messages, truncate if too long
          return message.length > 40 ? message.substring(0, 40) + '...' : message;
      }
    }

    // Render conversations
    function renderConversations(convos) {
      const list = document.getElementById('conversationsList');
      list.innerHTML = '';

      if (convos.length === 0) {
        list.innerHTML = `
          <div style="text-align: center; padding: 40px; color: var(--ig-secondary-text);">
            <div style="font-size: 24px; margin-bottom: 8px;">üì®</div>
            <div>No messages yet</div>
            <div style="font-size: 12px; margin-top: 4px;">Start a conversation</div>
          </div>
        `;
        return;
      }

      // AI Assistant entry at top
      const aiEl = document.createElement('div');
      aiEl.className = `ig-conversation ${currentContactId === 'ai-assistant' ? 'active' : ''}`;
      aiEl.id = 'ai-assistant-conversation';
      aiEl.innerHTML = `
        <div style="width: 56px; height: 56px; min-width: 56px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center;">
          <svg fill="white" height="28" viewBox="0 0 24 24" width="28"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
        </div>
        <div class="ig-conversation-info">
          <div class="ig-conversation-name" style="display: flex; align-items: center; gap: 6px;">
            Innovate AI
            <span style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; font-size: 9px; padding: 1px 6px; border-radius: 10px; font-weight: 600;">AI</span>
          </div>
          <div class="ig-conversation-message">Ask me anything ‚Ä¢ Multi-model AI</div>
        </div>
        <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 4px;">
          <div class="ig-conversation-time" style="color: #667eea; font-weight: 600; font-size: 10px;">Online</div>
        </div>
      `;
      aiEl.onclick = () => openAIChat();
      list.appendChild(aiEl);

      convos.forEach(conv => {
        const convEl = document.createElement('div');
        convEl.className = `ig-conversation ${currentContactId === conv.contact_id ? 'active' : ''}`;
        
        const isUnread = conv.unread_count > 0;
        const messageClass = isUnread ? 'ig-conversation-message unread' : 'ig-conversation-message';
        const messagePreview = formatMessagePreview(conv.last_message, conv.last_message_type, conv.last_message_filename);
        
        convEl.innerHTML = `
          <a href="/profile/${conv.contact_id}" onclick="event.stopPropagation()" title="View profile">
            <img src="${InnovateAPI.getUserAvatar(conv.profile_picture)}" alt="${conv.username}" class="ig-conversation-avatar" style="cursor:pointer;">
          </a>
          <div class="ig-conversation-info">
            <div class="ig-conversation-name"><a href="/profile/${conv.contact_id}" onclick="event.stopPropagation()" style="text-decoration:none; color: inherit;">${conv.username}</a></div>
            <div class="${messageClass}">${messagePreview}</div>
          </div>
          <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 4px;">
            <div class="ig-conversation-time">${conv.last_message_time ? formatTime(conv.last_message_time) : ''}</div>
            <button class="ig-conversation-camera" onclick="event.stopPropagation(); openCameraForUser(${conv.contact_id})">
              <svg fill="currentColor" height="20" viewBox="0 0 24 24" width="20">
                <path d="M6.827 6.175A2.31 2.31 0 0 1 5.186 7.23h-.005A2.31 2.31 0 0 1 3.54 6.175L1.945 4.581a.75.75 0 0 1 1.06-1.06l1.595 1.594a.767.767 0 0 0 .544.226.767.767 0 0 0 .543-.226L7.281 3.52a.75.75 0 0 1 1.061 1.06L6.827 6.175Z" fill-rule="evenodd"></path>
                <path d="M2.25 12a9.75 9.75 0 1 1 19.5 0 9.75 9.75 0 0 1-19.5 0Zm9.75-8.25a8.25 8.25 0 1 0 0 16.5 8.25 8.25 0 0 0 0-16.5Zm0 12.5a4.25 4.25 0 1 1 0-8.5 4.25 4.25 0 0 1 0 8.5Zm0-1.5a2.75 2.75 0 1 0 0-5.5 2.75 2.75 0 0 0 0 5.5Z"></path>
              </svg>
            </button>
            ${isUnread ? '<div class="ig-conversation-unread"></div>' : ''}
          </div>
        `;
        
        convEl.onclick = () => openChat(conv.contact_id, conv.username, conv.profile_picture);
        list.appendChild(convEl);
      });

      // After rendering DMs, also render groups
      renderGroupsSection();
    }

    async function renderGroupsSection() {
      try {
        const data = await InnovateAPI.apiRequest('/groups');
        const groups = data.groups || [];
        const list = document.getElementById('conversationsList');
        if (groups.length === 0) return;

        // Section header
        const header = document.createElement('div');
        header.style.cssText = 'padding: 8px 20px; font-size: 12px; color: var(--ig-secondary-text); border-top: 1px solid var(--ig-border);';
        header.textContent = 'Groups';
        list.appendChild(header);

        groups.forEach(group => {
          const convEl = document.createElement('div');
          convEl.className = 'ig-conversation';
          const preview = formatMessagePreview(group.last_message, group.last_message_type);
          convEl.innerHTML = `
            <div>
              <img src="/images/default-avatar.svg" alt="${group.name}" class="ig-conversation-avatar" style="cursor:pointer;">
            </div>
            <div class="ig-conversation-info">
              <div class="ig-conversation-name">${group.name}</div>
              <div class="ig-conversation-message">${preview || 'Group ‚Ä¢ ' + (group.member_count || 0) + ' members'}</div>
            </div>
            <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 4px;">
              <div class="ig-conversation-time">${group.last_message_time ? formatTime(group.last_message_time) : ''}</div>
              ${group.unread_count > 0 ? '<div class="ig-conversation-unread"></div>' : ''}
            </div>
          `;
          convEl.onclick = () => openGroupChat(group.id, group.name);
          list.appendChild(convEl);
        });
      } catch (error) {
        console.error('Error loading groups:', error);
      }
    }

    // Current group chat state
    let currentGroupId = null;

    // Open chat
    async function openChat(contactId, username, profilePicture) {
      currentContactId = contactId;
      currentGroupId = null;
      
      // Update UI
      const chatAvatarEl = document.getElementById('chatAvatar');
      const chatAvatarIcon = document.getElementById('chatAvatarIcon');
      const chatAvatarContainer = document.getElementById('chatAvatarContainer');
      const chatUsernameEl = document.getElementById('chatUsername');
      
      // Show avatar image, hide default icon
      chatAvatarEl.src = InnovateAPI.getUserAvatar(profilePicture);
      chatAvatarEl.style.display = 'block';
      chatAvatarIcon.style.display = 'none';
      chatAvatarContainer.style.background = 'transparent';
      chatAvatarContainer.style.width = '40px';
      chatAvatarContainer.style.height = '40px';
      
      chatUsernameEl.textContent = username;
      // Make avatar and username clickable to open profile
      chatAvatarEl.style.cursor = 'pointer';
      chatUsernameEl.style.cursor = 'pointer';
      chatAvatarEl.onclick = () => window.location.href = `/profile/${currentContactId}`;
      chatUsernameEl.onclick = () => window.location.href = `/profile/${currentContactId}`;
      
      // Mark conversation as active
      document.querySelectorAll('.ig-conversation').forEach(el => el.classList.remove('active'));
      event?.currentTarget?.classList.add('active');
      
      // On mobile, show chat window and hide nav
      const chatWindow = document.getElementById('chatWindow');
      chatWindow.classList.add('active');
      
      // Hide nav on mobile
      if (window.innerWidth <= 768) {
        document.querySelector('.ig-top-nav')?.style.setProperty('display', 'none');
        document.querySelector('.ig-bottom-nav')?.style.setProperty('display', 'none');
      }
      
      // Load messages
      await loadMessages(contactId);
    }

    // Load messages
    async function loadMessages(contactId) {
      try {
        const data = await InnovateAPI.apiRequest(`/messages/${contactId}`);
        const messagesContainer = document.getElementById('chatMessages');
        messagesContainer.innerHTML = '';

        if (data.messages.length === 0) {
          messagesContainer.innerHTML = `
            <div style="text-align: center; color: var(--ig-secondary-text); padding: 40px;">
              <div style="font-size: 24px; margin-bottom: 8px;">üëã</div>
              <div>No messages yet</div>
              <div style="font-size: 12px; margin-top: 4px;">Send a message to start the conversation</div>
            </div>
          `;
          return;
        }

        // Check for pinned messages
        const pinnedMessages = data.messages.filter(msg => msg.is_pinned === 1 || msg.is_pinned === true);
        
        // Add pinned message banner at the top (if any) - make it sticky
        if (pinnedMessages.length > 0) {
          const pinnedMsg = pinnedMessages[0]; // Show most recent pinned message
          const pinnedContent = pinnedMsg.content || 'Message';
          const truncatedContent = pinnedContent.length > 50 ? pinnedContent.substring(0, 50) + '...' : pinnedContent;
          
          const pinBanner = document.createElement('div');
          pinBanner.id = 'pinned-message-banner';
          pinBanner.style.cssText = 'position: sticky; top: 0; z-index: 10; background: linear-gradient(135deg, rgba(0, 149, 246, 0.15) 0%, rgba(138, 43, 226, 0.1) 100%); border-left: 4px solid var(--ig-blue); padding: 12px 16px; margin: 0 0 8px 0; border-radius: 0 0 8px 8px; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);';
          pinBanner.onmouseover = () => { 
            pinBanner.style.background = 'linear-gradient(135deg, rgba(0, 149, 246, 0.25) 0%, rgba(138, 43, 226, 0.15) 100%)';
            pinBanner.style.transform = 'translateY(1px)';
          };
          pinBanner.onmouseout = () => { 
            pinBanner.style.background = 'linear-gradient(135deg, rgba(0, 149, 246, 0.15) 0%, rgba(138, 43, 226, 0.1) 100%)';
            pinBanner.style.transform = 'translateY(0)';
          };
          pinBanner.onclick = () => {
            // Scroll to pinned message
            const messageEl = document.querySelector(`[data-message-id="${pinnedMsg.id}"]`);
            if (messageEl) {
              messageEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
              // Highlight the message briefly
              const originalBg = messageEl.style.backgroundColor;
              messageEl.style.backgroundColor = 'rgba(0, 149, 246, 0.3)';
              messageEl.style.transition = 'background-color 0.3s';
              setTimeout(() => {
                messageEl.style.backgroundColor = originalBg;
                setTimeout(() => {
                  messageEl.style.transition = '';
                }, 300);
              }, 1500);
            }
          };
          pinBanner.innerHTML = `
            <div style="display: flex; align-items: flex-start; justify-content: space-between; gap: 12px;">
              <div style="flex: 1; min-width: 0;">
                <div style="font-size: 13px; color: var(--ig-blue); margin-bottom: 6px; font-weight: 700; display: flex; align-items: center; gap: 6px;">
                  <i class="fas fa-thumbtack" style="font-size: 14px;"></i> 
                  <span>Pinned Message</span>
                </div>
                <div style="font-size: 14px; color: var(--ig-primary-text); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; opacity: 0.9;">
                  <strong>${pinnedMsg.sender_username || 'User'}:</strong> ${truncatedContent}
                </div>
              </div>
              <button onclick="event.stopPropagation(); unpinMessageFromBanner(${pinnedMsg.id})" 
                      style="background: rgba(0, 0, 0, 0.05); border: none; color: var(--ig-secondary-text); cursor: pointer; font-size: 18px; line-height: 1; padding: 0; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: all 0.2s; flex-shrink: 0;"
                      onmouseover="this.style.background='rgba(0,0,0,0.15)'; this.style.color='var(--ig-primary-text)'; this.style.transform='scale(1.1)'"
                      onmouseout="this.style.background='rgba(0,0,0,0.05)'; this.style.color='var(--ig-secondary-text)'; this.style.transform='scale(1)'"
                      title="Unpin message">√ó</button>
            </div>
          `;
          messagesContainer.appendChild(pinBanner);
        }

        data.messages.forEach(msg => {
          const isSent = msg.sender_id === user.id;
          const senderLabel = isSent ? 'You' : (msg.sender_username || '');

          // Wrapper holds label + bubble
          const wrapperEl = document.createElement('div');
          wrapperEl.style.cssText = 'display: flex; flex-direction: column; width: 100%;';
          const labelEl = document.createElement('div');
          labelEl.style.cssText = `font-size: 11px; color: var(--ig-secondary-text); width: 100%; text-align: ${isSent ? 'right' : 'left'}; padding: 0 12px; margin-bottom: 4px;`;
          labelEl.textContent = senderLabel;
          wrapperEl.appendChild(labelEl);

          // Message bubble
          const messageEl = document.createElement('div');
          messageEl.dataset.messageId = msg.id;
          messageEl.dataset.messageContent = msg.content;
          messageEl.dataset.isSent = isSent;
          messageEl.dataset.isPinned = msg.is_pinned ? 'true' : 'false';
          messageEl.dataset.isStarred = msg.is_starred ? 'true' : 'false';

          // Render by type
          if (msg.type === 'image' || msg.type === 'gif') {
            messageEl.className = isSent ? 'ig-message-media ig-message-sent' : 'ig-message-media ig-message-received';
            const filename = msg.original_filename || (msg.content || '').split('/').pop();
            const imgWrapper = document.createElement('div');
            imgWrapper.style.cssText = 'position: relative; display: inline-block;';
            
            const img = document.createElement('img');
            img.src = msg.content;
            img.style.cssText = `max-width: 250px; max-height: ${msg.type === 'gif' ? '250px' : '350px'}; border-radius: 18px; cursor: pointer; display: block;`;
            img.onclick = (e) => {
              // Single click opens preview
              if (!e.ctrlKey && !e.metaKey) {
                openMediaPreview(msg.content, msg.type, filename);
              }
            };
            
            // Add context menu trigger to image
            img.addEventListener('contextmenu', (e) => {
              e.preventDefault();
              e.stopPropagation();
              showMessageContextMenu(e, msg.id, msg.content, isSent, msg.type);
            });
            
            // Add three-dot menu button for mobile
            const menuBtn = document.createElement('button');
            menuBtn.onclick = (e) => {
              e.stopPropagation();
              showMessageContextMenu(e, msg.id, msg.content, isSent, msg.type);
            };
            menuBtn.style.cssText = 'position: absolute; top: 8px; left: 8px; background: rgba(0,0,0,0.6); border: none; color: white; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; display: flex; align-items: center; justify-content: center; opacity: 0.7;';
            menuBtn.title = 'More options';
            menuBtn.innerHTML = `<svg fill="currentColor" height="16" viewBox="0 0 24 24" width="16"><circle cx="12" cy="5" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="12" cy="19" r="2"/></svg>`;
            
            const downloadBtn = document.createElement('button');
            downloadBtn.onclick = (e) => {
              e.stopPropagation();
              downloadFile(msg.content, filename);
            };
            downloadBtn.style.cssText = 'position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.6); border: none; color: white; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; display: flex; align-items: center; justify-content: center;';
            downloadBtn.title = 'Download';
            downloadBtn.innerHTML = `<svg fill="currentColor" height="16" viewBox="0 0 24 24" width="16"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"></path></svg>`;
            
            imgWrapper.appendChild(img);
            imgWrapper.appendChild(menuBtn);
            imgWrapper.appendChild(downloadBtn);
            messageEl.appendChild(imgWrapper);
          } else if (msg.type === 'voice') {
            messageEl.className = isSent ? 'ig-message ig-message-sent' : 'ig-message ig-message-received';
            const filename = msg.original_filename || (msg.content || '').split('/').pop();
            messageEl.innerHTML = `
              <div style="display: flex; align-items: center; gap: 8px;">
                <audio controls style="max-width: 200px;">
                  <source src="${msg.content}">
                </audio>
                <button onclick="downloadFile('${msg.content}', '${filename}')" style="background: var(--ig-secondary-background); border: none; color: var(--ig-primary-text); border-radius: 50%; width: 32px; height: 32px; cursor: pointer; display: flex; align-items: center; justify-content: center;" title="Download">
                  <svg fill="currentColor" height="16" viewBox="0 0 24 24" width="16">
                    <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"></path>
                  </svg>
                </button>
              </div>
            `;
          } else if (msg.type === 'location') {
            messageEl.className = isSent ? 'ig-message ig-message-sent' : 'ig-message ig-message-received';
            try {
              const loc = JSON.parse(msg.content);
              messageEl.innerHTML = `
                <a href="https://www.google.com/maps?q=${loc.lat},${loc.lng}" target="_blank" style="display: block; text-decoration: none; color: inherit;">
                  <div style="font-weight: 600;">üìç Location</div>
                  <div style="font-size: 12px; opacity: 0.8;">Tap to view on map</div>
                </a>
              `;
            } catch (_) {
              messageEl.textContent = 'Shared location';
            }
          } else if (msg.type === 'todo') {
            messageEl.className = isSent ? 'ig-message ig-message-sent' : 'ig-message ig-message-received';
            try {
              const todo = JSON.parse(msg.content || '{}');
              let html = `<div style="font-weight: 600; margin-bottom: 8px;">‚úì ${todo.title || 'Todo'}</div>`;
              (todo.items || []).forEach(item => {
                html += `<div style="display: flex; align-items: center; gap: 8px; padding: 4px 0;">
                  <input type="checkbox" ${item.checked ? 'checked' : ''} disabled style="width: 16px; height: 16px;">
                  <span style="font-size: 14px;">${item.text || ''}</span>
                </div>`;
              });
              messageEl.innerHTML = html;
            } catch (_) {
              messageEl.textContent = msg.content || '';
            }
          } else if (msg.type === 'file' || msg.type === 'video' || msg.type === 'document') {
            const fileName = msg.original_filename || (msg.content || '').split('/').pop();
            const isVideo = msg.type === 'video' || (msg.content || '').match(/\.(mp4|webm|mov|avi)$/i);
            const isPdf = (msg.content || '').match(/\.pdf$/i) || (fileName || '').match(/\.pdf$/i);
            const isDoc = (msg.content || '').match(/\.(doc|docx|txt)$/i) || (fileName || '').match(/\.(doc|docx|txt)$/i);
            messageEl.className = isSent ? 'ig-message-media ig-message-sent' : 'ig-message-media ig-message-received';
            if (isVideo) {
              const videoWrapper = document.createElement('div');
              videoWrapper.style.cssText = 'position: relative; display: inline-block;';
              
              const video = document.createElement('video');
              video.controls = true;
              video.style.cssText = 'max-width: 250px; max-height: 350px; border-radius: 18px; display: block;';
              video.innerHTML = `<source src="${msg.content}">`;
              
              // Add context menu to video
              video.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                e.stopPropagation();
                showMessageContextMenu(e, msg.id, msg.content, isSent, msg.type);
              });
              
              // Add three-dot menu button for mobile
              const menuBtn = document.createElement('button');
              menuBtn.onclick = (e) => {
                e.stopPropagation();
                showMessageContextMenu(e, msg.id, msg.content, isSent, msg.type);
              };
              menuBtn.style.cssText = 'position: absolute; top: 8px; left: 8px; background: rgba(0,0,0,0.6); border: none; color: white; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; display: flex; align-items: center; justify-content: center; opacity: 0.7; z-index: 10;';
              menuBtn.title = 'More options';
              menuBtn.innerHTML = `<svg fill="currentColor" height="16" viewBox="0 0 24 24" width="16"><circle cx="12" cy="5" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="12" cy="19" r="2"/></svg>`;
              
              const downloadBtn = document.createElement('button');
              downloadBtn.onclick = (e) => {
                e.stopPropagation();
                downloadFile(msg.content, fileName);
              };
              downloadBtn.style.cssText = 'position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.6); border: none; color: white; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 10;';
              downloadBtn.title = 'Download';
              downloadBtn.innerHTML = `<svg fill="currentColor" height="16" viewBox="0 0 24 24" width="16"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"></path></svg>`;
              
              videoWrapper.appendChild(video);
              videoWrapper.appendChild(menuBtn);
              videoWrapper.appendChild(downloadBtn);
              messageEl.appendChild(videoWrapper);
            } else {
              const icon = isPdf ? 'üìÑ' : isDoc ? 'üìù' : 'üìé';
              
              const fileWrapper = document.createElement('div');
              fileWrapper.style.cssText = 'position: relative; display: inline-block;';
              
              const fileContainer = document.createElement('div');
              fileContainer.style.cssText = 'display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--ig-secondary-background); border-radius: 12px; max-width: 250px; cursor: pointer;';
              fileContainer.onclick = (e) => {
                if (!e.target.closest('button')) {
                  openMediaPreview(msg.content, 'file', fileName);
                }
              };
              
              // Add context menu to file
              fileContainer.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                e.stopPropagation();
                showMessageContextMenu(e, msg.id, msg.content, isSent, msg.type);
              });
              
              fileContainer.innerHTML = `
                <div style="font-size: 32px;">${icon}</div>
                <div style="flex: 1; min-width: 0;">
                  <div style="font-weight: 600; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${fileName}</div>
                  <div style="font-size: 12px; color: var(--ig-secondary-text); margin-top: 4px;">Click to preview</div>
                </div>
              `;
              
              // Add three-dot menu button for mobile
              const menuBtn = document.createElement('button');
              menuBtn.onclick = (e) => {
                e.stopPropagation();
                showMessageContextMenu(e, msg.id, msg.content, isSent, msg.type);
              };
              menuBtn.style.cssText = 'position: absolute; top: 8px; left: 8px; background: rgba(0,0,0,0.6); border: none; color: white; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; display: flex; align-items: center; justify-content: center; opacity: 0.7; z-index: 10;';
              menuBtn.title = 'More options';
              menuBtn.innerHTML = `<svg fill="currentColor" height="16" viewBox="0 0 24 24" width="16"><circle cx="12" cy="5" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="12" cy="19" r="2"/></svg>`;
              
              const downloadBtn = document.createElement('button');
              downloadBtn.onclick = (e) => {
                e.stopPropagation();
                downloadFile(msg.content, fileName);
              };
              downloadBtn.style.cssText = 'background: var(--ig-blue); border: none; color: white; border-radius: 50%; width: 36px; height: 36px; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0;';
              downloadBtn.title = 'Download';
              downloadBtn.innerHTML = `<svg fill="currentColor" height="18" viewBox="0 0 24 24" width="18"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"></path></svg>`;
              
              fileContainer.appendChild(downloadBtn);
              fileWrapper.appendChild(fileContainer);
              fileWrapper.appendChild(menuBtn);
              messageEl.appendChild(fileWrapper);
            }
          } else {
            // Text
            messageEl.className = isSent ? 'ig-message ig-message-sent' : 'ig-message ig-message-received';
            
            // Add reply context if this is a reply
            if (msg.reply_to_id) {
              const replyContext = data.messages.find(m => m.id === msg.reply_to_id);
              if (replyContext) {
                const replyDiv = document.createElement('div');
                replyDiv.style.cssText = 'border-left: 3px solid var(--ig-blue); padding: 6px 10px; margin-bottom: 8px; background: rgba(0,0,0,0.2); border-radius: 6px; cursor: pointer;';
                replyDiv.dataset.scrollToMessage = replyContext.id;
                replyDiv.innerHTML = `
                  <div style="font-size: 11px; color: var(--ig-blue); font-weight: 600; margin-bottom: 2px;">
                    ${replyContext.sender_id === user.id ? 'You' : replyContext.sender_username || 'User'}
                  </div>
                  <div style="font-size: 12px; opacity: 0.8; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                    ${replyContext.content?.substring(0, 50) || 'Message'}
                  </div>
                `;
                replyDiv.onclick = (e) => {
                  e.stopPropagation();
                  scrollToMessage(replyContext.id);
                };
                messageEl.appendChild(replyDiv);
              }
            }
            
            // Create text wrapper for positioning
            const textWrapper = document.createElement('div');
            textWrapper.style.cssText = 'position: relative; display: inline-block; width: 100%;';
            
            const textContent = document.createElement('div');
            textContent.textContent = msg.content || '';
            textContent.style.cssText = 'padding-right: 30px;'; // Space for three-dot button
            
            // Add three-dot menu button for mobile
            const menuBtn = document.createElement('button');
            menuBtn.onclick = (e) => {
              e.stopPropagation();
              showMessageContextMenu(e, msg.id, msg.content, isSent, msg.type);
            };
            menuBtn.style.cssText = `position: absolute; top: 4px; ${isSent ? 'left: 4px;' : 'right: 4px;'} background: transparent; border: none; color: var(--ig-secondary-text); border-radius: 50%; width: 24px; height: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; opacity: 0.6; padding: 0;`;
            menuBtn.title = 'More options';
            menuBtn.innerHTML = `<svg fill="currentColor" height="16" viewBox="0 0 24 24" width="16"><circle cx="12" cy="5" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="12" cy="19" r="2"/></svg>`;
            
            textWrapper.appendChild(textContent);
            textWrapper.appendChild(menuBtn);
            messageEl.appendChild(textWrapper);
            
            // Add pin indicator if message is pinned
            if (msg.is_pinned) {
              const pinIndicator = document.createElement('div');
              pinIndicator.style.cssText = 'display: flex; align-items: center; gap: 4px; font-size: 11px; color: #ffa500; margin-top: 4px;';
              pinIndicator.innerHTML = `<svg fill="currentColor" height="12" viewBox="0 0 24 24" width="12"><path d="M16 9V4h1c.55 0 1-.45 1-1s-.45-1-1-1H7c-.55 0-1 .45-1 1s.45 1 1 1h1v5c0 1.66-1.34 3-3 3v2h5.97v7l1 1 1-1v-7H19v-2c-1.66 0-3-1.34-3-3z"/></svg><span>Pinned</span>`;
              messageEl.appendChild(pinIndicator);
            }
          }

          // Time/status
          const timeEl = document.createElement('div');
          timeEl.className = 'ig-message-time';
          timeEl.style.cssText = 'display: flex; align-items: center; gap: 4px; justify-content: ' + (isSent ? 'flex-end' : 'flex-start') + ';';
          if (isSent) {
            const statusIcon = msg.is_read ? '‚úì‚úì' : '‚úì';
            timeEl.innerHTML = `<span style="font-size: 11px;">${formatMessageTime(msg.created_at)}</span><span style="font-size: 10px; color: ${msg.is_read ? '#0095f6' : 'inherit'};">${statusIcon}</span>`;
          } else {
            timeEl.textContent = formatMessageTime(msg.created_at);
          }
          if (msg.expires_at) {
            const timerEl = document.createElement('span');
            timerEl.style.cssText = 'margin-left: 8px; opacity: 0.7;';
            timerEl.textContent = 'üïê';
            timeEl.appendChild(timerEl);
          }
          // Add star indicator if message is starred
          if (msg.is_starred) {
            const starEl = document.createElement('span');
            starEl.style.cssText = 'margin-left: 8px; color: #ffd700;';
            starEl.textContent = '‚≠ê';
            starEl.title = 'Starred';
            timeEl.appendChild(starEl);
          }
          messageEl.appendChild(timeEl);

          // Track expiry
          if (msg.expires_at) {
            messageEl.dataset.messageId = msg.id;
            messageEl.dataset.expiresAt = msg.expires_at;
          }

          // Long-press and context menu
          let pressTimer;
          messageEl.addEventListener('touchstart', (e) => {
            pressTimer = setTimeout(() => {
              showMessageContextMenu(e, msg.id, msg.content, isSent, msg.type);
            }, 500);
          });
          messageEl.addEventListener('touchend', () => {
            clearTimeout(pressTimer);
          });
          messageEl.addEventListener('touchmove', () => {
            clearTimeout(pressTimer);
          });
          messageEl.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            showMessageContextMenu(e, msg.id, msg.content, isSent, msg.type);
          });
          
          messageEl.addEventListener('click', (e) => {
            // Allow click-through for media and buttons, but show menu on long text click
            const target = e.target;
            if (target.tagName !== 'IMG' && target.tagName !== 'BUTTON' && target.tagName !== 'AUDIO' && 
                target.tagName !== 'VIDEO' && !target.closest('a') && !target.closest('button')) {
              showMessageContextMenu(e, msg.id, msg.content, isSent, msg.type);
            }
          });

          wrapperEl.appendChild(messageEl);
          messagesContainer.appendChild(wrapperEl);
        });

        // Scroll to bottom
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
        // Start checking for expired messages
        checkExpiredMessages();
      } catch (error) {
        console.error('Error loading messages:', error);
      }
    }

    // Open group chat
    async function openGroupChat(groupId, groupName) {
      currentGroupId = groupId;
      currentContactId = null;
      const chatAvatarEl = document.getElementById('chatAvatar');
      const chatAvatarIcon = document.getElementById('chatAvatarIcon');
      const chatAvatarContainer = document.getElementById('chatAvatarContainer');
      const chatUsernameEl = document.getElementById('chatUsername');
      
      // Show default group icon
      chatAvatarEl.src = '/images/default-avatar.svg';
      chatAvatarEl.style.display = 'block';
      chatAvatarIcon.style.display = 'none';
      chatAvatarContainer.style.background = 'transparent';
      
      chatUsernameEl.textContent = groupName;
      chatAvatarEl.style.cursor = 'default';
      chatUsernameEl.style.cursor = 'default';

      document.querySelectorAll('.ig-conversation').forEach(el => el.classList.remove('active'));

      const chatWindow = document.getElementById('chatWindow');
      chatWindow.classList.add('active');
      if (window.innerWidth <= 768) {
        document.querySelector('.ig-top-nav')?.style.setProperty('display', 'none');
        document.querySelector('.ig-bottom-nav')?.style.setProperty('display', 'none');
      }
      await loadGroupMessages(groupId);
      // Mark as read (non-throwing)
      try {
        const token = InnovateAPI.getToken();
        await fetch(`${InnovateAPI.API_URL}/groups/${groupId}/read`, {
          method: 'POST',
          headers: token ? { 'Authorization': `Bearer ${token}` } : {}
        });
      } catch (_) {}
    }

    // Load group messages (basic text)
    async function loadGroupMessages(groupId) {
      try {
        const data = await InnovateAPI.apiRequest(`/groups/${groupId}/messages`);
        const messagesContainer = document.getElementById('chatMessages');
        messagesContainer.innerHTML = '';

        if (!data.messages || data.messages.length === 0) {
          messagesContainer.innerHTML = `
            <div style="text-align: center; color: var(--ig-secondary-text); padding: 40px;">
              <div style="font-size: 24px; margin-bottom: 8px;">üëã</div>
              <div>No messages yet</div>
              <div style="font-size: 12px; margin-top: 4px;">Start the conversation</div>
            </div>
          `;
          return;
        }

        data.messages.forEach(msg => {
          const isSent = msg.sender_id === user.id;
          const senderLabel = isSent ? 'You' : (msg.sender_username || '');

          const wrapperEl = document.createElement('div');
          wrapperEl.style.cssText = 'display: flex; flex-direction: column; width: 100%;';
          const labelEl = document.createElement('div');
          labelEl.style.cssText = `font-size: 11px; color: var(--ig-secondary-text); width: 100%; text-align: ${isSent ? 'right' : 'left'}; padding: 0 12px; margin-bottom: 4px;`;
          labelEl.textContent = senderLabel;
          wrapperEl.appendChild(labelEl);

          const messageEl = document.createElement('div');
          messageEl.className = isSent ? 'ig-message ig-message-sent' : 'ig-message ig-message-received';
          messageEl.textContent = msg.content || '';

          const timeEl = document.createElement('div');
          timeEl.className = 'ig-message-time';
          timeEl.style.cssText = 'display: flex; align-items: center; gap: 4px; justify-content: ' + (isSent ? 'flex-end' : 'flex-start') + ';';
          if (isSent) {
            const statusIcon = msg.is_read ? '‚úì‚úì' : '‚úì';
            timeEl.innerHTML = `<span style="font-size: 11px;">${formatMessageTime(msg.created_at)}</span><span style="font-size: 10px; color: ${msg.is_read ? '#0095f6' : 'inherit'};">${statusIcon}</span>`;
          } else {
            timeEl.textContent = formatMessageTime(msg.created_at);
          }
          messageEl.appendChild(timeEl);

          wrapperEl.appendChild(messageEl);
          messagesContainer.appendChild(wrapperEl);
        });

        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      } catch (error) {
        console.error('Error loading group messages:', error);
      }
    }
    
    // Check and remove expired messages
    function checkExpiredMessages() {
      const messagesContainer = document.getElementById('chatMessages');
      if (!messagesContainer) return;
      
      const now = new Date().getTime();
      const messages = messagesContainer.querySelectorAll('[data-expires-at]');
      
      messages.forEach(messageEl => {
        const expiresAt = new Date(messageEl.dataset.expiresAt).getTime();
        if (now >= expiresAt) {
          // Fade out and remove
          messageEl.style.transition = 'opacity 0.5s';
          messageEl.style.opacity = '0';
          setTimeout(() => {
            messageEl.remove();
          }, 500);
        }
      });
    }
    
    // Check expired messages every 5 seconds
    setInterval(checkExpiredMessages, 5000);

    // Send message
    async function sendMessage() {
      const input = document.getElementById('messageInput');
      const content = input.value.trim();
      
      // Check if editing (support both old and new dataset keys)
      const isEditing = input.dataset.editing || input.dataset.editingMessageId;
      
      // Allow sending if: has content, OR is editing with attachment changes, OR has contact/group
      const hasAttachmentChanges = isEditing && (input.dataset.attachmentAction || window.editingNewFile);
      if (!hasAttachmentChanges && (!content || (!currentContactId && !currentGroupId))) return;
      
      if (isEditing) {
        try {
          const attachmentAction = input.dataset.attachmentAction;
          const hasNewFile = window.editingNewFile;
          
          // If there are attachment changes, use FormData
          if (attachmentAction === 'remove' || hasNewFile) {
            const formData = new FormData();
            formData.append('content', content);
            formData.append('attachmentAction', attachmentAction || 'keep');
            
            if (hasNewFile) {
              formData.append('file', hasNewFile);
              formData.append('fileType', input.dataset.newFileType || 'file');
            }
            
            await InnovateAPI.apiRequest(`/messages/${isEditing}`, {
              method: 'PUT',
              body: formData
              // Don't set headers - apiRequest will handle FormData automatically
            });
          } else {
            // Text-only edit
            await InnovateAPI.apiRequest(`/messages/${isEditing}`, {
              method: 'PUT',
              body: JSON.stringify({ content })
            });
          }
          
          delete input.dataset.editing;
          delete input.dataset.editingMessageId;
          delete input.dataset.originalFileType;
          delete input.dataset.attachmentAction;
          delete input.dataset.newFileType;
          delete window.editingNewFile;
          input.value = '';
          input.placeholder = 'Message...';
          
          // Clear preview container
          document.getElementById('messagePreviewContainer').innerHTML = '';
          
          // Reset send button
          const sendBtn = document.getElementById('sendBtn');
          sendBtn.innerHTML = '<svg aria-label="Send" fill="currentColor" height="24" viewBox="0 0 24 24" width="24"><path d="M1.464 12.986 23.963.863a.5.5 0 0 1 .71.627l-5.24 20.618a.5.5 0 0 1-.925.114l-5.14-9.47-9.472-5.138a.5.5 0 0 1 .115-.925l-.547.297Z" stroke="currentColor" fill="none" stroke-linejoin="round"></path></svg>';
          
          // Reset button visibility after edit
          sendBtn.style.display = 'none';
          const voiceBtn = document.getElementById('voiceBtn');
          const moreBtn = document.getElementById('moreBtn');
          if (voiceBtn) voiceBtn.style.display = 'inline-flex';
          if (moreBtn) moreBtn.style.display = 'inline-flex';
          
          loadMessages(currentContactId);
          InnovateAPI.showAlert('Message updated', 'success');
        } catch (error) {
          console.error('Edit error:', error);
          InnovateAPI.showAlert('Failed to update message: ' + (error.message || 'Unknown error'), 'error');
        }
        return;
      }
      
      // Check for timer and reply
      const timer = input.dataset.timer;
      const replyToMessageId = input.dataset.replyToMessageId;
      const isGroup = !!currentGroupId;
      let endpoint, payload;
      if (isGroup) {
        endpoint = `/groups/${currentGroupId}/messages`;
        payload = { content, type: 'text' };
        if (timer) payload.timer = parseInt(timer);
        if (replyToMessageId) payload.reply_to_id = parseInt(replyToMessageId);
      } else {
        endpoint = '/messages';
        payload = { receiver_id: currentContactId, content };
        if (timer) payload.timer = parseInt(timer);
        if (replyToMessageId) payload.reply_to_id = parseInt(replyToMessageId);
      }

      if (timer) {
        delete input.dataset.timer;
        input.placeholder = 'Message...';
      }
      
      // Store reply info before clearing
      let replyContext = null;
      if (replyToMessageId) {
        replyContext = {
          messageId: replyToMessageId,
          content: selectedMessageContent
        };
        delete input.dataset.replyToMessageId;
        document.getElementById('messagePreviewContainer').innerHTML = '';
      }

      try {
        await InnovateAPI.apiRequest(endpoint, {
          method: 'POST',
          body: JSON.stringify(payload)
        });
        
        // Clear input
        input.value = '';
        
        // Add message to UI
        const messagesContainer = document.getElementById('chatMessages');
        const messageEl = document.createElement('div');
        messageEl.className = 'ig-message ig-message-sent';
        messageEl.dataset.messageContent = content;
        messageEl.dataset.isSent = 'true';
        if (replyContext) {
          messageEl.dataset.replyToId = replyContext.messageId;
        }
        
        // Add reply context if this is a reply
        if (replyContext) {
          const replyDiv = document.createElement('div');
          replyDiv.style.cssText = 'border-left: 3px solid var(--ig-blue); padding: 6px 10px; margin-bottom: 8px; background: rgba(0,0,0,0.2); border-radius: 6px; cursor: pointer;';
          replyDiv.dataset.scrollToMessage = replyContext.messageId;
          replyDiv.innerHTML = `
            <div style="font-size: 11px; color: var(--ig-blue); font-weight: 600; margin-bottom: 2px;">
              ${currentContactId ? 'User' : 'You'}
            </div>
            <div style="font-size: 12px; opacity: 0.8; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
              ${replyContext.content?.substring(0, 50) || 'Message'}
            </div>
          `;
          replyDiv.onclick = (e) => {
            e.stopPropagation();
            scrollToMessage(replyContext.messageId);
          };
          messageEl.appendChild(replyDiv);
        }
        
        // Add text content with three-dot menu
        const textWrapper = document.createElement('div');
        textWrapper.style.cssText = 'position: relative; display: inline-block; width: 100%;';
        
        const textContent = document.createElement('div');
        textContent.textContent = content;
        textContent.style.cssText = 'padding-right: 30px;';
        
        // Add three-dot menu button for mobile
        const menuBtn = document.createElement('button');
        menuBtn.onclick = (e) => {
          e.stopPropagation();
          showMessageContextMenu(e, messageEl.dataset.messageId, content, true, 'text');
        };
        menuBtn.style.cssText = 'position: absolute; top: 4px; left: 4px; background: transparent; border: none; color: var(--ig-secondary-text); border-radius: 50%; width: 24px; height: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; opacity: 0.6; padding: 0;';
        menuBtn.title = 'More options';
        menuBtn.innerHTML = `<svg fill="currentColor" height="16" viewBox="0 0 24 24" width="16"><circle cx="12" cy="5" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="12" cy="19" r="2"/></svg>`;
        
        textWrapper.appendChild(textContent);
        textWrapper.appendChild(menuBtn);
        messageEl.appendChild(textWrapper);
        
        // Add message status (delivered)
        const statusEl = document.createElement('div');
        statusEl.className = 'ig-message-time';
        statusEl.style.cssText = 'display: flex; align-items: center; gap: 4px; justify-content: flex-end;';
        statusEl.innerHTML = `<span style="font-size: 11px;">Just now</span><span style="font-size: 10px;">‚úì‚úì</span>`;
        messageEl.appendChild(statusEl);
        
        if (timer) {
          const timerEl = document.createElement('div');
          timerEl.style.cssText = 'font-size: 11px; opacity: 0.7; margin-top: 4px;';
          timerEl.textContent = `üïê ${formatTimerDuration(parseInt(timer))}`;
          messageEl.appendChild(timerEl);
        }
        
        // Add context menu support
        messageEl.addEventListener('contextmenu', (e) => {
          e.preventDefault();
          showMessageContextMenu(e, messageEl.dataset.messageId, content, true, 'text');
        });
        messageEl.addEventListener('click', (e) => {
          if (e.target.tagName !== 'BUTTON') {
            showMessageContextMenu(e, messageEl.dataset.messageId, content, true, 'text');
          }
        });
        
        // Remove placeholder if exists
        if (messagesContainer.querySelector('[style*="text-align: center"]')) {
          messagesContainer.innerHTML = '';
        }
        
        messagesContainer.appendChild(messageEl);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
        // Emit via socket
        if (isGroup) {
          InnovateAPI.getSocket().emit('group:message', {
            groupId: currentGroupId,
            message: { content }
          });
        } else {
          InnovateAPI.getSocket().emit('send_message', {
            receiver_id: currentContactId,
            content: content
          });
        }
        
        // Reload messages and conversations to get full data (with delay to ensure DB is updated)
        setTimeout(() => {
          if (isGroup) {
            loadGroupMessages(currentGroupId);
          } else {
            // Only reload if we're in the same conversation
            if (currentContactId) {
              const scrollPos = messagesContainer.scrollHeight;
              loadMessages(currentContactId).then(() => {
                // Restore scroll position
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
              });
            }
            loadConversations();
          }
        }, 1500);
      } catch (error) {
        console.error('Error sending message:', error);
        InnovateAPI.showAlert('Failed to send message', 'error');
      }
    }

    // Close chat (mobile)
    function closeChat() {
      document.getElementById('chatWindow').classList.remove('active');
      
      // Reset to default icon
      const chatAvatarEl = document.getElementById('chatAvatar');
      const chatAvatarIcon = document.getElementById('chatAvatarIcon');
      const chatAvatarContainer = document.getElementById('chatAvatarContainer');
      const chatUsernameEl = document.getElementById('chatUsername');
      
      chatAvatarEl.style.display = 'none';
      chatAvatarIcon.style.display = 'block';
      chatAvatarContainer.style.background = 'var(--ig-secondary-background)';
      chatUsernameEl.textContent = 'Select a conversation';
      
      // Show nav on mobile
      if (window.innerWidth <= 768) {
        document.querySelector('.ig-top-nav')?.style.setProperty('display', 'block');
        document.querySelector('.ig-bottom-nav')?.style.setProperty('display', 'flex');
      }
    }

    // Lightweight confirm modal (Instagram-style)
    function showConfirmModal(title, message, confirmText = 'Confirm') {
      return new Promise((resolve) => {
        const overlay = document.createElement('div');
        overlay.className = 'ig-modal-overlay';
        const modal = document.createElement('div');
        modal.className = 'ig-modal';

        const content = document.createElement('div');
        content.style.padding = '16px';
        content.innerHTML = `
          <div style="font-weight: 600; font-size: 16px; margin-bottom: 8px;">${title}</div>
          <div style="font-size: 14px; color: var(--ig-secondary-text);">${message}</div>
        `;

        const actions = document.createElement('div');
        actions.style.cssText = 'display:flex; justify-content:flex-end; gap:8px; padding: 12px 16px;';
        const cancelBtn = document.createElement('button');
        cancelBtn.className = 'ig-btn-secondary';
        cancelBtn.textContent = 'Cancel';
        const confirmBtn = document.createElement('button');
        confirmBtn.className = 'ig-btn-primary';
        confirmBtn.textContent = confirmText;

        cancelBtn.onclick = () => { document.body.removeChild(overlay); resolve(false); };
        confirmBtn.onclick = () => { document.body.removeChild(overlay); resolve(true); };

        actions.appendChild(cancelBtn);
        actions.appendChild(confirmBtn);
        modal.appendChild(content);
        modal.appendChild(actions);
        overlay.appendChild(modal);
        document.body.appendChild(overlay);
      });
    }

    // Delete chat or group
    async function deleteConversation() {
      // If a group chat is open, delete the group
      if (currentGroupId) {
        const confirmed = await showConfirmModal(
          'Delete Group',
          'This will permanently delete the group for all members. Only the creator or an admin can perform this action.',
          'Delete Group'
        );
        if (!confirmed) return;
        try {
          await InnovateAPI.apiRequest(`/groups/${currentGroupId}`, { method: 'DELETE' });
          // Close chat and refresh lists
          document.getElementById('chatWindow').classList.remove('active');
          currentGroupId = null;
          await loadConversations();
          InnovateAPI.showAlert('Group deleted', 'success');
        } catch (e) {
          InnovateAPI.showAlert('Failed to delete group', 'error');
        }
        return;
      }

      // Otherwise delete DM conversation
      if (!currentContactId) return;
      const confirmed = await showConfirmModal('Delete Chat', 'This hides the conversation for you. You can still receive new messages from this user.', 'Delete');
      if (!confirmed) return;
      try {
        await InnovateAPI.apiRequest(`/messages/conversations/${currentContactId}`, { method: 'DELETE' });
        // Return to conversations list
        document.getElementById('chatWindow').classList.remove('active');
        await loadConversations();
        InnovateAPI.showAlert('Chat deleted', 'success');
      } catch (e) {
        InnovateAPI.showAlert('Failed to delete chat', 'error');
      }
    }

    // New message
    async function newMessage() {
      const username = prompt('Enter username to message:');
      if (!username) return;
      
      try {
        const data = await InnovateAPI.apiRequest(`/search/users?q=${encodeURIComponent(username)}`);
        if (data.users && data.users.length > 0) {
          const user = data.users[0];
          openChat(user.id, user.username, user.profile_picture);
        } else {
          InnovateAPI.showAlert('User not found', 'error');
        }
      } catch (error) {
        InnovateAPI.showAlert('Error searching for user', 'error');
      }
    }

    // New Group modal with search & selection
    async function newGroup() { openNewGroupModal(); }

    function openNewGroupModal() {
      const overlay = document.createElement('div');
      overlay.className = 'ig-modal-overlay';
      const modal = document.createElement('div');
      modal.className = 'ig-message-actions-menu';

      const header = document.createElement('div');
      header.style.cssText = 'padding: 16px; border-bottom: 1px solid var(--ig-border); display:flex; align-items:center; gap:8px;';
      header.innerHTML = `<div style="font-weight:600; font-size:16px;">New Group</div>`;

      const body = document.createElement('div');
      body.style.cssText = 'padding: 12px; display:flex; flex-direction:column; gap:12px; max-height: 50vh; overflow-y:auto;';
      const nameInput = document.createElement('input');
      nameInput.placeholder = 'Group name';
      nameInput.style.cssText = 'width:100%; padding:10px; border:1px solid var(--ig-border); border-radius:8px; background: var(--ig-secondary-background); color: var(--ig-primary-text);';

      const searchInput = document.createElement('input');
      searchInput.placeholder = 'Search users';
      searchInput.style.cssText = 'width:100%; padding:10px; border:1px solid var(--ig-border); border-radius:8px; background: var(--ig-secondary-background); color: var(--ig-primary-text);';

      const resultsContainer = document.createElement('div');
      resultsContainer.style.cssText = 'display:flex; flex-direction:column; gap:8px;';

      const selected = new Map();
      const doSearch = InnovateAPI.debounce(async () => {
        const q = searchInput.value.trim();
        if (!q) { resultsContainer.innerHTML=''; return; }
        try {
          const data = await InnovateAPI.apiRequest(`/search/users?q=${encodeURIComponent(q)}`);
          const users = data.users || [];
          resultsContainer.innerHTML = '';
          users.forEach(u => {
            const row = document.createElement('label');
            row.style.cssText = 'display:flex; align-items:center; gap:8px; padding:8px; border:1px solid var(--ig-border); border-radius:8px;';
            row.innerHTML = `
              <img src="${InnovateAPI.getUserAvatar(u.profile_picture)}" alt="${u.username}" style="width:32px;height:32px;border-radius:50%;object-fit:cover;">
              <input type="checkbox" style="accent-color: var(--ig-blue);">
              <div style="flex:1;">
                <div style="font-weight:600;">${u.username}</div>
                <div style="font-size:12px;color:var(--ig-secondary-text);">${u.fullname || ''}</div>
              </div>`;
            const checkbox = row.querySelector('input[type="checkbox"]');
            checkbox.checked = selected.has(u.username);
            checkbox.onchange = () => { if (checkbox.checked) selected.set(u.username, true); else selected.delete(u.username); };
            resultsContainer.appendChild(row);
          });
        } catch (e) {
          resultsContainer.innerHTML = `<div style="color: var(--ig-secondary-text);">Search failed</div>`;
        }
      }, 300);
      searchInput.addEventListener('input', doSearch);

      body.appendChild(nameInput);
      body.appendChild(searchInput);
      body.appendChild(resultsContainer);

      const actions = document.createElement('div');
      actions.style.cssText = 'display:flex; justify-content:flex-end; gap:8px; padding: 12px 16px;';
      const cancelBtn = document.createElement('button');
      cancelBtn.className = 'ig-btn-secondary';
      cancelBtn.textContent = 'Cancel';
      const createBtn = document.createElement('button');
      createBtn.className = 'ig-btn-primary';
      createBtn.textContent = 'Create';
      cancelBtn.onclick = () => document.body.removeChild(overlay);
      createBtn.onclick = async () => {
        const name = nameInput.value.trim();
        if (!name) { InnovateAPI.showAlert('Enter a group name', 'error'); return; }
        const usernames = Array.from(selected.keys());
        try {
          const data = await InnovateAPI.apiRequest('/groups', { method: 'POST', body: JSON.stringify({ name, usernames }) });
          if (data && data.group) {
            document.body.removeChild(overlay);
            openGroupChat(data.group.id, data.group.name);
            setTimeout(() => loadConversations(), 300);
          }
        } catch (e) { InnovateAPI.showAlert('Failed to create group', 'error'); }
      };
      actions.appendChild(cancelBtn);
      actions.appendChild(createBtn);

      modal.appendChild(header);
      modal.appendChild(body);
      modal.appendChild(actions);
      overlay.appendChild(modal);
      document.body.appendChild(overlay);
    }

    // Normalize SQLite UTC timestamps (YYYY-MM-DD HH:MM:SS) by appending 'Z'
    function normalizeTimestamp(timestamp) {
      if (typeof timestamp === 'string' && timestamp.includes(' ') && !timestamp.includes('T') && !timestamp.includes('Z') && !timestamp.includes('+')) {
        return timestamp.replace(' ', 'T') + 'Z';
      }
      return timestamp;
    }

    // Format time
    function formatTime(timestamp) {
      const date = new Date(normalizeTimestamp(timestamp));
      const now = new Date();
      const diff = now - date;
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);
      
      if (minutes < 1) return 'now';
      if (minutes < 60) return `${minutes}m`;
      if (hours < 24) return `${hours}h`;
      if (days < 7) return `${days}d`;
      return date.toLocaleDateString('en-IN', { timeZone: 'Asia/Kolkata' });
    }
    
    // Format message time (for chat)
    function formatMessageTime(timestamp) {
      const date = new Date(normalizeTimestamp(timestamp));
      const now = new Date();
      const tzOptions = { timeZone: 'Asia/Kolkata' };
      const isToday = date.toLocaleDateString('en-US', tzOptions) === now.toLocaleDateString('en-US', tzOptions);
      
      if (isToday) {
        return date.toLocaleTimeString('en-US', { ...tzOptions, hour: 'numeric', minute: '2-digit', hour12: true });
      } else {
        const diff = now - date;
        const days = Math.floor(diff / 86400000);
        if (days < 7) {
          return date.toLocaleDateString('en-US', { ...tzOptions, weekday: 'short' }) + ' ' + 
                 date.toLocaleTimeString('en-US', { ...tzOptions, hour: 'numeric', minute: '2-digit', hour12: true });
        }
        return date.toLocaleDateString('en-US', { ...tzOptions, month: 'short', day: 'numeric' });
      }
    }

    // Search messages
    let searchTimeout;
    document.getElementById('searchMessages').addEventListener('input', async (e) => {
      const query = e.target.value.trim();
      
      if (!query) {
        renderConversations(conversations);
        return;
      }
      
      const queryLower = query.toLowerCase();
      const filtered = conversations.filter(conv => 
        conv.username.toLowerCase().includes(queryLower) ||
        (conv.last_message && conv.last_message.toLowerCase().includes(queryLower))
      );
      
      // If no conversations match, search for users
      if (filtered.length === 0 && query.length >= 2) {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(async () => {
          try {
            const data = await InnovateAPI.apiRequest(`/search/users?q=${encodeURIComponent(query)}`);
            if (data.users && data.users.length > 0) {
              // Display found users as potential new conversations
              const list = document.getElementById('conversationsList');
              list.innerHTML = `
                <div style="padding: 12px 16px; font-size: 12px; color: var(--ig-secondary-text); font-weight: 600;">
                  SEARCH RESULTS
                </div>
              `;
              
              data.users.forEach(user => {
                const userEl = document.createElement('div');
                userEl.className = 'ig-conversation';
                userEl.innerHTML = `
                  <img src="${InnovateAPI.getUserAvatar(user.profile_picture)}" alt="${user.username}" class="ig-conversation-avatar">
                  <div class="ig-conversation-info">
                    <div class="ig-conversation-name">${user.fullname || user.username}</div>
                    <div class="ig-conversation-message">@${user.username}</div>
                  </div>
                `;
                userEl.onclick = () => {
                  openChat(user.id, user.username, user.profile_picture);
                  e.target.value = '';
                  renderConversations(conversations);
                };
                list.appendChild(userEl);
              });
            } else {
              renderConversations([]);
            }
          } catch (error) {
            console.error('Search error:', error);
            renderConversations(filtered);
          }
        }, 300);
      } else {
        renderConversations(filtered);
      }
    });

    // Setup Socket.IO Event Listeners
    function setupSocketListeners() {
      console.log('Setting up Socket.IO event listeners...');
      const socket = InnovateAPI.getSocket();
      
      // Remove any existing listeners to prevent duplicates
      socket.off('new_message');
      socket.off('user:online');
      socket.off('user:offline');
      socket.off('message:expired');
      
      // New message listener
      socket.on('new_message', (data) => {
      if (data.sender_id === currentContactId) {
        const messagesContainer = document.getElementById('chatMessages');
        const messageEl = document.createElement('div');
        
        if (data.type === 'image') {
          messageEl.className = 'ig-message-media ig-message-received';
          const filename = data.original_filename || data.content.split('/').pop();
          messageEl.innerHTML = `
            <div style="position: relative; display: inline-block;">
              <img src="${data.content}" style="max-width: 250px; max-height: 350px; border-radius: 18px; cursor: pointer; display: block;" onclick='openMediaPreview(\`${data.content}\`, "image", \`${filename}\`)'>
              <button onclick='event.stopPropagation(); downloadFile(\`${data.content}\`, \`${filename}\`)' style="position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.6); border: none; color: white; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; display: flex; align-items: center; justify-content: center;" title="Download">
                <svg fill="currentColor" height="16" viewBox="0 0 24 24" width="16">
                  <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"></path>
                </svg>
              </button>
            </div>
            <div class="ig-message-time">${formatMessageTime(data.created_at)}</div>
          `;
        } else if (data.type === 'gif') {
          messageEl.className = 'ig-message-media ig-message-received';
          messageEl.innerHTML = `
            <div style="position: relative; display: inline-block;">
              <img src="${data.content}" style="max-width: 250px; max-height: 250px; border-radius: 18px; cursor: pointer; display: block;" onclick='openMediaPreview(\`${data.content}\`, "gif")'>
            </div>
            <div class="ig-message-time">${formatMessageTime(data.created_at)}</div>
          `;
        } else if (data.type === 'voice') {
          messageEl.className = 'ig-message ig-message-received';
          const filename = data.original_filename || data.content.split('/').pop();
          messageEl.innerHTML = `
            <div style="display: flex; align-items: center; gap: 8px;">
              <audio controls style="max-width: 200px;">
                <source src="${data.content}" type="audio/webm">
              </audio>
              <button onclick='downloadFile(\`${data.content}\`, \`${filename}\`)' style="background: var(--ig-secondary-background); border: none; color: var(--ig-primary-text); border-radius: 50%; width: 32px; height: 32px; cursor: pointer; display: flex; align-items: center; justify-content: center;" title="Download">
                <svg fill="currentColor" height="16" viewBox="0 0 24 24" width="16">
                  <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"></path>
                </svg>
              </button>
            </div>
          `;
        } else if (data.type === 'video') {
          messageEl.className = 'ig-message ig-message-received';
          const filename = data.original_filename || data.content.split('/').pop();
          messageEl.innerHTML = `
            <div style="position: relative; display: inline-block;">
              <video controls style="max-width: 250px; max-height: 350px; border-radius: 18px; display: block;">
                <source src="${data.content}">
              </video>
              <button onclick="event.stopPropagation(); downloadFile('${data.content}', '${filename}')" style="position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.6); border: none; color: white; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; display: flex; align-items: center; justify-content: center;" title="Download">
                <svg fill="currentColor" height="16" viewBox="0 0 24 24" width="16">
                  <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"></path>
                </svg>
              </button>
            </div>
          `;
        } else if (data.type === 'file') {
          messageEl.className = 'ig-message ig-message-received';
          const fileName = data.original_filename || data.content.split('/').pop();
          const isPdf = data.content.match(/\.pdf$/i) || fileName.match(/\.pdf$/i);
          const isDoc = data.content.match(/\.(doc|docx|txt)$/i) || fileName.match(/\.(doc|docx|txt)$/i);
          const icon = isPdf ? 'üìÑ' : isDoc ? 'üìù' : 'üìé';
          
          const fileWrapper = document.createElement('div');
          fileWrapper.style.cssText = 'position: relative; display: inline-block;';
          
          const fileContainer = document.createElement('div');
          fileContainer.style.cssText = 'display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--ig-secondary-background); border-radius: 12px; max-width: 250px; cursor: pointer;';
          fileContainer.onclick = (e) => {
            if (!e.target.closest('button')) {
              openMediaPreview(data.content, 'file', fileName);
            }
          };
          
          // Add context menu support
          fileContainer.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            e.stopPropagation();
            showMessageContextMenu(e, data.id, data.content, false, data.type);
          });
          
          fileContainer.innerHTML = `
            <div style="font-size: 32px;">${icon}</div>
            <div style="flex: 1; min-width: 0;">
              <div style="font-weight: 600; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${fileName}</div>
              <div style="font-size: 12px; color: var(--ig-secondary-text); margin-top: 4px;">Click to preview</div>
            </div>
          `;
          
          // Add three-dot menu button
          const menuBtn = document.createElement('button');
          menuBtn.onclick = (e) => {
            e.stopPropagation();
            showMessageContextMenu(e, data.id, data.content, false, data.type);
          };
          menuBtn.style.cssText = 'position: absolute; top: 8px; left: 8px; background: rgba(0,0,0,0.6); border: none; color: white; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; display: flex; align-items: center; justify-content: center; opacity: 0.7; z-index: 10;';
          menuBtn.title = 'More options';
          menuBtn.innerHTML = `<svg fill="currentColor" height="16" viewBox="0 0 24 24" width="16"><circle cx="12" cy="5" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="12" cy="19" r="2"/></svg>`;
          
          const downloadBtn = document.createElement('button');
          downloadBtn.onclick = (e) => {
            e.stopPropagation();
            downloadFile(data.content, fileName);
          };
          downloadBtn.style.cssText = 'background: var(--ig-blue); border: none; color: white; border-radius: 50%; width: 36px; height: 36px; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0;';
          downloadBtn.title = 'Download';
          downloadBtn.innerHTML = `<svg fill="currentColor" height="18" viewBox="0 0 24 24" width="18"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"></path></svg>`;
          
          fileContainer.appendChild(downloadBtn);
          fileWrapper.appendChild(fileContainer);
          fileWrapper.appendChild(menuBtn);
          messageEl.appendChild(fileWrapper);
        } else if (data.type === 'location') {
          messageEl.className = 'ig-message ig-message-received';
          const loc = JSON.parse(data.content);
          messageEl.innerHTML = `
            <a href="https://www.google.com/maps?q=${loc.lat},${loc.lng}" target="_blank" style="display: block; text-decoration: none; color: inherit;">
              <div style="font-weight: 600;">üìç Location</div>
              <div style="font-size: 12px; opacity: 0.8;">Tap to view on map</div>
            </a>
          `;
        } else if (data.type === 'todo') {
          messageEl.className = 'ig-message ig-message-received';
          const todo = JSON.parse(data.content);
          let html = `<div style="font-weight: 600; margin-bottom: 8px;">‚úì ${todo.title}</div>`;
          todo.items.forEach((item, idx) => {
            html += `<div style="display: flex; align-items: center; gap: 8px; padding: 4px 0;">
              <input type="checkbox" ${item.checked ? 'checked' : ''} disabled style="width: 16px; height: 16px;">
              <span style="font-size: 14px;">${item.text}</span>
            </div>`;
          });
          messageEl.innerHTML = html;
        } else {
          messageEl.className = 'ig-message ig-message-received';
          
          // Add reply context if this is a reply
          if (data.reply_to_id) {
            // Try to find the original message in the DOM
            const originalMsg = messagesContainer.querySelector(`[data-message-id="${data.reply_to_id}"]`);
            if (originalMsg) {
              const originalContent = originalMsg.dataset.messageContent || 'Message';
              const replyDiv = document.createElement('div');
              replyDiv.style.cssText = 'border-left: 3px solid var(--ig-blue); padding: 6px 10px; margin-bottom: 8px; background: rgba(0,0,0,0.2); border-radius: 6px; cursor: pointer;';
              replyDiv.dataset.scrollToMessage = data.reply_to_id;
              replyDiv.innerHTML = `
                <div style="font-size: 11px; color: var(--ig-blue); font-weight: 600; margin-bottom: 2px;">
                  You
                </div>
                <div style="font-size: 12px; opacity: 0.8; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                  ${originalContent?.substring(0, 50) || 'Message'}
                </div>
              `;
              replyDiv.onclick = (e) => {
                e.stopPropagation();
                scrollToMessage(data.reply_to_id);
              };
              messageEl.appendChild(replyDiv);
            }
          }
          
          // Add text content with three-dot menu
          const textWrapper = document.createElement('div');
          textWrapper.style.cssText = 'position: relative; display: inline-block; width: 100%;';
          
          const textContent = document.createElement('div');
          textContent.textContent = data.content;
          textContent.style.cssText = 'padding-right: 30px;';
          
          // Add three-dot menu button for mobile
          const menuBtn = document.createElement('button');
          menuBtn.onclick = (e) => {
            e.stopPropagation();
            showMessageContextMenu(e, data.id, data.content, false, data.type);
          };
          menuBtn.style.cssText = 'position: absolute; top: 4px; right: 4px; background: transparent; border: none; color: var(--ig-secondary-text); border-radius: 50%; width: 24px; height: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; opacity: 0.6; padding: 0;';
          menuBtn.title = 'More options';
          menuBtn.innerHTML = `<svg fill="currentColor" height="16" viewBox="0 0 24 24" width="16"><circle cx="12" cy="5" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="12" cy="19" r="2"/></svg>`;
          
          textWrapper.appendChild(textContent);
          textWrapper.appendChild(menuBtn);
          messageEl.appendChild(textWrapper);
          
          const timeEl = document.createElement('div');
          timeEl.className = 'ig-message-time';
          timeEl.textContent = formatMessageTime(data.created_at);
          messageEl.appendChild(timeEl);
        }
        
        // Add data attributes and event listeners
        messageEl.dataset.messageId = data.id;
        messageEl.dataset.messageContent = data.content;
        messageEl.dataset.isSent = 'false';
        messageEl.dataset.isPinned = data.is_pinned ? 'true' : 'false';
        messageEl.dataset.isStarred = data.is_starred ? 'true' : 'false';
        
        messageEl.addEventListener('contextmenu', (e) => {
          e.preventDefault();
          showMessageContextMenu(e, data.id, data.content, false, data.type);
        });
        messageEl.addEventListener('click', (e) => {
          if (e.target.tagName !== 'IMG' && e.target.tagName !== 'BUTTON' && e.target.tagName !== 'AUDIO') {
            showMessageContextMenu(e, data.id, data.content, false, data.type);
          }
        });
        
        messagesContainer.appendChild(messageEl);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }
      
      // Reload conversations to update last message (with small delay to ensure DB is updated)
      setTimeout(() => {
        loadConversations();
      }, 300);
    });
    
    // Online/Offline status listeners
    socket.on('user:online', (userId) => {
      if (userId == currentContactId) {
        const statusEl = document.getElementById('chatStatus');
        if (statusEl) {
          statusEl.textContent = 'Active now';
          statusEl.style.color = 'var(--ig-secondary-text)';
        }
      }
    });
    
    socket.on('user:offline', (userId) => {
      if (userId == currentContactId) {
        const statusEl = document.getElementById('chatStatus');
        if (statusEl) {
          statusEl.textContent = 'Offline';
          statusEl.style.color = 'var(--ig-secondary-text)';
        }
      }
    });
    
    // Listen for expired messages
    socket.on('message:expired', (messageId) => {
      const messageEl = document.querySelector(`[data-message-id="${messageId}"]`);
      if (messageEl) {
        messageEl.style.transition = 'opacity 0.5s';
        messageEl.style.opacity = '0';
        setTimeout(() => {
          messageEl.remove();
        }, 500);
      }
    });
    
    // WebRTC call event listeners
    socket.off('call:incoming');
    socket.off('call:answered');
    socket.off('call:ice-candidate');
    socket.off('call:rejected');
    socket.off('call:ended');
    
    console.log('Registering call event listeners...');
    socket.on('call:incoming', (data) => {
      console.log('call:incoming event received:', data);
      showIncomingCall(data);
    });

    socket.on('call:answered', async (data) => {
      if (peerConnection && data.answer) {
        await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
      }
    });

    socket.on('call:ice-candidate', async (data) => {
      if (peerConnection && data.candidate) {
        await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
      }
    });

    socket.on('call:rejected', () => {
      InnovateAPI.showAlert('Call rejected', 'info');
      cleanupCall();
    });

    socket.on('call:ended', () => {
      InnovateAPI.showAlert('Call ended', 'info');
      cleanupCall();
    });
      
    // Emit user join
    socket.emit('user:join', user.id);
    console.log('Socket.IO listeners setup complete');
  }
    
    // Voice recording
    let mediaRecorder;
    let audioChunks = [];
    let isRecording = false;
    
    async function startVoiceRecording() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        isRecording = true;
        
        mediaRecorder.ondataavailable = (event) => {
          audioChunks.push(event.data);
        };
        
        mediaRecorder.onstop = async () => {
          const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
          await sendVoiceMessage(audioBlob);
          stream.getTracks().forEach(track => track.stop());
        };
        
        mediaRecorder.start();
        document.querySelector('.ig-voice-btn').style.background = '#ed4956';
      } catch (error) {
        InnovateAPI.showAlert('Microphone access denied', 'error');
      }
    }
    
    function stopVoiceRecording() {
      if (isRecording && mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
        isRecording = false;
        document.querySelector('.ig-voice-btn').style.background = '';
      }
    }
    
    async function sendVoiceMessage(audioBlob) {
      if (!currentContactId) return;
      
      const formData = new FormData();
      formData.append('audio', audioBlob, 'voice-message.webm');
      formData.append('receiver_id', currentContactId);
      formData.append('type', 'voice');
      
      try {
        const response = await InnovateAPI.apiRequest('/messages/send', {
          method: 'POST',
          body: formData,
          headers: {} // Let browser set Content-Type for FormData
        });
        
        loadMessages(currentContactId);
        InnovateAPI.showAlert('Voice message sent', 'success');
      } catch (error) {
        InnovateAPI.showAlert('Failed to send voice message', 'error');
      }
    }
    
    // Camera functions
    let cameraStream;
    
    async function openCamera() {
      document.getElementById('attachMenu').style.display = 'none';
      document.getElementById('cameraModal').style.display = 'flex';
      
      try {
        cameraStream = await navigator.mediaDevices.getUserMedia({ 
          video: { facingMode: 'user' } 
        });
        document.getElementById('cameraPreview').srcObject = cameraStream;
      } catch (error) {
        InnovateAPI.showAlert('Camera access denied', 'error');
        closeCameraModal();
      }
    }
    
    function closeCameraModal() {
      document.getElementById('cameraModal').style.display = 'none';
      if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
      }
    }
    
    async function capturePhoto() {
      const video = document.getElementById('cameraPreview');
      const canvas = document.getElementById('cameraCanvas');
      const context = canvas.getContext('2d');
      
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      context.drawImage(video, 0, 0);
      
      canvas.toBlob(async (blob) => {
        closeCameraModal();
        await sendFile(blob, 'camera-photo.jpg');
      }, 'image/jpeg', 0.9);
    }
    
    // Location sharing
    async function shareLocation() {
      document.getElementById('attachMenu').style.display = 'none';
      
      if (!navigator.geolocation) {
        InnovateAPI.showAlert('Geolocation not supported', 'error');
        return;
      }
      
      InnovateAPI.showAlert('Getting your location...', 'info');
      
      navigator.geolocation.getCurrentPosition(
        async (position) => {
          const location = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          };
          
          try {
            await InnovateAPI.apiRequest('/messages/send', {
              method: 'POST',
              body: JSON.stringify({
                receiver_id: currentContactId,
                content: JSON.stringify(location),
                type: 'location'
              })
            });
            
            loadMessages(currentContactId);
            InnovateAPI.showAlert('Location shared', 'success');
          } catch (error) {
            InnovateAPI.showAlert('Failed to share location', 'error');
          }
        },
        (error) => {
          InnovateAPI.showAlert('Location access denied', 'error');
        }
      );
    }
    
    // File sending
    async function sendFile(file, filename) {
      if (!currentContactId) {
        InnovateAPI.showAlert('Please select a conversation first', 'error');
        return;
      }
      
      const formData = new FormData();
      formData.append('file', file, filename || file.name);
      formData.append('receiver_id', currentContactId);
      
      // Determine type
      let fileType = 'file';
      if (file.type.startsWith('image/')) {
        fileType = 'image';
      } else if (file.type.startsWith('video/')) {
        fileType = 'video';
      }
      formData.append('type', fileType);
      
      try {
        const response = await InnovateAPI.apiRequest('/messages/send', {
          method: 'POST',
          body: formData
        });
        
        // Add file message to UI immediately with delivered status
        const messagesContainer = document.getElementById('chatMessages');
        const messageEl = document.createElement('div');
        messageEl.className = 'ig-message ig-message-sent';
        
        let icon = 'üìé';
        if (file.type.startsWith('image/')) icon = 'üì∑';
        else if (file.type.startsWith('video/')) icon = 'üé¨';
        else if (filename.match(/\.pdf$/i)) icon = 'üìÑ';
        else if (filename.match(/\.(doc|docx)$/i)) icon = 'üìù';
        
        messageEl.innerHTML = `
          <div style="display: inline-block;">
            <div style="font-size: 14px;">${icon} ${filename || file.name}</div>
            <div class="ig-message-time" style="display: flex; align-items: center; gap: 4px; justify-content: flex-end;">
              <span style="font-size: 11px;">Just now</span>
              <span style="font-size: 10px;">‚úì‚úì</span>
            </div>
          </div>
        `;
        messagesContainer.appendChild(messageEl);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
        // Reload messages to get full message data
        setTimeout(() => {
          loadMessages(currentContactId);
        }, 500);
        
        InnovateAPI.showAlert('File sent successfully', 'success');
      } catch (error) {
        console.error('File send error:', error);
        InnovateAPI.showAlert('Failed to send file', 'error');
      }
    }
    
    // Attach menu toggle
    function toggleAttachMenu() {
      const menu = document.getElementById('attachMenu');
      menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
    }
    
    // Emoji Picker Functions
    const emojis = [
      'üòÄ', 'üòÉ', 'üòÑ', 'üòÅ', 'üòÜ', 'üòÖ', 'ü§£', 'üòÇ', 'üôÇ', 'üôÉ', 'üòâ', 'üòä', 'üòá', 
      '‚ù§Ô∏è', 'üß°', 'üíõ', 'üíö', 'üíô', 'üíú', 'üñ§', 'ü§ç', 'ü§é', 'üíî', '‚ù£Ô∏è', 'üíï', 'üíû', 
      'üëç', 'üëé', 'üëä', '‚úä', 'ü§õ', 'ü§ú', 'ü§û', '‚úåÔ∏è', 'ü§ü', 'ü§ò', 'üëå', 'ü§è', 'üëà', 
      'üî•', '‚ú®', 'üí´', '‚≠ê', 'üåü', 'üí•', 'üí¢', 'üíØ', '‚úÖ', '‚ùå', '‚ö†Ô∏è', '‚ùó', '‚ùì',
      'üéâ', 'üéä', 'üéà', 'üéÅ', 'üèÜ', 'ü•á', 'ü•à', 'ü•â', '‚öΩ', 'üèÄ', 'üèà', '‚öæ', 'üéæ'
    ];
    
    function openEmojiPicker() {
      const modal = document.getElementById('emojiModal');
      const grid = document.querySelector('.ig-emoji-grid');
      
      // Populate emoji grid if empty
      if (!grid.hasChildNodes()) {
        emojis.forEach(emoji => {
          const btn = document.createElement('button');
          btn.className = 'ig-emoji-item';
          btn.textContent = emoji;
          btn.onclick = () => insertEmoji(emoji);
          grid.appendChild(btn);
        });
      }
      
      modal.style.display = 'flex';
    }
    
    function closeEmojiPicker() {
      document.getElementById('emojiModal').style.display = 'none';
    }
    
    function switchEmojiTab(tab) {
      const emojiTab = document.getElementById('emojiTab');
      const gifTab = document.getElementById('gifTab');
      const emojiContent = document.getElementById('emojiContent');
      const gifContent = document.getElementById('gifContent');
      
      if (tab === 'emoji') {
        emojiTab.classList.add('active');
        emojiTab.style.borderBottom = '2px solid var(--ig-blue)';
        emojiTab.style.color = 'var(--ig-primary-text)';
        gifTab.classList.remove('active');
        gifTab.style.borderBottom = '2px solid transparent';
        gifTab.style.color = 'var(--ig-secondary-text)';
        emojiContent.style.display = 'block';
        gifContent.style.display = 'none';
      } else {
        gifTab.classList.add('active');
        gifTab.style.borderBottom = '2px solid var(--ig-blue)';
        gifTab.style.color = 'var(--ig-primary-text)';
        emojiTab.classList.remove('active');
        emojiTab.style.borderBottom = '2px solid transparent';
        emojiTab.style.color = 'var(--ig-secondary-text)';
        gifContent.style.display = 'block';
        emojiContent.style.display = 'none';
        // Load trending GIFs on first open
        const gifGrid = document.getElementById('gifGridInPicker');
        if (gifGrid.children.length === 1) {
          searchGifsInPicker('trending');
        }
      }
    }
    
    function insertEmoji(emoji) {
      const input = document.getElementById('messageInput');
      const start = input.selectionStart;
      const end = input.selectionEnd;
      const text = input.value;
      
      input.value = text.substring(0, start) + emoji + text.substring(end);
      input.selectionStart = input.selectionEnd = start + emoji.length;
      input.focus();
      
      // Trigger input event to show send button if needed
      input.dispatchEvent(new Event('input'));
    }
    
    // GIF search in emoji picker
    let gifSearchTimeoutInPicker;
    async function searchGifsInPicker(query) {
      clearTimeout(gifSearchTimeoutInPicker);
      gifSearchTimeoutInPicker = setTimeout(async () => {
        const grid = document.getElementById('gifGridInPicker');
        grid.innerHTML = '<div style="text-align: center; padding: 20px; grid-column: 1/-1; color: var(--ig-secondary-text);">Searching...</div>';
        
        try {
          const endpoint = query === 'trending' ? 
            `https://api.giphy.com/v1/gifs/trending?api_key=${GIPHY_API_KEY}&limit=20` :
            `https://api.giphy.com/v1/gifs/search?api_key=${GIPHY_API_KEY}&q=${encodeURIComponent(query)}&limit=20`;
          
          const response = await fetch(endpoint);
          const data = await response.json();
          
          grid.innerHTML = '';
          if (data.data.length === 0) {
            grid.innerHTML = '<div style="text-align: center; padding: 40px; grid-column: 1/-1; color: var(--ig-secondary-text);">No GIFs found</div>';
            return;
          }
          
          data.data.forEach(gif => {
            const img = document.createElement('img');
            img.src = gif.images.fixed_height_small.url;
            img.style.cssText = 'width: 100%; height: 150px; object-fit: cover; border-radius: 8px; cursor: pointer;';
            img.onclick = () => sendGifFromPicker(gif.images.fixed_height.url);
            grid.appendChild(img);
          });
        } catch (error) {
          grid.innerHTML = '<div style="text-align: center; padding: 40px; grid-column: 1/-1; color: var(--ig-secondary-text);">Failed to load GIFs</div>';
        }
      }, 500);
    }
    
    async function sendGifFromPicker(gifUrl) {
      if (!currentContactId) {
        InnovateAPI.showAlert('Please select a conversation first', 'error');
        return;
      }
      
      closeEmojiPicker();
      
      try {
        await InnovateAPI.apiRequest('/messages/send', {
          method: 'POST',
          body: JSON.stringify({
            receiver_id: currentContactId,
            content: gifUrl,
            type: 'gif'
          })
        });
        
        loadMessages(currentContactId);
        InnovateAPI.showAlert('GIF sent', 'success');
      } catch (error) {
        InnovateAPI.showAlert('Failed to send GIF', 'error');
      }
    }
    
    // Message Actions Functions
    let selectedMessageId = null;
    let selectedMessageContent = null;
    let selectedMessageType = null;
    let selectedMessageIsSent = false;
    
    function showMessageActions(messageId, content, isSent) {
      selectedMessageId = messageId;
      selectedMessageContent = content;
      
      const modal = document.getElementById('messageActionsModal');
      const unsendBtn = document.getElementById('unsendBtn');
      const editBtn = document.getElementById('editBtn');
      
      // Only show unsend and edit for sent messages
      if (unsendBtn) {
        unsendBtn.style.display = isSent ? 'flex' : 'none';
      }
      if (editBtn) {
        editBtn.style.display = isSent ? 'flex' : 'none';
      }
      
      modal.style.display = 'flex';
    }
    
    function closeMessageActions() {
      document.getElementById('messageActionsModal').style.display = 'none';
      selectedMessageId = null;
      selectedMessageContent = null;
    }
    
    async function replyToMessage() {
      closeMessageActions();
      const input = document.getElementById('messageInput');
      const replyPreview = document.createElement('div');
      replyPreview.className = 'ig-reply-preview';
      replyPreview.innerHTML = `
        <div style="padding: 8px 12px; background: var(--ig-hover-overlay); border-left: 3px solid var(--ig-blue); margin-bottom: 8px; border-radius: 8px;">
          <div style="font-size: 12px; color: var(--ig-blue); margin-bottom: 4px;">Replying to message</div>
          <div style="font-size: 13px; color: var(--ig-secondary-text); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
            ${selectedMessageContent}
          </div>
          <button onclick="this.parentElement.remove()" style="position: absolute; right: 8px; top: 8px; background: none; border: none; cursor: pointer;">‚úï</button>
        </div>
      `;
      input.parentElement.insertBefore(replyPreview, input);
      input.focus();
    }
    
    async function copyMessage() {
      try {
        await navigator.clipboard.writeText(selectedMessageContent);
        InnovateAPI.showAlert('Message copied', 'success');
        closeMessageActions();
      } catch (error) {
        InnovateAPI.showAlert('Failed to copy message', 'error');
      }
    }
    
    // Old duplicate functions removed - using updated versions below
    
    // GIF Picker Functions
    let gifSearchTimeout;
    const GIPHY_API_KEY = 'Gc7131jiJuvI7IdN0HZ1D7nh0ow5BH6g'; // Public Giphy API key
    
    function openGifPicker() {
      document.getElementById('gifModal').style.display = 'flex';
      document.getElementById('gifSearch').value = '';
      searchGifs('trending');
    }
    
    function closeGifPicker() {
      document.getElementById('gifModal').style.display = 'none';
    }
    
    async function searchGifs(query) {
      clearTimeout(gifSearchTimeout);
      gifSearchTimeout = setTimeout(async () => {
        const grid = document.getElementById('gifGrid');
        grid.innerHTML = '<div style="text-align: center; padding: 20px; grid-column: 1/-1; color: var(--ig-secondary-text);">Searching...</div>';
        
        try {
          const endpoint = query === 'trending' ? 
            `https://api.giphy.com/v1/gifs/trending?api_key=${GIPHY_API_KEY}&limit=20` :
            `https://api.giphy.com/v1/gifs/search?api_key=${GIPHY_API_KEY}&q=${encodeURIComponent(query)}&limit=20`;
          
          const response = await fetch(endpoint);
          const data = await response.json();
          
          grid.innerHTML = '';
          if (data.data.length === 0) {
            grid.innerHTML = '<div style="text-align: center; padding: 40px; grid-column: 1/-1; color: var(--ig-secondary-text);">No GIFs found</div>';
            return;
          }
          
          data.data.forEach(gif => {
            const img = document.createElement('img');
            img.src = gif.images.fixed_height_small.url;
            img.style.cssText = 'width: 100%; height: 150px; object-fit: cover; border-radius: 8px; cursor: pointer;';
            img.onclick = () => sendGif(gif.images.fixed_height.url);
            grid.appendChild(img);
          });
        } catch (error) {
          grid.innerHTML = '<div style="text-align: center; padding: 40px; grid-column: 1/-1; color: var(--ig-secondary-text);">Failed to load GIFs</div>';
        }
      }, 500);
    }
    
    async function sendGif(gifUrl) {
      if (!currentContactId) return;
      
      closeGifPicker();
      toggleAttachMenu();
      
      try {
        await InnovateAPI.apiRequest('/messages/send', {
          method: 'POST',
          body: JSON.stringify({
            receiver_id: currentContactId,
            content: gifUrl,
            type: 'gif'
          })
        });
        
        loadMessages(currentContactId);
        InnovateAPI.showAlert('GIF sent', 'success');
      } catch (error) {
        InnovateAPI.showAlert('Failed to send GIF', 'error');
      }
    }
    
    // TODO List Functions
    let todoItemCount = 0;
    
    function openTodoCreator() {
      document.getElementById('todoModal').style.display = 'flex';
      document.getElementById('todoTitle').value = '';
      document.getElementById('todoItems').innerHTML = '';
      todoItemCount = 0;
      addTodoItem();
      toggleAttachMenu();
    }
    
    function closeTodoCreator() {
      document.getElementById('todoModal').style.display = 'none';
    }
    
    function addTodoItem() {
      const container = document.getElementById('todoItems');
      const itemId = ++todoItemCount;
      const div = document.createElement('div');
      div.style.cssText = 'display: flex; gap: 8px; margin-bottom: 8px; align-items: center;';
      div.innerHTML = `
        <input type="checkbox" id="todo_${itemId}" style="width: 18px; height: 18px;">
        <input type="text" class="todo-item-text" placeholder="Task ${itemId}..." style="flex: 1; padding: 8px; border: 1px solid var(--ig-border); border-radius: 6px; background: var(--ig-secondary-background); color: var(--ig-primary-text);">
        <button onclick="this.parentElement.remove()" style="background: none; border: none; color: var(--ig-secondary-text); cursor: pointer; font-size: 20px;">&times;</button>
      `;
      container.appendChild(div);
    }
    
    async function sendTodoList() {
      const title = document.getElementById('todoTitle').value || 'TODO List';
      const items = [];
      
      document.querySelectorAll('.todo-item-text').forEach(input => {
        if (input.value.trim()) {
          items.push({
            text: input.value.trim(),
            checked: false
          });
        }
      });
      
      if (items.length === 0) {
        InnovateAPI.showAlert('Please add at least one item', 'error');
        return;
      }
      
      const todoData = { title, items };
      
      try {
        await InnovateAPI.apiRequest('/messages/send', {
          method: 'POST',
          body: JSON.stringify({
            receiver_id: currentContactId,
            content: JSON.stringify(todoData),
            type: 'todo'
          })
        });
        
        // Add TODO message to UI immediately
        const messagesContainer = document.getElementById('chatMessages');
        const messageEl = document.createElement('div');
        messageEl.className = 'ig-message ig-message-sent';
        
        let html = `<div style="font-weight: 600; margin-bottom: 8px;">\u2713 ${title}</div>`;
        items.forEach((item) => {
          html += `<div style="display: flex; align-items: center; gap: 8px; padding: 4px 0;">
            <input type="checkbox" disabled style="width: 16px; height: 16px;">
            <span style="font-size: 14px;">${item.text}</span>
          </div>`;
        });
        html += `<div class="ig-message-time" style="display: flex; align-items: center; gap: 4px; justify-content: flex-end; margin-top: 8px;">
          <span style="font-size: 11px;">Just now</span>
          <span style="font-size: 10px;">\u2713\u2713</span>
        </div>`;
        messageEl.innerHTML = html;
        
        messagesContainer.appendChild(messageEl);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
        // Reload messages after delay to get full data
        setTimeout(() => {
          loadMessages(currentContactId);
        }, 500);
        
        InnovateAPI.showAlert('TODO list sent', 'success');
        closeTodoCreator();
      } catch (error) {
        InnovateAPI.showAlert('Failed to send TODO list', 'error');
      }
    }
    
    // Timer Message Functions
    let messageTimer = null;
    
    function openTimerPicker() {
      document.getElementById('timerModal').style.display = 'flex';
      toggleAttachMenu();
    }
    
    function closeTimerPicker() {
      document.getElementById('timerModal').style.display = 'none';
      messageTimer = null;
    }
    
    function setMessageTimer(seconds) {
      messageTimer = seconds;
      closeTimerPicker();
      const input = document.getElementById('messageInput');
      input.placeholder = `Message will disappear in ${formatTimerDuration(seconds)}...`;
      input.dataset.timer = seconds;
      input.focus();
      
      InnovateAPI.showAlert(`Timer set: ${formatTimerDuration(seconds)}`, 'success');
    }
    
    function formatTimerDuration(seconds) {
      if (seconds < 60) return `${seconds}s`;
      if (seconds < 3600) return `${Math.floor(seconds/60)}m`;
      if (seconds < 86400) return `${Math.floor(seconds/3600)}h`;
      return `${Math.floor(seconds/86400)}d`;
    }
    
    // Map Location Picker Functions
    let selectedLocation = null;
    
    function openMapPicker() {
      document.getElementById('mapModal').style.display = 'flex';
      selectedLocation = null;
      document.getElementById('mapCoords').textContent = 'Click on map to select location';
      toggleAttachMenu();
    }
    
    function closeMapPicker() {
      document.getElementById('mapModal').style.display = 'none';
      selectedLocation = null;
    }
    
    function selectPointOnMap(event) {
      const container = event.currentTarget;
      const rect = container.getBoundingClientRect();
      const x = event.clientX - rect.left;
      const y = event.clientY - rect.top;
      
      // Convert click position to approximate lat/lng (simplified)
      const lat = 40.7128 + (150 - y) / 10; // Example center: NYC
      const lng = -74.0060 + (x - 250) / 10;
      
      selectedLocation = { lat, lng };
      
      // Move pin to clicked position
      const pin = document.getElementById('mapPin');
      pin.style.left = x + 'px';
      pin.style.top = y + 'px';
      
      document.getElementById('mapCoords').textContent = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
    }
    
    function useCurrentLocation() {
      if (!navigator.geolocation) {
        InnovateAPI.showAlert('Geolocation not supported', 'error');
        return;
      }
      
      navigator.geolocation.getCurrentPosition(
        (position) => {
          selectedLocation = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          };
          document.getElementById('mapCoords').textContent = 
            `${selectedLocation.lat.toFixed(4)}, ${selectedLocation.lng.toFixed(4)}`;
          InnovateAPI.showAlert('Current location selected', 'success');
        },
        (error) => {
          InnovateAPI.showAlert('Failed to get location', 'error');
        }
      );
    }
    
    async function sendSelectedLocation() {
      if (!selectedLocation) {
        InnovateAPI.showAlert('Please select a location', 'error');
        return;
      }
      
      try {
        await InnovateAPI.apiRequest('/messages/send', {
          method: 'POST',
          body: JSON.stringify({
            receiver_id: currentContactId,
            content: JSON.stringify(selectedLocation),
            type: 'location'
          })
        });
        
        loadMessages(currentContactId);
        InnovateAPI.showAlert('Location shared', 'success');
        closeMapPicker();
      } catch (error) {
        InnovateAPI.showAlert('Failed to share location', 'error');
      }
    }
    
    // Handle Enter key
    function handleMessageKeyPress(event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
      }
    }
    
    // Update send button visibility based on input
    const messageInput = document.getElementById('messageInput');
    if (messageInput) {
      messageInput.addEventListener('input', (e) => {
        const hasText = e.target.value.trim();
        const isEditing = e.target.dataset.editingMessageId;
        const hasAttachmentChange = e.target.dataset.attachmentAction && e.target.dataset.attachmentAction !== 'keep';
        const sendBtn = document.getElementById('sendBtn');
        const voiceBtn = document.getElementById('voiceBtn');
        const moreBtn = document.getElementById('moreBtn');
        
        // Show send button if: has text, is editing, or has attachment changes
        if (hasText || isEditing || hasAttachmentChange) {
          if (sendBtn) sendBtn.style.display = 'inline-flex';
          if (voiceBtn) voiceBtn.style.display = 'none';
          if (moreBtn) moreBtn.style.display = 'none';
        } else {
          if (sendBtn) sendBtn.style.display = 'none';
          if (voiceBtn) voiceBtn.style.display = 'inline-flex';
          if (moreBtn) moreBtn.style.display = 'inline-flex';
        }
      });
    }

    // Check for user parameter (deep link from home)
    const urlParams = new URLSearchParams(window.location.search);
    const userId = urlParams.get('user');
    
    // Switch Messages/Requests tab
    function switchMessagesTab(tab) {
      document.getElementById('messagesTab').classList.toggle('active', tab === 'messages');
      document.getElementById('requestsTab').classList.toggle('active', tab === 'requests');
      
      if (tab === 'requests') {
        document.getElementById('conversationsList').innerHTML = `
          <div style=\"text-align: center; padding: 60px 20px; color: var(--ig-secondary-text);\">
            <div style=\"font-size: 48px; margin-bottom: 16px;\">üì¨</div>
            <div style=\"font-size: 16px;\">No message requests</div>
          </div>
        `;
      } else {
        loadConversations();
      }
    }
    
    // Open camera for specific user
    function openCameraForUser(userId) {
      currentContactId = userId;
      openCamera();
    }
    
    // Download file function
    function downloadFile(url, filename) {
      const link = document.createElement('a');
      link.href = url;
      link.download = filename || url.split('/').pop();
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
    
    // Open media preview modal
    function openMediaPreview(url, type, filename) {
      const modal = document.createElement('div');
      modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.95); z-index: 999999; display: flex; align-items: center; justify-content: center; flex-direction: column;';
      
      const displayFilename = filename || url.split('/').pop();
      let content = '';
      if (type === 'image' || type === 'gif') {
        content = `<img src="${url}" style="max-width: 90vw; max-height: 80vh; object-fit: contain; border-radius: 8px;">`;
      } else if (type === 'file') {
        const isPdf = url.match(/\.pdf$/i) || (filename && filename.match(/\.pdf$/i));
        const isTxt = url.match(/\.txt$/i) || (filename && filename.match(/\.txt$/i));
        const isDoc = url.match(/\.(doc|docx)$/i) || (filename && filename.match(/\.(doc|docx)$/i));
        
        if (isPdf) {
          // PDF preview with embedded viewer and loading state
          content = `<div style="width: 90vw; height: 85vh; position: relative;">
            <div id="pdfLoader" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; text-align: center;">
              <div class="ig-spinner" style="border-color: rgba(255,255,255,0.3); border-top-color: white; margin: 0 auto 16px;"></div>
              <div>Loading PDF...</div>
            </div>
            <iframe src="${url}#toolbar=1&navpanes=0&scrollbar=1" style="width: 100%; height: 100%; border: none; border-radius: 8px; background: white;" onload="document.getElementById('pdfLoader')?.remove()"></iframe>
          </div>`;
        } else if (isTxt) {
          // Text file preview - fetch and display content with loading
          content = `<div id="textPreviewContainer" style="width: 90vw; height: 85vh; background: white; border-radius: 8px; overflow: auto; padding: 20px; position: relative;">
            <div id="textLoader" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #666; text-align: center;">
              <div class="ig-spinner" style="margin: 0 auto 16px;"></div>
              <div>Loading text file...</div>
            </div>
          </div>`;
          // Fetch text content with timeout
          const fetchTimeout = setTimeout(() => {
            const container = document.getElementById('textPreviewContainer');
            if (container) {
              container.innerHTML = `<div style="text-align: center; padding: 40px; color: #666;">
                <div style="font-size: 48px; margin-bottom: 16px;">‚è±Ô∏è</div>
                <div style="font-size: 16px; margin-bottom: 12px;">Loading taking too long</div>
                <button onclick="downloadFile('${url}', '${displayFilename}')" style="padding: 10px 20px; background: var(--ig-blue); color: white; border: none; border-radius: 8px; cursor: pointer;">Download Instead</button>
              </div>`;
            }
          }, 5000); // 5 second timeout

          fetch(url)
            .then(response => {
              if (!response.ok) throw new Error('Failed to load');
              return response.text();
            })
            .then(text => {
              clearTimeout(fetchTimeout);
              const container = document.getElementById('textPreviewContainer');
              if (container) {
                // Limit text size for performance
                const displayText = text.length > 100000 ? text.substring(0, 100000) + '\\n\\n... (File too large, showing first 100KB)' : text;
                container.innerHTML = `<pre style="white-space: pre-wrap; word-wrap: break-word; font-family: 'Courier New', monospace; font-size: 14px; line-height: 1.5; color: #333; margin: 0;">${displayText.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</pre>`;
              }
            })
            .catch(() => {
              clearTimeout(fetchTimeout);
              const container = document.getElementById('textPreviewContainer');
              if (container) {
                container.innerHTML = `<div style="text-align: center; padding: 40px; color: #666;">
                  <div style="font-size: 48px; margin-bottom: 16px;">‚ùå</div>
                  <div style="font-size: 16px; margin-bottom: 12px;">Failed to load text file</div>
                  <button onclick="downloadFile('${url}', '${displayFilename}')" style="padding: 10px 20px; background: var(--ig-blue); color: white; border: none; border-radius: 8px; cursor: pointer;">Download File</button>
                </div>`;
              }
            });
        } else if (isDoc) {
          // DOC/DOCX - direct download with preview message
          content = `<div style="text-align: center; color: white; padding: 40px; max-width: 600px;">
            <div style="font-size: 64px; margin-bottom: 20px;">üìù</div>
            <div style="font-size: 20px; font-weight: 600; margin-bottom: 12px;">${displayFilename}</div>
            <div style="font-size: 16px; margin-bottom: 8px; color: rgba(255,255,255,0.9);">Word Document</div>
            <div style="font-size: 14px; margin-bottom: 30px; color: rgba(255,255,255,0.7); line-height: 1.6;">Preview not available for Word documents in this environment. Download the file to view it in Microsoft Word or compatible viewer.</div>
            <button onclick="downloadFile('${url}', '${displayFilename}')" style="padding: 14px 32px; background: var(--ig-blue); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600; box-shadow: 0 4px 12px rgba(0,149,246,0.3);">
              <svg fill="currentColor" height="20" viewBox="0 0 24 24" width="20" style="vertical-align: middle; margin-right: 8px;">
                <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"></path>
              </svg>
              Download File
            </button>
            <div style="font-size: 12px; margin-top: 16px; color: rgba(255,255,255,0.5);">
              Supported viewers: Microsoft Word, Google Docs, LibreOffice
            </div>
          </div>`;
        } else {
          content = `<div style="text-align: center; color: white; padding: 40px;">
            <div style="font-size: 64px; margin-bottom: 20px;">üìÑ</div>
            <div style="font-size: 20px; font-weight: 600; margin-bottom: 12px;">${displayFilename}</div>
            <div style="font-size: 18px; margin-bottom: 30px; color: rgba(255,255,255,0.7);">Preview not available</div>
            <button onclick="downloadFile('${url}', '${displayFilename}')" style="padding: 14px 28px; background: var(--ig-blue); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600;">Download File</button>
          </div>`;
        }
      }
      
      modal.innerHTML = `
        <div style="position: absolute; top: 20px; right: 20px; display: flex; gap: 12px;">
          <button onclick="downloadFile('${url}', '${displayFilename}')" style="background: rgba(255,255,255,0.2); border: none; color: white; border-radius: 50%; width: 48px; height: 48px; cursor: pointer; display: flex; align-items: center; justify-content: center;" title="Download">
            <svg fill="currentColor" height="24" viewBox="0 0 24 24" width="24">
              <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"></path>
            </svg>
          </button>
          <button onclick="this.closest('[style*=fixed]').remove()" style="background: rgba(255,255,255,0.2); border: none; color: white; border-radius: 50%; width: 48px; height: 48px; cursor: pointer; font-size: 32px; display: flex; align-items: center; justify-content: center;">&times;</button>
        </div>
        ${content}
      `;
      
      modal.onclick = (e) => {
        if (e.target === modal) {
          modal.remove();
        }
      };
      
      document.body.appendChild(modal);
    }
    
    // Initialize - Wrap in DOMContentLoaded to ensure DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Messages page initializing...');
      
      // Initialize Socket.IO first
      const socket = InnovateAPI.getSocket();
      if (!socket) {
        console.error('Socket.IO not initialized!');
        InnovateAPI.initSocket();
      }
      
      // Setup socket event listeners
      setupSocketListeners();
      
      // Load user info and conversations
      loadUserInfo()
        .then(() => {
          console.log('User info loaded');
          return loadConversations();
        })
        .then(async () => {
          console.log('Conversations loaded:', conversations.length);
          if (userId) {
            // Find conversation with this user and open it
            const conv = conversations.find(c => c.contact_id == userId);
            if (conv) {
              console.log('Opening chat with user from existing conversation:', userId);
              openChat(conv.contact_id, conv.username, conv.profile_picture);
            } else {
              // No existing conversation; fetch user info and open a new chat window
              try {
                const userResp = await InnovateAPI.apiRequest(`/users/${userId}`);
                const u = userResp && userResp.user ? userResp.user : null;
                if (u) {
                  console.log('Opening chat with user (no prior conversation):', userId);
                  openChat(u.id, u.username, u.profile_picture);
                } else {
                  console.warn('User not found for direct message:', userId);
                }
              } catch (e) {
                console.error('Failed to open chat for user param:', e);
              }
            }
          }
        })
        .catch(error => {
          console.error('Initialization error:', error);
          InnovateAPI.showAlert('Failed to load messages', 'error');
        });
    });

    // Voice and Video Calling with WebRTC
    let localStream = null;
    let remoteStream = null;
    let peerConnection = null;
    let isCallActive = false;
    let isVideoCall = false;
    let isMuted = false;
    let isVideoEnabled = true;
    let callStartTime = null;
    let callDurationInterval = null;
    let currentCallContactId = null;

    const configuration = {
      iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' }
      ]
    };

    // Start voice call
    async function startVoiceCall() {
      if (!currentContactId) {
        InnovateAPI.showAlert('Please select a conversation first', 'error');
        return;
      }
      isVideoCall = false;
      await initiateCall(false);
    }

    // Start video call
    async function startVideoCall() {
      if (!currentContactId) {
        InnovateAPI.showAlert('Please select a conversation first', 'error');
        return;
      }
      isVideoCall = true;
      await initiateCall(true);
    }

    // Initiate call
    async function initiateCall(video) {
      try {
        // Get user media
        localStream = await navigator.mediaDevices.getUserMedia({
          audio: true,
          video: video
        });

        // Set up call
        currentCallContactId = currentContactId;
        setupCallUI(video);
        
        // Create peer connection
        peerConnection = new RTCPeerConnection(configuration);
        
        // Add local stream to peer connection
        localStream.getTracks().forEach(track => {
          peerConnection.addTrack(track, localStream);
        });

        // Handle ICE candidates
        peerConnection.onicecandidate = (event) => {
          if (event.candidate) {
            InnovateAPI.getSocket().emit('call:ice-candidate', {
              to: currentCallContactId,
              candidate: event.candidate
            });
          }
        };

        // Handle remote stream
        peerConnection.ontrack = (event) => {
          if (!remoteStream) {
            remoteStream = new MediaStream();
            document.getElementById('remoteVideo').srcObject = remoteStream;
          }
          remoteStream.addTrack(event.track);
        };

        // Create and send offer
        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);

        // Get contact info for call
        const contactData = conversations.find(c => c.contact_id === currentCallContactId);
        
        console.log('Initiating call to user:', currentCallContactId);
        console.log('Caller info:', { id: user.id, username: user.username });
        
        InnovateAPI.getSocket().emit('call:initiate', {
          to: currentCallContactId,
          from: user.id,
          offer: offer,
          isVideo: video,
          caller: {
            username: user.username,
            profile_picture: user.profile_picture
          }
        });

        showActiveCall(contactData?.username || 'User', contactData?.profile_picture);
        
      } catch (error) {
        console.error('Error starting call:', error);
        InnovateAPI.showAlert('Failed to access camera/microphone', 'error');
      }
    }

    // Setup call UI
    function setupCallUI(video) {
      const localVideo = document.getElementById('localVideo');
      const remoteVideo = document.getElementById('remoteVideo');
      
      if (localStream) {
        localVideo.srcObject = localStream;
        localVideo.style.display = video ? 'block' : 'none';
      }
      
      remoteVideo.style.display = video ? 'block' : 'none';
      
      // Show/hide video button based on call type
      document.getElementById('videoBtn').style.display = video ? 'flex' : 'none';
    }

    // Show active call UI
    function showActiveCall(name, avatar) {
      document.getElementById('activeCallModal').style.display = 'flex';
      document.getElementById('activeCallName').textContent = name;
      document.getElementById('activeCallAvatar').src = InnovateAPI.getUserAvatar(avatar);
      
      isCallActive = true;
      callStartTime = Date.now();
      
      // Start duration counter
      callDurationInterval = setInterval(updateCallDuration, 1000);
    }

    // Update call duration
    function updateCallDuration() {
      if (!callStartTime) return;
      
      const elapsed = Math.floor((Date.now() - callStartTime) / 1000);
      const minutes = Math.floor(elapsed / 60);
      const seconds = elapsed % 60;
      
      document.getElementById('callDuration').textContent = 
        `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    }

    // Show incoming call
    function showIncomingCall(data) {
      console.log('Incoming call received:', data);
      document.getElementById('incomingCallModal').style.display = 'flex';
      document.getElementById('incomingCallName').textContent = data.caller.username;
      document.getElementById('incomingCallAvatar').src = InnovateAPI.getUserAvatar(data.caller.profile_picture);
      document.getElementById('incomingCallType').textContent = 
        data.isVideo ? 'Incoming video call...' : 'Incoming voice call...';
      
      // Store call data for accepting
      window.incomingCallData = data;
    }

    // Accept call
    async function acceptCall() {
      const data = window.incomingCallData;
      if (!data) return;

      try {
        isVideoCall = data.isVideo;
        currentCallContactId = data.from;
        
        // Get user media
        localStream = await navigator.mediaDevices.getUserMedia({
          audio: true,
          video: data.isVideo
        });

        // Hide incoming call modal
        document.getElementById('incomingCallModal').style.display = 'none';
        
        // Setup call UI
        setupCallUI(data.isVideo);
        showActiveCall(data.caller.username, data.caller.profile_picture);

        // Create peer connection
        peerConnection = new RTCPeerConnection(configuration);
        
        // Add local stream
        localStream.getTracks().forEach(track => {
          peerConnection.addTrack(track, localStream);
        });

        // Handle ICE candidates
        peerConnection.onicecandidate = (event) => {
          if (event.candidate) {
            InnovateAPI.getSocket().emit('call:ice-candidate', {
              to: currentCallContactId,
              candidate: event.candidate
            });
          }
        };

        // Handle remote stream
        peerConnection.ontrack = (event) => {
          if (!remoteStream) {
            remoteStream = new MediaStream();
            document.getElementById('remoteVideo').srcObject = remoteStream;
          }
          remoteStream.addTrack(event.track);
        };

        // Set remote description and create answer
        await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
        const answer = await peerConnection.createAnswer();
        await peerConnection.setLocalDescription(answer);

        // Send answer
        InnovateAPI.getSocket().emit('call:answer', {
          to: data.from,
          answer: answer
        });

      } catch (error) {
        console.error('Error accepting call:', error);
        InnovateAPI.showAlert('Failed to accept call', 'error');
        rejectCall();
      }
    }

    // Reject call
    function rejectCall() {
      const data = window.incomingCallData;
      if (data) {
        InnovateAPI.getSocket().emit('call:reject', {
          to: data.from
        });
      }
      
      document.getElementById('incomingCallModal').style.display = 'none';
      window.incomingCallData = null;
    }

    // End call
    function endCall() {
      // Send end call signal
      if (currentCallContactId) {
        InnovateAPI.getSocket().emit('call:end', {
          to: currentCallContactId
        });
      }

      // Clean up
      cleanupCall();
    }

    // Cleanup call resources
    function cleanupCall() {
      // Stop all tracks
      if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
        localStream = null;
      }

      if (remoteStream) {
        remoteStream.getTracks().forEach(track => track.stop());
        remoteStream = null;
      }

      // Close peer connection
      if (peerConnection) {
        peerConnection.close();
        peerConnection = null;
      }

      // Clear duration interval
      if (callDurationInterval) {
        clearInterval(callDurationInterval);
        callDurationInterval = null;
      }

      // Hide call UI
      document.getElementById('activeCallModal').style.display = 'none';
      document.getElementById('incomingCallModal').style.display = 'none';

      // Reset state
      isCallActive = false;
      currentCallContactId = null;
      callStartTime = null;
      isMuted = false;
      isVideoEnabled = true;
    }

    // Toggle mute
    function toggleMute() {
      if (!localStream) return;
      
      const audioTrack = localStream.getAudioTracks()[0];
      if (audioTrack) {
        audioTrack.enabled = !audioTrack.enabled;
        isMuted = !audioTrack.enabled;
        
        const muteBtn = document.getElementById('muteBtn');
        muteBtn.style.background = isMuted ? '#ed4956' : 'rgba(255,255,255,0.2)';
      }
    }

    // Toggle video
    function toggleVideo() {
      if (!localStream) return;
      
      const videoTrack = localStream.getVideoTracks()[0];
      if (videoTrack) {
        videoTrack.enabled = !videoTrack.enabled;
        isVideoEnabled = videoTrack.enabled;
        
        const videoBtn = document.getElementById('videoBtn');
        videoBtn.style.background = !isVideoEnabled ? '#ed4956' : 'rgba(255,255,255,0.2)';
        
        document.getElementById('localVideo').style.display = isVideoEnabled ? 'block' : 'none';
      }
    }

    // Toggle speaker (placeholder - browser handles audio output)
    function toggleSpeaker() {
      InnovateAPI.showAlert('Speaker toggle', 'info');
    }

    // Scroll to specific message (for reply navigation)
    function scrollToMessage(messageId) {
      const messagesContainer = document.getElementById('chatMessages');
      const messageEl = messagesContainer.querySelector(`[data-message-id="${messageId}"]`);
      
      if (messageEl) {
        messageEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        // Highlight the message temporarily
        const originalBg = messageEl.style.background;
        messageEl.style.background = 'rgba(0, 149, 246, 0.2)';
        messageEl.style.transition = 'background 0.3s';
        
        setTimeout(() => {
          messageEl.style.background = originalBg;
          setTimeout(() => {
            messageEl.style.background = '';
            messageEl.style.transition = '';
          }, 300);
        }, 1000);
      }
    }

    // Message Context Menu Functions
    function showMessageContextMenu(event, messageId, content, isSent, type) {
      event.preventDefault();
      selectedMessageId = messageId;
      selectedMessageContent = content;
      selectedMessageType = type;
      selectedMessageIsSent = isSent;
      
      // Check if message is pinned
      const messageEl = document.querySelector(`[data-message-id="${messageId}"]`);
      const isPinned = messageEl?.dataset.isPinned === 'true';
      const isStarred = messageEl?.dataset.isStarred === 'true';
      
      // Update pin button text
      const pinBtn = document.querySelector('[onclick="pinMessage(event)"]');
      if (pinBtn) {
        const pinSvg = pinBtn.querySelector('svg');
        pinBtn.innerHTML = '';
        pinBtn.appendChild(pinSvg);
        const textNode = document.createTextNode(isPinned ? ' Unpin' : ' Pin');
        pinBtn.appendChild(textNode);
      }
      
      // Update star button text
      const starBtn = document.querySelector('[onclick="starMessage(event)"]');
      if (starBtn) {
        const starSvg = starBtn.querySelector('svg');
        starBtn.innerHTML = '';
        starBtn.appendChild(starSvg);
        const textNode = document.createTextNode(isStarred ? ' Unstar' : ' Star');
        starBtn.appendChild(textNode);
      }
      
      const menu = document.getElementById('messageContextMenu');
      
      // Position menu at cursor or touch point
      let x = event.clientX || event.touches?.[0]?.clientX || 0;
      let y = event.clientY || event.touches?.[0]?.clientY || 0;
      
      // Show menu temporarily to get dimensions
      menu.style.visibility = 'hidden';
      menu.style.display = 'block';
      menu.classList.add('active');
      
      const menuWidth = menu.offsetWidth;
      const menuHeight = menu.offsetHeight;
      const viewportWidth = window.innerWidth;
      const viewportHeight = window.innerHeight;
      
      // Adjust if menu goes off right edge
      if (x + menuWidth > viewportWidth) {
        x = viewportWidth - menuWidth - 10;
      }
      
      // Adjust if menu goes off bottom edge
      if (y + menuHeight > viewportHeight) {
        y = viewportHeight - menuHeight - 10;
      }
      
      // Ensure menu doesn't go off left or top edges
      x = Math.max(10, x);
      y = Math.max(10, y);
      
      menu.style.left = x + 'px';
      menu.style.top = y + 'px';
      menu.style.visibility = 'visible';
      menu.style.display = 'block';
      
      // Hide menu when clicking outside
      setTimeout(() => {
        document.addEventListener('click', hideMessageContextMenu);
      }, 10);
    }

    function hideMessageContextMenu() {
      const menu = document.getElementById('messageContextMenu');
      menu.classList.remove('active');
      menu.style.display = 'none';
      menu.style.visibility = '';
      document.removeEventListener('click', hideMessageContextMenu);
    }

    async function replyToMessage(event) {
      if (event) event.stopPropagation();
      hideMessageContextMenu();
      const input = document.getElementById('messageInput');
      const previewContainer = document.getElementById('messagePreviewContainer');
      
      // Clear edit mode if active
      delete input.dataset.editingMessageId;
      input.value = '';
      
      // Store reply message ID
      input.dataset.replyToMessageId = selectedMessageId;
      
      // Remove any existing previews/indicators
      previewContainer.innerHTML = '';
      
      const replyPreview = document.createElement('div');
      replyPreview.className = 'ig-reply-preview';
      replyPreview.style.cssText = 'padding: 8px 12px; background: var(--ig-secondary-background); border-left: 3px solid var(--ig-blue); margin-bottom: 4px; border-radius: 8px; position: relative;';
      replyPreview.innerHTML = `
        <div style="font-size: 12px; color: var(--ig-blue); margin-bottom: 4px; font-weight: 600;">Replying to message</div>
        <div style="font-size: 13px; color: var(--ig-secondary-text); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 90%;">
          ${selectedMessageContent?.substring(0, 100) || 'Message'}
        </div>
        <button onclick="cancelReply()" style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: var(--ig-secondary-text); font-size: 20px; line-height: 1;">√ó</button>
      `;
      previewContainer.appendChild(replyPreview);
      input.focus();
    }

    async function copyMessage(event) {
      if (event) event.stopPropagation();
      hideMessageContextMenu();
      try {
        await navigator.clipboard.writeText(selectedMessageContent);
        InnovateAPI.showAlert('Message copied to clipboard', 'success');
      } catch (error) {
        InnovateAPI.showAlert('Failed to copy message', 'error');
      }
    }

    async function forwardMessage(event) {
      console.log('Forward message clicked', {selectedMessageId, selectedMessageContent});
      if (event) event.stopPropagation();
      hideMessageContextMenu();
      
      try {
        // For now, show a selection of recent conversations
        console.log('Fetching conversations...');
        const response = await InnovateAPI.apiRequest('/messages/conversations');
        console.log('Conversations response:', response);
        
        // Handle API response format
        const conversationsList = response.conversations || response || [];
        
        if (!conversationsList || conversationsList.length === 0) {
          InnovateAPI.showAlert('No conversations to forward to', 'error');
          return;
        }
        
        // Simple prompt for now (you can create a modal later)
        const contactList = conversationsList.slice(0, 5).map((c, i) => `${i + 1}. ${c.username}`).join('\n');
        const choice = prompt(`Forward message to:\n${contactList}\n\nEnter number (1-${Math.min(5, conversationsList.length)}):`);
        
        if (choice && !isNaN(choice) && choice >= 1 && choice <= Math.min(5, conversationsList.length)) {
          const selectedContact = conversationsList[parseInt(choice) - 1];
          console.log('Forwarding to:', selectedContact);
          try {
            await InnovateAPI.apiRequest('/messages', {
              method: 'POST',
              body: JSON.stringify({
                receiver_id: selectedContact.contact_id,
                content: selectedMessageContent
              })
            });
            InnovateAPI.showAlert(`Message forwarded to ${selectedContact.username}`, 'success');
          } catch (error) {
            console.error('Forward error:', error);
            InnovateAPI.showAlert('Failed to forward message: ' + error.message, 'error');
          }
        }
      } catch (error) {
        console.error('Forward message error:', error);
        InnovateAPI.showAlert('Error: ' + error.message, 'error');
      }
    }

    async function pinMessage(event) {
      console.log('Pin message clicked', {selectedMessageId, currentGroupId});
      if (event) event.stopPropagation();
      hideMessageContextMenu();
      
      // Check if message is already pinned
      const messageEl = document.querySelector(`[data-message-id="${selectedMessageId}"]`);
      const isPinned = messageEl?.dataset.isPinned === 'true';
      
      if (isPinned) {
        // Unpin if already pinned
        await unpinMessage();
      } else {
        // Show duration modal if not pinned
        showPinTimerModal();
      }
    }
    
    function showPinTimerModal() {
      const modal = document.createElement('div');
      modal.className = 'ig-modal-overlay';
      modal.innerHTML = `
        <div class="ig-modal" style="max-width: 400px;">
          <div style="padding: 24px; border-bottom: 1px solid var(--ig-border);">
            <h3 style="margin: 0; font-size: 20px; display: flex; align-items: center; gap: 8px;">
              <i class="fas fa-thumbtack"></i> Pin Message
            </h3>
          </div>
          <div style="padding: 24px;">
            <p style="margin: 0 0 20px 0; color: var(--ig-secondary-text); font-size: 14px;">
              How long do you want to pin this message?
            </p>
            
            <div style="display: flex; flex-direction: column; gap: 12px;">
              <button onclick="pinMessageWithDuration(1)" 
                style="padding: 16px; border: 1px solid var(--ig-border); border-radius: 12px; background: var(--ig-secondary-background); color: var(--ig-primary-text); cursor: pointer; font-size: 15px; font-weight: 500; transition: all 0.2s; text-align: left; display: flex; justify-content: space-between; align-items: center;"
                onmouseover="this.style.background='var(--ig-hover)'; this.style.borderColor='var(--ig-blue)'"
                onmouseout="this.style.background='var(--ig-secondary-background)'; this.style.borderColor='var(--ig-border)'">
                <span>üìÖ 1 Day</span>
                <i class="fas fa-chevron-right" style="font-size: 12px; opacity: 0.5;"></i>
              </button>
              
              <button onclick="pinMessageWithDuration(7)" 
                style="padding: 16px; border: 1px solid var(--ig-border); border-radius: 12px; background: var(--ig-secondary-background); color: var(--ig-primary-text); cursor: pointer; font-size: 15px; font-weight: 500; transition: all 0.2s; text-align: left; display: flex; justify-content: space-between; align-items: center;"
                onmouseover="this.style.background='var(--ig-hover)'; this.style.borderColor='var(--ig-blue)'"
                onmouseout="this.style.background='var(--ig-secondary-background)'; this.style.borderColor='var(--ig-border)'">
                <span>üìÖ 7 Days</span>
                <i class="fas fa-chevron-right" style="font-size: 12px; opacity: 0.5;"></i>
              </button>
              
              <button onclick="pinMessageWithDuration(30)" 
                style="padding: 16px; border: 1px solid var(--ig-border); border-radius: 12px; background: var(--ig-secondary-background); color: var(--ig-primary-text); cursor: pointer; font-size: 15px; font-weight: 500; transition: all 0.2s; text-align: left; display: flex; justify-content: space-between; align-items: center;"
                onmouseover="this.style.background='var(--ig-hover)'; this.style.borderColor='var(--ig-blue)'"
                onmouseout="this.style.background='var(--ig-secondary-background)'; this.style.borderColor='var(--ig-border)'">
                <span>üìÖ 30 Days</span>
                <i class="fas fa-chevron-right" style="font-size: 12px; opacity: 0.5;"></i>
              </button>
              
              <button onclick="pinMessageWithDuration(null)" 
                style="padding: 16px; border: 1px solid var(--ig-border); border-radius: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; cursor: pointer; font-size: 15px; font-weight: 600; transition: all 0.2s; text-align: left; display: flex; justify-content: space-between; align-items: center;"
                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.4)'"
                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                <span>üìå Until I unpin</span>
                <i class="fas fa-infinity" style="font-size: 16px;"></i>
              </button>
            </div>
          </div>
          <div style="padding: 16px 24px; border-top: 1px solid var(--ig-border); text-align: right;">
            <button onclick="this.closest('.ig-modal-overlay').remove()" 
              style="padding: 10px 20px; border: 1px solid var(--ig-border); border-radius: 8px; background: transparent; color: var(--ig-primary-text); cursor: pointer; font-weight: 500;">
              Cancel
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Close on overlay click
      modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
      });
    }
    
    async function pinMessageWithDuration(days) {
      // Close the modal
      document.querySelector('.ig-modal-overlay')?.remove();
      
      try {
        const endpoint = currentGroupId 
          ? `/groups/${currentGroupId}/messages/${selectedMessageId}/pin`
          : `/messages/${selectedMessageId}/pin`;
        
        console.log('Calling pin endpoint:', endpoint, 'with duration:', days);
        const result = await InnovateAPI.apiRequest(endpoint, { 
          method: 'POST',
          body: JSON.stringify({ pinDuration: days })
        });
        console.log('Pin result:', result);
        
        const durationText = days ? `for ${days} day${days > 1 ? 's' : ''}` : 'until unpinned';
        InnovateAPI.showAlert(`Message pinned ${durationText}!`, 'success');
        
        // Reload messages to show updated pin status
        if (currentGroupId) {
          await loadGroupChat();
        } else if (currentContactId) {
          await loadMessages(currentContactId);
        }
      } catch (error) {
        console.error('Pin error:', error);
        InnovateAPI.showAlert('Failed to pin message: ' + error.message, 'error');
      }
    }
    
    async function unpinMessage() {
      try {
        const endpoint = currentGroupId 
          ? `/groups/${currentGroupId}/messages/${selectedMessageId}/pin`
          : `/messages/${selectedMessageId}/pin`;
        
        console.log('Calling unpin endpoint:', endpoint);
        const result = await InnovateAPI.apiRequest(endpoint, { 
          method: 'POST',
          body: JSON.stringify({})
        });
        console.log('Unpin result:', result);
        
        InnovateAPI.showAlert('Message unpinned!', 'success');
        
        // Reload messages to show updated pin status
        if (currentGroupId) {
          await loadGroupChat();
        } else if (currentContactId) {
          await loadMessages(currentContactId);
        }
      } catch (error) {
        console.error('Unpin error:', error);
        InnovateAPI.showAlert('Failed to unpin message: ' + error.message, 'error');
      }
    }
    
    async function unpinMessageFromBanner(messageId) {
      console.log('Unpinning message from banner:', messageId);
      try {
        const endpoint = currentGroupId 
          ? `/groups/${currentGroupId}/messages/${messageId}/pin`
          : `/messages/${messageId}/pin`;
        
        console.log('Calling unpin endpoint:', endpoint);
        const result = await InnovateAPI.apiRequest(endpoint, { 
          method: 'POST',
          body: JSON.stringify({})
        });
        console.log('Unpin result:', result);
        
        InnovateAPI.showAlert('Message unpinned!', 'success');
        
        // Reload messages to show updated pin status
        if (currentGroupId) {
          await loadGroupChat();
        } else if (currentContactId) {
          await loadMessages(currentContactId);
        }
      } catch (error) {
        console.error('Unpin error:', error);
        InnovateAPI.showAlert('Failed to unpin message: ' + error.message, 'error');
      }
    }

    async function starMessage(event) {
      console.log('Star message clicked', {selectedMessageId});
      if (event) event.stopPropagation();
      hideMessageContextMenu();
      try {
        console.log('Calling star endpoint for message:', selectedMessageId);
        const response = await InnovateAPI.apiRequest(`/messages/${selectedMessageId}/star`, { 
          method: 'POST' 
        });
        console.log('Star response:', response);
        const action = response.starred ? 'starred' : 'unstarred';
        InnovateAPI.showAlert(`Message ${action}`, 'success');
        
        // Reload messages to show updated star status
        if (currentContactId) {
          await loadMessages(currentContactId);
        }
      } catch (error) {
        console.error('Star error:', error);
        InnovateAPI.showAlert('Failed to star message: ' + error.message, 'error');
      }
    }

    async function editMessage(event) {
      if (event) event.stopPropagation();
      hideMessageContextMenu();
      if (!selectedMessageIsSent) {
        InnovateAPI.showAlert('You can only edit your own messages', 'error');
        return;
      }
      
      const input = document.getElementById('messageInput');
      const previewContainer = document.getElementById('messagePreviewContainer');
      
      // Clear reply mode if active
      delete input.dataset.replyToMessageId;
      
      // Remove any existing previews/indicators
      previewContainer.innerHTML = '';
      
      // Get the message element to check for attachments
      const messageEl = document.querySelector(`[data-message-id="${selectedMessageId}"]`);
      const hasFile = selectedMessageType !== 'text';
      
      // For file messages, don't show the file path in the input
      // File paths start with /uploads/, so we can check for that
      if (!hasFile) {
        input.value = selectedMessageContent || '';
      } else if (selectedMessageContent && !selectedMessageContent.startsWith('/uploads/')) {
        // If there's additional text content with the file, show it
        input.value = selectedMessageContent;
      } else {
        input.value = '';
      }
      
      input.dataset.editingMessageId = selectedMessageId;
      
      // Initialize attachment state
      if (hasFile) {
        input.dataset.originalFileType = selectedMessageType;
        input.dataset.attachmentAction = 'keep'; // keep, remove, or replace
      }
      
      // Show send button in edit mode
      const sendBtn = document.getElementById('sendBtn');
      if (sendBtn) sendBtn.style.display = 'inline-flex';
      
      const voiceBtn = document.getElementById('voiceBtn');
      const moreBtn = document.getElementById('moreBtn');
      if (voiceBtn) voiceBtn.style.display = 'none';
      if (moreBtn) moreBtn.style.display = 'none';
      
      input.focus();
      
      // Show edit indicator
      const editIndicator = document.createElement('div');
      editIndicator.className = 'ig-edit-indicator';
      editIndicator.style.cssText = 'padding: 8px 12px; background: var(--ig-secondary-background); border-left: 3px solid #ffa500; margin-bottom: 4px; border-radius: 8px; position: relative;';
      
      let indicatorHTML = `
        <div style="font-size: 12px; color: #ffa500; font-weight: 600; margin-bottom: 8px;">Editing message</div>
      `;
      
      // Show existing attachment if present
      if (hasFile && messageEl) {
        const fileContainer = messageEl.querySelector('.ig-message-file, .ig-message-image, .ig-message-video');
        if (fileContainer) {
          const filePreview = fileContainer.cloneNode(true);
          filePreview.style.cssText = 'max-width: 200px; margin: 8px 0; position: relative;';
          filePreview.id = 'editAttachmentPreview';
          
          // Add remove button
          const removeBtn = document.createElement('button');
          removeBtn.onclick = () => removeEditAttachment();
          removeBtn.style.cssText = 'position: absolute; top: 4px; right: 4px; background: rgba(0,0,0,0.7); border: none; border-radius: 50%; width: 24px; height: 24px; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 10;';
          removeBtn.innerHTML = '√ó';
          removeBtn.title = 'Remove attachment';
          filePreview.appendChild(removeBtn);
          
          editIndicator.appendChild(filePreview);
        }
      }
      
      // Add file upload buttons for edit mode
      indicatorHTML += `
        <div id="editFileButtons" style="display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap;">
          <label class="ig-edit-file-btn" style="display: inline-flex; align-items: center; gap: 4px; padding: 6px 12px; background: var(--ig-blue); color: white; border-radius: 6px; cursor: pointer; font-size: 12px;">
            <svg fill="none" height="16" viewBox="0 0 24 24" width="16" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
              <circle cx="8.5" cy="8.5" r="1.5" fill="currentColor"/>
              <path d="M21 15l-5-5L5 21"/>
            </svg>
            Image
            <input type="file" accept="image/*" onchange="replaceEditAttachment(this.files[0], 'image')" style="display: none;">
          </label>
          <label class="ig-edit-file-btn" style="display: inline-flex; align-items: center; gap: 4px; padding: 6px 12px; background: var(--ig-blue); color: white; border-radius: 6px; cursor: pointer; font-size: 12px;">
            <svg fill="none" height="16" viewBox="0 0 24 24" width="16" stroke="currentColor" stroke-width="2">
              <path d="M23 7l-7 5 7 5V7z"/>
              <rect x="1" y="5" width="15" height="14" rx="2" ry="2"/>
            </svg>
            Video
            <input type="file" accept="video/*" onchange="replaceEditAttachment(this.files[0], 'video')" style="display: none;">
          </label>
          <label class="ig-edit-file-btn" style="display: inline-flex; align-items: center; gap: 4px; padding: 6px 12px; background: var(--ig-blue); color: white; border-radius: 6px; cursor: pointer; font-size: 12px;">
            <svg fill="none" height="16" viewBox="0 0 24 24" width="16" stroke="currentColor" stroke-width="2">
              <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/>
              <path d="M13 2v7h7"/>
            </svg>
            Document
            <input type="file" accept=".pdf,.doc,.docx,.txt" onchange="replaceEditAttachment(this.files[0], 'document')" style="display: none;">
          </label>
        </div>
        <button onclick="cancelEdit()" style="position: absolute; right: 8px; top: 8px; background: none; border: none; cursor: pointer; color: var(--ig-secondary-text); font-size: 20px; line-height: 1;">√ó</button>
      `;
      
      editIndicator.innerHTML = indicatorHTML;
      previewContainer.appendChild(editIndicator);
    }
    
    // Handle attachment removal during edit
    function removeEditAttachment() {
      const input = document.getElementById('messageInput');
      input.dataset.attachmentAction = 'remove';
      delete input.dataset.newFile;
      delete input.dataset.newFileType;
      
      const preview = document.getElementById('editAttachmentPreview');
      if (preview) {
        preview.remove();
      }
      
      // Keep send button visible
      const sendBtn = document.getElementById('sendBtn');
      if (sendBtn) sendBtn.style.display = 'inline-flex';
      
      InnovateAPI.showAlert('Attachment will be removed', 'info');
    }
    
    // Handle attachment replacement during edit
    function replaceEditAttachment(file, type) {
      if (!file) return;
      
      const input = document.getElementById('messageInput');
      input.dataset.attachmentAction = 'replace';
      input.dataset.newFileType = type;
      
      // Store file for submission
      window.editingNewFile = file;
      
      // Remove old preview
      const oldPreview = document.getElementById('editAttachmentPreview');
      if (oldPreview) {
        oldPreview.remove();
      }
      
      // Create new preview
      const editIndicator = document.querySelector('.ig-edit-indicator');
      const fileButtons = document.getElementById('editFileButtons');
      
      const newPreview = document.createElement('div');
      newPreview.id = 'editAttachmentPreview';
      newPreview.style.cssText = 'max-width: 200px; margin: 8px 0; position: relative;';
      
      if (type === 'image') {
        const img = document.createElement('img');
        img.src = URL.createObjectURL(file);
        img.style.cssText = 'width: 100%; border-radius: 8px;';
        img.onload = () => URL.revokeObjectURL(img.src);
        newPreview.appendChild(img);
      } else if (type === 'video') {
        const video = document.createElement('video');
        video.src = URL.createObjectURL(file);
        video.style.cssText = 'width: 100%; border-radius: 8px;';
        video.controls = true;
        newPreview.appendChild(video);
      } else {
        const fileInfo = document.createElement('div');
        fileInfo.style.cssText = 'padding: 12px; background: rgba(255,255,255,0.1); border-radius: 8px; display: flex; align-items: center; gap: 8px;';
        fileInfo.innerHTML = `
          <svg fill="none" height="24" viewBox="0 0 24 24" width="24" stroke="currentColor" stroke-width="2">
            <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/>
            <path d="M13 2v7h7"/>
          </svg>
          <div style="flex: 1; overflow: hidden;">
            <div style="font-size: 12px; font-weight: 600; overflow: hidden; text-overflow: ellipsis;">${file.name}</div>
            <div style="font-size: 10px; opacity: 0.7;">${(file.size / 1024).toFixed(1)} KB</div>
          </div>
        `;
        newPreview.appendChild(fileInfo);
      }
      
      // Add remove button
      const removeBtn = document.createElement('button');
      removeBtn.onclick = () => {
        input.dataset.attachmentAction = input.dataset.originalFileType ? 'keep' : 'remove';
        delete window.editingNewFile;
        newPreview.remove();
      };
      removeBtn.style.cssText = 'position: absolute; top: 4px; right: 4px; background: rgba(0,0,0,0.7); border: none; border-radius: 50%; width: 24px; height: 24px; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 10;';
      removeBtn.innerHTML = '√ó';
      removeBtn.title = 'Remove attachment';
      newPreview.appendChild(removeBtn);
      
      editIndicator.insertBefore(newPreview, fileButtons);
      
      // Show send button when file is selected
      const sendBtn = document.getElementById('sendBtn');
      if (sendBtn) sendBtn.style.display = 'inline-flex';
      
      const voiceBtn = document.getElementById('voiceBtn');
      const moreBtn = document.getElementById('moreBtn');
      if (voiceBtn) voiceBtn.style.display = 'none';
      if (moreBtn) moreBtn.style.display = 'none';
      
      InnovateAPI.showAlert('New attachment added', 'success');
    }

    function cancelReply() {
      const input = document.getElementById('messageInput');
      const previewContainer = document.getElementById('messagePreviewContainer');
      delete input.dataset.replyToMessageId;
      previewContainer.innerHTML = '';
    }

    function cancelEdit() {
      const input = document.getElementById('messageInput');
      const previewContainer = document.getElementById('messagePreviewContainer');
      delete input.dataset.editingMessageId;
      delete input.dataset.originalFileType;
      delete input.dataset.attachmentAction;
      delete input.dataset.newFileType;
      delete window.editingNewFile;
      input.value = '';
      previewContainer.innerHTML = '';
      
      // Reset button visibility
      const sendBtn = document.getElementById('sendBtn');
      const voiceBtn = document.getElementById('voiceBtn');
      const moreBtn = document.getElementById('moreBtn');
      if (sendBtn) sendBtn.style.display = 'none';
      if (voiceBtn) voiceBtn.style.display = 'inline-flex';
      if (moreBtn) moreBtn.style.display = 'inline-flex';
    }

    async function messageInfo(event) {
      if (event) event.stopPropagation();
      hideMessageContextMenu();
      
      // Show basic message info
      const info = `Message ID: ${selectedMessageId}\nType: ${selectedMessageType || 'text'}\nContent: ${selectedMessageContent?.substring(0, 50)}...`;
      alert(info);
      // TODO: Show detailed modal with delivery time, read status, etc.
    }

    async function deleteMessage(event) {
      if (event) event.stopPropagation();
      hideMessageContextMenu();
      
      if (!selectedMessageIsSent) {
        InnovateAPI.showAlert('You can only delete your own messages', 'error');
        return;
      }
      
      const confirmed = confirm('Delete this message?');
      if (!confirmed) return;
      
      try {
        const endpoint = currentGroupId
          ? `/groups/${currentGroupId}/messages/${selectedMessageId}`
          : `/messages/${selectedMessageId}`;
        
        await InnovateAPI.apiRequest(endpoint, { method: 'DELETE' });
        
        // Remove message from UI
        const messageEl = document.querySelector(`[data-message-id="${selectedMessageId}"]`);
        if (messageEl) {
          const wrapper = messageEl.closest('div[style*="flex-direction: column"]');
          if (wrapper) wrapper.remove();
        }
        
        InnovateAPI.showAlert('Message deleted', 'success');
      } catch (error) {
        InnovateAPI.showAlert('Failed to delete message', 'error');
      }
    }

    // =====================================================
    // AI CHAT SYSTEM - Multi-model AI chatbot in messages
    // =====================================================
    
    let aiChatActive = false;
    let aiConversationId = null;
    let aiSelectedModel = 'llama-3.3-70b-versatile';
    let aiModels = [];
    let aiIsLoading = false;
    let aiConversations = [];

    // Provider colors and icons
    const AI_PROVIDER_STYLES = {
      groq:        { color: '#f55036', icon: 'üöÄ', label: 'Groq (FREE)' },
      google:      { color: '#4285f4', icon: '‚ú®', label: 'Google Gemini (FREE)' },
      huggingface: { color: '#ffbd45', icon: 'ü§ó', label: 'HuggingFace (FREE)' },
      cohere:      { color: '#39594d', icon: 'üåä', label: 'Cohere (FREE)' },
      mistral:     { color: '#ff7000', icon: 'üå¨Ô∏è', label: 'Mistral (FREE)' },
      openrouter:  { color: '#6366f1', icon: 'üîÄ', label: 'OpenRouter (FREE)' },
      ollama:      { color: '#ffffff', icon: 'üè†', label: 'Ollama (LOCAL)' },
      openai:      { color: '#10a37f', icon: 'ü§ñ', label: 'OpenAI' },
      xai:         { color: '#1da1f2', icon: '‚ö°', label: 'xAI' },
      anthropic:   { color: '#d4a574', icon: 'üß†', label: 'Anthropic' },
      deepseek:    { color: '#0066ff', icon: 'üî¨', label: 'DeepSeek' }
    };

    // Load available AI models
    async function loadAIModels() {
      try {
        const data = await InnovateAPI.apiRequest('/ai-chat/models');
        aiModels = data.models || [];
      } catch (error) {
        console.error('Error loading AI models:', error);
        aiModels = [];
      }
    }

    // Load user AI preferences
    async function loadAIPreferences() {
      try {
        const data = await InnovateAPI.apiRequest('/ai-chat/preferences');
        aiSelectedModel = data.preferred_model || 'llama-3.3-70b-versatile';
      } catch (error) {
        console.log('Using default AI model');
      }
    }

    // Open AI Chat
    async function openAIChat() {
      aiChatActive = true;
      currentContactId = 'ai-assistant';
      currentGroupId = null;

      // Mark AI conversation as active
      document.querySelectorAll('.ig-conversation').forEach(el => el.classList.remove('active'));
      document.getElementById('ai-assistant-conversation')?.classList.add('active');

      // Update chat header for AI
      const chatAvatarEl = document.getElementById('chatAvatar');
      const chatAvatarIcon = document.getElementById('chatAvatarIcon');
      const chatAvatarContainer = document.getElementById('chatAvatarContainer');
      const chatUsernameEl = document.getElementById('chatUsername');

      chatAvatarEl.style.display = 'none';
      chatAvatarIcon.style.display = 'none';
      chatAvatarContainer.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
      chatAvatarContainer.style.width = '40px';
      chatAvatarContainer.style.height = '40px';
      chatAvatarContainer.innerHTML = `
        <svg fill="white" height="22" viewBox="0 0 24 24" width="22"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
        <img id="chatAvatar" src="" alt="" class="ig-chat-avatar" style="display: none;">
      `;

      chatUsernameEl.innerHTML = `
        <span>Innovate AI</span>
        <span style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; font-size: 9px; padding: 1px 6px; border-radius: 10px; font-weight: 600; margin-left: 6px;">AI</span>
      `;
      chatUsernameEl.style.cursor = 'default';
      chatUsernameEl.onclick = null;

      // Replace call buttons with model selector
      const chatActions = document.querySelector('.ig-chat-actions');
      chatActions.innerHTML = `
        <div id="aiModelSelector" style="position: relative;">
          <button onclick="toggleModelSelector()" id="modelSelectorBtn" style="display: flex; align-items: center; gap: 6px; background: var(--ig-secondary-background); border: 1px solid var(--ig-border); border-radius: 20px; padding: 6px 12px; color: var(--ig-primary-text); cursor: pointer; font-size: 12px; white-space: nowrap;">
            <span id="currentModelIcon">ü§ñ</span>
            <span id="currentModelName">Llama 3.3 70B</span>
            <svg fill="currentColor" height="10" width="10" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>
          </button>
          <div id="modelDropdown" style="display: none; position: absolute; right: 0; top: 42px; background: var(--ig-primary-background); border: 1px solid var(--ig-border); border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); z-index: 1000; min-width: 280px; max-height: 400px; overflow-y: auto;">
          </div>
        </div>
        <button onclick="showAIConversations()" style="background: none; border: none; color: var(--ig-primary-text); cursor: pointer; padding: 8px;" title="Chat History">
          <svg fill="none" height="22" viewBox="0 0 24 24" width="22" stroke="currentColor" stroke-width="2"><path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
        <button onclick="startNewAIChat()" style="background: none; border: none; color: var(--ig-primary-text); cursor: pointer; padding: 8px;" title="New Chat">
          <svg fill="none" height="22" viewBox="0 0 24 24" width="22" stroke="currentColor" stroke-width="2"><path d="M12 4v16m8-8H4" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
      `;

      // Update chat status
      const chatStatus = document.getElementById('chatStatus');
      if (chatStatus) {
        const modelInfo = aiModels.find(m => m.id === aiSelectedModel);
        chatStatus.textContent = modelInfo ? `Using ${modelInfo.name}` : 'Multi-model AI Assistant';
        chatStatus.style.color = '#667eea';
      }

      // Show chat window
      const chatWindow = document.getElementById('chatWindow');
      chatWindow.classList.add('active');
      if (window.innerWidth <= 768) {
        document.querySelector('.ig-top-nav')?.style.setProperty('display', 'none');
        document.querySelector('.ig-bottom-nav')?.style.setProperty('display', 'none');
      }

      // Update model selector display
      updateModelSelectorDisplay();

      // Load AI conversation
      await loadAIChatMessages();

      // Populate model dropdown
      renderModelDropdown();
    }

    // Update the model selector button display
    function updateModelSelectorDisplay() {
      const model = aiModels.find(m => m.id === aiSelectedModel);
      const iconEl = document.getElementById('currentModelIcon');
      const nameEl = document.getElementById('currentModelName');
      if (model && iconEl && nameEl) {
        const providerStyle = AI_PROVIDER_STYLES[model.provider] || { icon: 'ü§ñ', label: model.provider };
        iconEl.textContent = providerStyle.icon;
        nameEl.textContent = model.name;
      }
    }

    // Toggle model selector dropdown
    function toggleModelSelector() {
      const dropdown = document.getElementById('modelDropdown');
      if (dropdown) {
        dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
      }
    }

    // Close model dropdown when clicking outside
    document.addEventListener('click', (e) => {
      const dropdown = document.getElementById('modelDropdown');
      const btn = document.getElementById('modelSelectorBtn');
      if (dropdown && !dropdown.contains(e.target) && !btn?.contains(e.target)) {
        dropdown.style.display = 'none';
      }
    });

    // Render the model dropdown with provider groups
    function renderModelDropdown() {
      const dropdown = document.getElementById('modelDropdown');
      if (!dropdown) return;

      // Group by provider
      const providers = {};
      aiModels.forEach(m => {
        if (!providers[m.provider]) providers[m.provider] = [];
        providers[m.provider].push(m);
      });

      // Sort providers: free first, then premium
      const providerOrder = ['groq', 'google', 'huggingface', 'cohere', 'mistral', 'openrouter', 'ollama', 'openai', 'xai', 'anthropic', 'deepseek'];
      const sortedProviders = Object.entries(providers).sort(([a], [b]) => {
        const ai = providerOrder.indexOf(a); const bi = providerOrder.indexOf(b);
        return (ai === -1 ? 99 : ai) - (bi === -1 ? 99 : bi);
      });

      let html = `<div style="padding: 12px 16px; border-bottom: 1px solid var(--ig-border);">
        <div style="font-weight: 700; font-size: 14px; color: var(--ig-primary-text);">Choose AI Model</div>
        <div style="font-size: 11px; color: var(--ig-secondary-text); margin-top: 2px;">Free open-source models listed first</div>
      </div>`;

      let addedPremiumHeader = false;
      for (const [provider, models] of sortedProviders) {
        const style = AI_PROVIDER_STYLES[provider] || { icon: 'ü§ñ', label: provider, color: '#666' };
        const isFreeProvider = models.some(m => m.free);
        
        if (!isFreeProvider && !addedPremiumHeader) {
          addedPremiumHeader = true;
          html += `<div style="padding: 10px 16px 4px; font-size: 10px; font-weight: 700; color: var(--ig-secondary-text); text-transform: uppercase; letter-spacing: 1px; border-top: 2px solid var(--ig-border); margin-top: 4px;">üíé Premium Models</div>`;
        }

        html += `<div style="padding: 8px 16px 4px; font-size: 11px; font-weight: 600; color: ${style.color}; text-transform: uppercase; letter-spacing: 0.5px;">
          ${style.icon} ${style.label}
        </div>`;

        models.forEach(m => {
          const isSelected = m.id === aiSelectedModel;
          const isAvailable = m.available;
          const freeBadge = m.free ? '<span style="background: #00c853; color: white; font-size: 8px; padding: 1px 5px; border-radius: 6px; font-weight: 700; margin-left: 4px;">FREE</span>' : '';
          const localBadge = m.local ? '<span style="background: #ff9800; color: white; font-size: 8px; padding: 1px 5px; border-radius: 6px; font-weight: 700; margin-left: 4px;">LOCAL</span>' : '';
          
          html += `
            <button onclick="selectAIModel('${m.id}')" 
              style="width: 100%; display: flex; align-items: center; gap: 10px; padding: 10px 16px; border: none; background: ${isSelected ? 'var(--ig-secondary-background)' : 'transparent'}; cursor: ${isAvailable ? 'pointer' : 'not-allowed'}; color: var(--ig-primary-text); text-align: left; opacity: ${isAvailable ? 1 : 0.4}; transition: background 0.15s;"
              onmouseover="this.style.background='var(--ig-secondary-background)'"
              onmouseout="this.style.background='${isSelected ? 'var(--ig-secondary-background)' : 'transparent'}'"
              ${isAvailable ? '' : 'disabled'}>
              <div style="flex: 1;">
                <div style="font-size: 13px; font-weight: ${isSelected ? '600' : '400'}; display: flex; align-items: center; flex-wrap: wrap;">${m.name}${freeBadge}${localBadge}</div>
                <div style="font-size: 11px; color: var(--ig-secondary-text);">${m.description}</div>
              </div>
              ${isSelected ? '<svg fill="#667eea" height="18" viewBox="0 0 24 24" width="18"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>' : ''}
              ${!isAvailable ? '<span style="font-size: 9px; background: var(--ig-secondary-background); padding: 2px 6px; border-radius: 8px; color: var(--ig-secondary-text);">Add Key</span>' : ''}
            </button>
          `;
        });
      }

      html += `<div style="padding: 10px 16px; border-top: 1px solid var(--ig-border); font-size: 11px; color: var(--ig-secondary-text);">
        Uncomment API keys in .env file to enable models
      </div>`;

      dropdown.innerHTML = html;
    }

    // Select an AI model
    async function selectAIModel(modelId) {
      aiSelectedModel = modelId;
      
      // Close dropdown
      document.getElementById('modelDropdown').style.display = 'none';
      
      // Update display
      updateModelSelectorDisplay();
      renderModelDropdown();

      // Update chat status
      const model = aiModels.find(m => m.id === modelId);
      const chatStatus = document.getElementById('chatStatus');
      if (chatStatus && model) {
        chatStatus.textContent = `Using ${model.name}`;
      }

      // Save preference
      try {
        await InnovateAPI.apiRequest('/ai-chat/preferences', {
          method: 'PUT',
          body: JSON.stringify({ preferred_model: modelId })
        });
      } catch (e) {
        console.log('Could not save model preference');
      }

      InnovateAPI.showAlert(`Switched to ${model?.name || modelId}`, 'success');
    }

    // Load AI chat messages
    async function loadAIChatMessages() {
      const messagesContainer = document.getElementById('chatMessages');
      
      if (!aiConversationId) {
        // Show welcome screen
        messagesContainer.innerHTML = `
          <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px 20px; height: 100%; text-align: center;">
            <div style="width: 80px; height: 80px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; margin-bottom: 20px;">
              <svg fill="white" height="40" viewBox="0 0 24 24" width="40"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
            </div>
            <h2 style="color: var(--ig-primary-text); margin-bottom: 8px; font-size: 20px;">Innovate AI</h2>
            <p style="color: var(--ig-secondary-text); font-size: 14px; max-width: 350px; line-height: 1.5; margin-bottom: 24px;">
              Your multi-model AI assistant. Chat with Llama, Gemini, Mistral, Claude and 30+ models. Switch models anytime using the selector above. <span style="color: #44b700; font-weight: 600;">FREE models available!</span>
            </p>
            <div style="display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; max-width: 380px;">
              <button onclick="sendAISuggestion('Explain quantum computing simply')" class="ai-suggestion-btn">üî¨ Explain quantum computing</button>
              <button onclick="sendAISuggestion('Write a creative short story')" class="ai-suggestion-btn">üìù Write a short story</button>
              <button onclick="sendAISuggestion('Help me debug my code')" class="ai-suggestion-btn">üíª Help debug code</button>
              <button onclick="sendAISuggestion('Give me a workout plan')" class="ai-suggestion-btn">üí™ Workout plan</button>
              <button onclick="sendAISuggestion('Summarize the latest tech trends')" class="ai-suggestion-btn">üìä Tech trends</button>
              <button onclick="sendAISuggestion('Help me plan a trip to Japan')" class="ai-suggestion-btn">‚úàÔ∏è Plan a trip</button>
            </div>
          </div>
          <style>
            .ai-suggestion-btn {
              background: var(--ig-secondary-background);
              border: 1px solid var(--ig-border);
              border-radius: 20px;
              padding: 8px 16px;
              font-size: 13px;
              color: var(--ig-primary-text);
              cursor: pointer;
              transition: all 0.2s;
            }
            .ai-suggestion-btn:hover {
              background: linear-gradient(135deg, rgba(102,126,234,0.15), rgba(118,75,162,0.15));
              border-color: #667eea;
            }
          </style>
        `;
        return;
      }

      try {
        const data = await InnovateAPI.apiRequest(`/ai-chat/conversations/${aiConversationId}/messages`);
        messagesContainer.innerHTML = '';

        if (data.messages.length === 0) {
          loadAIChatMessages(); // Show welcome
          aiConversationId = null;
          return;
        }

        data.messages.forEach(msg => {
          appendAIMessage(msg.role, msg.content, msg.model_id, msg.created_at);
        });

        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      } catch (error) {
        console.error('Error loading AI messages:', error);
        messagesContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--ig-secondary-text);">Error loading conversation</div>';
      }
    }

    // Append a message to the AI chat
    function appendAIMessage(role, content, modelId, timestamp) {
      const messagesContainer = document.getElementById('chatMessages');
      const messageEl = document.createElement('div');
      
      if (role === 'user') {
        messageEl.className = 'ig-message ig-message-sent';
        messageEl.innerHTML = `
          <div style="word-break: break-word; white-space: pre-wrap;">${escapeHtml(content)}</div>
          <div class="ig-message-time" style="display: flex; align-items: center; gap: 4px; justify-content: flex-end;">
            <span style="font-size: 11px;">${timestamp ? formatMessageTime(timestamp) : 'Just now'}</span>
          </div>
        `;
      } else {
        // AI response
        const model = aiModels.find(m => m.id === modelId);
        const providerStyle = AI_PROVIDER_STYLES[model?.provider] || { icon: 'ü§ñ', color: '#667eea', label: 'AI' };
        
        messageEl.className = 'ig-message ig-message-received';
        messageEl.style.maxWidth = '85%';
        messageEl.innerHTML = `
          <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 6px; font-size: 11px;">
            <span style="font-weight: 600; color: ${providerStyle.color};">${providerStyle.icon} ${model?.name || modelId}</span>
          </div>
          <div class="ai-response-content" style="word-break: break-word; line-height: 1.6; font-size: 14px;">${renderAIMarkdown(content)}</div>
          <div style="display: flex; align-items: center; gap: 8px; margin-top: 8px;">
            <span class="ig-message-time" style="font-size: 11px;">${timestamp ? formatMessageTime(timestamp) : 'Just now'}</span>
            <button onclick="copyAIResponse(this)" style="background: none; border: none; color: var(--ig-secondary-text); cursor: pointer; padding: 2px; font-size: 11px; display: flex; align-items: center; gap: 3px;" title="Copy response">
              <svg fill="none" height="12" viewBox="0 0 24 24" width="12" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
              Copy
            </button>
          </div>
        `;
      }

      messagesContainer.appendChild(messageEl);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // Basic markdown rendering for AI responses
    function renderAIMarkdown(text) {
      if (!text) return '';
      let html = escapeHtml(text);
      
      // Code blocks (```...```)
      html = html.replace(/```(\w*)\n([\s\S]*?)```/g, (_, lang, code) => {
        return `<pre style="background: var(--ig-secondary-background); border: 1px solid var(--ig-border); border-radius: 8px; padding: 12px; overflow-x: auto; margin: 8px 0; font-family: 'Fira Code', monospace; font-size: 13px; line-height: 1.5;"><code>${code.trim()}</code></pre>`;
      });
      
      // Inline code (`...`)
      html = html.replace(/`([^`]+)`/g, '<code style="background: var(--ig-secondary-background); padding: 2px 6px; border-radius: 4px; font-family: monospace; font-size: 13px;">$1</code>');
      
      // Bold (**...** or __...__)
      html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
      html = html.replace(/__(.+?)__/g, '<strong>$1</strong>');
      
      // Italic (*...* or _..._)
      html = html.replace(/(?<!\*)\*(?!\*)(.+?)(?<!\*)\*(?!\*)/g, '<em>$1</em>');
      
      // Headers (### ... , ## ..., # ...)
      html = html.replace(/^### (.+)$/gm, '<div style="font-size: 15px; font-weight: 700; margin: 12px 0 4px;">$1</div>');
      html = html.replace(/^## (.+)$/gm, '<div style="font-size: 16px; font-weight: 700; margin: 12px 0 4px;">$1</div>');
      html = html.replace(/^# (.+)$/gm, '<div style="font-size: 18px; font-weight: 700; margin: 12px 0 4px;">$1</div>');
      
      // Bullet lists
      html = html.replace(/^[\-\*] (.+)$/gm, '<div style="padding-left: 16px; position: relative; margin: 2px 0;"><span style="position: absolute; left: 0;">‚Ä¢</span> $1</div>');
      
      // Numbered lists
      html = html.replace(/^(\d+)\. (.+)$/gm, '<div style="padding-left: 20px; position: relative; margin: 2px 0;"><span style="position: absolute; left: 0; font-weight: 600;">$1.</span> $2</div>');
      
      // Line breaks
      html = html.replace(/\n/g, '<br>');
      
      return html;
    }

    // Escape HTML entities
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Copy AI response
    function copyAIResponse(btn) {
      const contentEl = btn.closest('.ig-message').querySelector('.ai-response-content');
      if (contentEl) {
        navigator.clipboard.writeText(contentEl.textContent).then(() => {
          btn.innerHTML = '<svg fill="none" height="12" viewBox="0 0 24 24" width="12" stroke="#667eea" stroke-width="2"><path d="M20 6L9 17l-5-5" stroke-linecap="round" stroke-linejoin="round"/></svg> Copied!';
          btn.style.color = '#667eea';
          setTimeout(() => {
            btn.innerHTML = '<svg fill="none" height="12" viewBox="0 0 24 24" width="12" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg> Copy';
            btn.style.color = 'var(--ig-secondary-text)';
          }, 2000);
        });
      }
    }

    // Send suggestion as first message
    function sendAISuggestion(text) {
      document.getElementById('messageInput').value = text;
      sendMessage();
    }

    // Show typing indicator for AI
    function showAITypingIndicator() {
      const messagesContainer = document.getElementById('chatMessages');
      
      // Remove existing typing indicator
      document.getElementById('ai-typing-indicator')?.remove();
      
      const typingEl = document.createElement('div');
      typingEl.id = 'ai-typing-indicator';
      typingEl.className = 'ig-message ig-message-received';
      typingEl.style.maxWidth = '200px';
      typingEl.innerHTML = `
        <div style="display: flex; align-items: center; gap: 6px;">
          <div style="display: flex; gap: 4px;">
            <div class="ai-typing-dot" style="width: 8px; height: 8px; background: #667eea; border-radius: 50%; animation: aiTypingBounce 1.4s ease-in-out infinite;"></div>
            <div class="ai-typing-dot" style="width: 8px; height: 8px; background: #667eea; border-radius: 50%; animation: aiTypingBounce 1.4s ease-in-out 0.2s infinite;"></div>
            <div class="ai-typing-dot" style="width: 8px; height: 8px; background: #667eea; border-radius: 50%; animation: aiTypingBounce 1.4s ease-in-out 0.4s infinite;"></div>
          </div>
          <span style="font-size: 11px; color: var(--ig-secondary-text);">Thinking...</span>
        </div>
        <style>
          @keyframes aiTypingBounce {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
            30% { transform: translateY(-8px); opacity: 1; }
          }
        </style>
      `;
      messagesContainer.appendChild(typingEl);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // Remove typing indicator
    function removeAITypingIndicator() {
      document.getElementById('ai-typing-indicator')?.remove();
    }

    // Override sendMessage for AI chat
    const originalSendMessage = sendMessage;
    sendMessage = async function() {
      if (!aiChatActive) {
        return originalSendMessage();
      }

      const input = document.getElementById('messageInput');
      const content = input.value.trim();
      if (!content || aiIsLoading) return;

      aiIsLoading = true;
      input.value = '';

      // Hide send button
      const sendBtn = document.getElementById('sendBtn');
      if (sendBtn) sendBtn.style.display = 'none';
      const voiceBtn = document.getElementById('voiceBtn');
      const moreBtn = document.getElementById('moreBtn');
      if (voiceBtn) voiceBtn.style.display = 'inline-flex';
      if (moreBtn) moreBtn.style.display = 'inline-flex';

      // Append user message to UI
      appendAIMessage('user', content, null, null);

      // Show typing indicator
      showAITypingIndicator();

      try {
        const payload = {
          message: content,
          model_id: aiSelectedModel
        };
        if (aiConversationId) {
          payload.conversation_id = aiConversationId;
        }

        const data = await InnovateAPI.apiRequest('/ai-chat/send', {
          method: 'POST',
          body: JSON.stringify(payload)
        });

        // Get conversation ID from response
        if (data.conversation_id) {
          aiConversationId = data.conversation_id;
        }

        // Remove typing indicator and show response
        removeAITypingIndicator();
        appendAIMessage('assistant', data.response.content, data.response.model, null);

      } catch (error) {
        removeAITypingIndicator();
        
        // Show error as AI message with helpful guidance
        let errorMsg = error.message || 'Failed to get AI response.';
        let suggestion = '';
        
        // Detect common errors and provide helpful suggestions
        if (errorMsg.includes('API key not configured') || errorMsg.includes('not configured')) {
          const currentModel = aiModels.find(m => m.id === aiSelectedModel);
          const freeModels = aiModels.filter(m => m.free && m.available);
          if (freeModels.length > 0) {
            suggestion = `<br><span style="color: #44b700;">üí° Try a free model instead: <a href="#" onclick="selectAIModel('${freeModels[0].id}'); return false;" style="color: #667eea; text-decoration: underline;">${freeModels[0].name}</a></span>`;
          } else {
            suggestion = '<br><span style="color: #b0b3b8;">üí° Add a free API key (Groq, HuggingFace, or Google) in your .env file to get started.</span>';
          }
        } else if (errorMsg.includes('Rate limit')) {
          const freeModels = aiModels.filter(m => m.free && m.available && m.id !== aiSelectedModel);
          if (freeModels.length > 0) {
            suggestion = `<br><span style="color: #44b700;">üí° Switch to a free model: <a href="#" onclick="selectAIModel('${freeModels[0].id}'); return false;" style="color: #667eea; text-decoration: underline;">${freeModels[0].name}</a></span>`;
          } else {
            suggestion = '<br><span style="color: #b0b3b8;">üí° Try again later or configure a different provider in .env</span>';
          }
        } else if (errorMsg.includes('Authentication failed')) {
          suggestion = '<br><span style="color: #b0b3b8;">üí° Your API key appears invalid. Check your .env file and get a new key from the provider.</span>';
        }
        
        const messagesContainer = document.getElementById('chatMessages');
        const errorEl = document.createElement('div');
        errorEl.className = 'ig-message ig-message-received';
        errorEl.innerHTML = `
          <div style="color: #ed4956; display: flex; align-items: flex-start; gap: 8px;">
            <svg fill="#ed4956" height="18" viewBox="0 0 24 24" width="18" style="flex-shrink: 0; margin-top: 2px;"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>
            <div style="font-size: 13px;">${escapeHtml(errorMsg)}${suggestion}</div>
          </div>
        `;
        messagesContainer.appendChild(errorEl);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }

      aiIsLoading = false;
    };

    // Start a new AI chat
    function startNewAIChat() {
      aiConversationId = null;
      loadAIChatMessages();
    }

    // Show AI conversation history
    async function showAIConversations() {
      try {
        const data = await InnovateAPI.apiRequest('/ai-chat/conversations');
        aiConversations = data.conversations || [];
        
        const messagesContainer = document.getElementById('chatMessages');
        
        if (aiConversations.length === 0) {
          InnovateAPI.showAlert('No previous conversations', 'info');
          return;
        }

        let html = `
          <div style="padding: 20px;">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
              <h3 style="color: var(--ig-primary-text); margin: 0;">Chat History</h3>
              <button onclick="loadAIChatMessages()" style="background: none; border: none; color: #667eea; cursor: pointer; font-size: 13px;">‚Üê Back to chat</button>
            </div>
        `;

        aiConversations.forEach(conv => {
          const model = aiModels.find(m => m.id === conv.model_id);
          const providerStyle = AI_PROVIDER_STYLES[model?.provider] || { icon: 'ü§ñ', color: '#667eea' };
          const timeAgo = formatTime(conv.updated_at);
          const preview = conv.last_message ? (conv.last_message.length > 80 ? conv.last_message.substring(0, 80) + '...' : conv.last_message) : 'No messages';
          
          html += `
            <div onclick="loadAIConversation(${conv.id})" style="padding: 14px; border: 1px solid var(--ig-border); border-radius: 12px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s; background: var(--ig-primary-background);"
              onmouseover="this.style.background='var(--ig-secondary-background)'" onmouseout="this.style.background='var(--ig-primary-background)'">
              <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px;">
                <div style="font-weight: 600; font-size: 14px; color: var(--ig-primary-text);">${escapeHtml(conv.title)}</div>
                <div style="display: flex; align-items: center; gap: 6px;">
                  <span style="font-size: 10px; color: ${providerStyle.color};">${providerStyle.icon} ${model?.name || conv.model_id}</span>
                  <button onclick="event.stopPropagation(); deleteAIConversation(${conv.id})" style="background: none; border: none; color: var(--ig-secondary-text); cursor: pointer; padding: 4px;" title="Delete">
                    <svg fill="none" height="14" viewBox="0 0 24 24" width="14" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                  </button>
                </div>
              </div>
              <div style="font-size: 12px; color: var(--ig-secondary-text); margin-bottom: 4px;">${escapeHtml(preview)}</div>
              <div style="font-size: 11px; color: var(--ig-secondary-text);">${conv.message_count} messages ‚Ä¢ ${timeAgo}</div>
            </div>
          `;
        });

        html += '</div>';
        messagesContainer.innerHTML = html;
      } catch (error) {
        console.error('Error loading AI conversations:', error);
        InnovateAPI.showAlert('Failed to load conversations', 'error');
      }
    }

    // Load a specific AI conversation
    async function loadAIConversation(conversationId) {
      aiConversationId = conversationId;
      await loadAIChatMessages();
    }

    // Delete an AI conversation
    async function deleteAIConversation(conversationId) {
      if (!confirm('Delete this conversation?')) return;
      
      try {
        await InnovateAPI.apiRequest(`/ai-chat/conversations/${conversationId}`, { method: 'DELETE' });
        
        if (aiConversationId === conversationId) {
          aiConversationId = null;
        }
        
        // Refresh conversation list
        showAIConversations();
        InnovateAPI.showAlert('Conversation deleted', 'success');
      } catch (error) {
        InnovateAPI.showAlert('Failed to delete conversation', 'error');
      }
    }

    // Override closeChat to reset AI state
    const originalCloseChat = typeof closeChat === 'function' ? closeChat : null;
    function closeChatWithAIReset() {
      if (aiChatActive) {
        aiChatActive = false;
        currentContactId = null;
        
        // Restore original chat actions buttons
        const chatActions = document.querySelector('.ig-chat-actions');
        if (chatActions) {
          chatActions.innerHTML = `
            <button class="ig-chat-action-btn" title="Details">
              <svg fill="none" height="24" viewBox="0 0 24 24" width="24" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10" stroke-linecap="round" stroke-linejoin="round"></circle><path d="M12 16v-4M12 8h.01" stroke-linecap="round" stroke-linejoin="round"></path></svg>
            </button>
            <button class="ig-chat-action-btn" onclick="startVoiceCall()" title="Voice Call">
              <svg fill="none" height="24" viewBox="0 0 24 24" width="24" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72 12.84 12.84 0 00.7 2.81 2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45 12.84 12.84 0 002.81.7A2 2 0 0122 16.92z" stroke-linecap="round" stroke-linejoin="round"></path></svg>
            </button>
            <button class="ig-chat-action-btn" onclick="startVideoCall()" title="Video Call">
              <svg fill="none" height="24" viewBox="0 0 24 24" width="24" stroke="currentColor" stroke-width="2"><path d="M23 7l-7 5 7 5V7z" stroke-linecap="round" stroke-linejoin="round"></path><rect x="1" y="5" width="15" height="14" rx="2" ry="2" stroke-linecap="round" stroke-linejoin="round"></rect></svg>
            </button>
          `;
        }
        
        // Restore chat avatar container
        const chatAvatarContainer = document.getElementById('chatAvatarContainer');
        if (chatAvatarContainer) {
          chatAvatarContainer.innerHTML = `
            <svg id="chatAvatarIcon" fill="none" height="24" viewBox="0 0 24 24" width="24" stroke="var(--ig-secondary-text)" stroke-width="2"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z" stroke-linecap="round" stroke-linejoin="round"></path></svg>
            <img id="chatAvatar" src="" alt="" class="ig-chat-avatar" style="display: none;">
          `;
        }
      }
      
      // Call existing close logic
      const chatWindow = document.getElementById('chatWindow');
      chatWindow.classList.remove('active');
      if (window.innerWidth <= 768) {
        document.querySelector('.ig-top-nav')?.style.setProperty('display', '');
        document.querySelector('.ig-bottom-nav')?.style.setProperty('display', '');
      }
    }
    // Replace closeChat
    if (typeof window.closeChat === 'function') {
      const _origClose = window.closeChat;
      window.closeChat = function() {
        if (aiChatActive) {
          closeChatWithAIReset();
        } else {
          _origClose();
        }
      };
    }

    // Setup AI Socket.IO listeners
    function setupAISocketListeners() {
      const socket = InnovateAPI.getSocket();
      if (!socket) return;

      socket.off('ai:typing');
      socket.off('ai:response');
      socket.off('ai:error');

      socket.on('ai:typing', (data) => {
        if (aiChatActive) showAITypingIndicator();
      });

      socket.on('ai:response', (data) => {
        // Response is handled by the API call directly
      });

      socket.on('ai:error', (data) => {
        removeAITypingIndicator();
      });
    }

    // Initialize AI chat on page load
    async function initAIChat() {
      await loadAIModels();
      await loadAIPreferences();
      setupAISocketListeners();
    }

    // Call init
    initAIChat();
  </script>
</body>
</html>

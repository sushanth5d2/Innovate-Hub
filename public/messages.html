<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Messages ‚Ä¢ Innovate</title>
  <link rel="stylesheet" href="/css/instagram.css">
</head>
<body>
  <!-- Top Navigation -->
  <nav class="ig-top-nav">
    <div class="ig-nav-container">
      <a href="/home" class="ig-logo">Innovate</a>
      
      <div class="ig-search-box">
        <input type="text" class="ig-search-input" placeholder="Search messages" id="searchMessages">
      </div>
      
      <div class="ig-nav-icons">
        <div class="ig-nav-icon" onclick="window.location.href='/home'">
          <svg aria-label="Home" fill="none" height="24" viewBox="0 0 24 24" width="24">
            <path d="M9.005 16.545a2.997 2.997 0 0 1 2.997-2.997A2.997 2.997 0 0 1 15 16.545V22h7V11.543L12 2 2 11.543V22h7.005Z" fill="none" stroke="currentColor" stroke-linejoin="round" stroke-width="2"></path>
          </svg>
        </div>
        
        <div class="ig-nav-icon">
          <svg aria-label="Messenger" fill="currentColor" height="24" viewBox="0 0 24 24" width="24">
            <path d="M12.003 2.001a9.705 9.705 0 1 1 0 19.4 10.876 10.876 0 0 1-2.895-.384.798.798 0 0 0-.533.04l-1.984.876a.801.801 0 0 1-1.123-.708l-.054-1.78a.806.806 0 0 0-.27-.569 9.49 9.49 0 0 1-3.14-7.175 9.65 9.65 0 0 1 10-9.7Z"></path>
            <path d="M17.79 10.132a.659.659 0 0 0-.962-.873l-2.556 2.05a.63.63 0 0 1-.758.002L11.06 9.47a1.576 1.576 0 0 0-2.277.42l-2.567 3.98a.659.659 0 0 0 .961.875l2.556-2.049a.63.63 0 0 1 .759-.002l2.452 1.84a1.576 1.576 0 0 0 2.278-.42Z" fill-rule="evenodd"></path>
          </svg>
        </div>
        
        <div class="ig-nav-icon" onclick="window.location.href='/profile/' + getCurrentUserId()">
          <img id="navProfilePic" src="" alt="Profile" style="width: 24px; height: 24px; border-radius: 50%; object-fit: cover;">
        </div>
      </div>
    </div>
  </nav>

  <!-- Messages Container -->
  <div class="ig-messages-container">
    <!-- Conversations List -->
    <div class="ig-conversations">
      <!-- Mobile Header -->
      <div class="ig-messages-mobile-header">
        <button class="ig-mobile-back" onclick="window.location.href='/home'">
          <svg fill="currentColor" height="24" viewBox="0 0 24 24" width="24">
            <path d="M21 11.25H5.81l6.22-6.22a.75.75 0 0 0-1.06-1.06l-7.5 7.5a.75.75 0 0 0 0 1.06l7.5 7.5a.75.75 0 0 0 1.06-1.06L5.81 12.75H21a.75.75 0 0 0 0-1.5Z"></path>
          </svg>
        </button>
        <div style="display: flex; align-items: center; gap: 8px; flex: 1;">
          <span class="ig-messages-username" id="currentUsername" style="font-size: 18px; font-weight: 600;">Loading...</span>
          <svg fill="currentColor" height="12" viewBox="0 0 24 24" width="12">
            <path d="M21 7.5l-9 9-9-9" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="3"></path>
          </svg>
        </div>
        <button class="ig-new-message-btn" onclick="newMessage()">
          <svg aria-label="New message" fill="currentColor" height="24" viewBox="0 0 24 24" width="24">
            <path d="M12.202 3.203H5.25a3 3 0 0 0-3 3V18.75a3 3 0 0 0 3 3h12.547a3 3 0 0 0 3-3v-6.952" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
            <path d="M10.002 17.226H6.774v-3.228L18.607 2.165a1.417 1.417 0 0 1 2.004 0l1.224 1.225a1.417 1.417 0 0 1 0 2.004Z" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
          </svg>
        </button>
      </div>

      <!-- Search Bar -->
      <div class="ig-messages-search">
        <svg aria-label="Search" fill="currentColor" height="16" viewBox="0 0 24 24" width="16" style="margin-right: 8px; color: var(--ig-secondary-text);">
          <path d="M19 10.5A8.5 8.5 0 1 1 10.5 2a8.5 8.5 0 0 1 8.5 8.5Z" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
          <line fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" x1="16.511" x2="22" y1="16.511" y2="22"></line>
        </svg>
        <input type="text" placeholder="Ask Meta AI or search" id="searchMessages" style="background: none; border: none; outline: none; color: var(--ig-primary-text); flex: 1; font-size: 14px;">
      </div>

      <!-- Messages/Requests Tabs -->
      <div class="ig-messages-tabs">
        <div class="ig-messages-tab active" id="messagesTab" onclick="switchMessagesTab('messages')">Messages</div>
        <div class="ig-messages-tab" id="requestsTab" onclick="switchMessagesTab('requests')">Requests</div>
      </div>
      
      <div class="ig-conversations-list" id="conversationsList">
        <div class="ig-spinner"></div>
      </div>
    </div>

    <!-- Chat Window -->
    <div class="ig-chat" id="chatWindow">
      <div class="ig-chat-header">
        <button class="ig-chat-back" onclick="closeChat()">
          <svg aria-label="Back" fill="currentColor" height="24" viewBox="0 0 24 24" width="24">
            <path d="M21 11.25H5.81l6.22-6.22a.75.75 0 0 0-1.06-1.06l-7.5 7.5a.75.75 0 0 0 0 1.06l7.5 7.5a.75.75 0 0 0 1.06-1.06L5.81 12.75H21a.75.75 0 0 0 0-1.5Z"></path>
          </svg>
        </button>
        <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
          <img id="chatAvatar" src="" alt="" class="ig-chat-avatar">
          <div style="flex: 1;">
            <div class="ig-chat-username" id="chatUsername">Select a conversation</div>
            <div class="ig-chat-status" id="chatStatus"></div>
          </div>
        </div>
        <div class="ig-chat-actions">
          <button class="ig-chat-action-btn" title="Link">
            <svg fill="currentColor" height="24" viewBox="0 0 24 24" width="24">
              <path d="M13.5 10.5 21 3m-5.5.5h5v5" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
              <path d="M21 14v5a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
            </svg>
          </button>
          <button class="ig-chat-action-btn" onclick="startVoiceCall()" title="Voice Call">
            <svg fill="currentColor" height="24" viewBox="0 0 24 24" width="24">
              <path d="M14.344 2.5c4.633.122 8.194 3.816 8.194 8.5a8.66 8.66 0 0 1-1.836 5.364L22.768 22H14.5C9.806 22 6 18.194 6 13.5S9.806 5 14.5 5c.065 0 .13 0 .194.003l.15-.003Zm0 1.5a7 7 0 1 0 4.274 12.532l.228-.168.722 2.166h-5.068a7.5 7.5 0 0 1-7.495-7.066L7 11l.003-.15C7.127 6.264 10.286 3.5 14.344 4Z" fill="none" stroke="currentColor" stroke-width="1.5"></path>
            </svg>
          </button>
          <button class="ig-chat-action-btn" onclick="startVideoCall()" title="Video Call">
            <svg fill="currentColor" height="24" viewBox="0 0 24 24" width="24">
              <path d="M5.5 4A2.5 2.5 0 0 0 3 6.5v11A2.5 2.5 0 0 0 5.5 20h8a2.5 2.5 0 0 0 2.5-2.5v-11A2.5 2.5 0 0 0 13.5 4h-8Zm12.207 2.793a1 1 0 0 1 1.686.614l.021.113.006.117v8.726a1 1 0 0 1-1.595.78l-.108-.087-3.5-3.25v-3.512l3.5-3.25a1 1 0 0 1 .99-.25Z"></path>
            </svg>
          </button>
        </div>
      </div>
      
      <div class="ig-chat-messages" id="chatMessages">
        <div style="text-align: center; color: var(--ig-secondary-text); padding: 40px;">
          Select a conversation to start messaging
        </div>
      </div>
      
      <div class="ig-chat-input-container">
        <button class="ig-input-action-btn" onclick="openCamera()" title="Camera">
          <svg fill="currentColor" height="24" viewBox="0 0 24 24" width="24">
            <path d="M6.827 6.175A2.31 2.31 0 0 1 5.186 7.23h-.005A2.31 2.31 0 0 1 3.54 6.175L1.945 4.581a.75.75 0 0 1 1.06-1.06l1.595 1.594a.767.767 0 0 0 .544.226.767.767 0 0 0 .543-.226L7.281 3.52a.75.75 0 0 1 1.061 1.06L6.827 6.175Z" fill-rule="evenodd"></path>
            <path d="M2.25 12a9.75 9.75 0 1 1 19.5 0 9.75 9.75 0 0 1-19.5 0Zm9.75-8.25a8.25 8.25 0 1 0 0 16.5 8.25 8.25 0 0 0 0-16.5Zm0 12.5a4.25 4.25 0 1 1 0-8.5 4.25 4.25 0 0 1 0 8.5Zm0-1.5a2.75 2.75 0 1 0 0-5.5 2.75 2.75 0 0 0 0 5.5Z"></path>
          </svg>
        </button>
        
        <input type="text" class="ig-chat-input" placeholder="Message..." id="messageInput" onkeypress="handleMessageKeyPress(event)">
        
        <button class="ig-input-action-btn ig-voice-btn" onmousedown="startVoiceRecording()" onmouseup="stopVoiceRecording()" ontouchstart="startVoiceRecording()" ontouchend="stopVoiceRecording()" title="Voice" id="voiceBtn">
          <svg aria-label="Voice message" fill="currentColor" height="24" viewBox="0 0 24 24" width="24">
            <path d="M12 15c1.66 0 3-1.34 3-3V6c0-1.66-1.34-3-3-3S9 4.34 9 6v6c0 1.66 1.34 3 3 3z"></path>
            <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"></path>
          </svg>
        </button>
        
        <label class="ig-input-action-btn" title="Gallery">
          <svg fill="currentColor" height="24" viewBox="0 0 24 24" width="24">
            <path d="M2.25 18c0 .966.784 1.75 1.75 1.75h16a1.75 1.75 0 0 0 1.75-1.75V6a1.75 1.75 0 0 0-1.75-1.75H4A1.75 1.75 0 0 0 2.25 6Zm1.75-.25a.25.25 0 0 1-.25-.25V6a.25.25 0 0 1 .25-.25h16a.25.25 0 0 1 .25.25v12a.25.25 0 0 1-.25.25Z"></path>
            <path d="M16 9.75a1.75 1.75 0 1 1-3.5 0 1.75 1.75 0 0 1 3.5 0Zm-13.25 8v-2.052l5.5-5.464 5.464 5.464 3.232-3.232L21 16.52v1.23a1.75 1.75 0 0 1-1.75 1.75H4A1.75 1.75 0 0 1 2.75 17.75Z"></path>
          </svg>
          <input type="file" accept="image/*" onchange="sendFile(this.files[0])" style="display: none;">
        </label>
        
        <button class="ig-input-action-btn" onclick="openEmojiPicker()" title="Emoji" id="emojiBtn">
          <svg fill="currentColor" height="24" viewBox="0 0 24 24" width="24">
            <path d="M15.83 10.997a1.167 1.167 0 1 0 1.167 1.167 1.167 1.167 0 0 0-1.167-1.167Zm-6.5 1.167a1.167 1.167 0 1 0-1.166 1.167 1.167 1.167 0 0 0 1.166-1.167Zm5.163 3.24a3.406 3.406 0 0 1-4.982.007 1 1 0 1 0-1.557 1.256 5.397 5.397 0 0 0 8.09 0 1 1 0 0 0-1.55-1.263ZM12 .503a11.5 11.5 0 1 0 11.5 11.5A11.513 11.513 0 0 0 12 .503Zm0 21a9.5 9.5 0 1 1 9.5-9.5 9.51 9.51 0 0 1-9.5 9.5Z"></path>
          </svg>
        </button>
        
        <button class="ig-input-action-btn" onclick="toggleAttachMenu()" title="More" id="moreBtn">
          <svg fill="currentColor" height="24" viewBox="0 0 24 24" width="24">
            <circle cx="12" cy="12" r="2"></circle>
            <circle cx="19" cy="12" r="2"></circle>
            <circle cx="5" cy="12" r="2"></circle>
          </svg>
        </button>
        
        <div class="ig-attach-menu" id="attachMenu" style="display: none;">
          <button class="ig-attach-option" onclick="openMapPicker()">
            <svg fill="currentColor" height="20" viewBox="0 0 24 24" width="20">
              <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"></path>
            </svg>
            Location
          </button>
          <label class="ig-attach-option">
            <svg fill="currentColor" height="20" viewBox="0 0 24 24" width="20">
              <path d="M18 4l2 4h-3l-2-4h-2l2 4h-3l-2-4H8l2 4H7L5 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4h-4z"></path>
            </svg>
            Video
            <input type="file" accept="video/*" onchange="sendFile(this.files[0])" style="display: none;">
          </label>
          <label class="ig-attach-option">
            <svg fill="currentColor" height="20" viewBox="0 0 24 24" width="20">
              <path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"></path>
            </svg>
            Document
            <input type="file" accept=".pdf,.doc,.docx,.txt" onchange="sendFile(this.files[0])" style="display: none;">
          </label>
          <button class="ig-attach-option" onclick="openGifPicker()">
            <svg fill="currentColor" height="20" viewBox="0 0 24 24" width="20">
              <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"></path>
            </svg>
            GIF
          </button>
          <button class="ig-attach-option" onclick="openTodoCreator()">
            <svg fill="currentColor" height="20" viewBox="0 0 24 24" width="20">
              <path d="M22 5.18L10.59 16.6l-4.24-4.24 1.41-1.41 2.83 2.83 10-10L22 5.18zM12 20c-4.41 0-8-3.59-8-8s3.59-8 8-8c1.57 0 3.04.46 4.28 1.25l1.45-1.45C16.1 2.67 14.13 2 12 2 6.48 2 2 6.48 2 12s4.48 10 10 10c1.73 0 3.36-.44 4.78-1.22l-1.5-1.5C14.28 19.74 13.17 20 12 20z"></path>
            </svg>
            TODO List
          </button>
          <button class="ig-attach-option" onclick="openTimerPicker()">
            <svg fill="currentColor" height="20" viewBox="0 0 24 24" width="20">
              <path d="M15 1H9v2h6V1zm-4 13h2V8h-2v6zm8.03-6.61l1.42-1.42c-.43-.51-.9-.99-1.41-1.41l-1.42 1.42C16.07 4.74 14.12 4 12 4c-4.97 0-9 4.03-9 9s4.02 9 9 9 9-4.03 9-9c0-2.12-.74-4.07-1.97-5.61zM12 20c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"></path>
            </svg>
            Timer
          </button>
        </div>
        
        <button class="ig-send-btn" onclick="sendMessage()" style="display: none;" id="sendBtn">
          <svg aria-label="Send" fill="currentColor" height="24" viewBox="0 0 24 24" width="24">
            <path d="M1.464 12.986 23.963.863a.5.5 0 0 1 .71.627l-5.24 20.618a.5.5 0 0 1-.925.114l-5.14-9.47-9.472-5.138a.5.5 0 0 1 .115-.925l-.547.297Z" stroke="currentColor" fill="none" stroke-linejoin="round"></path>
          </svg>
        </button>
      </div>
      
      <!-- Message Actions Modal -->
      <div id="messageActionsModal" class="ig-modal" style="display: none;">
        <div class="ig-modal-backdrop" onclick="closeMessageActions()"></div>
        <div class="ig-message-actions-menu">
          <button class="ig-message-action" onclick="replyToMessage()">
            <svg fill="currentColor" height="20" viewBox="0 0 24 24" width="20">
              <path d="M10 9V5l-7 7 7 7v-4.1c5 0 8.5 1.6 11 5.1-1-5-4-10-11-11z"></path>
            </svg>
            Reply
          </button>
          <button class="ig-message-action" onclick="copyMessage()">
            <svg fill="currentColor" height="20" viewBox="0 0 24 24" width="20">
              <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"></path>
            </svg>
            Copy
          </button>
          <button class="ig-message-action" onclick="forwardMessage()">
            <svg fill="currentColor" height="20" viewBox="0 0 24 24" width="20">
              <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"></path>
            </svg>
            Forward
          </button>
          <button class="ig-message-action" onclick="deleteMessage()">
            <svg fill="currentColor" height="20" viewBox="0 0 24 24" width="20">
              <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"></path>
            </svg>
            Delete
          </button>
          <button class="ig-message-action" onclick="editMessage()

" id="editBtn" style="display: none;">
            <svg fill="currentColor" height="20" viewBox="0 0 24 24" width="20">
              <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"></path>
            </svg>
            Edit
          </button>
          <button class="ig-message-action" onclick="unsendMessage()" id="unsendBtn" style="display: none;">
            <svg fill="currentColor" height="20" viewBox="0 0 24 24" width="20">
              <path d="M12.5 8c-2.65 0-5.05.99-6.9 2.6L2 7v9h9l-3.62-3.62c1.39-1.16 3.16-1.88 5.12-1.88 3.54 0 6.55 2.31 7.6 5.5l2.37-.78C21.08 11.03 17.15 8 12.5 8z"></path>
            </svg>
            Unsend
          </button>
        </div>
      </div>

      <!-- Emoji Picker Modal -->
      <div id="emojiModal" class="ig-modal" style="display: none; z-index: 99999;">
        <div class="ig-modal-backdrop" onclick="closeEmojiPicker()" style="z-index: 99998;"></div>
        <div class="ig-emoji-picker" style="z-index: 99999;">
          <div class="ig-emoji-header" style="display: flex; align-items: center; padding: 12px; border-bottom: 1px solid var(--ig-border);">
            <button id="emojiTab" class="ig-emoji-tab active" onclick="switchEmojiTab('emoji')" style="flex: 1; padding: 8px; background: none; border: none; color: var(--ig-primary-text); font-weight: 600; cursor: pointer; border-bottom: 2px solid var(--ig-blue);">Emojis</button>
            <button id="gifTab" class="ig-emoji-tab" onclick="switchEmojiTab('gif')" style="flex: 1; padding: 8px; background: none; border: none; color: var(--ig-secondary-text); font-weight: 600; cursor: pointer; border-bottom: 2px solid transparent;">GIFs</button>
            <button onclick="closeEmojiPicker()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--ig-primary-text); margin-left: 8px;">&times;</button>
          </div>
          <div id="emojiContent" style="display: block;">
            <div class="ig-emoji-grid" id="emojiGrid"></div>
          </div>
          <div id="gifContent" style="display: none;">
            <input type="text" id="gifSearchInPicker" placeholder="Search GIFs..." onkeyup="searchGifsInPicker(this.value)" style="width: calc(100% - 24px); margin: 12px; padding: 8px 12px; border: 1px solid var(--ig-border); border-radius: 8px; background: var(--ig-secondary-background); color: var(--ig-primary-text);">
            <div id="gifGridInPicker" style="padding: 0 12px 12px 12px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; overflow-y: auto; max-height: 300px;">
              <div style="text-align: center; padding: 40px; grid-column: 1/-1; color: var(--ig-secondary-text);">Search for GIFs...</div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Camera Modal -->
      <div id="cameraModal" class="ig-modal" style="display: none;">
        <div class="ig-modal-content" style="max-width: 600px;">
          <div class="ig-modal-header">
            <h3>Take Photo</h3>
            <button onclick="closeCameraModal()">&times;</button>
          </div>
          <video id="cameraPreview" autoplay playsinline style="width: 100%; border-radius: 8px;"></video>
          <canvas id="cameraCanvas" style="display: none;"></canvas>
          <div style="padding: 16px; display: flex; gap: 12px; justify-content: center;">
            <button class="ig-btn-secondary" onclick="closeCameraModal()">Cancel</button>
            <button class="ig-btn-primary" onclick="capturePhoto()">Capture</button>
          </div>
        </div>
      </div>

      <!-- GIF Picker Modal -->
      <div id="gifModal" class="ig-modal" style="display: none;">
        <div class="ig-modal-backdrop" onclick="closeGifPicker()"></div>
        <div class="ig-emoji-picker" style="max-height: 500px;">
          <div class="ig-emoji-header">
            <h3>Choose a GIF</h3>
            <input type="text" id="gifSearch" placeholder="Search GIFs..." onkeyup="searchGifs(this.value)" style="flex: 1; margin: 0 12px; padding: 8px 12px; border: 1px solid var(--ig-border); border-radius: 8px; background: var(--ig-secondary-background); color: var(--ig-primary-text);">
            <button onclick="closeGifPicker()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--ig-primary-text);">&times;</button>
          </div>
          <div id="gifGrid" style="padding: 12px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; overflow-y: auto; max-height: 350px;">
            <div style="text-align: center; padding: 40px; grid-column: 1/-1; color: var(--ig-secondary-text);">Search for GIFs...</div>
          </div>
        </div>
      </div>

      <!-- TODO List Creator Modal -->
      <div id="todoModal" class="ig-modal" style="display: none;">
        <div class="ig-modal-backdrop" onclick="closeTodoCreator()"></div>
        <div class="ig-modal-content" style="max-width: 400px;">
          <div class="ig-modal-header">
            <h3>Create TODO List</h3>
            <button onclick="closeTodoCreator()">&times;</button>
          </div>
          <div style="padding: 16px;">
            <input type="text" id="todoTitle" placeholder="List title..." style="width: 100%; padding: 12px; border: 1px solid var(--ig-border); border-radius: 8px; background: var(--ig-secondary-background); color: var(--ig-primary-text); margin-bottom: 12px;">
            <div id="todoItems" style="margin-bottom: 12px;"></div>
            <button onclick="addTodoItem()" style="width: 100%; padding: 10px; background: var(--ig-secondary-background); border: 1px dashed var(--ig-border); border-radius: 8px; cursor: pointer; color: var(--ig-primary-text); margin-bottom: 12px;">+ Add Item</button>
            <div style="display: flex; gap: 12px;">
              <button class="ig-btn-secondary" onclick="closeTodoCreator()" style="flex: 1;">Cancel</button>
              <button class="ig-btn-primary" onclick="sendTodoList()" style="flex: 1;">Send</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Timer Picker Modal -->
      <div id="timerModal" class="ig-modal" style="display: none;">
        <div class="ig-modal-backdrop" onclick="closeTimerPicker()"></div>
        <div class="ig-modal-content" style="max-width: 350px;">
          <div class="ig-modal-header">
            <h3>Disappearing Message</h3>
            <button onclick="closeTimerPicker()">&times;</button>
          </div>
          <div style="padding: 16px;">
            <p style="color: var(--ig-secondary-text); margin-bottom: 16px; font-size: 14px;">Message will disappear after:</p>
            <div style="display: grid; gap: 8px;">
              <button class="ig-timer-option" onclick="setMessageTimer(10)">10 seconds</button>
              <button class="ig-timer-option" onclick="setMessageTimer(30)">30 seconds</button>
              <button class="ig-timer-option" onclick="setMessageTimer(60)">1 minute</button>
              <button class="ig-timer-option" onclick="setMessageTimer(300)">5 minutes</button>
              <button class="ig-timer-option" onclick="setMessageTimer(3600)">1 hour</button>
              <button class="ig-timer-option" onclick="setMessageTimer(86400)">24 hours</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Map Location Picker Modal -->
      <div id="mapModal" class="ig-modal" style="display: none;">
        <div class="ig-modal-backdrop" onclick="closeMapPicker()"></div>
        <div class="ig-modal-content" style="max-width: 600px;">
          <div class="ig-modal-header">
            <h3>Share Location</h3>
            <button onclick="closeMapPicker()">&times;</button>
          </div>
          <div style="padding: 16px;">
            <div id="mapContainer" style="width: 100%; height: 300px; background: var(--ig-secondary-background); border-radius: 8px; margin-bottom: 12px; position: relative; overflow: hidden; cursor: crosshair;" onclick="selectPointOnMap(event)">
              <div id="mapPin" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 32px;">üìç</div>
              <div id="mapCoords" style="position: absolute; bottom: 8px; left: 8px; background: rgba(0,0,0,0.7); color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;"></div>
            </div>
            <div style="display: flex; gap: 12px; margin-bottom: 12px;">
              <button class="ig-btn-secondary" onclick="useCurrentLocation()" style="flex: 1;">Use Current Location</button>
            </div>
            <div style="display: flex; gap: 12px;">
              <button class="ig-btn-secondary" onclick="closeMapPicker()" style="flex: 1;">Cancel</button>
              <button class="ig-btn-primary" onclick="sendSelectedLocation()" style="flex: 1;">Send Location</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom Navigation -->
  <nav class="ig-bottom-nav">
    <a href="/home" class="ig-bottom-nav-item">
      <svg aria-label="Home" viewBox="0 0 24 24" width="24">
        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
        <polyline points="9 22 9 12 15 12 15 22" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <span class="ig-bottom-nav-label">Home</span>
    </a>
    <a href="/communities" class="ig-bottom-nav-item">
      <svg aria-label="Communities" viewBox="0 0 24 24" width="24">
        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
        <circle cx="9" cy="7" r="4" stroke="currentColor" stroke-width="2" fill="none"/>
        <path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <span class="ig-bottom-nav-label">Communities</span>
    </a>
    <a href="/events" class="ig-bottom-nav-item">
      <svg aria-label="Events" viewBox="0 0 24 24" width="24">
        <rect x="3" y="4" width="18" height="18" rx="2" ry="2" stroke="currentColor" stroke-width="2" fill="none"/>
        <line x1="16" y1="2" x2="16" y2="6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <line x1="8" y1="2" x2="8" y2="6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <line x1="3" y1="10" x2="21" y2="10" stroke="currentColor" stroke-width="2"/>
      </svg>
      <span class="ig-bottom-nav-label">Events</span>
    </a>
    <a href="/home" class="ig-bottom-nav-item" onclick="event.preventDefault(); openCreatePostModal();">
      <svg aria-label="Create" viewBox="0 0 24 24" width="24">
        <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"/>
      </svg>
      <span class="ig-bottom-nav-label">Create</span>
    </a>
    <a href="/social-service" class="ig-bottom-nav-item">
      <svg aria-label="Social Service" viewBox="0 0 24 24" width="24">
        <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <span class="ig-bottom-nav-label">Service</span>
    </a>
    <a href="/search" class="ig-bottom-nav-item">
      <svg aria-label="Search" viewBox="0 0 24 24" width="24">
        <circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2" fill="none"/>
        <line x1="21" y1="21" x2="16.65" y2="16.65" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
      <span class="ig-bottom-nav-label">Search</span>
    </a>
    <a href="#" class="ig-bottom-nav-item" id="profileNavLink" onclick="navigateToProfile(event)">
      <svg aria-label="Profile" viewBox="0 0 24 24" width="24">
        <circle cx="12" cy="7" r="4" stroke="currentColor" stroke-width="2" fill="none"/>
        <path d="M5.5 21v-2a7.5 7.5 0 0 1 13 0v2" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/>
      </svg>
      <span class="ig-bottom-nav-label">Profile</span>
    </a>
  </nav>

  <script>
    function navigateToProfile(e) {
      e.preventDefault();
      const user = InnovateAPI.getCurrentUser();
      if (user && user.id) {
        window.location.href = `/profile/${user.id}`;
      }
    }
  </script>

  <!-- Call Modals -->
  <!-- Incoming Call Modal -->
  <div id="incomingCallModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 999999; align-items: center; justify-content: center;">
    <div style="background: var(--ig-primary-background); border-radius: 20px; padding: 40px; text-align: center; max-width: 400px; width: 90%;">
      <img id="incomingCallAvatar" src="" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; margin-bottom: 20px;">
      <h2 id="incomingCallName" style="margin-bottom: 10px; color: var(--ig-primary-text);">User</h2>
      <p id="incomingCallType" style="color: var(--ig-secondary-text); margin-bottom: 40px;">Incoming call...</p>
      <div style="display: flex; gap: 20px; justify-content: center;">
        <button onclick="rejectCall()" style="width: 60px; height: 60px; border-radius: 50%; background: #ed4956; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center;">
          <svg fill="white" height="30" viewBox="0 0 24 24" width="30">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm0-4h-2V7h2v8z"/>
          </svg>
        </button>
        <button onclick="acceptCall()" style="width: 60px; height: 60px; border-radius: 50%; background: #0095f6; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center;">
          <svg fill="white" height="30" viewBox="0 0 24 24" width="30">
            <path d="M20.01 15.38c-1.23 0-2.42-.2-3.53-.56-.35-.12-.74-.03-1.01.24l-1.57 1.97c-2.83-1.35-5.48-3.9-6.89-6.83l1.95-1.66c.27-.28.35-.67.24-1.02-.37-1.11-.56-2.3-.56-3.53 0-.54-.45-.99-.99-.99H4.19C3.65 3 3 3.24 3 3.99 3 13.28 10.73 21 20.01 21c.71 0 .99-.63.99-1.18v-3.45c0-.54-.45-.99-.99-.99z"/>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <!-- Active Call Modal -->
  <div id="activeCallModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #000; z-index: 999999; flex-direction: column;">
    <div style="flex: 1; position: relative; display: flex; align-items: center; justify-content: center;">
      <video id="remoteVideo" autoplay playsinline style="width: 100%; height: 100%; object-fit: cover;"></video>
      <video id="localVideo" autoplay playsinline muted style="position: absolute; bottom: 20px; right: 20px; width: 150px; height: 200px; border-radius: 12px; object-fit: cover; border: 2px solid white;"></video>
      
      <!-- Call info overlay -->
      <div id="callInfoOverlay" style="position: absolute; top: 40px; left: 50%; transform: translateX(-50%); text-align: center; color: white; background: rgba(0,0,0,0.5); padding: 20px 30px; border-radius: 12px;">
        <img id="activeCallAvatar" src="" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; margin-bottom: 12px;">
        <h3 id="activeCallName" style="margin-bottom: 8px;">User</h3>
        <p id="callDuration" style="opacity: 0.8; font-size: 14px;">00:00</p>
      </div>
    </div>
    
    <!-- Call controls -->
    <div style="padding: 30px; display: flex; gap: 20px; justify-content: center; align-items: center; background: rgba(0,0,0,0.8);">
      <button id="muteBtn" onclick="toggleMute()" style="width: 60px; height: 60px; border-radius: 50%; background: rgba(255,255,255,0.2); border: none; cursor: pointer; display: flex; align-items: center; justify-content: center;" title="Mute">
        <svg fill="white" height="24" viewBox="0 0 24 24" width="24">
          <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
          <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
        </svg>
      </button>
      <button id="videoBtn" onclick="toggleVideo()" style="width: 60px; height: 60px; border-radius: 50%; background: rgba(255,255,255,0.2); border: none; cursor: pointer; display: flex; align-items: center; justify-content: center;" title="Video">
        <svg fill="white" height="24" viewBox="0 0 24 24" width="24">
          <path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/>
        </svg>
      </button>
      <button onclick="endCall()" style="width: 70px; height: 70px; border-radius: 50%; background: #ed4956; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center;" title="End Call">
        <svg fill="white" height="32" viewBox="0 0 24 24" width="32">
          <path d="M12 9c-1.6 0-3.15.25-4.6.72v3.1c0 .39-.23.74-.56.9-.98.49-1.87 1.12-2.66 1.85-.18.18-.43.28-.7.28-.28 0-.53-.11-.71-.29L.29 13.08c-.18-.17-.29-.42-.29-.7 0-.28.11-.53.29-.71C3.34 8.78 7.46 7 12 7s8.66 1.78 11.71 4.67c.18.18.29.43.29.71 0 .28-.11.53-.29.71l-2.48 2.48c-.18.18-.43.29-.71.29-.27 0-.52-.11-.7-.28-.79-.74-1.69-1.36-2.67-1.85-.33-.16-.56-.5-.56-.9v-3.1C15.15 9.25 13.6 9 12 9z"/>
        </svg>
      </button>
      <button onclick="toggleSpeaker()" style="width: 60px; height: 60px; border-radius: 50%; background: rgba(255,255,255,0.2); border: none; cursor: pointer; display: flex; align-items: center; justify-content: center;" title="Speaker">
        <svg fill="white" height="24" viewBox="0 0 24 24" width="24">
          <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/>
        </svg>
      </button>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script src="/js/app.js"></script>
  <script src="/js/instagram-theme.js"></script>
  <script>
    InnovateAPI.requireAuth();
    InnovateAPI.initializePage();
    InnovateAPI.initSocket();

    const user = InnovateAPI.getCurrentUser();
    let currentContactId = null;
    let conversations = [];

    function getCurrentUserId() {
      return user.id;
    }

    // Load user info
    async function loadUserInfo() {
      try {
        const data = await InnovateAPI.apiRequest(`/users/${user.id}`);
        const avatar = InnovateAPI.getUserAvatar(data.user.profile_picture);
        // Update profile link in navigation
        const profileLink = document.querySelector('.ig-bottom-nav-item[href^="/profile/"]');
        if (profileLink) {
          profileLink.href = `/profile/${user.id}`;
        }
      } catch (error) {
        console.error('Error loading user info:', error);
      }
    }

    // Load conversations
    async function loadConversations() {
      try {
        const data = await InnovateAPI.apiRequest('/messages/conversations');
        conversations = data.conversations;
        console.log('Conversations loaded and rendering:', conversations.length);
        renderConversations(conversations);
        return conversations;
      } catch (error) {
        console.error('Error loading conversations:', error);
        document.getElementById('conversationsList').innerHTML = 
          '<div style="text-align: center; padding: 40px; color: var(--ig-secondary-text);">Error loading conversations</div>';
        return [];
      }
    }

    // Format message preview based on type
    function formatMessagePreview(message, type, filename) {
      if (!message) return 'Start a conversation';
      
      switch(type) {
        case 'image':
          return 'üì∑ Photo';
        case 'video':
          return 'üé¨ Video';
        case 'voice':
          return 'üé§ Voice message';
        case 'gif':
          return 'üéûÔ∏è GIF';
        case 'location':
          return 'üìç Location';
        case 'file':
          if (filename) {
            if (filename.match(/\.(pdf)$/i)) return 'üìÑ PDF';
            if (filename.match(/\.(doc|docx)$/i)) return 'üìù Document';
            if (filename.match(/\.(xls|xlsx)$/i)) return 'üìä Spreadsheet';
            if (filename.match(/\.(txt)$/i)) return 'üìÉ Text file';
          }
          return 'üìé File';
        case 'todo':
          try {
            const todo = JSON.parse(message);
            return `‚úì ${todo.title || 'Todo list'}`;
          } catch {
            return '‚úì Todo list';
          }
        default:
          // For text messages, truncate if too long
          return message.length > 40 ? message.substring(0, 40) + '...' : message;
      }
    }

    // Render conversations
    function renderConversations(convos) {
      const list = document.getElementById('conversationsList');
      list.innerHTML = '';

      if (convos.length === 0) {
        list.innerHTML = `
          <div style="text-align: center; padding: 40px; color: var(--ig-secondary-text);">
            <div style="font-size: 24px; margin-bottom: 8px;">üì®</div>
            <div>No messages yet</div>
            <div style="font-size: 12px; margin-top: 4px;">Start a conversation</div>
          </div>
        `;
        return;
      }

      convos.forEach(conv => {
        const convEl = document.createElement('div');
        convEl.className = `ig-conversation ${currentContactId === conv.contact_id ? 'active' : ''}`;
        
        const isUnread = conv.unread_count > 0;
        const messageClass = isUnread ? 'ig-conversation-message unread' : 'ig-conversation-message';
        const messagePreview = formatMessagePreview(conv.last_message, conv.last_message_type, conv.last_message_filename);
        
        convEl.innerHTML = `
          <img src="${InnovateAPI.getUserAvatar(conv.profile_picture)}" alt="${conv.username}" class="ig-conversation-avatar">
          <div class="ig-conversation-info">
            <div class="ig-conversation-name">${conv.username}</div>
            <div class="${messageClass}">${messagePreview}</div>
          </div>
          <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 4px;">
            <div class="ig-conversation-time">${conv.last_message_time ? formatTime(conv.last_message_time) : ''}</div>
            <button class="ig-conversation-camera" onclick="event.stopPropagation(); openCameraForUser(${conv.contact_id})">
              <svg fill="currentColor" height="20" viewBox="0 0 24 24" width="20">
                <path d="M6.827 6.175A2.31 2.31 0 0 1 5.186 7.23h-.005A2.31 2.31 0 0 1 3.54 6.175L1.945 4.581a.75.75 0 0 1 1.06-1.06l1.595 1.594a.767.767 0 0 0 .544.226.767.767 0 0 0 .543-.226L7.281 3.52a.75.75 0 0 1 1.061 1.06L6.827 6.175Z" fill-rule="evenodd"></path>
                <path d="M2.25 12a9.75 9.75 0 1 1 19.5 0 9.75 9.75 0 0 1-19.5 0Zm9.75-8.25a8.25 8.25 0 1 0 0 16.5 8.25 8.25 0 0 0 0-16.5Zm0 12.5a4.25 4.25 0 1 1 0-8.5 4.25 4.25 0 0 1 0 8.5Zm0-1.5a2.75 2.75 0 1 0 0-5.5 2.75 2.75 0 0 0 0 5.5Z"></path>
              </svg>
            </button>
            ${isUnread ? '<div class="ig-conversation-unread"></div>' : ''}
          </div>
        `;
        
        convEl.onclick = () => openChat(conv.contact_id, conv.username, conv.profile_picture);
        list.appendChild(convEl);
      });
    }

    // Open chat
    async function openChat(contactId, username, profilePicture) {
      currentContactId = contactId;
      
      // Update UI
      document.getElementById('chatAvatar').src = InnovateAPI.getUserAvatar(profilePicture);
      document.getElementById('chatUsername').textContent = username;
      
      // Mark conversation as active
      document.querySelectorAll('.ig-conversation').forEach(el => el.classList.remove('active'));
      event?.currentTarget?.classList.add('active');
      
      // On mobile, show chat window and hide nav
      const chatWindow = document.getElementById('chatWindow');
      chatWindow.classList.add('active');
      
      // Hide nav on mobile
      if (window.innerWidth <= 768) {
        document.querySelector('.ig-top-nav')?.style.setProperty('display', 'none');
        document.querySelector('.ig-bottom-nav')?.style.setProperty('display', 'none');
      }
      
      // Load messages
      await loadMessages(contactId);
    }

    // Load messages
    async function loadMessages(contactId) {
      try {
        const data = await InnovateAPI.apiRequest(`/messages/${contactId}`);
        const messagesContainer = document.getElementById('chatMessages');
        messagesContainer.innerHTML = '';

        if (data.messages.length === 0) {
          messagesContainer.innerHTML = `
            <div style="text-align: center; color: var(--ig-secondary-text); padding: 40px;">
              <div style="font-size: 24px; margin-bottom: 8px;">üëã</div>
              <div>No messages yet</div>
              <div style="font-size: 12px; margin-top: 4px;">Send a message to start the conversation</div>
            </div>
          `;
          return;
        }

        data.messages.forEach(msg => {
          const messageEl = document.createElement('div');
          const isSent = msg.sender_id === user.id;
          
          if (msg.type === 'image') {
            messageEl.className = isSent ? 'ig-message-media ig-message-sent' : 'ig-message-media ig-message-received';
            const filename = msg.original_filename || msg.content.split('/').pop();
            messageEl.innerHTML = `
              <div style="position: relative; display: inline-block;">
                <img src="${msg.content}" style="max-width: 250px; max-height: 350px; border-radius: 18px; cursor: pointer; display: block;" onclick="openMediaPreview('${msg.content}', 'image', '${filename}')">
                <button onclick="event.stopPropagation(); downloadFile('${msg.content}', '${filename}')" style="position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.6); border: none; color: white; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; display: flex; align-items: center; justify-content: center;" title="Download">
                  <svg fill="currentColor" height="16" viewBox="0 0 24 24" width="16">
                    <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"></path>
                  </svg>
                </button>
              </div>
              <div class="ig-message-time">${formatMessageTime(msg.created_at)}</div>
            `;
          } else if (msg.type === 'gif') {
            messageEl.className = isSent ? 'ig-message-media ig-message-sent' : 'ig-message-media ig-message-received';
            const filename = msg.original_filename || msg.content.split('/').pop();
            messageEl.innerHTML = `
              <div style="position: relative; display: inline-block;">
                <img src="${msg.content}" style="max-width: 250px; max-height: 250px; border-radius: 18px; cursor: pointer; display: block;" onclick="openMediaPreview('${msg.content}', 'gif', '${filename}')">
                <button onclick="event.stopPropagation(); downloadFile('${msg.content}', '${filename}')" style="position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.6); border: none; color: white; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; display: flex; align-items: center; justify-content: center;" title="Download">
                  <svg fill="currentColor" height="16" viewBox="0 0 24 24" width="16">
                    <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"></path>
                  </svg>
                </button>
              </div>
              <div class="ig-message-time">${formatMessageTime(msg.created_at)}</div>
            `;
          } else if (msg.type === 'voice') {
            messageEl.className = isSent ? 'ig-message ig-message-sent' : 'ig-message ig-message-received';
            const filename = msg.original_filename || msg.content.split('/').pop();
            messageEl.innerHTML = `
              <div style="display: flex; align-items: center; gap: 8px;">
                <audio controls style="max-width: 200px;">
                  <source src="${msg.content}" type="audio/webm">
                </audio>
                <button onclick="downloadFile('${msg.content}', '${filename}')" style="background: var(--ig-secondary-background); border: none; color: var(--ig-primary-text); border-radius: 50%; width: 32px; height: 32px; cursor: pointer; display: flex; align-items: center; justify-content: center;" title="Download">
                  <svg fill="currentColor" height="16" viewBox="0 0 24 24" width="16">
                    <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"></path>
                  </svg>
                </button>
              </div>
            `;
          } else if (msg.type === 'location') {
            const loc = JSON.parse(msg.content);
            messageEl.className = isSent ? 'ig-message ig-message-sent' : 'ig-message ig-message-received';
            messageEl.innerHTML = `
              <a href="https://www.google.com/maps?q=${loc.lat},${loc.lng}" target="_blank" style="display: block; text-decoration: none; color: inherit;">
                <div style="font-weight: 600;">üìç Location</div>
                <div style="font-size: 12px; opacity: 0.8;">Tap to view on map</div>
              </a>
            `;
          } else if (msg.type === 'todo') {
            const todo = JSON.parse(msg.content);
            messageEl.className = isSent ? 'ig-message ig-message-sent' : 'ig-message ig-message-received';
            let html = `<div style="font-weight: 600; margin-bottom: 8px;">‚úì ${todo.title}</div>`;
            todo.items.forEach((item, idx) => {
              html += `<div style="display: flex; align-items: center; gap: 8px; padding: 4px 0;">
                <input type="checkbox" ${item.checked ? 'checked' : ''} disabled style="width: 16px; height: 16px;">
                <span style="font-size: 14px;">${item.text}</span>
              </div>`;
            });
            messageEl.innerHTML = html;
          } else if (msg.type === 'file' || msg.type === 'video') {
            messageEl.className = isSent ? 'ig-message ig-message-sent' : 'ig-message ig-message-received';
            const fileName = msg.original_filename || msg.content.split('/').pop();
            const isVideo = msg.type === 'video' || msg.content.match(/\.(mp4|webm|mov|avi)$/i);
            const isPdf = msg.content.match(/\.pdf$/i) || fileName.match(/\.pdf$/i);
            const isDoc = msg.content.match(/\.(doc|docx|txt)$/i) || fileName.match(/\.(doc|docx|txt)$/i);
            
            if (isVideo) {
              messageEl.innerHTML = `
                <div style="position: relative; display: inline-block;">
                  <video controls style="max-width: 250px; max-height: 350px; border-radius: 18px; display: block;">
                    <source src="${msg.content}">
                  </video>
                  <button onclick="event.stopPropagation(); downloadFile('${msg.content}', '${fileName}')" style="position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.6); border: none; color: white; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; display: flex; align-items: center; justify-content: center;" title="Download">
                    <svg fill="currentColor" height="16" viewBox="0 0 24 24" width="16">
                      <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"></path>
                    </svg>
                  </button>
                </div>
              `;
            } else {
              const icon = isPdf ? 'üìÑ' : isDoc ? 'üìù' : 'üìé';
              messageEl.innerHTML = `
                <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--ig-secondary-background); border-radius: 12px; max-width: 250px;">
                  <div style="font-size: 32px;">${icon}</div>
                  <div style="flex: 1; min-width: 0;">
                    <div style="font-weight: 600; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${fileName}</div>
                    <div style="font-size: 12px; color: var(--ig-secondary-text); margin-top: 4px;">Click to preview</div>
                  </div>
                  <button onclick="event.stopPropagation(); downloadFile('${msg.content}', '${fileName}')" style="background: var(--ig-blue); border: none; color: white; border-radius: 50%; width: 36px; height: 36px; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0;" title="Download">
                    <svg fill="currentColor" height="18" viewBox="0 0 24 24" width="18">
                      <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"></path>
                    </svg>
                  </button>
                </div>
              `;
              messageEl.style.cursor = 'pointer';
              messageEl.onclick = () => openMediaPreview(msg.content, 'file', fileName);
            }
          } else {
            messageEl.className = isSent ? 'ig-message ig-message-sent' : 'ig-message ig-message-received';
            messageEl.textContent = msg.content;
            const timeEl = document.createElement('div');
            timeEl.className = 'ig-message-time';
            timeEl.style.cssText = 'display: flex; align-items: center; gap: 4px; justify-content: ' + (isSent ? 'flex-end' : 'flex-start') + ';';
            
            // Format time and add status for sent messages
            if (isSent) {
              const statusIcon = msg.is_read ? '‚úì‚úì' : '‚úì'; // Double check if read, single if delivered
              timeEl.innerHTML = `<span style="font-size: 11px;">${formatMessageTime(msg.created_at)}</span><span style="font-size: 10px; color: ${msg.is_read ? '#0095f6' : 'inherit'};">${statusIcon}</span>`;
            } else {
              timeEl.textContent = formatMessageTime(msg.created_at);
            }
            
            // Add timer indicator if message has expiry
            if (msg.expires_at) {
              const timerEl = document.createElement('span');
              timerEl.style.cssText = 'margin-left: 8px; opacity: 0.7;';
              timerEl.textContent = 'üïê';
              timeEl.appendChild(timerEl);
            }
            
            messageEl.appendChild(timeEl);
          }
          
          // Store message data for timer tracking
          if (msg.expires_at) {
            messageEl.dataset.messageId = msg.id;
            messageEl.dataset.expiresAt = msg.expires_at;
          }
          
          // Add long-press detection for message actions
          let pressTimer;
          messageEl.addEventListener('touchstart', (e) => {
            pressTimer = setTimeout(() => {
              showMessageActions(msg.id, msg.content, isSent);
            }, 500);
          });
          
          messageEl.addEventListener('touchend', () => {
            clearTimeout(pressTimer);
          });
          
          messageEl.addEventListener('touchmove', () => {
            clearTimeout(pressTimer);
          });
          
          // Desktop right-click support
          messageEl.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            showMessageActions(msg.id, msg.content, isSent);
          });
          
          messagesContainer.appendChild(messageEl);
        });

        // Scroll to bottom
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
        // Start checking for expired messages
        checkExpiredMessages();
      } catch (error) {
        console.error('Error loading messages:', error);
      }
    }
    
    // Check and remove expired messages
    function checkExpiredMessages() {
      const messagesContainer = document.getElementById('chatMessages');
      if (!messagesContainer) return;
      
      const now = new Date().getTime();
      const messages = messagesContainer.querySelectorAll('[data-expires-at]');
      
      messages.forEach(messageEl => {
        const expiresAt = new Date(messageEl.dataset.expiresAt).getTime();
        if (now >= expiresAt) {
          // Fade out and remove
          messageEl.style.transition = 'opacity 0.5s';
          messageEl.style.opacity = '0';
          setTimeout(() => {
            messageEl.remove();
          }, 500);
        }
      });
    }
    
    // Check expired messages every 5 seconds
    setInterval(checkExpiredMessages, 5000);

    // Send message
    async function sendMessage() {
      const input = document.getElementById('messageInput');
      const content = input.value.trim();
      
      if (!content || !currentContactId) return;
      
      // Check if editing
      const isEditing = input.dataset.editing;
      if (isEditing) {
        try {
          await InnovateAPI.apiRequest(`/messages/${isEditing}`, {
            method: 'PUT',
            body: JSON.stringify({ content })
          });
          
          delete input.dataset.editing;
          input.value = '';
          input.placeholder = 'Message...';
          
          // Reset send button
          const sendBtn = document.getElementById('sendBtn');
          sendBtn.innerHTML = '<svg aria-label="Send" fill="currentColor" height="24" viewBox="0 0 24 24" width="24"><path d="M1.464 12.986 23.963.863a.5.5 0 0 1 .71.627l-5.24 20.618a.5.5 0 0 1-.925.114l-5.14-9.47-9.472-5.138a.5.5 0 0 1 .115-.925l-.547.297Z" stroke="currentColor" fill="none" stroke-linejoin="round"></path></svg>';
          
          loadMessages(currentContactId);
          InnovateAPI.showAlert('Message updated', 'success');
        } catch (error) {
          InnovateAPI.showAlert('Failed to update message', 'error');
        }
        return;
      }
      
      // Check for timer
      const timer = input.dataset.timer;
      const messageData = {
        receiver_id: currentContactId,
        content: content
      };
      
      if (timer) {
        messageData.timer = parseInt(timer);
        delete input.dataset.timer;
        input.placeholder = 'Message...';
      }
      
      try {
        await InnovateAPI.apiRequest('/messages', {
          method: 'POST',
          body: JSON.stringify(messageData)
        });
        
        // Clear input
        input.value = '';
        
        // Add message to UI
        const messagesContainer = document.getElementById('chatMessages');
        const messageEl = document.createElement('div');
        messageEl.className = 'ig-message ig-message-sent';
        messageEl.textContent = content;
        
        // Add message status (delivered)
        const statusEl = document.createElement('div');
        statusEl.className = 'ig-message-time';
        statusEl.style.cssText = 'display: flex; align-items: center; gap: 4px; justify-content: flex-end;';
        statusEl.innerHTML = `<span style="font-size: 11px;">Just now</span><span style="font-size: 10px;">‚úì‚úì</span>`;
        messageEl.appendChild(statusEl);
        
        if (timer) {
          const timerEl = document.createElement('div');
          timerEl.style.cssText = 'font-size: 11px; opacity: 0.7; margin-top: 4px;';
          timerEl.textContent = `üïê ${formatTimerDuration(parseInt(timer))}`;
          messageEl.appendChild(timerEl);
        }
        
        // Remove placeholder if exists
        if (messagesContainer.querySelector('[style*="text-align: center"]')) {
          messagesContainer.innerHTML = '';
        }
        
        messagesContainer.appendChild(messageEl);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
        // Emit via socket
        InnovateAPI.getSocket().emit('send_message', {
          receiver_id: currentContactId,
          content: content
        });
        
        // Reload conversations to update last message (with small delay)
        setTimeout(() => {
          loadConversations();
        }, 300);
      } catch (error) {
        console.error('Error sending message:', error);
        InnovateAPI.showAlert('Failed to send message', 'error');
      }
    }

    // Close chat (mobile)
    function closeChat() {
      document.getElementById('chatWindow').classList.remove('active');
      
      // Show nav on mobile
      if (window.innerWidth <= 768) {
        document.querySelector('.ig-top-nav')?.style.setProperty('display', 'block');
        document.querySelector('.ig-bottom-nav')?.style.setProperty('display', 'flex');
      }
    }

    // New message
    async function newMessage() {
      const username = prompt('Enter username to message:');
      if (!username) return;
      
      try {
        const data = await InnovateAPI.apiRequest(`/search/users?q=${encodeURIComponent(username)}`);
        if (data.users && data.users.length > 0) {
          const user = data.users[0];
          openChat(user.id, user.username, user.profile_picture);
        } else {
          InnovateAPI.showAlert('User not found', 'error');
        }
      } catch (error) {
        InnovateAPI.showAlert('Error searching for user', 'error');
      }
    }

    // Format time
    function formatTime(timestamp) {
      const date = new Date(timestamp);
      const now = new Date();
      const diff = now - date;
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);
      
      if (minutes < 1) return 'now';
      if (minutes < 60) return `${minutes}m`;
      if (hours < 24) return `${hours}h`;
      if (days < 7) return `${days}d`;
      return date.toLocaleDateString();
    }
    
    // Format message time (for chat)
    function formatMessageTime(timestamp) {
      const date = new Date(timestamp);
      const now = new Date();
      const isToday = date.toDateString() === now.toDateString();
      
      if (isToday) {
        return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
      } else {
        const diff = now - date;
        const days = Math.floor(diff / 86400000);
        if (days < 7) {
          return date.toLocaleDateString('en-US', { weekday: 'short' }) + ' ' + date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
        }
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      }
    }

    // Search messages
    let searchTimeout;
    document.getElementById('searchMessages').addEventListener('input', async (e) => {
      const query = e.target.value.trim();
      
      if (!query) {
        renderConversations(conversations);
        return;
      }
      
      const queryLower = query.toLowerCase();
      const filtered = conversations.filter(conv => 
        conv.username.toLowerCase().includes(queryLower) ||
        (conv.last_message && conv.last_message.toLowerCase().includes(queryLower))
      );
      
      // If no conversations match, search for users
      if (filtered.length === 0 && query.length >= 2) {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(async () => {
          try {
            const data = await InnovateAPI.apiRequest(`/search/users?q=${encodeURIComponent(query)}`);
            if (data.users && data.users.length > 0) {
              // Display found users as potential new conversations
              const list = document.getElementById('conversationsList');
              list.innerHTML = `
                <div style="padding: 12px 16px; font-size: 12px; color: var(--ig-secondary-text); font-weight: 600;">
                  SEARCH RESULTS
                </div>
              `;
              
              data.users.forEach(user => {
                const userEl = document.createElement('div');
                userEl.className = 'ig-conversation';
                userEl.innerHTML = `
                  <img src="${InnovateAPI.getUserAvatar(user.profile_picture)}" alt="${user.username}" class="ig-conversation-avatar">
                  <div class="ig-conversation-info">
                    <div class="ig-conversation-name">${user.fullname || user.username}</div>
                    <div class="ig-conversation-message">@${user.username}</div>
                  </div>
                `;
                userEl.onclick = () => {
                  openChat(user.id, user.username, user.profile_picture);
                  e.target.value = '';
                  renderConversations(conversations);
                };
                list.appendChild(userEl);
              });
            } else {
              renderConversations([]);
            }
          } catch (error) {
            console.error('Search error:', error);
            renderConversations(filtered);
          }
        }, 300);
      } else {
        renderConversations(filtered);
      }
    });

    // Setup Socket.IO Event Listeners
    function setupSocketListeners() {
      console.log('Setting up Socket.IO event listeners...');
      const socket = InnovateAPI.getSocket();
      
      // Remove any existing listeners to prevent duplicates
      socket.off('new_message');
      socket.off('user:online');
      socket.off('user:offline');
      socket.off('message:expired');
      
      // New message listener
      socket.on('new_message', (data) => {
      if (data.sender_id === currentContactId) {
        const messagesContainer = document.getElementById('chatMessages');
        const messageEl = document.createElement('div');
        
        if (data.type === 'image') {
          messageEl.className = 'ig-message-media ig-message-received';
          const filename = data.original_filename || data.content.split('/').pop();
          messageEl.innerHTML = `
            <div style="position: relative; display: inline-block;">
              <img src="${data.content}" style="max-width: 250px; max-height: 350px; border-radius: 18px; cursor: pointer; display: block;" onclick='openMediaPreview(\`${data.content}\`, "image", \`${filename}\`)'>
              <button onclick='event.stopPropagation(); downloadFile(\`${data.content}\`, \`${filename}\`)' style="position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.6); border: none; color: white; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; display: flex; align-items: center; justify-content: center;" title="Download">
                <svg fill="currentColor" height="16" viewBox="0 0 24 24" width="16">
                  <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"></path>
                </svg>
              </button>
            </div>
            <div class="ig-message-time">${formatMessageTime(data.created_at)}</div>
          `;
        } else if (data.type === 'gif') {
          messageEl.className = 'ig-message-media ig-message-received';
          messageEl.innerHTML = `
            <div style="position: relative; display: inline-block;">
              <img src="${data.content}" style="max-width: 250px; max-height: 250px; border-radius: 18px; cursor: pointer; display: block;" onclick='openMediaPreview(\`${data.content}\`, "gif")'>
            </div>
            <div class="ig-message-time">${formatMessageTime(data.created_at)}</div>
          `;
        } else if (data.type === 'voice') {
          messageEl.className = 'ig-message ig-message-received';
          const filename = data.original_filename || data.content.split('/').pop();
          messageEl.innerHTML = `
            <div style="display: flex; align-items: center; gap: 8px;">
              <audio controls style="max-width: 200px;">
                <source src="${data.content}" type="audio/webm">
              </audio>
              <button onclick='downloadFile(\`${data.content}\`, \`${filename}\`)' style="background: var(--ig-secondary-background); border: none; color: var(--ig-primary-text); border-radius: 50%; width: 32px; height: 32px; cursor: pointer; display: flex; align-items: center; justify-content: center;" title="Download">
                <svg fill="currentColor" height="16" viewBox="0 0 24 24" width="16">
                  <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"></path>
                </svg>
              </button>
            </div>
          `;
        } else if (data.type === 'video') {
          messageEl.className = 'ig-message ig-message-received';
          const filename = data.original_filename || data.content.split('/').pop();
          messageEl.innerHTML = `
            <div style="position: relative; display: inline-block;">
              <video controls style="max-width: 250px; max-height: 350px; border-radius: 18px; display: block;">
                <source src="${data.content}">
              </video>
              <button onclick="event.stopPropagation(); downloadFile('${data.content}', '${filename}')" style="position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.6); border: none; color: white; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; display: flex; align-items: center; justify-content: center;" title="Download">
                <svg fill="currentColor" height="16" viewBox="0 0 24 24" width="16">
                  <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"></path>
                </svg>
              </button>
            </div>
          `;
        } else if (data.type === 'file') {
          messageEl.className = 'ig-message ig-message-received';
          const fileName = data.original_filename || data.content.split('/').pop();
          const isPdf = data.content.match(/\.pdf$/i) || fileName.match(/\.pdf$/i);
          const isDoc = data.content.match(/\.(doc|docx|txt)$/i) || fileName.match(/\.(doc|docx|txt)$/i);
          const icon = isPdf ? 'üìÑ' : isDoc ? 'üìù' : 'üìé';
          messageEl.innerHTML = `
            <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--ig-secondary-background); border-radius: 12px; max-width: 250px; cursor: pointer;" onclick='openMediaPreview(\`${data.content}\`, "file", \`${fileName}\`)'>
              <div style="font-size: 32px;">${icon}</div>
              <div style="flex: 1; min-width: 0;">
                <div style="font-weight: 600; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${fileName}</div>
                <div style="font-size: 12px; color: var(--ig-secondary-text); margin-top: 4px;">Click to preview</div>
              </div>
              <button onclick='event.stopPropagation(); downloadFile(\`${data.content}\`, \`${fileName}\`)' style="background: var(--ig-blue); border: none; color: white; border-radius: 50%; width: 36px; height: 36px; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0;" title="Download">
                <svg fill="currentColor" height="18" viewBox="0 0 24 24" width="18">
                  <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"></path>
                </svg>
              </button>
            </div>
          `;
        } else if (data.type === 'location') {
          messageEl.className = 'ig-message ig-message-received';
          const loc = JSON.parse(data.content);
          messageEl.innerHTML = `
            <a href="https://www.google.com/maps?q=${loc.lat},${loc.lng}" target="_blank" style="display: block; text-decoration: none; color: inherit;">
              <div style="font-weight: 600;">üìç Location</div>
              <div style="font-size: 12px; opacity: 0.8;">Tap to view on map</div>
            </a>
          `;
        } else if (data.type === 'todo') {
          messageEl.className = 'ig-message ig-message-received';
          const todo = JSON.parse(data.content);
          let html = `<div style="font-weight: 600; margin-bottom: 8px;">‚úì ${todo.title}</div>`;
          todo.items.forEach((item, idx) => {
            html += `<div style="display: flex; align-items: center; gap: 8px; padding: 4px 0;">
              <input type="checkbox" ${item.checked ? 'checked' : ''} disabled style="width: 16px; height: 16px;">
              <span style="font-size: 14px;">${item.text}</span>
            </div>`;
          });
          messageEl.innerHTML = html;
        } else {
          messageEl.className = 'ig-message ig-message-received';
          messageEl.textContent = data.content;
          const timeEl = document.createElement('div');
          timeEl.className = 'ig-message-time';
          timeEl.textContent = formatMessageTime(data.created_at);
          messageEl.appendChild(timeEl);
        }
        
        messagesContainer.appendChild(messageEl);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }
      
      // Reload conversations to update last message (with small delay to ensure DB is updated)
      setTimeout(() => {
        loadConversations();
      }, 300);
    });
    
    // Online/Offline status listeners
    socket.on('user:online', (userId) => {
      if (userId == currentContactId) {
        const statusEl = document.getElementById('chatStatus');
        if (statusEl) {
          statusEl.textContent = 'Active now';
          statusEl.style.color = 'var(--ig-secondary-text)';
        }
      }
    });
    
    socket.on('user:offline', (userId) => {
      if (userId == currentContactId) {
        const statusEl = document.getElementById('chatStatus');
        if (statusEl) {
          statusEl.textContent = 'Offline';
          statusEl.style.color = 'var(--ig-secondary-text)';
        }
      }
    });
    
    // Listen for expired messages
    socket.on('message:expired', (messageId) => {
      const messageEl = document.querySelector(`[data-message-id="${messageId}"]`);
      if (messageEl) {
        messageEl.style.transition = 'opacity 0.5s';
        messageEl.style.opacity = '0';
        setTimeout(() => {
          messageEl.remove();
        }, 500);
      }
    });
    
    // WebRTC call event listeners
    socket.off('call:incoming');
    socket.off('call:answered');
    socket.off('call:ice-candidate');
    socket.off('call:rejected');
    socket.off('call:ended');
    
    console.log('Registering call event listeners...');
    socket.on('call:incoming', (data) => {
      console.log('call:incoming event received:', data);
      showIncomingCall(data);
    });

    socket.on('call:answered', async (data) => {
      if (peerConnection && data.answer) {
        await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
      }
    });

    socket.on('call:ice-candidate', async (data) => {
      if (peerConnection && data.candidate) {
        await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
      }
    });

    socket.on('call:rejected', () => {
      InnovateAPI.showAlert('Call rejected', 'info');
      cleanupCall();
    });

    socket.on('call:ended', () => {
      InnovateAPI.showAlert('Call ended', 'info');
      cleanupCall();
    });
      
    // Emit user join
    socket.emit('user:join', user.id);
    console.log('Socket.IO listeners setup complete');
  }
    
    // Voice recording
    let mediaRecorder;
    let audioChunks = [];
    let isRecording = false;
    
    async function startVoiceRecording() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        isRecording = true;
        
        mediaRecorder.ondataavailable = (event) => {
          audioChunks.push(event.data);
        };
        
        mediaRecorder.onstop = async () => {
          const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
          await sendVoiceMessage(audioBlob);
          stream.getTracks().forEach(track => track.stop());
        };
        
        mediaRecorder.start();
        document.querySelector('.ig-voice-btn').style.background = '#ed4956';
      } catch (error) {
        InnovateAPI.showAlert('Microphone access denied', 'error');
      }
    }
    
    function stopVoiceRecording() {
      if (isRecording && mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
        isRecording = false;
        document.querySelector('.ig-voice-btn').style.background = '';
      }
    }
    
    async function sendVoiceMessage(audioBlob) {
      if (!currentContactId) return;
      
      const formData = new FormData();
      formData.append('audio', audioBlob, 'voice-message.webm');
      formData.append('receiver_id', currentContactId);
      formData.append('type', 'voice');
      
      try {
        const response = await InnovateAPI.apiRequest('/messages/send', {
          method: 'POST',
          body: formData,
          headers: {} // Let browser set Content-Type for FormData
        });
        
        loadMessages(currentContactId);
        InnovateAPI.showAlert('Voice message sent', 'success');
      } catch (error) {
        InnovateAPI.showAlert('Failed to send voice message', 'error');
      }
    }
    
    // Camera functions
    let cameraStream;
    
    async function openCamera() {
      document.getElementById('attachMenu').style.display = 'none';
      document.getElementById('cameraModal').style.display = 'flex';
      
      try {
        cameraStream = await navigator.mediaDevices.getUserMedia({ 
          video: { facingMode: 'user' } 
        });
        document.getElementById('cameraPreview').srcObject = cameraStream;
      } catch (error) {
        InnovateAPI.showAlert('Camera access denied', 'error');
        closeCameraModal();
      }
    }
    
    function closeCameraModal() {
      document.getElementById('cameraModal').style.display = 'none';
      if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
      }
    }
    
    async function capturePhoto() {
      const video = document.getElementById('cameraPreview');
      const canvas = document.getElementById('cameraCanvas');
      const context = canvas.getContext('2d');
      
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      context.drawImage(video, 0, 0);
      
      canvas.toBlob(async (blob) => {
        closeCameraModal();
        await sendFile(blob, 'camera-photo.jpg');
      }, 'image/jpeg', 0.9);
    }
    
    // Location sharing
    async function shareLocation() {
      document.getElementById('attachMenu').style.display = 'none';
      
      if (!navigator.geolocation) {
        InnovateAPI.showAlert('Geolocation not supported', 'error');
        return;
      }
      
      InnovateAPI.showAlert('Getting your location...', 'info');
      
      navigator.geolocation.getCurrentPosition(
        async (position) => {
          const location = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          };
          
          try {
            await InnovateAPI.apiRequest('/messages/send', {
              method: 'POST',
              body: JSON.stringify({
                receiver_id: currentContactId,
                content: JSON.stringify(location),
                type: 'location'
              })
            });
            
            loadMessages(currentContactId);
            InnovateAPI.showAlert('Location shared', 'success');
          } catch (error) {
            InnovateAPI.showAlert('Failed to share location', 'error');
          }
        },
        (error) => {
          InnovateAPI.showAlert('Location access denied', 'error');
        }
      );
    }
    
    // File sending
    async function sendFile(file, filename) {
      if (!currentContactId) {
        InnovateAPI.showAlert('Please select a conversation first', 'error');
        return;
      }
      
      const formData = new FormData();
      formData.append('file', file, filename || file.name);
      formData.append('receiver_id', currentContactId);
      
      // Determine type
      let fileType = 'file';
      if (file.type.startsWith('image/')) {
        fileType = 'image';
      } else if (file.type.startsWith('video/')) {
        fileType = 'video';
      }
      formData.append('type', fileType);
      
      try {
        const response = await InnovateAPI.apiRequest('/messages/send', {
          method: 'POST',
          body: formData
        });
        
        // Add file message to UI immediately with delivered status
        const messagesContainer = document.getElementById('chatMessages');
        const messageEl = document.createElement('div');
        messageEl.className = 'ig-message ig-message-sent';
        
        let icon = 'üìé';
        if (file.type.startsWith('image/')) icon = 'üì∑';
        else if (file.type.startsWith('video/')) icon = 'üé¨';
        else if (filename.match(/\.pdf$/i)) icon = 'üìÑ';
        else if (filename.match(/\.(doc|docx)$/i)) icon = 'üìù';
        
        messageEl.innerHTML = `
          <div style="display: inline-block;">
            <div style="font-size: 14px;">${icon} ${filename || file.name}</div>
            <div class="ig-message-time" style="display: flex; align-items: center; gap: 4px; justify-content: flex-end;">
              <span style="font-size: 11px;">Just now</span>
              <span style="font-size: 10px;">‚úì‚úì</span>
            </div>
          </div>
        `;
        messagesContainer.appendChild(messageEl);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
        // Reload messages to get full message data
        setTimeout(() => {
          loadMessages(currentContactId);
        }, 500);
        
        InnovateAPI.showAlert('File sent successfully', 'success');
      } catch (error) {
        console.error('File send error:', error);
        InnovateAPI.showAlert('Failed to send file', 'error');
      }
    }
    
    // Attach menu toggle
    function toggleAttachMenu() {
      const menu = document.getElementById('attachMenu');
      menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
    }
    
    // Emoji Picker Functions
    const emojis = [
      'üòÄ', 'üòÉ', 'üòÑ', 'üòÅ', 'üòÜ', 'üòÖ', 'ü§£', 'üòÇ', 'üôÇ', 'üôÉ', 'üòâ', 'üòä', 'üòá', 
      '‚ù§Ô∏è', 'üß°', 'üíõ', 'üíö', 'üíô', 'üíú', 'üñ§', 'ü§ç', 'ü§é', 'üíî', '‚ù£Ô∏è', 'üíï', 'üíû', 
      'üëç', 'üëé', 'üëä', '‚úä', 'ü§õ', 'ü§ú', 'ü§û', '‚úåÔ∏è', 'ü§ü', 'ü§ò', 'üëå', 'ü§è', 'üëà', 
      'üî•', '‚ú®', 'üí´', '‚≠ê', 'üåü', 'üí•', 'üí¢', 'üíØ', '‚úÖ', '‚ùå', '‚ö†Ô∏è', '‚ùó', '‚ùì',
      'üéâ', 'üéä', 'üéà', 'üéÅ', 'üèÜ', 'ü•á', 'ü•à', 'ü•â', '‚öΩ', 'üèÄ', 'üèà', '‚öæ', 'üéæ'
    ];
    
    function openEmojiPicker() {
      const modal = document.getElementById('emojiModal');
      const grid = document.querySelector('.ig-emoji-grid');
      
      // Populate emoji grid if empty
      if (!grid.hasChildNodes()) {
        emojis.forEach(emoji => {
          const btn = document.createElement('button');
          btn.className = 'ig-emoji-item';
          btn.textContent = emoji;
          btn.onclick = () => insertEmoji(emoji);
          grid.appendChild(btn);
        });
      }
      
      modal.style.display = 'flex';
    }
    
    function closeEmojiPicker() {
      document.getElementById('emojiModal').style.display = 'none';
    }
    
    function switchEmojiTab(tab) {
      const emojiTab = document.getElementById('emojiTab');
      const gifTab = document.getElementById('gifTab');
      const emojiContent = document.getElementById('emojiContent');
      const gifContent = document.getElementById('gifContent');
      
      if (tab === 'emoji') {
        emojiTab.classList.add('active');
        emojiTab.style.borderBottom = '2px solid var(--ig-blue)';
        emojiTab.style.color = 'var(--ig-primary-text)';
        gifTab.classList.remove('active');
        gifTab.style.borderBottom = '2px solid transparent';
        gifTab.style.color = 'var(--ig-secondary-text)';
        emojiContent.style.display = 'block';
        gifContent.style.display = 'none';
      } else {
        gifTab.classList.add('active');
        gifTab.style.borderBottom = '2px solid var(--ig-blue)';
        gifTab.style.color = 'var(--ig-primary-text)';
        emojiTab.classList.remove('active');
        emojiTab.style.borderBottom = '2px solid transparent';
        emojiTab.style.color = 'var(--ig-secondary-text)';
        gifContent.style.display = 'block';
        emojiContent.style.display = 'none';
        // Load trending GIFs on first open
        const gifGrid = document.getElementById('gifGridInPicker');
        if (gifGrid.children.length === 1) {
          searchGifsInPicker('trending');
        }
      }
    }
    
    function insertEmoji(emoji) {
      const input = document.getElementById('messageInput');
      const start = input.selectionStart;
      const end = input.selectionEnd;
      const text = input.value;
      
      input.value = text.substring(0, start) + emoji + text.substring(end);
      input.selectionStart = input.selectionEnd = start + emoji.length;
      input.focus();
      
      // Trigger input event to show send button if needed
      input.dispatchEvent(new Event('input'));
    }
    
    // GIF search in emoji picker
    let gifSearchTimeoutInPicker;
    async function searchGifsInPicker(query) {
      clearTimeout(gifSearchTimeoutInPicker);
      gifSearchTimeoutInPicker = setTimeout(async () => {
        const grid = document.getElementById('gifGridInPicker');
        grid.innerHTML = '<div style="text-align: center; padding: 20px; grid-column: 1/-1; color: var(--ig-secondary-text);">Searching...</div>';
        
        try {
          const endpoint = query === 'trending' ? 
            `https://api.giphy.com/v1/gifs/trending?api_key=${GIPHY_API_KEY}&limit=20` :
            `https://api.giphy.com/v1/gifs/search?api_key=${GIPHY_API_KEY}&q=${encodeURIComponent(query)}&limit=20`;
          
          const response = await fetch(endpoint);
          const data = await response.json();
          
          grid.innerHTML = '';
          if (data.data.length === 0) {
            grid.innerHTML = '<div style="text-align: center; padding: 40px; grid-column: 1/-1; color: var(--ig-secondary-text);">No GIFs found</div>';
            return;
          }
          
          data.data.forEach(gif => {
            const img = document.createElement('img');
            img.src = gif.images.fixed_height_small.url;
            img.style.cssText = 'width: 100%; height: 150px; object-fit: cover; border-radius: 8px; cursor: pointer;';
            img.onclick = () => sendGifFromPicker(gif.images.fixed_height.url);
            grid.appendChild(img);
          });
        } catch (error) {
          grid.innerHTML = '<div style="text-align: center; padding: 40px; grid-column: 1/-1; color: var(--ig-secondary-text);">Failed to load GIFs</div>';
        }
      }, 500);
    }
    
    async function sendGifFromPicker(gifUrl) {
      if (!currentContactId) {
        InnovateAPI.showAlert('Please select a conversation first', 'error');
        return;
      }
      
      closeEmojiPicker();
      
      try {
        await InnovateAPI.apiRequest('/messages/send', {
          method: 'POST',
          body: JSON.stringify({
            receiver_id: currentContactId,
            content: gifUrl,
            type: 'gif'
          })
        });
        
        loadMessages(currentContactId);
        InnovateAPI.showAlert('GIF sent', 'success');
      } catch (error) {
        InnovateAPI.showAlert('Failed to send GIF', 'error');
      }
    }
    
    // Message Actions Functions
    let selectedMessageId = null;
    let selectedMessageContent = null;
    
    function showMessageActions(messageId, content, isSent) {
      selectedMessageId = messageId;
      selectedMessageContent = content;
      
      const modal = document.getElementById('messageActionsModal');
      const unsendBtn = document.getElementById('unsendBtn');
      const editBtn = document.getElementById('editBtn');
      
      // Only show unsend and edit for sent messages
      if (unsendBtn) {
        unsendBtn.style.display = isSent ? 'flex' : 'none';
      }
      if (editBtn) {
        editBtn.style.display = isSent ? 'flex' : 'none';
      }
      
      modal.style.display = 'flex';
    }
    
    function closeMessageActions() {
      document.getElementById('messageActionsModal').style.display = 'none';
      selectedMessageId = null;
      selectedMessageContent = null;
    }
    
    async function replyToMessage() {
      closeMessageActions();
      const input = document.getElementById('messageInput');
      const replyPreview = document.createElement('div');
      replyPreview.className = 'ig-reply-preview';
      replyPreview.innerHTML = `
        <div style="padding: 8px 12px; background: var(--ig-hover-overlay); border-left: 3px solid var(--ig-blue); margin-bottom: 8px; border-radius: 8px;">
          <div style="font-size: 12px; color: var(--ig-blue); margin-bottom: 4px;">Replying to message</div>
          <div style="font-size: 13px; color: var(--ig-secondary-text); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
            ${selectedMessageContent}
          </div>
          <button onclick="this.parentElement.remove()" style="position: absolute; right: 8px; top: 8px; background: none; border: none; cursor: pointer;">‚úï</button>
        </div>
      `;
      input.parentElement.insertBefore(replyPreview, input);
      input.focus();
    }
    
    async function copyMessage() {
      try {
        await navigator.clipboard.writeText(selectedMessageContent);
        InnovateAPI.showAlert('Message copied', 'success');
        closeMessageActions();
      } catch (error) {
        InnovateAPI.showAlert('Failed to copy message', 'error');
      }
    }
    
    async function forwardMessage() {
      closeMessageActions();
      InnovateAPI.showAlert('Forward feature coming soon', 'info');
      // TODO: Show user picker modal to select recipients
    }
    
    async function deleteMessage() {
      if (!confirm('Delete this message for you?')) return;
      
      try {
        const response = await InnovateAPI.apiRequest(`/messages/${selectedMessageId}`, {
          method: 'DELETE'
        });
        
        loadMessages(currentContactId);
        InnovateAPI.showAlert('Message deleted', 'success');
        closeMessageActions();
      } catch (error) {
        InnovateAPI.showAlert('Failed to delete message', 'error');
      }
    }
    
    async function unsendMessage() {
      if (!confirm('Unsend this message for everyone?')) return;
      
      try {
        const response = await InnovateAPI.apiRequest(`/messages/${selectedMessageId}/unsend`, {
          method: 'DELETE'
        });
        
        loadMessages(currentContactId);
        InnovateAPI.showAlert('Message unsent', 'success');
        closeMessageActions();
      } catch (error) {
        InnovateAPI.showAlert('Failed to unsend message', 'error');
      }
    }
    
    // Edit message
    async function editMessage() {
      closeMessageActions();
      const input = document.getElementById('messageInput');
      input.value = selectedMessageContent;
      input.dataset.editing = selectedMessageId;
      input.focus();
      
      // Change send button to "Update"
      const sendBtn = document.getElementById('sendBtn');
      if (sendBtn) {
        sendBtn.innerHTML = '<svg aria-label="Update" fill="currentColor" height="24" viewBox="0 0 24 24" width="24"><path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"></path></svg>';
        sendBtn.style.display = 'inline-flex';
      }
    }
    
    // GIF Picker Functions
    let gifSearchTimeout;
    const GIPHY_API_KEY = 'Gc7131jiJuvI7IdN0HZ1D7nh0ow5BH6g'; // Public Giphy API key
    
    function openGifPicker() {
      document.getElementById('gifModal').style.display = 'flex';
      document.getElementById('gifSearch').value = '';
      searchGifs('trending');
    }
    
    function closeGifPicker() {
      document.getElementById('gifModal').style.display = 'none';
    }
    
    async function searchGifs(query) {
      clearTimeout(gifSearchTimeout);
      gifSearchTimeout = setTimeout(async () => {
        const grid = document.getElementById('gifGrid');
        grid.innerHTML = '<div style="text-align: center; padding: 20px; grid-column: 1/-1; color: var(--ig-secondary-text);">Searching...</div>';
        
        try {
          const endpoint = query === 'trending' ? 
            `https://api.giphy.com/v1/gifs/trending?api_key=${GIPHY_API_KEY}&limit=20` :
            `https://api.giphy.com/v1/gifs/search?api_key=${GIPHY_API_KEY}&q=${encodeURIComponent(query)}&limit=20`;
          
          const response = await fetch(endpoint);
          const data = await response.json();
          
          grid.innerHTML = '';
          if (data.data.length === 0) {
            grid.innerHTML = '<div style="text-align: center; padding: 40px; grid-column: 1/-1; color: var(--ig-secondary-text);">No GIFs found</div>';
            return;
          }
          
          data.data.forEach(gif => {
            const img = document.createElement('img');
            img.src = gif.images.fixed_height_small.url;
            img.style.cssText = 'width: 100%; height: 150px; object-fit: cover; border-radius: 8px; cursor: pointer;';
            img.onclick = () => sendGif(gif.images.fixed_height.url);
            grid.appendChild(img);
          });
        } catch (error) {
          grid.innerHTML = '<div style="text-align: center; padding: 40px; grid-column: 1/-1; color: var(--ig-secondary-text);">Failed to load GIFs</div>';
        }
      }, 500);
    }
    
    async function sendGif(gifUrl) {
      if (!currentContactId) return;
      
      closeGifPicker();
      toggleAttachMenu();
      
      try {
        await InnovateAPI.apiRequest('/messages/send', {
          method: 'POST',
          body: JSON.stringify({
            receiver_id: currentContactId,
            content: gifUrl,
            type: 'gif'
          })
        });
        
        loadMessages(currentContactId);
        InnovateAPI.showAlert('GIF sent', 'success');
      } catch (error) {
        InnovateAPI.showAlert('Failed to send GIF', 'error');
      }
    }
    
    // TODO List Functions
    let todoItemCount = 0;
    
    function openTodoCreator() {
      document.getElementById('todoModal').style.display = 'flex';
      document.getElementById('todoTitle').value = '';
      document.getElementById('todoItems').innerHTML = '';
      todoItemCount = 0;
      addTodoItem();
      toggleAttachMenu();
    }
    
    function closeTodoCreator() {
      document.getElementById('todoModal').style.display = 'none';
    }
    
    function addTodoItem() {
      const container = document.getElementById('todoItems');
      const itemId = ++todoItemCount;
      const div = document.createElement('div');
      div.style.cssText = 'display: flex; gap: 8px; margin-bottom: 8px; align-items: center;';
      div.innerHTML = `
        <input type="checkbox" id="todo_${itemId}" style="width: 18px; height: 18px;">
        <input type="text" class="todo-item-text" placeholder="Task ${itemId}..." style="flex: 1; padding: 8px; border: 1px solid var(--ig-border); border-radius: 6px; background: var(--ig-secondary-background); color: var(--ig-primary-text);">
        <button onclick="this.parentElement.remove()" style="background: none; border: none; color: var(--ig-secondary-text); cursor: pointer; font-size: 20px;">&times;</button>
      `;
      container.appendChild(div);
    }
    
    async function sendTodoList() {
      const title = document.getElementById('todoTitle').value || 'TODO List';
      const items = [];
      
      document.querySelectorAll('.todo-item-text').forEach(input => {
        if (input.value.trim()) {
          items.push({
            text: input.value.trim(),
            checked: false
          });
        }
      });
      
      if (items.length === 0) {
        InnovateAPI.showAlert('Please add at least one item', 'error');
        return;
      }
      
      const todoData = { title, items };
      
      try {
        await InnovateAPI.apiRequest('/messages/send', {
          method: 'POST',
          body: JSON.stringify({
            receiver_id: currentContactId,
            content: JSON.stringify(todoData),
            type: 'todo'
          })
        });
        
        // Add TODO message to UI immediately
        const messagesContainer = document.getElementById('chatMessages');
        const messageEl = document.createElement('div');
        messageEl.className = 'ig-message ig-message-sent';
        
        let html = `<div style="font-weight: 600; margin-bottom: 8px;">\u2713 ${title}</div>`;
        items.forEach((item) => {
          html += `<div style="display: flex; align-items: center; gap: 8px; padding: 4px 0;">
            <input type="checkbox" disabled style="width: 16px; height: 16px;">
            <span style="font-size: 14px;">${item.text}</span>
          </div>`;
        });
        html += `<div class="ig-message-time" style="display: flex; align-items: center; gap: 4px; justify-content: flex-end; margin-top: 8px;">
          <span style="font-size: 11px;">Just now</span>
          <span style="font-size: 10px;">\u2713\u2713</span>
        </div>`;
        messageEl.innerHTML = html;
        
        messagesContainer.appendChild(messageEl);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
        // Reload messages after delay to get full data
        setTimeout(() => {
          loadMessages(currentContactId);
        }, 500);
        
        InnovateAPI.showAlert('TODO list sent', 'success');
        closeTodoCreator();
      } catch (error) {
        InnovateAPI.showAlert('Failed to send TODO list', 'error');
      }
    }
    
    // Timer Message Functions
    let messageTimer = null;
    
    function openTimerPicker() {
      document.getElementById('timerModal').style.display = 'flex';
      toggleAttachMenu();
    }
    
    function closeTimerPicker() {
      document.getElementById('timerModal').style.display = 'none';
      messageTimer = null;
    }
    
    function setMessageTimer(seconds) {
      messageTimer = seconds;
      closeTimerPicker();
      const input = document.getElementById('messageInput');
      input.placeholder = `Message will disappear in ${formatTimerDuration(seconds)}...`;
      input.dataset.timer = seconds;
      input.focus();
      
      InnovateAPI.showAlert(`Timer set: ${formatTimerDuration(seconds)}`, 'success');
    }
    
    function formatTimerDuration(seconds) {
      if (seconds < 60) return `${seconds}s`;
      if (seconds < 3600) return `${Math.floor(seconds/60)}m`;
      if (seconds < 86400) return `${Math.floor(seconds/3600)}h`;
      return `${Math.floor(seconds/86400)}d`;
    }
    
    // Map Location Picker Functions
    let selectedLocation = null;
    
    function openMapPicker() {
      document.getElementById('mapModal').style.display = 'flex';
      selectedLocation = null;
      document.getElementById('mapCoords').textContent = 'Click on map to select location';
      toggleAttachMenu();
    }
    
    function closeMapPicker() {
      document.getElementById('mapModal').style.display = 'none';
      selectedLocation = null;
    }
    
    function selectPointOnMap(event) {
      const container = event.currentTarget;
      const rect = container.getBoundingClientRect();
      const x = event.clientX - rect.left;
      const y = event.clientY - rect.top;
      
      // Convert click position to approximate lat/lng (simplified)
      const lat = 40.7128 + (150 - y) / 10; // Example center: NYC
      const lng = -74.0060 + (x - 250) / 10;
      
      selectedLocation = { lat, lng };
      
      // Move pin to clicked position
      const pin = document.getElementById('mapPin');
      pin.style.left = x + 'px';
      pin.style.top = y + 'px';
      
      document.getElementById('mapCoords').textContent = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
    }
    
    function useCurrentLocation() {
      if (!navigator.geolocation) {
        InnovateAPI.showAlert('Geolocation not supported', 'error');
        return;
      }
      
      navigator.geolocation.getCurrentPosition(
        (position) => {
          selectedLocation = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          };
          document.getElementById('mapCoords').textContent = 
            `${selectedLocation.lat.toFixed(4)}, ${selectedLocation.lng.toFixed(4)}`;
          InnovateAPI.showAlert('Current location selected', 'success');
        },
        (error) => {
          InnovateAPI.showAlert('Failed to get location', 'error');
        }
      );
    }
    
    async function sendSelectedLocation() {
      if (!selectedLocation) {
        InnovateAPI.showAlert('Please select a location', 'error');
        return;
      }
      
      try {
        await InnovateAPI.apiRequest('/messages/send', {
          method: 'POST',
          body: JSON.stringify({
            receiver_id: currentContactId,
            content: JSON.stringify(selectedLocation),
            type: 'location'
          })
        });
        
        loadMessages(currentContactId);
        InnovateAPI.showAlert('Location shared', 'success');
        closeMapPicker();
      } catch (error) {
        InnovateAPI.showAlert('Failed to share location', 'error');
      }
    }
    
    // Handle Enter key
    function handleMessageKeyPress(event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
      }
    }
    
    // Update send button visibility based on input
    const messageInput = document.getElementById('messageInput');
    if (messageInput) {
      messageInput.addEventListener('input', (e) => {
        const hasText = e.target.value.trim();
        const sendBtn = document.getElementById('sendBtn');
        const voiceBtn = document.getElementById('voiceBtn');
        const moreBtn = document.getElementById('moreBtn');
        
        if (hasText) {
          if (sendBtn) sendBtn.style.display = 'inline-flex';
          if (voiceBtn) voiceBtn.style.display = 'none';
          if (moreBtn) moreBtn.style.display = 'none';
        } else {
          if (sendBtn) sendBtn.style.display = 'none';
          if (voiceBtn) voiceBtn.style.display = 'inline-flex';
          if (moreBtn) moreBtn.style.display = 'inline-flex';
        }
      });
    }

    // Check for user parameter (deep link from home)
    const urlParams = new URLSearchParams(window.location.search);
    const userId = urlParams.get('user');
    
    // Switch Messages/Requests tab
    function switchMessagesTab(tab) {
      document.getElementById('messagesTab').classList.toggle('active', tab === 'messages');
      document.getElementById('requestsTab').classList.toggle('active', tab === 'requests');
      
      if (tab === 'requests') {
        document.getElementById('conversationsList').innerHTML = `
          <div style=\"text-align: center; padding: 60px 20px; color: var(--ig-secondary-text);\">
            <div style=\"font-size: 48px; margin-bottom: 16px;\">üì¨</div>
            <div style=\"font-size: 16px;\">No message requests</div>
          </div>
        `;
      } else {
        loadConversations();
      }
    }
    
    // Open camera for specific user
    function openCameraForUser(userId) {
      currentContactId = userId;
      openCamera();
    }
    
    // Download file function
    function downloadFile(url, filename) {
      const link = document.createElement('a');
      link.href = url;
      link.download = filename || url.split('/').pop();
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
    
    // Open media preview modal
    function openMediaPreview(url, type, filename) {
      const modal = document.createElement('div');
      modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.95); z-index: 999999; display: flex; align-items: center; justify-content: center; flex-direction: column;';
      
      const displayFilename = filename || url.split('/').pop();
      let content = '';
      if (type === 'image' || type === 'gif') {
        content = `<img src="${url}" style="max-width: 90vw; max-height: 80vh; object-fit: contain; border-radius: 8px;">`;
      } else if (type === 'file') {
        const isPdf = url.match(/\.pdf$/i) || (filename && filename.match(/\.pdf$/i));
        const isTxt = url.match(/\.txt$/i) || (filename && filename.match(/\.txt$/i));
        const isDoc = url.match(/\.(doc|docx)$/i) || (filename && filename.match(/\.(doc|docx)$/i));
        
        if (isPdf) {
          // PDF preview with embedded viewer and loading state
          content = `<div style="width: 90vw; height: 85vh; position: relative;">
            <div id="pdfLoader" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; text-align: center;">
              <div class="ig-spinner" style="border-color: rgba(255,255,255,0.3); border-top-color: white; margin: 0 auto 16px;"></div>
              <div>Loading PDF...</div>
            </div>
            <iframe src="${url}#toolbar=1&navpanes=0&scrollbar=1" style="width: 100%; height: 100%; border: none; border-radius: 8px; background: white;" onload="document.getElementById('pdfLoader')?.remove()"></iframe>
          </div>`;
        } else if (isTxt) {
          // Text file preview - fetch and display content with loading
          content = `<div id="textPreviewContainer" style="width: 90vw; height: 85vh; background: white; border-radius: 8px; overflow: auto; padding: 20px; position: relative;">
            <div id="textLoader" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #666; text-align: center;">
              <div class="ig-spinner" style="margin: 0 auto 16px;"></div>
              <div>Loading text file...</div>
            </div>
          </div>`;
          // Fetch text content with timeout
          const fetchTimeout = setTimeout(() => {
            const container = document.getElementById('textPreviewContainer');
            if (container) {
              container.innerHTML = `<div style="text-align: center; padding: 40px; color: #666;">
                <div style="font-size: 48px; margin-bottom: 16px;">‚è±Ô∏è</div>
                <div style="font-size: 16px; margin-bottom: 12px;">Loading taking too long</div>
                <button onclick="downloadFile('${url}', '${displayFilename}')" style="padding: 10px 20px; background: var(--ig-blue); color: white; border: none; border-radius: 8px; cursor: pointer;">Download Instead</button>
              </div>`;
            }
          }, 5000); // 5 second timeout

          fetch(url)
            .then(response => {
              if (!response.ok) throw new Error('Failed to load');
              return response.text();
            })
            .then(text => {
              clearTimeout(fetchTimeout);
              const container = document.getElementById('textPreviewContainer');
              if (container) {
                // Limit text size for performance
                const displayText = text.length > 100000 ? text.substring(0, 100000) + '\\n\\n... (File too large, showing first 100KB)' : text;
                container.innerHTML = `<pre style="white-space: pre-wrap; word-wrap: break-word; font-family: 'Courier New', monospace; font-size: 14px; line-height: 1.5; color: #333; margin: 0;">${displayText.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</pre>`;
              }
            })
            .catch(() => {
              clearTimeout(fetchTimeout);
              const container = document.getElementById('textPreviewContainer');
              if (container) {
                container.innerHTML = `<div style="text-align: center; padding: 40px; color: #666;">
                  <div style="font-size: 48px; margin-bottom: 16px;">‚ùå</div>
                  <div style="font-size: 16px; margin-bottom: 12px;">Failed to load text file</div>
                  <button onclick="downloadFile('${url}', '${displayFilename}')" style="padding: 10px 20px; background: var(--ig-blue); color: white; border: none; border-radius: 8px; cursor: pointer;">Download File</button>
                </div>`;
              }
            });
        } else if (isDoc) {
          // DOC/DOCX - direct download with preview message
          content = `<div style="text-align: center; color: white; padding: 40px; max-width: 600px;">
            <div style="font-size: 64px; margin-bottom: 20px;">üìù</div>
            <div style="font-size: 20px; font-weight: 600; margin-bottom: 12px;">${displayFilename}</div>
            <div style="font-size: 16px; margin-bottom: 8px; color: rgba(255,255,255,0.9);">Word Document</div>
            <div style="font-size: 14px; margin-bottom: 30px; color: rgba(255,255,255,0.7); line-height: 1.6;">Preview not available for Word documents in this environment. Download the file to view it in Microsoft Word or compatible viewer.</div>
            <button onclick="downloadFile('${url}', '${displayFilename}')" style="padding: 14px 32px; background: var(--ig-blue); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600; box-shadow: 0 4px 12px rgba(0,149,246,0.3);">
              <svg fill="currentColor" height="20" viewBox="0 0 24 24" width="20" style="vertical-align: middle; margin-right: 8px;">
                <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"></path>
              </svg>
              Download File
            </button>
            <div style="font-size: 12px; margin-top: 16px; color: rgba(255,255,255,0.5);">
              Supported viewers: Microsoft Word, Google Docs, LibreOffice
            </div>
          </div>`;
        } else {
          content = `<div style="text-align: center; color: white; padding: 40px;">
            <div style="font-size: 64px; margin-bottom: 20px;">üìÑ</div>
            <div style="font-size: 20px; font-weight: 600; margin-bottom: 12px;">${displayFilename}</div>
            <div style="font-size: 18px; margin-bottom: 30px; color: rgba(255,255,255,0.7);">Preview not available</div>
            <button onclick="downloadFile('${url}', '${displayFilename}')" style="padding: 14px 28px; background: var(--ig-blue); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600;">Download File</button>
          </div>`;
        }
      }
      
      modal.innerHTML = `
        <div style="position: absolute; top: 20px; right: 20px; display: flex; gap: 12px;">
          <button onclick="downloadFile('${url}', '${displayFilename}')" style="background: rgba(255,255,255,0.2); border: none; color: white; border-radius: 50%; width: 48px; height: 48px; cursor: pointer; display: flex; align-items: center; justify-content: center;" title="Download">
            <svg fill="currentColor" height="24" viewBox="0 0 24 24" width="24">
              <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"></path>
            </svg>
          </button>
          <button onclick="this.closest('[style*=fixed]').remove()" style="background: rgba(255,255,255,0.2); border: none; color: white; border-radius: 50%; width: 48px; height: 48px; cursor: pointer; font-size: 32px; display: flex; align-items: center; justify-content: center;">&times;</button>
        </div>
        ${content}
      `;
      
      modal.onclick = (e) => {
        if (e.target === modal) {
          modal.remove();
        }
      };
      
      document.body.appendChild(modal);
    }
    
    // Initialize - Wrap in DOMContentLoaded to ensure DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Messages page initializing...');
      
      // Initialize Socket.IO first
      const socket = InnovateAPI.getSocket();
      if (!socket) {
        console.error('Socket.IO not initialized!');
        InnovateAPI.initSocket();
      }
      
      // Setup socket event listeners
      setupSocketListeners();
      
      // Load user info and conversations
      loadUserInfo()
        .then(() => {
          console.log('User info loaded');
          return loadConversations();
        })
        .then(() => {
          console.log('Conversations loaded:', conversations.length);
          if (userId) {
            // Find conversation with this user and open it
            const conv = conversations.find(c => c.contact_id == userId);
            if (conv) {
              console.log('Opening chat with user:', userId);
              openChat(conv.contact_id, conv.username, conv.profile_picture);
            }
          }
        })
        .catch(error => {
          console.error('Initialization error:', error);
          InnovateAPI.showAlert('Failed to load messages', 'error');
        });
    });

    // Voice and Video Calling with WebRTC
    let localStream = null;
    let remoteStream = null;
    let peerConnection = null;
    let isCallActive = false;
    let isVideoCall = false;
    let isMuted = false;
    let isVideoEnabled = true;
    let callStartTime = null;
    let callDurationInterval = null;
    let currentCallContactId = null;

    const configuration = {
      iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' }
      ]
    };

    // Start voice call
    async function startVoiceCall() {
      if (!currentContactId) {
        InnovateAPI.showAlert('Please select a conversation first', 'error');
        return;
      }
      isVideoCall = false;
      await initiateCall(false);
    }

    // Start video call
    async function startVideoCall() {
      if (!currentContactId) {
        InnovateAPI.showAlert('Please select a conversation first', 'error');
        return;
      }
      isVideoCall = true;
      await initiateCall(true);
    }

    // Initiate call
    async function initiateCall(video) {
      try {
        // Get user media
        localStream = await navigator.mediaDevices.getUserMedia({
          audio: true,
          video: video
        });

        // Set up call
        currentCallContactId = currentContactId;
        setupCallUI(video);
        
        // Create peer connection
        peerConnection = new RTCPeerConnection(configuration);
        
        // Add local stream to peer connection
        localStream.getTracks().forEach(track => {
          peerConnection.addTrack(track, localStream);
        });

        // Handle ICE candidates
        peerConnection.onicecandidate = (event) => {
          if (event.candidate) {
            InnovateAPI.getSocket().emit('call:ice-candidate', {
              to: currentCallContactId,
              candidate: event.candidate
            });
          }
        };

        // Handle remote stream
        peerConnection.ontrack = (event) => {
          if (!remoteStream) {
            remoteStream = new MediaStream();
            document.getElementById('remoteVideo').srcObject = remoteStream;
          }
          remoteStream.addTrack(event.track);
        };

        // Create and send offer
        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);

        // Get contact info for call
        const contactData = conversations.find(c => c.contact_id === currentCallContactId);
        
        console.log('Initiating call to user:', currentCallContactId);
        console.log('Caller info:', { id: user.id, username: user.username });
        
        InnovateAPI.getSocket().emit('call:initiate', {
          to: currentCallContactId,
          from: user.id,
          offer: offer,
          isVideo: video,
          caller: {
            username: user.username,
            profile_picture: user.profile_picture
          }
        });

        showActiveCall(contactData?.username || 'User', contactData?.profile_picture);
        
      } catch (error) {
        console.error('Error starting call:', error);
        InnovateAPI.showAlert('Failed to access camera/microphone', 'error');
      }
    }

    // Setup call UI
    function setupCallUI(video) {
      const localVideo = document.getElementById('localVideo');
      const remoteVideo = document.getElementById('remoteVideo');
      
      if (localStream) {
        localVideo.srcObject = localStream;
        localVideo.style.display = video ? 'block' : 'none';
      }
      
      remoteVideo.style.display = video ? 'block' : 'none';
      
      // Show/hide video button based on call type
      document.getElementById('videoBtn').style.display = video ? 'flex' : 'none';
    }

    // Show active call UI
    function showActiveCall(name, avatar) {
      document.getElementById('activeCallModal').style.display = 'flex';
      document.getElementById('activeCallName').textContent = name;
      document.getElementById('activeCallAvatar').src = InnovateAPI.getUserAvatar(avatar);
      
      isCallActive = true;
      callStartTime = Date.now();
      
      // Start duration counter
      callDurationInterval = setInterval(updateCallDuration, 1000);
    }

    // Update call duration
    function updateCallDuration() {
      if (!callStartTime) return;
      
      const elapsed = Math.floor((Date.now() - callStartTime) / 1000);
      const minutes = Math.floor(elapsed / 60);
      const seconds = elapsed % 60;
      
      document.getElementById('callDuration').textContent = 
        `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    }

    // Show incoming call
    function showIncomingCall(data) {
      console.log('Incoming call received:', data);
      document.getElementById('incomingCallModal').style.display = 'flex';
      document.getElementById('incomingCallName').textContent = data.caller.username;
      document.getElementById('incomingCallAvatar').src = InnovateAPI.getUserAvatar(data.caller.profile_picture);
      document.getElementById('incomingCallType').textContent = 
        data.isVideo ? 'Incoming video call...' : 'Incoming voice call...';
      
      // Store call data for accepting
      window.incomingCallData = data;
    }

    // Accept call
    async function acceptCall() {
      const data = window.incomingCallData;
      if (!data) return;

      try {
        isVideoCall = data.isVideo;
        currentCallContactId = data.from;
        
        // Get user media
        localStream = await navigator.mediaDevices.getUserMedia({
          audio: true,
          video: data.isVideo
        });

        // Hide incoming call modal
        document.getElementById('incomingCallModal').style.display = 'none';
        
        // Setup call UI
        setupCallUI(data.isVideo);
        showActiveCall(data.caller.username, data.caller.profile_picture);

        // Create peer connection
        peerConnection = new RTCPeerConnection(configuration);
        
        // Add local stream
        localStream.getTracks().forEach(track => {
          peerConnection.addTrack(track, localStream);
        });

        // Handle ICE candidates
        peerConnection.onicecandidate = (event) => {
          if (event.candidate) {
            InnovateAPI.getSocket().emit('call:ice-candidate', {
              to: currentCallContactId,
              candidate: event.candidate
            });
          }
        };

        // Handle remote stream
        peerConnection.ontrack = (event) => {
          if (!remoteStream) {
            remoteStream = new MediaStream();
            document.getElementById('remoteVideo').srcObject = remoteStream;
          }
          remoteStream.addTrack(event.track);
        };

        // Set remote description and create answer
        await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
        const answer = await peerConnection.createAnswer();
        await peerConnection.setLocalDescription(answer);

        // Send answer
        InnovateAPI.getSocket().emit('call:answer', {
          to: data.from,
          answer: answer
        });

      } catch (error) {
        console.error('Error accepting call:', error);
        InnovateAPI.showAlert('Failed to accept call', 'error');
        rejectCall();
      }
    }

    // Reject call
    function rejectCall() {
      const data = window.incomingCallData;
      if (data) {
        InnovateAPI.getSocket().emit('call:reject', {
          to: data.from
        });
      }
      
      document.getElementById('incomingCallModal').style.display = 'none';
      window.incomingCallData = null;
    }

    // End call
    function endCall() {
      // Send end call signal
      if (currentCallContactId) {
        InnovateAPI.getSocket().emit('call:end', {
          to: currentCallContactId
        });
      }

      // Clean up
      cleanupCall();
    }

    // Cleanup call resources
    function cleanupCall() {
      // Stop all tracks
      if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
        localStream = null;
      }

      if (remoteStream) {
        remoteStream.getTracks().forEach(track => track.stop());
        remoteStream = null;
      }

      // Close peer connection
      if (peerConnection) {
        peerConnection.close();
        peerConnection = null;
      }

      // Clear duration interval
      if (callDurationInterval) {
        clearInterval(callDurationInterval);
        callDurationInterval = null;
      }

      // Hide call UI
      document.getElementById('activeCallModal').style.display = 'none';
      document.getElementById('incomingCallModal').style.display = 'none';

      // Reset state
      isCallActive = false;
      currentCallContactId = null;
      callStartTime = null;
      isMuted = false;
      isVideoEnabled = true;
    }

    // Toggle mute
    function toggleMute() {
      if (!localStream) return;
      
      const audioTrack = localStream.getAudioTracks()[0];
      if (audioTrack) {
        audioTrack.enabled = !audioTrack.enabled;
        isMuted = !audioTrack.enabled;
        
        const muteBtn = document.getElementById('muteBtn');
        muteBtn.style.background = isMuted ? '#ed4956' : 'rgba(255,255,255,0.2)';
      }
    }

    // Toggle video
    function toggleVideo() {
      if (!localStream) return;
      
      const videoTrack = localStream.getVideoTracks()[0];
      if (videoTrack) {
        videoTrack.enabled = !videoTrack.enabled;
        isVideoEnabled = videoTrack.enabled;
        
        const videoBtn = document.getElementById('videoBtn');
        videoBtn.style.background = !isVideoEnabled ? '#ed4956' : 'rgba(255,255,255,0.2)';
        
        document.getElementById('localVideo').style.display = isVideoEnabled ? 'block' : 'none';
      }
    }

    // Toggle speaker (placeholder - browser handles audio output)
    function toggleSpeaker() {
      InnovateAPI.showAlert('Speaker toggle', 'info');
    }
  </script>
</body>
</html>

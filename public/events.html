<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Events - Innovate</title>
  <link rel="stylesheet" href="/css/instagram.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <!-- Top Navigation -->
  <nav class="ig-top-nav">
    <div class="ig-nav-container">
      <a href="/home" class="ig-logo">Innovate</a>
      
      <div class="ig-search-box">
        <input type="text" class="ig-search-input" placeholder="Search events..." id="search-input">
      </div>
      
      <div class="ig-nav-icons">
        <div class="ig-nav-icon" onclick="window.location.href='/home'">
          <svg aria-label="Home" fill="currentColor" height="24" viewBox="0 0 24 24" width="24">
            <path d="M9.005 16.545a2.997 2.997 0 0 1 2.997-2.997A2.997 2.997 0 0 1 15 16.545V22h7V11.543L12 2 2 11.543V22h7.005Z" fill="none" stroke="currentColor" stroke-linejoin="round" stroke-width="2"></path>
          </svg>
        </div>
        
        <div class="ig-nav-icon" onclick="openCreateEventModal()">
          <svg aria-label="New event" fill="currentColor" height="24" viewBox="0 0 24 24" width="24">
            <path d="M2 12v3.45c0 2.849.698 4.005 1.606 4.944.94.909 2.098 1.608 4.946 1.608h6.896c2.848 0 4.006-.7 4.946-1.608C21.302 19.455 22 18.3 22 15.45V8.552c0-2.849-.698-4.006-1.606-4.945C19.454 2.7 18.296 2 15.448 2H8.552c-2.848 0-4.006.699-4.946 1.607C2.698 4.547 2 5.703 2 8.552Z" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
            <line fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" x1="6.545" x2="17.455" y1="12.001" y2="12.001"></line>
            <line fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" x1="12.003" x2="12.003" y1="6.545" y2="17.455"></line>
          </svg>
        </div>
        
        <div class="ig-nav-icon" onclick="window.location.href='/notifications'">
          <svg aria-label="Notifications" fill="currentColor" height="24" viewBox="0 0 24 24" width="24">
            <path d="M16.792 3.904A4.989 4.989 0 0 1 21.5 9.122c0 3.072-2.652 4.959-5.197 7.222-2.512 2.243-3.865 3.469-4.303 3.752-.477-.309-2.143-1.823-4.303-3.752C5.141 14.072 2.5 12.167 2.5 9.122a4.989 4.989 0 0 1 4.708-5.218 4.21 4.21 0 0 1 3.675 1.941c.84 1.175.98 1.763 1.12 1.763s.278-.588 1.11-1.766a4.17 4.17 0 0 1 3.679-1.938m0-2a6.04 6.04 0 0 0-4.797 2.127 6.052 6.052 0 0 0-4.787-2.127A6.985 6.985 0 0 0 .5 9.122c0 3.61 2.55 5.827 5.015 7.97.283.246.569.494.853.747l1.027.918a44.998 44.998 0 0 0 3.518 3.018 2 2 0 0 0 2.174 0 45.263 45.263 0 0 0 3.626-3.115l.922-.824c.293-.26.59-.519.885-.774 2.334-2.025 4.98-4.32 4.98-7.94a6.985 6.985 0 0 0-6.708-7.218Z"></path>
          </svg>
        </div>
        
        <div class="ig-nav-icon" onclick="window.location.href='/profile'">
          <img id="navProfilePic" src="/images/default-avatar.png" alt="Profile" style="width: 24px; height: 24px; border-radius: 50%; object-fit: cover;">
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="ig-main">
    <!-- Tabs -->
    <div style="background: var(--ig-primary-background); border-bottom: 1px solid var(--ig-border); display: flex; gap: 24px; padding: 0 20px; margin-bottom: 24px;">
      <button class="event-tab active" onclick="switchTab('events')" style="padding: 12px 0; background: none; border: none; border-bottom: 2px solid var(--ig-primary-text); color: var(--ig-primary-text); font-weight: 600; cursor: pointer;">Events</button>
      <button class="event-tab" onclick="switchTab('crosspath')" style="padding: 12px 0; background: none; border: none; border-bottom: 2px solid transparent; color: var(--ig-secondary-text); font-weight: 600; cursor: pointer;">Crosspath</button>
      <button class="event-tab" onclick="switchTab('reminders')" style="padding: 12px 0; background: none; border: none; border-bottom: 2px solid transparent; color: var(--ig-secondary-text); font-weight: 600; cursor: pointer;">Reminders</button>
    </div>

    <!-- Events Tab -->
    <div id="events-tab" class="tab-content">
      <div id="events-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 24px;">
        <!-- Events will be loaded here -->
      </div>
    </div>

    <!-- Crosspath Tab -->
    <div id="crosspath-tab" class="tab-content" style="display: none;">
      <div id="crosspath-list" style="max-width: 600px; margin: 0 auto;">
        <!-- Crosspath requests will be loaded here -->
      </div>
    </div>

    <!-- Reminders Tab -->
    <div id="reminders-tab" class="tab-content" style="display: none;">
      <div id="reminders-list" style="max-width: 600px; margin: 0 auto;">
        <!-- Reminders will be loaded here -->
      </div>
    </div>
  </main>

  <!-- Create Event Modal -->
  <div id="create-event-modal" class="ig-modal-overlay" style="display: none;">
    <div class="ig-modal">
      <div class="ig-modal-item" style="padding: 20px; text-align: left;">
        <h3 style="margin: 0 0 20px 0; font-size: 18px; font-weight: 600;">Create Event</h3>
        
        <form id="create-event-form" onsubmit="createEvent(); return false;">
          <div style="margin-bottom: 16px;">
            <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 600;">Event Title</label>
            <input type="text" id="event-title" style="width: 100%; padding: 10px; border: 1px solid var(--ig-border); border-radius: 4px; background: var(--ig-secondary-background); color: var(--ig-primary-text);" required>
          </div>
          
          <div style="margin-bottom: 16px;">
            <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 600;">Date & Time</label>
            <input type="datetime-local" id="event-date" style="width: 100%; padding: 10px; border: 1px solid var(--ig-border); border-radius: 4px; background: var(--ig-secondary-background); color: var(--ig-primary-text);" required>
          </div>
          
          <div style="margin-bottom: 16px;">
            <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 600;">Location</label>
            <input type="text" id="event-location" style="width: 100%; padding: 10px; border: 1px solid var(--ig-border); border-radius: 4px; background: var(--ig-secondary-background); color: var(--ig-primary-text);">
          </div>
          
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 600;">Description</label>
            <textarea id="event-description" rows="3" style="width: 100%; padding: 10px; border: 1px solid var(--ig-border); border-radius: 4px; background: var(--ig-secondary-background); color: var(--ig-primary-text);"></textarea>
          </div>
          
          <div style="display: flex; gap: 10px;">
            <button type="button" onclick="closeCreateEventModal()" style="flex: 1; padding: 12px; border: 1px solid var(--ig-border); border-radius: 4px; background: transparent; color: var(--ig-primary-text); cursor: pointer;">Cancel</button>
            <button type="submit" style="flex: 1; padding: 12px; border: none; border-radius: 4px; background: var(--ig-blue); color: white; font-weight: 600; cursor: pointer;">Create</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Bottom Navigation -->
  <nav class="ig-bottom-nav">
    <a href="/home" class="ig-bottom-nav-item">
      <svg aria-label="Home" viewBox="0 0 24 24" width="24">
        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
        <polyline points="9 22 9 12 15 12 15 22" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <span class="ig-bottom-nav-label">Home</span>
    </a>
    <a href="/communities" class="ig-bottom-nav-item">
      <svg aria-label="Communities" viewBox="0 0 24 24" width="24">
        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
        <circle cx="9" cy="7" r="4" stroke="currentColor" stroke-width="2" fill="none"/>
        <path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <span class="ig-bottom-nav-label">Communities</span>
    </a>
    <a href="/events" class="ig-bottom-nav-item active">
      <svg aria-label="Events" viewBox="0 0 24 24" width="24">
        <rect x="3" y="4" width="18" height="18" rx="2" ry="2" stroke="currentColor" stroke-width="2" fill="none"/>
        <line x1="16" y1="2" x2="16" y2="6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <line x1="8" y1="2" x2="8" y2="6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <line x1="3" y1="10" x2="21" y2="10" stroke="currentColor" stroke-width="2"/>
      </svg>
      <span class="ig-bottom-nav-label">Events</span>
    </a>
    <button class="ig-bottom-nav-item" onclick="openCreateEventModal()" style="background: none; border: none; cursor: pointer;">
      <svg aria-label="Create" viewBox="0 0 24 24" width="24">
        <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"/>
      </svg>
      <span class="ig-bottom-nav-label">Create</span>
    </button>
    <a href="/social-service" class="ig-bottom-nav-item">
      <svg aria-label="Social Service" viewBox="0 0 24 24" width="24">
        <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <span class="ig-bottom-nav-label">Service</span>
    </a>
    <a href="/search" class="ig-bottom-nav-item">
      <svg aria-label="Search" viewBox="0 0 24 24" width="24">
        <circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2" fill="none"/>
        <line x1="21" y1="21" x2="16.65" y2="16.65" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
      <span class="ig-bottom-nav-label">Search</span>
    </a>
    <a href="#" class="ig-bottom-nav-item" id="profileNavLink" onclick="navigateToProfile(event)">
      <svg aria-label="Profile" viewBox="0 0 24 24" width="24">
        <circle cx="12" cy="7" r="4" stroke="currentColor" stroke-width="2" fill="none"/>
        <path d="M5.5 21v-2a7.5 7.5 0 0 1 13 0v2" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/>
      </svg>
      <span class="ig-bottom-nav-label">Profile</span>
    </a>
  </nav>

  <script>
    function navigateToProfile(e) {
      e.preventDefault();
      const user = InnovateAPI.getCurrentUser();
      if (user && user.id) {
        window.location.href = `/profile/${user.id}`;
      }
    }
  </script>
      </svg>
    </a>
  </nav>

  <script src="/socket.io/socket.io.js"></script>
  <script src="/js/instagram-theme.js"></script>
  <script>
    const socket = io();

    if (!localStorage.getItem('token')) {
      window.location.href = '/login';
    }

    let currentTab = 'events';

    function switchTab(tab) {
      currentTab = tab;
      
      // Update tab buttons
      document.querySelectorAll('.event-tab').forEach(btn => {
        btn.classList.remove('active');
        btn.style.borderBottomColor = 'transparent';
        btn.style.color = 'var(--ig-secondary-text)';
      });
      event.target.classList.add('active');
      event.target.style.borderBottomColor = 'var(--ig-primary-text)';
      event.target.style.color = 'var(--ig-primary-text)';

      // Update tab content
      document.querySelectorAll('.tab-content').forEach(content => {
        content.style.display = 'none';
      });
      document.getElementById(`${tab}-tab`).style.display = 'block';

      // Load data for tab
      if (tab === 'events') loadEvents();
      else if (tab === 'crosspath') loadCrosspathRequests();
      else if (tab === 'reminders') loadReminders();
    }

    async function loadEvents() {
      try {
        const response = await fetch('/api/events', {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          }
        });

        if (!response.ok) throw new Error('Failed to load events');
        
        const data = await response.json();
        displayEvents(data.events || []);
      } catch (error) {
        console.error('Error loading events:', error);
      }
    }

    function displayEvents(events) {
      const grid = document.getElementById('events-grid');
      grid.innerHTML = '';

      if (events.length === 0) {
        grid.innerHTML = `
          <div style="grid-column: 1/-1; text-align: center; padding: 60px 20px;">
            <div style="font-size: 48px; margin-bottom: 16px;">üìÖ</div>
            <p style="color: var(--ig-secondary-text); margin-bottom: 24px;">No events yet</p>
            <button class="ig-action-btn" onclick="openCreateEventModal()" style="padding: 10px 24px; background: var(--ig-blue); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">Create First Event</button>
          </div>
        `;
        return;
      }

      events.forEach(event => {
        const card = document.createElement('div');
        card.className = 'ig-post';
        card.innerHTML = `
          <div style="padding: 20px;">
            <div style="display: flex; align-items: flex-start; gap: 12px; margin-bottom: 16px;">
              <div style="width: 56px; height: 56px; background: linear-gradient(135deg, var(--ig-blue), #833AB4); border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; flex-shrink: 0;">
                <div style="font-size: 20px; font-weight: 700;">${new Date(event.event_date).getDate()}</div>
                <div style="font-size: 11px; text-transform: uppercase;">${new Date(event.event_date).toLocaleString('default', { month: 'short' })}</div>
              </div>
              <div style="flex: 1; min-width: 0;">
                <h3 style="margin: 0 0 4px 0; font-size: 16px; font-weight: 600;">${event.title}</h3>
                <div style="font-size: 14px; color: var(--ig-secondary-text); margin-bottom: 4px;">
                  <i class="fas fa-clock"></i> ${new Date(event.event_date).toLocaleString()}
                </div>
                ${event.location ? `<div style="font-size: 14px; color: var(--ig-secondary-text);"><i class="fas fa-map-marker-alt"></i> ${event.location}</div>` : ''}
              </div>
            </div>
            ${event.description ? `<p style="color: var(--ig-secondary-text); font-size: 14px; margin: 0 0 16px 0;">${event.description}</p>` : ''}
            <div style="display: flex; gap: 16px; font-size: 14px; color: var(--ig-secondary-text); margin-bottom: 16px;">
              <span><i class="fas fa-users"></i> ${event.attendee_count || 0} attending</span>
              <span><i class="fas fa-user"></i> ${event.creator_username}</span>
            </div>
            <button class="ig-action-btn ${event.user_status === 'attending' ? 'attending' : ''}" onclick="toggleAttendance(${event.id}, this)" style="width: 100%; padding: 10px; background: ${event.user_status === 'attending' ? 'transparent' : 'var(--ig-blue)'}; color: ${event.user_status === 'attending' ? 'var(--ig-primary-text)' : 'white'}; border: ${event.user_status === 'attending' ? '1px solid var(--ig-border)' : 'none'}; border-radius: 8px; font-weight: 600; cursor: pointer;">
              ${event.user_status === 'attending' ? 'Attending' : 'RSVP'}
            </button>
          </div>
        `;
        grid.appendChild(card);
      });
    }

    async function toggleAttendance(eventId, button) {
      const isAttending = button.classList.contains('attending');

      try {
        const response = await fetch(`/api/events/${eventId}/rsvp`, {
          method: isAttending ? 'DELETE' : 'POST',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          }
        });

        if (!response.ok) throw new Error('Failed to update RSVP');
        
        button.classList.toggle('attending');
        button.textContent = isAttending ? 'RSVP' : 'Attending';
        button.style.background = isAttending ? 'var(--ig-blue)' : 'transparent';
        button.style.color = isAttending ? 'white' : 'var(--ig-primary-text)';
        button.style.border = isAttending ? 'none' : '1px solid var(--ig-border)';
      } catch (error) {
        console.error('Error updating RSVP:', error);
      }
    }

    async function loadCrosspathRequests() {
      try {
        const response = await fetch('/api/events/crosspath/pending', {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          }
        });

        if (!response.ok) throw new Error('Failed to load crosspath requests');
        
        const data = await response.json();
        displayCrosspathRequests(data.requests || []);
      } catch (error) {
        console.error('Error loading crosspath:', error);
      }
    }

    function displayCrosspathRequests(requests) {
      const list = document.getElementById('crosspath-list');
      list.innerHTML = '';

      if (requests.length === 0) {
        list.innerHTML = `
          <div style="text-align: center; padding: 60px 20px;">
            <div style="font-size: 48px; margin-bottom: 16px;">ü§ù</div>
            <p style="color: var(--ig-secondary-text);">No crosspath requests</p>
          </div>
        `;
        return;
      }

      requests.forEach(request => {
        const card = document.createElement('div');
        card.className = 'ig-post';
        card.style.marginBottom = '16px';
        card.innerHTML = `
          <div style="padding: 20px;">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
              <img src="${request.user_profile_picture || '/images/default-avatar.png'}" style="width: 48px; height: 48px; border-radius: 50%; object-fit: cover;">
              <div>
                <div style="font-weight: 600;">${request.user_username}</div>
                <div style="font-size: 14px; color: var(--ig-secondary-text);">${request.event_title}</div>
              </div>
            </div>
            <div style="display: flex; gap: 10px;">
              <button onclick="respondToCrosspath(${request.id}, 'accept')" style="flex: 1; padding: 10px; background: var(--ig-blue); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">Accept</button>
              <button onclick="respondToCrosspath(${request.id}, 'reject')" style="flex: 1; padding: 10px; background: transparent; color: var(--ig-primary-text); border: 1px solid var(--ig-border); border-radius: 8px; font-weight: 600; cursor: pointer;">Decline</button>
            </div>
          </div>
        `;
        list.appendChild(card);
      });
    }

    async function respondToCrosspath(requestId, action) {
      try {
        const response = await fetch(`/api/events/crosspath/${requestId}/${action}`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          }
        });

        if (!response.ok) throw new Error('Failed to respond to crosspath');
        
        loadCrosspathRequests();
      } catch (error) {
        console.error('Error responding to crosspath:', error);
      }
    }

    async function loadReminders() {
      try {
        const response = await fetch('/api/posts/reminders', {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          }
        });

        if (!response.ok) throw new Error('Failed to load reminders');
        
        const data = await response.json();
        displayReminders(data.reminders || []);
      } catch (error) {
        console.error('Error loading reminders:', error);
      }
    }

    function displayReminders(reminders) {
      const list = document.getElementById('reminders-list');
      list.innerHTML = '';

      if (reminders.length === 0) {
        list.innerHTML = `
          <div style="text-align: center; padding: 60px 20px;">
            <div style="font-size: 48px; margin-bottom: 16px;">‚è∞</div>
            <p style="color: var(--ig-secondary-text);">No reminders set</p>
          </div>
        `;
        return;
      }

      reminders.forEach(reminder => {
        const card = document.createElement('div');
        card.className = 'ig-post';
        card.style.marginBottom = '16px';
        card.innerHTML = `
          <div style="padding: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
              <div>
                <div style="font-weight: 600; margin-bottom: 4px;">${reminder.message || 'Reminder'}</div>
                <div style="font-size: 14px; color: var(--ig-secondary-text);">
                  <i class="fas fa-clock"></i> ${new Date(reminder.reminder_date).toLocaleString()}
                </div>
              </div>
              <button onclick="deleteReminder(${reminder.id})" style="background: none; border: none; color: var(--ig-secondary-text); cursor: pointer; padding: 4px;">
                <i class="fas fa-times"></i>
              </button>
            </div>
            <a href="/post/${reminder.post_id}" style="display: block; padding: 12px; background: var(--ig-secondary-background); border-radius: 8px; color: var(--ig-primary-text); text-decoration: none;">
              View Post <i class="fas fa-arrow-right"></i>
            </a>
          </div>
        `;
        list.appendChild(card);
      });
    }

    async function deleteReminder(reminderId) {
      try {
        const response = await fetch(`/api/posts/reminders/${reminderId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          }
        });

        if (!response.ok) throw new Error('Failed to delete reminder');
        
        loadReminders();
      } catch (error) {
        console.error('Error deleting reminder:', error);
      }
    }

    function openCreateEventModal() {
      document.getElementById('create-event-modal').style.display = 'flex';
    }

    function closeCreateEventModal() {
      document.getElementById('create-event-modal').style.display = 'none';
      document.getElementById('create-event-form').reset();
    }

    async function createEvent() {
      event.preventDefault();
      
      const title = document.getElementById('event-title').value;
      const eventDate = document.getElementById('event-date').value;
      const location = document.getElementById('event-location').value;
      const description = document.getElementById('event-description').value;

      try {
        const response = await fetch('/api/events', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          },
          body: JSON.stringify({
            title,
            event_date: eventDate,
            location,
            description
          })
        });

        if (!response.ok) {
          const error = await response.json();
          alert(error.error || 'Failed to create event');
          return;
        }
        
        closeCreateEventModal();
        loadEvents();
        alert('Event created successfully!');
      } catch (error) {
        console.error('Error creating event:', error);
        alert('Failed to create event');
      }
    }

    // Initialize
    loadEvents();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Community - Innovate</title>
  <link rel="stylesheet" href="/css/instagram.css">
  <link rel="stylesheet" href="/css/workspace.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="/js/instagram-theme.js"></script>
  <style>
    /* WhatsApp Community Complete Styles */
    body { margin: 0; padding: 0; overflow: hidden; }
    
    .community-shell {
      display: grid;
      grid-template-columns: 380px 1fr 360px;
      height: 100vh;
      background: var(--ig-primary-background);
    }

    /* LEFT SIDEBAR - Groups & Announcements */
    .community-left {
      border-right: 1px solid var(--ig-border);
      background: var(--ig-primary-background);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .left-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--ig-border);
      background: var(--ig-secondary-background);
    }

    .community-title {
      font-size: 18px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 4px;
    }

    .community-subtitle {
      font-size: 13px;
      color: var(--ig-secondary-text);
    }

    .left-tabs {
      display: flex;
      border-bottom: 1px solid var(--ig-border);
    }

    .left-tab {
      flex: 1;
      padding: 12px;
      text-align: center;
      font-size: 14px;
      font-weight: 600;
      color: var(--ig-secondary-text);
      border-bottom: 2px solid transparent;
      cursor: pointer;
      background: none;
      border: none;
      transition: all 0.2s;
    }

    .left-tab.active {
      color: var(--ig-blue);
      border-bottom-color: var(--ig-blue);
    }

    .left-content {
      flex: 1;
      overflow-y: auto;
    }

    .group-item {
      padding: 12px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      border-bottom: 1px solid var(--ig-border);
      transition: background 0.2s;
    }

    .group-item:hover, .group-item.active {
      background: var(--ig-hover);
    }

    .group-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--ig-blue), #5B86E5);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 18px;
      flex-shrink: 0;
    }

    .group-info {
      flex: 1;
      min-width: 0;
    }

    .group-name {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .group-desc {
      font-size: 13px;
      color: var(--ig-secondary-text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .left-footer {
      padding: 16px;
      border-top: 1px solid var(--ig-border);
    }

    /* CENTER - Main Content */
    .community-center {
      display: flex;
      flex-direction: column;
      background: var(--ig-secondary-background);
      overflow: hidden;
    }

    .center-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--ig-border);
      background: var(--ig-primary-background);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .header-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--ig-blue);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
    }

    .header-title {
      font-size: 16px;
      font-weight: 600;
      margin: 0;
    }

    .header-subtitle {
      font-size: 13px;
      color: var(--ig-secondary-text);
      margin: 2px 0 0 0;
    }

    .center-tabs {
      display: flex;
      gap: 8px;
      padding: 12px 20px;
      border-bottom: 1px solid var(--ig-border);
      background: var(--ig-primary-background);
      overflow-x: auto;
    }

    .center-tab {
      padding: 8px 16px;
      border-radius: 20px;
      background: var(--ig-secondary-background);
      border: 1px solid var(--ig-border);
      color: var(--ig-secondary-text);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.2s;
    }

    .center-tab.active {
      background: var(--ig-blue);
      color: white;
      border-color: var(--ig-blue);
    }

    .center-content {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }

    .center-footer {
      padding: 12px 16px;
      border-top: 1px solid var(--ig-border);
      background: var(--ig-primary-background);
    }

    /* RIGHT SIDEBAR - Info & Settings */
    .community-right {
      border-left: 1px solid var(--ig-border);
      background: var(--ig-primary-background);
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }

    .right-header {
      padding: 24px 20px;
      text-align: center;
      border-bottom: 1px solid var(--ig-border);
    }

    .right-avatar {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--ig-blue), #5B86E5);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 48px;
      margin: 0 auto 16px;
    }

    .right-name {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .right-meta {
      font-size: 13px;
      color: var(--ig-secondary-text);
    }

    .right-actions {
      display: flex;
      justify-content: space-around;
      padding: 16px;
      border-bottom: 1px solid var(--ig-border);
    }

    .right-action {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      transition: opacity 0.2s;
    }

    .right-action:hover { opacity: 0.7; }

    .action-circle {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: var(--ig-blue);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
    }

    .action-label {
      font-size: 12px;
      color: var(--ig-secondary-text);
    }

    .right-section {
      padding: 20px;
      border-bottom: 1px solid var(--ig-border);
    }

    .section-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--ig-secondary-text);
      margin-bottom: 12px;
      letter-spacing: 0.5px;
    }

    .menu-item {
      padding: 14px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--ig-border);
      cursor: pointer;
      transition: background 0.2s;
    }

    .menu-item:hover {
      background: var(--ig-hover);
    }

    .menu-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .menu-icon {
      width: 24px;
      text-align: center;
      color: var(--ig-secondary-text);
    }

    /* Content Cards */
    .announcement-card {
      background: var(--ig-primary-background);
      border: 1px solid var(--ig-border);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
    }

    .card-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .card-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--ig-blue);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
    }

    .card-info {
      flex: 1;
    }

    .card-author {
      font-size: 14px;
      font-weight: 600;
    }

    .card-date {
      font-size: 12px;
      color: var(--ig-secondary-text);
    }

    .card-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .card-body {
      font-size: 14px;
      line-height: 1.6;
    }

    /* Call Interface */
    .call-view {
      display: flex;
      flex-direction: column;
      height: 100%;
      background: #1a1a1a;
    }

    .video-grid {
      flex: 1;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 8px;
      padding: 16px;
      overflow-y: auto;
    }

    .video-tile {
      background: #2a2a2a;
      border-radius: 12px;
      position: relative;
      aspect-ratio: 16/9;
      overflow: hidden;
    }

    .video-tile video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .video-name {
      position: absolute;
      bottom: 12px;
      left: 12px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
    }

    .call-controls {
      padding: 20px;
      background: #1a1a1a;
      display: flex;
      justify-content: center;
      gap: 16px;
    }

    .call-btn {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      color: white;
      font-size: 20px;
    }

    .call-btn.mute { background: #4a4a4a; }
    .call-btn.end { background: #e74c3c; }
    .call-btn.video { background: #4a4a4a; }
    .call-btn.screen { background: #4a4a4a; }

    .call-btn:hover {
      transform: scale(1.1);
    }

    /* Folder UI */
    .folder-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 12px;
    }

    .folder-item {
      padding: 16px;
      border: 1px solid var(--ig-border);
      border-radius: 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .folder-item:hover {
      background: var(--ig-hover);
      transform: translateY(-2px);
    }

    .folder-icon {
      font-size: 48px;
      margin-bottom: 8px;
    }

    .folder-name {
      font-size: 14px;
      font-weight: 500;
    }

    .folder-count {
      font-size: 12px;
      color: var(--ig-secondary-text);
      margin-top: 4px;
    }

    /* Task Card */
    .task-card {
      background: var(--ig-primary-background);
      border: 1px solid var(--ig-border);
      border-radius: 10px;
      padding: 14px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .task-card:hover {
      border-color: var(--ig-blue);
      transform: translateX(4px);
    }

    .task-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .task-title {
      font-size: 14px;
      font-weight: 600;
    }

    .task-priority {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }

    .priority-high { background: #ffebee; color: #c62828; }
    .priority-medium { background: #fff3e0; color: #ef6c00; }
    .priority-low { background: #e8f5e9; color: #2e7d32; }

    .task-desc {
      font-size: 13px;
      color: var(--ig-secondary-text);
      margin-bottom: 8px;
    }

    .task-meta {
      display: flex;
      gap: 12px;
      font-size: 12px;
      color: var(--ig-secondary-text);
    }

    /* Note Editor */
    .note-editor {
      background: var(--ig-primary-background);
      border: 1px solid var(--ig-border);
      border-radius: 12px;
      padding: 16px;
    }

    .note-editor textarea {
      width: 100%;
      min-height: 300px;
      border: none;
      background: transparent;
      color: var(--ig-primary-text);
      font-size: 14px;
      font-family: 'Monaco', 'Courier New', monospace;
      resize: vertical;
      outline: none;
    }

    /* Modals */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      animation: fadeIn 0.2s;
    }

    .modal-content {
      background: var(--ig-primary-background);
      border-radius: 16px;
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      padding: 24px;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-title {
      font-size: 20px;
      font-weight: 600;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--ig-secondary-text);
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .form-input,
    .form-textarea,
    .form-select {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--ig-border);
      border-radius: 8px;
      background: var(--ig-secondary-background);
      color: var(--ig-primary-text);
      font-size: 14px;
    }

    .form-textarea {
      min-height: 100px;
      resize: vertical;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary {
      background: var(--ig-blue);
      color: white;
    }

    .btn-secondary {
      background: var(--ig-secondary-background);
      color: var(--ig-primary-text);
      border: 1px solid var(--ig-border);
    }

    .btn-danger {
      background: var(--ig-error);
      color: white;
    }

    .btn:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }

    .btn-group {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }

    /* Empty States */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--ig-secondary-text);
    }

    .empty-icon {
      font-size: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .empty-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .empty-text {
      font-size: 14px;
    }

    /* Responsive */
    @media (max-width: 1200px) {
      .community-shell {
        grid-template-columns: 320px 1fr;
      }
      .community-right {
        display: none;
      }
    }

    @media (max-width: 768px) {
      .community-shell {
        grid-template-columns: 1fr;
      }
      .community-left {
        display: none;
      }
      .community-left.mobile-active {
        display: flex;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 1000;
      }
    }

    /* Loading */
    .loading {
      text-align: center;
      padding: 40px;
      color: var(--ig-secondary-text);
    }

    .spinner {
      border: 3px solid var(--ig-border);
      border-top-color: var(--ig-blue);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* File Upload */
    .file-upload {
      border: 2px dashed var(--ig-border);
      border-radius: 12px;
      padding: 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .file-upload:hover {
      border-color: var(--ig-blue);
      background: var(--ig-hover);
    }

    .file-upload.drag-over {
      border-color: var(--ig-blue);
      background: var(--ig-hover);
    }

    /* GitHub Integration */
    .github-connected {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: var(--ig-secondary-background);
      border: 1px solid var(--ig-border);
      border-radius: 10px;
      margin-bottom: 16px;
    }

    .github-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #24292e;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
    }

    .repo-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .repo-item {
      padding: 12px 16px;
      border: 1px solid var(--ig-border);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      transition: all 0.2s;
    }

    .repo-item:hover {
      border-color: var(--ig-blue);
      background: var(--ig-hover);
    }
  </style>
</head>
<body>
  <div class="community-shell">
    <!-- LEFT SIDEBAR -->
    <div class="community-left" id="communityLeft">
      <div class="left-header">
        <div class="community-title">
          <i class="fas fa-users"></i>
          <span id="communityName">Loading...</span>
        </div>
        <div class="community-subtitle" id="communitySubtitle">Community</div>
      </div>

      <div class="left-tabs">
        <button class="left-tab active" onclick="switchLeftTab('community')">Community</button>
        <button class="left-tab" onclick="switchLeftTab('announcements')">Announcements</button>
      </div>

      <div class="left-content" id="leftContent">
        <!-- Content loads here -->
      </div>

      <div class="left-footer">
        <button class="btn btn-primary" style="width: 100%;" onclick="showCreateGroupModal()">
          <i class="fas fa-plus"></i> Create Group
        </button>
      </div>
    </div>

    <!-- CENTER PANEL -->
    <div class="community-center">
      <div class="center-header">
        <div class="header-left">
          <button class="ws-icon-btn" onclick="toggleLeftSidebar()" style="margin-right: 8px; display: none;" id="menuBtn">
            <i class="fas fa-bars"></i>
          </button>
          <div class="header-icon" id="centerIcon">
            <i class="fas fa-bullhorn"></i>
          </div>
          <div>
            <h2 class="header-title" id="centerTitle">Select a group</h2>
            <p class="header-subtitle" id="centerSubtitle">Choose from the left sidebar</p>
          </div>
        </div>
        <div id="centerActions"></div>
      </div>

      <div class="center-tabs" id="centerTabs" style="display: none;">
        <!-- Tabs load dynamically -->
      </div>

      <div class="center-content" id="centerContent">
        <div class="empty-state">
          <div class="empty-icon">üöÄ</div>
          <div class="empty-title">Welcome to your community!</div>
          <div class="empty-text">Select a group from the sidebar to start collaborating</div>
        </div>
      </div>

      <div class="center-footer" id="centerFooter" style="display: none;">
        <!-- Dynamic footer (chat input, etc.) -->
      </div>
    </div>

    <!-- RIGHT SIDEBAR -->
    <div class="community-right" id="communityRight">
      <div class="right-header">
        <div class="right-avatar" id="rightAvatar">
          <i class="fas fa-users"></i>
        </div>
        <div class="right-name" id="rightName">Community Name</div>
        <div class="right-meta" id="rightMeta">Community ¬∑ 0 groups</div>
      </div>

      <div class="right-actions">
        <div class="right-action" onclick="inviteMembers()">
          <div class="action-circle">
            <i class="fas fa-link"></i>
          </div>
          <div class="action-label">Invite</div>
        </div>

        <div class="right-action" onclick="addMembers()">
          <div class="action-circle">
            <i class="fas fa-user-plus"></i>
          </div>
          <div class="action-label">Add members</div>
        </div>

        <div class="right-action" onclick="showCreateGroupModal()">
          <div class="action-circle">
            <i class="fas fa-users-cog"></i>
          </div>
          <div class="action-label">Add groups</div>
        </div>
      </div>

      <div class="right-section">
        <div class="section-title">DESCRIPTION</div>
        <div id="rightDescription">Loading...</div>
      </div>

      <div class="menu-item" onclick="manageGroups()">
        <div class="menu-left">
          <div class="menu-icon"><i class="fas fa-users"></i></div>
          <div>Manage groups</div>
        </div>
        <i class="fas fa-chevron-right"></i>
      </div>

      <div class="menu-item" onclick="showCommunitySettings()">
        <div class="menu-left">
          <div class="menu-icon"><i class="fas fa-cog"></i></div>
          <div>Community settings</div>
        </div>
        <i class="fas fa-chevron-right"></i>
      </div>

      <div class="menu-item" onclick="viewAllGroups()">
        <div class="menu-left">
          <div class="menu-icon"><i class="fas fa-list"></i></div>
          <div>View groups</div>
        </div>
        <div id="groupCountBadge" style="color: var(--ig-secondary-text);">(0)</div>
      </div>

      <div class="menu-item" onclick="showGitHubIntegration()">
        <div class="menu-left">
          <div class="menu-icon"><i class="fab fa-github"></i></div>
          <div>GitHub Integration</div>
        </div>
        <i class="fas fa-chevron-right"></i>
      </div>
    </div>
  </div>

  <!-- Modals Container -->
  <div id="modalsContainer"></div>

  <script src="/socket.io/socket.io.js"></script>
  <script src="/js/app.js"></script>
  <script>
    // ==================== GLOBAL STATE ====================
    let state = {
      communityId: null,
      currentGroupId: null,
      currentView: 'announcements', // announcements, chat, calls, folders, tasks, notes
      socket: null,
      user: null,
      community: null,
      groups: [],
      currentCall: null,
      localStream: null,
      peerConnections: {},
      githubIntegration: null
    };

    // ==================== INITIALIZATION ====================
    document.addEventListener('DOMContentLoaded', async () => {
      if (!InnovateAPI.requireAuth()) return;
      
      state.user = InnovateAPI.getCurrentUser();
      state.socket = InnovateAPI.initSocket();
      
      // Get community ID from URL
      const urlParams = new URLSearchParams(window.location.search);
      state.communityId = urlParams.get('id') || window.location.pathname.split('/').pop();

      await Promise.all([
        loadCommunityData(),
        loadGroups(),
        loadAnnouncements()
      ]);

      setupSocketListeners();
      setupResponsive();
    });

    // ==================== SOCKET LISTENERS ====================
    function setupSocketListeners() {
      if (!state.socket) return;

      state.socket.on('announcement:new', (data) => {
        if (data.communityId == state.communityId) loadAnnouncements();
      });

      state.socket.on('group:new', (data) => {
        if (data.communityId == state.communityId) loadGroups();
      });

      state.socket.on('group:message', (data) => {
        if (data.groupId == state.currentGroupId) appendChatMessage(data.message);
      });

      state.socket.on('call:offer', handleCallOffer);
      state.socket.on('call:answer', handleCallAnswer);
      state.socket.on('call:ice-candidate', handleIceCandidate);
      state.socket.on('call:peer-joined', handlePeerJoined);
      state.socket.on('call:peer-left', handlePeerLeft);
    }

    // ==================== DATA LOADING ====================
    async function loadCommunityData() {
      try {
        const res = await InnovateAPI.apiRequest(`/communities/${state.communityId}`);
        if (res.success) {
          state.community = res.community;
          document.getElementById('communityName').textContent = res.community.name;
          document.getElementById('communitySubtitle').textContent = res.community.description || 'Community';
          document.getElementById('rightName').textContent = res.community.name;
          document.getElementById('rightDescription').textContent = res.community.description || 'No description';
          document.getElementById('rightMeta').textContent = `Community ¬∑ ${res.community.member_count || 0} members`;
        }
      } catch (error) {
        console.error('Error loading community:', error);
        InnovateAPI.showAlert('Error loading community', 'error');
      }
    }

    async function loadGroups() {
      try {
        const res = await InnovateAPI.apiRequest(`/api/communities/${state.communityId}/groups`);
        if (res.success) {
          state.groups = res.groups || [];
          document.getElementById('groupCountBadge').textContent = `(${state.groups.length})`;
          renderGroupsList();
        }
      } catch (error) {
        console.error('Error loading groups:', error);
      }
    }

    async function loadAnnouncements() {
      try {
        const res = await InnovateAPI.apiRequest(`/communities/${state.communityId}/announcements`);
        if (res.success) {
          renderAnnouncements(res.announcements || []);
        }
      } catch (error) {
        console.error('Error loading announcements:', error);
      }
    }

    // ==================== UI RENDERING ====================
    function renderGroupsList() {
      const content = document.getElementById('leftContent');
      
      if (state.groups.length === 0) {
        content.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">üë•</div>
            <div class="empty-title">No groups yet</div>
            <div class="empty-text">Create your first group to get started</div>
          </div>
        `;
        return;
      }

      content.innerHTML = state.groups.map(group => `
        <div class="group-item ${state.currentGroupId == group.id ? 'active' : ''}" onclick="selectGroup(${group.id})">
          <div class="group-avatar">${group.name.charAt(0).toUpperCase()}</div>
          <div class="group-info">
            <div class="group-name">${group.name}</div>
            <div class="group-desc">${group.description || 'No description'}</div>
          </div>
        </div>
      `).join('');
    }

    function renderAnnouncements(announcements) {
      const content = document.getElementById('leftContent');
      
      if (announcements.length === 0) {
        content.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">üì¢</div>
            <div class="empty-title">No announcements</div>
            <div class="empty-text">Admins can post important updates here</div>
          </div>
        `;
        return;
      }

      content.innerHTML = announcements.map(ann => `
        <div class="group-item" onclick="viewAnnouncement(${ann.id})">
          <div class="group-avatar"><i class="fas fa-bullhorn"></i></div>
          <div class="group-info">
            <div class="group-name">${ann.title || 'Announcement'}</div>
            <div class="group-desc">${InnovateAPI.formatDate(ann.created_at)} ¬∑ ${ann.author_username}</div>
          </div>
        </div>
      `).join('');
    }

    // ==================== TAB SWITCHING ====================
    function switchLeftTab(tab) {
      document.querySelectorAll('.left-tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');

      if (tab === 'announcements') {
        loadAnnouncements();
      } else {
        renderGroupsList();
      }
    }

    function switchCenterTab(view) {
      state.currentView = view;
      document.querySelectorAll('.center-tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');
      loadGroupView(state.currentGroupId);
    }

    // ==================== GROUP SELECTION ====================
    async function selectGroup(groupId) {
      state.currentGroupId = groupId;
      const group = state.groups.find(g => g.id == groupId);
      if (!group) return;

      // Update header
      document.getElementById('centerTitle').textContent = group.name;
      document.getElementById('centerSubtitle').textContent = group.description || 'Group workspace';
      
      // Show tabs
      document.getElementById('centerTabs').style.display = 'flex';
      document.getElementById('centerTabs').innerHTML = `
        <button class="center-tab active" onclick="switchCenterTab('chat')">
          <i class="fas fa-comments"></i> Chat
        </button>
        <button class="center-tab" onclick="switchCenterTab('calls')">
          <i class="fas fa-video"></i> Calls
        </button>
        <button class="center-tab" onclick="switchCenterTab('folders')">
          <i class="fas fa-folder"></i> Folders
        </button>
        <button class="center-tab" onclick="switchCenterTab('tasks')">
          <i class="fas fa-tasks"></i> To-Do
        </button>
        <button class="center-tab" onclick="switchCenterTab('notes')">
          <i class="fas fa-file-alt"></i> Notes
        </button>
      `;

      // Show action button
      document.getElementById('centerActions').innerHTML = `
        <button class="btn btn-primary" onclick="showGroupActions()">
          <i class="fas fa-ellipsis-v"></i>
        </button>
      `;

      state.currentView = 'chat';
      await loadGroupView(groupId);
      renderGroupsList(); // Update active state
    }

    // ==================== VIEW LOADING ====================
    async function loadGroupView(groupId) {
      const content = document.getElementById('centerContent');
      const footer = document.getElementById('centerFooter');

      switch (state.currentView) {
        case 'chat':
          await loadChatView(groupId);
          break;
        case 'calls':
          loadCallsView(groupId);
          break;
        case 'folders':
          await loadFoldersView(groupId);
          break;
        case 'tasks':
          await loadTasksView(groupId);
          break;
        case 'notes':
          await loadNotesView(groupId);
          break;
      }
    }

    // ==================== CHAT VIEW ====================
    async function loadChatView(groupId) {
      const content = document.getElementById('centerContent');
      const footer = document.getElementById('centerFooter');

      content.innerHTML = '<div class="loading"><div class="spinner"></div>Loading messages...</div>';
      footer.style.display = 'flex';
      footer.innerHTML = `
        <button class="ws-icon-btn" onclick="attachFile()">
          <i class="fas fa-paperclip"></i>
        </button>
        <input type="text" class="form-input" id="chatInput" placeholder="Type a message..." style="flex: 1; margin: 0 12px;">
        <button class="btn btn-primary" onclick="sendMessage()">
          <i class="fas fa-paper-plane"></i>
        </button>
      `;

      // Load messages (implement API call)
      content.innerHTML = `
        <div class="empty-state">
          <div class="empty-icon">üí¨</div>
          <div class="empty-title">No messages yet</div>
          <div class="empty-text">Start the conversation!</div>
        </div>
      `;

      // Join room
      if (state.socket) {
        state.socket.emit('group:join', groupId);
      }
    }

    async function sendMessage() {
      const input = document.getElementById('chatInput');
      const message = input.value.trim();
      if (!message) return;

      try {
        // Implement send message API
        input.value = '';
        InnovateAPI.showAlert('Message sent', 'success');
      } catch (error) {
        console.error('Error sending message:', error);
      }
    }

    // ==================== CALLS VIEW ====================
    function loadCallsView(groupId) {
      const content = document.getElementById('centerContent');
      const footer = document.getElementById('centerFooter');
      footer.style.display = 'none';

      content.innerHTML = `
        <div class="empty-state">
          <div class="empty-icon">üìû</div>
          <div class="empty-title">Start a call</div>
          <div class="empty-text">Voice, video, or screen sharing</div>
          <div style="margin-top: 24px; display: flex; gap: 12px; justify-content: center;">
            <button class="btn btn-primary" onclick="startVoiceCall()">
              <i class="fas fa-phone"></i> Voice Call
            </button>
            <button class="btn btn-primary" onclick="startVideoCall()">
              <i class="fas fa-video"></i> Video Call
            </button>
            <button class="btn btn-primary" onclick="startScreenShare()">
              <i class="fas fa-desktop"></i> Screen Share
            </button>
          </div>
        </div>
      `;
    }

    async function startVoiceCall() {
      try {
        state.localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
        renderCallInterface(false);
        // Implement WebRTC signaling
      } catch (error) {
        console.error('Error starting voice call:', error);
        InnovateAPI.showAlert('Microphone access denied', 'error');
      }
    }

    async function startVideoCall() {
      try {
        state.localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: true });
        renderCallInterface(true);
        // Implement WebRTC signaling
      } catch (error) {
        console.error('Error starting video call:', error);
        InnovateAPI.showAlert('Camera/microphone access denied', 'error');
      }
    }

    async function startScreenShare() {
      try {
        state.localStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
        renderCallInterface(true);
        // Implement WebRTC signaling
      } catch (error) {
        console.error('Error starting screen share:', error);
      }
    }

    function renderCallInterface(hasVideo) {
      const content = document.getElementById('centerContent');
      content.innerHTML = `
        <div class="call-view">
          <div class="video-grid" id="videoGrid">
            <div class="video-tile">
              <video id="localVideo" autoplay muted ${hasVideo ? '' : 'style="display:none"'}></video>
              <div class="video-name">You</div>
            </div>
          </div>
          <div class="call-controls">
            <button class="call-btn mute" onclick="toggleMute()">
              <i class="fas fa-microphone"></i>
            </button>
            <button class="call-btn video" onclick="toggleVideo()" ${hasVideo ? '' : 'style="display:none"'}>
              <i class="fas fa-video"></i>
            </button>
            <button class="call-btn screen" onclick="toggleScreenShare()">
              <i class="fas fa-desktop"></i>
            </button>
            <button class="call-btn end" onclick="endCall()">
              <i class="fas fa-phone-slash"></i>
            </button>
          </div>
        </div>
      `;

      if (hasVideo) {
        document.getElementById('localVideo').srcObject = state.localStream;
      }
    }

    function toggleMute() {
      if (state.localStream) {
        const audioTrack = state.localStream.getAudioTracks()[0];
        audioTrack.enabled = !audioTrack.enabled;
        event.target.innerHTML = audioTrack.enabled ? '<i class="fas fa-microphone"></i>' : '<i class="fas fa-microphone-slash"></i>';
      }
    }

    function toggleVideo() {
      if (state.localStream) {
        const videoTrack = state.localStream.getVideoTracks()[0];
        videoTrack.enabled = !videoTrack.enabled;
        event.target.innerHTML = videoTrack.enabled ? '<i class="fas fa-video"></i>' : '<i class="fas fa-video-slash"></i>';
      }
    }

    function endCall() {
      if (state.localStream) {
        state.localStream.getTracks().forEach(track => track.stop());
        state.localStream = null;
      }
      loadCallsView(state.currentGroupId);
    }

    // ==================== FOLDERS VIEW ====================
    async function loadFoldersView(groupId) {
      const content = document.getElementById('centerContent');
      const footer = document.getElementById('centerFooter');
      footer.style.display = 'none';

      content.innerHTML = `
        <div class="folder-grid">
          <div class="folder-item" onclick="openFolder('images')">
            <div class="folder-icon">üñºÔ∏è</div>
            <div class="folder-name">Images</div>
            <div class="folder-count">0 files</div>
          </div>
          <div class="folder-item" onclick="openFolder('videos')">
            <div class="folder-icon">üé•</div>
            <div class="folder-name">Videos</div>
            <div class="folder-count">0 files</div>
          </div>
          <div class="folder-item" onclick="openFolder('documents')">
            <div class="folder-icon">üìÑ</div>
            <div class="folder-name">Documents</div>
            <div class="folder-count">0 files</div>
          </div>
          <div class="folder-item" onclick="openFolder('links')">
            <div class="folder-icon">üîó</div>
            <div class="folder-name">Links</div>
            <div class="folder-count">0 saved</div>
          </div>
          <div class="folder-item" onclick="openGitHubRepos()">
            <div class="folder-icon">üíª</div>
            <div class="folder-name">GitHub</div>
            <div class="folder-count">Repositories</div>
          </div>
        </div>
        <div style="margin-top: 24px;">
          <div class="file-upload" onclick="uploadFile()">
            <i class="fas fa-cloud-upload-alt" style="font-size: 48px; color: var(--ig-blue); margin-bottom: 16px;"></i>
            <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">Upload Files</div>
            <div style="font-size: 14px; color: var(--ig-secondary-text);">Click to browse or drag and drop</div>
          </div>
        </div>
      `;

      // Load file counts (implement API call)
    }

    function openFolder(type) {
      console.log(`Opening ${type} folder...`);
      // Implement folder view
    }

    function uploadFile() {
      const input = document.createElement('input');
      input.type = 'file';
      input.multiple = true;
      input.onchange = async (e) => {
        const files = Array.from(e.target.files);
        InnovateAPI.showAlert(`Uploading ${files.length} file(s)...`, 'info');
        // Implement file upload
      };
      input.click();
    }

    // ==================== TASKS VIEW ====================
    async function loadTasksView(groupId) {
      const content = document.getElementById('centerContent');
      const footer = document.getElementById('centerFooter');
      footer.style.display = 'none';

      try {
        const res = await InnovateAPI.apiRequest(`/api/community-groups/${groupId}/tasks`);
        const tasks = res.tasks || [];

        content.innerHTML = `
          <div style="margin-bottom: 16px; display: flex; gap: 12px;">
            <button class="btn btn-primary" onclick="createTaskFromText()">
              <i class="fas fa-plus"></i> Add Task
            </button>
            <button class="btn btn-secondary" onclick="createTaskFromImage()">
              <i class="fas fa-image"></i> From Image
            </button>
            <button class="btn btn-secondary" onclick="createTaskFromVoice()">
              <i class="fas fa-microphone"></i> From Voice
            </button>
          </div>
          <div id="tasksList">
            ${tasks.length === 0 ? `
              <div class="empty-state">
                <div class="empty-icon">‚úÖ</div>
                <div class="empty-title">No tasks yet</div>
                <div class="empty-text">Create tasks using text, image, or voice</div>
              </div>
            ` : tasks.map(task => `
              <div class="task-card" onclick="editTask(${task.id})">
                <div class="task-header">
                  <div class="task-title">${task.title}</div>
                  <span class="task-priority priority-${task.priority || 'medium'}">${task.priority || 'medium'}</span>
                </div>
                <div class="task-desc">${task.description || 'No description'}</div>
                <div class="task-meta">
                  <span><i class="fas fa-calendar"></i> ${task.due_date ? new Date(task.due_date).toLocaleDateString() : 'No due date'}</span>
                  <span><i class="fas fa-chart-line"></i> ${task.progress || 0}%</span>
                </div>
              </div>
            `).join('')}
          </div>
        `;
      } catch (error) {
        console.error('Error loading tasks:', error);
      }
    }

    async function createTaskFromText() {
      const title = prompt('Task title:');
      if (!title) return;
      const description = prompt('Description (optional):');

      try {
        await InnovateAPI.apiRequest(`/api/community-groups/${state.currentGroupId}/tasks/from-text`, {
          method: 'POST',
          body: JSON.stringify({ description: `${title}\n${description || ''}` })
        });
        InnovateAPI.showAlert('Task created!', 'success');
        loadTasksView(state.currentGroupId);
      } catch (error) {
        console.error('Error creating task:', error);
      }
    }

    function createTaskFromImage() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append('image', file);

        try {
          const res = await fetch(`/api/community-groups/${state.currentGroupId}/tasks/from-image`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${InnovateAPI.getToken()}` },
            body: formData
          });
          const data = await res.json();
          InnovateAPI.showAlert('Tasks extracted from image!', 'success');
          loadTasksView(state.currentGroupId);
        } catch (error) {
          console.error('Error:', error);
        }
      };
      input.click();
    }

    function createTaskFromVoice() {
      InnovateAPI.showAlert('Voice-to-task feature coming soon!', 'info');
      // Implement voice recording and transcription
    }

    // ==================== NOTES VIEW ====================
    async function loadNotesView(groupId) {
      const content = document.getElementById('centerContent');
      const footer = document.getElementById('centerFooter');
      footer.style.display = 'none';

      try {
        const res = await InnovateAPI.apiRequest(`/api/community-groups/${groupId}/notes`);
        const notes = res.notes || [];

        content.innerHTML = `
          <div style="margin-bottom: 16px;">
            <button class="btn btn-primary" onclick="createNote()">
              <i class="fas fa-plus"></i> New Note
            </button>
          </div>
          ${notes.length === 0 ? `
            <div class="empty-state">
              <div class="empty-icon">üìù</div>
              <div class="empty-title">No notes yet</div>
              <div class="empty-text">Create shared notes for your group</div>
            </div>
          ` : `
            <div style="display: flex; flex-direction: column; gap: 12px;">
              ${notes.map(note => `
                <div class="announcement-card" onclick="openNote(${note.id})">
                  <div class="card-header">
                    <div class="card-info">
                      <div class="card-author">${note.title}</div>
                      <div class="card-date">Updated ${InnovateAPI.formatDate(note.updated_at)} by ${note.updated_by_username || note.created_by_username}</div>
                    </div>
                  </div>
                </div>
              `).join('')}
            </div>
          `}
        `;
      } catch (error) {
        console.error('Error loading notes:', error);
      }
    }

    async function createNote() {
      const title = prompt('Note title:');
      if (!title) return;

      try {
        const res = await InnovateAPI.apiRequest(`/api/community-groups/${state.currentGroupId}/notes`, {
          method: 'POST',
          body: JSON.stringify({ title, content_md: '# Start writing...' })
        });
        InnovateAPI.showAlert('Note created!', 'success');
        openNote(res.note.id);
      } catch (error) {
        console.error('Error creating note:', error);
      }
    }

    function openNote(noteId) {
      window.open(`/note-editor.html?id=${noteId}`, '_blank');
    }

    // ==================== MODALS ====================
    function showCreateGroupModal() {
      showModal(`
        <div class="modal-header">
          <div class="modal-title">Create New Group</div>
          <button class="modal-close" onclick="closeModal()">√ó</button>
        </div>
        <form onsubmit="createGroup(event)">
          <div class="form-group">
            <label class="form-label">Group Name *</label>
            <input type="text" class="form-input" id="groupName" required placeholder="e.g., CSE A, Development Team">
          </div>
          <div class="form-group">
            <label class="form-label">Description</label>
            <textarea class="form-textarea" id="groupDescription" placeholder="What is this group about?"></textarea>
          </div>
          <div class="btn-group">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button type="submit" class="btn btn-primary">Create Group</button>
          </div>
        </form>
      `);
    }

    async function createGroup(e) {
      e.preventDefault();
      const name = document.getElementById('groupName').value;
      const description = document.getElementById('groupDescription').value;

      try {
        const res = await InnovateAPI.apiRequest(`/api/communities/${state.communityId}/groups`, {
          method: 'POST',
          body: JSON.stringify({ name, description })
        });
        
        InnovateAPI.showAlert('Group created!', 'success');
        closeModal();
        await loadGroups();
        
        if (state.socket) {
          state.socket.emit('group:new', { communityId: state.communityId });
        }
      } catch (error) {
        console.error('Error creating group:', error);
        InnovateAPI.showAlert('Error creating group', 'error');
      }
    }

    function showModal(content) {
      const container = document.getElementById('modalsContainer');
      container.innerHTML = `
        <div class="modal-overlay" onclick="if(event.target===this) closeModal()">
          <div class="modal-content">
            ${content}
          </div>
        </div>
      `;
    }

    function closeModal() {
      document.getElementById('modalsContainer').innerHTML = '';
    }

    // ==================== GITHUB INTEGRATION ====================
    function showGitHubIntegration() {
      showModal(`
        <div class="modal-header">
          <div class="modal-title">GitHub Integration</div>
          <button class="modal-close" onclick="closeModal()">√ó</button>
        </div>
        <div style="padding: 20px 0;">
          ${state.githubIntegration ? `
            <div class="github-connected">
              <div class="github-icon"><i class="fab fa-github"></i></div>
              <div>
                <div style="font-weight: 600;">${state.githubIntegration.org || state.githubIntegration.repo}</div>
                <div style="font-size: 13px; color: var(--ig-secondary-text);">Connected</div>
              </div>
            </div>
            <button class="btn btn-danger" style="width: 100%;" onclick="disconnectGitHub()">Disconnect</button>
          ` : `
            <div style="text-align: center; padding: 40px 20px;">
              <i class="fab fa-github" style="font-size: 64px; color: var(--ig-secondary-text); margin-bottom: 16px;"></i>
              <h3 style="margin-bottom: 8px;">Connect GitHub</h3>
              <p style="color: var(--ig-secondary-text); margin-bottom: 24px;">Link your repository to push code directly from the app</p>
              <button class="btn btn-primary" onclick="connectGitHub()">
                <i class="fab fa-github"></i> Connect GitHub
              </button>
            </div>
          `}
        </div>
      `);
    }

    function connectGitHub() {
      InnovateAPI.showAlert('GitHub OAuth flow coming soon!', 'info');
      // Implement GitHub OAuth
    }

    function disconnectGitHub() {
      state.githubIntegration = null;
      InnovateAPI.showAlert('GitHub disconnected', 'success');
      closeModal();
    }

    function openGitHubRepos() {
      if (!state.githubIntegration) {
        showGitHubIntegration();
        return;
      }
      InnovateAPI.showAlert('Showing GitHub repositories...', 'info');
      // Implement GitHub repo browser
    }

    // ==================== UTILITY FUNCTIONS ====================
    function inviteMembers() {
      const link = `${window.location.origin}/communities?join=${state.communityId}`;
      navigator.clipboard.writeText(link);
      InnovateAPI.showAlert('Invite link copied!', 'success');
    }

    function addMembers() {
      InnovateAPI.showAlert('Add members feature coming soon', 'info');
    }

    function manageGroups() {
      InnovateAPI.showAlert('Manage groups feature coming soon', 'info');
    }

    function showCommunitySettings() {
      InnovateAPI.showAlert('Community settings coming soon', 'info');
    }

    function viewAllGroups() {
      switchLeftTab('community');
    }

    function showGroupActions() {
      InnovateAPI.showAlert('Group actions coming soon', 'info');
    }

    function viewAnnouncement(id) {
      InnovateAPI.showAlert('View announcement: ' + id, 'info');
    }

    function setupResponsive() {
      const menuBtn = document.getElementById('menuBtn');
      const leftSidebar = document.getElementById('communityLeft');

      if (window.innerWidth <= 768) {
        menuBtn.style.display = 'block';
      }

      window.addEventListener('resize', () => {
        if (window.innerWidth <= 768) {
          menuBtn.style.display = 'block';
        } else {
          menuBtn.style.display = 'none';
          leftSidebar.classList.remove('mobile-active');
        }
      });
    }

    function toggleLeftSidebar() {
      document.getElementById('communityLeft').classList.toggle('mobile-active');
    }

    // WebRTC Handlers (placeholders)
    function handleCallOffer(data) { }
    function handleCallAnswer(data) { }
    function handleIceCandidate(data) { }
    function handlePeerJoined(data) { }
    function handlePeerLeft(data) { }
    function toggleScreenShare() { }
    function attachFile() { }
    function appendChatMessage(msg) { }
    function editTask(id) { }
  </script>
</body>
</html>

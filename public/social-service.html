<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Social Service - Innovate</title>
  <link rel="stylesheet" href="/css/instagram.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .donation-card {
      background: var(--ig-primary-background);
      border: 1px solid var(--ig-border);
      border-radius: 12px;
      margin-bottom: 16px;
      overflow: hidden;
    }
    
    .donation-images {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 4px;
      max-height: 300px;
      overflow: hidden;
    }
    
    .donation-images img {
      width: 100%;
      height: 150px;
      object-fit: cover;
    }
    
    .donation-content {
      padding: 16px;
    }
    
    .donation-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }
    
    .donation-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
    }
    
    .donation-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
    }
    
    .donation-description {
      color: var(--ig-secondary-text);
      margin-bottom: 12px;
    }
    
    .donation-location {
      display: flex;
      align-items: center;
      gap: 6px;
      color: var(--ig-secondary-text);
      font-size: 14px;
      margin-bottom: 12px;
    }
    
    .donation-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }
    
    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .status-available {
      background: #e7f3ff;
      color: #0095f6;
    }
    
    .status-assigned {
      background: #fff3cd;
      color: #856404;
    }
    
    .status-completed {
      background: #d4edda;
      color: #155724;
    }
    
    .completion-photos {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-top: 12px;
    }
    
    .completion-photos img {
      width: 100%;
      height: 100px;
      object-fit: cover;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <!-- Top Navigation -->
  <div class="ig-top-nav">
    <div class="ig-nav-container">
      <a href="/home" class="ig-logo">Innovate</a>
      <div class="ig-nav-icons">
        <button onclick="openCreateModal()" class="ig-nav-icon">
          <i class="fas fa-plus"></i>
        </button>
        <a href="/home" class="ig-nav-icon">
          <i class="fas fa-home"></i>
        </a>
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="ig-main" style="margin-top: 80px;">
    <div style="display: flex; gap: 8px; margin-bottom: 16px; border-bottom: 1px solid var(--ig-border);">
      <button class="tab-button active" onclick="switchTab('donations')" id="donations-tab">
        <i class="fas fa-hand-holding-heart"></i> Donations
      </button>
      <button class="tab-button" onclick="switchTab('picked')" id="picked-tab">
        <i class="fas fa-check-circle"></i> Picked
      </button>
    </div>

    <!-- Donations Tab -->
    <div id="donations-content">
      <div id="donations-list"></div>
    </div>

    <!-- Picked Tab -->
    <div id="picked-content" style="display: none;">
      <div id="picked-list"></div>
    </div>
  </div>

  <!-- Create/Edit Donation Modal -->
  <div id="create-modal" class="ig-modal-overlay" style="display: none;">
    <div class="ig-modal" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
      <div style="padding: 16px; border-bottom: 1px solid var(--ig-border); display: flex; justify-content: space-between; align-items: center;">
        <button onclick="closeCreateModal()" style="background: none; border: none; color: var(--ig-primary-text); cursor: pointer;">Cancel</button>
        <h3 style="margin: 0;" id="modal-title">Create Donation</h3>
        <button onclick="submitDonation()" class="ig-btn-primary" style="background: var(--ig-blue); color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600;">Post</button>
      </div>
      <div style="padding: 16px;">
        <form id="donation-form" onsubmit="submitDonation(); return false;">
          <input type="hidden" id="donation-id">
          
          <div style="margin-bottom: 16px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Title *</label>
            <input type="text" id="donation-title" required style="width: 100%; padding: 12px; border: 1px solid var(--ig-border); border-radius: 8px; background: var(--ig-secondary-background); color: var(--ig-primary-text);" placeholder="e.g., Clothes for winter">
          </div>

          <div style="margin-bottom: 16px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Description</label>
            <textarea id="donation-description" rows="4" style="width: 100%; padding: 12px; border: 1px solid var(--ig-border); border-radius: 8px; background: var(--ig-secondary-background); color: var(--ig-primary-text); resize: vertical;" placeholder="Describe what you're donating..."></textarea>
          </div>

          <div style="margin-bottom: 16px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Images (up to 5)</label>
            <input type="file" id="donation-images" accept="image/*" multiple style="display: none;" onchange="previewImages()">
            <button type="button" onclick="document.getElementById('donation-images').click()" style="width: 100%; padding: 40px; border: 2px dashed var(--ig-border); border-radius: 8px; background: var(--ig-secondary-background); color: var(--ig-secondary-text); cursor: pointer;">
              <i class="fas fa-camera"></i> Add Photos
            </button>
            <div id="image-preview" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 8px; margin-top: 8px;"></div>
          </div>

          <div style="margin-bottom: 16px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Address *</label>
            <input type="text" id="donation-address" required style="width: 100%; padding: 12px; border: 1px solid var(--ig-border); border-radius: 8px; background: var(--ig-secondary-background); color: var(--ig-primary-text);" placeholder="Enter pickup address">
          </div>

          <div style="margin-bottom: 16px;">
            <button type="button" onclick="getLocation()" style="width: 100%; padding: 12px; border: 1px solid var(--ig-border); border-radius: 8px; background: var(--ig-secondary-background); color: var(--ig-primary-text); cursor: pointer;">
              <i class="fas fa-map-marker-alt"></i> Use My Location
            </button>
          </div>

          <input type="hidden" id="donation-latitude">
          <input type="hidden" id="donation-longitude">
        </form>
      </div>
    </div>
  </div>

  <!-- Upload Completion Photos Modal -->
  <div id="completion-modal" class="ig-modal-overlay" style="display: none;">
    <div class="ig-modal" style="max-width: 500px;">
      <div style="padding: 16px; border-bottom: 1px solid var(--ig-border); display: flex; justify-content: space-between; align-items: center;">
        <button onclick="closeCompletionModal()" style="background: none; border: none; color: var(--ig-primary-text); cursor: pointer;">Cancel</button>
        <h3 style="margin: 0;">Upload Completion Photos</h3>
        <button onclick="uploadCompletionPhotos()" class="ig-btn-primary" style="background: var(--ig-blue); color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600;">Upload</button>
      </div>
      <div style="padding: 16px;">
        <input type="hidden" id="completion-donation-id">
        <p style="color: var(--ig-secondary-text); margin-bottom: 16px;">Upload photos showing the successful donation pickup</p>
        <input type="file" id="completion-photos" accept="image/*" multiple style="display: none;" onchange="previewCompletionPhotos()">
        <button type="button" onclick="document.getElementById('completion-photos').click()" style="width: 100%; padding: 40px; border: 2px dashed var(--ig-border); border-radius: 8px; background: var(--ig-secondary-background); color: var(--ig-secondary-text); cursor: pointer;">
          <i class="fas fa-camera"></i> Add Photos
        </button>
        <div id="completion-preview" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 8px; margin-top: 8px;"></div>
      </div>
    </div>
  </div>

  <!-- Bottom Navigation -->
  <nav class="ig-bottom-nav">
    <a href="/home" class="ig-bottom-nav-item">
      <svg aria-label="Home" viewBox="0 0 24 24" width="24">
        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
        <polyline points="9 22 9 12 15 12 15 22" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <span class="ig-bottom-nav-label">Home</span>
    </a>
    <a href="/communities" class="ig-bottom-nav-item">
      <svg aria-label="Communities" viewBox="0 0 24 24" width="24">
        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
        <circle cx="9" cy="7" r="4" stroke="currentColor" stroke-width="2" fill="none"/>
        <path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <span class="ig-bottom-nav-label">Communities</span>
    </a>
    <a href="/events" class="ig-bottom-nav-item">
      <svg aria-label="Events" viewBox="0 0 24 24" width="24">
        <rect x="3" y="4" width="18" height="18" rx="2" ry="2" stroke="currentColor" stroke-width="2" fill="none"/>
        <line x1="16" y1="2" x2="16" y2="6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <line x1="8" y1="2" x2="8" y2="6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <line x1="3" y1="10" x2="21" y2="10" stroke="currentColor" stroke-width="2"/>
      </svg>
      <span class="ig-bottom-nav-label">Events</span>
    </a>
    <button class="ig-bottom-nav-item" onclick="openCreateModal()" style="background: none; border: none; cursor: pointer;">
      <svg aria-label="Create" viewBox="0 0 24 24" width="24">
        <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"/>
      </svg>
      <span class="ig-bottom-nav-label">Create</span>
    </button>
    <a href="/social-service" class="ig-bottom-nav-item active">
      <svg aria-label="Social Service" viewBox="0 0 24 24" width="24">
        <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <span class="ig-bottom-nav-label">Service</span>
    </a>
    <a href="/search" class="ig-bottom-nav-item">
      <svg aria-label="Search" viewBox="0 0 24 24" width="24">
        <circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2" fill="none"/>
        <line x1="21" y1="21" x2="16.65" y2="16.65" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
      <span class="ig-bottom-nav-label">Search</span>
    </a>
    <a href="#" class="ig-bottom-nav-item" id="profileNavLink" onclick="navigateToProfile(event)">
      <svg aria-label="Profile" viewBox="0 0 24 24" width="24">
        <circle cx="12" cy="7" r="4" stroke="currentColor" stroke-width="2" fill="none"/>
        <path d="M5.5 21v-2a7.5 7.5 0 0 1 13 0v2" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/>
      </svg>
      <span class="ig-bottom-nav-label">Profile</span>
    </a>
  </nav>

  <script>
    function navigateToProfile(e) {
      e.preventDefault();
      const user = InnovateAPI.getCurrentUser();
      if (user && user.id) {
        window.location.href = `/profile/${user.id}`;
      }
    }
  </script>

  <script src="/socket.io/socket.io.js"></script>
  <script src="/js/app.js"></script>
  <script src="/js/instagram-theme.js"></script>
  <script>
    InnovateAPI.requireAuth();
    InnovateAPI.initializePage();

    let currentTab = 'donations';
    let editingDonationId = null;

    // Load donations on page load
    loadDonations();

    function switchTab(tab) {
      currentTab = tab;
      
      // Update tab buttons
      document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
      document.getElementById(`${tab}-tab`).classList.add('active');
      
      // Show/hide content
      document.getElementById('donations-content').style.display = tab === 'donations' ? 'block' : 'none';
      document.getElementById('picked-content').style.display = tab === 'picked' ? 'block' : 'none';
      
      if (tab === 'donations') {
        loadDonations();
      } else {
        loadPickedDonations();
      }
    }

    async function loadDonations() {
      try {
        const data = await InnovateAPI.apiRequest('/social-service/donations');
        const list = document.getElementById('donations-list');
        list.innerHTML = '';

        if (data.donations.length === 0) {
          list.innerHTML = `
            <div style="text-align: center; padding: 40px; color: var(--ig-secondary-text);">
              <i class="fas fa-hand-holding-heart" style="font-size: 48px; margin-bottom: 16px;"></i>
              <p>No donations yet</p>
              <button onclick="openCreateModal()" class="ig-btn-primary" style="background: var(--ig-blue); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; margin-top: 16px;">Create First Donation</button>
            </div>
          `;
          return;
        }

        data.donations.forEach(donation => {
          const card = createDonationCard(donation);
          list.appendChild(card);
        });
      } catch (error) {
        console.error('Error loading donations:', error);
        InnovateAPI.showAlert('Error loading donations', 'error');
      }
    }

    async function loadPickedDonations() {
      try {
        const data = await InnovateAPI.apiRequest('/social-service/picked');
        const list = document.getElementById('picked-list');
        list.innerHTML = '';

        if (data.donations.length === 0) {
          list.innerHTML = `
            <div style="text-align: center; padding: 40px; color: var(--ig-secondary-text);">
              <i class="fas fa-box-open" style="font-size: 48px; margin-bottom: 16px;"></i>
              <p>No picked donations yet</p>
            </div>
          `;
          return;
        }

        data.donations.forEach(donation => {
          const card = createPickedDonationCard(donation);
          list.appendChild(card);
        });
      } catch (error) {
        console.error('Error loading picked donations:', error);
        InnovateAPI.showAlert('Error loading picked donations', 'error');
      }
    }

    function createDonationCard(donation) {
      const div = document.createElement('div');
      div.className = 'donation-card';

      const images = donation.images ? JSON.parse(donation.images) : [];
      const currentUser = InnovateAPI.getCurrentUser();
      const isOwner = currentUser && currentUser.id === donation.user_id;

      div.innerHTML = `
        ${images.length > 0 ? `
          <div class="donation-images">
            ${images.slice(0, 4).map(img => `<img src="/${img}" alt="Donation image">`).join('')}
          </div>
        ` : ''}
        <div class="donation-content">
          <div class="donation-header">
            <img src="${donation.profile_picture || '/images/default-avatar.png'}" alt="${donation.username}" class="donation-avatar">
            <div>
              <div style="font-weight: 600;">${donation.username}</div>
              <div style="font-size: 12px; color: var(--ig-secondary-text);">${InnovateAPI.formatDate(donation.created_at)}</div>
            </div>
            <span class="status-badge status-${donation.status}">${donation.status}</span>
          </div>
          <div class="donation-title">${donation.title}</div>
          ${donation.description ? `<div class="donation-description">${donation.description}</div>` : ''}
          ${donation.address ? `
            <div class="donation-location">
              <i class="fas fa-map-marker-alt"></i>
              ${donation.address}
            </div>
          ` : ''}
          <div class="donation-actions">
            ${isOwner ? `
              <button onclick="editDonation(${donation.id})" style="flex: 1; padding: 10px; border: 1px solid var(--ig-border); border-radius: 8px; background: var(--ig-secondary-background); color: var(--ig-primary-text); cursor: pointer;">
                <i class="fas fa-edit"></i> Edit
              </button>
              <button onclick="deleteDonation(${donation.id})" style="flex: 1; padding: 10px; border: 1px solid #ed4956; border-radius: 8px; background: var(--ig-secondary-background); color: #ed4956; cursor: pointer;">
                <i class="fas fa-trash"></i> Delete
              </button>
            ` : donation.status === 'available' ? `
              <button onclick="assignDonation(${donation.id})" style="flex: 1; padding: 10px; border: none; border-radius: 8px; background: var(--ig-blue); color: white; cursor: pointer; font-weight: 600;">
                <i class="fas fa-hand-pointer"></i> Assign Me
              </button>
            ` : ''}
          </div>
        </div>
      `;

      return div;
    }

    function createPickedDonationCard(donation) {
      const div = document.createElement('div');
      div.className = 'donation-card';

      const images = donation.images ? JSON.parse(donation.images) : [];
      const completionPhotos = donation.completion_photos ? JSON.parse(donation.completion_photos) : [];

      div.innerHTML = `
        ${images.length > 0 ? `
          <div class="donation-images">
            ${images.slice(0, 4).map(img => `<img src="/${img}" alt="Donation image">`).join('')}
          </div>
        ` : ''}
        <div class="donation-content">
          <div class="donation-header">
            <img src="${donation.donor_picture || '/images/default-avatar.png'}" alt="${donation.donor_username}" class="donation-avatar">
            <div>
              <div style="font-weight: 600;">${donation.donor_username}</div>
              <div style="font-size: 12px; color: var(--ig-secondary-text);">Picked ${InnovateAPI.formatDate(donation.assigned_at)}</div>
            </div>
            <span class="status-badge status-${donation.completed ? 'completed' : 'assigned'}">${donation.completed ? 'Completed' : 'In Progress'}</span>
          </div>
          <div class="donation-title">${donation.title}</div>
          ${donation.description ? `<div class="donation-description">${donation.description}</div>` : ''}
          ${donation.address ? `
            <div class="donation-location">
              <i class="fas fa-map-marker-alt"></i>
              ${donation.address}
            </div>
          ` : ''}
          ${completionPhotos.length > 0 ? `
            <div style="margin-top: 12px;">
              <div style="font-weight: 600; margin-bottom: 8px;">Completion Photos</div>
              <div class="completion-photos">
                ${completionPhotos.map(photo => `<img src="/${photo}" alt="Completion photo">`).join('')}
              </div>
            </div>
          ` : ''}
          <div class="donation-actions">
            ${!donation.completed ? `
              <button onclick="unassignDonation(${donation.id})" style="flex: 1; padding: 10px; border: 1px solid var(--ig-border); border-radius: 8px; background: var(--ig-secondary-background); color: var(--ig-primary-text); cursor: pointer;">
                <i class="fas fa-times"></i> Unassign
              </button>
              <button onclick="openCompletionModal(${donation.id})" style="flex: 1; padding: 10px; border: none; border-radius: 8px; background: var(--ig-blue); color: white; cursor: pointer; font-weight: 600;">
                <i class="fas fa-check"></i> Mark Complete
              </button>
            ` : ''}
          </div>
        </div>
      `;

      return div;
    }

    function openCreateModal() {
      editingDonationId = null;
      document.getElementById('modal-title').textContent = 'Create Donation';
      document.getElementById('donation-form').reset();
      document.getElementById('donation-id').value = '';
      document.getElementById('image-preview').innerHTML = '';
      document.getElementById('create-modal').style.display = 'flex';
    }

    function closeCreateModal() {
      document.getElementById('create-modal').style.display = 'none';
      editingDonationId = null;
    }

    function previewImages() {
      const input = document.getElementById('donation-images');
      const preview = document.getElementById('image-preview');
      preview.innerHTML = '';

      Array.from(input.files).slice(0, 5).forEach(file => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = document.createElement('img');
          img.src = e.target.result;
          img.style.width = '100%';
          img.style.height = '100px';
          img.style.objectFit = 'cover';
          img.style.borderRadius = '8px';
          preview.appendChild(img);
        };
        reader.readAsDataURL(file);
      });
    }

    function getLocation() {
      if (!navigator.geolocation) {
        InnovateAPI.showAlert('Geolocation not supported', 'error');
        return;
      }

      navigator.geolocation.getCurrentPosition(
        (position) => {
          document.getElementById('donation-latitude').value = position.coords.latitude;
          document.getElementById('donation-longitude').value = position.coords.longitude;
          InnovateAPI.showAlert('Location captured!', 'success');

          // Reverse geocode to get address
          fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${position.coords.latitude}&lon=${position.coords.longitude}`)
            .then(res => res.json())
            .then(data => {
              document.getElementById('donation-address').value = data.display_name;
            })
            .catch(() => {});
        },
        (error) => {
          InnovateAPI.showAlert('Could not get location', 'error');
        }
      );
    }

    async function submitDonation() {
      const form = document.getElementById('donation-form');
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      const formData = new FormData();
      formData.append('title', document.getElementById('donation-title').value);
      formData.append('description', document.getElementById('donation-description').value);
      formData.append('address', document.getElementById('donation-address').value);
      formData.append('latitude', document.getElementById('donation-latitude').value);
      formData.append('longitude', document.getElementById('donation-longitude').value);

      const images = document.getElementById('donation-images').files;
      Array.from(images).forEach(image => {
        formData.append('images', image);
      });

      try {
        const url = editingDonationId 
          ? `/social-service/donations/${editingDonationId}`
          : '/social-service/donations';
        
        const method = editingDonationId ? 'PUT' : 'POST';

        const response = await fetch(url, {
          method: method,
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          },
          body: formData
        });

        if (!response.ok) throw new Error('Failed to save donation');

        InnovateAPI.showAlert(editingDonationId ? 'Donation updated!' : 'Donation posted!', 'success');
        closeCreateModal();
        loadDonations();
      } catch (error) {
        console.error('Error saving donation:', error);
        InnovateAPI.showAlert('Error saving donation', 'error');
      }
    }

    async function assignDonation(donationId) {
      if (!confirm('Are you sure you want to pick this donation?')) return;

      try {
        await InnovateAPI.apiRequest(`/social-service/donations/${donationId}/assign`, { method: 'POST' });
        InnovateAPI.showAlert('Donation assigned to you!', 'success');
        loadDonations();
      } catch (error) {
        console.error('Error assigning donation:', error);
        InnovateAPI.showAlert('Error assigning donation', 'error');
      }
    }

    async function unassignDonation(donationId) {
      if (!confirm('Are you sure you want to unassign this donation?')) return;

      try {
        await InnovateAPI.apiRequest(`/social-service/donations/${donationId}/assign`, { method: 'DELETE' });
        InnovateAPI.showAlert('Donation unassigned', 'success');
        loadPickedDonations();
      } catch (error) {
        console.error('Error unassigning donation:', error);
        InnovateAPI.showAlert('Error unassigning donation', 'error');
      }
    }

    async function deleteDonation(donationId) {
      if (!confirm('Are you sure you want to delete this donation?')) return;

      try {
        await InnovateAPI.apiRequest(`/social-service/donations/${donationId}`, { method: 'DELETE' });
        InnovateAPI.showAlert('Donation deleted', 'success');
        loadDonations();
      } catch (error) {
        console.error('Error deleting donation:', error);
        InnovateAPI.showAlert('Error deleting donation', 'error');
      }
    }

    function openCompletionModal(donationId) {
      document.getElementById('completion-donation-id').value = donationId;
      document.getElementById('completion-preview').innerHTML = '';
      document.getElementById('completion-modal').style.display = 'flex';
    }

    function closeCompletionModal() {
      document.getElementById('completion-modal').style.display = 'none';
    }

    function previewCompletionPhotos() {
      const input = document.getElementById('completion-photos');
      const preview = document.getElementById('completion-preview');
      preview.innerHTML = '';

      Array.from(input.files).forEach(file => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = document.createElement('img');
          img.src = e.target.result;
          img.style.width = '100%';
          img.style.height = '100px';
          img.style.objectFit = 'cover';
          img.style.borderRadius = '8px';
          preview.appendChild(img);
        };
        reader.readAsDataURL(file);
      });
    }

    async function uploadCompletionPhotos() {
      const donationId = document.getElementById('completion-donation-id').value;
      const photos = document.getElementById('completion-photos').files;

      if (photos.length === 0) {
        InnovateAPI.showAlert('Please select at least one photo', 'error');
        return;
      }

      const formData = new FormData();
      Array.from(photos).forEach(photo => {
        formData.append('completion_photos', photo);
      });

      try {
        const response = await fetch(`/api/social-service/donations/${donationId}/complete`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          },
          body: formData
        });

        if (!response.ok) throw new Error('Failed to upload photos');

        InnovateAPI.showAlert('Donation marked as complete!', 'success');
        closeCompletionModal();
        loadPickedDonations();
      } catch (error) {
        console.error('Error uploading completion photos:', error);
        InnovateAPI.showAlert('Error uploading photos', 'error');
      }
    }

    // Close modals on overlay click
    document.getElementById('create-modal').addEventListener('click', (e) => {
      if (e.target.id === 'create-modal') closeCreateModal();
    });

    document.getElementById('completion-modal').addEventListener('click', (e) => {
      if (e.target.id === 'completion-modal') closeCompletionModal();
    });

    // Tab button styles
    const style = document.createElement('style');
    style.textContent = `
      .tab-button {
        flex: 1;
        padding: 12px;
        border: none;
        border-bottom: 2px solid transparent;
        background: none;
        color: var(--ig-secondary-text);
        cursor: pointer;
        font-weight: 600;
        transition: all 0.2s;
      }
      
      .tab-button.active {
        color: var(--ig-primary-text);
        border-bottom-color: var(--ig-primary-text);
      }
      
      .tab-button:hover {
        color: var(--ig-primary-text);
      }
    `;
    document.head.appendChild(style);
  </script>
</body>
</html>

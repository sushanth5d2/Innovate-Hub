<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Social Service - Innovate</title>
  <link rel="stylesheet" href="/css/instagram.css">
  <link rel="stylesheet" href="/css/experiences.css">
  <link rel="stylesheet" href="/css/social-service.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
  <!-- Top Navigation -->
  <header class="exp-topbar">
    <div class="exp-topbar-inner">
      <a class="exp-brand" href="/home">Innovate</a>

      <button class="exp-pill" id="cityBtn" type="button" title="Change city">
        <span id="cityLabel">All Cities</span>
        <span style="opacity:0.7;">‚ñæ</span>
      </button>

      <div class="exp-search exp-search-desktop" title="Search">
        <span style="opacity:0.7;">üîé</span>
        <input id="searchInput" type="text" placeholder="Search donations..." />
      </div>

      <div class="exp-actions">
        <button class="exp-icon-btn exp-search-mobile-btn" id="mobileSearchBtn" type="button" title="Search" style="display: none;">üîé</button>
        <button class="exp-pill" id="filtersBtn" type="button"><span class="filter-text">Filters</span><span class="filter-icon" style="display: none;">‚öôÔ∏è</span></button>
        <button class="exp-icon-btn" onclick="openCreateModal()" type="button" title="Create donation">Ôºã</button>
        <a class="exp-icon-btn" href="/notifications" title="Notifications" style="text-decoration:none;">üîî</a>
        <a class="exp-icon-btn" href="/home" title="Home" style="text-decoration:none;">üè†</a>
      </div>
      
      <!-- Mobile search overlay -->
      <div class="exp-search-mobile-overlay" id="mobileSearchOverlay" style="display: none;">
        <div class="exp-search-mobile-container">
          <button class="exp-icon-btn" id="closeMobileSearch" type="button">‚Üê</button>
          <input id="searchInputMobile" type="text" placeholder="Search donations..." style="flex: 1; border: none; background: transparent; color: var(--ig-primary-text); font-size: 15px; outline: none;" />
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="exp-main exp-page" style="padding-bottom: 80px;">
    <div>
      <div class="exp-title" id="pageTitle">Social Service</div>
      <div class="exp-subtitle" id="pageSubtitle">Donate items you don't need or help pick up donations</div>
      <div class="exp-tabs" role="tablist">
        <button class="exp-tab" onclick="switchTab('overview')" id="overview-tab" type="button">Overview</button>
        <button class="exp-tab active" onclick="switchTab('donations')" id="donations-tab" type="button">All Donations</button>
        <button class="exp-tab" onclick="switchTab('mine')" id="mine-tab" type="button">My Donations</button>
        <button class="exp-tab" onclick="switchTab('picked')" id="picked-tab" type="button">Picked by Me</button>
        <button class="exp-tab" onclick="switchTab('map')" id="map-tab" type="button">Map</button>
      </div>
    </div>

    <!-- Overview Tab -->
    <div id="overview-content" style="display: none;">
      <div class="ss-hero" id="hero-section">
        <div class="ss-hero-icon">ü§ù</div>
        <h1 class="ss-hero-title">Make a Difference</h1>
        <p class="ss-hero-subtitle">Donate items you don't need or help pick up donations. Together, we build a better community.</p>
        
        <!-- Stats -->
        <div class="ss-hero-stats">
          <div class="ss-stat">
            <div>
              <div class="ss-stat-value" id="stat-total">0</div>
              <div class="ss-stat-label">TOTAL DONATIONS</div>
            </div>
          </div>
          <div class="ss-stat">
            <div>
              <div class="ss-stat-value" id="stat-active">0</div>
              <div class="ss-stat-label">ACTIVE</div>
            </div>
          </div>
          <div class="ss-stat">
            <div>
              <div class="ss-stat-value" id="stat-completed">0</div>
              <div class="ss-stat-label">COMPLETED</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Donations Tab -->
    <section id="donations-content">
      <div id="donations-list" class="exp-grid"></div>
    </section>

    <!-- My Donations Tab -->
    <section id="mine-content" style="display: none;">
      <div id="mine-list" class="exp-grid"></div>
    </section>

    <!-- Picked Tab -->
    <section id="picked-content" style="display: none;">
      <div id="picked-list" class="exp-grid"></div>
    </section>

    <!-- Map Tab -->
    <div id="map-content" style="display: none;">
      <!-- Map Settings Panel (Collapsible) -->
      <div id="map-settings-panel" style="margin-bottom: 16px; background: rgba(255,255,255,0.04); border: 1px solid var(--ig-border); border-radius: 12px; overflow: hidden;">
        <div style="padding: 16px; display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleMapSettings()">
          <div style="display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-cog" style="color: #0095f6;"></i>
            <span style="font-weight: 700; font-size: 15px;">Map & Location Settings</span>
          </div>
          <i class="fas fa-chevron-down" id="settings-chevron" style="color: var(--ig-secondary-text); transition: transform 0.3s;"></i>
        </div>
        
        <div id="map-settings-content" style="display: none; padding: 0 16px 16px 16px; border-top: 1px solid var(--ig-border);">
          <div style="margin-top: 16px; padding: 12px; background: rgba(0,149,246,0.1); border: 1px solid rgba(0,149,246,0.3); border-radius: 8px; font-size: 13px;">
            <i class="fas fa-info-circle" style="color: #0095f6;"></i>
            <span style="color: var(--ig-secondary-text);">Control how your donations appear on the map and get notified about nearby donations</span>
          </div>

          <!-- Show on Map Toggle -->
          <div class="ss-setting-row" style="margin-top: 16px;">
            <div>
              <div class="ss-setting-title">Show My Donations on Map</div>
              <div class="ss-setting-desc">Allow your available donations to be visible on the public map</div>
            </div>
            <label class="ss-toggle">
              <input type="checkbox" id="show-on-map-toggle" onchange="autoSaveSettings()">
              <span class="ss-toggle-slider"></span>
            </label>
          </div>

          <!-- Proximity Notifications -->
          <div class="ss-setting-row" style="padding-top: 16px; border-top: 1px solid var(--ig-border); margin-top: 16px;">
            <div>
              <div class="ss-setting-title">Proximity Notifications</div>
              <div class="ss-setting-desc">Get notified when donations appear within your radius</div>
            </div>
            <label class="ss-toggle">
              <input type="checkbox" id="proximity-notifications-toggle" onchange="toggleProximityDistance(); autoSaveSettings();">
              <span class="ss-toggle-slider"></span>
            </label>
          </div>

          <!-- Distance Radius -->
          <div id="distance-setting" style="margin-top: 16px; display: none;">
            <label class="ss-form-label">Notification Radius</label>
            <div style="display: flex; gap: 12px; align-items: center; margin-top: 8px;">
              <input type="range" id="proximity-distance" min="100" max="5000" step="100" value="500" 
                     onchange="updateDistanceValue(); autoSaveSettings();"
                     style="flex: 1; accent-color: #0095f6;">
              <div style="min-width: 80px; text-align: right; font-weight: 600; color: var(--ig-primary-text);">
                <span id="distance-value">500</span>m
              </div>
            </div>
            <div class="ss-file-hint" style="margin-top: 8px;">You'll be notified about new donations within this distance from your location</div>
          </div>

          <!-- Current Location Info -->
          <div style="margin-top: 16px; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px; border: 1px solid var(--ig-border);">
            <div style="font-size: 13px; color: var(--ig-secondary-text);">
              <i class="fas fa-map-marker-alt" style="color: #ed4956;"></i>
              <span id="current-location-info">Location access required</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Map Status Bar -->
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px; border: 1px solid var(--ig-border);">
        <div style="font-size: 14px; color: var(--ig-secondary-text);">
          <i class="fas fa-map-marker-alt" style="color: #ed4956;"></i>
          <span id="map-status">Showing available donations on map</span>
        </div>
      </div>

      <!-- Nearby Donations List (shown when proximity notifications enabled) -->
      <div id="nearby-donations-section" style="display: none; margin-bottom: 16px;">
        <div style="padding: 16px; background: rgba(255,255,255,0.04); border: 1px solid var(--ig-border); border-radius: 12px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <div style="font-weight: 700; font-size: 15px; color: var(--ig-primary-text);">
              <i class="fas fa-location-arrow" style="color: #0095f6;"></i>
              <span id="nearby-title">Nearby Donations</span>
            </div>
            <div id="nearby-count" style="font-size: 13px; color: var(--ig-secondary-text);"></div>
          </div>
          <div id="nearby-donations-list" style="display: flex; flex-direction: column; gap: 10px; max-height: 400px; overflow-y: auto;"></div>
        </div>
      </div>

      <!-- Map Container -->
      <div id="donation-map" style="height: calc(100vh - 380px); min-height: 400px; border-radius: 12px; overflow: hidden; border: 1px solid var(--ig-border);"></div>
      
      <!-- Map Legend -->
      <div id="map-legend" style="margin-top: 12px; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px; border: 1px solid var(--ig-border); font-size: 13px;">
        <div style="display: flex; gap: 20px; flex-wrap: wrap; align-items: center;">
          <div style="display: flex; align-items: center; gap: 8px;">
            <div style="
              background: linear-gradient(135deg, #10b981 0%, #059669 100%);
              width: 32px;
              height: 32px;
              border-radius: 50%;
              display: flex;
              align-items: center;
              justify-content: center;
              border: 2px solid white;
              box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            ">
              <span style="font-size: 20px;">üßç</span>
            </div>
            <span>Available</span>
          </div>
          <div style="display: flex; align-items: center; gap: 8px;">
            <div style="
              background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
              width: 32px;
              height: 32px;
              border-radius: 50%;
              display: flex;
              align-items: center;
              justify-content: center;
              border: 2px solid white;
              box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            ">
              <span style="font-size: 20px;">üö∂</span>
            </div>
            <span>Assigned</span>
          </div>
          <div style="display: flex; align-items: center; gap: 8px;">
            <div style="
              background: linear-gradient(135deg, #0095f6 0%, #0074cc 100%);
              width: 32px;
              height: 32px;
              border-radius: 50%;
              display: flex;
              align-items: center;
              justify-content: center;
              border: 2px solid white;
              box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            ">
              <span style="font-size: 20px;">üòä</span>
            </div>
            <span>Your Location</span>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Create/Edit Donation Modal -->
  <div id="create-modal" class="ig-modal-overlay" style="display: none;">
    <div class="ig-modal" style="max-width: 860px;">
      <div class="ss-modal-header">
        <h3 class="ss-modal-title" id="modal-title">Create Donation</h3>
        <button onclick="closeCreateModal()" class="ss-modal-close">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="ss-modal-body">
        <form id="donation-form" onsubmit="submitDonation(); return false;">
          <input type="hidden" id="donation-id">
          
          <div class="ss-form-row">
            <div class="ss-form-group">
              <label class="ss-form-label">Title</label>
              <input 
                type="text" 
                id="donation-title" 
                class="ss-form-input"
                required 
                placeholder="e.g., Winter clothes for donation"
                maxlength="100"
              >
            </div>

            <div class="ss-form-group">
              <label class="ss-form-label">Category</label>
              <input 
                type="text" 
                id="donation-category" 
                class="ss-form-input"
                placeholder="e.g., Clothes, Books, Furniture"
              >
            </div>
          </div>

          <div class="ss-form-group">
            <label class="ss-form-label">City</label>
            <input 
              type="text" 
              id="donation-city" 
              class="ss-form-input"
              placeholder="e.g., Hyderabad, Mumbai, Delhi"
            >
          </div>

          <div class="ss-form-group">
            <label class="ss-form-label">Description</label>
            <textarea 
              id="donation-description" 
              class="ss-form-textarea"
              placeholder="Describe what you're donating, condition, sizes, etc..."
              rows="4"
            ></textarea>
          </div>

          <div class="ss-form-group">
            <label class="ss-form-label">Pickup Address</label>
            <input 
              type="text" 
              id="donation-address" 
              class="ss-form-input"
              required 
              placeholder="Enter complete pickup address"
            >
          </div>

          <div class="ss-form-group">
            <label class="ss-form-label">Phone Number</label>
            <input 
              type="tel" 
              id="donation-phone" 
              class="ss-form-input"
              placeholder="e.g., +91 98765 43210"
            >
          </div>

          <div class="ss-form-group">
            <label class="ss-form-label">Upload Photos (optional)</label>
            <input 
              type="file" 
              id="donation-images" 
              accept="image/*" 
              multiple
              class="ss-file-input"
              onchange="previewImages()"
            >
            <div class="ss-file-hint">Upload up to 5 photos (PNG, JPG up to 5MB each)</div>
            <div id="image-preview" class="ss-image-preview"></div>
          </div>

          <div class="ss-form-row">
            <div class="ss-form-group">
              <button type="button" onclick="getAddress()" class="ss-location-btn">
                <i class="fas fa-map-marker-alt"></i>
                <span>Get Address</span>
              </button>
            </div>
            <div class="ss-form-group">
              <button type="button" onclick="shareLocation()" class="ss-location-btn ss-location-btn-share">
                <i class="fas fa-share-alt"></i>
                <span>Share Location</span>
              </button>
            </div>
          </div>

          <input type="hidden" id="donation-latitude">
          <input type="hidden" id="donation-longitude">
        </form>
      </div>
      <div class="ss-modal-footer">
        <button onclick="submitDonation()" class="ss-btn ss-btn-primary ss-btn-full">
          Post Donation
        </button>
      </div>
    </div>
  </div>

  <!-- Donation Detail Modal -->
  <div id="donation-detail-modal" class="ig-modal-overlay" style="display: none;">
    <div style="max-width: 1080px; width: 95%; max-height: 90vh; margin: auto; display: flex; background: var(--ig-secondary-background); border-radius: 12px; overflow: hidden;">
      <!-- Image Section -->
      <div style="flex: 0 0 60%; position: relative; background: #000;">
        <button onclick="closeDonationDetail()" class="ss-detail-close">
          <i class="fas fa-times"></i>
        </button>
        <div id="detail-images-container" style="height: 100%; display: flex; align-items: center; justify-content: center; position: relative;">
          <!-- Images will be loaded here -->
        </div>
      </div>
      
      <!-- Details Section -->
      <div style="flex: 1; display: flex; flex-direction: column; overflow-y: auto;">
        <div style="padding: 24px;">
          <!-- User Info -->
          <div class="ss-detail-user" id="detail-user-info" onclick="event.stopPropagation();">
            <!-- User info will be loaded here -->
          </div>
          
          <!-- Title and Status -->
          <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-top: 20px;">
            <h2 id="detail-title" style="font-size: 24px; font-weight: 900; color: var(--ig-primary-text); flex: 1;"></h2>
            <div id="detail-status-badge"></div>
          </div>
          
          <!-- Meta Info -->
          <div id="detail-meta" class="ss-card-meta" style="margin-top: 12px;"></div>
          
          <!-- Description -->
          <div id="detail-description" style="margin-top: 16px; color: var(--ig-secondary-text); line-height: 1.6;"></div>
          
          <!-- Location -->
          <div id="detail-location" style="margin-top: 16px; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px; border: 1px solid var(--ig-border);">
            <!-- Location will be loaded here -->
          </div>
          
          <!-- Picker Info -->
          <div id="detail-picker-info"></div>
          
          <!-- Completion Photos -->
          <div id="detail-completion-photos"></div>
          
          <!-- Share Location Link -->
          <div id="detail-share-link" style="margin-top: 16px;"></div>
        </div>
        
        <!-- Action Buttons -->
        <div id="detail-actions" style="padding: 20px; border-top: 1px solid var(--ig-border); margin-top: auto;">
          <!-- Buttons will be loaded here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Upload Completion Photos Modal -->
  <div id="completion-modal" class="ig-modal-overlay" style="display: none;">
    <div class="ig-modal" style="max-width: 600px;">
      <div class="ss-modal-header">
        <h3 class="ss-modal-title">Complete Donation</h3>
        <button onclick="closeCompletionModal()" class="ss-modal-close">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="ss-modal-body">
        <input type="hidden" id="completion-donation-id">
        <div class="ss-info-box">
          <i class="fas fa-info-circle"></i>
          <p>Upload photos to confirm successful donation pickup</p>
        </div>
        <div class="ss-form-group">
          <label class="ss-form-label">Upload Completion Photos</label>
          <input 
            type="file" 
            id="completion-photos" 
            accept="image/*" 
            multiple
            class="ss-file-input"
            onchange="previewCompletionPhotos()"
          >
          <div class="ss-file-hint">Upload proof of successful pickup</div>
          <div id="completion-preview" class="ss-image-preview"></div>
        </div>
      </div>
      <div class="ss-modal-footer">
        <button onclick="uploadCompletionPhotos()" class="ss-btn ss-btn-success ss-btn-full">
          Mark as Complete
        </button>
      </div>
    </div>
  </div>

  <!-- Filters overlay + drawer -->
  <div class="exp-overlay" id="filtersOverlay"></div>
  <div class="exp-drawer" id="filtersDrawer" aria-label="Filters">
    <div style="display:flex; justify-content:space-between; align-items:center; gap: 12px;">
      <div style="font-weight: 900; font-size: 16px;">Filters</div>
      <button class="exp-icon-btn" id="closeFilters" type="button">‚úï</button>
    </div>
    <div class="exp-field">
      <label>City</label>
      <select id="filterCity">
        <option value="">All Cities</option>
      </select>
    </div>
    <div class="exp-field">
      <label>Category</label>
      <select id="filterCategory">
        <option value="">All Categories</option>
      </select>
    </div>
    <div class="exp-hint">Filter donations by city and category</div>
    <div style="display:flex; gap: 10px; margin-top: 16px;">
      <button class="exp-btn" type="button" id="applyFilters">Apply</button>
      <button class="exp-btn" type="button" id="clearFilters" style="background: rgba(255,255,255,0.1);">Clear</button>
    </div>
  </div>

  <!-- Bottom Navigation -->
  <nav class="ig-bottom-nav">
    <a href="/home" class="ig-bottom-nav-item">
      <svg aria-label="Home" viewBox="0 0 24 24" width="24">
        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
        <polyline points="9 22 9 12 15 12 15 22" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <span class="ig-bottom-nav-label">Home</span>
    </a>
    <a href="/communities" class="ig-bottom-nav-item">
      <svg aria-label="Communities" viewBox="0 0 24 24" width="24">
        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
        <circle cx="9" cy="7" r="4" stroke="currentColor" stroke-width="2" fill="none"/>
        <path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <span class="ig-bottom-nav-label">Communities</span>
    </a>
    <a href="/events" class="ig-bottom-nav-item">
      <svg aria-label="Events" viewBox="0 0 24 24" width="24">
        <rect x="3" y="4" width="18" height="18" rx="2" ry="2" stroke="currentColor" stroke-width="2" fill="none"/>
        <line x1="16" y1="2" x2="16" y2="6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <line x1="8" y1="2" x2="8" y2="6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <line x1="3" y1="10" x2="21" y2="10" stroke="currentColor" stroke-width="2"/>
      </svg>
      <span class="ig-bottom-nav-label">Events</span>
    </a>
    <button class="ig-bottom-nav-item" onclick="openCreateModal()" style="background: none; border: none; cursor: pointer;">
      <svg aria-label="Create" viewBox="0 0 24 24" width="24">
        <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"/>
      </svg>
      <span class="ig-bottom-nav-label">Create</span>
    </button>
    <a href="/social-service" class="ig-bottom-nav-item active">
      <svg aria-label="Social Service" viewBox="0 0 24 24" width="24">
        <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <span class="ig-bottom-nav-label">Service</span>
    </a>
    <a href="/search" class="ig-bottom-nav-item">
      <svg aria-label="Search" viewBox="0 0 24 24" width="24">
        <circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2" fill="none"/>
        <line x1="21" y1="21" x2="16.65" y2="16.65" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
      <span class="ig-bottom-nav-label">Search</span>
    </a>
    <a href="#" class="ig-bottom-nav-item" id="profileNavLink" onclick="navigateToProfile(event)">
      <svg aria-label="Profile" viewBox="0 0 24 24" width="24">
        <circle cx="12" cy="7" r="4" stroke="currentColor" stroke-width="2" fill="none"/>
        <path d="M5.5 21v-2a7.5 7.5 0 0 1 13 0v2" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/>
      </svg>
      <span class="ig-bottom-nav-label">Profile</span>
    </a>
  </nav>

  <script>
    function navigateToProfile(e) {
      e.preventDefault();
      const user = InnovateAPI.getCurrentUser();
      if (user && user.id) {
        window.location.href = `/profile/${user.id}`;
      }
    }
  </script>

  <script src="/socket.io/socket.io.js"></script>
  <script src="/js/app.js"></script>
  <script src="/js/instagram-theme.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="/js/social-service.js"></script>
</body>
</html>

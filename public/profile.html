<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profile - Innovate</title>
  <link rel="stylesheet" href="/css/instagram.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
  <style>
    /* ===== 3D Portfolio â€” Trending Animated Dark Style ===== */
    :root {
      --pf-accent: #667eea;
      --pf-accent2: #764ba2;
      --pf-glow: rgba(102, 126, 234, 0.35);
      --pf-card-bg: rgba(20, 20, 35, 0.65);
      --pf-glass: rgba(255,255,255,0.04);
      --pf-border: rgba(255,255,255,0.08);
      --pf-text: #e8eaf6;
      --pf-text2: #9ea4b8;
      --pf-bg: #0a0a1a;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      background: var(--pf-bg);
      color: var(--pf-text);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      overflow-x: hidden;
      min-height: 100vh;
    }

    /* ===== Animated Background ===== */
    .pf-bg-canvas {
      position: fixed;
      inset: 0;
      z-index: 0;
      overflow: hidden;
      pointer-events: none;
    }

    .pf-orb {
      position: absolute;
      border-radius: 50%;
      filter: blur(80px);
      opacity: 0.3;
      animation: pfOrbFloat 20s ease-in-out infinite alternate;
    }

    .pf-orb-1 { width: 500px; height: 500px; background: var(--pf-accent); top: -10%; left: -10%; animation-duration: 25s; }
    .pf-orb-2 { width: 400px; height: 400px; background: var(--pf-accent2); bottom: -10%; right: -10%; animation-duration: 30s; animation-delay: -5s; }
    .pf-orb-3 { width: 300px; height: 300px; background: #00d2ff; top: 50%; left: 50%; animation-duration: 22s; animation-delay: -10s; }

    @keyframes pfOrbFloat {
      0% { transform: translate(0, 0) scale(1); }
      33% { transform: translate(60px, -40px) scale(1.1); }
      66% { transform: translate(-30px, 50px) scale(0.95); }
      100% { transform: translate(40px, -20px) scale(1.05); }
    }

    /* ===== Grid Particles ===== */
    .pf-grid-bg {
      position: fixed;
      inset: 0;
      z-index: 0;
      background-image:
        linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);
      background-size: 60px 60px;
      pointer-events: none;
    }

    /* ===== Main Container ===== */
    .pf-container {
      position: relative;
      z-index: 1;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      min-height: 100vh;
    }

    /* ===== Top Nav ===== */
    .pf-topnav {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 0;
      margin-bottom: 40px;
    }

    .pf-back-btn {
      background: var(--pf-glass);
      border: 1px solid var(--pf-border);
      color: var(--pf-text);
      width: 44px;
      height: 44px;
      border-radius: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    .pf-back-btn:hover {
      background: rgba(102, 126, 234, 0.15);
      border-color: var(--pf-accent);
      transform: translateX(-3px);
    }

    .pf-nav-title {
      font-size: 14px;
      letter-spacing: 3px;
      text-transform: uppercase;
      color: var(--pf-text2);
      font-weight: 500;
    }

    .pf-share-btn {
      background: var(--pf-glass);
      border: 1px solid var(--pf-border);
      color: var(--pf-text);
      width: 44px;
      height: 44px;
      border-radius: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    .pf-share-btn:hover {
      background: rgba(102, 126, 234, 0.15);
      border-color: var(--pf-accent);
    }

    /* ===== Hero Section ===== */
    .pf-hero {
      text-align: center;
      padding: 40px 0 60px;
      position: relative;
    }

    .pf-hero-avatar-wrap {
      position: relative;
      width: 130px;
      height: 130px;
      margin: 0 auto 24px;
    }

    .pf-hero-avatar {
      width: 130px;
      height: 130px;
      border-radius: 30px;
      object-fit: cover;
      border: 3px solid transparent;
      background: linear-gradient(var(--pf-bg), var(--pf-bg)) padding-box,
                  linear-gradient(135deg, var(--pf-accent), var(--pf-accent2), #00d2ff) border-box;
      position: relative;
      z-index: 2;
      transition: transform 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .pf-hero-avatar:hover {
      transform: scale(1.08) rotateY(10deg);
    }

    .pf-hero-avatar-glow {
      position: absolute;
      inset: -8px;
      border-radius: 34px;
      background: linear-gradient(135deg, var(--pf-accent), var(--pf-accent2));
      opacity: 0.3;
      filter: blur(20px);
      z-index: 1;
      animation: pfPulse 3s ease-in-out infinite;
    }

    @keyframes pfPulse {
      0%, 100% { opacity: 0.2; transform: scale(1); }
      50% { opacity: 0.4; transform: scale(1.05); }
    }

    .pf-hero-name {
      font-size: 36px;
      font-weight: 800;
      margin-bottom: 8px;
      background: linear-gradient(135deg, #fff, #c8cfe8);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      letter-spacing: -0.5px;
    }

    .pf-hero-title {
      font-size: 16px;
      color: var(--pf-accent);
      font-weight: 500;
      margin-bottom: 16px;
      letter-spacing: 1px;
    }

    .pf-hero-bio {
      font-size: 15px;
      color: var(--pf-text2);
      max-width: 500px;
      margin: 0 auto 28px;
      line-height: 1.6;
    }

    /* ===== Stats Row ===== */
    .pf-stats-row {
      display: flex;
      justify-content: center;
      gap: 32px;
      margin-bottom: 48px;
    }

    .pf-stat-card {
      background: var(--pf-card-bg);
      backdrop-filter: blur(20px);
      border: 1px solid var(--pf-border);
      border-radius: 20px;
      padding: 20px 32px;
      text-align: center;
      min-width: 120px;
      transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      cursor: default;
      position: relative;
      overflow: hidden;
    }

    .pf-stat-card::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(102,126,234,0.1), transparent);
      opacity: 0;
      transition: opacity 0.3s;
    }

    .pf-stat-card:hover {
      transform: translateY(-6px) scale(1.02);
      border-color: rgba(102,126,234,0.3);
      box-shadow: 0 20px 40px rgba(0,0,0,0.3), 0 0 30px var(--pf-glow);
    }

    .pf-stat-card:hover::before { opacity: 1; }

    .pf-stat-number {
      font-size: 28px;
      font-weight: 800;
      background: linear-gradient(135deg, var(--pf-accent), var(--pf-accent2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      position: relative;
    }

    .pf-stat-label {
      font-size: 12px;
      color: var(--pf-text2);
      text-transform: uppercase;
      letter-spacing: 1.5px;
      margin-top: 4px;
    }

    /* ===== Section Titles ===== */
    .pf-section-title {
      display: flex;
      align-items: center;
      gap: 14px;
      margin-bottom: 28px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--pf-border);
    }

    .pf-section-icon {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      background: linear-gradient(135deg, var(--pf-accent), var(--pf-accent2));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      color: white;
      flex-shrink: 0;
    }

    .pf-section-title h2 {
      font-size: 22px;
      font-weight: 700;
      letter-spacing: -0.3px;
    }

    .pf-section-title span {
      font-size: 13px;
      color: var(--pf-text2);
    }

    /* ===== Skills Section ===== */
    .pf-skills-section {
      margin-bottom: 60px;
    }

    .pf-skills-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }

    .pf-skill-chip {
      background: var(--pf-card-bg);
      backdrop-filter: blur(20px);
      border: 1px solid var(--pf-border);
      border-radius: 50px;
      padding: 10px 22px;
      font-size: 14px;
      color: var(--pf-text);
      font-weight: 500;
      transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      cursor: default;
      position: relative;
      overflow: hidden;
    }

    .pf-skill-chip::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, var(--pf-accent), var(--pf-accent2));
      opacity: 0;
      transition: opacity 0.3s;
      border-radius: 50px;
    }

    .pf-skill-chip:hover {
      transform: translateY(-4px) scale(1.05);
      border-color: var(--pf-accent);
      box-shadow: 0 8px 24px rgba(102, 126, 234, 0.25);
    }

    .pf-skill-chip:hover::before { opacity: 0.15; }

    .pf-skill-chip span {
      position: relative;
      z-index: 1;
    }

    /* ===== 3D Project Cards ===== */
    .pf-projects-section {
      margin-bottom: 60px;
    }

    .pf-projects-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 24px;
    }

    .pf-project-card {
      background: var(--pf-card-bg);
      backdrop-filter: blur(20px);
      border: 1px solid var(--pf-border);
      border-radius: 20px;
      overflow: hidden;
      transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
      cursor: pointer;
      position: relative;
      transform-style: preserve-3d;
      perspective: 1000px;
    }

    .pf-project-card:hover {
      transform: translateY(-12px) rotateX(2deg) rotateY(-2deg);
      border-color: rgba(102, 126, 234, 0.4);
      box-shadow:
        0 30px 60px rgba(0,0,0,0.4),
        0 0 40px var(--pf-glow),
        inset 0 1px 0 rgba(255,255,255,0.1);
    }

    .pf-project-thumb {
      width: 100%;
      aspect-ratio: 16/10;
      object-fit: cover;
      display: block;
      transition: transform 0.6s ease;
    }

    .pf-project-card:hover .pf-project-thumb {
      transform: scale(1.05);
    }

    .pf-project-thumb-placeholder {
      width: 100%;
      aspect-ratio: 16/10;
      background: linear-gradient(135deg, rgba(102,126,234,0.2), rgba(118,75,162,0.2));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 48px;
      color: var(--pf-accent);
    }

    .pf-project-body {
      padding: 20px;
    }

    .pf-project-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 8px;
      color: var(--pf-text);
    }

    .pf-project-desc {
      font-size: 13px;
      color: var(--pf-text2);
      line-height: 1.6;
      margin-bottom: 16px;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .pf-project-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 16px;
    }

    .pf-project-tag {
      background: rgba(102, 126, 234, 0.12);
      border: 1px solid rgba(102, 126, 234, 0.2);
      color: var(--pf-accent);
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 6px;
      font-weight: 500;
    }

    .pf-project-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding-top: 12px;
      border-top: 1px solid var(--pf-border);
    }

    .pf-project-link {
      color: var(--pf-accent);
      font-size: 13px;
      font-weight: 600;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: gap 0.3s ease;
    }

    .pf-project-link:hover { gap: 10px; }

    .pf-project-date {
      font-size: 12px;
      color: var(--pf-text2);
    }

    /* ===== Interests Section ===== */
    .pf-interests-section {
      margin-bottom: 60px;
    }

    .pf-interests-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 16px;
    }

    .pf-interest-card {
      background: var(--pf-card-bg);
      backdrop-filter: blur(20px);
      border: 1px solid var(--pf-border);
      border-radius: 16px;
      padding: 24px 20px;
      text-align: center;
      transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      cursor: default;
    }

    .pf-interest-card:hover {
      transform: translateY(-8px) scale(1.03);
      border-color: rgba(102, 126, 234, 0.3);
      box-shadow: 0 20px 40px rgba(0,0,0,0.3), 0 0 20px var(--pf-glow);
    }

    .pf-interest-icon {
      font-size: 32px;
      margin-bottom: 12px;
      display: block;
    }

    .pf-interest-name {
      font-size: 14px;
      font-weight: 600;
      color: var(--pf-text);
    }

    /* ===== Activity / Posts Timeline ===== */
    .pf-activity-section {
      margin-bottom: 60px;
    }

    .pf-activity-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 20px;
    }

    .pf-activity-card {
      background: var(--pf-card-bg);
      backdrop-filter: blur(20px);
      border: 1px solid var(--pf-border);
      border-radius: 16px;
      overflow: hidden;
      transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      cursor: pointer;
    }

    .pf-activity-card:hover {
      transform: translateY(-8px);
      border-color: rgba(102, 126, 234, 0.3);
      box-shadow: 0 20px 40px rgba(0,0,0,0.3);
    }

    .pf-activity-img {
      width: 100%;
      aspect-ratio: 4/3;
      object-fit: cover;
    }

    .pf-activity-body {
      padding: 16px;
    }

    .pf-activity-text {
      font-size: 14px;
      color: var(--pf-text);
      line-height: 1.5;
      margin-bottom: 8px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .pf-activity-meta {
      font-size: 12px;
      color: var(--pf-text2);
      display: flex;
      gap: 12px;
    }

    /* ===== Contact / Social Links ===== */
    .pf-contact-section {
      margin-bottom: 60px;
    }

    .pf-social-grid {
      display: flex;
      justify-content: center;
      gap: 16px;
      flex-wrap: wrap;
    }

    .pf-social-btn {
      width: 56px;
      height: 56px;
      border-radius: 16px;
      background: var(--pf-card-bg);
      backdrop-filter: blur(20px);
      border: 1px solid var(--pf-border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      color: var(--pf-text);
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      text-decoration: none;
    }

    .pf-social-btn:hover {
      transform: translateY(-6px) scale(1.1);
      background: linear-gradient(135deg, var(--pf-accent), var(--pf-accent2));
      border-color: transparent;
      color: white;
      box-shadow: 0 12px 30px var(--pf-glow);
    }

    /* ===== Edit Portfolio Modal ===== */
    .pf-modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(8px);
      z-index: 9999;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .pf-modal {
      background: #14142b;
      border: 1px solid var(--pf-border);
      border-radius: 24px;
      max-width: 600px;
      width: 100%;
      max-height: 85vh;
      overflow-y: auto;
      animation: pfModalIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    @keyframes pfModalIn {
      from { transform: scale(0.9) translateY(30px); opacity: 0; }
      to { transform: scale(1) translateY(0); opacity: 1; }
    }

    .pf-modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--pf-border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .pf-modal-header h3 {
      font-size: 18px;
      font-weight: 700;
    }

    .pf-modal-close {
      background: none;
      border: none;
      color: var(--pf-text2);
      font-size: 24px;
      cursor: pointer;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 10px;
      transition: all 0.2s;
    }

    .pf-modal-close:hover {
      background: rgba(255,255,255,0.1);
      color: var(--pf-text);
    }

    .pf-modal-body {
      padding: 24px;
    }

    .pf-form-group {
      margin-bottom: 20px;
    }

    .pf-form-group label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: var(--pf-text2);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .pf-form-input {
      width: 100%;
      padding: 12px 16px;
      background: rgba(255,255,255,0.04);
      border: 1px solid var(--pf-border);
      border-radius: 12px;
      color: var(--pf-text);
      font-size: 14px;
      outline: none;
      transition: border-color 0.3s, box-shadow 0.3s;
    }

    .pf-form-input:focus {
      border-color: var(--pf-accent);
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
    }

    .pf-form-input::placeholder { color: rgba(255,255,255,0.2); }

    textarea.pf-form-input {
      resize: vertical;
      min-height: 80px;
    }

    .pf-modal-footer {
      padding: 16px 24px;
      border-top: 1px solid var(--pf-border);
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    .pf-btn {
      padding: 10px 24px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      border: none;
    }

    .pf-btn-primary {
      background: linear-gradient(135deg, var(--pf-accent), var(--pf-accent2));
      color: white;
    }

    .pf-btn-primary:hover {
      box-shadow: 0 8px 24px var(--pf-glow);
      transform: translateY(-2px);
    }

    .pf-btn-secondary {
      background: var(--pf-glass);
      color: var(--pf-text);
      border: 1px solid var(--pf-border);
    }

    .pf-btn-secondary:hover {
      background: rgba(255,255,255,0.08);
    }

    /* ===== Project Card Add ===== */
    .pf-project-add {
      border: 2px dashed rgba(102, 126, 234, 0.3);
      background: transparent;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 280px;
      color: var(--pf-text2);
      font-size: 14px;
      cursor: pointer;
      transition: all 0.4s;
      border-radius: 20px;
    }

    .pf-project-add:hover {
      border-color: var(--pf-accent);
      background: rgba(102, 126, 234, 0.05);
      color: var(--pf-accent);
      transform: translateY(-4px);
    }

    .pf-project-add i {
      font-size: 36px;
      margin-bottom: 12px;
      opacity: 0.5;
    }

    /* ===== Empty State ===== */
    .pf-empty {
      text-align: center;
      padding: 48px 20px;
      color: var(--pf-text2);
    }

    .pf-empty i {
      font-size: 56px;
      margin-bottom: 16px;
      display: block;
      opacity: 0.15;
    }

    .pf-empty h3 { font-size: 18px; margin-bottom: 8px; color: var(--pf-text); }
    .pf-empty p { font-size: 14px; line-height: 1.6; }

    /* ===== Scroll Animations ===== */
    .pf-reveal {
      opacity: 0;
      transform: translateY(30px);
      transition: all 0.7s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .pf-reveal.visible {
      opacity: 1;
      transform: translateY(0);
    }

    /* ===== Footer ===== */
    .pf-footer {
      text-align: center;
      padding: 40px 20px;
      border-top: 1px solid var(--pf-border);
      margin-top: 40px;
    }

    .pf-footer-text {
      font-size: 13px;
      color: var(--pf-text2);
    }

    .pf-footer-brand {
      background: linear-gradient(135deg, var(--pf-accent), var(--pf-accent2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-weight: 700;
    }

    /* ===== Responsive ===== */
    @media (max-width: 768px) {
      .pf-hero-name { font-size: 26px; }
      .pf-stats-row { gap: 16px; flex-wrap: wrap; }
      .pf-stat-card { padding: 16px 20px; min-width: 90px; }
      .pf-stat-number { font-size: 22px; }
      .pf-projects-grid { grid-template-columns: 1fr; }
      .pf-interests-grid { grid-template-columns: repeat(2, 1fr); }
      .pf-activity-grid { grid-template-columns: 1fr; }
      .pf-container { padding: 12px; }
    }

    /* ===== Scrollbar ===== */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }

    /* ===== Post Detail Modal ===== */
    .pf-post-modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 10000;
      background: rgba(0,0,0,0.85);
      backdrop-filter: blur(8px);
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    .pf-post-modal-overlay.active { display: flex; }
    .pf-post-modal {
      background: var(--pf-card);
      border-radius: 16px;
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      border: 1px solid rgba(255,255,255,0.08);
      animation: pfModalIn 0.3s ease;
    }
    .pf-post-modal-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }
    .pf-post-modal-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
    }
    .pf-post-modal-username {
      font-weight: 600;
      color: var(--pf-text);
      font-size: 14px;
    }
    .pf-post-modal-time {
      font-size: 12px;
      color: var(--pf-text2);
    }
    .pf-post-modal-close {
      margin-left: auto;
      background: none;
      border: none;
      color: var(--pf-text2);
      font-size: 22px;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 8px;
      transition: all 0.2s;
    }
    .pf-post-modal-close:hover { color: var(--pf-text); background: rgba(255,255,255,0.08); }
    .pf-post-modal-images {
      width: 100%;
      position: relative;
    }
    .pf-post-modal-images img {
      width: 100%;
      display: block;
      max-height: 500px;
      object-fit: cover;
    }
    .pf-post-modal-images video {
      width: 100%;
      display: block;
      max-height: 500px;
      background: #000;
    }
    .pf-post-modal-carousel {
      position: relative;
      overflow: hidden;
    }
    .pf-post-modal-carousel-track {
      display: flex;
      transition: transform 0.3s ease;
    }
    .pf-post-modal-carousel-track img {
      min-width: 100%;
      flex-shrink: 0;
    }
    .pf-post-carousel-btn {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(0,0,0,0.6);
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      cursor: pointer;
      font-size: 14px;
      z-index: 2;
    }
    .pf-post-carousel-btn.prev { left: 8px; }
    .pf-post-carousel-btn.next { right: 8px; }
    .pf-post-modal-content {
      padding: 16px;
      font-size: 14px;
      line-height: 1.6;
      color: var(--pf-text);
      white-space: pre-wrap;
      word-break: break-word;
    }
    .pf-post-modal-actions {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 12px 16px;
      border-top: 1px solid rgba(255,255,255,0.06);
    }
    .pf-post-action-btn {
      background: none;
      border: none;
      color: var(--pf-text2);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 14px;
      padding: 6px 10px;
      border-radius: 8px;
      transition: all 0.2s;
    }
    .pf-post-action-btn:hover { background: rgba(255,255,255,0.06); color: var(--pf-text); }
    .pf-post-action-btn.liked { color: #ef4444; }
    .pf-post-modal-comments {
      padding: 0 16px 16px;
      max-height: 300px;
      overflow-y: auto;
    }
    .pf-post-comment {
      display: flex;
      gap: 10px;
      padding: 10px 0;
      border-top: 1px solid rgba(255,255,255,0.04);
    }
    .pf-post-comment-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      object-fit: cover;
      flex-shrink: 0;
    }
    .pf-post-comment-body {
      flex: 1;
    }
    .pf-post-comment-user {
      font-weight: 600;
      font-size: 13px;
      color: var(--pf-text);
      margin-bottom: 2px;
    }
    .pf-post-comment-text {
      font-size: 13px;
      color: var(--pf-text2);
      line-height: 1.4;
    }
    .pf-post-comment-time {
      font-size: 11px;
      color: var(--pf-text2);
      opacity: 0.7;
      margin-top: 2px;
    }
    .pf-post-comment-input-row {
      display: flex;
      gap: 8px;
      padding: 12px 16px;
      border-top: 1px solid rgba(255,255,255,0.06);
    }
    .pf-post-comment-input {
      flex: 1;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 20px;
      padding: 8px 16px;
      color: var(--pf-text);
      font-size: 13px;
      outline: none;
    }
    .pf-post-comment-input:focus { border-color: var(--pf-accent); }
    .pf-post-comment-send {
      background: var(--pf-accent);
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .pf-post-comment-send:hover { opacity: 0.85; }

    /* ===== Mouse 3D tilt for cards ===== */
    .pf-3d-tilt {
      transform-style: preserve-3d;
      will-change: transform;
    }

    /* ===== Profile Action Buttons ===== */
    .pf-action-buttons {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-bottom: 48px;
      flex-wrap: wrap;
    }

    .pf-action-btn {
      padding: 10px 28px;
      border-radius: 14px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      border: 1px solid var(--pf-border);
      display: flex;
      align-items: center;
      gap: 8px;
      backdrop-filter: blur(20px);
    }

    .pf-action-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 30px rgba(0,0,0,0.3);
    }

    .pf-action-btn-primary {
      background: linear-gradient(135deg, var(--pf-accent), var(--pf-accent2));
      color: white;
      border: none;
    }

    .pf-action-btn-primary:hover {
      box-shadow: 0 12px 30px var(--pf-glow);
    }

    .pf-action-btn-secondary {
      background: var(--pf-card-bg);
      color: var(--pf-text);
    }

    .pf-action-btn-secondary:hover {
      background: rgba(102, 126, 234, 0.15);
      border-color: var(--pf-accent);
    }

    .pf-action-btn-follow {
      background: linear-gradient(135deg, #0095f6, #00d4ff);
      color: white;
      border: none;
      min-width: 120px;
      justify-content: center;
    }

    .pf-action-btn-following {
      background: var(--pf-card-bg);
      color: var(--pf-text);
      min-width: 120px;
      justify-content: center;
    }

    /* ===== Hero Avatar Upload Overlay ===== */
    .pf-hero-avatar-wrap {
      cursor: pointer;
    }

    .pf-avatar-upload-overlay {
      position: absolute;
      inset: 0;
      border-radius: 30px;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.3s;
      z-index: 3;
    }

    .pf-hero-avatar-wrap:hover .pf-avatar-upload-overlay {
      opacity: 1;
    }

    .pf-avatar-upload-overlay i {
      font-size: 28px;
      color: white;
    }

    /* ===== Settings Drawer ===== */
    .pf-settings-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(6px);
      z-index: 9998;
      display: none;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .pf-settings-overlay.active {
      display: block;
      opacity: 1;
    }

    .pf-settings-drawer {
      position: fixed;
      right: -420px;
      top: 0;
      bottom: 0;
      width: 400px;
      max-width: 90vw;
      background: #14142b;
      border-left: 1px solid var(--pf-border);
      z-index: 9999;
      overflow-y: auto;
      transition: right 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      box-shadow: -8px 0 40px rgba(0,0,0,0.5);
    }

    .pf-settings-drawer.active {
      right: 0;
    }

    .pf-settings-drawer-header {
      padding: 24px;
      border-bottom: 1px solid var(--pf-border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      background: #14142b;
      z-index: 2;
    }

    .pf-settings-drawer-header h3 {
      font-size: 20px;
      font-weight: 700;
      background: linear-gradient(135deg, var(--pf-accent), var(--pf-accent2));
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .pf-settings-section {
      padding: 16px 24px;
      border-bottom: 1px solid var(--pf-border);
    }

    .pf-settings-section-title {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: var(--pf-text2);
      margin-bottom: 12px;
    }

    .pf-settings-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 16px;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
      margin-bottom: 4px;
    }

    .pf-settings-item:hover {
      background: rgba(102, 126, 234, 0.08);
    }

    .pf-settings-item-left {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .pf-settings-item-icon {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      background: rgba(102, 126, 234, 0.12);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      color: var(--pf-accent);
    }

    .pf-settings-item-label {
      font-size: 14px;
      font-weight: 500;
      color: var(--pf-text);
    }

    .pf-settings-item-desc {
      font-size: 11px;
      color: var(--pf-text2);
      margin-top: 2px;
    }

    .pf-settings-item-chevron {
      color: var(--pf-text2);
      font-size: 14px;
    }

    /* Toggle Switch */
    .pf-toggle {
      width: 44px;
      height: 24px;
      border-radius: 12px;
      background: rgba(255,255,255,0.1);
      position: relative;
      cursor: pointer;
      transition: background 0.3s;
      flex-shrink: 0;
    }

    .pf-toggle.active {
      background: linear-gradient(135deg, var(--pf-accent), var(--pf-accent2));
    }

    .pf-toggle::after {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: white;
      top: 2px;
      left: 2px;
      transition: transform 0.3s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    .pf-toggle.active::after {
      transform: translateX(20px);
    }

    /* ===== Followers/Following List Modal ===== */
    .pf-list-modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(8px);
      z-index: 10000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .pf-list-modal {
      background: #14142b;
      border: 1px solid var(--pf-border);
      border-radius: 24px;
      max-width: 440px;
      width: 100%;
      max-height: 70vh;
      overflow: hidden;
      animation: pfModalIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .pf-list-modal-header {
      padding: 18px 24px;
      border-bottom: 1px solid var(--pf-border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .pf-list-modal-header h3 {
      font-size: 16px;
      font-weight: 700;
    }

    .pf-list-modal-body {
      overflow-y: auto;
      max-height: calc(70vh - 70px);
    }

    .pf-user-list-item {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 12px 24px;
      cursor: pointer;
      transition: background 0.2s;
      text-decoration: none;
      color: inherit;
    }

    .pf-user-list-item:hover {
      background: rgba(102, 126, 234, 0.08);
    }

    .pf-user-list-avatar {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid var(--pf-border);
    }

    .pf-user-list-name {
      font-size: 14px;
      font-weight: 600;
      color: var(--pf-text);
    }

    .pf-user-list-bio {
      font-size: 12px;
      color: var(--pf-text2);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 240px;
    }

    /* ===== Edit Profile Modal Extended ===== */
    .pf-edit-avatar-section {
      text-align: center;
      margin-bottom: 24px;
    }

    .pf-edit-avatar-wrap {
      position: relative;
      display: inline-block;
      margin-bottom: 12px;
    }

    .pf-edit-avatar-img {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid var(--pf-border);
    }

    .pf-edit-avatar-btn {
      position: absolute;
      bottom: 0;
      right: 0;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--pf-accent), var(--pf-accent2));
      border: 3px solid #14142b;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      transition: transform 0.2s;
    }

    .pf-edit-avatar-btn:hover {
      transform: scale(1.1);
    }

    .pf-edit-change-photo {
      color: var(--pf-accent);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .pf-edit-change-photo:hover {
      text-decoration: underline;
    }

    /* ===== Toast Notification ===== */
    .pf-toast {
      position: fixed;
      bottom: 40px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(135deg, var(--pf-accent), var(--pf-accent2));
      color: white;
      padding: 12px 28px;
      border-radius: 50px;
      font-size: 14px;
      font-weight: 600;
      z-index: 99999;
      animation: pfModalIn 0.3s ease;
      box-shadow: 0 8px 32px var(--pf-glow);
    }

    /* ===== Danger/Delete styles ===== */
    .pf-danger-text { color: #ef4444 !important; }

    .pf-settings-item.danger:hover {
      background: rgba(239, 68, 68, 0.08);
    }

    .pf-settings-item.danger .pf-settings-item-icon {
      background: rgba(239, 68, 68, 0.12);
      color: #ef4444;
    }

    /* ===== All Posts Grid ===== */
    .pf-posts-grid-section {
      margin-bottom: 60px;
    }

    .pf-posts-instagram-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 4px;
    }

    .pf-posts-grid-item {
      position: relative;
      aspect-ratio: 1;
      cursor: pointer;
      overflow: hidden;
      border-radius: 4px;
      background: var(--pf-card-bg);
    }

    .pf-posts-grid-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.3s, opacity 0.3s;
    }

    .pf-posts-grid-item:hover img {
      transform: scale(1.05);
      opacity: 0.7;
    }

    .pf-posts-grid-item .pf-grid-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 16px;
      background: rgba(0,0,0,0.3);
      opacity: 0;
      transition: opacity 0.3s;
      color: white;
      font-weight: 600;
      font-size: 14px;
    }

    .pf-posts-grid-item:hover .pf-grid-overlay {
      opacity: 1;
    }

    .pf-grid-stat {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .pf-posts-grid-item .pf-grid-text-post {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      font-size: 13px;
      color: var(--pf-text);
      text-align: center;
      line-height: 1.4;
      overflow: hidden;
    }

    .pf-posts-grid-item .pf-grid-multi-icon {
      position: absolute;
      top: 8px;
      right: 8px;
      color: white;
      font-size: 16px;
      text-shadow: 0 1px 3px rgba(0,0,0,0.5);
    }

    .pf-posts-grid-item .pf-archive-badge {
      position: absolute;
      top: 8px;
      left: 8px;
      background: rgba(0,0,0,0.6);
      color: white;
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 4px;
    }

    /* ===== User List Enhanced Styles ===== */
    .pf-user-list-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-shrink: 0;
    }

    .pf-follow-back-btn {
      background: linear-gradient(135deg, #0095f6, #00d4ff);
      color: white;
      border: none;
      padding: 6px 16px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .pf-follow-back-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(0,149,246,0.3);
    }

    .pf-follow-back-btn.following {
      background: var(--pf-card-bg);
      color: var(--pf-text);
      border: 1px solid var(--pf-border);
    }

    .pf-remove-btn {
      background: none;
      border: none;
      color: var(--pf-text2);
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 16px;
      transition: all 0.2s;
    }

    .pf-remove-btn:hover {
      background: rgba(239, 68, 68, 0.1);
      color: #ef4444;
    }

    .pf-message-btn {
      background: var(--pf-card-bg);
      color: var(--pf-text);
      border: 1px solid var(--pf-border);
      padding: 6px 16px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .pf-message-btn:hover {
      background: rgba(102, 126, 234, 0.15);
      border-color: var(--pf-accent);
    }

    .pf-more-btn {
      background: none;
      border: none;
      color: var(--pf-text2);
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 18px;
      transition: all 0.2s;
      position: relative;
    }

    .pf-more-btn:hover {
      background: rgba(255,255,255,0.08);
      color: var(--pf-text);
    }

    /* ===== Dropdown Menu ===== */
    .pf-dropdown-menu {
      position: absolute;
      right: 0;
      top: 100%;
      background: #1e1e3a;
      border: 1px solid var(--pf-border);
      border-radius: 12px;
      min-width: 160px;
      overflow: hidden;
      z-index: 100;
      box-shadow: 0 8px 24px rgba(0,0,0,0.4);
      animation: pfModalIn 0.2s ease;
    }

    .pf-dropdown-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 16px;
      font-size: 14px;
      color: var(--pf-text);
      cursor: pointer;
      transition: background 0.2s;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
    }

    .pf-dropdown-item:hover {
      background: rgba(102, 126, 234, 0.1);
    }

    .pf-dropdown-item.danger {
      color: #ef4444;
    }

    .pf-dropdown-item.danger:hover {
      background: rgba(239, 68, 68, 0.1);
    }

    /* ===== Share Modal ===== */
    .pf-share-modal {
      background: #14142b;
      border: 1px solid var(--pf-border);
      border-radius: 24px;
      max-width: 480px;
      width: 100%;
      max-height: 80vh;
      overflow: hidden;
      animation: pfModalIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .pf-share-search {
      padding: 12px 16px;
      border-bottom: 1px solid var(--pf-border);
    }

    .pf-share-search input {
      width: 100%;
      padding: 10px 16px;
      background: rgba(255,255,255,0.06);
      border: 1px solid var(--pf-border);
      border-radius: 20px;
      color: var(--pf-text);
      font-size: 14px;
      outline: none;
    }

    .pf-share-search input:focus {
      border-color: var(--pf-accent);
    }

    .pf-share-section-title {
      padding: 12px 16px 6px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--pf-text2);
    }

    .pf-share-users {
      max-height: 300px;
      overflow-y: auto;
    }

    .pf-share-user-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 16px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .pf-share-user-item:hover {
      background: rgba(102, 126, 234, 0.08);
    }

    .pf-share-user-item .pf-share-send-btn {
      margin-left: auto;
      background: linear-gradient(135deg, var(--pf-accent), var(--pf-accent2));
      color: white;
      border: none;
      padding: 6px 16px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
    }

    .pf-share-user-item .pf-share-send-btn:hover {
      opacity: 0.9;
    }

    .pf-share-user-item .pf-share-send-btn.sent {
      background: var(--pf-card-bg);
      color: var(--pf-text2);
      border: 1px solid var(--pf-border);
    }

    .pf-share-apps {
      padding: 12px 16px;
      display: flex;
      gap: 16px;
      overflow-x: auto;
      border-top: 1px solid var(--pf-border);
    }

    .pf-share-app {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      min-width: 60px;
      font-size: 11px;
      color: var(--pf-text2);
    }

    .pf-share-app-icon {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      transition: transform 0.2s;
    }

    .pf-share-app:hover .pf-share-app-icon {
      transform: scale(1.1);
    }

    @media (max-width: 768px) {
      .pf-posts-instagram-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 2px;
      }
    }
  </style>
</head>
<body>
  <!-- Animated Background -->
  <div class="pf-bg-canvas">
    <div class="pf-orb pf-orb-1"></div>
    <div class="pf-orb pf-orb-2"></div>
    <div class="pf-orb pf-orb-3"></div>
  </div>
  <div class="pf-grid-bg"></div>

  <div class="pf-container">
    <!-- Top Navigation -->
    <nav class="pf-topnav">
      <button class="pf-back-btn" onclick="goBack()" title="Back">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
      </button>
      <div class="pf-nav-title">Profile</div>
      <div style="display:flex;gap:8px;">
        <button class="pf-share-btn" id="pf-settings-btn" onclick="openSettingsDrawer()" title="Settings" style="display:none;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
        </button>
      </div>
    </nav>

    <!-- Hero Section -->
    <section class="pf-hero pf-reveal">
      <div class="pf-hero-avatar-wrap" id="pf-avatar-wrap" onclick="handleAvatarClick()">
        <div class="pf-hero-avatar-glow"></div>
        <img id="pf-avatar" class="pf-hero-avatar" src="" alt="Avatar">
        <div class="pf-avatar-upload-overlay" id="pf-avatar-overlay" style="display:none;">
          <i class="fas fa-camera"></i>
        </div>
      </div>
      <h1 id="pf-name" class="pf-hero-name"></h1>
      <div id="pf-title" class="pf-hero-title"></div>
      <p id="pf-bio" class="pf-hero-bio"></p>

      <!-- Action Buttons (dynamic: Edit Profile/Settings for own, Follow/Message for others) -->
      <div class="pf-action-buttons" id="pf-action-buttons"></div>
    </section>

    <!-- Stats -->
    <section class="pf-stats-row pf-reveal">
      <div class="pf-stat-card pf-3d-tilt" style="cursor:pointer;" onclick="showAllPosts()">
        <div class="pf-stat-number" id="pf-posts-count">0</div>
        <div class="pf-stat-label">Posts</div>
      </div>
      <div class="pf-stat-card pf-3d-tilt" style="cursor:pointer;" onclick="showFollowersList()">
        <div class="pf-stat-number" id="pf-followers-count">0</div>
        <div class="pf-stat-label">Followers</div>
      </div>
      <div class="pf-stat-card pf-3d-tilt" style="cursor:pointer;" onclick="showFollowingList()">
        <div class="pf-stat-number" id="pf-following-count">0</div>
        <div class="pf-stat-label">Following</div>
      </div>
      <div class="pf-stat-card pf-3d-tilt">
        <div class="pf-stat-number" id="pf-projects-count">0</div>
        <div class="pf-stat-label">Projects</div>
      </div>
    </section>

    <!-- Skills -->
    <section class="pf-skills-section pf-reveal" id="pf-skills-section" style="display:none;">
      <div class="pf-section-title">
        <div class="pf-section-icon"><i class="fas fa-bolt"></i></div>
        <div>
          <h2>Skills</h2>
          <span>Technologies & expertise</span>
        </div>
      </div>
      <div class="pf-skills-grid" id="pf-skills-grid"></div>
    </section>

    <!-- Projects / Portfolio Items -->
    <section class="pf-projects-section pf-reveal" id="pf-projects-section">
      <div class="pf-section-title">
        <div class="pf-section-icon"><i class="fas fa-rocket"></i></div>
        <div>
          <h2>Projects</h2>
          <span>Featured work & creations</span>
        </div>
        <button id="pf-add-project-btn" onclick="openProjectModal()" style="margin-left:auto;background:linear-gradient(135deg,var(--pf-accent),var(--pf-accent2));color:#fff;border:none;padding:8px 18px;border-radius:10px;font-size:13px;font-weight:600;cursor:pointer;display:none;transition:all 0.3s;" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 8px 24px rgba(102,126,234,0.3)'" onmouseout="this.style.transform='';this.style.boxShadow=''">
          <i class="fas fa-plus" style="margin-right:6px;"></i> Add Project
        </button>
      </div>
      <div class="pf-projects-grid" id="pf-projects-grid"></div>
    </section>

    <!-- Interests -->
    <section class="pf-interests-section pf-reveal" id="pf-interests-section" style="display:none;">
      <div class="pf-section-title">
        <div class="pf-section-icon"><i class="fas fa-heart"></i></div>
        <div>
          <h2>Interests</h2>
          <span>What drives the passion</span>
        </div>
      </div>
      <div class="pf-interests-grid" id="pf-interests-grid"></div>
    </section>

    <!-- Recent Activity / Posts -->
    <section class="pf-activity-section pf-reveal" id="pf-activity-section">
      <div class="pf-section-title">
        <div class="pf-section-icon"><i class="fas fa-fire"></i></div>
        <div>
          <h2>Recent Activity</h2>
          <span>Latest posts & updates</span>
        </div>
      </div>
      <div class="pf-activity-grid" id="pf-activity-grid"></div>
    </section>

    <!-- Footer -->
    <footer class="pf-footer pf-reveal">
      <p class="pf-footer-text">Crafted on <span class="pf-footer-brand">Innovate Hub</span></p>
    </footer>
  </div>

  <!-- Add/Edit Project Modal -->
  <div class="pf-modal-overlay" id="pf-project-modal" onclick="if(event.target===this)closeProjectModal()">
    <div class="pf-modal">
      <div class="pf-modal-header">
        <h3 id="pf-modal-title">Add Project</h3>
        <button class="pf-modal-close" onclick="closeProjectModal()">&times;</button>
      </div>
      <div class="pf-modal-body">
        <input type="hidden" id="pf-edit-project-id">
        <div class="pf-form-group">
          <label>Project Name</label>
          <input type="text" class="pf-form-input" id="pf-project-name" placeholder="My Awesome Project">
        </div>
        <div class="pf-form-group">
          <label>Description</label>
          <textarea class="pf-form-input" id="pf-project-desc" placeholder="What does this project do?" rows="3"></textarea>
        </div>
        <div class="pf-form-group">
          <label>Technologies (comma separated)</label>
          <input type="text" class="pf-form-input" id="pf-project-tech" placeholder="React, Node.js, Python">
        </div>
        <div class="pf-form-group">
          <label>Project URL</label>
          <input type="text" class="pf-form-input" id="pf-project-url" placeholder="https://github.com/...">
        </div>
        <div class="pf-form-group">
          <label>Thumbnail URL (optional)</label>
          <input type="text" class="pf-form-input" id="pf-project-thumb" placeholder="https://example.com/image.png">
        </div>
      </div>
      <div class="pf-modal-footer">
        <button class="pf-btn pf-btn-secondary" onclick="closeProjectModal()">Cancel</button>
        <button class="pf-btn pf-btn-primary" onclick="saveProject()">Save Project</button>
      </div>
    </div>
  </div>

  <!-- Edit Profile Modal -->
  <div class="pf-modal-overlay" id="pf-edit-profile-modal" onclick="if(event.target===this)closeEditProfileModal()">
    <div class="pf-modal">
      <div class="pf-modal-header">
        <h3>Edit Profile</h3>
        <button class="pf-modal-close" onclick="closeEditProfileModal()">&times;</button>
      </div>
      <div class="pf-modal-body">
        <!-- Avatar Change -->
        <div class="pf-edit-avatar-section">
          <div class="pf-edit-avatar-wrap">
            <img id="pf-edit-avatar" class="pf-edit-avatar-img" src="" alt="Avatar">
            <button class="pf-edit-avatar-btn" onclick="changePhoto()">
              <i class="fas fa-camera"></i>
            </button>
          </div>
          <div class="pf-edit-change-photo" onclick="changePhoto()">
            <i class="fas fa-image"></i> Change Profile Photo
          </div>
        </div>
        <!-- Name -->
        <div class="pf-form-group">
          <label>Display Name</label>
          <input type="text" class="pf-form-input" id="pf-edit-fullname" placeholder="Your name">
        </div>
        <!-- Bio -->
        <div class="pf-form-group">
          <label>Bio</label>
          <textarea class="pf-form-input" id="pf-edit-bio" placeholder="Tell the world about yourself..." rows="3" maxlength="150"></textarea>
          <div style="text-align:right;font-size:12px;color:var(--pf-text2);margin-top:4px;"><span id="pf-bio-count">0</span>/150</div>
        </div>
        <!-- Skills -->
        <div class="pf-form-group">
          <label>Skills</label>
          <input type="text" class="pf-form-input" id="pf-edit-skills" placeholder="JavaScript, Python, Design">
        </div>
        <!-- Interests -->
        <div class="pf-form-group">
          <label>Interests</label>
          <input type="text" class="pf-form-input" id="pf-edit-interests" placeholder="Gaming, Travel, Music">
        </div>
        <!-- Favorite Teams -->
        <div class="pf-form-group">
          <label>Favorite Teams</label>
          <input type="text" class="pf-form-input" id="pf-edit-teams" placeholder="Lakers, Real Madrid">
        </div>
      </div>
      <div class="pf-modal-footer">
        <button class="pf-btn pf-btn-secondary" onclick="closeEditProfileModal()">Cancel</button>
        <button class="pf-btn pf-btn-primary" onclick="saveEditProfile()">Save Changes</button>
      </div>
    </div>
  </div>

  <!-- Followers/Following List Modal -->
  <div class="pf-list-modal-overlay" id="pf-list-modal" onclick="if(event.target===this)closeListModal()">
    <div class="pf-list-modal">
      <div class="pf-list-modal-header">
        <h3 id="pf-list-title">Followers</h3>
        <button class="pf-modal-close" onclick="closeListModal()">&times;</button>
      </div>
      <div class="pf-list-modal-body" id="pf-list-body"></div>
    </div>
  </div>

  <!-- Settings Drawer -->
  <div class="pf-settings-overlay" id="pf-settings-overlay" onclick="closeSettingsDrawer()"></div>
  <div class="pf-settings-drawer" id="pf-settings-drawer">
    <div class="pf-settings-drawer-header">
      <h3>Settings</h3>
      <button class="pf-modal-close" onclick="closeSettingsDrawer()">&times;</button>
    </div>

    <!-- Account Section -->
    <div class="pf-settings-section">
      <div class="pf-settings-section-title">Account</div>
      <div class="pf-settings-item" onclick="openEditProfileModal()">
        <div class="pf-settings-item-left">
          <div class="pf-settings-item-icon"><i class="fas fa-user-edit"></i></div>
          <div>
            <div class="pf-settings-item-label">Edit Profile</div>
            <div class="pf-settings-item-desc">Change your profile info</div>
          </div>
        </div>
        <span class="pf-settings-item-chevron"><i class="fas fa-chevron-right"></i></span>
      </div>
      <div class="pf-settings-item" onclick="changePhoto()">
        <div class="pf-settings-item-left">
          <div class="pf-settings-item-icon"><i class="fas fa-camera"></i></div>
          <div>
            <div class="pf-settings-item-label">Change Photo</div>
            <div class="pf-settings-item-desc">Update your profile picture</div>
          </div>
        </div>
        <span class="pf-settings-item-chevron"><i class="fas fa-chevron-right"></i></span>
      </div>
      <div class="pf-settings-item" onclick="showSavedPosts()">
        <div class="pf-settings-item-left">
          <div class="pf-settings-item-icon"><i class="fas fa-bookmark"></i></div>
          <div>
            <div class="pf-settings-item-label">Saved Posts</div>
            <div class="pf-settings-item-desc">View your saved posts</div>
          </div>
        </div>
        <span class="pf-settings-item-chevron"><i class="fas fa-chevron-right"></i></span>
      </div>
      <div class="pf-settings-item" onclick="showArchivedPosts()">
        <div class="pf-settings-item-left">
          <div class="pf-settings-item-icon"><i class="fas fa-archive"></i></div>
          <div>
            <div class="pf-settings-item-label">Archived Posts</div>
            <div class="pf-settings-item-desc">View your archived posts</div>
          </div>
        </div>
        <span class="pf-settings-item-chevron"><i class="fas fa-chevron-right"></i></span>
      </div>
    </div>

    <!-- Appearance Section -->
    <div class="pf-settings-section">
      <div class="pf-settings-section-title">Appearance</div>
      <div class="pf-settings-item" onclick="toggleThemeSetting()">
        <div class="pf-settings-item-left">
          <div class="pf-settings-item-icon"><i class="fas fa-moon"></i></div>
          <div>
            <div class="pf-settings-item-label">Dark Mode</div>
            <div class="pf-settings-item-desc">Toggle dark/light theme</div>
          </div>
        </div>
        <div class="pf-toggle active" id="pf-theme-toggle"></div>
      </div>
    </div>

    <!-- Privacy Section -->
    <div class="pf-settings-section">
      <div class="pf-settings-section-title">Privacy</div>
      <div class="pf-settings-item" onclick="toggleCrosspathSetting()">
        <div class="pf-settings-item-left">
          <div class="pf-settings-item-icon"><i class="fas fa-location-crosshairs"></i></div>
          <div>
            <div class="pf-settings-item-label">Crosspath</div>
            <div class="pf-settings-item-desc">Allow others to find you nearby</div>
          </div>
        </div>
        <div class="pf-toggle" id="pf-crosspath-toggle"></div>
      </div>
      <div class="pf-settings-item" onclick="toggleOnlineStatusSetting()">
        <div class="pf-settings-item-left">
          <div class="pf-settings-item-icon"><i class="fas fa-circle"></i></div>
          <div>
            <div class="pf-settings-item-label">Online Status</div>
            <div class="pf-settings-item-desc">Show when you're active</div>
          </div>
        </div>
        <div class="pf-toggle" id="pf-online-toggle"></div>
      </div>
    </div>

    <!-- Notifications Section -->
    <div class="pf-settings-section">
      <div class="pf-settings-section-title">Notifications</div>
      <div class="pf-settings-item" onclick="toggleNotificationsSetting()">
        <div class="pf-settings-item-left">
          <div class="pf-settings-item-icon"><i class="fas fa-bell"></i></div>
          <div>
            <div class="pf-settings-item-label">Push Notifications</div>
            <div class="pf-settings-item-desc">Get notified about activity</div>
          </div>
        </div>
        <div class="pf-toggle active" id="pf-notif-toggle"></div>
      </div>
    </div>

    <!-- Security Section -->
    <div class="pf-settings-section">
      <div class="pf-settings-section-title">Security</div>
      <div class="pf-settings-item" onclick="changePasswordSetting()">
        <div class="pf-settings-item-left">
          <div class="pf-settings-item-icon"><i class="fas fa-lock"></i></div>
          <div>
            <div class="pf-settings-item-label">Change Password</div>
          </div>
        </div>
        <span class="pf-settings-item-chevron"><i class="fas fa-chevron-right"></i></span>
      </div>
      <div class="pf-settings-item" onclick="viewBlockedUsers()">
        <div class="pf-settings-item-left">
          <div class="pf-settings-item-icon"><i class="fas fa-ban"></i></div>
          <div>
            <div class="pf-settings-item-label">Blocked Users</div>
          </div>
        </div>
        <span class="pf-settings-item-chevron"><i class="fas fa-chevron-right"></i></span>
      </div>
    </div>

    <!-- Support Section -->
    <div class="pf-settings-section">
      <div class="pf-settings-section-title">Support</div>
      <div class="pf-settings-item" onclick="window.location.href='/about'">
        <div class="pf-settings-item-left">
          <div class="pf-settings-item-icon"><i class="fas fa-info-circle"></i></div>
          <div><div class="pf-settings-item-label">About</div></div>
        </div>
        <span class="pf-settings-item-chevron"><i class="fas fa-chevron-right"></i></span>
      </div>
      <div class="pf-settings-item" onclick="window.location.href='/help'">
        <div class="pf-settings-item-left">
          <div class="pf-settings-item-icon"><i class="fas fa-question-circle"></i></div>
          <div><div class="pf-settings-item-label">Help</div></div>
        </div>
        <span class="pf-settings-item-chevron"><i class="fas fa-chevron-right"></i></span>
      </div>
    </div>

    <!-- Danger Zone -->
    <div class="pf-settings-section">
      <div class="pf-settings-section-title" style="color:#ef4444;">Danger Zone</div>
      <div class="pf-settings-item" onclick="confirmLogout()">
        <div class="pf-settings-item-left">
          <div class="pf-settings-item-icon" style="background:rgba(239,68,68,0.12);color:#ef4444;"><i class="fas fa-sign-out-alt"></i></div>
          <div><div class="pf-settings-item-label pf-danger-text">Log Out</div></div>
        </div>
      </div>
      <div class="pf-settings-item danger" onclick="confirmDeleteAccount()">
        <div class="pf-settings-item-left">
          <div class="pf-settings-item-icon" style="background:rgba(239,68,68,0.12);color:#ef4444;"><i class="fas fa-trash-alt"></i></div>
          <div>
            <div class="pf-settings-item-label pf-danger-text">Delete Account</div>
            <div class="pf-settings-item-desc">Permanently delete everything</div>
          </div>
        </div>
      </div>
    </div>

    <div style="padding:24px;text-align:center;">
      <p style="font-size:12px;color:var(--pf-text2);">Innovate Hub v2.0</p>
    </div>
  </div>

  <!-- Post Detail Modal -->
  <div class="pf-post-modal-overlay" id="pf-post-modal">
    <div class="pf-post-modal">
      <div class="pf-post-modal-header">
        <a id="pf-post-user-link" href="#" style="display:flex;align-items:center;gap:12px;text-decoration:none;color:inherit;">
          <img class="pf-post-modal-avatar" id="pf-post-avatar" src="" alt="">
          <div>
            <div class="pf-post-modal-username" id="pf-post-username"></div>
            <div class="pf-post-modal-time" id="pf-post-time"></div>
          </div>
        </a>
        <div style="margin-left:auto;display:flex;align-items:center;gap:4px;">
          <div id="pf-post-3dot-container" style="position:relative;display:none;">
            <button onclick="toggleProfilePostMenu()" style="background:none;border:none;cursor:pointer;color:var(--pf-text2);padding:6px;border-radius:8px;" title="More options">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="5" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="12" cy="19" r="2"/></svg>
            </button>
            <div id="pf-post-menu-dropdown" style="display:none;position:absolute;right:0;top:100%;background:var(--pf-card);border:1px solid rgba(255,255,255,0.1);border-radius:12px;box-shadow:0 4px 16px rgba(0,0,0,0.4);z-index:20;min-width:180px;overflow:hidden;">
              <button onclick="handleProfileEditPost()" style="display:flex;align-items:center;gap:10px;width:100%;padding:12px 16px;background:none;border:none;color:var(--pf-text);cursor:pointer;font-size:14px;text-align:left;">
                <i class="fas fa-edit" style="width:16px;"></i> Edit
              </button>
              <button onclick="handleProfileArchivePost()" style="display:flex;align-items:center;gap:10px;width:100%;padding:12px 16px;background:none;border:none;border-top:1px solid rgba(255,255,255,0.06);color:var(--pf-text);cursor:pointer;font-size:14px;text-align:left;">
                <i class="fas fa-archive" style="width:16px;"></i> Archive
              </button>
              <button onclick="handleProfileDeletePost()" style="display:flex;align-items:center;gap:10px;width:100%;padding:12px 16px;background:none;border:none;border-top:1px solid rgba(255,255,255,0.06);color:#ef4444;cursor:pointer;font-size:14px;text-align:left;">
                <i class="fas fa-trash" style="width:16px;"></i> Delete
              </button>
            </div>
          </div>
          <button class="pf-post-modal-close" onclick="closePostModal()">&times;</button>
        </div>
      </div>
      <div class="pf-post-modal-images" id="pf-post-images"></div>
      <div class="pf-post-modal-content" id="pf-post-content"></div>
      <div class="pf-post-modal-actions" id="pf-post-actions"></div>
      <div class="pf-post-modal-comments" id="pf-post-comments"></div>
      <div id="pf-post-reply-info" style="display:none;padding:8px 16px;background:rgba(102,126,234,0.1);font-size:13px;color:var(--pf-accent);align-items:center;justify-content:space-between;">
        <span>Replying to <strong id="pf-reply-to-username"></strong></span>
        <button onclick="cancelProfileReply()" style="background:none;border:none;color:var(--pf-text2);cursor:pointer;font-size:16px;padding:4px 8px;">âœ•</button>
      </div>
      <div class="pf-post-comment-input-row">
        <input class="pf-post-comment-input" id="pf-post-comment-input" placeholder="Add a comment..." onkeydown="if(event.key==='Enter')submitPostComment()">
        <button class="pf-post-comment-send" onclick="submitPostComment()"><i class="fas fa-paper-plane"></i></button>
      </div>
    </div>
  </div>

  <script src="/js/app.js"></script>
  <script src="/js/instagram-theme.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
  <script>
    // ===== Portfolio Page Logic =====
    const urlParams = new URLSearchParams(window.location.search);
    const viewUsername = urlParams.get('username');
    // Also support /profile/:id or /profile/:username URL pattern used throughout the app
    const pathMatch = window.location.pathname.match(/^\/profile\/(.+)$/);
    const pathParam = pathMatch ? decodeURIComponent(pathMatch[1]) : null;
    const viewUserId = pathParam && /^\d+$/.test(pathParam) ? parseInt(pathParam) : null;
    const viewUsernameFromPath = pathParam && !/^\d+$/.test(pathParam) ? pathParam : null;
    const currentUser = JSON.parse(localStorage.getItem('user') || '{}');
    let portfolioUserId = null;
    let isOwnPortfolio = false;
    let portfolioProjects = [];
    let portfolioUserData = null; // Store full user data for edit profile
    let isFollowing = false;

    const defaultAvatar = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%23262645'/%3E%3Ccircle cx='50' cy='35' r='18' fill='%23667eea'/%3E%3Cpath d='M20 85 Q20 60 50 60 Q80 60 80 85 Z' fill='%23667eea'/%3E%3C/svg%3E";

    const interestIcons = {
      'gaming': 'ðŸŽ®', 'travel': 'âœˆï¸', 'music': 'ðŸŽµ', 'cooking': 'ðŸ³', 'fitness': 'ðŸ’ª',
      'reading': 'ðŸ“š', 'photography': 'ðŸ“¸', 'art': 'ðŸŽ¨', 'coding': 'ðŸ’»', 'movies': 'ðŸŽ¬',
      'sports': 'âš½', 'design': 'ðŸŽ¯', 'tech': 'ðŸš€', 'science': 'ðŸ”¬', 'nature': 'ðŸŒ¿',
      'fashion': 'ðŸ‘—', 'food': 'ðŸ•', 'cars': 'ðŸŽï¸', 'anime': 'ðŸŽŒ', 'writing': 'âœï¸',
      'hiking': 'ðŸ¥¾', 'yoga': 'ðŸ§˜', 'dance': 'ðŸ’ƒ', 'crafts': 'ðŸ› ï¸', 'gardening': 'ðŸŒ±',
      'default': 'âœ¨'
    };

    function goBack() {
      window.location.href = '/home';
    }

    function showToast(message) {
      const toast = document.createElement('div');
      toast.className = 'pf-toast';
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 2500);
    }

    async function initPortfolio() {
      if (!localStorage.getItem('token')) {
        window.location.href = '/login';
        return;
      }

      try {
        let user;

        // Determine which user to view: ?username=, /profile/:id, /profile/:username, or self
        const effectiveUsername = viewUsername || viewUsernameFromPath;

        if (effectiveUsername) {
          // Viewing via username (query param or path)
          if (currentUser.username && effectiveUsername.toLowerCase() === currentUser.username.toLowerCase()) {
            portfolioUserId = currentUser.id;
            isOwnPortfolio = true;
          } else {
            const searchRes = await fetch(`/api/search/users?q=${encodeURIComponent(effectiveUsername)}`, {
              headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
            });
            const searchData = await searchRes.json();
            const found = searchData.users?.find(u => u.username.toLowerCase() === effectiveUsername.toLowerCase());

            if (!found) {
              alert('User not found');
              return goBack();
            }
            portfolioUserId = found.id;
            isOwnPortfolio = currentUser.id == found.id;
          }
        } else if (viewUserId) {
          // Viewing via /profile/:id URL path (numeric ID)
          portfolioUserId = viewUserId;
          isOwnPortfolio = currentUser.id == viewUserId;
        } else {
          portfolioUserId = currentUser.id;
          isOwnPortfolio = true;
        }

        // Load user profile
        const profileRes = await fetch(`/api/users/${portfolioUserId}`, {
          headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        });
        if (!profileRes.ok) throw new Error('Failed to load profile');
        const profileData = await profileRes.json();
        user = profileData.user;
        portfolioUserData = user;
        isFollowing = !!user.is_following;

        // Parse JSON fields
        const skills = Array.isArray(user.skills) ? user.skills : (user.skills ? JSON.parse(user.skills) : []);
        const interests = Array.isArray(user.interests) ? user.interests : (user.interests ? JSON.parse(user.interests) : []);
        const teams = Array.isArray(user.favorite_teams) ? user.favorite_teams : (user.favorite_teams ? JSON.parse(user.favorite_teams) : []);

        // Populate hero
        document.getElementById('pf-avatar').src = user.profile_picture || defaultAvatar;
        document.getElementById('pf-name').textContent = user.username;
        document.getElementById('pf-title').textContent = skills.length > 0 ? skills.slice(0, 3).join(' â€¢ ') : 'Innovate Hub Member';
        document.getElementById('pf-bio').textContent = user.bio || 'Building amazing things on Innovate Hub';

        // Stats
        document.getElementById('pf-posts-count').textContent = user.post_count || 0;
        document.getElementById('pf-followers-count').textContent = user.followers_count || 0;
        document.getElementById('pf-following-count').textContent = user.following_count || 0;

        // Render action buttons
        renderActionButtons();

        // Show settings button and avatar overlay for own profile
        if (isOwnPortfolio) {
          document.getElementById('pf-settings-btn').style.display = '';
          document.getElementById('pf-avatar-overlay').style.display = '';
        }

        // Skills
        if (skills.length > 0) {
          document.getElementById('pf-skills-section').style.display = '';
          const skillsGrid = document.getElementById('pf-skills-grid');
          skillsGrid.innerHTML = skills.map(s =>
            `<div class="pf-skill-chip pf-3d-tilt"><span>${s}</span></div>`
          ).join('');
        }

        // Interests
        const allInterests = [...interests, ...teams];
        if (allInterests.length > 0) {
          document.getElementById('pf-interests-section').style.display = '';
          const interestsGrid = document.getElementById('pf-interests-grid');
          interestsGrid.innerHTML = allInterests.map(i => {
            const key = i.toLowerCase().replace(/[^a-z]/g, '');
            const icon = Object.keys(interestIcons).find(k => key.includes(k));
            return `<div class="pf-interest-card pf-3d-tilt">
              <span class="pf-interest-icon">${interestIcons[icon] || interestIcons.default}</span>
              <div class="pf-interest-name">${i}</div>
            </div>`;
          }).join('');
        }

        // Show add project button for own portfolio
        if (isOwnPortfolio) {
          document.getElementById('pf-add-project-btn').style.display = '';
        }

        // Load projects
        await loadProjects();

        // Load recent posts
        await loadRecentPosts();

        // Animate reveal
        initScrollReveal();
        initTilt3D();
        animateCounters();

        // Load settings state
        if (isOwnPortfolio) {
          loadSettingsState();
        }

      } catch (err) {
        console.error('Portfolio init error:', err);
      }
    }

    // ===== ACTION BUTTONS =====
    function renderActionButtons() {
      const container = document.getElementById('pf-action-buttons');
      if (isOwnPortfolio) {
        container.innerHTML = `
          <button class="pf-action-btn pf-action-btn-primary" onclick="openEditProfileModal()">
            <i class="fas fa-pen"></i> Edit Profile
          </button>
          <button class="pf-action-btn pf-action-btn-secondary" onclick="openSettingsDrawer()">
            <i class="fas fa-cog"></i> Settings
          </button>
          <button class="pf-action-btn pf-action-btn-secondary" onclick="sharePortfolio()">
            <i class="fas fa-share-alt"></i> Share
          </button>
        `;
      } else {
        container.innerHTML = `
          <button class="pf-action-btn ${isFollowing ? 'pf-action-btn-following' : 'pf-action-btn-follow'}" id="pf-follow-btn" onclick="toggleFollow()">
            <i class="fas ${isFollowing ? 'fa-user-check' : 'fa-user-plus'}"></i> ${isFollowing ? 'Following' : 'Follow'}
          </button>
          <button class="pf-action-btn pf-action-btn-secondary" onclick="messageUser()">
            <i class="fas fa-paper-plane"></i> Message
          </button>
          <button class="pf-action-btn pf-action-btn-secondary" onclick="sharePortfolio()">
            <i class="fas fa-share-alt"></i> Share
          </button>
        `;
      }
    }

    // ===== FOLLOW / UNFOLLOW =====
    async function toggleFollow() {
      try {
        const method = isFollowing ? 'DELETE' : 'POST';
        const res = await fetch(`/api/users/${portfolioUserId}/follow`, {
          method,
          headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        });
        if (!res.ok) throw new Error('Failed');
        isFollowing = !isFollowing;

        // Update button
        const btn = document.getElementById('pf-follow-btn');
        btn.className = `pf-action-btn ${isFollowing ? 'pf-action-btn-following' : 'pf-action-btn-follow'}`;
        btn.innerHTML = `<i class="fas ${isFollowing ? 'fa-user-check' : 'fa-user-plus'}"></i> ${isFollowing ? 'Following' : 'Follow'}`;

        // Update follower count
        const countEl = document.getElementById('pf-followers-count');
        let count = parseInt(countEl.textContent) || 0;
        count += isFollowing ? 1 : -1;
        countEl.textContent = Math.max(0, count);

        showToast(isFollowing ? 'Following!' : 'Unfollowed');
      } catch (err) {
        console.error('Follow error:', err);
        showToast('Failed to update');
      }
    }

    function messageUser() {
      window.location.href = `/messages?user=${portfolioUserId}`;
    }

    // ===== AVATAR CLICK & PHOTO CHANGE =====
    function handleAvatarClick() {
      if (isOwnPortfolio) {
        changePhoto();
      } else {
        // Preview photo for other users
        const src = document.getElementById('pf-avatar').src;
        if (!src || src.includes('default') || src.startsWith('data:image/svg')) return;
        const modal = document.createElement('div');
        modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.95);z-index:99999;display:flex;align-items:center;justify-content:center;cursor:pointer;';
        modal.innerHTML = `
          <button onclick="this.parentElement.remove()" style="position:absolute;top:20px;right:20px;background:rgba(255,255,255,0.2);border:none;color:white;width:44px;height:44px;border-radius:50%;font-size:24px;cursor:pointer;display:flex;align-items:center;justify-content:center;">&times;</button>
          <img src="${src}" style="max-width:90vw;max-height:85vh;object-fit:contain;border-radius:12px;">
        `;
        modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
        document.body.appendChild(modal);
      }
    }

    let cropper = null;

    function changePhoto() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
          if (file.size > 5 * 1024 * 1024) {
            showToast('Image must be under 5MB');
            return;
          }
          showImageCropper(file);
        }
      };
      input.click();
    }

    function showImageCropper(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        const modal = document.createElement('div');
        modal.id = 'pf-cropper-modal';
        modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.95);z-index:100000;display:flex;flex-direction:column;';
        modal.innerHTML = `
          <div style="padding:16px 24px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--pf-border);background:#14142b;">
            <button onclick="closeCropper()" style="background:none;border:none;color:var(--pf-text);font-size:15px;font-weight:600;cursor:pointer;">Cancel</button>
            <h3 style="margin:0;font-size:16px;font-weight:700;color:var(--pf-text);">Adjust Photo</h3>
            <button onclick="uploadCroppedImage()" style="background:none;border:none;color:var(--pf-accent);font-size:15px;font-weight:600;cursor:pointer;" id="pf-crop-done">Done</button>
          </div>
          <div style="flex:1;display:flex;align-items:center;justify-content:center;padding:20px;overflow:hidden;">
            <img id="pf-crop-image" src="${e.target.result}" style="max-width:100%;max-height:calc(100vh - 160px);display:block;">
          </div>
          <div style="padding:16px;background:#14142b;border-top:1px solid var(--pf-border);display:flex;gap:12px;justify-content:center;flex-wrap:wrap;">
            <button onclick="rotateCropper(-90)" class="pf-btn pf-btn-secondary" style="padding:8px 16px;"><i class="fas fa-undo"></i> Rotate</button>
            <button onclick="rotateCropper(90)" class="pf-btn pf-btn-secondary" style="padding:8px 16px;"><i class="fas fa-redo"></i> Rotate</button>
            <button onclick="flipCropper()" class="pf-btn pf-btn-secondary" style="padding:8px 16px;"><i class="fas fa-arrows-alt-h"></i> Flip</button>
            <button onclick="resetCropper()" class="pf-btn pf-btn-secondary" style="padding:8px 16px;"><i class="fas fa-sync"></i> Reset</button>
          </div>
        `;
        document.body.appendChild(modal);

        const image = document.getElementById('pf-crop-image');
        cropper = new Cropper(image, {
          aspectRatio: 1,
          viewMode: 1,
          dragMode: 'move',
          autoCropArea: 1,
          restore: false,
          guides: true,
          center: true,
          highlight: false,
          cropBoxMovable: true,
          cropBoxResizable: true,
          toggleDragModeOnDblclick: false,
        });
      };
      reader.readAsDataURL(file);
    }

    function closeCropper() {
      const modal = document.getElementById('pf-cropper-modal');
      if (modal) {
        if (cropper) { cropper.destroy(); cropper = null; }
        modal.remove();
      }
    }

    function rotateCropper(deg) { if (cropper) cropper.rotate(deg); }
    function flipCropper() { if (cropper) cropper.scaleX(-cropper.getData().scaleX || -1); }
    function resetCropper() { if (cropper) cropper.reset(); }

    async function uploadCroppedImage() {
      if (!cropper) return;
      const doneBtn = document.getElementById('pf-crop-done');
      doneBtn.disabled = true;
      doneBtn.textContent = 'Uploading...';

      try {
        const canvas = cropper.getCroppedCanvas({
          width: 400, height: 400,
          imageSmoothingEnabled: true,
          imageSmoothingQuality: 'high',
        });

        canvas.toBlob(async (blob) => {
          const formData = new FormData();
          formData.append('profile_picture', blob, 'profile.jpg');

          const response = await fetch('/api/users/profile-picture', {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` },
            body: formData
          });

          if (!response.ok) throw new Error('Upload failed');
          const data = await response.json();

          // Update all avatar instances
          document.getElementById('pf-avatar').src = data.profile_picture;
          const editAvatar = document.getElementById('pf-edit-avatar');
          if (editAvatar) editAvatar.src = data.profile_picture;

          // Update stored user data
          const storedUser = JSON.parse(localStorage.getItem('user'));
          storedUser.profile_picture = data.profile_picture;
          localStorage.setItem('user', JSON.stringify(storedUser));

          closeCropper();
          showToast('Profile photo updated!');
        }, 'image/jpeg', 0.9);
      } catch (err) {
        console.error('Upload error:', err);
        showToast('Failed to upload photo');
        doneBtn.disabled = false;
        doneBtn.textContent = 'Done';
      }
    }

    // ===== EDIT PROFILE MODAL =====
    function openEditProfileModal() {
      closeSettingsDrawer();
      const user = portfolioUserData;
      if (!user) return;

      const skills = Array.isArray(user.skills) ? user.skills : (user.skills ? JSON.parse(user.skills) : []);
      const interests = Array.isArray(user.interests) ? user.interests : (user.interests ? JSON.parse(user.interests) : []);
      const teams = Array.isArray(user.favorite_teams) ? user.favorite_teams : (user.favorite_teams ? JSON.parse(user.favorite_teams) : []);

      document.getElementById('pf-edit-avatar').src = user.profile_picture || defaultAvatar;
      document.getElementById('pf-edit-fullname').value = user.username || '';
      document.getElementById('pf-edit-bio').value = user.bio || '';
      document.getElementById('pf-edit-skills').value = skills.join(', ');
      document.getElementById('pf-edit-interests').value = interests.join(', ');
      document.getElementById('pf-edit-teams').value = teams.join(', ');
      updateBioCount();
      document.getElementById('pf-edit-profile-modal').style.display = 'flex';
    }

    function closeEditProfileModal() {
      document.getElementById('pf-edit-profile-modal').style.display = 'none';
    }

    function updateBioCount() {
      const bio = document.getElementById('pf-edit-bio');
      const count = document.getElementById('pf-bio-count');
      if (bio && count) count.textContent = bio.value.length;
    }

    document.getElementById('pf-edit-bio')?.addEventListener('input', updateBioCount);

    async function saveEditProfile() {
      try {
        const formData = new FormData();
        formData.append('bio', document.getElementById('pf-edit-bio').value);
        formData.append('skills', JSON.stringify(
          document.getElementById('pf-edit-skills').value.split(',').map(s => s.trim()).filter(s => s)
        ));
        formData.append('interests', JSON.stringify(
          document.getElementById('pf-edit-interests').value.split(',').map(i => i.trim()).filter(i => i)
        ));
        formData.append('favorite_teams', JSON.stringify(
          document.getElementById('pf-edit-teams').value.split(',').map(t => t.trim()).filter(t => t)
        ));

        const response = await fetch('/api/users', {
          method: 'PUT',
          headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` },
          body: formData
        });

        if (!response.ok) throw new Error('Failed to update profile');

        closeEditProfileModal();
        showToast('Profile updated!');

        // Reload portfolio data
        await initPortfolio();
      } catch (err) {
        console.error('Save profile error:', err);
        showToast('Failed to update profile');
      }
    }

    // ===== SETTINGS DRAWER =====
    function openSettingsDrawer() {
      document.getElementById('pf-settings-overlay').classList.add('active');
      document.getElementById('pf-settings-drawer').classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closeSettingsDrawer() {
      document.getElementById('pf-settings-overlay').classList.remove('active');
      document.getElementById('pf-settings-drawer').classList.remove('active');
      document.body.style.overflow = '';
    }

    function loadSettingsState() {
      // Theme - always dark in portfolio but sync toggle state
      const theme = localStorage.getItem('theme') || 'dark';
      if (theme === 'dark') {
        document.getElementById('pf-theme-toggle').classList.add('active');
      } else {
        document.getElementById('pf-theme-toggle').classList.remove('active');
      }

      // Crosspath
      if (localStorage.getItem('crosspath_enabled') === 'true') {
        document.getElementById('pf-crosspath-toggle').classList.add('active');
      }

      // Online status
      if (localStorage.getItem('show_online_status') !== 'false') {
        document.getElementById('pf-online-toggle').classList.add('active');
      }

      // Notifications
      if (localStorage.getItem('notifications_enabled') !== 'false') {
        document.getElementById('pf-notif-toggle').classList.add('active');
      }
    }

    function toggleThemeSetting() {
      const toggle = document.getElementById('pf-theme-toggle');
      toggle.classList.toggle('active');
      const isDark = toggle.classList.contains('active');
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
      if (typeof igTheme !== 'undefined') igTheme.setTheme(isDark ? 'dark' : 'light');
      showToast(`${isDark ? 'Dark' : 'Light'} mode enabled`);
    }

    async function toggleCrosspathSetting() {
      const toggle = document.getElementById('pf-crosspath-toggle');
      const isEnabled = toggle.classList.contains('active');
      toggle.classList.toggle('active');
      localStorage.setItem('crosspath_enabled', !isEnabled);
      showToast(`Crosspath ${!isEnabled ? 'enabled' : 'disabled'}`);
    }

    async function toggleOnlineStatusSetting() {
      const toggle = document.getElementById('pf-online-toggle');
      const isEnabled = toggle.classList.contains('active');

      try {
        await fetch('/api/users/online-status', {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ is_online: !isEnabled })
        });
        toggle.classList.toggle('active');
        localStorage.setItem('show_online_status', !isEnabled);
        showToast(`Online status ${!isEnabled ? 'visible' : 'hidden'}`);
      } catch (err) {
        showToast('Failed to update');
      }
    }

    function toggleNotificationsSetting() {
      const toggle = document.getElementById('pf-notif-toggle');
      const isEnabled = toggle.classList.contains('active');
      toggle.classList.toggle('active');
      localStorage.setItem('notifications_enabled', !isEnabled);
      showToast(`Notifications ${!isEnabled ? 'enabled' : 'disabled'}`);
    }

    function changePasswordSetting() {
      closeSettingsDrawer();
      const oldPw = prompt('Enter current password:');
      if (!oldPw) return;
      const newPw = prompt('Enter new password:');
      if (!newPw) return;
      const confirmPw = prompt('Confirm new password:');
      if (newPw !== confirmPw) { showToast('Passwords do not match'); return; }

      fetch('/api/users/password', {
        method: 'PUT',
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ old_password: oldPw, new_password: newPw })
      })
      .then(res => {
        if (!res.ok) throw new Error('Failed');
        showToast('Password changed!');
      })
      .catch(() => showToast('Failed to change password'));
    }

    async function viewBlockedUsers() {
      closeSettingsDrawer();
      try {
        const res = await fetch('/api/users/blocked/list', {
          headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        });
        if (!res.ok) throw new Error('Failed');
        const data = await res.json();
        const users = data.blocked_users || [];

        document.getElementById('pf-list-title').textContent = 'Blocked Users';
        const body = document.getElementById('pf-list-body');
        if (users.length === 0) {
          body.innerHTML = '<div style="padding:40px;text-align:center;color:var(--pf-text2);">No blocked users</div>';
        } else {
          body.innerHTML = users.map(u => `
            <div class="pf-user-list-item">
              <img class="pf-user-list-avatar" src="${u.profile_picture || defaultAvatar}" alt="${u.username}">
              <div style="flex:1;min-width:0;">
                <div class="pf-user-list-name">${u.username}</div>
              </div>
              <button onclick="unblockUser(${u.id}, this)" style="background:linear-gradient(135deg,var(--pf-accent),var(--pf-accent2));color:white;border:none;padding:6px 14px;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;">Unblock</button>
            </div>
          `).join('');
        }
        document.getElementById('pf-list-modal').style.display = 'flex';
      } catch (err) {
        showToast('Failed to load blocked users');
      }
    }

    async function unblockUser(userId, btn) {
      try {
        await fetch(`/api/users/${userId}/block`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        });
        btn.closest('.pf-user-list-item').remove();
        showToast('User unblocked');
      } catch (err) {
        showToast('Failed to unblock');
      }
    }

    function confirmLogout() {
      closeSettingsDrawer();
      if (confirm('Log out of Innovate Hub?')) {
        fetch('/api/auth/logout', {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        }).finally(() => {
          localStorage.clear();
          window.location.href = '/';
        });
      }
    }

    function confirmDeleteAccount() {
      closeSettingsDrawer();
      if (!confirm('Are you sure? This cannot be undone.')) return;
      const password = prompt('Enter your password to confirm:');
      if (!password) return;

      fetch('/api/users/account', {
        method: 'DELETE',
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ password })
      }).then(res => {
        if (!res.ok) throw new Error('Failed');
        localStorage.clear();
        window.location.href = '/';
      }).catch(() => showToast('Failed to delete account'));
    }

    // ===== FOLLOWERS / FOLLOWING LISTS =====
    function showFollowersList() {
      showFollowersDetailed();
    }

    function showFollowingList() {
      showFollowingDetailed();
    }

    async function showFollowersDetailed() {
      try {
        const res = await fetch(`/api/users/${portfolioUserId}/followers-detailed`, {
          headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        });
        if (!res.ok) {
          // Fallback to basic endpoint
          return showUserList('Followers', `/api/users/${portfolioUserId}/followers`, 'followers');
        }
        const data = await res.json();
        const users = data.followers || [];

        document.getElementById('pf-list-title').textContent = 'Followers';
        const body = document.getElementById('pf-list-body');

        if (users.length === 0) {
          body.innerHTML = `<div style="padding:48px;text-align:center;color:var(--pf-text2);"><i class="fas fa-users" style="font-size:32px;opacity:0.2;display:block;margin-bottom:12px;"></i>No followers yet</div>`;
        } else {
          body.innerHTML = users.map(u => {
            const isFollowingBack = u.is_following_back > 0;
            return `
            <div class="pf-user-list-item" style="cursor:default;">
              <a href="/profile.html?username=${u.username}" style="display:flex;align-items:center;gap:14px;flex:1;min-width:0;text-decoration:none;color:inherit;">
                <img class="pf-user-list-avatar" src="${u.profile_picture || defaultAvatar}" alt="${u.username}">
                <div style="flex:1;min-width:0;">
                  <div class="pf-user-list-name">${u.username}</div>
                  ${u.bio ? `<div class="pf-user-list-bio">${u.bio}</div>` : ''}
                </div>
              </a>
              <div class="pf-user-list-actions">
                ${u.id !== currentUser.id ? `
                  <button class="pf-follow-back-btn ${isFollowingBack ? 'following' : ''}" onclick="event.stopPropagation(); toggleFollowInList(${u.id}, this)">
                    ${isFollowingBack ? 'Following' : 'Follow Back'}
                  </button>
                ` : ''}
                ${isOwnPortfolio && u.id !== currentUser.id ? `
                  <button class="pf-remove-btn" onclick="event.stopPropagation(); removeFollower(${u.id}, this)" title="Remove follower">
                    <i class="fas fa-times"></i>
                  </button>
                ` : ''}
              </div>
            </div>`;
          }).join('');
        }
        document.getElementById('pf-list-modal').style.display = 'flex';
      } catch (err) {
        console.error('List load error:', err);
        showToast('Failed to load followers');
      }
    }

    async function showFollowingDetailed() {
      try {
        const res = await fetch(`/api/users/${portfolioUserId}/following-detailed`, {
          headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        });
        if (!res.ok) {
          return showUserList('Following', `/api/users/${portfolioUserId}/following`, 'following');
        }
        const data = await res.json();
        const users = data.following || [];

        document.getElementById('pf-list-title').textContent = 'Following';
        const body = document.getElementById('pf-list-body');

        if (users.length === 0) {
          body.innerHTML = `<div style="padding:48px;text-align:center;color:var(--pf-text2);"><i class="fas fa-users" style="font-size:32px;opacity:0.2;display:block;margin-bottom:12px;"></i>Not following anyone yet</div>`;
        } else {
          body.innerHTML = users.map(u => `
            <div class="pf-user-list-item" style="cursor:default;">
              <a href="/profile.html?username=${u.username}" style="display:flex;align-items:center;gap:14px;flex:1;min-width:0;text-decoration:none;color:inherit;">
                <img class="pf-user-list-avatar" src="${u.profile_picture || defaultAvatar}" alt="${u.username}">
                <div style="flex:1;min-width:0;">
                  <div class="pf-user-list-name">${u.username}</div>
                  ${u.bio ? `<div class="pf-user-list-bio">${u.bio}</div>` : ''}
                </div>
              </a>
              <div class="pf-user-list-actions">
                <button class="pf-message-btn" onclick="event.stopPropagation(); window.location.href='/messages?user=${u.id}'">
                  Message
                </button>
                <div class="pf-more-btn" onclick="event.stopPropagation(); toggleFollowingMenu(this, ${u.id}, '${u.username}')">
                  <i class="fas fa-ellipsis-v"></i>
                </div>
              </div>
            </div>
          `).join('');
        }
        document.getElementById('pf-list-modal').style.display = 'flex';
      } catch (err) {
        console.error('List load error:', err);
        showToast('Failed to load following');
      }
    }

    function toggleFollowingMenu(btn, userId, username) {
      // Close any existing dropdown
      document.querySelectorAll('.pf-dropdown-menu').forEach(m => m.remove());

      const menu = document.createElement('div');
      menu.className = 'pf-dropdown-menu';
      menu.innerHTML = `
        <button class="pf-dropdown-item danger" onclick="unfollowFromList(${userId}, this)">
          <i class="fas fa-user-minus"></i> Unfollow
        </button>
        <button class="pf-dropdown-item" onclick="muteUser(${userId}, '${username}', this)">
          <i class="fas fa-volume-mute"></i> Mute
        </button>
      `;
      btn.appendChild(menu);

      // Close on outside click
      const closeMenu = (e) => {
        if (!menu.contains(e.target) && e.target !== btn) {
          menu.remove();
          document.removeEventListener('click', closeMenu);
        }
      };
      setTimeout(() => document.addEventListener('click', closeMenu), 10);
    }

    async function toggleFollowInList(userId, btn) {
      const isFollowing = btn.classList.contains('following');
      try {
        const method = isFollowing ? 'DELETE' : 'POST';
        const res = await fetch(`/api/users/${userId}/follow`, {
          method,
          headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        });
        if (!res.ok) throw new Error('Failed');
        btn.classList.toggle('following');
        btn.textContent = btn.classList.contains('following') ? 'Following' : 'Follow Back';
        showToast(btn.classList.contains('following') ? 'Following!' : 'Unfollowed');
      } catch (err) {
        showToast('Failed to update');
      }
    }

    async function removeFollower(userId, btn) {
      if (!confirm('Remove this follower?')) return;
      try {
        const res = await fetch(`/api/users/${userId}/remove-follower`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        });
        if (!res.ok) throw new Error('Failed');
        btn.closest('.pf-user-list-item').remove();
        // Decrease follower count
        const countEl = document.getElementById('pf-followers-count');
        let count = parseInt(countEl.textContent) || 0;
        countEl.textContent = Math.max(0, count - 1);
        showToast('Follower removed');
      } catch (err) {
        showToast('Failed to remove follower');
      }
    }

    async function unfollowFromList(userId, btn) {
      try {
        const res = await fetch(`/api/users/${userId}/follow`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        });
        if (!res.ok) throw new Error('Failed');
        const item = btn.closest('.pf-user-list-item');
        if (item) item.remove();
        const countEl = document.getElementById('pf-following-count');
        let count = parseInt(countEl.textContent) || 0;
        countEl.textContent = Math.max(0, count - 1);
        showToast('Unfollowed');
      } catch (err) {
        showToast('Failed to unfollow');
      }
    }

    async function muteUser(userId, username, btn) {
      try {
        const res = await fetch(`/api/users/${userId}/mute`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        });
        if (!res.ok) throw new Error('Failed');
        // Close dropdown
        const menu = btn.closest('.pf-dropdown-menu');
        if (menu) menu.remove();
        showToast(`${username} muted`);
      } catch (err) {
        showToast('Failed to mute user');
      }
    }

    async function showUserList(title, endpoint, key) {
      try {
        const res = await fetch(endpoint, {
          headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        });
        if (!res.ok) throw new Error('Failed');
        const data = await res.json();
        const users = data[key] || [];

        document.getElementById('pf-list-title').textContent = title;
        const body = document.getElementById('pf-list-body');

        if (users.length === 0) {
          body.innerHTML = `<div style="padding:48px;text-align:center;color:var(--pf-text2);"><i class="fas fa-users" style="font-size:32px;opacity:0.2;display:block;margin-bottom:12px;"></i>No ${title.toLowerCase()} yet</div>`;
        } else {
          body.innerHTML = users.map(u => `
            <a class="pf-user-list-item" href="/profile.html?username=${u.username}">
              <img class="pf-user-list-avatar" src="${u.profile_picture || defaultAvatar}" alt="${u.username}">
              <div style="flex:1;min-width:0;">
                <div class="pf-user-list-name">${u.username}</div>
                ${u.bio ? `<div class="pf-user-list-bio">${u.bio}</div>` : ''}
              </div>
            </a>
          `).join('');
        }
        document.getElementById('pf-list-modal').style.display = 'flex';
      } catch (err) {
        console.error('List load error:', err);
        showToast('Failed to load list');
      }
    }

    function closeListModal() {
      document.getElementById('pf-list-modal').style.display = 'none';
    }

    // ===== PORTFOLIO PROJECTS (existing) =====
    async function loadProjects() {
      try {
        const res = await fetch(`/api/portfolio/${portfolioUserId}/projects`, {
          headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        });
        if (!res.ok) {
          portfolioProjects = [];
        } else {
          const data = await res.json();
          portfolioProjects = data.projects || [];
        }
      } catch {
        portfolioProjects = [];
      }

      renderProjects();
    }

    function renderProjects() {
      const grid = document.getElementById('pf-projects-grid');
      document.getElementById('pf-projects-count').textContent = portfolioProjects.length;

      if (portfolioProjects.length === 0 && !isOwnPortfolio) {
        grid.innerHTML = `<div class="pf-empty" style="grid-column:1/-1;">
          <i class="fas fa-folder-open"></i>
          <h3>No projects yet</h3>
          <p>This user hasn't added any projects to their portfolio.</p>
        </div>`;
        return;
      }

      let html = '';
      portfolioProjects.forEach(p => {
        const tags = p.technologies ? p.technologies.split(',').map(t => t.trim()).filter(t => t) : [];
        html += `<div class="pf-project-card pf-3d-tilt" onclick="openProjectUrl('${p.url || '#'}')">
          ${p.thumbnail
            ? `<img class="pf-project-thumb" src="${p.thumbnail}" alt="${p.name}" onerror="this.outerHTML='<div class=\\'pf-project-thumb-placeholder\\'><i class=\\'fas fa-code\\'></i></div>'">`
            : `<div class="pf-project-thumb-placeholder"><i class="fas fa-code"></i></div>`
          }
          <div class="pf-project-body">
            <div class="pf-project-title">${p.name}</div>
            <div class="pf-project-desc">${p.description || 'No description'}</div>
            ${tags.length > 0 ? `<div class="pf-project-tags">${tags.map(t => `<span class="pf-project-tag">${t}</span>`).join('')}</div>` : ''}
            <div class="pf-project-footer">
              ${p.url ? `<a href="${p.url}" target="_blank" class="pf-project-link" onclick="event.stopPropagation()">View Project <i class="fas fa-arrow-right"></i></a>` : '<span></span>'}
              ${isOwnPortfolio ? `<div style="display:flex;gap:8px;">
                <button onclick="event.stopPropagation();editProject(${p.id})" style="background:none;border:none;color:var(--pf-text2);cursor:pointer;font-size:14px;" title="Edit"><i class="fas fa-pen"></i></button>
                <button onclick="event.stopPropagation();deleteProject(${p.id})" style="background:none;border:none;color:#ef4444;cursor:pointer;font-size:14px;" title="Delete"><i class="fas fa-trash"></i></button>
              </div>` : `<span class="pf-project-date">${p.created_at ? new Date(p.created_at).toLocaleDateString() : ''}</span>`}
            </div>
          </div>
        </div>`;
      });

      if (isOwnPortfolio) {
        html += `<div class="pf-project-add" onclick="openProjectModal()">
          <i class="fas fa-plus-circle"></i>
          <span>Add a project</span>
        </div>`;
      }

      grid.innerHTML = html;
      initTilt3D();
    }

    function openProjectUrl(url) {
      if (url && url !== '#') window.open(url, '_blank');
    }

    let currentViewPostId = null;

    async function viewPost(postId) {
      currentViewPostId = postId;
      const modal = document.getElementById('pf-post-modal');
      modal.classList.add('active');
      document.body.style.overflow = 'hidden';

      try {
        const [postRes, commentsRes] = await Promise.all([
          fetch(`/api/posts/${postId}`, { headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` } }),
          fetch(`/api/posts/${postId}/comments`, { headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` } })
        ]);

        if (!postRes.ok) { showToast('Post not found'); closePostModal(); return; }

        const postData = await postRes.json();
        const post = postData.post;
        const commentsData = commentsRes.ok ? await commentsRes.json() : { comments: [] };
        const comments = commentsData.comments || [];
        const postOwnerId = commentsData.post_user_id || post.user_id;

        // Store post owner id for comment rendering
        window._profilePostOwnerId = postOwnerId;

        // Header
        document.getElementById('pf-post-avatar').src = post.profile_picture || defaultAvatar;
        document.getElementById('pf-post-username').textContent = post.username;
        document.getElementById('pf-post-time').textContent = formatTimeAgo(post.created_at);
        document.getElementById('pf-post-user-link').href = `/profile/${post.user_id}`;

        // Show 3-dot menu only for own posts
        const threeDotContainer = document.getElementById('pf-post-3dot-container');
        if (post.user_id === currentUser.id) {
          threeDotContainer.style.display = 'block';
        } else {
          threeDotContainer.style.display = 'none';
        }
        // Close any open menu
        document.getElementById('pf-post-menu-dropdown').style.display = 'none';

        // Images / Video
        const imagesDiv = document.getElementById('pf-post-images');
        const images = Array.isArray(post.images) ? post.images : [];
        if (images.length > 1) {
          let idx = 0;
          imagesDiv.innerHTML = `
            <div class="pf-post-modal-carousel">
              <div class="pf-post-modal-carousel-track" id="pf-carousel-track">
                ${images.map(img => `<img src="${img}" alt="Post" onerror="this.style.display='none'">`).join('')}
              </div>
              <button class="pf-post-carousel-btn prev" onclick="slidePostCarousel(-1)">&#8249;</button>
              <button class="pf-post-carousel-btn next" onclick="slidePostCarousel(1)">&#8250;</button>
            </div>`;
          window._postCarouselIdx = 0;
        } else if (images.length === 1) {
          imagesDiv.innerHTML = `<img src="${images[0]}" alt="Post" onerror="this.style.display='none'">`;
        } else if (post.video_url) {
          imagesDiv.innerHTML = `<video src="${post.video_url}" controls></video>`;
        } else {
          imagesDiv.innerHTML = '';
        }

        // Content
        document.getElementById('pf-post-content').textContent = post.content || '';
        if (!post.content) document.getElementById('pf-post-content').style.display = 'none';
        else document.getElementById('pf-post-content').style.display = '';

        // Actions
        const liked = post.user_has_liked > 0;
        const saved = post.is_saved > 0;
        document.getElementById('pf-post-actions').innerHTML = `
          <button class="pf-post-action-btn ${liked ? 'liked' : ''}" id="pf-post-like-btn" onclick="togglePostLike(${post.id})">
            <i class="${liked ? 'fas' : 'far'} fa-heart"></i>
            <span id="pf-post-likes-count">${post.likes_count || 0}</span>
          </button>
          <button class="pf-post-action-btn" onclick="document.getElementById('pf-post-comment-input').focus()">
            <i class="far fa-comment"></i>
            <span>${comments.length}</span>
          </button>
          <button class="pf-post-action-btn" onclick="togglePostSave(${post.id})" id="pf-post-save-btn">
            <i class="${saved ? 'fas' : 'far'} fa-bookmark"></i>
          </button>
        `;

        // Comments - show collapsed with "View all X comments" button
        renderPostComments(comments, postOwnerId);

      } catch (err) {
        console.error('Error loading post:', err);
        showToast('Error loading post');
        closePostModal();
      }
    }

    function toggleProfilePostMenu() {
      const menu = document.getElementById('pf-post-menu-dropdown');
      menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
    }

    async function handleProfileEditPost() {
      document.getElementById('pf-post-menu-dropdown').style.display = 'none';
      showToast('Edit functionality coming soon!');
    }

    async function handleProfileArchivePost() {
      document.getElementById('pf-post-menu-dropdown').style.display = 'none';
      if (!confirm('Archive this post?')) return;
      try {
        const res = await fetch(`/api/posts/${currentViewPostId}/archive`, {
          method: 'PUT',
          headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        });
        if (res.ok) {
          showToast('Post archived');
          closePostModal();
          loadRecentPosts();
          // Update post count
          const countEl = document.getElementById('pf-posts-count');
          if (countEl) countEl.textContent = Math.max(0, parseInt(countEl.textContent) - 1);
        }
      } catch (err) { showToast('Failed to archive'); }
    }

    async function handleProfileDeletePost() {
      document.getElementById('pf-post-menu-dropdown').style.display = 'none';
      if (!confirm('Delete this post permanently?')) return;
      try {
        const res = await fetch(`/api/posts/${currentViewPostId}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        });
        if (res.ok) {
          showToast('Post deleted');
          closePostModal();
          loadRecentPosts();
          const countEl = document.getElementById('pf-posts-count');
          if (countEl) countEl.textContent = Math.max(0, parseInt(countEl.textContent) - 1);
        }
      } catch (err) { showToast('Failed to delete post'); }
    }

    function closePostModal() {
      document.getElementById('pf-post-modal').classList.remove('active');
      document.body.style.overflow = '';
      currentViewPostId = null;
      // Reset reply state
      cancelProfileReply();
    }

    function slidePostCarousel(dir) {
      const track = document.getElementById('pf-carousel-track');
      if (!track) return;
      const total = track.children.length;
      window._postCarouselIdx = Math.max(0, Math.min(total - 1, (window._postCarouselIdx || 0) + dir));
      track.style.transform = `translateX(-${window._postCarouselIdx * 100}%)`;
    }

    let profileReplyTo = null;

    function replyToProfileComment(commentId, username) {
      profileReplyTo = { commentId, username };
      const replyInfo = document.getElementById('pf-post-reply-info');
      const replyUser = document.getElementById('pf-reply-to-username');
      if (replyInfo && replyUser) {
        replyInfo.style.display = 'flex';
        replyUser.textContent = '@' + username;
      }
      const input = document.getElementById('pf-post-comment-input');
      if (input) {
        input.value = `@${username} `;
        input.focus();
      }
    }

    function cancelProfileReply() {
      profileReplyTo = null;
      const replyInfo = document.getElementById('pf-post-reply-info');
      if (replyInfo) replyInfo.style.display = 'none';
    }

    function toggleProfileCommentMenu(commentId) {
      document.querySelectorAll('.pf-comment-3dot-menu').forEach(m => m.style.display = 'none');
      const menu = document.getElementById(`pf-comment-menu-${commentId}`);
      if (menu) menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
    }

    async function deleteProfileComment(commentId, btn) {
      if (!confirm('Delete this comment?')) {
        btn.closest('.pf-comment-3dot-menu').style.display = 'none';
        return;
      }
      try {
        const res = await fetch(`/api/posts/${currentViewPostId}/comments/${commentId}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        });
        if (res.ok) {
          const commentEl = btn.closest('.pf-post-comment');
          if (commentEl) commentEl.remove();
          showToast('Comment deleted');
        }
      } catch (err) { showToast('Failed to delete comment'); }
    }

    function reportProfileComment(commentId) {
      document.querySelectorAll('.pf-comment-3dot-menu').forEach(m => m.style.display = 'none');
      showToast('Comment reported. We will review it.');
    }

    function renderPostComments(comments, postOwnerId) {
      const container = document.getElementById('pf-post-comments');
      if (!comments.length) {
        container.innerHTML = '<p style="color:var(--pf-text2);font-size:13px;padding:8px 0;">No comments yet</p>';
        return;
      }

      // Separate top-level and replies
      const topLevel = comments.filter(c => !c.parent_id);
      const repliesMap = {};
      comments.filter(c => c.parent_id).forEach(c => {
        if (!repliesMap[c.parent_id]) repliesMap[c.parent_id] = [];
        repliesMap[c.parent_id].push(c);
      });

      const renderSingleComment = (c, isReply) => {
        const isOwn = c.user_id === currentUser.id;
        const isPostOwner = currentUser.id === postOwnerId;
        const canDelete = isOwn || isPostOwner;
        const contentWithMentions = (c.content || '').replace(/@(\w+)/g, '<a href="/profile/$1" style="color:var(--pf-accent);text-decoration:none;font-weight:600;">@$1</a>');
        const avatarSize = isReply ? '24px' : '32px';
        const fontSize = isReply ? '12px' : '13px';

        return `
          <div class="pf-post-comment" data-comment-id="${c.id}" style="${isReply ? 'padding: 6px 0;' : ''}">
            <a href="/profile/${c.user_id}" style="flex-shrink:0;text-decoration:none;">
              <img class="pf-post-comment-avatar" src="${c.profile_picture || defaultAvatar}" alt="${c.username}" style="cursor:pointer;width:${avatarSize};height:${avatarSize};">
            </a>
            <div class="pf-post-comment-body" style="flex:1;min-width:0;">
              <a href="/profile/${c.user_id}" class="pf-post-comment-user" style="text-decoration:none;cursor:pointer;font-size:${fontSize};">${c.username}</a>
              <div class="pf-post-comment-text" style="font-size:${fontSize};">${contentWithMentions}</div>
              <div style="display:flex;gap:12px;align-items:center;margin-top:4px;">
                <span class="pf-post-comment-time">${formatTimeAgo(c.created_at)}</span>
                <button onclick="replyToProfileComment(${c.id}, '${c.username}')" style="background:none;border:none;color:var(--pf-text2);cursor:pointer;font-size:11px;font-weight:600;padding:0;">Reply</button>
              </div>
            </div>
            <div style="position:relative;flex-shrink:0;align-self:flex-start;margin-top:4px;">
              <button onclick="event.stopPropagation(); toggleProfileCommentMenu(${c.id})" style="background:none;border:none;cursor:pointer;color:var(--pf-text2);padding:4px;">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="5" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="12" cy="19" r="2"/></svg>
              </button>
              <div class="pf-comment-3dot-menu" id="pf-comment-menu-${c.id}" style="display:none;position:absolute;right:0;top:100%;background:var(--pf-card);border:1px solid rgba(255,255,255,0.1);border-radius:12px;box-shadow:0 4px 16px rgba(0,0,0,0.4);z-index:20;min-width:150px;overflow:hidden;">
                <button onclick="document.querySelectorAll('.pf-comment-3dot-menu').forEach(m => m.style.display = 'none'); showToast('Comment liked!')" style="display:flex;align-items:center;gap:8px;width:100%;padding:12px 16px;background:none;border:none;color:var(--pf-text);cursor:pointer;font-size:13px;text-align:left;">
                  <i class="fas fa-heart" style="width:14px;"></i> Like
                </button>
                ${canDelete ? `
                  <button onclick="deleteProfileComment(${c.id}, this)" style="display:flex;align-items:center;gap:8px;width:100%;padding:12px 16px;background:none;border:none;border-top:1px solid rgba(255,255,255,0.06);color:#ef4444;cursor:pointer;font-size:13px;text-align:left;">
                    <i class="fas fa-trash" style="width:14px;"></i> Delete
                  </button>
                ` : ''}
                <button onclick="reportProfileComment(${c.id})" style="display:flex;align-items:center;gap:8px;width:100%;padding:12px 16px;background:none;border:none;border-top:1px solid rgba(255,255,255,0.06);color:var(--pf-text);cursor:pointer;font-size:13px;text-align:left;">
                  <i class="fas fa-flag" style="width:14px;"></i> Report
                </button>
              </div>
            </div>
          </div>`;
      };

      const renderThreaded = (commentsList) => {
        let html = '';
        const topLevelFiltered = commentsList.filter(c => !c.parent_id);
        topLevelFiltered.forEach(c => {
          html += renderSingleComment(c, false);
          const replies = repliesMap[c.id] || [];
          if (replies.length > 0) {
            html += `<div style="margin-left: 40px; border-left: 2px solid rgba(255,255,255,0.08); padding-left: 8px;">`;
            replies.forEach(r => {
              html += renderSingleComment(r, true);
            });
            html += `</div>`;
          }
        });
        // Also render any orphan replies (parent not in current slice)
        const orphans = commentsList.filter(c => c.parent_id && !topLevelFiltered.find(t => t.id === c.parent_id));
        orphans.forEach(c => { html += renderSingleComment(c, false); });
        return html;
      };

      // Show only the latest 2 top-level comments initially, with a "View all" button if there are more
      const showAll = topLevel.length <= 2;
      const visibleTopLevel = showAll ? topLevel : topLevel.slice(-2);
      const visibleComments = showAll ? comments : [...visibleTopLevel, ...visibleTopLevel.flatMap(t => repliesMap[t.id] || [])];

      let html = '';
      if (!showAll) {
        html += `<button id="pf-view-all-comments-btn" onclick="expandAllProfileComments()" style="background:none;border:none;color:var(--pf-text2);cursor:pointer;font-size:13px;padding:8px 0;font-weight:400;">View all ${comments.length} comments</button>`;
        html += `<div id="pf-all-comments-container" style="display:none;">${renderThreaded(comments)}</div>`;
        html += `<div id="pf-preview-comments-container">${renderThreaded(visibleComments)}</div>`;
      } else {
        html += renderThreaded(comments);
      }

      container.innerHTML = html;

      // Store full comments for expanding
      window._profileAllComments = comments;
      window._profileCommentsPostOwnerId = postOwnerId;

      // Close menus on click elsewhere
      container.addEventListener('click', (e) => {
        if (!e.target.closest('.pf-comment-3dot-menu') && !e.target.closest('button[onclick*="toggleProfileCommentMenu"]')) {
          document.querySelectorAll('.pf-comment-3dot-menu').forEach(m => m.style.display = 'none');
        }
      });
    }

    function expandAllProfileComments() {
      const btn = document.getElementById('pf-view-all-comments-btn');
      const allContainer = document.getElementById('pf-all-comments-container');
      const previewContainer = document.getElementById('pf-preview-comments-container');
      if (btn) btn.style.display = 'none';
      if (previewContainer) previewContainer.style.display = 'none';
      if (allContainer) allContainer.style.display = 'block';
    }

    async function togglePostLike(postId) {
      try {
        const btn = document.getElementById('pf-post-like-btn');
        const isLiked = btn.classList.contains('liked');
        const res = await fetch(`/api/posts/${postId}/${isLiked ? 'unlike' : 'like'}`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        });
        if (res.ok) {
          btn.classList.toggle('liked');
          const icon = btn.querySelector('i');
          icon.className = btn.classList.contains('liked') ? 'fas fa-heart' : 'far fa-heart';
          const countEl = document.getElementById('pf-post-likes-count');
          countEl.textContent = parseInt(countEl.textContent) + (btn.classList.contains('liked') ? 1 : -1);
        }
      } catch (err) { console.error('Like error:', err); }
    }

    async function togglePostSave(postId) {
      try {
        const btn = document.getElementById('pf-post-save-btn');
        const isSaved = btn.querySelector('i').classList.contains('fas');
        const res = await fetch(`/api/posts/${postId}/${isSaved ? 'unsave' : 'save'}`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        });
        if (res.ok) {
          btn.querySelector('i').className = isSaved ? 'far fa-bookmark' : 'fas fa-bookmark';
          showToast(isSaved ? 'Post unsaved' : 'Post saved');
        }
      } catch (err) { console.error('Save error:', err); }
    }

    async function submitPostComment() {
      if (!currentViewPostId) return;
      const input = document.getElementById('pf-post-comment-input');
      const content = input.value.trim();
      if (!content) return;

      try {
        let endpoint = `/api/posts/${currentViewPostId}/comments`;
        if (profileReplyTo && profileReplyTo.commentId) {
          endpoint = `/api/posts/${currentViewPostId}/comments/${profileReplyTo.commentId}/reply`;
        }

        const res = await fetch(endpoint, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ content })
        });
        if (res.ok) {
          input.value = '';
          cancelProfileReply();
          // Reload comments
          const commentsRes = await fetch(`/api/posts/${currentViewPostId}/comments`, {
            headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
          });
          if (commentsRes.ok) {
            const data = await commentsRes.json();
            renderPostComments(data.comments || [], data.post_user_id || window._profilePostOwnerId);
          }
        }
      } catch (err) { console.error('Comment error:', err); }
    }

    async function loadRecentPosts() {
      try {
        const res = await fetch(`/api/users/${portfolioUserId}/posts`, {
          headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        });
        if (!res.ok) return;
        const data = await res.json();
        const posts = (data.posts || []).slice(0, 6);
        const grid = document.getElementById('pf-activity-grid');

        if (posts.length === 0) {
          document.getElementById('pf-activity-section').style.display = 'none';
          return;
        }

        grid.innerHTML = posts.map(p => {
          const images = Array.isArray(p.images) ? p.images : (p.images ? JSON.parse(p.images) : []);
          const content = p.content || '';
          const timeAgo = formatTimeAgo(p.created_at);
          const likes = p.likes_count || 0;

          return `<div class="pf-activity-card pf-3d-tilt" onclick="viewPost(${p.id})" style="cursor:pointer;">
            ${images.length > 0
              ? `<img class="pf-activity-img" src="${images[0]}" alt="Post" onerror="this.style.display='none'">`
              : p.video_url
                ? `<div class="pf-activity-img" style="background:linear-gradient(135deg,rgba(102,126,234,0.3),rgba(118,75,162,0.3));display:flex;align-items:center;justify-content:center;"><i class="fas fa-play-circle" style="font-size:36px;color:rgba(255,255,255,0.6);"></i></div>`
                : ''
            }
            <div class="pf-activity-body">
              <div class="pf-activity-text">${content || 'Shared a post'}</div>
              <div class="pf-activity-meta">
                <span><i class="fas fa-heart" style="color:#ef4444;margin-right:4px;"></i> ${likes}</span>
                <span>${timeAgo}</span>
              </div>
            </div>
          </div>`;
        }).join('');

        initTilt3D();
      } catch (err) {
        console.error('Error loading posts:', err);
      }
    }

    // ===== SHOW ALL POSTS (Instagram Grid) =====
    async function showAllPosts() {
      try {
        const res = await fetch(`/api/users/${portfolioUserId}/posts`, {
          headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        });
        if (!res.ok) throw new Error('Failed');
        const data = await res.json();
        const posts = data.posts || [];

        document.getElementById('pf-list-title').textContent = 'Posts';
        const body = document.getElementById('pf-list-body');

        if (posts.length === 0) {
          body.innerHTML = `<div style="padding:48px;text-align:center;color:var(--pf-text2);"><i class="fas fa-camera" style="font-size:40px;opacity:0.2;display:block;margin-bottom:12px;"></i><h3 style="margin-bottom:8px;color:var(--pf-text);">No Posts Yet</h3><p>Posts will appear here.</p></div>`;
        } else {
          body.innerHTML = `<div class="pf-posts-instagram-grid">${posts.map(p => {
            const images = Array.isArray(p.images) ? p.images : [];
            const likes = p.likes_count || 0;
            const comments = p.comments_count || 0;
            return `<div class="pf-posts-grid-item" onclick="viewPost(${p.id})">
              ${images.length > 0
                ? `<img src="${images[0]}" alt="Post" onerror="this.style.display='none'">`
                : p.video_url
                  ? `<div style="width:100%;height:100%;background:linear-gradient(135deg,rgba(102,126,234,0.3),rgba(118,75,162,0.3));display:flex;align-items:center;justify-content:center;"><i class="fas fa-play-circle" style="font-size:32px;color:rgba(255,255,255,0.6);"></i></div>`
                  : `<div class="pf-grid-text-post">${(p.content || 'Post').substring(0, 80)}</div>`
              }
              ${images.length > 1 ? '<span class="pf-grid-multi-icon"><i class="fas fa-clone"></i></span>' : ''}
              <div class="pf-grid-overlay">
                <span class="pf-grid-stat"><i class="fas fa-heart"></i> ${likes}</span>
                <span class="pf-grid-stat"><i class="fas fa-comment"></i> ${comments}</span>
              </div>
            </div>`;
          }).join('')}</div>`;
        }
        document.getElementById('pf-list-modal').style.display = 'flex';
      } catch (err) {
        showToast('Failed to load posts');
      }
    }

    // ===== ARCHIVED POSTS =====
    async function showArchivedPosts() {
      closeSettingsDrawer();
      try {
        const res = await fetch('/api/posts/archived/list', {
          headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        });
        if (!res.ok) throw new Error('Failed');
        const data = await res.json();
        const posts = data.posts || [];

        document.getElementById('pf-list-title').textContent = 'Archived Posts';
        const body = document.getElementById('pf-list-body');

        if (posts.length === 0) {
          body.innerHTML = `<div style="padding:48px;text-align:center;color:var(--pf-text2);"><i class="fas fa-archive" style="font-size:40px;opacity:0.2;display:block;margin-bottom:12px;"></i><h3 style="margin-bottom:8px;color:var(--pf-text);">No Archived Posts</h3><p>Archived posts will appear here.</p></div>`;
        } else {
          body.innerHTML = posts.map(p => {
            const images = Array.isArray(p.images) ? p.images : [];
            return `
            <div class="pf-user-list-item" style="cursor:default;">
              <div style="width:56px;height:56px;border-radius:8px;overflow:hidden;flex-shrink:0;background:var(--pf-card-bg);">
                ${images.length > 0
                  ? `<img src="${images[0]}" style="width:100%;height:100%;object-fit:cover;" onerror="this.style.display='none'">`
                  : `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;"><i class="fas fa-file-alt" style="color:var(--pf-text2);"></i></div>`
                }
              </div>
              <div style="flex:1;min-width:0;">
                <div class="pf-user-list-name">${(p.content || 'Post').substring(0, 40)}${(p.content || '').length > 40 ? '...' : ''}</div>
                <div class="pf-user-list-bio">${formatTimeAgo(p.created_at)} Â· ${p.likes_count || 0} likes Â· ${p.comments_count || 0} comments</div>
              </div>
              <div class="pf-user-list-actions">
                <button class="pf-follow-back-btn" onclick="event.stopPropagation(); unarchivePost(${p.id}, this)" style="background:linear-gradient(135deg,var(--pf-accent),var(--pf-accent2));">
                  <i class="fas fa-undo" style="margin-right:4px;"></i> Unarchive
                </button>
              </div>
            </div>`;
          }).join('');
        }
        document.getElementById('pf-list-modal').style.display = 'flex';
      } catch (err) {
        showToast('Failed to load archived posts');
      }
    }

    async function unarchivePost(postId, btn) {
      try {
        const res = await fetch(`/api/posts/${postId}/unarchive`, {
          method: 'PUT',
          headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        });
        if (!res.ok) throw new Error('Failed');
        btn.closest('.pf-user-list-item').remove();
        showToast('Post unarchived!');
        // Refresh counts
        const countEl = document.getElementById('pf-posts-count');
        let count = parseInt(countEl.textContent) || 0;
        countEl.textContent = count + 1;
      } catch (err) {
        showToast('Failed to unarchive post');
      }
    }

    // ===== SAVED POSTS =====
    async function showSavedPosts() {
      closeSettingsDrawer();
      try {
        const res = await fetch(`/api/users/${currentUser.id}/saved`, {
          headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        });
        if (!res.ok) throw new Error('Failed');
        const data = await res.json();
        const posts = data.posts || [];

        document.getElementById('pf-list-title').textContent = 'Saved Posts';
        const body = document.getElementById('pf-list-body');

        if (posts.length === 0) {
          body.innerHTML = `<div style="padding:48px;text-align:center;color:var(--pf-text2);"><i class="fas fa-bookmark" style="font-size:40px;opacity:0.2;display:block;margin-bottom:12px;"></i><h3 style="margin-bottom:8px;color:var(--pf-text);">No Saved Posts</h3><p>Save posts to see them here.</p></div>`;
        } else {
          body.innerHTML = `<div class="pf-posts-instagram-grid">${posts.map(p => {
            const images = Array.isArray(p.images) ? p.images : [];
            const likes = p.likes_count || 0;
            const comments = p.comments_count || 0;
            return `<div class="pf-posts-grid-item" onclick="viewPost(${p.id})">
              ${images.length > 0
                ? `<img src="${images[0]}" alt="Post" onerror="this.style.display='none'">`
                : p.video_url
                  ? `<div style="width:100%;height:100%;background:linear-gradient(135deg,rgba(102,126,234,0.3),rgba(118,75,162,0.3));display:flex;align-items:center;justify-content:center;"><i class="fas fa-play-circle" style="font-size:32px;color:rgba(255,255,255,0.6);"></i></div>`
                  : `<div class="pf-grid-text-post">${(p.content || 'Post').substring(0, 80)}</div>`
              }
              <div class="pf-grid-overlay">
                <span class="pf-grid-stat"><i class="fas fa-heart"></i> ${likes}</span>
                <span class="pf-grid-stat"><i class="fas fa-comment"></i> ${comments}</span>
              </div>
            </div>`;
          }).join('')}</div>`;
        }
        document.getElementById('pf-list-modal').style.display = 'flex';
      } catch (err) {
        showToast('Failed to load saved posts');
      }
    }

    // ===== Project CRUD (existing) =====
    function openProjectModal(projectId) {
      document.getElementById('pf-edit-project-id').value = '';
      document.getElementById('pf-project-name').value = '';
      document.getElementById('pf-project-desc').value = '';
      document.getElementById('pf-project-tech').value = '';
      document.getElementById('pf-project-url').value = '';
      document.getElementById('pf-project-thumb').value = '';
      document.getElementById('pf-modal-title').textContent = 'Add Project';
      document.getElementById('pf-project-modal').style.display = 'flex';
    }

    function closeProjectModal() {
      document.getElementById('pf-project-modal').style.display = 'none';
    }

    function editProject(id) {
      const p = portfolioProjects.find(x => x.id === id);
      if (!p) return;
      document.getElementById('pf-edit-project-id').value = id;
      document.getElementById('pf-project-name').value = p.name || '';
      document.getElementById('pf-project-desc').value = p.description || '';
      document.getElementById('pf-project-tech').value = p.technologies || '';
      document.getElementById('pf-project-url').value = p.url || '';
      document.getElementById('pf-project-thumb').value = p.thumbnail || '';
      document.getElementById('pf-modal-title').textContent = 'Edit Project';
      document.getElementById('pf-project-modal').style.display = 'flex';
    }

    async function saveProject() {
      const id = document.getElementById('pf-edit-project-id').value;
      const body = {
        name: document.getElementById('pf-project-name').value.trim(),
        description: document.getElementById('pf-project-desc').value.trim(),
        technologies: document.getElementById('pf-project-tech').value.trim(),
        url: document.getElementById('pf-project-url').value.trim(),
        thumbnail: document.getElementById('pf-project-thumb').value.trim()
      };

      if (!body.name) return alert('Project name is required');

      try {
        const method = id ? 'PUT' : 'POST';
        const url = id ? `/api/portfolio/projects/${id}` : '/api/portfolio/projects';
        const res = await fetch(url, {
          method,
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(body)
        });

        if (!res.ok) throw new Error('Failed to save project');
        closeProjectModal();
        await loadProjects();
        showToast(id ? 'Project updated!' : 'Project added!');
      } catch (err) {
        console.error('Save project error:', err);
        showToast('Failed to save project');
      }
    }

    async function deleteProject(id) {
      if (!confirm('Delete this project?')) return;
      try {
        const res = await fetch(`/api/portfolio/projects/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        });
        if (!res.ok) throw new Error('Failed to delete');
        await loadProjects();
        showToast('Project deleted');
      } catch (err) {
        console.error('Delete project error:', err);
        showToast('Failed to delete project');
      }
    }

    // ===== Animations (existing) =====
    function initScrollReveal() {
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            entry.target.classList.add('visible');
          }
        });
      }, { threshold: 0.1 });

      document.querySelectorAll('.pf-reveal').forEach(el => observer.observe(el));
      setTimeout(() => {
        document.querySelectorAll('.pf-reveal').forEach((el, i) => {
          setTimeout(() => el.classList.add('visible'), i * 120);
        });
      }, 100);
    }

    function initTilt3D() {
      document.querySelectorAll('.pf-3d-tilt').forEach(card => {
        if (card._tiltBound) return;
        card._tiltBound = true;

        card.addEventListener('mousemove', (e) => {
          const rect = card.getBoundingClientRect();
          const x = e.clientX - rect.left;
          const y = e.clientY - rect.top;
          const centerX = rect.width / 2;
          const centerY = rect.height / 2;
          const rotateX = ((y - centerY) / centerY) * -8;
          const rotateY = ((x - centerX) / centerX) * 8;
          card.style.transform = `perspective(800px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) translateY(-4px) scale(1.02)`;
        });

        card.addEventListener('mouseleave', () => {
          card.style.transform = '';
          card.style.transition = 'transform 0.5s ease';
          setTimeout(() => { card.style.transition = ''; }, 500);
        });
      });
    }

    function animateCounters() {
      document.querySelectorAll('.pf-stat-number').forEach(el => {
        const target = parseInt(el.textContent) || 0;
        if (target === 0) return;
        let current = 0;
        const step = Math.max(1, Math.floor(target / 30));
        const interval = setInterval(() => {
          current += step;
          if (current >= target) { current = target; clearInterval(interval); }
          el.textContent = current;
        }, 30);
      });
    }

    function formatTimeAgo(dateStr) {
      const date = new Date(dateStr);
      const now = new Date();
      const diff = Math.floor((now - date) / 1000);
      if (diff < 60) return 'just now';
      if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
      if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
      if (diff < 604800) return Math.floor(diff / 86400) + 'd ago';
      return date.toLocaleDateString();
    }

    function sharePortfolio() {
      const url = window.location.href;
      if (navigator.share) {
        navigator.share({ title: 'Profile', url });
      } else {
        navigator.clipboard.writeText(url);
        showToast('Link copied!');
      }
    }

    // ESC key handler for all modals/drawers
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeEditProfileModal();
        closeProjectModal();
        closeListModal();
        closeSettingsDrawer();
        closeCropper();
      }
    });

    // Init
    initPortfolio();
  </script>
</body>
</html>

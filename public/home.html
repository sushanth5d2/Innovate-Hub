<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Innovate</title>
  <link rel="stylesheet" href="/css/instagram.css">
  <link rel="stylesheet" href="/css/post-interactions.css">
</head>
<body>
  <!-- Top Navigation -->
  <nav class="ig-top-nav ig-home-nav">
    <div class="ig-nav-container">
      <div class="ig-nav-left">
        <a href="/home" class="ig-logo">Innovate</a>
        <svg class="ig-logo-dropdown" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
      </div>

      <div class="ig-nav-icons">
        <div class="ig-nav-icon" onclick="window.location.href='/notifications'">
          <svg aria-label="Notifications" fill="currentColor" height="24" viewBox="0 0 24 24" width="24">
            <path d="M16.792 3.904A4.989 4.989 0 0 1 21.5 9.122c0 3.072-2.652 4.959-5.197 7.222-2.512 2.243-3.865 3.469-4.303 3.752-.477-.309-2.143-1.823-4.303-3.752C5.141 14.072 2.5 12.167 2.5 9.122a4.989 4.989 0 0 1 4.708-5.218 4.21 4.21 0 0 1 3.675 1.941c.84 1.175.98 1.763 1.12 1.763s.278-.588 1.11-1.766a4.17 4.17 0 0 1 3.679-1.938m0-2a6.04 6.04 0 0 0-4.797 2.127 6.052 6.052 0 0 0-4.787-2.127A6.985 6.985 0 0 0 .5 9.122c0 3.61 2.55 5.827 5.015 7.97.283.246.569.494.853.747l1.027.918a44.998 44.998 0 0 0 3.518 3.018 2 2 0 0 0 2.174 0 45.263 45.263 0 0 0 3.626-3.115l.922-.824c.293-.26.59-.519.885-.774 2.334-2.025 4.98-4.32 4.98-7.94a6.985 6.985 0 0 0-6.708-7.218Z"></path>
          </svg>
          <span class="ig-notification-dot" id="notificationDot" style="display: none;"></span>
        </div>

        <div class="ig-nav-icon" onclick="window.location.href='/messages'">
          <svg aria-label="Messenger" fill="currentColor" height="24" viewBox="0 0 24 24" width="24">
            <path d="M12.003 2.001a9.705 9.705 0 1 1 0 19.4 10.876 10.876 0 0 1-2.895-.384.798.798 0 0 0-.533.04l-1.984.876a.801.801 0 0 1-1.123-.708l-.054-1.78a.806.806 0 0 0-.27-.569 9.49 9.49 0 0 1-3.14-7.175 9.65 9.65 0 0 1 10-9.7Z" fill="none" stroke="currentColor" stroke-miterlimit="10" stroke-width="1.739"></path>
            <path d="M17.79 10.132a.659.659 0 0 0-.962-.873l-2.556 2.05a.63.63 0 0 1-.758.002L11.06 9.47a1.576 1.576 0 0 0-2.277.42l-2.567 3.98a.659.659 0 0 0 .961.875l2.556-2.049a.63.63 0 0 1 .759-.002l2.452 1.84a1.576 1.576 0 0 0 2.278-.42Z" fill-rule="evenodd"></path>
          </svg>
          <span class="ig-notification-dot" id="messageDot" style="display: none;"></span>
        </div>
      </div>
    </div>
  </nav>

  <!-- Hidden search input for JS compatibility -->
  <input type="text" id="searchInput" style="display:none;">

  <!-- Main Content -->
  <main class="ig-main">
    <!-- Stories -->
    <div class="ig-stories ig-stories-flush">
      <div class="ig-stories-scroll" id="storiesContainer">
        <div class="ig-story ig-add-story" onclick="openCreateStoryModal()">
          <div class="ig-story-ring">
            <img id="myStoryAvatar" src="" alt="Your story" class="ig-story-avatar">
          </div>
          <div class="ig-add-story-btn">+</div>
          <div class="ig-story-username">Your story</div>
        </div>
      </div>
    </div>

    <!-- Posts Feed -->
    <div id="postsFeed"></div>
  </main>

  <!-- Bottom Navigation -->
  <nav class="ig-bottom-nav">
    <a href="/home" class="ig-bottom-nav-item active">
      <svg aria-label="Home" viewBox="0 0 24 24" width="24">
        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
        <polyline points="9 22 9 12 15 12 15 22" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <span class="ig-bottom-nav-label">Home</span>
    </a>
    <a href="/communities" class="ig-bottom-nav-item">
      <svg aria-label="Communities" viewBox="0 0 24 24" width="24">
        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
        <circle cx="9" cy="7" r="4" stroke="currentColor" stroke-width="2" fill="none"/>
        <path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <span class="ig-bottom-nav-label">Communities</span>
    </a>
    <a href="/events" class="ig-bottom-nav-item">
      <svg aria-label="Events" viewBox="0 0 24 24" width="24">
        <rect x="3" y="4" width="18" height="18" rx="2" ry="2" stroke="currentColor" stroke-width="2" fill="none"/>
        <line x1="16" y1="2" x2="16" y2="6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <line x1="8" y1="2" x2="8" y2="6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <line x1="3" y1="10" x2="21" y2="10" stroke="currentColor" stroke-width="2"/>
      </svg>
      <span class="ig-bottom-nav-label">Events</span>
    </a>
    <button class="ig-bottom-nav-item" onclick="openCreatePostModal()" style="background: none; border: none; cursor: pointer;">
      <svg aria-label="Create" viewBox="0 0 24 24" width="24">
        <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"/>
      </svg>
      <span class="ig-bottom-nav-label">Create</span>
    </button>
    <a href="/search" class="ig-bottom-nav-item" id="searchCreatorSeriesTab">
      <svg aria-label="Explore" viewBox="0 0 24 24" width="24">
        <circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2" fill="none"/>
        <line x1="21" y1="21" x2="16.65" y2="16.65" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
      <span class="ig-bottom-nav-label">Explore</span>
    </a>
    <a href="/social-service" class="ig-bottom-nav-item">
      <svg aria-label="Social Service" viewBox="0 0 24 24" width="24">
        <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <span class="ig-bottom-nav-label">Service</span>
    </a>
    <a href="#" class="ig-bottom-nav-item" id="profileNavLink" onclick="navigateToProfile(event)">
      <svg aria-label="Profile" viewBox="0 0 24 24" width="24">
        <circle cx="12" cy="7" r="4" stroke="currentColor" stroke-width="2" fill="none"/>
        <path d="M5.5 21v-2a7.5 7.5 0 0 1 13 0v2" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/>
      </svg>
      <span class="ig-bottom-nav-label">Profile</span>
    </a>
  </nav>

  <script>
    function navigateToProfile(e) {
      e.preventDefault();
      const user = InnovateAPI.getCurrentUser();
      if (user && user.id) {
        window.location.href = `/profile/${user.id}`;
      }
    }
    
    // Open Creator Series from sessionStorage (when navigating from search/explore page)
    function checkOpenCreatorSeriesFromSession() {
      const creatorSeriesPosts = sessionStorage.getItem('openCreatorSeriesPosts');
      const creatorSeriesIndex = sessionStorage.getItem('openCreatorSeriesIndex');
      if (creatorSeriesPosts && creatorSeriesIndex !== null) {
        sessionStorage.removeItem('openCreatorSeriesPosts');
        sessionStorage.removeItem('openCreatorSeriesIndex');
        try {
          const posts = JSON.parse(creatorSeriesPosts);
          setTimeout(() => {
            PostRenderer.openFullScreenViewer(posts, parseInt(creatorSeriesIndex) || 0);
            setTimeout(() => {
              const header = document.querySelector('.ig-fullscreen-header span');
              if (header) header.textContent = 'Creator Series';
            }, 50);
          }, 500);
        } catch(e) { console.error('Error opening creator series:', e); }
      }
    }
    window.addEventListener('load', checkOpenCreatorSeriesFromSession);
  </script>

  <!-- Unified Post Modal (Create & Edit) — powered by post-modal.js -->
  <div id="postModalContainer"></div>

  <!-- Legacy Create Post Modal removed — now unified in PostModal -->

  <style>
    /* ===== Caption Link/Hashtag/Mention Styling ===== */
    .ig-caption-link {
      color: #00376b;
      color: var(--ig-link-color, #e0f1ff);
      text-decoration: none;
      cursor: pointer;
    }
    .ig-caption-link:hover {
      text-decoration: underline;
    }

    /* ===== Create Post Modal - Instagram-Style ===== */
    .cp-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.85);
      z-index: 10001;
      display: flex; align-items: center; justify-content: center;
      animation: cpFadeIn 0.2s ease;
      padding: 16px;
    }
    @keyframes cpFadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes cpSlideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    .cp-container {
      background: var(--ig-primary-background);
      border-radius: 16px;
      width: 100%; max-width: 520px; max-height: 90vh;
      display: flex; flex-direction: column;
      animation: cpSlideUp 0.3s ease;
      overflow: hidden;
      border: 1px solid var(--ig-border);
    }

    /* Header */
    .cp-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 12px 16px;
      border-bottom: 1px solid var(--ig-border);
      min-height: 52px;
    }
    .cp-header-btn {
      background: none; border: none; color: var(--ig-primary-text);
      cursor: pointer; padding: 4px; display: flex; align-items: center;
      border-radius: 50%; transition: background 0.2s;
    }
    .cp-header-btn:hover { background: var(--ig-hover); }
    .cp-header-title {
      font-size: 16px; font-weight: 600; color: var(--ig-primary-text);
      margin: 0;
    }
    .cp-share-btn {
      background: none; border: none; color: var(--ig-blue);
      font-size: 14px; font-weight: 600; cursor: pointer;
      padding: 8px 16px; border-radius: 8px;
      transition: all 0.2s;
    }
    .cp-share-btn:hover { background: rgba(0,149,246,0.1); }
    .cp-share-btn:disabled { opacity: 0.4; cursor: default; }
    .cp-share-btn.cp-sharing {
      color: var(--ig-secondary-text);
      pointer-events: none;
    }

    /* ===== Post/Creator Series Tab Bar ===== */
    .cr-tab-bar {
      display: flex;
      border-bottom: 1px solid var(--ig-border);
      background: var(--ig-primary-background);
    }
    .cr-tab {
      flex: 1;
      display: flex; align-items: center; justify-content: center; gap: 6px;
      padding: 12px 0;
      background: none; border: none;
      color: var(--ig-secondary-text);
      font-size: 14px; font-weight: 600;
      cursor: pointer;
      position: relative;
      transition: color 0.2s;
    }
    .cr-tab:hover { color: var(--ig-primary-text); }
    .cr-tab.active { color: var(--ig-primary-text); }
    .cr-tab.active::after {
      content: '';
      position: absolute; bottom: 0; left: 0; right: 0;
      height: 2px;
      background: var(--ig-primary-text);
      border-radius: 2px 2px 0 0;
    }
    .cr-tab svg { flex-shrink: 0; }

    /* ===== Creator Series Creation Styles ===== */
    .cr-media-section { }

    /* Upload zone */
    .cr-cseries-upload-zone { padding: 0 16px; }
    .cr-cseries-upload-placeholder {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      padding: 40px 20px;
      border: 2px dashed var(--ig-border);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
      margin: 8px 0;
    }
    .cr-cseries-upload-placeholder:hover {
      border-color: var(--ig-blue);
      background: rgba(0,149,246,0.03);
    }
    .cr-cseries-upload-icon { margin-bottom: 12px; opacity: 0.6; }
    .cr-cseries-upload-text {
      font-size: 16px; font-weight: 600;
      color: var(--ig-primary-text);
      margin: 0 0 4px;
    }
    .cr-cseries-upload-hint {
      font-size: 12px;
      color: var(--ig-secondary-text);
      margin: 0;
    }

    /* Video preview */
    .cr-cseries-preview { padding: 0 16px; }
    .cr-cseries-video-wrap {
      position: relative;
      border-radius: 12px;
      overflow: hidden;
      background: #000;
      max-height: 320px;
      display: flex; align-items: center; justify-content: center;
    }
    .cr-cseries-video {
      width: 100%; max-height: 320px;
      object-fit: contain;
      display: block;
    }
    .cr-cseries-play-overlay {
      position: absolute; inset: 0;
      display: flex; align-items: center; justify-content: center;
      background: rgba(0,0,0,0.25);
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .cr-cseries-video-wrap:hover .cr-cseries-play-overlay { opacity: 1; }
    .cr-cseries-play-overlay.cr-paused { opacity: 1; }
    .cr-cseries-duration {
      position: absolute; bottom: 8px; right: 8px;
      background: rgba(0,0,0,0.7);
      color: #fff; font-size: 12px; font-weight: 600;
      padding: 2px 8px; border-radius: 4px;
    }
    .cr-cseries-change-btn {
      position: absolute; top: 8px; right: 8px;
      display: flex; align-items: center; gap: 4px;
      background: rgba(0,0,0,0.6);
      color: #fff; border: none;
      font-size: 12px; font-weight: 600;
      padding: 6px 10px; border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .cr-cseries-change-btn:hover { background: rgba(0,0,0,0.8); }

    /* Trim section */
    .cr-trim-section {
      margin: 12px 0;
      background: var(--ig-secondary-background);
      border-radius: 10px;
      padding: 12px;
    }
    .cr-trim-header {
      display: flex; align-items: center; gap: 6px;
      font-size: 13px; font-weight: 600;
      color: var(--ig-primary-text);
      margin-bottom: 10px;
    }
    .cr-trim-timeline {
      position: relative;
      height: 48px;
      border-radius: 6px;
      overflow: hidden;
      background: var(--ig-border);
      cursor: pointer;
    }
    .cr-trim-canvas {
      width: 100%; height: 48px;
      display: block;
    }
    .cr-trim-handle {
      position: absolute; top: 0; bottom: 0;
      width: 14px;
      background: var(--ig-blue);
      cursor: ew-resize;
      z-index: 2;
      border-radius: 3px;
      opacity: 0.9;
    }
    .cr-trim-handle::after {
      content: '';
      position: absolute; top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      width: 2px; height: 18px;
      background: #fff;
      border-radius: 1px;
    }
    .cr-trim-start { left: 0; border-radius: 6px 3px 3px 6px; }
    .cr-trim-end { right: 0; border-radius: 3px 6px 6px 3px; }
    .cr-trim-progress {
      position: absolute; top: 0; bottom: 0;
      width: 2px; background: #fff;
      z-index: 3;
      pointer-events: none;
      left: 0;
    }
    .cr-trim-times {
      display: flex; justify-content: space-between;
      font-size: 11px;
      color: var(--ig-secondary-text);
      margin-top: 6px;
      font-variant-numeric: tabular-nums;
    }

    /* Cover selector */
    .cr-cover-section {
      margin: 12px 0;
      background: var(--ig-secondary-background);
      border-radius: 10px;
      padding: 12px;
    }
    .cr-cover-header {
      display: flex; align-items: center; gap: 6px;
      font-size: 13px; font-weight: 600;
      color: var(--ig-primary-text);
      margin-bottom: 10px;
    }
    .cr-cover-thumbnails {
      display: flex; gap: 4px;
      overflow-x: auto;
      padding-bottom: 8px;
      scrollbar-width: thin;
    }
    .cr-cover-thumbnails canvas {
      width: 56px; height: 100px;
      border-radius: 6px;
      cursor: pointer;
      border: 2px solid transparent;
      transition: border-color 0.2s;
      flex-shrink: 0;
      object-fit: cover;
    }
    .cr-cover-thumbnails canvas.cr-cover-selected {
      border-color: var(--ig-blue);
    }
    .cr-cover-preview {
      display: flex; align-items: center; gap: 12px;
      margin-top: 8px;
    }
    .cr-cover-canvas {
      border-radius: 8px;
      background: #000;
      object-fit: cover;
    }
    .cr-cover-hint {
      font-size: 12px;
      color: var(--ig-secondary-text);
      margin: 0;
    }

    /* Audio section */
    .cr-audio-section {
      margin: 12px 0;
      background: var(--ig-secondary-background);
      border-radius: 10px;
      padding: 12px;
    }
    .cr-audio-header {
      display: flex; align-items: center; gap: 6px;
      font-size: 13px; font-weight: 600;
      color: var(--ig-primary-text);
      cursor: pointer;
    }
    .cr-audio-chevron { margin-left: auto; transition: transform 0.3s; }
    .cr-audio-chevron.cr-open { transform: rotate(180deg); }
    .cr-audio-options { padding-top: 8px; }
    .cr-audio-volume {
      display: flex; align-items: center; gap: 10px;
      padding: 8px 0 4px;
    }
    .cr-volume-slider {
      flex: 1;
      -webkit-appearance: none;
      height: 4px;
      background: var(--ig-border);
      border-radius: 2px;
      outline: none;
    }
    .cr-volume-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 16px; height: 16px;
      border-radius: 50%;
      background: var(--ig-blue);
      cursor: pointer;
    }
    .cr-volume-label {
      font-size: 12px;
      color: var(--ig-secondary-text);
      min-width: 36px;
      text-align: right;
    }

    /* Body */
    .cp-body {
      overflow-y: auto; flex: 1;
      padding: 0;
      scrollbar-width: thin;
    }

    /* User Row */
    .cp-user-row {
      display: flex; align-items: center; gap: 12px;
      padding: 14px 16px 6px;
    }
    .cp-avatar {
      width: 36px; height: 36px; border-radius: 50%;
      object-fit: cover; border: 1px solid var(--ig-border);
    }
    .cp-username {
      font-size: 14px; font-weight: 600; color: var(--ig-primary-text);
    }

    /* Caption */
    .cp-caption-wrap { padding: 4px 16px 8px; position: relative; }
    .cp-caption {
      width: 100%; border: none; outline: none; resize: none;
      font-size: 15px; line-height: 1.5;
      color: var(--ig-primary-text);
      background: transparent;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      min-height: 80px;
    }
    .cp-caption::placeholder { color: var(--ig-secondary-text); }
    .cp-char-count {
      text-align: right; font-size: 12px; color: var(--ig-tertiary-text);
      padding-top: 4px;
    }

    /* Hashtag Suggestions */
    .cp-hashtag-suggestions {
      padding: 0 16px 8px;
    }
    .cp-hashtag-header {
      display: flex; align-items: center; gap: 6px;
      font-size: 13px; font-weight: 600; color: var(--ig-secondary-text);
      margin-bottom: 8px;
    }
    .cp-hashtag-list {
      display: flex; flex-wrap: wrap; gap: 6px;
    }
    .cp-hashtag-chip {
      padding: 6px 14px;
      background: rgba(0,149,246,0.1);
      color: var(--ig-blue);
      border: 1px solid rgba(0,149,246,0.2);
      border-radius: 20px;
      font-size: 13px; font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      user-select: none;
    }
    .cp-hashtag-chip:hover {
      background: rgba(0,149,246,0.2);
      border-color: var(--ig-blue);
      transform: translateY(-1px);
    }
    .cp-hashtag-chip.cp-hashtag-added {
      background: var(--ig-blue);
      color: white;
      border-color: var(--ig-blue);
    }

    /* Trending Section */
    .cp-trending-section { padding: 0 16px 8px; }
    .cp-trending-header {
      display: flex; align-items: center; gap: 6px;
      font-size: 13px; font-weight: 600; color: var(--ig-secondary-text);
      cursor: pointer; padding: 6px 0;
      user-select: none;
    }
    .cp-trending-chevron { margin-left: auto; transition: transform 0.3s; }
    .cp-trending-chevron.cp-open { transform: rotate(180deg); }
    .cp-trending-list {
      margin-top: 6px;
    }
    .cp-trending-item {
      display: flex; align-items: center; justify-content: space-between;
      padding: 8px 10px;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .cp-trending-item:hover { background: var(--ig-hover); }
    .cp-trending-tag {
      font-size: 14px; font-weight: 500; color: var(--ig-primary-text);
    }
    .cp-trending-count {
      font-size: 12px; color: var(--ig-secondary-text);
    }

    /* Media Grid */
    .cp-media-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
      gap: 4px;
      padding: 0 16px;
    }
    .cp-media-grid:empty { display: none; }
    .media-preview-item {
      position: relative; border-radius: 8px; overflow: hidden;
      aspect-ratio: 1; background: var(--ig-secondary-background);
    }
    .media-preview-item img, .media-preview-item video {
      width: 100%; height: 100%; object-fit: cover;
    }
    .media-preview-remove {
      position: absolute; top: 6px; right: 6px;
      background: rgba(0,0,0,0.75); color: white;
      border: none; border-radius: 50%;
      width: 26px; height: 26px; cursor: pointer;
      font-size: 14px; display: flex; align-items: center; justify-content: center;
      backdrop-filter: blur(4px);
      transition: transform 0.2s, background 0.2s;
    }
    .media-preview-remove:hover { background: var(--ig-error); transform: scale(1.1); }

    /* Files List */
    .cp-files-list { padding: 0 16px; }
    .cp-files-list:empty { display: none; }
    .file-preview-item {
      display: flex; align-items: center; gap: 10px;
      padding: 10px 12px; margin-bottom: 4px;
      background: var(--ig-secondary-background);
      border-radius: 10px; border: 1px solid var(--ig-border);
    }
    .file-preview-item span:first-child { font-size: 20px; }
    .file-preview-remove {
      margin-left: auto; background: none; border: none;
      color: var(--ig-error); cursor: pointer; font-size: 20px;
      padding: 2px 6px; border-radius: 4px;
      transition: background 0.2s;
    }
    .file-preview-remove:hover { background: rgba(237,73,86,0.1); }

    /* Drop Zone */
    .cp-drop-zone {
      margin: 8px 16px; padding: 32px;
      border: 2px dashed var(--ig-border); border-radius: 12px;
      text-align: center; color: var(--ig-secondary-text);
      transition: all 0.3s;
    }
    .cp-drop-zone.cp-drag-over {
      border-color: var(--ig-blue);
      background: rgba(0,149,246,0.05);
    }
    .cp-drop-zone p { margin-top: 12px; font-size: 14px; }

    /* Toolbar */
    .cp-toolbar {
      display: flex; gap: 0; padding: 8px 8px;
      border-top: 1px solid var(--ig-border);
      border-bottom: 1px solid var(--ig-border);
      margin-top: 8px;
    }
    .cp-tool-btn {
      flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px;
      padding: 10px 4px; background: none; border: none;
      color: var(--ig-primary-text); cursor: pointer;
      border-radius: 10px; transition: all 0.2s;
      font-size: inherit; font-family: inherit;
    }
    .cp-tool-btn:hover { background: var(--ig-hover); }
    .cp-tool-btn.cp-tool-active {
      color: var(--ig-blue);
      background: rgba(0,149,246,0.08);
    }
    .cp-tool-label { font-size: 11px; color: var(--ig-secondary-text); font-weight: 500; }
    .cp-tool-btn:hover .cp-tool-label,
    .cp-tool-btn.cp-tool-active .cp-tool-label { color: var(--ig-blue); }

    /* Sections (Poll, Schedule) */
    .cp-section {
      margin: 0 16px 8px; padding: 14px;
      background: var(--ig-secondary-background);
      border-radius: 12px; border: 1px solid var(--ig-border);
    }
    .cp-section-header {
      display: flex; align-items: center; gap: 8px;
      font-size: 14px; font-weight: 600; color: var(--ig-primary-text);
      margin-bottom: 12px;
    }
    .cp-section-close {
      margin-left: auto; background: none; border: none;
      color: var(--ig-secondary-text); cursor: pointer;
      font-size: 22px; line-height: 1; padding: 0 4px;
      border-radius: 50%; transition: color 0.2s;
    }
    .cp-section-close:hover { color: var(--ig-error); }
    .cp-input {
      width: 100%; padding: 10px 12px;
      background: var(--ig-primary-background);
      border: 1px solid var(--ig-border);
      border-radius: 8px; color: var(--ig-primary-text);
      font-size: 14px; outline: none;
      transition: border-color 0.2s;
    }
    .cp-input:focus { border-color: var(--ig-blue); }
    .cp-input::placeholder { color: var(--ig-tertiary-text); }

    /* Poll Options */
    .cp-poll-options { margin: 10px 0; }
    .cp-poll-option-row {
      display: flex; align-items: center; gap: 10px;
      margin-bottom: 8px;
    }
    .cp-poll-dot {
      width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0;
    }
    .cp-add-option-btn {
      display: flex; align-items: center; gap: 6px;
      background: none; border: none;
      color: var(--ig-blue); font-size: 13px; font-weight: 600;
      cursor: pointer; padding: 6px 0;
      transition: opacity 0.2s;
    }
    .cp-add-option-btn:hover { opacity: 0.7; }
    .cp-poll-expiry {
      display: flex; align-items: center; gap: 8px;
      padding-top: 10px; margin-top: 10px;
      border-top: 1px solid var(--ig-border);
    }
    .cp-datetime-input {
      flex: 1; padding: 8px 10px;
      background: var(--ig-primary-background);
      border: 1px solid var(--ig-border); border-radius: 8px;
      color: var(--ig-primary-text); font-size: 13px;
      outline: none;
    }
    .cp-datetime-input:focus { border-color: var(--ig-blue); }
    .cp-expiry-label { font-size: 13px; color: var(--ig-secondary-text); white-space: nowrap; }

    /* Schedule */
    .cp-schedule-picker { margin-top: 4px; }
    .cp-schedule-hint {
      margin-top: 8px; font-size: 12px; color: var(--ig-secondary-text);
    }

    /* Advanced Options */
    .cp-advanced-toggle {
      display: flex; align-items: center; justify-content: space-between;
      padding: 12px 16px; cursor: pointer;
      color: var(--ig-secondary-text); font-size: 14px;
      border-top: 1px solid var(--ig-border);
      user-select: none;
      transition: color 0.2s;
    }
    .cp-advanced-toggle:hover { color: var(--ig-primary-text); }
    .cp-advanced-toggle svg { transition: transform 0.3s; }
    .cp-advanced-toggle.cp-open svg { transform: rotate(180deg); }

    .cp-advanced { padding: 0 16px 12px; }

    .cp-toggle-row {
      display: flex; align-items: center; justify-content: space-between;
      padding: 12px 0; cursor: pointer;
      border-bottom: 1px solid var(--ig-border);
    }
    .cp-toggle-row:last-child { border-bottom: none; }
    .cp-toggle-info {
      display: flex; align-items: center; gap: 12px;
      font-size: 14px; color: var(--ig-primary-text);
    }

    /* Toggle Switch */
    .cp-switch { position: relative; width: 44px; height: 24px; flex-shrink: 0; }
    .cp-switch input { opacity: 0; width: 0; height: 0; }
    .cp-switch-slider {
      position: absolute; top: 0; left: 0; right: 0; bottom: 0;
      background: var(--ig-border); border-radius: 24px;
      cursor: pointer; transition: all 0.3s;
    }
    .cp-switch-slider::before {
      content: ''; position: absolute;
      width: 20px; height: 20px; left: 2px; bottom: 2px;
      background: white; border-radius: 50%;
      transition: all 0.3s;
    }
    .cp-switch input:checked + .cp-switch-slider {
      background: var(--ig-blue);
    }
    .cp-switch input:checked + .cp-switch-slider::before {
      transform: translateX(20px);
    }

    /* ===== Custom Button Builder ===== */
    .cb-builder {
      margin-top: 14px;
      padding-top: 14px;
      border-top: 1px solid var(--ig-border);
    }
    .cb-builder-header {
      display: flex; align-items: center; gap: 8px;
      font-size: 14px; font-weight: 600; color: var(--ig-primary-text);
      margin-bottom: 10px;
    }
    .cb-name-input {
      margin-bottom: 12px;
      font-weight: 500;
    }
    .cb-check-row {
      display: flex; align-items: center; gap: 0;
      padding: 0; margin-bottom: 8px;
      cursor: pointer; user-select: none;
      position: relative;
    }
    .cb-check-row input[type="checkbox"] {
      position: absolute; opacity: 0; width: 0; height: 0; pointer-events: none;
    }
    .cb-check-label {
      display: flex; align-items: center; gap: 10px;
      width: 100%; padding: 12px 16px;
      background: var(--ig-secondary-background);
      border: 2px solid var(--ig-border);
      border-radius: 12px;
      font-size: 14px; font-weight: 600;
      color: var(--ig-primary-text);
      transition: all 0.25s ease;
    }
    .cb-check-label::after {
      content: ''; margin-left: auto; flex-shrink: 0;
      width: 22px; height: 22px;
      border-radius: 50%;
      border: 2px solid var(--ig-border);
      background: transparent;
      transition: all 0.25s ease;
      box-sizing: border-box;
    }
    .cb-check-row input[type="checkbox"]:checked + .cb-check-label {
      border-color: var(--ig-blue);
      background: rgba(0,149,246,0.08);
      color: var(--ig-blue);
    }
    .cb-check-row input[type="checkbox"]:checked + .cb-check-label::after {
      border-color: var(--ig-blue);
      background: var(--ig-blue);
      box-shadow: inset 0 0 0 3px var(--ig-primary-background);
    }
    .cb-check-row:hover .cb-check-label {
      border-color: rgba(0,149,246,0.5);
      background: rgba(0,149,246,0.04);
    }
    .cb-sub-fields {
      padding: 10px 0 10px 28px;
      animation: cbSlideDown 0.2s ease;
    }
    @keyframes cbSlideDown { from { opacity: 0; transform: translateY(-6px); } to { opacity: 1; transform: translateY(0); } }
    .cb-multi-group { margin-bottom: 10px; }
    .cb-field-label {
      font-size: 12px; font-weight: 600; color: var(--ig-secondary-text);
      text-transform: uppercase; letter-spacing: 0.5px;
      margin-bottom: 6px; display: block;
    }
    .cb-multi-row {
      display: flex; gap: 6px; margin-bottom: 6px;
    }
    .cb-multi-row .cp-input { flex: 1; font-size: 13px; padding: 8px 10px; }
    .cb-add-btn {
      width: 34px; height: 34px; border: 1px solid var(--ig-border);
      background: var(--ig-secondary-background); color: var(--ig-blue);
      border-radius: 8px; cursor: pointer; font-size: 18px; font-weight: 600;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.2s; flex-shrink: 0;
    }
    .cb-add-btn:hover { background: var(--ig-blue); color: white; }
    .cb-remove-btn {
      width: 34px; height: 34px; border: 1px solid var(--ig-border);
      background: var(--ig-secondary-background); color: var(--ig-error, #ed4956);
      border-radius: 8px; cursor: pointer; font-size: 16px;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.2s; flex-shrink: 0;
    }
    .cb-remove-btn:hover { background: var(--ig-error, #ed4956); color: white; }
    .cb-dm-textarea {
      resize: none; font-size: 13px; min-height: 42px;
    }
    .cb-hint {
      font-size: 12px; color: var(--ig-secondary-text);
      margin: 6px 0 0; line-height: 1.4;
    }
    .cb-hire-fields-list {
      display: flex; flex-wrap: wrap; gap: 8px;
      margin: 8px 0;
    }
    .cb-hire-field-check {
      display: flex; align-items: center; gap: 8px;
      font-size: 13px; color: var(--ig-primary-text);
      cursor: pointer; padding: 8px 14px;
      background: var(--ig-secondary-background);
      border: 1.5px solid var(--ig-border);
      border-radius: 10px;
      transition: all 0.2s ease;
      user-select: none;
    }
    .cb-hire-field-check:hover {
      border-color: rgba(0,149,246,0.5);
      background: rgba(0,149,246,0.04);
    }
    .cb-hire-field-check:has(input:checked) {
      border-color: var(--ig-blue);
      background: rgba(0,149,246,0.08);
      color: var(--ig-blue);
    }
    .cb-hire-field-check input {
      accent-color: var(--ig-blue); cursor: pointer;
      width: 16px; height: 16px;
    }
    .cb-custom-fields-area { margin-top: 10px; }
    .cb-custom-field-row {
      display: flex; gap: 6px; margin-bottom: 6px;
    }
    .cb-custom-field-row .cp-input { flex: 1; font-size: 13px; padding: 8px 10px; }

    /* Custom Button on Post */
    .cb-post-button {
      display: block; width: calc(100% - 32px);
      margin: 0 16px 12px; padding: 10px 16px;
      background: linear-gradient(135deg, var(--ig-blue), #6366f1);
      color: white; border: none; border-radius: 8px;
      font-size: 14px; font-weight: 600; cursor: pointer;
      transition: all 0.2s; text-align: center;
    }
    .cb-post-button:hover { opacity: 0.9; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .cb-post-button:active { transform: scale(0.98); }

    /* Custom Button Action Modal */
    .cb-modal-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7);
      z-index: 10002; display: flex;
      align-items: center; justify-content: center;
      padding: 16px; animation: cpFadeIn 0.2s ease;
    }
    .cb-modal {
      background: var(--ig-primary-background);
      border-radius: 16px; width: 100%; max-width: 440px;
      max-height: 85vh; overflow-y: auto;
      animation: cpSlideUp 0.3s ease;
      border: 1px solid var(--ig-border);
    }
    .cb-modal-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 14px 16px; border-bottom: 1px solid var(--ig-border);
    }
    .cb-modal-title { font-size: 16px; font-weight: 700; color: var(--ig-primary-text); margin: 0; }
    .cb-modal-close {
      background: none; border: none; color: var(--ig-primary-text);
      cursor: pointer; font-size: 22px; padding: 4px 8px;
      border-radius: 50%; transition: background 0.2s;
    }
    .cb-modal-close:hover { background: var(--ig-hover); }
    .cb-modal-body { padding: 16px; }
    .cb-modal-section {
      margin-bottom: 18px;
      padding-bottom: 14px;
      border-bottom: 1px solid var(--ig-border);
    }
    .cb-modal-section:last-child { border-bottom: none; margin-bottom: 0; }
    .cb-modal-section-title {
      font-size: 14px; font-weight: 700; color: var(--ig-primary-text);
      margin-bottom: 10px; display: flex; align-items: center; gap: 8px;
    }
    .cb-contact-item {
      display: flex; align-items: center; gap: 10px;
      padding: 8px 12px; margin-bottom: 6px;
      background: var(--ig-secondary-background);
      border-radius: 8px; font-size: 14px; color: var(--ig-primary-text);
      cursor: pointer; transition: background 0.2s;
      text-decoration: none;
    }
    .cb-contact-item:hover { background: var(--ig-hover); }
    .cb-contact-item svg { flex-shrink: 0; }
    .cb-hire-form-group {
      margin-bottom: 12px;
    }
    .cb-hire-form-group label {
      display: block; font-size: 13px; font-weight: 600;
      color: var(--ig-secondary-text); margin-bottom: 4px;
    }
    .cb-hire-form-group input {
      width: 100%; padding: 10px 12px;
      background: var(--ig-secondary-background);
      border: 1px solid var(--ig-border); border-radius: 8px;
      color: var(--ig-primary-text); font-size: 14px; outline: none;
      transition: border-color 0.2s;
    }
    .cb-hire-form-group input:focus { border-color: var(--ig-blue); }
    .cb-dm-input-area { margin-top: 8px; }
    .cb-dm-input-area textarea {
      width: 100%; padding: 10px 12px;
      background: var(--ig-secondary-background);
      border: 1px solid var(--ig-border); border-radius: 8px;
      color: var(--ig-primary-text); font-size: 14px;
      outline: none; resize: none; min-height: 60px;
      font-family: inherit; transition: border-color 0.2s;
    }
    .cb-dm-input-area textarea:focus { border-color: var(--ig-blue); }
    .cb-submit-btn {
      display: block; width: 100%; padding: 12px;
      background: var(--ig-blue); color: white; border: none;
      border-radius: 8px; font-size: 14px; font-weight: 600;
      cursor: pointer; transition: all 0.2s; margin-top: 10px;
    }
    .cb-submit-btn:hover { opacity: 0.9; }
    .cb-submit-btn:disabled { opacity: 0.5; cursor: default; }

    /* Comment to DM items */
    .cdm-item {
      display: flex; gap: 8px; margin-bottom: 8px; align-items: center;
    }
    .cdm-item .cp-input { flex: 1; margin: 0; }
    .cdm-item-remove {
      background: none; border: none; color: var(--ig-error, #ed4956);
      font-size: 18px; cursor: pointer; padding: 4px; line-height: 1;
    }

    /* Responsive */
    @media (max-width: 540px) {
      .cp-container { max-width: 100%; max-height: 100vh; border-radius: 0; height: 100%; }
      .cp-overlay { padding: 0; }
      .cp-media-grid { grid-template-columns: repeat(3, 1fr); }
      .cr-cseries-video-wrap { max-height: 240px; }
      .cr-cseries-video { max-height: 240px; }
      .cr-cover-thumbnails canvas { width: 44px; height: 78px; }
      .cr-tab { font-size: 13px; padding: 10px 0; }
    }

    /* ===== Story Creation Modal ===== */
    .story-create-modal {
      width: 500px;
      max-width: 95vw;
      background: var(--ig-primary-background);
      border-radius: 16px;
      overflow: hidden;
      animation: slideUp 0.3s ease;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    }
    .story-create-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 16px;
      border-bottom: 1px solid var(--ig-border);
    }
    .story-create-close {
      background: none;
      border: none;
      color: var(--ig-primary-text);
      cursor: pointer;
      padding: 4px;
      display: flex;
      align-items: center;
    }
    .story-create-title {
      font-weight: 700;
      font-size: 16px;
      color: var(--ig-primary-text);
    }
    .story-create-share {
      background: var(--ig-blue);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 7px 18px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    .story-create-share:hover { opacity: 0.85; }
    .story-create-share:active { transform: scale(0.97); }
    .story-create-body { padding: 16px; }
    .story-create-preview {
      width: 100%;
      aspect-ratio: 9/16;
      max-height: 420px;
      border-radius: 12px;
      overflow: hidden;
      background: linear-gradient(135deg, #833ab4, #fd1d1d, #fcb045);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      margin-bottom: 16px;
    }
    .story-preview-content {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .story-preview-content img,
    .story-preview-content video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 0;
    }
    .story-preview-placeholder {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      color: rgba(255,255,255,0.8);
      position: absolute;
      pointer-events: none;
    }
    .story-preview-icon { opacity: 0.7; }
    .story-preview-hint {
      font-size: 14px;
      opacity: 0.8;
      margin: 0;
    }
    .story-create-inputs { display: flex; flex-direction: column; gap: 12px; }
    .story-create-textarea {
      width: 100%;
      background: var(--ig-secondary-background);
      border: 1px solid var(--ig-border);
      border-radius: 10px;
      padding: 12px 14px;
      color: var(--ig-primary-text);
      font-size: 14px;
      font-family: inherit;
      resize: none;
      outline: none;
      transition: border-color 0.2s;
      box-sizing: border-box;
    }
    .story-create-textarea:focus { border-color: var(--ig-blue); }
    .story-create-textarea::placeholder { color: var(--ig-secondary-text); }
    .story-create-charcount {
      text-align: right;
      font-size: 12px;
      color: var(--ig-secondary-text);
      margin-top: -8px;
    }
    .story-create-upload {
      cursor: pointer;
      display: block;
    }
    .story-upload-btn {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 14px;
      border-radius: 10px;
      border: 1.5px dashed var(--ig-border);
      color: var(--ig-blue);
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
    }
    .story-upload-btn:hover {
      border-color: var(--ig-blue);
      background: rgba(0,149,246,0.05);
    }
    .story-upload-hint {
      font-size: 12px;
      color: var(--ig-secondary-text);
      margin-left: auto;
      font-weight: 400;
    }
    .story-create-colors {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .story-color-label {
      font-size: 13px;
      color: var(--ig-secondary-text);
      font-weight: 500;
      white-space: nowrap;
    }
    .story-color-options { display: flex; gap: 8px; }
    .story-color-btn {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: 2px solid transparent;
      cursor: pointer;
      transition: all 0.2s;
      padding: 0;
    }
    .story-color-btn:hover { transform: scale(1.15); }
    .story-color-btn.active {
      border-color: var(--ig-blue);
      box-shadow: 0 0 0 2px var(--ig-primary-background), 0 0 0 4px var(--ig-blue);
    }

    /* ===== Post Actions Modal ===== */
    .post-actions-sheet {
      width: 400px;
      max-width: 92vw;
      background: var(--ig-primary-background);
      border-radius: 16px;
      overflow: hidden;
      animation: slideUp 0.25s ease;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    }
    .post-actions-header {
      text-align: center;
      padding: 16px 16px 0;
    }
    .post-actions-handle {
      width: 40px;
      height: 4px;
      background: var(--ig-border);
      border-radius: 4px;
      margin: 0 auto 12px;
    }
    .post-actions-list {
      padding: 4px 0 8px;
    }
    .post-action-item {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 14px 20px;
      cursor: pointer;
      transition: background 0.15s;
      color: var(--ig-primary-text);
      font-size: 15px;
    }
    .post-action-item:hover {
      background: var(--ig-hover);
    }
    .post-action-item .action-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--ig-secondary-background);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .post-action-item .action-icon svg {
      width: 20px;
      height: 20px;
    }
    .post-action-item.danger {
      color: #ed4956;
    }
    .post-action-item.danger .action-icon {
      background: rgba(237,73,86,0.1);
    }
    .post-actions-cancel {
      display: block;
      width: 100%;
      padding: 16px;
      text-align: center;
      border: none;
      border-top: 1px solid var(--ig-border);
      background: none;
      color: var(--ig-primary-text);
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.15s;
    }
    .post-actions-cancel:hover { background: var(--ig-hover); }

    /* ===== PDF Modal Viewer ===== */
    .pdf-viewer-modal {
      width: 92vw;
      max-width: 1000px;
      height: 90vh;
      max-height: 900px;
      background: var(--ig-primary-background);
      border-radius: 16px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      animation: slideUp 0.3s ease;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    }
    .pdf-viewer-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 20px;
      border-bottom: 1px solid var(--ig-border);
      flex-shrink: 0;
    }
    .pdf-viewer-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      color: var(--ig-primary-text);
      min-width: 0;
    }
    .pdf-viewer-badge {
      background: #e74c3c;
      color: #fff;
      font-size: 11px;
      font-weight: 700;
      padding: 3px 8px;
      border-radius: 4px;
      letter-spacing: 0.5px;
      flex-shrink: 0;
    }
    .pdf-viewer-name {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-size: 15px;
    }
    .pdf-viewer-close {
      background: var(--ig-secondary-background);
      border: none;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--ig-primary-text);
      font-size: 20px;
      transition: background 0.2s;
      flex-shrink: 0;
    }
    .pdf-viewer-close:hover { background: var(--ig-hover); }
    .pdf-viewer-body {
      flex: 1;
      overflow: auto;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding: 16px;
      background: var(--ig-secondary-background);
    }
    .pdf-viewer-body canvas {
      max-width: 100%;
      height: auto;
      border-radius: 4px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.15);
    }
    .pdf-viewer-controls {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 16px;
      padding: 14px 20px;
      border-top: 1px solid var(--ig-border);
      flex-shrink: 0;
      background: var(--ig-primary-background);
    }
    .pdf-ctrl-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--ig-secondary-background);
      border: 1px solid var(--ig-border);
      color: var(--ig-primary-text);
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .pdf-ctrl-btn:hover { background: var(--ig-hover); }
    .pdf-ctrl-btn:disabled { opacity: 0.3; cursor: default; }
    .pdf-page-indicator {
      font-size: 14px;
      font-weight: 600;
      color: var(--ig-primary-text);
      min-width: 60px;
      text-align: center;
    }
    .pdf-open-btn {
      margin-left: auto;
      padding: 8px 20px;
      background: var(--ig-blue);
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      transition: opacity 0.2s;
    }
    .pdf-open-btn:hover { opacity: 0.85; }

    @media (max-width: 540px) {
      .story-create-modal { max-width: 100%; border-radius: 0; min-height: 100vh; }
      .story-create-preview { max-height: 350px; }
      .post-actions-sheet { max-width: 100%; border-radius: 16px 16px 0 0; position: fixed; bottom: 0; left: 0; right: 0; }
      .pdf-viewer-modal { width: 100%; height: 100%; max-width: 100%; max-height: 100%; border-radius: 0; }
    }
  </style>

  <!-- Create Story Modal -->
  <div id="createStoryModal" class="ig-modal-overlay" style="display: none;" onclick="closeCreateStoryModal(event)">
    <div class="story-create-modal" onclick="event.stopPropagation()">
      <!-- Header -->
      <div class="story-create-header">
        <button class="story-create-close" onclick="closeCreateStoryModal()">
          <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
        <span class="story-create-title">Create Story</span>
        <button class="story-create-share" onclick="submitStory()">Share</button>
      </div>

      <!-- Content Area -->
      <div class="story-create-body">
        <!-- Preview Area -->
        <div class="story-create-preview" id="storyPreviewArea">
          <div id="storyPreview" class="story-preview-content"></div>
          <div class="story-preview-placeholder" id="storyPlaceholder">
            <div class="story-preview-icon">
              <svg width="64" height="64" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                <path d="M12 9v6m3-3H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
            <p class="story-preview-hint">Add a photo or video to your story</p>
          </div>
        </div>

        <!-- Input Area -->
        <div class="story-create-inputs">
          <textarea id="storyContent" class="story-create-textarea" placeholder="Write something..." rows="3" maxlength="500" oninput="updateStoryCharCount()"></textarea>
          <div class="story-create-charcount"><span id="storyCharCount">0</span>/500</div>

          <!-- Media Upload -->
          <label class="story-create-upload">
            <input type="file" id="storyMedia" accept="image/*,video/*" style="display: none;">
            <div class="story-upload-btn">
              <svg width="22" height="22" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/>
              </svg>
              <span>Add Photo or Video</span>
              <span class="story-upload-hint">Max 120 seconds for videos</span>
            </div>
          </label>

          <!-- Background Color Picker -->
          <div class="story-create-colors">
            <span class="story-color-label">Background</span>
            <div class="story-color-options">
              <button class="story-color-btn active" data-bg="linear-gradient(135deg, #833ab4, #fd1d1d, #fcb045)" onclick="setStoryBg(this)" style="background: linear-gradient(135deg, #833ab4, #fd1d1d, #fcb045);"></button>
              <button class="story-color-btn" data-bg="linear-gradient(135deg, #0095f6, #00d4ff)" onclick="setStoryBg(this)" style="background: linear-gradient(135deg, #0095f6, #00d4ff);"></button>
              <button class="story-color-btn" data-bg="linear-gradient(135deg, #7c3aed, #c084fc)" onclick="setStoryBg(this)" style="background: linear-gradient(135deg, #7c3aed, #c084fc);"></button>
              <button class="story-color-btn" data-bg="linear-gradient(135deg, #059669, #34d399)" onclick="setStoryBg(this)" style="background: linear-gradient(135deg, #059669, #34d399);"></button>
              <button class="story-color-btn" data-bg="#262626" onclick="setStoryBg(this)" style="background: #262626;"></button>
              <button class="story-color-btn" data-bg="#ffffff" onclick="setStoryBg(this)" style="background: #ffffff; border: 1px solid var(--ig-border);"></button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Post Actions Modals -->
  <div id="postActionsModal" class="ig-modal-overlay" style="display: none;" onclick="closePostActionsModal(event)">
    <div class="post-actions-sheet" onclick="event.stopPropagation()">
      <div class="post-actions-header">
        <div class="post-actions-handle"></div>
      </div>
      
      <div id="viewerActions" style="display: none;">
        <div class="post-actions-list">
          <div class="post-action-item" onclick="handleRepost()">
            <div class="action-icon">
              <svg fill="currentColor" viewBox="0 0 24 24"><path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z"/></svg>
            </div>
            <span>Repost</span>
          </div>
          
          <div class="post-action-item" onclick="handleGentleReminder()">
            <div class="action-icon">
              <svg fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg>
            </div>
            <span>Gentle Reminder</span>
          </div>
          
          <div class="post-action-item danger" onclick="handleReport()">
            <div class="action-icon">
              <svg fill="currentColor" viewBox="0 0 24 24"><path d="M14.4 6L14 4H5v17h2v-7h5.6l.4 2h7V6z"/></svg>
            </div>
            <span>Report</span>
          </div>
        </div>
      </div>
      
      <div id="ownerActions" style="display: none;">
        <div class="post-actions-list">
          <div class="post-action-item" onclick="handleEditPost()">
            <div class="action-icon">
              <svg fill="currentColor" viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
            </div>
            <span>Edit Post</span>
          </div>
          
          <div class="post-action-item" onclick="handleArchivePost()">
            <div class="action-icon">
              <svg fill="currentColor" viewBox="0 0 24 24"><path d="M20.54 5.23l-1.39-1.68C18.88 3.21 18.47 3 18 3H6c-.47 0-.88.21-1.16.55L3.46 5.23C3.17 5.57 3 6.02 3 6.5V19c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6.5c0-.48-.17-.93-.46-1.27zM12 17.5L6.5 12H10v-2h4v2h3.5L12 17.5zM5.12 5l.81-1h12l.94 1H5.12z"/></svg>
            </div>
            <span>Archive</span>
          </div>
          
          <div class="post-action-item danger" onclick="handleDeletePost()">
            <div class="action-icon">
              <svg fill="currentColor" viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
            </div>
            <span>Delete</span>
          </div>
        </div>
      </div>
      
      <button class="post-actions-cancel" onclick="closePostActionsModal()">Cancel</button>
    </div>
  </div>

  <div id="reminderModal" class="ig-modal-overlay" style="display: none;" onclick="closeReminderModal(event)">
    <div class="ig-modal" onclick="event.stopPropagation()" style="max-width: 420px; width: 90%; min-width: auto; border-radius: 16px; background: var(--ig-primary-background); box-shadow: 0 8px 32px rgba(0,0,0,0.25);">
      <div style="padding: 20px 20px 0; display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
        <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #ff6b6b, #ee5a24); display: flex; align-items: center; justify-content: center;">
          <svg width="20" height="20" fill="white" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg>
        </div>
        <div>
          <div style="font-weight: 700; font-size: 16px; color: var(--ig-primary-text);">Set Gentle Reminder</div>
          <div id="reminderPostPreview" style="font-size: 12px; color: var(--ig-secondary-text); margin-top: 2px; max-width: 280px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"></div>
        </div>
      </div>
      <div style="padding: 16px 20px;">
        <label style="display: block; margin-bottom: 6px; font-weight: 600; font-size: 13px; color: var(--ig-primary-text);"><i class="far fa-calendar" style="margin-right: 6px; color: var(--ig-blue);"></i>Date</label>
        <input type="date" id="reminderDateOnly" style="width: 100%; padding: 10px 12px; border: 1px solid var(--ig-border); border-radius: 10px; background: var(--ig-secondary-background); color: var(--ig-primary-text); font-size: 14px; box-sizing: border-box;">
        
        <label style="display: block; margin: 14px 0 6px; font-weight: 600; font-size: 13px; color: var(--ig-primary-text);"><i class="far fa-clock" style="margin-right: 6px; color: var(--ig-blue);"></i>Time</label>
        <input type="time" id="reminderTimeOnly" style="width: 100%; padding: 10px 12px; border: 1px solid var(--ig-border); border-radius: 10px; background: var(--ig-secondary-background); color: var(--ig-primary-text); font-size: 14px; box-sizing: border-box;">
        
        <label style="display: block; margin: 14px 0 6px; font-weight: 600; font-size: 13px; color: var(--ig-primary-text);"><i class="far fa-comment-dots" style="margin-right: 6px; color: var(--ig-blue);"></i>Message (Optional)</label>
        <textarea id="reminderMessage" placeholder="Add a note for this reminder..." rows="3" style="width: 100%; padding: 10px 12px; border: 1px solid var(--ig-border); border-radius: 10px; background: var(--ig-secondary-background); color: var(--ig-primary-text); font-size: 14px; resize: vertical; box-sizing: border-box; font-family: inherit;"></textarea>
      </div>
      <div style="padding: 0 20px 16px; display: flex; gap: 10px;">
        <button onclick="closeReminderModal()" style="flex: 1; padding: 11px; border: 1px solid var(--ig-border); border-radius: 10px; background: transparent; color: var(--ig-primary-text); font-size: 14px; font-weight: 600; cursor: pointer;">Cancel</button>
        <button onclick="submitReminder()" style="flex: 1; padding: 11px; border: none; border-radius: 10px; background: linear-gradient(135deg, #ff6b6b, #ee5a24); color: white; font-size: 14px; font-weight: 600; cursor: pointer;">Set Reminder</button>
      </div>
    </div>
  </div>

  <div id="meetingModal" class="ig-modal-overlay" style="display: none;" onclick="closeMeetingModal(event)">
    <div class="ig-modal" onclick="event.stopPropagation()">
      <div class="ig-modal-header">Create Instant Meeting</div>
      <div style="padding: 20px;">
        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--ig-primary-text);">Platform</label>
        <select id="meetingPlatform" class="ig-chat-input" style="width: 100%; padding: 10px; border: 1px solid var(--ig-border); border-radius: 8px; margin-bottom: 16px;">
          <option value="google-meet">Google Meet</option>
          <option value="zoom">Zoom</option>
          <option value="teams">Microsoft Teams</option>
          <option value="discord">Discord</option>
        </select>
        
        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--ig-primary-text);">Meeting Title</label>
        <input type="text" id="meetingTitle" class="ig-chat-input" placeholder="Enter meeting title..." style="width: 100%; padding: 10px; border: 1px solid var(--ig-border); border-radius: 8px; margin-bottom: 16px;">
        
        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--ig-primary-text);">Date & Time</label>
        <input type="datetime-local" id="meetingDate" class="ig-chat-input" style="width: 100%; padding: 10px; border: 1px solid var(--ig-border); border-radius: 8px; margin-bottom: 16px;">
        
        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--ig-primary-text);">Description (Optional)</label>
        <textarea id="meetingDescription" class="ig-chat-input" placeholder="Add meeting details..." rows="3" style="width: 100%; padding: 10px; border: 1px solid var(--ig-border); border-radius: 8px; resize: vertical;"></textarea>
      </div>
      <div class="ig-modal-item" onclick="submitMeeting()" style="color: var(--ig-blue); font-weight: 600;">
        Create Meeting
      </div>
      <div class="ig-modal-item" onclick="closeMeetingModal()">
        Cancel
      </div>
    </div>
  </div>

  <!-- Edit Post Modal removed — now unified in PostModal (post-modal.js) -->

  <!-- Story Viewer Modal -->
  <div id="storyViewerModal" class="story-viewer-overlay" style="display: none;">
    <div class="story-viewer" onclick="event.stopPropagation()" 
         onmousedown="pauseStory()" onmouseup="resumeStory()" onmouseleave="resumeStory()"
         ontouchstart="pauseStory()" ontouchend="resumeStory()">
      <!-- Navigation areas -->
      <div class="story-nav-left" onclick="event.stopPropagation(); previousStory()"></div>
      <div class="story-nav-right" onclick="event.stopPropagation(); nextStory()"></div>
      
      <div class="story-viewer-header">
        <div class="story-viewer-user">
          <img id="storyViewerAvatar" src="" alt="" class="story-viewer-avatar">
          <span id="storyViewerUsername"></span>
          <span id="storyViewerTime" class="story-viewer-time"></span>
        </div>
        <button class="story-viewer-close" onclick="event.stopPropagation(); closeStoryViewer()">×</button>
      </div>
      
      <div class="story-viewer-content">
        <div id="storyViewerMedia"></div>
        <div id="storyViewerText" class="story-viewer-text"></div>
      </div>
      
      <div class="story-viewer-progress">
        <div id="storyProgressBar" class="story-progress-bar"></div>
      </div>
    </div>
  </div>

  <style>
    .story-viewer-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.95);
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .story-viewer {
      width: 100%;
      max-width: 500px;
      height: 100vh;
      max-height: 900px;
      background: #000;
      position: relative;
      border-radius: 0;
    }

    @media (min-width: 768px) {
      .story-viewer {
        border-radius: 12px;
        height: 90vh;
      }
    }

    .story-nav-left,
    .story-nav-right {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 35%;
      z-index: 5;
      cursor: pointer;
    }

    .story-nav-left {
      left: 0;
    }

    .story-nav-right {
      right: 0;
    }

    .story-viewer-header {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      padding: 16px;
      background: linear-gradient(to bottom, rgba(0,0,0,0.7), transparent);
      z-index: 10;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .story-viewer-user {
      display: flex;
      align-items: center;
      gap: 12px;
      color: white;
      font-weight: 500;
    }

    .story-viewer-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      object-fit: cover;
    }

    .story-viewer-time {
      color: rgba(255,255,255,0.7);
      font-size: 14px;
      font-weight: 400;
    }

    .story-viewer-close {
      background: transparent;
      border: none;
      color: white;
      font-size: 32px;
      cursor: pointer;
      padding: 0;
      width: 40px;
      height: 40px;
      line-height: 32px;
    }

    .story-viewer-content {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .story-viewer-content img,
    .story-viewer-content video {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }

    .story-viewer-text {
      position: absolute;
      bottom: 80px;
      left: 20px;
      right: 20px;
      color: white;
      font-size: 16px;
      text-align: center;
      text-shadow: 0 1px 3px rgba(0,0,0,0.8);
    }

    .story-viewer-progress {
      position: absolute;
      top: 8px;
      left: 16px;
      right: 16px;
      z-index: 11;
    }

    .story-progress-bar {
      display: flex;
      gap: 4px;
    }

    .story-progress-fill {
      height: 100%;
      background: white;
      width: 0%;
      transition: width 0.1s linear;
    }

    .story-count {
      position: absolute;
      top: 5px;
      right: 5px;
      background: rgba(0,0,0,0.7);
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: bold;
      z-index: 1;
    }
  </style>

  <script src="/socket.io/socket.io.js"></script>
  <script src="/js/app.js"></script>
  <script src="/js/instagram-theme.js"></script>
  <script src="/js/swipe-gestures.js"></script>
  <script src="/js/post-interactions.js"></script>
  <script src="/js/post-modal.js"></script>
  <script src="/js/post-renderer.js"></script>
  <script>
    InnovateAPI.requireAuth();
    InnovateAPI.initializePage();
    InnovateAPI.initSocket();

    const user = InnovateAPI.getCurrentUser();
    let currentPostId = null;

    // Initialize shared post interactions module
    PostInteractions.init({
      getUser: () => user,
      refreshPosts: () => typeof loadPosts === 'function' && loadPosts(),
      prefix: ''
    });

    // Initialize unified Post Modal (Create & Edit)
    PostModal.init('postModalContainer', {
      prefix: '',
      getUser: () => user,
      refreshPosts: () => typeof loadPosts === 'function' && loadPosts()
    });

    // Linkify captions: hashtags, @mentions, URLs
    function linkifyCaption(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      let escaped = div.innerHTML;
      const hashtagPlaceholders = [];
      escaped = escaped.replace(/(^|\s)#(\w+)/g, (match, space, tag) => {
        const idx = hashtagPlaceholders.length;
        hashtagPlaceholders.push(`${space}<span class="ig-caption-link">#${tag}</span>`);
        return `__HASHTAG_${idx}__`;
      });
      const mentionPlaceholders = [];
      escaped = escaped.replace(/(^|\s)@(\w[\w.]*)/g, (match, space, username) => {
        const idx = mentionPlaceholders.length;
        mentionPlaceholders.push(`${space}<a href="/profile/${username}" class="ig-caption-link" onclick="event.stopPropagation();">@${username}</a>`);
        return `__MENTION_${idx}__`;
      });
      escaped = escaped.replace(/(https?:\/\/[^\s<]+)/gi, (url) => {
        let display = url.replace(/^https?:\/\/(www\.)?/, '');
        if (display.length > 50) display = display.substring(0, 47) + '...';
        return `<a href="${url}" target="_blank" rel="noopener" class="ig-caption-link" onclick="event.stopPropagation();">${display}</a>`;
      });
      hashtagPlaceholders.forEach((val, idx) => { escaped = escaped.replace(`__HASHTAG_${idx}__`, val); });
      mentionPlaceholders.forEach((val, idx) => { escaped = escaped.replace(`__MENTION_${idx}__`, val); });
      return escaped;
    }

    // Initialize shared post renderer module
    PostRenderer.init({
      getUser: () => user,
      refreshPosts: () => typeof loadPosts === 'function' && loadPosts(),
      getUserAvatar: InnovateAPI.getUserAvatar,
      linkifyCaption: linkifyCaption,
      openCommentsModal: (postId) => typeof openCommentsModal === 'function' && openCommentsModal(postId),
      sharePost: (postId) => typeof sharePost === 'function' && sharePost(postId),
      openPostActionsMenu: (postId, userId) => typeof openPostActionsMenu === 'function' && openPostActionsMenu(postId, userId),
      showAlert: InnovateAPI.showAlert,
      apiRequest: InnovateAPI.apiRequest,
      openAttachment: (url, name) => typeof openAttachmentViewer === 'function' && openAttachmentViewer(url, name),
      openCustomButtonModal: (postId, userId, config) => typeof openCustomButtonModal === 'function' && openCustomButtonModal(postId, userId, config),
      showWhoLiked: (postId) => typeof showWhoLiked === 'function' && showWhoLiked(postId),
      initPdfEmbeds: (el) => typeof initPdfEmbeds === 'function' && initPdfEmbeds(el),
    });

    function getCurrentUserId() {
      return user.id;
    }

    // Post Actions Menu Functions




    function handleInstantMeeting() {
      closePostActionsModal();
      document.getElementById('meetingModal').style.display = 'flex';
    }


    function closeMeetingModal(event) {
      if (!event || event.target.id === 'meetingModal') {
        document.getElementById('meetingModal').style.display = 'none';
      }
    }

    async function submitMeeting() {
      const platform = document.getElementById('meetingPlatform').value;
      const title = document.getElementById('meetingTitle').value;
      const date = document.getElementById('meetingDate').value;
      const description = document.getElementById('meetingDescription').value;
      
      if (!title || !date) {
        InnovateAPI.showAlert('Please fill in the title and date', 'error');
        return;
      }
      
      try {
        const response = await InnovateAPI.apiRequest(`/posts/${currentPostIdForActions}/meeting`, {
          method: 'POST',
          body: JSON.stringify({ platform, title, meeting_date: date, description })
        });
        closeMeetingModal();
        InnovateAPI.showAlert(`Meeting created! Check Events page for details.`, 'success');
        document.getElementById('meetingTitle').value = '';
        document.getElementById('meetingDate').value = '';
        document.getElementById('meetingDescription').value = '';
      } catch (error) {
        InnovateAPI.showAlert(error.message || 'Failed to create meeting', 'error');
      }
    }


    // Load user avatar
    async function loadUserAvatar() {
      try {
        const data = await InnovateAPI.apiRequest(`/users/${user.id}`);
        const avatar = InnovateAPI.getUserAvatar(data.user.profile_picture);
        
        const myStoryAvatar = document.getElementById('myStoryAvatar');
        if (myStoryAvatar) myStoryAvatar.src = avatar;
        
        const profileImg = document.getElementById('profileImg');
        if (profileImg) profileImg.src = avatar;
      } catch (error) {
        console.error('Error loading avatar:', error);
      }
    }

    // Load stories
    async function loadStories() {
      try {
        const data = await InnovateAPI.apiRequest('/posts/stories');
        const container = document.getElementById('storiesContainer');
        
        // Keep the "Your story" button and only clear other stories
        const existingStories = container.querySelectorAll('.ig-story:not(.ig-add-story)');
        existingStories.forEach(story => story.remove());
        
        // Group stories by user_id
        const storyGroups = {};
        data.stories.forEach(story => {
          if (!storyGroups[story.user_id]) {
            storyGroups[story.user_id] = {
              user: {
                user_id: story.user_id,
                username: story.username,
                profile_picture: story.profile_picture
              },
              stories: []
            };
          }
          storyGroups[story.user_id].stories.push(story);
        });
        
        // Create one ring per user
        Object.values(storyGroups).forEach(group => {
          // Check if user has viewed all stories in this group
          const allViewed = group.stories.every(s => s.viewed_by_current_user);
          
          const storyEl = document.createElement('div');
          storyEl.className = 'ig-story';
          storyEl.innerHTML = `
            <div class="ig-story-ring ${allViewed ? 'viewed' : ''}">
              <img src="${InnovateAPI.getUserAvatar(group.user.profile_picture)}" alt="${group.user.username}" class="ig-story-avatar">
              ${group.stories.length > 1 ? `<div class="story-count">${group.stories.length}</div>` : ''}
            </div>
            <div class="ig-story-username">${group.user.username}</div>
          `;
          storyEl.onclick = () => viewStory(group.stories, 0);
          container.appendChild(storyEl);
        });
      } catch (error) {
        console.error('Error loading stories:', error);
      }
    }

    // Load posts
    async function loadPosts() {
      try {
        const data = await InnovateAPI.apiRequest('/posts');
        const feed = document.getElementById('postsFeed');
        feed.innerHTML = '';
        
        if (data.posts.length === 0) {
          feed.innerHTML = '<div class="ig-text-center" style="padding: 40px; color: var(--ig-secondary-text);">No posts yet. Follow people to see their posts!</div>';
          return;
        }
        
        data.posts.forEach((post, index) => {
          const postEl = PostRenderer.createFeedPost(post);
          postEl.style.cursor = 'pointer';
          feed.appendChild(postEl);
          
          // Initialize carousel for posts with multiple images
          if (post.images && post.images.length > 1) {
            PostRenderer.initCarousel(post.id, post.images.length);
            PostRenderer.enableCarouselSwipe(post.id);
          }
          
          // Add click handler to open full-screen viewer
          postEl.addEventListener('click', (e) => {
            // Don't open if clicking interactive elements
            if (e.target.closest('button, input, label, a, .ig-action-btn, .ig-carousel-btn, .ig-carousel-dot, .ig-carousel-prev, .ig-carousel-next, .ig-poll, .poll-option, .ig-post-actions, .ig-post-actions-btns, .ig-add-comment, .ig-post-comments-btn, .ig-pdf-embed, .ig-pdf-ctrl, .ig-attachment-item, .ig-post-menu, .ig-video-sound-btn, .ig-video-play-btn, [onclick]')) {
              return;
            }
            // Only open for image/video clicks or post header area
            if (e.target.closest('.ig-post-image, .ig-post-caption, .ig-post-likes, .ig-post-video-container')) {
              PostRenderer.openFullScreenViewer(data.posts, index);
            }
          });
        });
        
        // Setup auto-play for video posts
        PostRenderer.setupFeedVideoAutoplay();

        // Check if we need to open a specific post (from /post/:id URL or ?post= param)
        var postUrlMatch = window.location.pathname.match(/^\/post\/(\d+)/);
        var postParam = new URLSearchParams(window.location.search).get('post');
        var targetPostId = postUrlMatch ? parseInt(postUrlMatch[1]) : (postParam ? parseInt(postParam) : null);
        if (targetPostId) {
          var targetIndex = data.posts.findIndex(function(p) { return p.id === targetPostId; });
          if (targetIndex >= 0) {
            PostRenderer.openFullScreenViewer(data.posts, targetIndex);
          } else {
            // Post not in feed - fetch it individually and display
            try {
              var singlePost = await InnovateAPI.apiRequest('/posts/' + targetPostId);
              if (singlePost && singlePost.id) {
                PostRenderer.openFullScreenViewer([singlePost], 0);
              }
            } catch(e) {
              console.error('Could not load post ' + targetPostId, e);
            }
          }
        }
      } catch (error) {
        console.error('Error loading posts:', error);
      }
    }



    // Double-tap to like with heart animation
    let lastTapTime = 0;


    // Post menu
    function openPostMenu(postId, userId) {
      currentPostId = postId;
      if (userId === user.id) {
        document.getElementById('postMenuModal').style.display = 'flex';
      } else {
        // Show report/unfollow options for other users' posts
        const action = confirm('Report this post?');
        if (action) {
          InnovateAPI.showAlert('Post reported', 'success');
        }
      }
    }

    function closePostMenu() {
      document.getElementById('postMenuModal').style.display = 'none';
    }

    async function deleteCurrentPost() {
      if (confirm('Are you sure you want to delete this post?')) {
        try {
          await InnovateAPI.apiRequest(`/posts/${currentPostId}`, {
            method: 'DELETE'
          });
          InnovateAPI.showAlert('Post deleted', 'success');
          closePostMenu();
          loadPosts();
        } catch (error) {
          InnovateAPI.showAlert(error.message, 'error');
        }
      }
    }

    function editCurrentPost() {
      InnovateAPI.showAlert('Edit functionality coming soon!', 'info');
      closePostMenu();
    }

    // ========== Create Post Modal (Instagram-Style) ==========
    let selectedImages = [];
    let selectedFiles = [];
    let hashtagDebounceTimer = null;
    let trendingHashtagsCache = null;

    // ===== Unified Modal wrappers =====
    function openCreatePostModal() {
      PostModal.openCreate();
    }

    function closeCreatePostModal(event) {
      PostModal.close();
    }

    // ===== Create Tab Switching (Post / Creator Series) =====
    let activeCreateTab = 'post';
    let creatorSeriesVideoFile = null;
    let creatorSeriesTrimStart = 0;
    let creatorSeriesTrimEnd = 1; // fraction 0-1
    let creatorSeriesCoverTime = 0;
    let creatorSeriesDuration = 0;

    function switchCreateTab(tab) {
      if (tab === activeCreateTab) return;
      activeCreateTab = tab;

      // Update tab buttons
      document.querySelectorAll('.cr-tab').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tab === tab);
      });

      // Toggle media sections
      const postMedia = document.getElementById('crPostMedia');
      const creatorSeriesMedia = document.getElementById('crCreatorSeriesMedia');
      if (postMedia) postMedia.style.display = tab === 'post' ? '' : 'none';
      if (creatorSeriesMedia) creatorSeriesMedia.style.display = tab === 'creatorSeries' ? '' : 'none';

      // Update header title
      const title = document.getElementById('cpHeaderTitle');
      if (title) title.textContent = tab === 'creatorSeries' ? 'Create new creator series' : 'Create new post';
    }

    function submitCreateContent() {
      if (activeCreateTab === 'creatorSeries') {
        submitCreatorSeries();
      } else {
        submitPost();
      }
    }

    // ===== Creator Series Video Handling =====
    function onCreatorSeriesVideoSelected(event) {
      const file = event.target.files[0];
      if (!file) return;
      if (!file.type.startsWith('video/')) {
        InnovateAPI.showAlert('Please select a video file', 'error');
        return;
      }

      creatorSeriesVideoFile = file;
      const video = document.getElementById('crCreatorSeriesVideo');
      const url = URL.createObjectURL(file);
      video.src = url;

      video.onloadedmetadata = () => {
        creatorSeriesDuration = video.duration;
        creatorSeriesTrimStart = 0;
        creatorSeriesTrimEnd = 1;
        creatorSeriesCoverTime = 0;

        // Show preview, hide placeholder
        document.getElementById('crCreatorSeriesPlaceholder').style.display = 'none';
        document.getElementById('crCreatorSeriesPreview').style.display = '';
        document.getElementById('crCreatorSeriesDuration').textContent = formatCreatorSeriesTime(creatorSeriesDuration);
        // Show file size info
        const sizeMB = (file.size / (1024 * 1024)).toFixed(1);
        const sizeInfo = sizeMB > 50 ? ` · ${sizeMB}MB (will compress)` : ` · ${sizeMB}MB`;
        document.getElementById('crCreatorSeriesDuration').textContent = formatCreatorSeriesTime(creatorSeriesDuration) + sizeInfo;
        document.getElementById('crTrimEndTime').textContent = formatCreatorSeriesTime(creatorSeriesDuration);
        document.getElementById('crTrimStartTime').textContent = '0:00';
        document.getElementById('crTrimDurationLabel').textContent = 'Duration: ' + formatCreatorSeriesTime(creatorSeriesDuration);

        // Reset trim handles
        const startHandle = document.getElementById('crTrimStart');
        const endHandle = document.getElementById('crTrimEnd');
        if (startHandle) startHandle.style.left = '0px';
        if (endHandle) endHandle.style.right = '0px';

        // Generate thumbnails
        generateTrimThumbnails(video);
        generateCoverThumbnails(video);

        // Set initial cover
        updateCoverFrame(0);
      };

      video.onended = () => {
        document.getElementById('crCreatorSeriesPlayOverlay').classList.add('cr-paused');
      };
    }

    function toggleCreatorSeriesPlayback() {
      const video = document.getElementById('crCreatorSeriesVideo');
      const overlay = document.getElementById('crCreatorSeriesPlayOverlay');
      if (video.paused) {
        video.play();
        overlay.classList.remove('cr-paused');
      } else {
        video.pause();
        overlay.classList.add('cr-paused');
      }
    }

    function changeCreatorSeriesVideo() {
      const video = document.getElementById('crCreatorSeriesVideo');
      if (video) { video.pause(); video.src = ''; }
      creatorSeriesVideoFile = null;
      creatorSeriesDuration = 0;
      document.getElementById('crCreatorSeriesPreview').style.display = 'none';
      document.getElementById('crCreatorSeriesPlaceholder').style.display = '';
      document.getElementById('creatorSeriesVideoInput').value = '';
      document.getElementById('creatorSeriesVideoInput').click();
    }

    function formatCreatorSeriesTime(seconds) {
      if (!seconds || isNaN(seconds)) return '0:00';
      const m = Math.floor(seconds / 60);
      const s = Math.floor(seconds % 60);
      return m + ':' + (s < 10 ? '0' : '') + s;
    }

    // ===== Trim Timeline Thumbnails =====
    function generateTrimThumbnails(videoEl) {
      const canvas = document.getElementById('crTrimCanvas');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      const numFrames = 10;
      const frameWidth = canvas.width / numFrames;
      canvas.width = canvas.offsetWidth * 2; // retina
      canvas.height = 96;
      const fw = canvas.width / numFrames;
      const fh = canvas.height;
      let framesLoaded = 0;

      const tempVideo = document.createElement('video');
      tempVideo.src = videoEl.src;
      tempVideo.muted = true;
      tempVideo.preload = 'auto';

      function drawFrame(idx) {
        const time = (idx / numFrames) * creatorSeriesDuration;
        tempVideo.currentTime = time;
      }

      tempVideo.onseeked = () => {
        ctx.drawImage(tempVideo, framesLoaded * fw, 0, fw, fh);
        framesLoaded++;
        if (framesLoaded < numFrames) {
          drawFrame(framesLoaded);
        }
      };

      tempVideo.onloadeddata = () => drawFrame(0);
    }

    // ===== Cover Frame Thumbnails =====
    function generateCoverThumbnails(videoEl) {
      const container = document.getElementById('crCoverThumbnails');
      if (!container) return;
      container.innerHTML = '';
      const numFrames = 8;
      const tempVideo = document.createElement('video');
      tempVideo.src = videoEl.src;
      tempVideo.muted = true;
      tempVideo.preload = 'auto';
      let currentIdx = 0;

      function createThumb(idx) {
        const time = (idx / (numFrames - 1)) * creatorSeriesDuration;
        tempVideo.currentTime = Math.min(time, creatorSeriesDuration - 0.1);
      }

      tempVideo.onseeked = () => {
        const c = document.createElement('canvas');
        c.width = 112;
        c.height = 200;
        const cx = c.getContext('2d');
        // Draw video frame covering the canvas (crop to fit 9:16)
        const vw = tempVideo.videoWidth;
        const vh = tempVideo.videoHeight;
        const scale = Math.max(c.width / vw, c.height / vh);
        const sw = c.width / scale;
        const sh = c.height / scale;
        const sx = (vw - sw) / 2;
        const sy = (vh - sh) / 2;
        cx.drawImage(tempVideo, sx, sy, sw, sh, 0, 0, c.width, c.height);

        if (currentIdx === 0) c.classList.add('cr-cover-selected');
        c.dataset.time = tempVideo.currentTime;
        c.onclick = () => selectCoverFrame(c);
        container.appendChild(c);
        currentIdx++;
        if (currentIdx < numFrames) {
          createThumb(currentIdx);
        }
      };

      tempVideo.onloadeddata = () => createThumb(0);
    }

    function selectCoverFrame(canvasEl) {
      // Deselect all
      document.querySelectorAll('.cr-cover-thumbnails canvas').forEach(c => c.classList.remove('cr-cover-selected'));
      canvasEl.classList.add('cr-cover-selected');
      creatorSeriesCoverTime = parseFloat(canvasEl.dataset.time) || 0;
      updateCoverFrame(creatorSeriesCoverTime);
    }

    function updateCoverFrame(time) {
      const coverCanvas = document.getElementById('crCoverCanvas');
      if (!coverCanvas) return;
      const video = document.getElementById('crCreatorSeriesVideo');
      if (!video || !video.src) return;

      const tempVideo = document.createElement('video');
      tempVideo.src = video.src;
      tempVideo.muted = true;
      tempVideo.currentTime = time;
      tempVideo.onseeked = () => {
        const ctx = coverCanvas.getContext('2d');
        const vw = tempVideo.videoWidth;
        const vh = tempVideo.videoHeight;
        const scale = Math.max(coverCanvas.width / vw, coverCanvas.height / vh);
        const sw = coverCanvas.width / scale;
        const sh = coverCanvas.height / scale;
        const sx = (vw - sw) / 2;
        const sy = (vh - sh) / 2;
        ctx.drawImage(tempVideo, sx, sy, sw, sh, 0, 0, coverCanvas.width, coverCanvas.height);
      };
    }

    // ===== Trim Handle Dragging =====
    (function setupTrimHandles() {
      let dragging = null; // 'start' or 'end'

      document.addEventListener('mousedown', (e) => {
        if (e.target.id === 'crTrimStart') dragging = 'start';
        else if (e.target.id === 'crTrimEnd') dragging = 'end';
      });

      document.addEventListener('mousemove', (e) => {
        if (!dragging) return;
        const timeline = document.getElementById('crTrimTimeline');
        if (!timeline) return;
        const rect = timeline.getBoundingClientRect();
        const x = Math.max(0, Math.min(e.clientX - rect.left, rect.width));
        const frac = x / rect.width;

        if (dragging === 'start') {
          creatorSeriesTrimStart = Math.min(frac, creatorSeriesTrimEnd - 0.05);
          document.getElementById('crTrimStart').style.left = (creatorSeriesTrimStart * 100) + '%';
          document.getElementById('crTrimStartTime').textContent = formatCreatorSeriesTime(creatorSeriesTrimStart * creatorSeriesDuration);
        } else {
          creatorSeriesTrimEnd = Math.max(frac, creatorSeriesTrimStart + 0.05);
          document.getElementById('crTrimEnd').style.left = (creatorSeriesTrimEnd * 100 - 3) + '%';
          document.getElementById('crTrimEndTime').textContent = formatCreatorSeriesTime(creatorSeriesTrimEnd * creatorSeriesDuration);
        }

        const trimDuration = (creatorSeriesTrimEnd - creatorSeriesTrimStart) * creatorSeriesDuration;
        document.getElementById('crTrimDurationLabel').textContent = 'Duration: ' + formatCreatorSeriesTime(trimDuration);
      });

      document.addEventListener('mouseup', () => { dragging = null; });

      // Touch support
      document.addEventListener('touchstart', (e) => {
        if (e.target.id === 'crTrimStart') dragging = 'start';
        else if (e.target.id === 'crTrimEnd') dragging = 'end';
      }, { passive: true });

      document.addEventListener('touchmove', (e) => {
        if (!dragging) return;
        const touch = e.touches[0];
        const timeline = document.getElementById('crTrimTimeline');
        if (!timeline) return;
        const rect = timeline.getBoundingClientRect();
        const x = Math.max(0, Math.min(touch.clientX - rect.left, rect.width));
        const frac = x / rect.width;

        if (dragging === 'start') {
          creatorSeriesTrimStart = Math.min(frac, creatorSeriesTrimEnd - 0.05);
          document.getElementById('crTrimStart').style.left = (creatorSeriesTrimStart * 100) + '%';
          document.getElementById('crTrimStartTime').textContent = formatCreatorSeriesTime(creatorSeriesTrimStart * creatorSeriesDuration);
        } else {
          creatorSeriesTrimEnd = Math.max(frac, creatorSeriesTrimStart + 0.05);
          document.getElementById('crTrimEnd').style.left = (creatorSeriesTrimEnd * 100 - 3) + '%';
          document.getElementById('crTrimEndTime').textContent = formatCreatorSeriesTime(creatorSeriesTrimEnd * creatorSeriesDuration);
        }

        const trimDuration = (creatorSeriesTrimEnd - creatorSeriesTrimStart) * creatorSeriesDuration;
        document.getElementById('crTrimDurationLabel').textContent = 'Duration: ' + formatCreatorSeriesTime(trimDuration);
      }, { passive: true });

      document.addEventListener('touchend', () => { dragging = null; }, { passive: true });
    })();

    // ===== Creator Series Audio Toggle =====
    function toggleCreatorSeriesAudio() {
      const opts = document.getElementById('crAudioOptions');
      const chevron = document.getElementById('crAudioChevron');
      if (!opts) return;
      const showing = opts.style.display === 'none';
      opts.style.display = showing ? '' : 'none';
      chevron?.classList.toggle('cr-open', showing);
    }

    // Volume slider
    document.getElementById('crAudioVolume')?.addEventListener('input', function() {
      document.getElementById('crVolumeLabel').textContent = this.value + '%';
      const video = document.getElementById('crCreatorSeriesVideo');
      if (video) video.volume = this.value / 100;
    });

    // Mute toggle
    document.getElementById('crMuteAudio')?.addEventListener('change', function() {
      const video = document.getElementById('crCreatorSeriesVideo');
      const volSection = document.getElementById('crVolumeSection');
      if (video) video.muted = this.checked;
      if (volSection) volSection.style.display = this.checked ? 'none' : '';
    });

    // ===== Reset Creator Series Fields =====
    function resetCreatorSeriesFields() {
      creatorSeriesVideoFile = null;
      creatorSeriesDuration = 0;
      creatorSeriesTrimStart = 0;
      creatorSeriesTrimEnd = 1;
      creatorSeriesCoverTime = 0;
      const video = document.getElementById('crCreatorSeriesVideo');
      if (video) { video.pause(); video.src = ''; }
      const preview = document.getElementById('crCreatorSeriesPreview');
      if (preview) preview.style.display = 'none';
      const placeholder = document.getElementById('crCreatorSeriesPlaceholder');
      if (placeholder) placeholder.style.display = '';
      const input = document.getElementById('creatorSeriesVideoInput');
      if (input) input.value = '';
      const thumbs = document.getElementById('crCoverThumbnails');
      if (thumbs) thumbs.innerHTML = '';
      const audioOpts = document.getElementById('crAudioOptions');
      if (audioOpts) audioOpts.style.display = 'none';
      const muteCheck = document.getElementById('crMuteAudio');
      if (muteCheck) muteCheck.checked = false;
      const volSlider = document.getElementById('crAudioVolume');
      if (volSlider) volSlider.value = 100;
      const volLabel = document.getElementById('crVolumeLabel');
      if (volLabel) volLabel.textContent = '100%';
      const volSection = document.getElementById('crVolumeSection');
      if (volSection) volSection.style.display = '';
    }

    // ===== Submit Creator Series =====
    // ===== Chunked Video Upload =====
    // Splits large videos into chunks to bypass proxy limits
    const CHUNK_SIZE = 4 * 1024 * 1024; // 4MB per chunk (proxy limit ~10MB)
    const PARALLEL_UPLOADS = 6; // upload 6 chunks simultaneously

    async function uploadVideoChunked(file, onProgress) {
      const totalChunks = Math.ceil(file.size / CHUNK_SIZE);

      // 1. Init upload session
      const initRes = await InnovateAPI.apiRequest('/posts/upload/init', {
        method: 'POST',
        body: JSON.stringify({
          fileName: file.name,
          fileSize: file.size,
          mimeType: file.type,
          totalChunks
        })
      });
      const { uploadId } = initRes;

      // 2. Upload chunks in parallel batches
      let completed = 0;
      for (let batch = 0; batch < totalChunks; batch += PARALLEL_UPLOADS) {
        const promises = [];
        for (let j = 0; j < PARALLEL_UPLOADS && (batch + j) < totalChunks; j++) {
          const i = batch + j;
          const start = i * CHUNK_SIZE;
          const end = Math.min(start + CHUNK_SIZE, file.size);
          const chunk = file.slice(start, end);

          const chunkForm = new FormData();
          chunkForm.append('uploadId', uploadId);
          chunkForm.append('chunkIndex', i.toString());
          chunkForm.append('chunk', chunk, `chunk_${i}`);

          promises.push(
            InnovateAPI.apiRequest('/posts/upload/chunk', {
              method: 'POST',
              body: chunkForm,
              headers: {}
            }).then(() => {
              completed++;
              if (onProgress) onProgress(completed, totalChunks);
            })
          );
        }
        await Promise.all(promises);
      }

      // 3. Finalize — assemble chunks on server
      const finalRes = await InnovateAPI.apiRequest('/posts/upload/finalize', {
        method: 'POST',
        body: JSON.stringify({ uploadId })
      });

      return finalRes.filePath;
    }

    async function submitCreatorSeries() {
      const shareBtn = document.getElementById('cpShareBtn');
      const content = document.getElementById('postContent').value;
      const scheduleTime = document.getElementById('scheduleTime')?.value;
      const enableContact = document.getElementById('enableContact')?.checked;
      const enableInterested = document.getElementById('enableInterested')?.checked;

      if (!creatorSeriesVideoFile) {
        InnovateAPI.showAlert('Please upload a video for your creator series', 'error');
        return;
      }

      // Calculate trimmed duration
      const trimmedDuration = (creatorSeriesTrimEnd - creatorSeriesTrimStart) * creatorSeriesDuration;

      shareBtn.disabled = true;
      shareBtn.classList.add('cp-sharing');

      try {
        let videoPath;
        const sizeMB = creatorSeriesVideoFile.size / (1024 * 1024);

        if (sizeMB > 4) {
          // Large file → chunked upload
          shareBtn.textContent = 'Uploading 0%...';
          videoPath = await uploadVideoChunked(creatorSeriesVideoFile, (done, total) => {
            const pct = Math.round((done / total) * 100);
            shareBtn.textContent = `Uploading ${pct}%...`;
          });
        } else {
          // Small file → direct upload via FormData
          shareBtn.textContent = 'Uploading...';
          videoPath = null; // will be handled by multer below
        }

        shareBtn.textContent = 'Sharing...';

        const formData = new FormData();
        formData.append('content', content);
        formData.append('is_creator_series', '1');

        if (videoPath) {
          // Video already uploaded via chunks
          formData.append('chunked_video_path', videoPath);
        } else {
          // Small video — attach directly
          formData.append('video', creatorSeriesVideoFile);
        }

        // Trim info
        const trimStartSec = creatorSeriesTrimStart * creatorSeriesDuration;
        const trimEndSec = creatorSeriesTrimEnd * creatorSeriesDuration;
        formData.append('trim_start', trimStartSec.toFixed(2));
        formData.append('trim_end', trimEndSec.toFixed(2));
        formData.append('cover_time', creatorSeriesCoverTime.toFixed(2));

        // Audio
        const muted = document.getElementById('crMuteAudio')?.checked;
        const volume = document.getElementById('crAudioVolume')?.value || '100';
        formData.append('audio_muted', muted ? '1' : '0');
        formData.append('audio_volume', volume);

        // Hashtags
        const hashtags = content.match(/#[\w]+/g);
        if (hashtags) {
          formData.append('hashtags', JSON.stringify(hashtags.map(h => h.substring(1))));
        }

        // Poll
        const pollSection = document.getElementById('pollSection');
        if (pollSection && pollSection.style.display !== 'none') {
          const pollQuestion = document.getElementById('pollQuestion')?.value;
          const pollOptions = Array.from(document.querySelectorAll('#pollSection .poll-option'))
            .map(input => input.value).filter(val => val.trim());
          const pollExpiry = document.getElementById('pollExpiry')?.value;

          if (pollQuestion && pollOptions.length >= 2) {
            formData.append('poll_question', pollQuestion);
            formData.append('poll_options', JSON.stringify(pollOptions));
            if (pollExpiry) formData.append('poll_expiry', pollExpiry);
          } else if (pollQuestion || pollOptions.length > 0) {
            shareBtn.disabled = false;
            shareBtn.classList.remove('cp-sharing');
            shareBtn.textContent = 'Share';
            InnovateAPI.showAlert('Poll needs a question and at least 2 options', 'error');
            return;
          }
        }

        // Schedule
        if (scheduleTime) formData.append('scheduled_at', scheduleTime);

        // Action buttons
        formData.append('enable_contact', enableContact ? '1' : '0');
        formData.append('enable_interested', enableInterested ? '1' : '0');

        // Custom button
        const customButtonData = collectCustomButtonData();
        if (customButtonData) formData.append('custom_button', JSON.stringify(customButtonData));

        // Comment to DM
        const commentDMData = collectCommentDMData();
        if (commentDMData) formData.append('comment_to_dm', JSON.stringify(commentDMData));

        await InnovateAPI.apiRequest('/posts', {
          method: 'POST',
          body: formData,
          headers: {}
        });

        InnovateAPI.showAlert(scheduleTime ? 'Creator Series scheduled!' : 'Creator Series shared!', 'success');
        document.getElementById('createPostModal').style.display = 'none';
        resetCreatorSeriesFields();
        loadPosts();
      } catch (error) {
        InnovateAPI.showAlert(error.message || 'Failed to create creator series', 'error');
      } finally {
        shareBtn.disabled = false;
        shareBtn.classList.remove('cp-sharing');
        shareBtn.textContent = 'Share';
      }
    }

    // Caption input handler with hashtag suggestions
    function onCaptionInput(textarea) {
      // Update character count
      const count = textarea.value.length;
      document.getElementById('cpCharCount').textContent = count;
      
      // Hashtag detection
      const text = textarea.value;
      const cursorPos = textarea.selectionStart;
      const beforeCursor = text.substring(0, cursorPos);
      const hashMatch = beforeCursor.match(/#(\w*)$/);
      
      if (hashMatch && hashMatch[1].length >= 1) {
        showHashtagSuggestions(hashMatch[1]);
      } else {
        // Also suggest hashtags based on content when there's enough text
        clearTimeout(hashtagDebounceTimer);
        if (text.length > 15) {
          hashtagDebounceTimer = setTimeout(() => suggestHashtagsFromContent(text), 800);
        }
      }
    }

    // Load trending hashtags from API
    async function loadTrendingHashtags() {
      try {
        const data = await InnovateAPI.apiRequest('/posts/trending-hashtags');
        if (data && data.hashtags && data.hashtags.length > 0) {
          trendingHashtagsCache = data.hashtags;
          renderTrendingHashtags(data.hashtags);
        }
      } catch (e) {
        // Silently fail - trending hashtags are optional
        console.log('Trending hashtags not available');
      }
    }

    function renderTrendingHashtags(hashtags) {
      const list = document.getElementById('trendingList');
      if (!list) return;
      list.innerHTML = hashtags.map(h => `
        <div class="cp-trending-item" onclick="insertHashtag('${h.tag}')">
          <span class="cp-trending-tag">#${h.tag}</span>
          <span class="cp-trending-count">${h.usage_count || 0} posts</span>
        </div>
      `).join('');
    }

    function toggleTrendingHashtags() {
      const list = document.getElementById('trendingList');
      const chevron = document.getElementById('trendingChevron');
      if (list.style.display === 'none') {
        list.style.display = 'block';
        chevron?.classList.add('cp-open');
      } else {
        list.style.display = 'none';
        chevron?.classList.remove('cp-open');
      }
    }

    // Show hashtag suggestions when typing #
    async function showHashtagSuggestions(query) {
      const suggestionsDiv = document.getElementById('hashtagSuggestions');
      const listDiv = document.getElementById('hashtagList');
      
      // Use a combination of local trending cache and the query
      let suggestions = [];
      
      // Filter from trending cache first
      if (trendingHashtagsCache) {
        suggestions = trendingHashtagsCache
          .filter(h => h.tag.toLowerCase().startsWith(query.toLowerCase()))
          .map(h => h.tag);
      }
      
      // Add common hashtag suggestions based on the query
      const commonTags = [
        'love', 'instagood', 'photooftheday', 'fashion', 'beautiful', 'happy',
        'cute', 'tbt', 'like4like', 'followme', 'picoftheday', 'follow',
        'me', 'selfie', 'summer', 'art', 'instadaily', 'friends', 'repost',
        'nature', 'girl', 'fun', 'style', 'smile', 'food', 'instalike',
        'family', 'travel', 'fitness', 'igers', 'tagsforlikes', 'life',
        'music', 'beauty', 'photo', 'amazing', 'animalsofinstagram',
        'tech', 'coding', 'programming', 'innovation', 'startup', 'design',
        'motivation', 'inspiration', 'community', 'trending', 'viral',
        'explore', 'business', 'entrepreneur', 'success', 'mindset'
      ];
      
      const filtered = commonTags
        .filter(t => t.startsWith(query.toLowerCase()) && !suggestions.includes(t))
        .slice(0, 8 - suggestions.length);
      
      suggestions = [...suggestions, ...filtered].slice(0, 8);
      
      if (suggestions.length > 0) {
        const currentContent = document.getElementById('postContent').value;
        listDiv.innerHTML = suggestions.map(tag => {
          const isAdded = currentContent.includes(`#${tag}`);
          return `<span class="cp-hashtag-chip ${isAdded ? 'cp-hashtag-added' : ''}" onclick="insertHashtag('${tag}')">#${tag}</span>`;
        }).join('');
        suggestionsDiv.style.display = 'block';
      } else {
        suggestionsDiv.style.display = 'none';
      }
    }

    // Suggest hashtags from content using built-in analysis
    function suggestHashtagsFromContent(content) {
      const suggestionsDiv = document.getElementById('hashtagSuggestions');
      const listDiv = document.getElementById('hashtagList');
      
      // Simple keyword extraction for hashtag suggestions
      const words = content.toLowerCase().replace(/[^a-z0-9\s]/g, '').split(/\s+/).filter(w => w.length > 3);
      const wordFreq = {};
      words.forEach(w => { wordFreq[w] = (wordFreq[w] || 0) + 1; });
      
      // Topic-based suggestions
      const topicMap = {
        'photo|picture|camera|shot|lens': ['photography', 'photooftheday', 'picoftheday'],
        'food|cook|recipe|eat|meal|restaurant': ['foodie', 'foodphotography', 'instafood'],
        'travel|trip|vacation|journey|explore': ['travel', 'wanderlust', 'travelgram'],
        'work|office|job|career|business': ['business', 'entrepreneur', 'worklife'],
        'code|programming|developer|software|tech': ['coding', 'developer', 'tech'],
        'fitness|gym|workout|exercise|health': ['fitness', 'gym', 'healthylifestyle'],
        'music|song|concert|band|singer': ['music', 'musician', 'musiclife'],
        'art|paint|draw|design|creative': ['art', 'artist', 'creative'],
        'nature|outdoor|mountain|beach|sunset': ['nature', 'naturephotography', 'outdoors'],
        'fashion|style|outfit|wear|dress': ['fashion', 'style', 'ootd'],
        'love|heart|relationship|couple': ['love', 'instagood', 'happy'],
        'learn|study|education|school|university': ['education', 'learning', 'knowledge']
      };

      let suggestions = [];
      const lowerContent = content.toLowerCase();
      
      for (const [keywords, tags] of Object.entries(topicMap)) {
        const regex = new RegExp(keywords);
        if (regex.test(lowerContent)) {
          suggestions.push(...tags);
        }
      }
      
      // Add high-frequency words as potential hashtags
      const freqWords = Object.entries(wordFreq)
        .filter(([w, c]) => c >= 1 && w.length > 4)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 3)
        .map(([w]) => w);
      suggestions.push(...freqWords);

      // Deduplicate and limit
      suggestions = [...new Set(suggestions)].slice(0, 8);
      
      const currentContent = document.getElementById('postContent').value;
      // Don't show if already typing hashtags or no suggestions
      if (suggestions.length === 0 || currentContent.includes('#')) return;
      
      listDiv.innerHTML = suggestions.map(tag => {
        const isAdded = currentContent.includes(`#${tag}`);
        return `<span class="cp-hashtag-chip ${isAdded ? 'cp-hashtag-added' : ''}" onclick="insertHashtag('${tag}')">#${tag}</span>`;
      }).join('');
      suggestionsDiv.style.display = 'block';
    }

    function insertHashtag(tag) {
      const textarea = document.getElementById('postContent');
      let content = textarea.value;
      
      // Check if hashtag already exists
      if (content.includes(`#${tag}`)) {
        // Remove it
        content = content.replace(new RegExp(`\\s*#${tag}`, 'g'), '');
        textarea.value = content.trim();
      } else {
        // Check if user is currently typing a hashtag - replace partial
        const cursorPos = textarea.selectionStart;
        const beforeCursor = content.substring(0, cursorPos);
        const afterCursor = content.substring(cursorPos);
        const hashMatch = beforeCursor.match(/#\w*$/);
        
        if (hashMatch) {
          // Replace the partial hashtag being typed
          const newBefore = beforeCursor.substring(0, hashMatch.index) + `#${tag} `;
          textarea.value = newBefore + afterCursor;
          textarea.selectionStart = textarea.selectionEnd = newBefore.length;
        } else {
          // Append hashtag to end
          const separator = content.endsWith(' ') || content === '' ? '' : ' ';
          textarea.value = content + separator + `#${tag} `;
        }
      }
      
      // Update char count
      document.getElementById('cpCharCount').textContent = textarea.value.length;
      textarea.focus();
      
      // Refresh suggestion chips to show added state
      onCaptionInput(textarea);
    }

    // Toggle sections
    function togglePollCreation() {
      const section = document.getElementById('pollSection');
      const btn = document.getElementById('pollToggleBtn');
      const isVisible = section.style.display !== 'none';
      section.style.display = isVisible ? 'none' : 'block';
      btn?.classList.toggle('cp-tool-active', !isVisible);
    }

    function toggleSchedule() {
      const section = document.getElementById('scheduleSection');
      const btn = document.getElementById('scheduleToggleBtn');
      const isVisible = section.style.display !== 'none';
      section.style.display = isVisible ? 'none' : 'block';
      btn?.classList.toggle('cp-tool-active', !isVisible);
    }

    function toggleAdvancedOptions() {
      const section = document.getElementById('advancedOptions');
      const toggle = document.querySelector('.cp-advanced-toggle');
      const isVisible = section.style.display !== 'none';
      section.style.display = isVisible ? 'none' : 'block';
      toggle?.classList.toggle('cp-open', !isVisible);
    }

    const pollColors = ['#0095f6', '#e1306c', '#833ab4', '#fd1d1d', '#f77737', '#fcaf45', '#405de6', '#5851db'];

    function addPollOption() {
      const container = document.getElementById('pollOptions');
      const optionCount = container.querySelectorAll('.poll-option').length;
      if (optionCount >= 8) {
        InnovateAPI.showAlert('Maximum 8 poll options', 'info');
        return;
      }
      const color = pollColors[optionCount % pollColors.length];
      const row = document.createElement('div');
      row.className = 'cp-poll-option-row';
      row.innerHTML = `
        <span class="cp-poll-dot" style="background: ${color};"></span>
        <input type="text" class="poll-option cp-input" placeholder="Option ${optionCount + 1}">
      `;
      container.appendChild(row);
    }

    function updateDropZoneVisibility() {
      const dropZone = document.getElementById('cpDropZone');
      const hasMedia = selectedImages.some(f => f !== null);
      const hasFiles = selectedFiles.some(f => f !== null);
      if (dropZone) {
        dropZone.style.display = (hasMedia || hasFiles) ? 'none' : 'block';
      }
    }

    // Handle image/video upload for posts
    document.getElementById('postImages')?.addEventListener('change', (e) => {
      const preview = document.getElementById('imagePreview');
      const files = Array.from(e.target.files);
      
      files.forEach((file) => {
        // Video duration check
        if (file.type.startsWith('video/')) {
          const tempVideo = document.createElement('video');
          tempVideo.preload = 'metadata';
          tempVideo.src = URL.createObjectURL(file);
          tempVideo.onloadedmetadata = function() {
            URL.revokeObjectURL(tempVideo.src);
            if (tempVideo.duration > 120) {
              InnovateAPI.showAlert(`Video "${file.name}" is longer than 2 minutes. Please use a shorter video.`, 'error');
              return;
            }
            addMediaPreview(file, preview);
          };
        } else {
          addMediaPreview(file, preview);
        }
      });
      e.target.value = '';
      updateDropZoneVisibility();
    });

    function addMediaPreview(file, preview) {
      const currentIndex = selectedImages.length;
      selectedImages.push(file);
      
      const reader = new FileReader();
      reader.onload = (e) => {
        const div = document.createElement('div');
        div.className = 'media-preview-item';
        div.dataset.index = currentIndex;
        
        if (file.type.startsWith('video/')) {
          div.innerHTML = `
            <video src="${e.target.result}" muted></video>
            <div style="position:absolute;bottom:6px;left:6px;background:rgba(0,0,0,0.7);color:#fff;font-size:11px;padding:2px 6px;border-radius:4px;">VIDEO</div>
            <button class="media-preview-remove" onclick="removeMedia(${currentIndex})">×</button>
          `;
        } else {
          div.innerHTML = `
            <img src="${e.target.result}" alt="Preview">
            <button class="media-preview-remove" onclick="removeMedia(${currentIndex})">×</button>
          `;
        }
        preview.appendChild(div);
        updateDropZoneVisibility();
      };
      reader.readAsDataURL(file);
    }

    // Handle file upload
    document.getElementById('postFiles')?.addEventListener('change', (e) => {
      const filesList = document.getElementById('postFilesList');
      const files = Array.from(e.target.files);
      
      files.forEach(file => {
        const currentIndex = selectedFiles.length;
        selectedFiles.push(file);
        
        // Determine icon based on file type
        const ext = file.name.split('.').pop().toLowerCase();
        const icons = { pdf: '📄', doc: '📝', docx: '📝', txt: '📃', zip: '🗜️', xls: '📊', xlsx: '📊', ppt: '📽️', pptx: '📽️' };
        const icon = icons[ext] || '📎';
        
        const sizeStr = file.size > 1048576 ? `${(file.size / 1048576).toFixed(1)} MB` : `${(file.size / 1024).toFixed(1)} KB`;
        
        const div = document.createElement('div');
        div.className = 'file-preview-item';
        div.dataset.index = currentIndex;
        div.innerHTML = `
          <span>${icon}</span>
          <span style="flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-size: 14px;">${file.name}</span>
          <span style="color: var(--ig-secondary-text); font-size: 12px; white-space: nowrap;">${sizeStr}</span>
          <button class="file-preview-remove" onclick="removeFile(${currentIndex})">×</button>
        `;
        filesList.appendChild(div);
      });
      
      e.target.value = '';
      updateDropZoneVisibility();
    });

    function removeMedia(index) {
      selectedImages[index] = null;
      const preview = document.getElementById('imagePreview');
      const item = preview.querySelector(`[data-index="${index}"]`);
      if (item) item.remove();
      updateDropZoneVisibility();
    }

    function removeFile(index) {
      selectedFiles[index] = null;
      const filesList = document.getElementById('postFilesList');
      const item = filesList.querySelector(`[data-index="${index}"]`);
      if (item) item.remove();
      updateDropZoneVisibility();
    }

    // Drag and drop support
    const dropZone = document.getElementById('cpDropZone');
    if (dropZone) {
      ['dragenter', 'dragover'].forEach(evt => {
        dropZone.addEventListener(evt, (e) => { e.preventDefault(); dropZone.classList.add('cp-drag-over'); });
      });
      ['dragleave', 'drop'].forEach(evt => {
        dropZone.addEventListener(evt, (e) => { e.preventDefault(); dropZone.classList.remove('cp-drag-over'); });
      });
      dropZone.addEventListener('drop', (e) => {
        const files = Array.from(e.dataTransfer.files);
        const preview = document.getElementById('imagePreview');
        files.forEach(file => {
          if (file.type.startsWith('image/') || file.type.startsWith('video/')) {
            addMediaPreview(file, preview);
          }
        });
      });
    }

    // Handle old postImage input for backward compatibility
    document.getElementById('postImage')?.addEventListener('change', (e) => {
      const preview = document.getElementById('imagePreview');
      const files = Array.from(e.target.files);
      files.forEach(file => addMediaPreview(file, preview));
    });

    // Submit post
    async function submitPost() {
      const shareBtn = document.getElementById('cpShareBtn');
      const content = document.getElementById('postContent').value;
      const pollSection = document.getElementById('pollSection');
      const scheduleTime = document.getElementById('scheduleTime').value;
      const enableContact = document.getElementById('enableContact').checked;
      const enableInterested = document.getElementById('enableInterested').checked;
      
      const validImages = selectedImages.filter(f => f !== null);
      const validFiles = selectedFiles.filter(f => f !== null);
      
      if (!content && validImages.length === 0 && validFiles.length === 0) {
        InnovateAPI.showAlert('Please add content or media to share', 'error');
        return;
      }

      // Disable share button while posting
      shareBtn.disabled = true;
      shareBtn.classList.add('cp-sharing');
      shareBtn.textContent = 'Sharing...';
      
      const formData = new FormData();
      formData.append('content', content);
      
      // Extract hashtags from content
      const hashtags = content.match(/#[\w]+/g);
      if (hashtags) {
        formData.append('hashtags', JSON.stringify(hashtags.map(h => h.substring(1))));
      }
      
      // Add images and videos
      validImages.forEach(file => {
        if (file.type.startsWith('video/')) {
          formData.append('video', file);
        } else {
          formData.append('images', file);
        }
      });
      
      // Add files
      validFiles.forEach(file => {
        formData.append('files', file);
      });
      
      // Add poll if created
      if (pollSection.style.display !== 'none') {
        const pollQuestion = document.getElementById('pollQuestion').value;
        const pollOptions = Array.from(document.querySelectorAll('#pollSection .poll-option'))
          .map(input => input.value)
          .filter(val => val.trim());
        const pollExpiry = document.getElementById('pollExpiry').value;
        
        if (pollQuestion && pollOptions.length >= 2) {
          formData.append('poll_question', pollQuestion);
          formData.append('poll_options', JSON.stringify(pollOptions));
          if (pollExpiry) {
            formData.append('poll_expiry', pollExpiry);
          }
        } else if (pollQuestion || pollOptions.length > 0) {
          shareBtn.disabled = false;
          shareBtn.classList.remove('cp-sharing');
          shareBtn.textContent = 'Share';
          InnovateAPI.showAlert('Poll needs a question and at least 2 options', 'error');
          return;
        }
      }
      
      // Add schedule time
      if (scheduleTime) {
        formData.append('scheduled_at', scheduleTime);
      }
      
      // Add action buttons
      formData.append('enable_contact', enableContact ? '1' : '0');
      formData.append('enable_interested', enableInterested ? '1' : '0');
      
      // Add custom button data
      const customButtonData = collectCustomButtonData();
      if (customButtonData) {
        formData.append('custom_button', JSON.stringify(customButtonData));
      }
      
      // Add comment-to-DM data
      const commentDMData = collectCommentDMData();
      if (commentDMData) {
        formData.append('comment_to_dm', JSON.stringify(commentDMData));
      }
      
      try {
        await InnovateAPI.apiRequest('/posts', {
          method: 'POST',
          body: formData,
          headers: {}
        });
        
        InnovateAPI.showAlert(scheduleTime ? 'Post scheduled successfully!' : 'Post shared!', 'success');
        document.getElementById('createPostModal').style.display = 'none';
        selectedImages = [];
        selectedFiles = [];
        loadPosts();
      } catch (error) {
        InnovateAPI.showAlert(error.message || 'Failed to create post', 'error');
      } finally {
        shareBtn.disabled = false;
        shareBtn.classList.remove('cp-sharing');
        shareBtn.textContent = 'Share';
      }
    }

    // Story functions
    function openCreateStoryModal() {
      document.getElementById('createStoryModal').style.display = 'flex';
      updateStoryCharCount();
    }

    function closeCreateStoryModal(event) {
      if (!event || event.target.id === 'createStoryModal') {
        document.getElementById('createStoryModal').style.display = 'none';
        document.getElementById('storyContent').value = '';
        document.getElementById('storyPreview').innerHTML = '';
        const placeholder = document.getElementById('storyPlaceholder');
        if (placeholder) placeholder.style.display = 'flex';
        updateStoryCharCount();
      }
    }

    function updateStoryCharCount() {
      const textarea = document.getElementById('storyContent');
      const counter = document.getElementById('storyCharCount');
      if (textarea && counter) counter.textContent = textarea.value.length;
    }

    function setStoryBg(btn) {
      document.querySelectorAll('.story-color-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      const bg = btn.getAttribute('data-bg');
      const preview = document.getElementById('storyPreviewArea');
      if (preview) preview.style.background = bg;
    }

    // Handle story media upload
    document.getElementById('storyMedia')?.addEventListener('change', (e) => {
      const preview = document.getElementById('storyPreview');
      preview.innerHTML = '';
      const placeholder = document.getElementById('storyPlaceholder');
      
      const file = e.target.files[0];
      if (!file) return;
      
      // Check if video is too long (120 seconds max)
      if (file.type.startsWith('video/')) {
        const video = document.createElement('video');
        video.preload = 'metadata';
        video.onloadedmetadata = function() {
          window.URL.revokeObjectURL(video.src);
          
          video.src = URL.createObjectURL(file);
          video.controls = true;
          video.style.cssText = 'width: 100%; height: 100%; object-fit: cover;';
          preview.appendChild(video);
          if (placeholder) placeholder.style.display = 'none';
        };
        video.src = URL.createObjectURL(file);
      } else {
        const reader = new FileReader();
        reader.onload = (ev) => {
          const img = document.createElement('img');
          img.src = ev.target.result;
          img.style.cssText = 'width: 100%; height: 100%; object-fit: cover;';
          preview.appendChild(img);
          if (placeholder) placeholder.style.display = 'none';
        };
        reader.readAsDataURL(file);
      }
    });

    async function submitStory() {
      const content = document.getElementById('storyContent').value;
      const media = document.getElementById('storyMedia').files[0];
      
      if (!content && !media) {
        InnovateAPI.showAlert('Please add content or media', 'error');
        return;
      }
      
      const formData = new FormData();
      formData.append('content', content);
      formData.append('is_story', 'true');
      
      if (media) {
        if (media.type.startsWith('video/')) {
          formData.append('video', media);
        } else {
          formData.append('images', media);
        }
      }
      
      try {
        await InnovateAPI.apiRequest('/posts', {
          method: 'POST',
          body: formData,
          headers: {}
        });
        
        InnovateAPI.showAlert('Story created!', 'success');
        closeCreateStoryModal();
        loadStories();
      } catch (error) {
        InnovateAPI.showAlert(error.message, 'error');
      }
    }

    let currentStories = [];
    let currentStoryIndex = 0;
    let storyProgressInterval = null;
    let isPaused = false;
    let pausedVideoTime = 0;

    function viewStory(stories, startIndex = 0) {
      currentStories = stories;
      currentStoryIndex = startIndex;
      showCurrentStory();
    }

    async function markStoryAsViewed(storyId) {
      try {
        await InnovateAPI.apiRequest(`/posts/stories/${storyId}/view`, {
          method: 'POST'
        });
        // Reload stories to update ring state after a short delay
        setTimeout(() => loadStories(), 500);
      } catch (error) {
        console.error('Error marking story as viewed:', error);
      }
    }

    function pauseStory() {
      isPaused = true;
      const media = document.getElementById('storyViewerMedia');
      const video = media.querySelector('video');
      
      if (video && !video.paused) {
        video.pause();
        pausedVideoTime = video.currentTime;
      }
      
      if (storyProgressInterval) {
        clearInterval(storyProgressInterval);
      }
    }

    function resumeStory() {
      if (!isPaused) return;
      isPaused = false;
      
      const media = document.getElementById('storyViewerMedia');
      const video = media.querySelector('video');
      
      if (video && video.paused) {
        video.play();
      } else if (!video) {
        // Resume image timer
        const story = currentStories[currentStoryIndex];
        if (story.images && story.images.length > 0) {
          const currentProgressFill = document.getElementById(`storyProgressFill${currentStoryIndex}`);
          const currentWidth = parseFloat(currentProgressFill.style.width) || 0;
          let progressWidth = currentWidth;
          
          storyProgressInterval = setInterval(() => {
            progressWidth += 2;
            currentProgressFill.style.width = progressWidth + '%';
            if (progressWidth >= 100) {
              clearInterval(storyProgressInterval);
              storyProgressInterval = null;
              nextStory();
            }
          }, 100);
        }
      }
    }

    function showCurrentStory() {
      const story = currentStories[currentStoryIndex];
      const modal = document.getElementById('storyViewerModal');
      const avatar = document.getElementById('storyViewerAvatar');
      const username = document.getElementById('storyViewerUsername');
      const time = document.getElementById('storyViewerTime');
      const media = document.getElementById('storyViewerMedia');
      const text = document.getElementById('storyViewerText');
      const progressContainer = document.getElementById('storyProgressBar');
      
      // Mark current story as viewed
      if (story && story.id) {
        markStoryAsViewed(story.id);
      }
      
      // Clear previous progress interval
      if (storyProgressInterval) {
        clearInterval(storyProgressInterval);
        storyProgressInterval = null;
      }
      
      isPaused = false;
      
      // Set user info
      avatar.src = InnovateAPI.getUserAvatar(story.profile_picture);
      username.textContent = story.username;
      time.textContent = InnovateAPI.formatDate(story.created_at);
      
      // Set content
      text.textContent = story.content || '';
      
      // Create progress bars (one per story)
      progressContainer.innerHTML = '';
      currentStories.forEach((_, idx) => {
        const barWrapper = document.createElement('div');
        barWrapper.style.cssText = 'flex: 1; height: 2px; background: rgba(255,255,255,0.3); margin: 0 2px; border-radius: 1px; overflow: hidden;';
        
        const barFill = document.createElement('div');
        barFill.id = `storyProgressFill${idx}`;
        barFill.style.cssText = 'height: 100%; background: white; width: ' + (idx < currentStoryIndex ? '100%' : '0%') + '; transition: width 0.1s linear;';
        
        barWrapper.appendChild(barFill);
        progressContainer.appendChild(barWrapper);
      });
      
      // Set media
      media.innerHTML = '';
      if (story.video_url) {
        const video = document.createElement('video');
        video.src = story.video_url;
        video.autoplay = true;
        video.style.cssText = 'max-width: 100%; max-height: 100%; object-fit: contain;';
        media.appendChild(video);
        
        // Progress bar for video
        const currentProgressFill = document.getElementById(`storyProgressFill${currentStoryIndex}`);
        video.addEventListener('timeupdate', () => {
          const percent = (video.currentTime / video.duration) * 100;
          currentProgressFill.style.width = percent + '%';
        });
        
        video.addEventListener('ended', nextStory);
      } else if (story.images && story.images.length > 0) {
        const img = document.createElement('img');
        img.src = story.images[0];
        img.style.cssText = 'max-width: 100%; max-height: 100%; object-fit: contain;';
        media.appendChild(img);
        
        // Auto progress for image (5 seconds)
        let progressWidth = 0;
        const currentProgressFill = document.getElementById(`storyProgressFill${currentStoryIndex}`);
        storyProgressInterval = setInterval(() => {
          progressWidth += 2;
          currentProgressFill.style.width = progressWidth + '%';
          if (progressWidth >= 100) {
            clearInterval(storyProgressInterval);
            storyProgressInterval = null;
            nextStory();
          }
        }, 100);
      }
      
      modal.style.display = 'flex';
    }

    function nextStory() {
      if (currentStoryIndex < currentStories.length - 1) {
        currentStoryIndex++;
        showCurrentStory();
      } else {
        closeStoryViewer();
      }
    }

    function previousStory() {
      if (currentStoryIndex > 0) {
        currentStoryIndex--;
        showCurrentStory();
      }
    }

    function closeStoryViewer() {
      const modal = document.getElementById('storyViewerModal');
      const media = document.getElementById('storyViewerMedia');
      
      // Stop video if playing
      const video = media.querySelector('video');
      if (video) {
        video.pause();
      }
      
      // Clear progress interval
      if (storyProgressInterval) {
        clearInterval(storyProgressInterval);
        storyProgressInterval = null;
      }
      
      currentStories = [];
      currentStoryIndex = 0;
      
      modal.style.display = 'none';
    }

    // Keyboard navigation for stories
    document.addEventListener('keydown', (e) => {
      const modal = document.getElementById('storyViewerModal');
      if (modal.style.display === 'flex') {
        if (e.key === 'ArrowRight') {
          nextStory();
        } else if (e.key === 'ArrowLeft') {
          previousStory();
        } else if (e.key === 'Escape') {
          closeStoryViewer();
        }
      }
    });

    // Search handler
    document.getElementById('searchInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        const query = e.target.value.trim();
        if (query) {
          window.location.href = `/search?q=${encodeURIComponent(query)}`;
        }
      }
    });

    // === Instagram-style scroll-to-hide top nav ===
    (function() {
      let lastScrollY = 0;
      let ticking = false;
      const topNav = document.querySelector('.ig-top-nav');
      if (topNav) {
        window.addEventListener('scroll', () => {
          if (!ticking) {
            window.requestAnimationFrame(() => {
              const currentY = window.scrollY;
              if (currentY > lastScrollY && currentY > 60) {
                // Scrolling down — hide
                topNav.classList.add('ig-nav-hidden');
              } else {
                // Scrolling up — show
                topNav.classList.remove('ig-nav-hidden');
              }
              lastScrollY = currentY;
              ticking = false;
            });
            ticking = true;
          }
        }, { passive: true });
      }
    })();

    // === Feed dropdown toggle (For You / Following) ===
    (function() {
      const navLeft = document.querySelector('.ig-nav-left');
      if (!navLeft) return;
      navLeft.style.cursor = 'pointer';
      navLeft.addEventListener('click', (e) => {
        e.preventDefault();
        // Remove existing dropdown if open
        const existing = document.getElementById('igFeedDropdown');
        if (existing) { existing.remove(); return; }

        const dd = document.createElement('div');
        dd.id = 'igFeedDropdown';
        dd.className = 'ig-feed-dropdown';
        const currentFeed = sessionStorage.getItem('feedType') || 'foryou';
        dd.innerHTML = `
          <div class="ig-feed-dd-item ${currentFeed === 'foryou' ? 'active' : ''}" data-feed="foryou">
            <span>For You</span>
            ${currentFeed === 'foryou' ? '<svg width="16" height="16" viewBox="0 0 24 24" fill="var(--ig-primary-text)" stroke="none"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>' : ''}
          </div>
          <div class="ig-feed-dd-item ${currentFeed === 'following' ? 'active' : ''}" data-feed="following">
            <span>Following</span>
            ${currentFeed === 'following' ? '<svg width="16" height="16" viewBox="0 0 24 24" fill="var(--ig-primary-text)" stroke="none"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>' : ''}
          </div>
        `;
        document.body.appendChild(dd);

        // Position it below the logo
        const rect = navLeft.getBoundingClientRect();
        dd.style.top = (rect.bottom + 8) + 'px';
        dd.style.left = rect.left + 'px';

        dd.querySelectorAll('.ig-feed-dd-item').forEach(item => {
          item.addEventListener('click', () => {
            const feedType = item.dataset.feed;
            sessionStorage.setItem('feedType', feedType);
            dd.remove();
            // Update chevron direction
            const chevron = document.querySelector('.ig-logo-dropdown');
            if (chevron) chevron.classList.remove('ig-chevron-open');
            loadPosts();
          });
        });

        // Rotate chevron
        const chevron = document.querySelector('.ig-logo-dropdown');
        if (chevron) chevron.classList.add('ig-chevron-open');

        // Close on outside click
        setTimeout(() => {
          document.addEventListener('click', function closeDd(ev) {
            if (!dd.contains(ev.target) && !navLeft.contains(ev.target)) {
              dd.remove();
              if (chevron) chevron.classList.remove('ig-chevron-open');
              document.removeEventListener('click', closeDd);
            }
          });
        }, 10);
      });
    })();

    // Initialize
    loadUserAvatar();
    loadStories();
    loadPosts();

    
    // Image zoom function
    function zoomImage(imgSrc) {
      const modal = document.createElement('div');
      modal.className = 'ig-zoom-modal';
      modal.innerHTML = `
        <div class="ig-zoom-overlay" onclick="this.parentElement.remove()">
          <img src="${imgSrc}" class="ig-zoom-image" onclick="event.stopPropagation()">
          <button class="ig-zoom-close" onclick="this.parentElement.parentElement.remove()">×</button>
        </div>
      `;
      document.body.appendChild(modal);
      
      // Enable pinch to zoom
      const img = modal.querySelector('.ig-zoom-image');
      let scale = 1;
      let lastDistance = 0;
      
      img.addEventListener('touchstart', (e) => {
        if (e.touches.length === 2) {
          lastDistance = Math.hypot(
            e.touches[0].pageX - e.touches[1].pageX,
            e.touches[0].pageY - e.touches[1].pageY
          );
        }
      });
      
      img.addEventListener('touchmove', (e) => {
        if (e.touches.length === 2) {
          e.preventDefault();
          const distance = Math.hypot(
            e.touches[0].pageX - e.touches[1].pageX,
            e.touches[0].pageY - e.touches[1].pageY
          );
          
          if (lastDistance > 0) {
            scale *= distance / lastDistance;
            scale = Math.max(0.5, Math.min(scale, 4));
            img.style.transform = `scale(${scale})`;
          }
          
          lastDistance = distance;
        }
      });
      
      img.addEventListener('touchend', () => {
        lastDistance = 0;
      });
    }
    
    // ====== Generic Bottom Sheet Drag Utility ======
    // Supports: drag down to dismiss, drag up to expand, touch + mouse
    
    // Full-screen post viewer with vertical scrolling
    // Helper function to extract plain text from HTML content
    function getPlainText(htmlContent) {
      if (!htmlContent) return '';
      const div = document.createElement('div');
      div.innerHTML = htmlContent;
      return div.textContent || div.innerText || '';
    }

    function escapeHtml(str) {
      return String(str ?? '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    function formatBytes(bytes) {
      const num = Number(bytes);
      if (!Number.isFinite(num) || num <= 0) return '';
      const units = ['B', 'KB', 'MB', 'GB'];
      const i = Math.min(Math.floor(Math.log(num) / Math.log(1024)), units.length - 1);
      const value = num / Math.pow(1024, i);
      return `${value.toFixed(i === 0 ? 0 : 1)} ${units[i]}`;
    }

    function getFileExtension(nameOrPath) {
      const s = String(nameOrPath || '');
      const idx = s.lastIndexOf('.');
      return idx >= 0 ? s.slice(idx + 1).toLowerCase() : '';
    }

    // --- PDF Viewer (LinkedIn-style) via PDF.js (loaded from CDN) ---
    const pdfDocCache = new Map();

    function isPdfFile(nameOrUrl) {
      return getFileExtension(nameOrUrl) === 'pdf';
    }

    function ensurePdfJsLoaded() {
      if (window.pdfjsLib) return Promise.resolve(window.pdfjsLib);

      return new Promise((resolve, reject) => {
        const existing = document.querySelector('script[data-pdfjs]');
        if (existing) {
          existing.addEventListener('load', () => resolve(window.pdfjsLib));
          existing.addEventListener('error', reject);
          return;
        }

        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js';
        script.async = true;
        script.setAttribute('data-pdfjs', 'true');
        script.onload = () => {
          try {
            // Worker must be explicitly set when loading from CDN.
            window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js';
          } catch (_) {
            // Best-effort; pdf.js will fallback in some environments.
          }
          resolve(window.pdfjsLib);
        };
        script.onerror = reject;
        document.head.appendChild(script);
      });
    }

    async function loadPdfDocument(url) {
      const key = String(url || '');
      if (!key) return null;
      if (pdfDocCache.has(key)) return pdfDocCache.get(key);

      const pdfjsLib = await ensurePdfJsLoaded();
      const loadingTask = pdfjsLib.getDocument({ url: key, withCredentials: true });
      const pdf = await loadingTask.promise;
      pdfDocCache.set(key, pdf);
      return pdf;
    }

    async function renderPdfPageToCanvas(pdf, pageNumber, canvas) {
      if (!pdf || !canvas) return;
      const page = await pdf.getPage(pageNumber);
      const ctx = canvas.getContext('2d');

      // Fit page to container width with high DPI support for sharp rendering
      const container = canvas.parentElement;
      const targetWidth = Math.max(320, (container?.clientWidth || 800));
      const dpr = window.devicePixelRatio || 1;
      const viewport = page.getViewport({ scale: 1 });
      const scale = (targetWidth / viewport.width) * dpr;
      const scaledViewport = page.getViewport({ scale });

      // Set canvas internal resolution to high-DPI
      canvas.width = Math.floor(scaledViewport.width);
      canvas.height = Math.floor(scaledViewport.height);
      // CSS size stays at logical pixels
      canvas.style.width = Math.floor(scaledViewport.width / dpr) + 'px';
      canvas.style.height = Math.floor(scaledViewport.height / dpr) + 'px';

      // Crisp rendering
      ctx.imageSmoothingEnabled = true;
      ctx.imageSmoothingQuality = 'high';

      await page.render({ canvasContext: ctx, viewport: scaledViewport }).promise;
    }

    function renderAttachments(post, options = {}) {
      const asMedia = !!options.asMedia;
      const files = Array.isArray(post?.files) ? post.files : [];
      if (!files.length) return '';

      const items = files
        .filter(f => f && (f.path || f.name))
        .map((f, idx) => {
          const name = f.name || 'Attachment';
          const url = f.path || '';
          const ext = getFileExtension(name) || getFileExtension(url);
          const size = f.size ? formatBytes(f.size) : '';
          const safeName = escapeHtml(name);
          const safeUrl = escapeHtml(url);
          const safeSize = escapeHtml(size);

          // LinkedIn-like inline preview for PDFs.
          if (ext === 'pdf') {
            const canvasId = `pdf-canvas-${post.id}-${idx}`;
            return `
              <div class="ig-pdf-embed" data-attachment-url="${safeUrl}" data-attachment-name="${safeName}" data-canvas-id="${canvasId}" role="button" tabindex="0">
                <div class="ig-pdf-embed-header">
                  <span class="ig-pdf-embed-badge">PDF</span>
                  <span class="ig-pdf-embed-title">${safeName}</span>
                  ${safeSize ? `<span class=\"ig-pdf-embed-size\">${safeSize}</span>` : ''}
                </div>
                <div class="ig-pdf-embed-preview">
                  <canvas id="${canvasId}"></canvas>
                </div>
                <div class="ig-pdf-embed-controls">
                  <button type="button" class="ig-pdf-ctrl" data-pdf-action="prev" aria-label="Previous page">‹</button>
                  <span class="ig-pdf-page"><span data-pdf-page>1</span><span class="ig-pdf-sep">/</span><span data-pdf-pages>…</span></span>
                  <button type="button" class="ig-pdf-ctrl" data-pdf-action="next" aria-label="Next page">›</button>
                  <button type="button" class="ig-pdf-ctrl" data-pdf-action="expand" aria-label="Open" style="margin-left: auto;">⤢</button>
                </div>
              </div>
            `;
          }

          // Default attachment card (non-PDF)
          const label = ext ? ext.toUpperCase() : 'FILE';
          const safeLabel = escapeHtml(label);
          return `
            <button type="button" class="ig-attachment-item" data-attachment-url="${safeUrl}" data-attachment-name="${safeName}" style="width: 100%; text-align: left; background: none; border: none; padding: 0; cursor: pointer;">
              <div style="display: flex; gap: 12px; padding: 12px; border: 1px solid var(--ig-border); border-radius: 8px; background: var(--ig-secondary-background);">
                <div style="width: 44px; height: 44px; border-radius: 10px; background: var(--ig-primary-background); border: 1px solid var(--ig-border); display: flex; align-items: center; justify-content: center; font-weight: 700; color: var(--ig-primary-text); flex-shrink: 0;">
                  ${safeLabel}
                </div>
                <div style="flex: 1; min-width: 0;">
                  <div style="font-weight: 600; color: var(--ig-primary-text); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${safeName}</div>
                  ${safeSize ? `<div style=\"font-size: 12px; color: var(--ig-secondary-text); margin-top: 2px;\">${safeSize}</div>` : ''}
                </div>
              </div>
            </button>
          `;
        })
        .join('');

      return `
        <div class="ig-post-attachments" style="padding: ${asMedia ? '0' : '0 16px'}; margin: ${asMedia ? '0' : '10px 0 4px'}; display: grid; gap: 8px;">
          ${items}
        </div>
      `;
    }

    async function initPdfEmbed(embedEl) {
      try {
        const url = embedEl.getAttribute('data-attachment-url') || '';
        const name = embedEl.getAttribute('data-attachment-name') || 'Document';
        // Find canvas within this embed element to avoid duplicate ID conflicts
        const canvas = embedEl.querySelector('.ig-pdf-embed-preview canvas');
        if (!url || !canvas) return;

        const pdf = await loadPdfDocument(url);
        if (!pdf) return;

        const pagesEl = embedEl.querySelector('[data-pdf-pages]');
        const pageEl = embedEl.querySelector('[data-pdf-page]');
        if (pagesEl) pagesEl.textContent = String(pdf.numPages || 1);

        let currentPage = 1;

        // Render the first page as the preview.
        await renderPdfPageToCanvas(pdf, 1, canvas);

        // Prev/Next buttons navigate inline pages
        const prevBtn = embedEl.querySelector('[data-pdf-action="prev"]');
        const nextBtn = embedEl.querySelector('[data-pdf-action="next"]');
        const expandBtn = embedEl.querySelector('[data-pdf-action="expand"]');

        if (prevBtn) {
          prevBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            e.stopPropagation();
            if (currentPage > 1) {
              currentPage--;
              if (pageEl) pageEl.textContent = String(currentPage);
              await renderPdfPageToCanvas(pdf, currentPage, canvas);
            }
          });
        }

        if (nextBtn) {
          nextBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            e.stopPropagation();
            if (currentPage < pdf.numPages) {
              currentPage++;
              if (pageEl) pageEl.textContent = String(currentPage);
              await renderPdfPageToCanvas(pdf, currentPage, canvas);
            }
          });
        }

        if (expandBtn) {
          expandBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            openPdfModal(url, name);
          });
        }

        // Clicking the preview opens the modal.
        embedEl.addEventListener('click', (e) => {
          // ignore clicks that originate from a button (already handled)
          if (e.target && e.target.closest && e.target.closest('[data-pdf-action]')) return;
          e.stopPropagation();
          openPdfModal(url, name);
        });

        embedEl.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            openPdfModal(url, name);
          }
        });
      } catch (e) {
        // If PDF.js fails for any reason, keep the UI but avoid breaking the feed.
        console.warn('PDF preview init failed', e);
      }
    }

    function initPdfEmbeds(rootEl) {
      const root = rootEl || document;
      root.querySelectorAll('.ig-pdf-embed').forEach((embed) => {
        if (embed.getAttribute('data-pdf-initialized') === 'true') return;
        embed.setAttribute('data-pdf-initialized', 'true');
        initPdfEmbed(embed);
      });
    }

    function openAttachment(url, name) {
      const ext = getFileExtension(name) || getFileExtension(url);
      if (ext === 'pdf') {
        openPdfModal(url, name);
        return;
      }
      if (url) window.open(url, '_blank', 'noopener');
    }

    async function openPdfModal(url, name) {
      if (!url) return;

      const previousOverflow = document.body.style.overflow;
      document.body.style.overflow = 'hidden';

      const modal = document.createElement('div');
      modal.className = 'ig-modal-overlay';
      modal.style.display = 'flex';

      const safeTitle = escapeHtml(name || 'Document');
      const safeUrl = escapeHtml(url);

      modal.innerHTML = `
        <div class="pdf-viewer-modal" onclick="event.stopPropagation()">
          <div class="pdf-viewer-header">
            <div class="pdf-viewer-title">
              <span class="pdf-viewer-badge">PDF</span>
              <span class="pdf-viewer-name">${safeTitle}</span>
            </div>
            <button type="button" aria-label="Close" class="pdf-viewer-close" data-close-modal>
              <svg width="18" height="18" fill="currentColor" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
            </button>
          </div>
          <div class="pdf-viewer-body">
            <canvas id="igPdfModalCanvas"></canvas>
          </div>
          <div class="pdf-viewer-controls">
            <button type="button" class="pdf-ctrl-btn" data-pdf-modal="prev" title="Previous page">‹</button>
            <span class="pdf-page-indicator"><span id="igPdfPage">1</span> / <span id="igPdfPages">…</span></span>
            <button type="button" class="pdf-ctrl-btn" data-pdf-modal="next" title="Next page">›</button>
            <a class="pdf-open-btn" href="${safeUrl}" target="_blank" rel="noopener">Open</a>
          </div>
        </div>
      `;

      let resizeTimer;
      let onResize;

      const close = () => {
        document.removeEventListener('keydown', onKeyDown);
        window.removeEventListener('resize', onResize);
        document.body.style.overflow = previousOverflow;
        modal.remove();
      };

      const onKeyDown = (e) => {
        if (e.key === 'Escape') close();
        if (e.key === 'ArrowLeft') modal.querySelector('[data-pdf-modal="prev"]')?.click();
        if (e.key === 'ArrowRight') modal.querySelector('[data-pdf-modal="next"]')?.click();
      };

      onResize = () => {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(() => {
          modal.__igPdfRender?.().catch(() => {});
        }, 100);
      };

      document.addEventListener('keydown', onKeyDown);
      window.addEventListener('resize', onResize);
      modal.addEventListener('click', (e) => {
        if (e.target === modal) close();
      });
      modal.querySelector('[data-close-modal]')?.addEventListener('click', (e) => {
        e.preventDefault();
        close();
      });
      modal.querySelector('.pdf-viewer-modal')?.addEventListener('click', (e) => e.stopPropagation());

      document.body.appendChild(modal);

      // Load + render with PDF.js (with iframe fallback if PDF.js fails)
      let pdf;
      try {
        pdf = await loadPdfDocument(url);
      } catch (e) {
        console.warn('PDF.js load failed, falling back to iframe', e);
        const body = modal.querySelector('.pdf-viewer-body');
        if (body) {
          body.innerHTML = `<iframe src="${safeUrl}" title="${safeTitle}" style="width:100%; height:100%; border:0; background: var(--ig-primary-background);"></iframe>`;
        }
        return;
      }

      const canvas = modal.querySelector('#igPdfModalCanvas');
      const pageEl = modal.querySelector('#igPdfPage');
      const pagesEl = modal.querySelector('#igPdfPages');
      const prevBtn = modal.querySelector('[data-pdf-modal="prev"]');
      const nextBtn = modal.querySelector('[data-pdf-modal="next"]');
      if (pagesEl) pagesEl.textContent = String(pdf.numPages || 1);

      let currentPage = 1;
      const render = async () => {
        if (pageEl) pageEl.textContent = String(currentPage);
        if (prevBtn) prevBtn.disabled = currentPage <= 1;
        if (nextBtn) nextBtn.disabled = currentPage >= pdf.numPages;
        await renderPdfPageToCanvas(pdf, currentPage, canvas);
      };
      modal.__igPdfRender = render;
      await render();

      prevBtn?.addEventListener('click', async (e) => {
        e.preventDefault();
        if (currentPage > 1) {
          currentPage -= 1;
          await render();
        }
      });

      nextBtn?.addEventListener('click', async (e) => {
        e.preventDefault();
        const max = Number(pdf.numPages || 1);
        if (currentPage < max) {
          currentPage += 1;
          await render();
        }
      });
    }
    

    // Set datetime inputs to India timezone (IST = UTC+5:30)
    function setIndiaDateTime() {
      const now = new Date();
      // Convert to IST
      const istOffset = 5.5 * 60; // IST is UTC+5:30
      const istTime = new Date(now.getTime() + (istOffset * 60000));
      const localTime = istTime.toISOString().slice(0, 16);
      
      const scheduleInput = document.getElementById('scheduleTime');
      const pollExpiryInput = document.getElementById('pollExpiry');
      
      if (scheduleInput) scheduleInput.min = localTime;
      if (pollExpiryInput) pollExpiryInput.min = localTime;
    }
    
    setIndiaDateTime();



    // Check for new messages/notifications periodically
    setInterval(async () => {
      try {
        const messages = await InnovateAPI.apiRequest('/messages/conversations');
        const hasUnread = messages.conversations.some(c => c.unread_count > 0);
        document.getElementById('messageDot').style.display = hasUnread ? 'block' : 'none';
      } catch (error) {
        console.error('Error checking messages:', error);
      }
    }, 30000); // Every 30 seconds


    // ========== Custom Button Builder Functions ==========

    function resetCustomButtonBuilder() {
      const nameInput = document.getElementById('cbButtonName');
      if (nameInput) nameInput.value = '';
      
      ['cbContactMe', 'cbDM', 'cbRegister', 'cbHireMe'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.checked = false;
      });
      
      ['cbContactFields', 'cbDMFields', 'cbRegisterFields', 'cbHireMeFields'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = 'none';
      });
      
      // Reset contact multi-fields to single row
      ['cbLinksGroup', 'cbEmailsGroup', 'cbPhonesGroup'].forEach(gid => {
        const grp = document.getElementById(gid);
        if (!grp) return;
        const label = grp.querySelector('.cb-field-label')?.textContent || '';
        const type = gid === 'cbLinksGroup' ? 'url' : gid === 'cbEmailsGroup' ? 'email' : 'tel';
        const ph = gid === 'cbLinksGroup' ? 'https://...' : gid === 'cbEmailsGroup' ? 'email@example.com' : '+1234567890';
        const cls = gid === 'cbLinksGroup' ? 'cb-link-input' : gid === 'cbEmailsGroup' ? 'cb-email-input' : 'cb-phone-input';
        const rows = grp.querySelectorAll('.cb-multi-row');
        rows.forEach((r, i) => { if (i > 0) r.remove(); });
        const firstInput = grp.querySelector('input');
        if (firstInput) firstInput.value = '';
      });
      
      const dmMsg = document.getElementById('cbDMMessage');
      if (dmMsg) dmMsg.value = '';
      
      const regLink = document.getElementById('cbRegisterLink');
      if (regLink) regLink.value = '';
      
      // Reset hire me checkboxes
      ['cbHireName', 'cbHireEmail', 'cbHireContact'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.checked = true;
      });
      const resumeChk = document.getElementById('cbHireResume');
      if (resumeChk) resumeChk.checked = false;
      
      const customFieldsList = document.getElementById('cbCustomFieldsList');
      if (customFieldsList) customFieldsList.innerHTML = '';
    }

    function toggleCBSection(sectionId) {
      const section = document.getElementById(sectionId);
      if (!section) return;
      // Map section IDs to their corresponding checkbox IDs
      const mapping = {
        'cbContactFields': 'cbContactMe',
        'cbDMFields': 'cbDM',
        'cbRegisterFields': 'cbRegister',
        'cbHireMeFields': 'cbHireMe',
        'commentDMFields': 'enableCommentDM',
        'cdmNotFollowingSection': 'cdmRequireFollow'
      };
      const chk = document.getElementById(mapping[sectionId]);
      section.style.display = chk && chk.checked ? 'block' : 'none';
    }

    function addCBField(groupId, type, placeholder) {
      const group = document.getElementById(groupId);
      if (!group) return;
      const rows = group.querySelectorAll('.cb-multi-row');
      if (rows.length >= 5) {
        InnovateAPI.showAlert('Maximum 5 entries', 'info');
        return;
      }
      const row = document.createElement('div');
      row.className = 'cb-multi-row';
      row.innerHTML = `
        <input type="${type}" class="cp-input" placeholder="${placeholder}">
        <button type="button" class="cb-remove-btn" onclick="this.parentElement.remove()">×</button>
      `;
      group.appendChild(row);
    }

    function addCBCustomField() {
      const list = document.getElementById('cbCustomFieldsList');
      if (!list) return;
      const count = list.querySelectorAll('.cb-custom-field-row').length;
      if (count >= 5) {
        InnovateAPI.showAlert('Maximum 5 custom fields', 'info');
        return;
      }
      const row = document.createElement('div');
      row.className = 'cb-custom-field-row';
      row.innerHTML = `
        <input type="text" class="cp-input" placeholder="Field name (e.g. Portfolio URL)">
        <button type="button" class="cb-remove-btn" onclick="this.parentElement.remove()">×</button>
      `;
      list.appendChild(row);
    }

    function collectCustomButtonData() {
      const name = document.getElementById('cbButtonName')?.value?.trim();
      const contactMe = document.getElementById('cbContactMe')?.checked;
      const dm = document.getElementById('cbDM')?.checked;
      const register = document.getElementById('cbRegister')?.checked;
      const hireMe = document.getElementById('cbHireMe')?.checked;

      // Only create custom button if name is provided and at least one option is checked
      if (!name || (!contactMe && !dm && !register && !hireMe)) return null;

      const data = { name };

      if (contactMe) {
        const links = getMultiFieldValues('cbLinksGroup');
        const emails = getMultiFieldValues('cbEmailsGroup');
        const phones = getMultiFieldValues('cbPhonesGroup');
        data.contact_me = { enabled: true, links, emails, phones };
      }

      if (dm) {
        const message = document.getElementById('cbDMMessage')?.value?.trim() || '';
        data.dm = { enabled: true, message };
      }

      if (register) {
        const link = document.getElementById('cbRegisterLink')?.value?.trim() || '';
        data.register = { enabled: true, link };
      }

      if (hireMe) {
        const fields = [];
        if (document.getElementById('cbHireName')?.checked) fields.push('name');
        if (document.getElementById('cbHireEmail')?.checked) fields.push('email');
        if (document.getElementById('cbHireContact')?.checked) fields.push('contact');
        if (document.getElementById('cbHireResume')?.checked) fields.push('resume_link');
        
        const customFields = [];
        document.querySelectorAll('#cbCustomFieldsList .cb-custom-field-row input').forEach(inp => {
          const val = inp.value.trim();
          if (val) customFields.push(val);
        });
        
        data.hire_me = { enabled: true, fields, custom_fields: customFields };
      }

      return data;
    }

    function getMultiFieldValues(groupId) {
      const group = document.getElementById(groupId);
      if (!group) return [];
      const values = [];
      group.querySelectorAll('.cb-multi-row input').forEach(inp => {
        const val = inp.value.trim();
        if (val) values.push(val);
      });
      return values;
    }

    // ========== Comment to DM Functions ==========

    function addCDMItem() {
      const list = document.getElementById('cdmItemsList');
      const idx = list.querySelectorAll('.cdm-item').length;
      const item = document.createElement('div');
      item.className = 'cdm-item';
      item.dataset.idx = idx;
      item.innerHTML = `
        <input type="text" class="cp-input cdm-item-label" placeholder="Custom button name" value="">
        <input type="text" class="cp-input cdm-item-content" placeholder="Link or content to send" value="">
        <button type="button" class="cdm-item-remove" onclick="this.parentElement.remove()">&times;</button>
      `;
      list.appendChild(item);
    }

    function collectCommentDMData() {
      const enabled = document.getElementById('enableCommentDM')?.checked;
      if (!enabled) return null;

      const requireFollow = document.getElementById('cdmRequireFollow')?.checked || false;
      const notFollowMsg = document.getElementById('cdmNotFollowMsg')?.value?.trim() || '';
      const dmMessage = document.getElementById('cdmDMMessage')?.value?.trim() || '';

      const items = [];
      document.querySelectorAll('#cdmItemsList .cdm-item').forEach(el => {
        const label = el.querySelector('.cdm-item-label')?.value?.trim();
        const content = el.querySelector('.cdm-item-content')?.value?.trim();
        if (label && content) items.push({ label, content });
      });

      if (items.length === 0) return null;

      return {
        enabled: true,
        require_follow: requireFollow,
        not_following_msg: notFollowMsg,
        dm_message: dmMessage,
        items: items
      };
    }

    function resetCommentDM() {
      const el = document.getElementById('enableCommentDM');
      if (el) el.checked = false;
      const fields = document.getElementById('commentDMFields');
      if (fields) fields.style.display = 'none';
      const follow = document.getElementById('cdmRequireFollow');
      if (follow) follow.checked = true;
      const msg = document.getElementById('cdmNotFollowMsg');
      if (msg) msg.value = '';
      const dmMsg = document.getElementById('cdmDMMessage');
      if (dmMsg) dmMsg.value = '';
      const list = document.getElementById('cdmItemsList');
      if (list) list.innerHTML = `<div class="cdm-item" data-idx="0">
        <input type="text" class="cp-input cdm-item-label" placeholder="Custom button name (e.g. Get Link, Download)" value="">
        <input type="text" class="cp-input cdm-item-content" placeholder="Link or content to send" value="">
      </div>`;
    }

    // ========== Custom Button Action Modal (on post view) ==========

    function openCustomButtonModal(postId, postUserId, configJson) {
      const config = typeof configJson === 'string' ? JSON.parse(configJson) : configJson;
      const currentUser = InnovateAPI.getCurrentUser();
      const isOwnPost = currentUser && currentUser.id == postUserId;

      // Normalize legacy field names: contact → contact_me, hire → hire_me
      if (config.contact && !config.contact_me) config.contact_me = config.contact;
      if (config.hire && !config.hire_me) config.hire_me = config.hire;

      // === Direct-open shortcut ===
      // If only Register link is configured, open it directly
      // Tolerate missing "enabled" — if the sub-object exists, treat it as enabled
      const hasContact = config.contact_me && (config.contact_me.enabled !== false) && (
        (config.contact_me.links && config.contact_me.links.length) ||
        (config.contact_me.emails && config.contact_me.emails.length) ||
        (config.contact_me.phones && config.contact_me.phones.length)
      );
      const hasRegister = config.register && (config.register.enabled !== false) && config.register.link;
      const hasDM = config.dm && (config.dm.enabled !== false) && !isOwnPost;
      const hasHireMe = config.hire_me && (config.hire_me.enabled !== false) && !isOwnPost;
      const enabledCount = [hasContact, hasRegister, hasDM, hasHireMe].filter(Boolean).length;

      // If only one action enabled, open it directly
      if (enabledCount === 1) {
        if (hasRegister) {
          window.open(config.register.link, '_blank', 'noopener');
          return;
        }
        if (hasContact) {
          const c = config.contact_me;
          // If only one contact method, open directly
          const allItems = [...(c.links||[]), ...(c.emails||[]).map(e=>'mailto:'+e), ...(c.phones||[]).map(p=>'tel:'+p)];
          if (allItems.length === 1) {
            window.open(allItems[0], '_blank', 'noopener');
            return;
          }
        }
      }

      // Remove any existing modal
      document.getElementById('cbActionModal')?.remove();

      let sections = '';

      // Contact Me section
      if (config.contact_me && config.contact_me.enabled !== false) {
        let items = '';
        (config.contact_me.links || []).forEach(link => {
          items += `<a href="${escapeHtml(link)}" target="_blank" rel="noopener" class="cb-contact-item">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--ig-blue)" stroke-width="2"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"/></svg>
            <span>${escapeHtml(link)}</span>
          </a>`;
        });
        (config.contact_me.emails || []).forEach(email => {
          items += `<a href="mailto:${escapeHtml(email)}" class="cb-contact-item">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#e1306c" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
            <span>${escapeHtml(email)}</span>
          </a>`;
        });
        (config.contact_me.phones || []).forEach(phone => {
          items += `<a href="tel:${escapeHtml(phone)}" class="cb-contact-item">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#00c853" stroke-width="2"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.42 19.42 0 01-6-6A19.79 19.79 0 012.12 4.18 2 2 0 014.11 2h3a2 2 0 012 1.72c.127.96.361 1.903.7 2.81a2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0122 16.92z"/></svg>
            <span>${escapeHtml(phone)}</span>
          </a>`;
        });
        if (items) {
          sections += `<div class="cb-modal-section">
            <div class="cb-modal-section-title">📞 Contact Information</div>
            ${items}
          </div>`;
        }
      }

      // Register section
      if (config.register && config.register.enabled !== false && config.register.link) {
        sections += `<div class="cb-modal-section">
          <div class="cb-modal-section-title">📝 Register</div>
          <a href="${escapeHtml(config.register.link)}" target="_blank" rel="noopener" class="cb-contact-item" style="color: var(--ig-blue); font-weight: 600;">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--ig-blue)" stroke-width="2"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
            <span>Open Registration Page</span>
          </a>
        </div>`;
      }

      // DM section
      if (config.dm && config.dm.enabled !== false && !isOwnPost) {
        const prefilledMsg = config.dm.message ? escapeHtml(config.dm.message) : '';
        sections += `<div class="cb-modal-section">
          <div class="cb-modal-section-title">💬 Send Message</div>
          <div class="cb-dm-input-area">
            <textarea id="cbDMActionMsg" placeholder="Write your message..." rows="3">${prefilledMsg}</textarea>
            <button class="cb-submit-btn" onclick="sendCustomDM(${postId}, this)">Send Message</button>
          </div>
        </div>`;
      }

      // Hire Me section
      if (config.hire_me && config.hire_me.enabled !== false && !isOwnPost) {
        let formFields = '';
        const fields = config.hire_me.fields || [];
        
        if (fields.includes('name')) {
          formFields += `<div class="cb-hire-form-group"><label>👤 Name</label><input type="text" id="cbHireFormName" placeholder="Your full name" required></div>`;
        }
        if (fields.includes('email')) {
          formFields += `<div class="cb-hire-form-group"><label>📧 Email</label><input type="email" id="cbHireFormEmail" placeholder="your@email.com" required></div>`;
        }
        if (fields.includes('contact')) {
          formFields += `<div class="cb-hire-form-group"><label>📞 Contact Number</label><input type="tel" id="cbHireFormContact" placeholder="+1234567890"></div>`;
        }
        if (fields.includes('resume_link')) {
          formFields += `<div class="cb-hire-form-group"><label>📎 Resume Link</label><input type="url" id="cbHireFormResume" placeholder="https://drive.google.com/..."></div>`;
        }
        
        // Custom fields
        (config.hire_me.custom_fields || []).forEach((fieldName, idx) => {
          formFields += `<div class="cb-hire-form-group"><label>📝 ${escapeHtml(fieldName)}</label><input type="text" class="cb-hire-custom-input" data-field-name="${escapeHtml(fieldName)}" placeholder="Enter ${escapeHtml(fieldName)}"></div>`;
        });

        if (formFields) {
          sections += `<div class="cb-modal-section">
            <div class="cb-modal-section-title">💼 Hire Me - Application Form</div>
            <form id="cbHireForm" onsubmit="submitHireForm(event, ${postId})">
              ${formFields}
              <button type="submit" class="cb-submit-btn">Submit Application</button>
            </form>
          </div>`;
        }
      }

      if (!sections) {
        InnovateAPI.showAlert('No actions available', 'info');
        return;
      }

      // Create modal
      const modal = document.createElement('div');
      modal.id = 'cbActionModal';
      modal.className = 'cb-modal-overlay';
      modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
      modal.innerHTML = `
        <div class="cb-modal" onclick="event.stopPropagation()">
          <div class="cb-modal-header">
            <h3 class="cb-modal-title">${escapeHtml(config.name || 'Action')}</h3>
            <button class="cb-modal-close" onclick="document.getElementById('cbActionModal').remove()">×</button>
          </div>
          <div class="cb-modal-body">${sections}</div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    async function sendCustomDM(postId, btn) {
      const textarea = document.getElementById('cbDMActionMsg');
      const message = textarea?.value?.trim();
      if (!message) {
        InnovateAPI.showAlert('Please enter a message', 'error');
        return;
      }
      btn.disabled = true;
      btn.textContent = 'Sending...';
      try {
        await InnovateAPI.apiRequest(`/posts/${postId}/custom-button-action`, {
          method: 'POST',
          body: JSON.stringify({ action: 'dm', message })
        });
        InnovateAPI.showAlert('Message sent successfully!', 'success');
        document.getElementById('cbActionModal')?.remove();
      } catch (error) {
        InnovateAPI.showAlert(error.message || 'Failed to send message', 'error');
        btn.disabled = false;
        btn.textContent = 'Send Message';
      }
    }

    async function submitHireForm(event, postId) {
      event.preventDefault();
      const form = document.getElementById('cbHireForm');
      const submitBtn = form.querySelector('.cb-submit-btn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Submitting...';

      const hire_data = {};
      const nameInput = document.getElementById('cbHireFormName');
      const emailInput = document.getElementById('cbHireFormEmail');
      const contactInput = document.getElementById('cbHireFormContact');
      const resumeInput = document.getElementById('cbHireFormResume');

      if (nameInput) hire_data.name = nameInput.value.trim();
      if (emailInput) hire_data.email = emailInput.value.trim();
      if (contactInput) hire_data.contact = contactInput.value.trim();
      if (resumeInput) hire_data.resume_link = resumeInput.value.trim();

      // Collect custom fields
      const customFields = {};
      form.querySelectorAll('.cb-hire-custom-input').forEach(inp => {
        const fieldName = inp.getAttribute('data-field-name');
        if (fieldName && inp.value.trim()) {
          customFields[fieldName] = inp.value.trim();
        }
      });
      if (Object.keys(customFields).length > 0) {
        hire_data.custom_fields = customFields;
      }

      // Validate at least one field filled
      if (!hire_data.name && !hire_data.email && !hire_data.contact && !hire_data.resume_link && Object.keys(customFields).length === 0) {
        InnovateAPI.showAlert('Please fill in at least one field', 'error');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit Application';
        return;
      }

      try {
        await InnovateAPI.apiRequest(`/posts/${postId}/custom-button-action`, {
          method: 'POST',
          body: JSON.stringify({ action: 'hire_me', hire_data })
        });
        InnovateAPI.showAlert('Application submitted successfully! Details sent to the post creator.', 'success');
        document.getElementById('cbActionModal')?.remove();
      } catch (error) {
        InnovateAPI.showAlert(error.message || 'Failed to submit application', 'error');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit Application';
      }
    }
  </script>
</body>
</html>

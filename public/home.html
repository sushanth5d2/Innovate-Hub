<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Innovate</title>
  <link rel="stylesheet" href="/css/instagram.css">
</head>
<body>
  <!-- Top Navigation -->
  <nav class="ig-top-nav">
    <div class="ig-nav-container">
      <a href="/home" class="ig-logo">Innovate</a>
      
      <div class="ig-search-box">
        <input type="text" class="ig-search-input" placeholder="Search" id="searchInput">
      </div>
      
      <div class="ig-nav-icons">
        <div class="ig-nav-icon" onclick="window.location.href='/messages'">
          <svg aria-label="Messenger" fill="currentColor" height="24" viewBox="0 0 24 24" width="24">
            <path d="M12.003 2.001a9.705 9.705 0 1 1 0 19.4 10.876 10.876 0 0 1-2.895-.384.798.798 0 0 0-.533.04l-1.984.876a.801.801 0 0 1-1.123-.708l-.054-1.78a.806.806 0 0 0-.27-.569 9.49 9.49 0 0 1-3.14-7.175 9.65 9.65 0 0 1 10-9.7Z" fill="none" stroke="currentColor" stroke-miterlimit="10" stroke-width="1.739"></path>
            <path d="M17.79 10.132a.659.659 0 0 0-.962-.873l-2.556 2.05a.63.63 0 0 1-.758.002L11.06 9.47a1.576 1.576 0 0 0-2.277.42l-2.567 3.98a.659.659 0 0 0 .961.875l2.556-2.049a.63.63 0 0 1 .759-.002l2.452 1.84a1.576 1.576 0 0 0 2.278-.42Z" fill-rule="evenodd"></path>
          </svg>
          <span class="ig-notification-dot" id="messageDot" style="display: none;"></span>
        </div>
        
        <div class="ig-nav-icon" onclick="window.location.href='/notifications'">
          <svg aria-label="Notifications" fill="currentColor" height="24" viewBox="0 0 24 24" width="24">
            <path d="M16.792 3.904A4.989 4.989 0 0 1 21.5 9.122c0 3.072-2.652 4.959-5.197 7.222-2.512 2.243-3.865 3.469-4.303 3.752-.477-.309-2.143-1.823-4.303-3.752C5.141 14.072 2.5 12.167 2.5 9.122a4.989 4.989 0 0 1 4.708-5.218 4.21 4.21 0 0 1 3.675 1.941c.84 1.175.98 1.763 1.12 1.763s.278-.588 1.11-1.766a4.17 4.17 0 0 1 3.679-1.938m0-2a6.04 6.04 0 0 0-4.797 2.127 6.052 6.052 0 0 0-4.787-2.127A6.985 6.985 0 0 0 .5 9.122c0 3.61 2.55 5.827 5.015 7.97.283.246.569.494.853.747l1.027.918a44.998 44.998 0 0 0 3.518 3.018 2 2 0 0 0 2.174 0 45.263 45.263 0 0 0 3.626-3.115l.922-.824c.293-.26.59-.519.885-.774 2.334-2.025 4.98-4.32 4.98-7.94a6.985 6.985 0 0 0-6.708-7.218Z"></path>
          </svg>
          <span class="ig-notification-dot" id="notificationDot" style="display: none;"></span>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="ig-main">
    <!-- Stories -->
    <div class="ig-stories">
      <div class="ig-stories-scroll" id="storiesContainer">
        <div class="ig-story ig-add-story" onclick="openCreateStoryModal()">
          <div class="ig-story-ring">
            <img id="myStoryAvatar" src="" alt="Your story" class="ig-story-avatar">
          </div>
          <div class="ig-add-story-btn">+</div>
          <div class="ig-story-username">Your story</div>
        </div>
      </div>
    </div>

    <!-- Posts Feed -->
    <div id="postsFeed"></div>
  </main>

  <!-- Bottom Navigation -->
  <nav class="ig-bottom-nav">
    <a href="/home" class="ig-bottom-nav-item active">
      <svg aria-label="Home" viewBox="0 0 24 24" width="24">
        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
        <polyline points="9 22 9 12 15 12 15 22" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <span class="ig-bottom-nav-label">Home</span>
    </a>
    <a href="/communities" class="ig-bottom-nav-item">
      <svg aria-label="Communities" viewBox="0 0 24 24" width="24">
        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
        <circle cx="9" cy="7" r="4" stroke="currentColor" stroke-width="2" fill="none"/>
        <path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <span class="ig-bottom-nav-label">Communities</span>
    </a>
    <a href="/events" class="ig-bottom-nav-item">
      <svg aria-label="Events" viewBox="0 0 24 24" width="24">
        <rect x="3" y="4" width="18" height="18" rx="2" ry="2" stroke="currentColor" stroke-width="2" fill="none"/>
        <line x1="16" y1="2" x2="16" y2="6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <line x1="8" y1="2" x2="8" y2="6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <line x1="3" y1="10" x2="21" y2="10" stroke="currentColor" stroke-width="2"/>
      </svg>
      <span class="ig-bottom-nav-label">Events</span>
    </a>
    <button class="ig-bottom-nav-item" onclick="openCreatePostModal()" style="background: none; border: none; cursor: pointer;">
      <svg aria-label="Create" viewBox="0 0 24 24" width="24">
        <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"/>
      </svg>
      <span class="ig-bottom-nav-label">Create</span>
    </button>
    <a href="/social-service" class="ig-bottom-nav-item">
      <svg aria-label="Social Service" viewBox="0 0 24 24" width="24">
        <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <span class="ig-bottom-nav-label">Service</span>
    </a>
    <a href="/search" class="ig-bottom-nav-item">
      <svg aria-label="Search" viewBox="0 0 24 24" width="24">
        <circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2" fill="none"/>
        <line x1="21" y1="21" x2="16.65" y2="16.65" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
      <span class="ig-bottom-nav-label">Search</span>
    </a>
    <a href="#" class="ig-bottom-nav-item" id="profileNavLink" onclick="navigateToProfile(event)">
      <svg aria-label="Profile" viewBox="0 0 24 24" width="24">
        <circle cx="12" cy="7" r="4" stroke="currentColor" stroke-width="2" fill="none"/>
        <path d="M5.5 21v-2a7.5 7.5 0 0 1 13 0v2" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/>
      </svg>
      <span class="ig-bottom-nav-label">Profile</span>
    </a>
  </nav>

  <script>
    function navigateToProfile(e) {
      e.preventDefault();
      const user = InnovateAPI.getCurrentUser();
      if (user && user.id) {
        window.location.href = `/profile/${user.id}`;
      }
    }
  </script>

  <!-- Create Post Modal -->
  <div id="createPostModal" class="ig-modal-overlay" style="display: none;" onclick="closeCreatePostModal(event)">
    <div class="ig-modal" onclick="event.stopPropagation()" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
      <div class="ig-modal-item" style="font-weight: 600; padding: 20px; border-bottom: 1px solid var(--ig-border);">
        Create new post
      </div>
      <div style="padding: 20px;">
        <!-- Content -->
        <textarea id="postContent" class="ig-chat-input" placeholder="Write a caption... Use #hashtags for trending topics" rows="4" style="width: 100%; border-radius: 8px; resize: vertical;"></textarea>
        
        <!-- Media Preview -->
        <div id="imagePreview" style="margin-top: 12px; display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 8px;"></div>
        
        <!-- Files Preview -->
        <div id="postFilesList" style="margin-top: 8px;"></div>
        
        <!-- Upload Options -->
        <div style="margin-top: 16px; display: flex; gap: 8px; flex-wrap: wrap;">
          <label class="upload-btn">
            <input type="file" id="postImages" accept="image/*,video/*" multiple style="display: none;">
            üì∑ Photos/Videos
          </label>
          <label class="upload-btn">
            <input type="file" id="postFiles" accept=".pdf,.doc,.docx,.txt,.zip" multiple style="display: none;">
            üìé Files
          </label>
          <button class="upload-btn" onclick="togglePollCreation()">üìä Poll</button>
          <button class="upload-btn" onclick="toggleSchedule()">‚è∞ Schedule</button>
        </div>
        
        <!-- Poll Creation -->
        <div id="pollSection" style="display: none; margin-top: 16px; padding: 12px; background: var(--ig-secondary-background); border-radius: 8px;">
          <input type="text" id="pollQuestion" placeholder="Ask a question..." style="width: 100%; padding: 8px; border: 1px solid var(--ig-border); border-radius: 4px; margin-bottom: 8px;">
          <div id="pollOptions">
            <input type="text" class="poll-option" placeholder="Option 1" style="width: 100%; padding: 8px; border: 1px solid var(--ig-border); border-radius: 4px; margin-bottom: 8px;">
            <input type="text" class="poll-option" placeholder="Option 2" style="width: 100%; padding: 8px; border: 1px solid var(--ig-border); border-radius: 4px; margin-bottom: 8px;">
          </div>
          <button onclick="addPollOption()" style="padding: 6px 12px; background: var(--ig-blue); color: white; border: none; border-radius: 4px; cursor: pointer;">+ Add Option</button>
          <div style="margin-top: 8px;">
            <label style="display: flex; align-items: center; gap: 8px; font-size: 14px;">
              <input type="datetime-local" id="pollExpiry" style="flex: 1; padding: 6px; border: 1px solid var(--ig-border); border-radius: 4px;">
              Poll expiry
            </label>
          </div>
        </div>
        
        <!-- Schedule Post -->
        <div id="scheduleSection" style="display: none; margin-top: 16px; padding: 12px; background: var(--ig-secondary-background); border-radius: 8px;">
          <label style="display: flex; flex-direction: column; gap: 4px;">
            <span style="font-size: 14px; font-weight: 500;">Schedule for:</span>
            <input type="datetime-local" id="scheduleTime" style="padding: 8px; border: 1px solid var(--ig-border); border-radius: 4px;">
          </label>
        </div>
        
        <!-- Action Buttons -->
        <div style="margin-top: 16px; padding: 12px; background: var(--ig-secondary-background); border-radius: 8px;">
          <div style="font-size: 14px; font-weight: 500; margin-bottom: 8px;">Enable Actions:</div>
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; margin-bottom: 6px;">
            <input type="checkbox" id="enableContact" style="width: 18px; height: 18px;">
            <span>üìû Contact Me Button</span>
          </label>
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="checkbox" id="enableInterested" style="width: 18px; height: 18px;">
            <span>‚≠ê I'm Interested Button</span>
          </label>
        </div>
      </div>
      
      <div class="ig-modal-item" onclick="submitPost()" style="color: var(--ig-blue); font-weight: 600;">
        Share
      </div>
      <div class="ig-modal-item" onclick="closeCreatePostModal()">
        Cancel
      </div>
    </div>
  </div>

  <style>
    .upload-btn {
      padding: 8px 16px;
      background: var(--ig-secondary-background);
      border: 1px solid var(--ig-border);
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
    }
    .upload-btn:hover {
      background: var(--ig-hover-overlay);
    }
    .media-preview-item {
      position: relative;
      border-radius: 8px;
      overflow: hidden;
      aspect-ratio: 1;
    }
    .media-preview-item img,
    .media-preview-item video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .media-preview-remove {
      position: absolute;
      top: 4px;
      right: 4px;
      background: rgba(0,0,0,0.7);
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      cursor: pointer;
      font-size: 16px;
      line-height: 1;
    }
    .file-preview-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px;
      background: var(--ig-secondary-background);
      border-radius: 8px;
      margin-bottom: 6px;
    }
    .file-preview-remove {
      margin-left: auto;
      background: transparent;
      border: none;
      color: var(--ig-error);
      cursor: pointer;
      font-size: 18px;
    }
  </style>

  <!-- Create Story Modal -->
  <div id="createStoryModal" class="ig-modal-overlay" style="display: none;" onclick="closeCreateStoryModal(event)">
    <div class="ig-modal" onclick="event.stopPropagation()">
      <div class="ig-modal-header">Create Story</div>
      <div style="padding: 20px;">
        <textarea id="storyContent" class="ig-chat-input" placeholder="What's on your mind?" rows="4" style="width: 100%; border-radius: 8px; resize: vertical;"></textarea>
        <div id="storyPreview" style="margin-top: 12px; max-height: 300px; overflow: hidden; display: flex; justify-content: center;"></div>
        <label class="ig-modal-item" style="display: flex; align-items: center; justify-content: center; color: var(--ig-blue); cursor: pointer; margin-top: 12px;">
          <input type="file" id="storyMedia" accept="image/*,video/*" style="display: none;">
          Add Photo or Video (Max 120 sec)
        </label>
      </div>
      <div class="ig-modal-item" onclick="submitStory()" style="color: var(--ig-blue); font-weight: 600;">
        Share Story
      </div>
      <div class="ig-modal-item" onclick="closeCreateStoryModal()">
        Cancel
      </div>
    </div>
  </div>

  <!-- Post Actions Modals -->
  <div id="postActionsModal" class="ig-modal-overlay" style="display: none;" onclick="closePostActionsModal(event)">
    <div class="ig-modal" onclick="event.stopPropagation()">
      <div class="ig-modal-header">Post Actions</div>
      
      <div id="viewerActions" style="display: none;">
        <div class="ig-modal-item" onclick="handleInterested()">
          <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
          </svg>
          <span>I'm Interested</span>
        </div>
        
        <div class="ig-modal-item" onclick="handleContactMe()">
          <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
            <path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/>
          </svg>
          <span>Contact Me</span>
        </div>
        
        <div class="ig-modal-item" onclick="handleGentleReminder()">
          <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/>
          </svg>
          <span>Gentle Reminder</span>
        </div>
        
        <div class="ig-modal-item" onclick="handleInstantMeeting()">
          <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
            <path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/>
          </svg>
          <span>Instant Meeting</span>
        </div>
        
        <div class="ig-modal-item" onclick="handleReport()">
          <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
            <path d="M14.4 6L14 4H5v17h2v-7h5.6l.4 2h7V6z"/>
          </svg>
          <span>Report</span>
        </div>
      </div>
      
      <div id="ownerActions" style="display: none;">
        <div class="ig-modal-item" onclick="handleEditPost()">
          <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
            <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
          </svg>
          <span>Edit Post</span>
        </div>
        
        <div class="ig-modal-item" onclick="handleArchivePost()">
          <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
            <path d="M20.54 5.23l-1.39-1.68C18.88 3.21 18.47 3 18 3H6c-.47 0-.88.21-1.16.55L3.46 5.23C3.17 5.57 3 6.02 3 6.5V19c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6.5c0-.48-.17-.93-.46-1.27zM12 17.5L6.5 12H10v-2h4v2h3.5L12 17.5zM5.12 5l.81-1h12l.94 1H5.12z"/>
          </svg>
          <span>Archive</span>
        </div>
        
        <div class="ig-modal-item danger" onclick="handleDeletePost()">
          <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
            <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
          </svg>
          <span>Delete</span>
        </div>
      </div>
      
      <div class="ig-modal-item" onclick="closePostActionsModal()">
        <span>Cancel</span>
      </div>
    </div>
  </div>

  <div id="reminderModal" class="ig-modal-overlay" style="display: none;" onclick="closeReminderModal(event)">
    <div class="ig-modal" onclick="event.stopPropagation()">
      <div class="ig-modal-header">Set Gentle Reminder</div>
      <div style="padding: 20px;">
        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--ig-primary-text);">Date & Time</label>
        <input type="datetime-local" id="reminderDate" class="ig-chat-input" style="width: 100%; padding: 10px; border: 1px solid var(--ig-border); border-radius: 8px;">
        
        <label style="display: block; margin: 16px 0 8px; font-weight: 500; color: var(--ig-primary-text);">Message (Optional)</label>
        <textarea id="reminderMessage" class="ig-chat-input" placeholder="Add a note for this reminder..." rows="3" style="width: 100%; padding: 10px; border: 1px solid var(--ig-border); border-radius: 8px; resize: vertical;"></textarea>
      </div>
      <div class="ig-modal-item" onclick="submitReminder()" style="color: var(--ig-blue); font-weight: 600;">
        Set Reminder
      </div>
      <div class="ig-modal-item" onclick="closeReminderModal()">
        Cancel
      </div>
    </div>
  </div>

  <div id="meetingModal" class="ig-modal-overlay" style="display: none;" onclick="closeMeetingModal(event)">
    <div class="ig-modal" onclick="event.stopPropagation()">
      <div class="ig-modal-header">Create Instant Meeting</div>
      <div style="padding: 20px;">
        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--ig-primary-text);">Platform</label>
        <select id="meetingPlatform" class="ig-chat-input" style="width: 100%; padding: 10px; border: 1px solid var(--ig-border); border-radius: 8px; margin-bottom: 16px;">
          <option value="google-meet">Google Meet</option>
          <option value="zoom">Zoom</option>
          <option value="teams">Microsoft Teams</option>
          <option value="discord">Discord</option>
        </select>
        
        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--ig-primary-text);">Meeting Title</label>
        <input type="text" id="meetingTitle" class="ig-chat-input" placeholder="Enter meeting title..." style="width: 100%; padding: 10px; border: 1px solid var(--ig-border); border-radius: 8px; margin-bottom: 16px;">
        
        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--ig-primary-text);">Date & Time</label>
        <input type="datetime-local" id="meetingDate" class="ig-chat-input" style="width: 100%; padding: 10px; border: 1px solid var(--ig-border); border-radius: 8px; margin-bottom: 16px;">
        
        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--ig-primary-text);">Description (Optional)</label>
        <textarea id="meetingDescription" class="ig-chat-input" placeholder="Add meeting details..." rows="3" style="width: 100%; padding: 10px; border: 1px solid var(--ig-border); border-radius: 8px; resize: vertical;"></textarea>
      </div>
      <div class="ig-modal-item" onclick="submitMeeting()" style="color: var(--ig-blue); font-weight: 600;">
        Create Meeting
      </div>
      <div class="ig-modal-item" onclick="closeMeetingModal()">
        Cancel
      </div>
    </div>
  </div>

  <div id="editPostModal" class="ig-modal-overlay" style="display: none;" onclick="closeEditModal(event)">
    <div class="ig-modal" onclick="event.stopPropagation()">
      <div class="ig-modal-header">Edit Post</div>
      <div style="padding: 20px;">
        <textarea id="editPostContent" class="ig-chat-input" rows="4" style="width: 100%; padding: 10px; border: 1px solid var(--ig-border); border-radius: 8px; resize: vertical;"></textarea>
        
        <div id="editImagePreview" style="margin-top: 12px;"></div>
        
        <label class="ig-button" style="display: inline-block; margin-top: 12px; padding: 8px 16px; background: var(--ig-blue); color: white; border-radius: 8px; cursor: pointer;">
          <input type="file" id="editPostImages" accept="image/*,video/*" multiple style="display: none;">
          Add More Media
        </label>
      </div>
      <div class="ig-modal-item" onclick="submitEditPost()" style="color: var(--ig-blue); font-weight: 600;">
        Save Changes
      </div>
      <div class="ig-modal-item" onclick="closeEditModal()">
        Cancel
      </div>
    </div>
  </div>

  <!-- Story Viewer Modal -->
  <div id="storyViewerModal" class="story-viewer-overlay" style="display: none;">
    <div class="story-viewer" onclick="event.stopPropagation()" 
         onmousedown="pauseStory()" onmouseup="resumeStory()" onmouseleave="resumeStory()"
         ontouchstart="pauseStory()" ontouchend="resumeStory()">
      <!-- Navigation areas -->
      <div class="story-nav-left" onclick="event.stopPropagation(); previousStory()"></div>
      <div class="story-nav-right" onclick="event.stopPropagation(); nextStory()"></div>
      
      <div class="story-viewer-header">
        <div class="story-viewer-user">
          <img id="storyViewerAvatar" src="" alt="" class="story-viewer-avatar">
          <span id="storyViewerUsername"></span>
          <span id="storyViewerTime" class="story-viewer-time"></span>
        </div>
        <button class="story-viewer-close" onclick="event.stopPropagation(); closeStoryViewer()">√ó</button>
      </div>
      
      <div class="story-viewer-content">
        <div id="storyViewerMedia"></div>
        <div id="storyViewerText" class="story-viewer-text"></div>
      </div>
      
      <div class="story-viewer-progress">
        <div id="storyProgressBar" class="story-progress-bar"></div>
      </div>
    </div>
  </div>

  <style>
    .story-viewer-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.95);
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .story-viewer {
      width: 100%;
      max-width: 500px;
      height: 100vh;
      max-height: 900px;
      background: #000;
      position: relative;
      border-radius: 0;
    }

    @media (min-width: 768px) {
      .story-viewer {
        border-radius: 12px;
        height: 90vh;
      }
    }

    .story-nav-left,
    .story-nav-right {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 35%;
      z-index: 5;
      cursor: pointer;
    }

    .story-nav-left {
      left: 0;
    }

    .story-nav-right {
      right: 0;
    }

    .story-viewer-header {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      padding: 16px;
      background: linear-gradient(to bottom, rgba(0,0,0,0.7), transparent);
      z-index: 10;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .story-viewer-user {
      display: flex;
      align-items: center;
      gap: 12px;
      color: white;
      font-weight: 500;
    }

    .story-viewer-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      object-fit: cover;
    }

    .story-viewer-time {
      color: rgba(255,255,255,0.7);
      font-size: 14px;
      font-weight: 400;
    }

    .story-viewer-close {
      background: transparent;
      border: none;
      color: white;
      font-size: 32px;
      cursor: pointer;
      padding: 0;
      width: 40px;
      height: 40px;
      line-height: 32px;
    }

    .story-viewer-content {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .story-viewer-content img,
    .story-viewer-content video {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }

    .story-viewer-text {
      position: absolute;
      bottom: 80px;
      left: 20px;
      right: 20px;
      color: white;
      font-size: 16px;
      text-align: center;
      text-shadow: 0 1px 3px rgba(0,0,0,0.8);
    }

    .story-viewer-progress {
      position: absolute;
      top: 8px;
      left: 16px;
      right: 16px;
      z-index: 11;
    }

    .story-progress-bar {
      display: flex;
      gap: 4px;
    }

    .story-progress-fill {
      height: 100%;
      background: white;
      width: 0%;
      transition: width 0.1s linear;
    }

    .story-count {
      position: absolute;
      top: 5px;
      right: 5px;
      background: rgba(0,0,0,0.7);
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: bold;
      z-index: 1;
    }
  </style>

  <script src="/socket.io/socket.io.js"></script>
  <script src="/js/app.js"></script>
  <script src="/js/instagram-theme.js"></script>
  <script src="/js/swipe-gestures.js"></script>
  <script>
    InnovateAPI.requireAuth();
    InnovateAPI.initializePage();
    InnovateAPI.initSocket();

    const user = InnovateAPI.getCurrentUser();
    let currentPostId = null;
    let currentPostIdForActions = null;
    let currentPostOwnerId = null;

    function getCurrentUserId() {
      return user.id;
    }

    // Post Actions Menu Functions
    function openPostActionsMenu(postId, ownerId) {
      currentPostIdForActions = postId;
      currentPostOwnerId = ownerId;
      
      const modal = document.getElementById('postActionsModal');
      const viewerActions = document.getElementById('viewerActions');
      const ownerActions = document.getElementById('ownerActions');
      
      const currentUserId = user.id;
      
      if (ownerId === currentUserId) {
        viewerActions.style.display = 'none';
        ownerActions.style.display = 'block';
      } else {
        viewerActions.style.display = 'block';
        ownerActions.style.display = 'none';
      }
      
      modal.style.display = 'flex';
    }

    function closePostActionsModal(event) {
      if (!event || event.target.id === 'postActionsModal') {
        document.getElementById('postActionsModal').style.display = 'none';
      }
    }

    async function handleInterested() {
      try {
        await InnovateAPI.apiRequest(`/posts/${currentPostIdForActions}/like`, {
          method: 'POST'
        });
        closePostActionsModal();
        InnovateAPI.showAlert('Post owner has been notified!', 'success');
        loadPosts();
      } catch (error) {
        console.error('Error:', error);
        InnovateAPI.showAlert('Failed to send notification', 'error');
      }
    }

    async function handleContactMe() {
      closePostActionsModal();
      try {
        await InnovateAPI.apiRequest(`/posts/${currentPostIdForActions}/interact`, {
          method: 'POST',
          body: JSON.stringify({ type: 'contact' })
        });
        window.location.href = `/messages?user=${currentPostOwnerId}`;
      } catch (error) {
        console.error('Error:', error);
      }
    }

    function handleGentleReminder() {
      closePostActionsModal();
      document.getElementById('reminderModal').style.display = 'flex';
    }

    function handleInstantMeeting() {
      closePostActionsModal();
      document.getElementById('meetingModal').style.display = 'flex';
    }

    function handleReport() {
      closePostActionsModal();
      if (confirm('Report this post for violating community guidelines?')) {
        InnovateAPI.showAlert('Thank you for your report. We will review this post.', 'success');
      }
    }

    function handleEditPost() {
      closePostActionsModal();
      const postEl = document.querySelector(`.ig-post[data-post-id="${currentPostIdForActions}"]`);
      const content = postEl.querySelector('.ig-caption-text')?.textContent || '';
      document.getElementById('editPostContent').value = content;
      document.getElementById('editPostModal').style.display = 'flex';
    }

    async function handleArchivePost() {
      if (confirm('Archive this post? You can restore it later from your profile.')) {
        try {
          const response = await InnovateAPI.apiRequest(`/posts/${currentPostIdForActions}/archive`, {
            method: 'PUT'
          });
          closePostActionsModal();
          InnovateAPI.showAlert('Post archived successfully!', 'success');
          loadPosts();
        } catch (error) {
          InnovateAPI.showAlert(error.message || 'Failed to archive post', 'error');
        }
      }
    }

    async function handleDeletePost() {
      if (confirm('Are you sure you want to delete this post? This cannot be undone.')) {
        try {
          await InnovateAPI.apiRequest(`/posts/${currentPostIdForActions}`, {
            method: 'DELETE'
          });
          closePostActionsModal();
          InnovateAPI.showAlert('Post deleted successfully!', 'success');
          loadPosts();
        } catch (error) {
          InnovateAPI.showAlert(error.message || 'Failed to delete post', 'error');
        }
      }
    }

    function closeReminderModal(event) {
      if (!event || event.target.id === 'reminderModal') {
        document.getElementById('reminderModal').style.display = 'none';
      }
    }

    async function submitReminder() {
      const date = document.getElementById('reminderDate').value;
      const message = document.getElementById('reminderMessage').value;
      
      if (!date) {
        InnovateAPI.showAlert('Please select a date and time', 'error');
        return;
      }
      
      try {
        await InnovateAPI.apiRequest(`/posts/${currentPostIdForActions}/reminder`, {
          method: 'POST',
          body: JSON.stringify({ reminder_date: date, message })
        });
        closeReminderModal();
        InnovateAPI.showAlert('Reminder set! Check the Events calendar.', 'success');
        document.getElementById('reminderDate').value = '';
        document.getElementById('reminderMessage').value = '';
      } catch (error) {
        InnovateAPI.showAlert(error.message || 'Failed to set reminder', 'error');
      }
    }

    function closeMeetingModal(event) {
      if (!event || event.target.id === 'meetingModal') {
        document.getElementById('meetingModal').style.display = 'none';
      }
    }

    async function submitMeeting() {
      const platform = document.getElementById('meetingPlatform').value;
      const title = document.getElementById('meetingTitle').value;
      const date = document.getElementById('meetingDate').value;
      const description = document.getElementById('meetingDescription').value;
      
      if (!title || !date) {
        InnovateAPI.showAlert('Please fill in the title and date', 'error');
        return;
      }
      
      try {
        const response = await InnovateAPI.apiRequest(`/posts/${currentPostIdForActions}/meeting`, {
          method: 'POST',
          body: JSON.stringify({ platform, title, meeting_date: date, description })
        });
        closeMeetingModal();
        InnovateAPI.showAlert(`Meeting created! Check Events page for details.`, 'success');
        document.getElementById('meetingTitle').value = '';
        document.getElementById('meetingDate').value = '';
        document.getElementById('meetingDescription').value = '';
      } catch (error) {
        InnovateAPI.showAlert(error.message || 'Failed to create meeting', 'error');
      }
    }

    function closeEditModal(event) {
      if (!event || event.target.id === 'editPostModal') {
        document.getElementById('editPostModal').style.display = 'none';
      }
    }

    document.getElementById('editPostImages')?.addEventListener('change', (e) => {
      const preview = document.getElementById('editImagePreview');
      preview.innerHTML = '';
      Array.from(e.target.files).forEach(file => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = document.createElement('img');
          img.src = e.target.result;
          img.style.cssText = 'max-width: 100%; border-radius: 8px; margin-top: 8px;';
          preview.appendChild(img);
        };
        reader.readAsDataURL(file);
      });
    });

    async function submitEditPost() {
      const content = document.getElementById('editPostContent').value;
      const files = document.getElementById('editPostImages').files;
      
      const formData = new FormData();
      formData.append('content', content);
      
      for (let file of files) {
        if (file.type.startsWith('image/')) {
          formData.append('images', file);
        } else if (file.type.startsWith('video/')) {
          formData.append('video', file);
        }
      }
      
      try {
        await InnovateAPI.apiRequest(`/posts/${currentPostIdForActions}`, {
          method: 'PUT',
          body: formData,
          headers: {}
        });
        closeEditModal();
        InnovateAPI.showAlert('Post updated successfully!', 'success');
        loadPosts();
      } catch (error) {
        InnovateAPI.showAlert(error.message || 'Failed to update post', 'error');
      }
    }

    // Load user avatar
    async function loadUserAvatar() {
      try {
        const data = await InnovateAPI.apiRequest(`/users/${user.id}`);
        const avatar = InnovateAPI.getUserAvatar(data.user.profile_picture);
        
        const myStoryAvatar = document.getElementById('myStoryAvatar');
        if (myStoryAvatar) myStoryAvatar.src = avatar;
        
        const profileImg = document.getElementById('profileImg');
        if (profileImg) profileImg.src = avatar;
      } catch (error) {
        console.error('Error loading avatar:', error);
      }
    }

    // Load stories
    async function loadStories() {
      try {
        const data = await InnovateAPI.apiRequest('/posts/stories');
        const container = document.getElementById('storiesContainer');
        
        // Keep the "Your story" button and only clear other stories
        const existingStories = container.querySelectorAll('.ig-story:not(.ig-add-story)');
        existingStories.forEach(story => story.remove());
        
        // Group stories by user_id
        const storyGroups = {};
        data.stories.forEach(story => {
          if (!storyGroups[story.user_id]) {
            storyGroups[story.user_id] = {
              user: {
                user_id: story.user_id,
                username: story.username,
                profile_picture: story.profile_picture
              },
              stories: []
            };
          }
          storyGroups[story.user_id].stories.push(story);
        });
        
        // Create one ring per user
        Object.values(storyGroups).forEach(group => {
          // Check if user has viewed all stories in this group
          const allViewed = group.stories.every(s => s.viewed_by_current_user);
          
          const storyEl = document.createElement('div');
          storyEl.className = 'ig-story';
          storyEl.innerHTML = `
            <div class="ig-story-ring ${allViewed ? 'viewed' : ''}">
              <img src="${InnovateAPI.getUserAvatar(group.user.profile_picture)}" alt="${group.user.username}" class="ig-story-avatar">
              ${group.stories.length > 1 ? `<div class="story-count">${group.stories.length}</div>` : ''}
            </div>
            <div class="ig-story-username">${group.user.username}</div>
          `;
          storyEl.onclick = () => viewStory(group.stories, 0);
          container.appendChild(storyEl);
        });
      } catch (error) {
        console.error('Error loading stories:', error);
      }
    }

    // Load posts
    async function loadPosts() {
      try {
        const data = await InnovateAPI.apiRequest('/posts');
        const feed = document.getElementById('postsFeed');
        feed.innerHTML = '';
        
        if (data.posts.length === 0) {
          feed.innerHTML = '<div class="ig-text-center" style="padding: 40px; color: var(--ig-secondary-text);">No posts yet. Follow people to see their posts!</div>';
          return;
        }
        
        data.posts.forEach((post, index) => {
          const postEl = createInstagramPost(post);
          postEl.style.cursor = 'pointer';
          feed.appendChild(postEl);
          
          // Initialize carousel for posts with multiple images
          if (post.images && post.images.length > 1) {
            initCarousel(post.id, post.images.length);
            enableCarouselSwipe(post.id);
          }
          
          // Add click handler to open full-screen viewer
          postEl.addEventListener('click', (e) => {
            // Don't open if clicking buttons or inputs, but allow image clicks
            if (e.target.closest('button, input, a:not(.ig-post-user), .ig-action-btn, .ig-carousel-btn')) {
              console.log('Click prevented - interactive element');
              return;
            }
            console.log('Opening full-screen viewer for post', index);
            openFullScreenPost(index, data.posts);
          });
        });
      } catch (error) {
        console.error('Error loading posts:', error);
      }
    }

    // Create Instagram-style post
    function createInstagramPost(post) {
      const postEl = document.createElement('div');
      postEl.className = 'ig-post';
      postEl.dataset.postId = post.id;
      
      // Make post clickable to open full-screen viewer
      postEl.style.cursor = 'pointer';
      
      const isLiked = post.user_has_liked || false;
      const isSaved = post.is_saved || false;
      const likesCount = post.likes_count || post.interested_count || 0;
      const commentsCount = post.comments_count || 0;
      
      // Handle media (images or video)
      let mediaHtml = '';
      if (post.video_url) {
        mediaHtml = `<video src="${post.video_url}" class="ig-post-image" controls ondblclick="toggleLike(${post.id})"></video>`;
      } else if (post.images && post.images.length > 0) {
        if (post.images.length === 1) {
          mediaHtml = `<img src="${post.images[0]}" alt="Post image" class="ig-post-image" ondblclick="toggleLike(${post.id})">`;  
        } else {
          // Multiple images carousel
          mediaHtml = `
            <div class="ig-carousel" id="carousel-${post.id}">
              <div class="ig-carousel-inner" id="carousel-inner-${post.id}">
                ${post.images.map((img, idx) => `
                  <img src="${img}" alt="Post image ${idx+1}" class="ig-post-image" ondblclick="toggleLike(${post.id})">
                `).join('')}
              </div>
              ${post.images.length > 1 ? `
                <button class="ig-carousel-btn ig-carousel-prev" onclick="carouselPrev(${post.id})" style="left: 10px;">‚Äπ</button>
                <button class="ig-carousel-btn ig-carousel-next" onclick="carouselNext(${post.id})" style="right: 10px;">‚Ä∫</button>
                <div class="ig-carousel-dots" id="dots-${post.id}">
                  ${post.images.map((_, idx) => `<span class="ig-carousel-dot ${idx === 0 ? 'active' : ''}" onclick="carouselGoTo(${post.id}, ${idx})"></span>`).join('')}
                </div>
              ` : ''}
            </div>
          `;
        }
      }
      
      postEl.innerHTML = `
        <div class="ig-post-header">
          <a href="/profile/${post.user_id}" class="ig-post-user">
            <img src="${InnovateAPI.getUserAvatar(post.profile_picture)}" alt="${post.username}" class="ig-post-avatar">
            <div class="ig-post-info">
              <div class="ig-post-username">${post.username}</div>
            </div>
          </a>
          <button class="ig-post-menu" onclick="openPostActionsMenu(${post.id}, ${post.user_id})">
            <svg aria-label="More options" fill="currentColor" height="24" viewBox="0 0 24 24" width="24">
              <circle cx="12" cy="12" r="1.5"></circle>
              <circle cx="6" cy="12" r="1.5"></circle>
              <circle cx="18" cy="12" r="1.5"></circle>
            </svg>
          </button>
        </div>
        
        ${mediaHtml}
        
        <div class="ig-post-actions">
          <div class="ig-post-actions-left">
            <button class="ig-action-btn ${isLiked ? 'liked' : ''}" onclick="toggleLike(${post.id})" data-post-id="${post.id}">
              <svg aria-label="Like" fill="${isLiked ? '#ed4956' : 'none'}" height="24" viewBox="0 0 24 24" width="24">
                <path d="M16.792 3.904A4.989 4.989 0 0 1 21.5 9.122c0 3.072-2.652 4.959-5.197 7.222-2.512 2.243-3.865 3.469-4.303 3.752-.477-.309-2.143-1.823-4.303-3.752C5.141 14.072 2.5 12.167 2.5 9.122a4.989 4.989 0 0 1 4.708-5.218 4.21 4.21 0 0 1 3.675 1.941c.84 1.175.98 1.763 1.12 1.763s.278-.588 1.11-1.766a4.17 4.17 0 0 1 3.679-1.938m0-2a6.04 6.04 0 0 0-4.797 2.127 6.052 6.052 0 0 0-4.787-2.127A6.985 6.985 0 0 0 .5 9.122c0 3.61 2.55 5.827 5.015 7.97.283.246.569.494.853.747l1.027.918a44.998 44.998 0 0 0 3.518 3.018 2 2 0 0 0 2.174 0 45.263 45.263 0 0 0 3.626-3.115l.922-.824c.293-.26.59-.519.885-.774 2.334-2.025 4.98-4.32 4.98-7.94a6.985 6.985 0 0 0-6.708-7.218Z"></path>
              </svg>
            </button>
            
            <button class="ig-action-btn" onclick="focusComment(${post.id})">
              <svg aria-label="Comment" fill="none" height="24" viewBox="0 0 24 24" width="24" stroke="#262626" stroke-width="2">
                <path d="M20.656 17.008a9.993 9.993 0 1 0-3.59 3.615L22 22Z" fill="none" stroke-linejoin="round"></path>
              </svg>
            </button>
            
            <button class="ig-action-btn" onclick="sharePost(${post.id})">
              <svg aria-label="Share" fill="none" height="24" viewBox="0 0 24 24" width="24" stroke="#262626" stroke-width="2">
                <line fill="none" stroke-linejoin="round" x1="22" x2="9.218" y1="3" y2="10.083"></line>
                <polygon fill="none" points="11.698 20.334 22 3.001 2 3.001 9.218 10.084 11.698 20.334" stroke-linejoin="round"></polygon>
              </svg>
            </button>
          </div>
          
          <button class="ig-action-btn ${isSaved ? 'saved' : ''}" onclick="toggleSave(${post.id})">
            <svg aria-label="Save" fill="${isSaved ? '#262626' : 'none'}" height="24" viewBox="0 0 24 24" width="24" stroke="#262626" stroke-width="2">
              <polygon fill="none" points="20 21 12 13.44 4 21 4 3 20 3 20 21" stroke-linecap="round" stroke-linejoin="round"></polygon>
            </svg>
          </button>
        </div>
        
        <div class="ig-post-likes">
          <span class="ig-post-likes-count" id="likes-${post.id}" onclick="showWhoLiked(${post.id})" style="cursor: pointer;">${likesCount} ${likesCount === 1 ? 'like' : 'likes'}</span>
        </div>
        
        ${post.content ? `
        <div class="ig-post-caption">
          <span class="ig-caption-username">${post.username}</span>
          <span class="ig-caption-text">${post.content}</span>
        </div>
        ` : ''}
        
        ${commentsCount > 0 ? `
        <button class="ig-post-comments-btn" onclick="window.location.href='/post/${post.id}'">
          View all ${commentsCount} comments
        </button>
        ` : ''}
        
        ${post.poll ? `
        <div class="ig-poll" style="margin: 12px 16px; padding: 12px; background: var(--ig-secondary-background); border-radius: 8px;">
          <div style="font-weight: 600; margin-bottom: 12px;">${post.poll.question}</div>
          ${post.poll.options.map((option, idx) => {
            const votes = post.poll.votes[idx] || 0;
            const totalVotes = post.poll.votes.reduce((a, b) => a + b, 0);
            const percentage = totalVotes > 0 ? Math.round((votes / totalVotes) * 100) : 0;
            return `
              <div class="poll-option" style="margin-bottom: 8px; position: relative; overflow: hidden; border-radius: 6px; border: 1px solid var(--ig-border);">
                <div style="position: absolute; top: 0; left: 0; height: 100%; width: ${percentage}%; background: var(--ig-blue); opacity: 0.2;"></div>
                <div style="position: relative; padding: 10px; display: flex; justify-content: space-between; align-items: center;">
                  <span>${option}</span>
                  <span style="font-weight: 600;">${percentage}%</span>
                </div>
              </div>
            `;
          }).join('')}
          <div style="margin-top: 8px; font-size: 12px; color: var(--ig-secondary-text);">
            ${post.poll.votes.reduce((a, b) => a + b, 0)} votes
          </div>
        </div>
        ` : ''}
        
        ${post.enable_contact || post.enable_interested ? `
        <div class="ig-post-actions-btns" style="margin: 0 16px 12px; display: flex; gap: 8px;">
          ${post.enable_contact ? `
            <button onclick="handleContactMe(${post.id})" style="flex: 1; padding: 8px; background: var(--ig-blue); color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">
              üìû Contact Me
            </button>
          ` : ''}
          ${post.enable_interested ? `
            <button onclick="handleInterested(${post.id})" style="flex: 1; padding: 8px; background: var(--ig-blue); color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">
              ‚≠ê I'm Interested
            </button>
          ` : ''}
        </div>
        ` : ''}
        
        <div class="ig-post-time">${InnovateAPI.formatDate(post.created_at)}</div>
        
        <div class="ig-add-comment">
          <input type="text" class="ig-add-comment-input" placeholder="Add a comment..." id="comment-${post.id}">
          <button class="ig-post-comment-btn" id="comment-btn-${post.id}">Post</button>
        </div>
      `;
      
      // Add comment input handler
      setTimeout(() => {
        const commentInput = document.getElementById(`comment-${post.id}`);
        const commentBtn = document.getElementById(`comment-btn-${post.id}`);
        
        if (commentInput && commentBtn) {
          commentInput.addEventListener('input', () => {
            commentBtn.classList.toggle('active', commentInput.value.trim().length > 0);
          });
          
          commentBtn.addEventListener('click', () => {
            if (commentInput.value.trim()) {
              addComment(post.id, commentInput.value.trim());
              commentInput.value = '';
              commentBtn.classList.remove('active');
            }
          });
          
          commentInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && commentInput.value.trim()) {
              addComment(post.id, commentInput.value.trim());
              commentInput.value = '';
              commentBtn.classList.remove('active');
            }
          });
        }
      }, 0);
      
      return postEl;
    }

    // Toggle like
    async function toggleLike(postId) {
      try {
        const btn = document.querySelector(`.ig-action-btn[data-post-id="${postId}"]`);
        const isLiked = btn.classList.contains('liked');
        
        const response = await InnovateAPI.apiRequest(`/posts/${postId}/like`, {
          method: 'POST'
        });
        
        btn.classList.toggle('liked');
        const svg = btn.querySelector('svg');
        svg.setAttribute('fill', isLiked ? 'none' : '#ed4956');
        
        // Update likes count from server response
        const likesEl = document.getElementById(`likes-${postId}`);
        if (likesEl && response.likes_count !== undefined) {
          likesEl.textContent = `${response.likes_count} ${response.likes_count === 1 ? 'like' : 'likes'}`;
        }
      } catch (error) {
        console.error('Error toggling like:', error);
      }
    }

    // Toggle save
    async function toggleSave(postId) {
      try {
        await InnovateAPI.apiRequest(`/posts/${postId}/save`, {
          method: 'POST'
        });
        
        const btn = document.querySelector(`.ig-post[data-post-id="${postId}"] .ig-action-btn.saved, .ig-post[data-post-id="${postId}"] .ig-post-actions button:last-child`);
        btn.classList.toggle('saved');
        const svg = btn.querySelector('svg');
        svg.setAttribute('fill', btn.classList.contains('saved') ? 'currentColor' : 'none');
      } catch (error) {
        console.error('Error toggling save:', error);
      }
    }

    // Add comment
    async function addComment(postId, content) {
      try {
        await InnovateAPI.apiRequest(`/posts/${postId}/comments`, {
          method: 'POST',
          body: JSON.stringify({ content })
        });
        InnovateAPI.showAlert('Comment added!', 'success');
      } catch (error) {
        console.error('Error adding comment:', error);
      }
    }

    // Focus comment input
    function focusComment(postId) {
      document.getElementById(`comment-${postId}`).focus();
    }

    // Share post
    function sharePost(postId) {
      const url = `${window.location.origin}/post/${postId}`;
      InnovateAPI.copyToClipboard(url);
      InnovateAPI.showAlert('Link copied!', 'success');
    }

    // Post menu
    function openPostMenu(postId, userId) {
      currentPostId = postId;
      if (userId === user.id) {
        document.getElementById('postMenuModal').style.display = 'flex';
      } else {
        // Show report/unfollow options for other users' posts
        const action = confirm('Report this post?');
        if (action) {
          InnovateAPI.showAlert('Post reported', 'success');
        }
      }
    }

    function closePostMenu() {
      document.getElementById('postMenuModal').style.display = 'none';
    }

    async function deleteCurrentPost() {
      if (confirm('Are you sure you want to delete this post?')) {
        try {
          await InnovateAPI.apiRequest(`/posts/${currentPostId}`, {
            method: 'DELETE'
          });
          InnovateAPI.showAlert('Post deleted', 'success');
          closePostMenu();
          loadPosts();
        } catch (error) {
          InnovateAPI.showAlert(error.message, 'error');
        }
      }
    }

    function editCurrentPost() {
      InnovateAPI.showAlert('Edit functionality coming soon!', 'info');
      closePostMenu();
    }

    // Create post modal
    function openCreatePostModal() {
      document.getElementById('createPostModal').style.display = 'flex';
      // Reset all fields
      document.getElementById('postContent').value = '';
      document.getElementById('imagePreview').innerHTML = '';
      document.getElementById('postFilesList').innerHTML = '';
      document.getElementById('pollSection').style.display = 'none';
      document.getElementById('scheduleSection').style.display = 'none';
      document.getElementById('enableContact').checked = false;
      document.getElementById('enableInterested').checked = false;
    }

    function closeCreatePostModal(event) {
      if (!event || event.target.classList.contains('ig-modal-overlay') || event.target.textContent === 'Cancel') {
        document.getElementById('createPostModal').style.display = 'none';
      }
    }

    function togglePollCreation() {
      const section = document.getElementById('pollSection');
      section.style.display = section.style.display === 'none' ? 'block' : 'none';
    }

    function toggleSchedule() {
      const section = document.getElementById('scheduleSection');
      section.style.display = section.style.display === 'none' ? 'block' : 'none';
    }

    function addPollOption() {
      const container = document.getElementById('pollOptions');
      const optionCount = container.querySelectorAll('.poll-option').length + 1;
      const input = document.createElement('input');
      input.type = 'text';
      input.className = 'poll-option';
      input.placeholder = `Option ${optionCount}`;
      input.style.cssText = 'width: 100%; padding: 8px; border: 1px solid var(--ig-border); border-radius: 4px; margin-bottom: 8px;';
      container.appendChild(input);
    }

    let selectedImages = [];
    let selectedFiles = [];

    // Handle image/video upload for posts
    document.getElementById('postImages')?.addEventListener('change', (e) => {
      const preview = document.getElementById('imagePreview');
      const files = Array.from(e.target.files);
      
      files.forEach((file) => {
        const currentIndex = selectedImages.length;
        selectedImages.push(file);
        
        const reader = new FileReader();
        reader.onload = (e) => {
          const div = document.createElement('div');
          div.className = 'media-preview-item';
          div.dataset.index = currentIndex;
          
          if (file.type.startsWith('video/')) {
            div.innerHTML = `
              <video src="${e.target.result}" controls></video>
              <button class="media-preview-remove" onclick="removeMedia(${currentIndex})">√ó</button>
            `;
          } else {
            div.innerHTML = `
              <img src="${e.target.result}" alt="Preview">
              <button class="media-preview-remove" onclick="removeMedia(${currentIndex})">√ó</button>
            `;
          }
          preview.appendChild(div);
        };
        reader.readAsDataURL(file);
      });
      
      // Reset input so same files can be selected again if needed
      e.target.value = '';
    });

    // Handle file upload
    document.getElementById('postFiles')?.addEventListener('change', (e) => {
      const filesList = document.getElementById('postFilesList');
      const files = Array.from(e.target.files);
      
      files.forEach(file => {
        const currentIndex = selectedFiles.length;
        selectedFiles.push(file);
        
        const div = document.createElement('div');
        div.className = 'file-preview-item';
        div.dataset.index = currentIndex;
        div.innerHTML = `
          <span>üìé</span>
          <span style="flex: 1; overflow: hidden; text-overflow: ellipsis;">${file.name}</span>
          <span style="color: var(--ig-secondary-text); font-size: 12px;">${(file.size / 1024).toFixed(1)} KB</span>
          <button class="file-preview-remove" onclick="removeFile(${currentIndex})">√ó</button>
        `;
        filesList.appendChild(div);
      });
      
      // Reset input
      e.target.value = '';
    });

    function removeMedia(index) {
      selectedImages[index] = null; // Mark as deleted instead of splicing
      const preview = document.getElementById('imagePreview');
      const item = preview.querySelector(`[data-index="${index}"]`);
      if (item) item.remove();
    }

    function removeFile(index) {
      selectedFiles[index] = null; // Mark as deleted instead of splicing
      const filesList = document.getElementById('postFilesList');
      const item = filesList.querySelector(`[data-index="${index}"]`);
      if (item) item.remove();
    }

    // Handle old postImage input for backward compatibility
    document.getElementById('postImage')?.addEventListener('change', (e) => {
      const preview = document.getElementById('imagePreview');
      const filesList = document.getElementById('postFilesList');
      preview.innerHTML = '';
      filesList.innerHTML = '';
      
      const files = Array.from(e.target.files);
      
      files.forEach((file, index) => {
        // Add to files list
        const fileItem = document.createElement('div');
        fileItem.style.cssText = 'padding: 8px; background: var(--ig-hover); border-radius: 4px; margin: 4px 0; display: flex; justify-content: space-between; align-items: center;';
        fileItem.innerHTML = `
          <span style="font-size: 14px;">${file.name}</span>
          <span style="font-size: 12px; color: var(--ig-secondary-text);">${(file.size / 1024).toFixed(2)} KB</span>
        `;
        filesList.appendChild(fileItem);
        
        // Show preview
        if (file.type.startsWith('video/')) {
          const video = document.createElement('video');
          video.src = URL.createObjectURL(file);
          video.controls = true;
          video.style.cssText = 'max-width: 100%; border-radius: 8px; margin-top: 8px;';
          preview.appendChild(video);
          
          // Check duration
          video.onloadedmetadata = function() {
            if (video.duration > 120) {
              alert(`Video "${file.name}" is longer than 120 seconds. Please use a shorter video.`);
            }
          };
        } else {
          const reader = new FileReader();
          reader.onload = (e) => {
            const img = document.createElement('img');
            img.src = e.target.result;
            img.style.cssText = 'max-width: 100%; border-radius: 8px; margin-top: 8px;';
            preview.appendChild(img);
          };
          reader.readAsDataURL(file);
        }
      });
    });

    // Submit post
    async function submitPost() {
      const content = document.getElementById('postContent').value;
      const pollSection = document.getElementById('pollSection');
      const scheduleTime = document.getElementById('scheduleTime').value;
      const enableContact = document.getElementById('enableContact').checked;
      const enableInterested = document.getElementById('enableInterested').checked;
      
      const validImages = selectedImages.filter(f => f !== null);
      const validFiles = selectedFiles.filter(f => f !== null);
      
      if (!content && validImages.length === 0 && validFiles.length === 0) {
        InnovateAPI.showAlert('Please add content or media', 'error');
        return;
      }
      
      const formData = new FormData();
      formData.append('content', content);
      
      // Extract hashtags from content
      const hashtags = content.match(/#[\w]+/g);
      if (hashtags) {
        formData.append('hashtags', JSON.stringify(hashtags.map(h => h.substring(1))));
      }
      
      // Add images and videos
      selectedImages.filter(file => file !== null).forEach(file => {
        if (file.type.startsWith('video/')) {
          formData.append('video', file);
        } else {
          formData.append('images', file);
        }
      });
      
      // Add files
      selectedFiles.filter(file => file !== null).forEach(file => {
        formData.append('files', file);
      });
      
      // Add poll if created
      if (pollSection.style.display !== 'none') {
        const pollQuestion = document.getElementById('pollQuestion').value;
        const pollOptions = Array.from(document.querySelectorAll('.poll-option'))
          .map(input => input.value)
          .filter(val => val.trim());
        const pollExpiry = document.getElementById('pollExpiry').value;
        
        if (pollQuestion && pollOptions.length >= 2) {
          formData.append('poll_question', pollQuestion);
          formData.append('poll_options', JSON.stringify(pollOptions));
          if (pollExpiry) {
            formData.append('poll_expiry', pollExpiry);
          }
        }
      }
      
      // Add schedule time
      if (scheduleTime) {
        formData.append('scheduled_at', scheduleTime);
      }
      
      // Add action buttons
      formData.append('enable_contact', enableContact ? '1' : '0');
      formData.append('enable_interested', enableInterested ? '1' : '0');
      
      try {
        await InnovateAPI.apiRequest('/posts', {
          method: 'POST',
          body: formData,
          headers: {}
        });
        
        InnovateAPI.showAlert(scheduleTime ? 'Post scheduled!' : 'Post created!', 'success');
        closeCreatePostModal();
        selectedImages = [];
        selectedFiles = [];
        loadPosts();
      } catch (error) {
        InnovateAPI.showAlert(error.message, 'error');
      }
    }

    // Story functions
    function openCreateStoryModal() {
      document.getElementById('createStoryModal').style.display = 'flex';
    }

    function closeCreateStoryModal(event) {
      if (!event || event.target.id === 'createStoryModal') {
        document.getElementById('createStoryModal').style.display = 'none';
        document.getElementById('storyContent').value = '';
        document.getElementById('storyPreview').innerHTML = '';
      }
    }

    // Handle story media upload
    document.getElementById('storyMedia')?.addEventListener('change', (e) => {
      const preview = document.getElementById('storyPreview');
      preview.innerHTML = '';
      
      const file = e.target.files[0];
      if (!file) return;
      
      // Check if video is too long (120 seconds max)
      if (file.type.startsWith('video/')) {
        const video = document.createElement('video');
        video.preload = 'metadata';
        video.onloadedmetadata = function() {
          window.URL.revokeObjectURL(video.src);
          if (video.duration > 120) {
            alert('Video must be 120 seconds or less');
            e.target.value = '';
            return;
          }
          
          video.src = URL.createObjectURL(file);
          video.controls = true;
          video.style.cssText = 'max-width: 100%; max-height: 280px; border-radius: 8px; object-fit: contain;';
          preview.appendChild(video);
        };
        video.src = URL.createObjectURL(file);
      } else {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = document.createElement('img');
          img.src = e.target.result;
          img.style.cssText = 'max-width: 100%; max-height: 280px; border-radius: 8px; object-fit: contain;';
          preview.appendChild(img);
        };
        reader.readAsDataURL(file);
      }
    });

    async function submitStory() {
      const content = document.getElementById('storyContent').value;
      const media = document.getElementById('storyMedia').files[0];
      
      if (!content && !media) {
        InnovateAPI.showAlert('Please add content or media', 'error');
        return;
      }
      
      const formData = new FormData();
      formData.append('content', content);
      formData.append('is_story', 'true');
      
      if (media) {
        if (media.type.startsWith('video/')) {
          formData.append('video', media);
        } else {
          formData.append('images', media);
        }
      }
      
      try {
        await InnovateAPI.apiRequest('/posts', {
          method: 'POST',
          body: formData,
          headers: {}
        });
        
        InnovateAPI.showAlert('Story created!', 'success');
        closeCreateStoryModal();
        loadStories();
      } catch (error) {
        InnovateAPI.showAlert(error.message, 'error');
      }
    }

    let currentStories = [];
    let currentStoryIndex = 0;
    let storyProgressInterval = null;
    let isPaused = false;
    let pausedVideoTime = 0;

    function viewStory(stories, startIndex = 0) {
      currentStories = stories;
      currentStoryIndex = startIndex;
      showCurrentStory();
    }

    async function markStoryAsViewed(storyId) {
      try {
        await InnovateAPI.apiRequest(`/posts/stories/${storyId}/view`, {
          method: 'POST'
        });
        // Reload stories to update ring state after a short delay
        setTimeout(() => loadStories(), 500);
      } catch (error) {
        console.error('Error marking story as viewed:', error);
      }
    }

    function pauseStory() {
      isPaused = true;
      const media = document.getElementById('storyViewerMedia');
      const video = media.querySelector('video');
      
      if (video && !video.paused) {
        video.pause();
        pausedVideoTime = video.currentTime;
      }
      
      if (storyProgressInterval) {
        clearInterval(storyProgressInterval);
      }
    }

    function resumeStory() {
      if (!isPaused) return;
      isPaused = false;
      
      const media = document.getElementById('storyViewerMedia');
      const video = media.querySelector('video');
      
      if (video && video.paused) {
        video.play();
      } else if (!video) {
        // Resume image timer
        const story = currentStories[currentStoryIndex];
        if (story.images && story.images.length > 0) {
          const currentProgressFill = document.getElementById(`storyProgressFill${currentStoryIndex}`);
          const currentWidth = parseFloat(currentProgressFill.style.width) || 0;
          let progressWidth = currentWidth;
          
          storyProgressInterval = setInterval(() => {
            progressWidth += 2;
            currentProgressFill.style.width = progressWidth + '%';
            if (progressWidth >= 100) {
              clearInterval(storyProgressInterval);
              storyProgressInterval = null;
              nextStory();
            }
          }, 100);
        }
      }
    }

    function showCurrentStory() {
      const story = currentStories[currentStoryIndex];
      const modal = document.getElementById('storyViewerModal');
      const avatar = document.getElementById('storyViewerAvatar');
      const username = document.getElementById('storyViewerUsername');
      const time = document.getElementById('storyViewerTime');
      const media = document.getElementById('storyViewerMedia');
      const text = document.getElementById('storyViewerText');
      const progressContainer = document.getElementById('storyProgressBar');
      
      // Mark current story as viewed
      if (story && story.id) {
        markStoryAsViewed(story.id);
      }
      
      // Clear previous progress interval
      if (storyProgressInterval) {
        clearInterval(storyProgressInterval);
        storyProgressInterval = null;
      }
      
      isPaused = false;
      
      // Set user info
      avatar.src = InnovateAPI.getUserAvatar(story.profile_picture);
      username.textContent = story.username;
      time.textContent = InnovateAPI.formatDate(story.created_at);
      
      // Set content
      text.textContent = story.content || '';
      
      // Create progress bars (one per story)
      progressContainer.innerHTML = '';
      currentStories.forEach((_, idx) => {
        const barWrapper = document.createElement('div');
        barWrapper.style.cssText = 'flex: 1; height: 2px; background: rgba(255,255,255,0.3); margin: 0 2px; border-radius: 1px; overflow: hidden;';
        
        const barFill = document.createElement('div');
        barFill.id = `storyProgressFill${idx}`;
        barFill.style.cssText = 'height: 100%; background: white; width: ' + (idx < currentStoryIndex ? '100%' : '0%') + '; transition: width 0.1s linear;';
        
        barWrapper.appendChild(barFill);
        progressContainer.appendChild(barWrapper);
      });
      
      // Set media
      media.innerHTML = '';
      if (story.video_url) {
        const video = document.createElement('video');
        video.src = story.video_url;
        video.autoplay = true;
        video.style.cssText = 'max-width: 100%; max-height: 100%; object-fit: contain;';
        media.appendChild(video);
        
        // Progress bar for video
        const currentProgressFill = document.getElementById(`storyProgressFill${currentStoryIndex}`);
        video.addEventListener('timeupdate', () => {
          const percent = (video.currentTime / video.duration) * 100;
          currentProgressFill.style.width = percent + '%';
        });
        
        video.addEventListener('ended', nextStory);
      } else if (story.images && story.images.length > 0) {
        const img = document.createElement('img');
        img.src = story.images[0];
        img.style.cssText = 'max-width: 100%; max-height: 100%; object-fit: contain;';
        media.appendChild(img);
        
        // Auto progress for image (5 seconds)
        let progressWidth = 0;
        const currentProgressFill = document.getElementById(`storyProgressFill${currentStoryIndex}`);
        storyProgressInterval = setInterval(() => {
          progressWidth += 2;
          currentProgressFill.style.width = progressWidth + '%';
          if (progressWidth >= 100) {
            clearInterval(storyProgressInterval);
            storyProgressInterval = null;
            nextStory();
          }
        }, 100);
      }
      
      modal.style.display = 'flex';
    }

    function nextStory() {
      if (currentStoryIndex < currentStories.length - 1) {
        currentStoryIndex++;
        showCurrentStory();
      } else {
        closeStoryViewer();
      }
    }

    function previousStory() {
      if (currentStoryIndex > 0) {
        currentStoryIndex--;
        showCurrentStory();
      }
    }

    function closeStoryViewer() {
      const modal = document.getElementById('storyViewerModal');
      const media = document.getElementById('storyViewerMedia');
      
      // Stop video if playing
      const video = media.querySelector('video');
      if (video) {
        video.pause();
      }
      
      // Clear progress interval
      if (storyProgressInterval) {
        clearInterval(storyProgressInterval);
        storyProgressInterval = null;
      }
      
      currentStories = [];
      currentStoryIndex = 0;
      
      modal.style.display = 'none';
    }

    // Keyboard navigation for stories
    document.addEventListener('keydown', (e) => {
      const modal = document.getElementById('storyViewerModal');
      if (modal.style.display === 'flex') {
        if (e.key === 'ArrowRight') {
          nextStory();
        } else if (e.key === 'ArrowLeft') {
          previousStory();
        } else if (e.key === 'Escape') {
          closeStoryViewer();
        }
      }
    });

    // Search handler
    document.getElementById('searchInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        const query = e.target.value.trim();
        if (query) {
          window.location.href = `/search?q=${encodeURIComponent(query)}`;
        }
      }
    });

    // Initialize
    loadUserAvatar();
    loadStories();
    loadPosts();

    // Carousel navigation functions
    const carouselStates = {};
    
    function initCarousel(postId, totalImages) {
      if (!carouselStates[postId]) {
        carouselStates[postId] = { currentIndex: 0, totalImages: totalImages };
      }
    }
    
    function carouselNext(postId) {
      const state = carouselStates[postId];
      if (!state) return;
      
      state.currentIndex = (state.currentIndex + 1) % state.totalImages;
      updateCarousel(postId);
    }
    
    function carouselPrev(postId) {
      const state = carouselStates[postId];
      if (!state) return;
      
      state.currentIndex = (state.currentIndex - 1 + state.totalImages) % state.totalImages;
      updateCarousel(postId);
    }
    
    function carouselGoTo(postId, index) {
      const state = carouselStates[postId];
      if (!state) return;
      
      state.currentIndex = index;
      updateCarousel(postId);
    }
    
    function updateCarousel(postId) {
      const state = carouselStates[postId];
      if (!state) return;
      
      const inner = document.getElementById(`carousel-inner-${postId}`);
      const dots = document.querySelectorAll(`#dots-${postId} .ig-carousel-dot`);
      
      if (inner) {
        inner.style.transform = `translateX(-${state.currentIndex * 100}%)`;
      }
      
      dots.forEach((dot, idx) => {
        dot.classList.toggle('active', idx === state.currentIndex);
      });
    }
    
    // Enable swipe for carousels
    function enableCarouselSwipe(postId) {
      const carousel = document.getElementById(`carousel-${postId}`);
      if (!carousel) return;
      
      let startX = 0;
      let isDragging = false;
      
      carousel.addEventListener('touchstart', (e) => {
        startX = e.touches[0].clientX;
        isDragging = true;
      });
      
      carousel.addEventListener('touchmove', (e) => {
        if (!isDragging) return;
        e.preventDefault();
      });
      
      carousel.addEventListener('touchend', (e) => {
        if (!isDragging) return;
        isDragging = false;
        
        const endX = e.changedTouches[0].clientX;
        const diff = startX - endX;
        
        if (Math.abs(diff) > 50) {
          if (diff > 0) {
            carouselNext(postId);
          } else {
            carouselPrev(postId);
          }
        }
      });
    }
    
    // Image zoom function
    function zoomImage(imgSrc) {
      const modal = document.createElement('div');
      modal.className = 'ig-zoom-modal';
      modal.innerHTML = `
        <div class="ig-zoom-overlay" onclick="this.parentElement.remove()">
          <img src="${imgSrc}" class="ig-zoom-image" onclick="event.stopPropagation()">
          <button class="ig-zoom-close" onclick="this.parentElement.parentElement.remove()">√ó</button>
        </div>
      `;
      document.body.appendChild(modal);
      
      // Enable pinch to zoom
      const img = modal.querySelector('.ig-zoom-image');
      let scale = 1;
      let lastDistance = 0;
      
      img.addEventListener('touchstart', (e) => {
        if (e.touches.length === 2) {
          lastDistance = Math.hypot(
            e.touches[0].pageX - e.touches[1].pageX,
            e.touches[0].pageY - e.touches[1].pageY
          );
        }
      });
      
      img.addEventListener('touchmove', (e) => {
        if (e.touches.length === 2) {
          e.preventDefault();
          const distance = Math.hypot(
            e.touches[0].pageX - e.touches[1].pageX,
            e.touches[0].pageY - e.touches[1].pageY
          );
          
          if (lastDistance > 0) {
            scale *= distance / lastDistance;
            scale = Math.max(0.5, Math.min(scale, 4));
            img.style.transform = `scale(${scale})`;
          }
          
          lastDistance = distance;
        }
      });
      
      img.addEventListener('touchend', () => {
        lastDistance = 0;
      });
    }
    
    // Show who liked modal
    async function showWhoLiked(postId) {
      try {
        const response = await InnovateAPI.apiRequest(`/posts/${postId}/likes`);
        
        if (!response.likes || response.likes.length === 0) {
          InnovateAPI.showAlert('No likes yet', 'info');
          return;
        }
        
        const modal = document.createElement('div');
        modal.className = 'ig-modal-overlay';
        modal.style.display = 'flex';
        modal.innerHTML = `
          <div class="ig-modal" onclick="event.stopPropagation()" style="max-width: 400px; max-height: 500px; overflow-y: auto;">
            <div class="ig-modal-header">
              Liked by
              <button onclick="this.closest('.ig-modal-overlay').remove()" style="position: absolute; right: 16px; background: none; border: none; font-size: 24px; cursor: pointer; color: var(--ig-secondary-text);">√ó</button>
            </div>
            <div style="padding: 8px 0;">
              ${response.likes.map(user => `
                <a href="/profile/${user.user_id}" class="ig-modal-item" style="display: flex; align-items: center; gap: 12px; padding: 12px 16px; text-decoration: none; color: inherit;">
                  <img src="${InnovateAPI.getUserAvatar(user.profile_picture)}" alt="${user.username}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">
                  <div style="flex: 1;">
                    <div style="font-weight: 600;">${user.username}</div>
                    ${user.bio ? `<div style="font-size: 12px; color: var(--ig-secondary-text);">${user.bio}</div>` : ''}
                  </div>
                </a>
              `).join('')}
            </div>
          </div>
        `;
        
        modal.onclick = (e) => {
          if (e.target === modal) modal.remove();
        };
        
        document.body.appendChild(modal);
      } catch (error) {
        InnovateAPI.showAlert('Failed to load likes', 'error');
      }
    }
    
    // Full-screen post viewer with vertical scrolling
    let fullScreenPosts = [];
    let currentFullScreenIndex = 0;
    
    // Helper function to extract plain text from HTML content
    function getPlainText(htmlContent) {
      if (!htmlContent) return '';
      const div = document.createElement('div');
      div.innerHTML = htmlContent;
      return div.textContent || div.innerText || '';
    }
    
    function openFullScreenPost(index, posts) {
      console.log('openFullScreenPost called', { index, postsCount: posts.length });
      fullScreenPosts = posts;
      currentFullScreenIndex = index;
      
      const viewer = document.createElement('div');
      viewer.id = 'fullScreenPostViewer';
      viewer.className = 'ig-fullscreen-viewer';
      viewer.innerHTML = `
        <div class="ig-fullscreen-header">
          <button class="ig-fullscreen-back" onclick="closeFullScreenPost()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
              <path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
          <button class="ig-fullscreen-camera" style="margin-left: auto;">
            <svg aria-label="Camera" fill="currentColor" height="24" viewBox="0 0 24 24" width="24">
              <path d="M6.827 6.175A2.31 2.31 0 0 1 5.186 7.23h-.005A2.31 2.31 0 0 1 3.54 6.175L1.945 4.581a.75.75 0 0 1 1.06-1.06l1.595 1.594a.767.767 0 0 0 .544.226.767.767 0 0 0 .543-.226L7.281 3.52a.75.75 0 0 1 1.061 1.06L6.827 6.175Z" fill-rule="evenodd"></path>
              <path d="M2.25 12a9.75 9.75 0 1 1 19.5 0 9.75 9.75 0 0 1-19.5 0Zm9.75-8.25a8.25 8.25 0 1 0 0 16.5 8.25 8.25 0 0 0 0-16.5Zm0 12.5a4.25 4.25 0 1 1 0-8.5 4.25 4.25 0 0 1 0 8.5Zm0-1.5a2.75 2.75 0 1 0 0-5.5 2.75 2.75 0 0 0 0 5.5Z"></path>
            </svg>
          </button>
        </div>
        <div class="ig-fullscreen-content" id="fullScreenContent"></div>
      `;
      
      document.body.appendChild(viewer);
      document.body.style.overflow = 'hidden';
      
      renderFullScreenPost(currentFullScreenIndex);
      enableFullScreenScroll();
    }
    
    function renderFullScreenPost(index) {
      const content = document.getElementById('fullScreenContent');
      if (!content || !fullScreenPosts || fullScreenPosts.length === 0) return;
      
      currentFullScreenIndex = index;
      
      // Render all posts for smooth scrolling
      content.innerHTML = fullScreenPosts.map((post, idx) => {
        const isLiked = post.user_has_liked || false;
        const isSaved = post.is_saved || false;
        const likesCount = post.likes_count || 0;
        const commentsCount = post.comments_count || 0;
        
        // Handle media
        let mediaHtml = '';
        if (post.video_url) {
          mediaHtml = `<video src="${post.video_url}" class="ig-fullscreen-image" controls></video>`;
        } else if (post.images && post.images.length > 0) {
          if (post.images.length === 1) {
            mediaHtml = `<img src="${post.images[0]}" alt="Post" class="ig-fullscreen-image" ondblclick="toggleLikeFullScreen(${post.id})">`;
          } else {
            mediaHtml = `
              <div class="ig-carousel" id="fs-carousel-${post.id}">
                <div class="ig-carousel-inner" id="fs-carousel-inner-${post.id}">
                  ${post.images.map((img, imgIdx) => `
                    <img src="${img}" alt="Image ${imgIdx+1}" class="ig-fullscreen-image" ondblclick="toggleLikeFullScreen(${post.id})">
                  `).join('')}
                </div>
                ${post.images.length > 1 ? `
                  <button class="ig-carousel-btn ig-carousel-prev" onclick="fsCarouselPrev(${post.id}, event)" style="left: 10px;">‚Äπ</button>
                  <button class="ig-carousel-btn ig-carousel-next" onclick="fsCarouselNext(${post.id}, event)" style="right: 10px;">‚Ä∫</button>
                  <div class="ig-carousel-dots" id="fs-dots-${post.id}">
                    ${post.images.map((_, dotIdx) => `<span class="ig-carousel-dot ${dotIdx === 0 ? 'active' : ''}" onclick="fsCarouselGoTo(${post.id}, ${dotIdx}, event)"></span>`).join('')}
                  </div>
                ` : ''}
              </div>
            `;
          }
        }
        
        return `
          <div class="ig-fullscreen-post" data-post-id="${post.id}" data-post-index="${idx}">
            ${mediaHtml}
          
          <div class="ig-post-actions">
            <div class="ig-post-actions-left">
              <button class="ig-action-btn ${isLiked ? 'liked' : ''}" onclick="toggleLikeFullScreen(${post.id})" data-post-id="${post.id}">
                <svg aria-label="Like" fill="${isLiked ? '#ed4956' : 'none'}" height="24" viewBox="0 0 24 24" width="24" stroke="${isLiked ? '#ed4956' : '#fff'}" stroke-width="2">
                  <path d="M16.792 3.904A4.989 4.989 0 0 1 21.5 9.122c0 3.072-2.652 4.959-5.197 7.222-2.512 2.243-3.865 3.469-4.303 3.752-.477-.309-2.143-1.823-4.303-3.752C5.141 14.072 2.5 12.167 2.5 9.122a4.989 4.989 0 0 1 4.708-5.218 4.21 4.21 0 0 1 3.675 1.941c.84 1.175.98 1.763 1.12 1.763s.278-.588 1.11-1.766a4.17 4.17 0 0 1 3.679-1.938m0-2a6.04 6.04 0 0 0-4.797 2.127 6.052 6.052 0 0 0-4.787-2.127A6.985 6.985 0 0 0 .5 9.122c0 3.61 2.55 5.827 5.015 7.97.283.246.569.494.853.747l1.027.918a44.998 44.998 0 0 0 3.518 3.018 2 2 0 0 0 2.174 0 45.263 45.263 0 0 0 3.626-3.115l.922-.824c.293-.26.59-.519.885-.774 2.334-2.025 4.98-4.32 4.98-7.94a6.985 6.985 0 0 0-6.708-7.218Z"></path>
                </svg>
              </button>
              
              <button class="ig-action-btn" onclick="focusCommentFullScreen(${post.id})">
                <svg aria-label="Comment" fill="none" height="24" viewBox="0 0 24 24" width="24" stroke="#fff" stroke-width="2">
                  <path d="M20.656 17.008a9.993 9.993 0 1 0-3.59 3.615L22 22Z" fill="none" stroke-linejoin="round"></path>
                </svg>
              </button>
              
              <button class="ig-action-btn" onclick="sharePost(${post.id})">
                <svg aria-label="Share" fill="none" height="24" viewBox="0 0 24 24" width="24" stroke="#fff" stroke-width="2">
                  <line fill="none" stroke-linejoin="round" x1="22" x2="9.218" y1="3" y2="10.083"></line>
                  <polygon fill="none" points="11.698 20.334 22 3.001 2 3.001 9.218 10.084 11.698 20.334" stroke-linejoin="round"></polygon>
                </svg>
              </button>
            </div>
            
            <button class="ig-action-btn ${isSaved ? 'saved' : ''}" onclick="toggleSaveFullScreen(${post.id})">
              <svg aria-label="Save" fill="${isSaved ? '#fff' : 'none'}" height="24" viewBox="0 0 24 24" width="24" stroke="#fff" stroke-width="2">
                <polygon fill="none" points="20 21 12 13.44 4 21 4 3 20 3 20 21" stroke-linecap="round" stroke-linejoin="round"></polygon>
              </svg>
            </button>
          </div>
          
          <div class="ig-post-likes">
            <span class="ig-post-likes-count" id="fs-likes-${post.id}" onclick="showWhoLiked(${post.id})" style="cursor: pointer;">${likesCount} ${likesCount === 1 ? 'like' : 'likes'}</span>
          </div>
          
          ${post.content ? `
          <div class="ig-post-caption">
            <span class="ig-caption-username">${post.username}</span>
            <span class="ig-caption-text">${getPlainText(post.content).substring(0, 200)}${getPlainText(post.content).length > 200 ? '...' : ''}</span>
          </div>
          ` : ''}
          
          ${commentsCount > 0 ? `
          <button class="ig-post-comments-btn" onclick="window.location.href='/post/${post.id}'">
            View all ${commentsCount} comments
          </button>
          ` : ''}
          
          <div class="ig-fullscreen-bottom-info">
            <div class="ig-fullscreen-user">
              <img src="${InnovateAPI.getUserAvatar(post.profile_picture)}" alt="${post.username}" class="ig-fullscreen-avatar">
              <span class="ig-fullscreen-username">${post.username}</span>
            </div>
            <button class="ig-fullscreen-more" onclick="openPostActionsMenu(${post.id}, ${post.user_id})">
              <svg aria-label="More options" fill="currentColor" height="24" viewBox="0 0 24 24" width="24">
                <circle cx="12" cy="12" r="1.5"></circle>
                <circle cx="6" cy="12" r="1.5"></circle>
                <circle cx="18" cy="12" r="1.5"></circle>
              </svg>
            </button>
          </div>
          
          <div class="ig-post-time">${InnovateAPI.formatDate(post.created_at)}</div>
          
          <div class="ig-add-comment">
            <input type="text" class="ig-add-comment-input" placeholder="Add a comment..." id="fs-comment-${post.id}">
            <button class="ig-post-comment-btn" id="fs-comment-btn-${post.id}">Post</button>
          </div>
        </div>
        `;
      }).join('');
      
      // Scroll to the selected post
      setTimeout(() => {
        const posts = content.querySelectorAll('.ig-fullscreen-post');
        if (posts[index]) {
          posts[index].scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        // Initialize carousels for all posts with multiple images
        fullScreenPosts.forEach((post, idx) => {
          if (post.images && post.images.length > 1) {
            initCarousel(`fs-carousel-${post.id}`, post.images.length);
            enableCarouselSwipe(`fs-carousel-${post.id}`);
          }
        });
      }, 100);
    }
    
    function enableFullScreenScroll() {
      const content = document.getElementById('fullScreenContent');
      if (!content) return;
      
      let startY = 0;
      let scrollTimeout;
      
      content.addEventListener('touchstart', (e) => {
        startY = e.touches[0].clientY;
      });
      
      content.addEventListener('touchend', (e) => {
        const endY = e.changedTouches[0].clientY;
        const diff = startY - endY;
        
        // Scroll to next/previous post
        if (Math.abs(diff) > 100) {
          clearTimeout(scrollTimeout);
          scrollTimeout = setTimeout(() => {
            if (diff > 0 && currentFullScreenIndex < fullScreenPosts.length - 1) {
              renderFullScreenPost(currentFullScreenIndex + 1);
            } else if (diff < 0 && currentFullScreenIndex > 0) {
              renderFullScreenPost(currentFullScreenIndex - 1);
            }
          }, 100);
        }
      });
      
      // Mouse wheel support
      content.addEventListener('wheel', (e) => {
        clearTimeout(scrollTimeout);
        scrollTimeout = setTimeout(() => {
          if (e.deltaY > 0 && currentFullScreenIndex < fullScreenPosts.length - 1) {
            renderFullScreenPost(currentFullScreenIndex + 1);
          } else if (e.deltaY < 0 && currentFullScreenIndex > 0) {
            renderFullScreenPost(currentFullScreenIndex - 1);
          }
        }, 100);
      });
    }
    
    function closeFullScreenPost() {
      const viewer = document.getElementById('fullScreenPostViewer');
      if (viewer) {
        viewer.remove();
        document.body.style.overflow = '';
        fullScreenPosts = [];
        currentFullScreenIndex = 0;
      }
    }
    
    // Fullscreen carousel functions
    function fsCarouselNext(postId, event) {
      event?.stopPropagation();
      carouselNext(`fs-carousel-${postId}`);
    }
    
    function fsCarouselPrev(postId, event) {
      event?.stopPropagation();
      carouselPrev(`fs-carousel-${postId}`);
    }
    
    function fsCarouselGoTo(postId, index, event) {
      event?.stopPropagation();
      carouselGoTo(`fs-carousel-${postId}`, index);
    }
    
    // Fullscreen actions
    async function toggleLikeFullScreen(postId) {
      await toggleLike(postId);
      // Update fullscreen like count
      const response = await InnovateAPI.apiRequest(`/posts/${postId}`);
      if (response.post) {
        const likesEl = document.getElementById(`fs-likes-${postId}`);
        if (likesEl) {
          likesEl.textContent = `${response.post.likes_count} ${response.post.likes_count === 1 ? 'like' : 'likes'}`;
        }
      }
    }
    
    async function toggleSaveFullScreen(postId) {
      await toggleSave(postId);
    }
    
    function focusCommentFullScreen(postId) {
      const input = document.getElementById(`fs-comment-${postId}`);
      if (input) input.focus();
    }

    // Set datetime inputs to India timezone (IST = UTC+5:30)
    function setIndiaDateTime() {
      const now = new Date();
      // Convert to IST
      const istOffset = 5.5 * 60; // IST is UTC+5:30
      const istTime = new Date(now.getTime() + (istOffset * 60000));
      const localTime = istTime.toISOString().slice(0, 16);
      
      const scheduleInput = document.getElementById('scheduleTime');
      const pollExpiryInput = document.getElementById('pollExpiry');
      
      if (scheduleInput) scheduleInput.min = localTime;
      if (pollExpiryInput) pollExpiryInput.min = localTime;
    }
    
    setIndiaDateTime();

    // Action button handlers
    async function handleContactMe(postId) {
      try {
        await InnovateAPI.apiRequest(`/posts/${postId}/action`, {
          method: 'POST',
          body: JSON.stringify({ action_type: 'contact' })
        });
        InnovateAPI.showAlert('Request sent! The user will be notified.', 'success');
      } catch (error) {
        InnovateAPI.showAlert(error.message, 'error');
      }
    }

    async function handleInterested(postId) {
      try {
        await InnovateAPI.apiRequest(`/posts/${postId}/action`, {
          method: 'POST',
          body: JSON.stringify({ action_type: 'interested' })
        });
        InnovateAPI.showAlert('Your interest has been noted!', 'success');
      } catch (error) {
        InnovateAPI.showAlert(error.message, 'error');
      }
    }

    // Check for new messages/notifications periodically
    setInterval(async () => {
      try {
        const messages = await InnovateAPI.apiRequest('/messages/conversations');
        const hasUnread = messages.conversations.some(c => c.unread_count > 0);
        document.getElementById('messageDot').style.display = hasUnread ? 'block' : 'none';
      } catch (error) {
        console.error('Error checking messages:', error);
      }
    }, 30000); // Every 30 seconds
  </script>
</body>
</html>

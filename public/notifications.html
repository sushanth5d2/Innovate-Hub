<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Notifications â€¢ Innovate</title>
  <link rel="stylesheet" href="/css/instagram.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .ig-notification-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border-bottom: 1px solid var(--ig-border);
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .ig-notification-item:hover {
      background-color: var(--ig-hover);
    }
    .ig-notification-item.unread {
      background-color: rgba(0, 149, 246, 0.05);
    }
    .ig-notification-avatar {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      object-fit: cover;
      flex-shrink: 0;
    }
    .ig-notification-content {
      flex: 1;
      min-width: 0;
    }
    .ig-notification-text {
      font-size: 14px;
      color: var(--ig-primary-text);
      line-height: 1.4;
    }
    .ig-notification-username {
      font-weight: 600;
    }
    .ig-notification-time {
      font-size: 12px;
      color: var(--ig-secondary-text);
      margin-top: 2px;
    }
    .ig-notification-action {
      flex-shrink: 0;
    }
    .ig-follow-btn {
      background-color: var(--ig-blue);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 7px 16px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .ig-follow-btn:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }
    .ig-following-btn {
      background-color: var(--ig-secondary-background);
      color: var(--ig-primary-text);
      border: 1px solid var(--ig-border);
      border-radius: 8px;
      padding: 7px 16px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .ig-following-btn:hover {
      background-color: var(--ig-hover);
      transform: translateY(-1px);
    }
  </style>
</head>
<body>
  <!-- Top Navigation -->
  <nav class="ig-top-nav">
    <div class="ig-nav-container">
      <a href="/home" class="ig-logo">Innovate</a>
      <div></div>
      <div class="ig-nav-icons">
        <div class="ig-nav-icon" onclick="window.location.href='/home'">
          <svg aria-label="Home" fill="none" height="24" viewBox="0 0 24 24" width="24">
            <path d="M9.005 16.545a2.997 2.997 0 0 1 2.997-2.997A2.997 2.997 0 0 1 15 16.545V22h7V11.543L12 2 2 11.543V22h7.005Z" fill="none" stroke="currentColor" stroke-linejoin="round" stroke-width="2"></path>
          </svg>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="ig-main">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
      <h2 style="font-size: 24px; font-weight: 600;">Notifications</h2>
      <div style="display: flex; gap: 12px;">
        <button class="ig-following-btn" onclick="markAllAsRead()">Mark all read</button>
        <button class="ig-following-btn" onclick="clearAllNotifications()" style="color: var(--ig-error, #ed4956);">Clear</button>
      </div>
    </div>

    <div class="ig-settings-section">
      <div id="notificationsList">
        <div class="ig-spinner"></div>
      </div>
    </div>
  </main>

  <!-- Bottom Navigation -->
  <nav class="ig-bottom-nav">
    <a href="/home" class="ig-bottom-nav-item">
      <svg aria-label="Home" viewBox="0 0 24 24" width="24">
        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
        <polyline points="9 22 9 12 15 12 15 22" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <span class="ig-bottom-nav-label">Home</span>
    </a>
    <a href="/communities" class="ig-bottom-nav-item">
      <svg aria-label="Communities" viewBox="0 0 24 24" width="24">
        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
        <circle cx="9" cy="7" r="4" stroke="currentColor" stroke-width="2" fill="none"/>
        <path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <span class="ig-bottom-nav-label">Communities</span>
    </a>
    <a href="/events" class="ig-bottom-nav-item">
      <svg aria-label="Events" viewBox="0 0 24 24" width="24">
        <rect x="3" y="4" width="18" height="18" rx="2" ry="2" stroke="currentColor" stroke-width="2" fill="none"/>
        <line x1="16" y1="2" x2="16" y2="6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <line x1="8" y1="2" x2="8" y2="6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <line x1="3" y1="10" x2="21" y2="10" stroke="currentColor" stroke-width="2"/>
      </svg>
      <span class="ig-bottom-nav-label">Events</span>
    </a>
    <a href="/home" class="ig-bottom-nav-item" onclick="event.preventDefault(); window.location.href='/home';">
      <svg aria-label="Create" viewBox="0 0 24 24" width="24">
        <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"/>
      </svg>
      <span class="ig-bottom-nav-label">Create</span>
    </a>
    <a href="/social-service" class="ig-bottom-nav-item">
      <svg aria-label="Social Service" viewBox="0 0 24 24" width="24">
        <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <span class="ig-bottom-nav-label">Service</span>
    </a>
    <a href="/search" class="ig-bottom-nav-item">
      <svg aria-label="Search" viewBox="0 0 24 24" width="24">
        <circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2" fill="none"/>
        <line x1="21" y1="21" x2="16.65" y2="16.65" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
      <span class="ig-bottom-nav-label">Search</span>
    </a>
    <a href="#" class="ig-bottom-nav-item" id="profileNavLink" onclick="navigateToProfile(event)">
      <svg aria-label="Profile" viewBox="0 0 24 24" width="24">
        <circle cx="12" cy="7" r="4" stroke="currentColor" stroke-width="2" fill="none"/>
        <path d="M5.5 21v-2a7.5 7.5 0 0 1 13 0v2" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/>
      </svg>
      <span class="ig-bottom-nav-label">Profile</span>
    </a>
  </nav>

  <script>
    function navigateToProfile(e) {
      e.preventDefault();
      const user = InnovateAPI.getCurrentUser();
      if (user && user.id) {
        window.location.href = `/profile/${user.id}`;
      }
    }
  </script>

  <script src="/socket.io/socket.io.js"></script>
  <script src="/js/app.js"></script>
  <script src="/js/instagram-theme.js"></script>
  <script>
    InnovateAPI.requireAuth();
    InnovateAPI.initializePage();
    InnovateAPI.initSocket();

    const user = InnovateAPI.getCurrentUser();
    const notificationsSocket = InnovateAPI.getSocket();

    // Load user info
    async function loadUserInfo() {
      try {
        const data = await InnovateAPI.apiRequest(`/users/${user.id}`);
        const avatar = InnovateAPI.getUserAvatar(data.user.profile_picture);
        // This page's bottom nav uses an SVG icon (no profile image).
        // Guard in case markup changes across pages.
        const bottomProfilePic = document.getElementById('bottomProfilePic');
        if (bottomProfilePic) bottomProfilePic.src = avatar;
        const bottomProfileLink = document.getElementById('bottomProfileLink');
        if (bottomProfileLink) bottomProfileLink.href = `/profile/${user.id}`;
      } catch (error) {
        console.error('Error loading user info:', error);
      }
    }

    // Load notifications
    async function loadNotifications() {
      try {
        const data = await InnovateAPI.apiRequest('/notifications');
        const list = document.getElementById('notificationsList');
        list.innerHTML = '';

        if (data.notifications.length === 0) {
          list.innerHTML = `
            <div style="text-align: center; padding: 60px 20px; color: var(--ig-secondary-text);">
              <div style="font-size: 48px; margin-bottom: 16px;">ðŸ””</div>
              <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">No Notifications Yet</div>
              <div style="font-size: 14px;">When someone likes or comments on your posts, you'll see it here.</div>
            </div>
          `;
          return;
        }

        data.notifications.forEach(notification => {
          const notifEl = createNotificationElement(notification);
          list.appendChild(notifEl);
        });
      } catch (error) {
        console.error('Error loading notifications:', error);
        document.getElementById('notificationsList').innerHTML = 
          '<div style="text-align: center; padding: 40px; color: var(--ig-secondary-text);">Error loading notifications</div>';
      }
    }

    // Socket listener for new notifications
    // Server emits `notification:receive` (and some older routes emit `new_notification`).
    if (notificationsSocket) {
      notificationsSocket.on('notification:receive', () => loadNotifications());
      notificationsSocket.on('new_notification', () => loadNotifications());
      // Backward compat (if any page/server emits plain `notification`)
      notificationsSocket.on('notification', () => loadNotifications());
    }

    // Create notification element
    function createNotificationElement(notification) {
      const div = document.createElement('div');
      div.className = `ig-notification-item ${!notification.is_read ? 'unread' : ''}`;
      
      const avatar = InnovateAPI.getUserAvatar(notification.profile_picture);
      const timeAgo = formatTimeAgo(notification.created_at);
      
      let actionButton = '';
      let notificationText = notification.content;
      
      if (notification.type === 'follow') {
        notificationText = `<span class="ig-notification-username">${notification.username || 'Someone'}</span> started following you.`;
        actionButton = `
          <div class="ig-notification-action">
            <button class="ig-follow-btn" onclick="followUser(${notification.sender_id}, event)">Follow</button>
          </div>
        `;
      } else if (notification.type === 'message') {
        notificationText = `<span class="ig-notification-username">${notification.username || 'Someone'}</span> sent you a message.`;
      } else if (notification.type === 'event_invite') {
        notificationText = `<span class="ig-notification-username">${notification.username || 'Someone'}</span> invited you to an event.`;
      } else if (notification.type === 'crosspath') {
        notificationText = `<span class="ig-notification-username">${notification.username || 'Someone'}</span> joined the same event as you!`;
      } else if (notification.type === 'crosspath_match') {
        // Extract event name from notification content and format with username highlighted
        const username = notification.username || 'Someone';
        const contentWithBoldUsername = notification.content.replace(username, `<span class="ig-notification-username">${username}</span>`);
        notificationText = contentWithBoldUsername;
      } else if (notification.type === 'community_join') {
        notificationText = `<span class="ig-notification-username">${notification.username || 'Someone'}</span> joined your community.`;
      } else if (notification.type === 'join_request') {
        notificationText = `<span class="ig-notification-username">${notification.username || 'Someone'}</span> requested to join your community.`;
        actionButton = `
          <div class="ig-notification-action" style="display: flex; gap: 8px;">
            <button class="ig-follow-btn" onclick="approveJoinRequest(${notification.related_id}, ${notification.created_by}, ${notification.id}, event)" style="padding: 7px 14px; font-size: 13px; display: flex; align-items: center; gap: 6px;" title="Accept">
              <i class="fas fa-check"></i> Accept
            </button>
            <button class="ig-following-btn" onclick="declineJoinRequest(${notification.related_id}, ${notification.created_by}, ${notification.id}, event)" style="padding: 7px 14px; font-size: 13px; display: flex; align-items: center; gap: 6px;" title="Decline">
              <i class="fas fa-times"></i> Decline
            </button>
          </div>
        `;
      } else if (notification.type === 'community_invite') {
        notificationText = `You've been invited to join <span class="ig-notification-username">${notification.content.replace("You've been invited to join ", "")}</span>`;
        actionButton = `
          <div class="ig-notification-action" style="display: flex; gap: 8px;">
            <button class="ig-follow-btn" onclick="acceptCommunityInvite(${notification.related_id}, ${notification.id}, event)" style="padding: 7px 14px; font-size: 13px;">Accept</button>
            <button class="ig-following-btn" onclick="rejectCommunityInvite(${notification.id}, event)" style="padding: 7px 14px; font-size: 13px;">Reject</button>
          </div>
        `;
      }
      
      div.innerHTML = `
        <img src="${avatar}" alt="Avatar" class="ig-notification-avatar" onclick="window.location.href='/profile/${notification.sender_id || user.id}'">
        <div class="ig-notification-content" onclick="handleNotificationClick(${notification.id}, '${notification.type}', ${notification.related_id || 'null'})">
          <div class="ig-notification-text">${notificationText}</div>
          <div class="ig-notification-time">${timeAgo}</div>
        </div>
        ${actionButton}
      `;
      
      return div;
    }

    // Format time ago
    function formatTimeAgo(timestamp) {
      if (!timestamp) return 'Unknown';
      
      // Handle SQLite datetime format: "2026-02-07 12:00:00"
      // SQLite stores in UTC, so we need to explicitly handle it
      let dateStr = timestamp;
      if (dateStr.includes(' ') && !dateStr.includes('T') && !dateStr.includes('Z')) {
        dateStr = dateStr.replace(' ', 'T') + 'Z'; // Add 'Z' to indicate UTC
      }
      
      const date = new Date(dateStr);
      const now = new Date();
      const diff = now - date;
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);
      const weeks = Math.floor(diff / 604800000);
      
      if (minutes < 1) return 'just now';
      if (minutes < 60) return `${minutes}m`;
      if (hours < 24) return `${hours}h`;
      if (days < 7) return `${days}d`;
      if (weeks < 4) return `${weeks}w`;
      return date.toLocaleDateString();
    }

    // Handle notification click
    async function handleNotificationClick(notificationId, type, referenceId) {
      try {
        await InnovateAPI.apiRequest(`/notifications/${notificationId}/read`, {
          method: 'PUT'
        });
        
        if (type === 'message') {
          window.location.href = '/messages';
        } else if (type === 'join_request' && referenceId) {
          window.location.href = `/community/${referenceId}`;
        } else if (type === 'community_invite' && referenceId) {
          window.location.href = `/community/${referenceId}`;
        } else if (type === 'event_invite' && referenceId) {
          window.location.href = `/events/${referenceId}`;
        } else if (type === 'crosspath' && referenceId) {
          window.location.href = `/events/${referenceId}`;
        } else if (type === 'crosspath_match' && referenceId) {
          window.location.href = `/events/${referenceId}`;
        } else if (referenceId) {
          window.location.href = `/post/${referenceId}`;
        }
      } catch (error) {
        console.error('Error marking notification as read:', error);
      }
    }

    // Follow user
    async function followUser(userId, event) {
      event.stopPropagation();
      try {
        await InnovateAPI.apiRequest(`/users/${userId}/follow`, {
          method: 'POST'
        });
        
        const btn = event.target;
        btn.textContent = 'Following';
        btn.className = 'ig-following-btn';
        btn.onclick = (e) => unfollowUser(userId, e);
      } catch (error) {
        console.error('Error following user:', error);
      }
    }

    // Unfollow user
    async function unfollowUser(userId, event) {
      event.stopPropagation();
      try {
        await InnovateAPI.apiRequest(`/users/${userId}/unfollow`, {
          method: 'POST'
        });
        
        const btn = event.target;
        btn.textContent = 'Follow';
        btn.className = 'ig-follow-btn';
        btn.onclick = (e) => followUser(userId, e);
      } catch (error) {
        console.error('Error unfollowing user:', error);
      }
    }

    // Mark all as read
    async function markAllAsRead() {
      try {
        await InnovateAPI.apiRequest('/notifications/read/all', {
          method: 'PUT'
        });
        
        loadNotifications();
        InnovateAPI.showAlert('All notifications marked as read', 'success');
      } catch (error) {
        console.error('Error marking all as read:', error);
      }
    }

    // Clear all notifications
    async function clearAllNotifications() {
      if (!confirm('Are you sure you want to clear all notifications? This cannot be undone.')) {
        return;
      }
      
      try {
        const response = await InnovateAPI.apiRequest('/notifications/clear/all', {
          method: 'DELETE'
        });
        
        loadNotifications();
        InnovateAPI.showAlert(`Cleared ${response.deleted || 'all'} notifications`, 'success');
      } catch (error) {
        console.error('Error clearing notifications:', error);
        InnovateAPI.showAlert('Failed to clear notifications', 'error');
      }
    }

    // Accept community invitation
    async function acceptCommunityInvite(communityId, notificationId, event) {
      event.stopPropagation();
      const actionDiv = event.target.closest('.ig-notification-action');
      try {
        const response = await InnovateAPI.apiRequest(`/communities/${communityId}/accept-invite`, {
          method: 'POST'
        });
        
        if (response.success) {
          // Replace buttons with success message
          actionDiv.innerHTML = `
            <div style="color: var(--ig-blue); font-weight: 600; font-size: 13px; display: flex; align-items: center; gap: 6px;">
              <i class="fas fa-check-circle"></i>
              Accepted
            </div>
          `;
          InnovateAPI.showAlert('You joined the community!', 'success');
          // Mark notification as read
          await InnovateAPI.apiRequest(`/notifications/${notificationId}/read`, {
            method: 'PUT'
          });
        }
      } catch (error) {
        console.error('Error accepting invite:', error);
        InnovateAPI.showAlert(error.message || 'Failed to accept invitation', 'error');
      }
    }

    // Reject community invitation
    async function rejectCommunityInvite(notificationId, event) {
      event.stopPropagation();
      const actionDiv = event.target.closest('.ig-notification-action');
      try {
        // Replace buttons with declined message
        actionDiv.innerHTML = `
          <div style="color: var(--ig-secondary-text); font-weight: 600; font-size: 13px; display: flex; align-items: center; gap: 6px;">
            <i class="fas fa-times-circle"></i>
            Declined
          </div>
        `;
        
        // Just mark the notification as read (delete it) after a short delay
        setTimeout(async () => {
          await InnovateAPI.apiRequest(`/notifications/${notificationId}`, {
            method: 'DELETE'
          });
          loadNotifications();
        }, 1500);
        
        InnovateAPI.showAlert('Invitation declined', 'success');
      } catch (error) {
        console.error('Error rejecting invite:', error);
        InnovateAPI.showAlert('Failed to decline invitation', 'error');
      }
    }

    // Approve join request
    async function approveJoinRequest(communityId, userId, notificationId, event) {
      event.stopPropagation();
      const actionDiv = event.target.closest('.ig-notification-action');
      const notifItem = event.target.closest('.ig-notification-item');
      try {
        // Disable buttons immediately
        const buttons = actionDiv.querySelectorAll('button');
        buttons.forEach(btn => btn.disabled = true);
        
        const response = await InnovateAPI.apiRequest(`/communities/${communityId}/join-requests/${userId}/approve`, {
          method: 'POST'
        });
        
        if (response.success) {
          // Replace buttons with success message
          actionDiv.innerHTML = `
            <div style="color: #10b981; font-weight: 600; font-size: 13px; display: flex; align-items: center; gap: 6px;">
              <i class="fas fa-check-circle"></i>
              Approved
            </div>
          `;
          InnovateAPI.showAlert('Join request approved!', 'success');
          
          // Mark notification as read and remove the notification item
          await InnovateAPI.apiRequest(`/notifications/${notificationId}/read`, {
            method: 'PUT'
          });
          
          // Remove the notification from UI after delay
          setTimeout(() => {
            notifItem.style.transition = 'opacity 0.3s';
            notifItem.style.opacity = '0';
            setTimeout(() => {
              notifItem.remove();
            }, 300);
          }, 1500);
        }
      } catch (error) {
        console.error('Error approving request:', error);
        InnovateAPI.showAlert(error.message || 'Failed to approve request', 'error');
        // Re-enable buttons on error
        const buttons = actionDiv.querySelectorAll('button');
        buttons.forEach(btn => btn.disabled = false);
      }
    }

    // Decline join request
    async function declineJoinRequest(communityId, userId, notificationId, event) {
      event.stopPropagation();
      const actionDiv = event.target.closest('.ig-notification-action');
      const notifItem = event.target.closest('.ig-notification-item');
      try {
        // Disable buttons immediately
        const buttons = actionDiv.querySelectorAll('button');
        buttons.forEach(btn => btn.disabled = true);
        
        const response = await InnovateAPI.apiRequest(`/communities/${communityId}/join-requests/${userId}/decline`, {
          method: 'POST'
        });
        
        if (response.success) {
          // Replace buttons with declined message
          actionDiv.innerHTML = `
            <div style="color: var(--ig-secondary-text); font-weight: 600; font-size: 13px; display: flex; align-items: center; gap: 6px;">
              <i class="fas fa-times-circle"></i>
              Declined
            </div>
          `;
          InnovateAPI.showAlert('Join request declined', 'success');
          
          // Mark notification as read and remove the notification item
          await InnovateAPI.apiRequest(`/notifications/${notificationId}/read`, {
            method: 'PUT'
          });
          
          // Remove the notification from UI after delay
          setTimeout(() => {
            notifItem.style.transition = 'opacity 0.3s';
            notifItem.style.opacity = '0';
            setTimeout(() => {
              notifItem.remove();
            }, 300);
          }, 1500);
        }
      } catch (error) {
        console.error('Error declining request:', error);
        InnovateAPI.showAlert(error.message || 'Failed to decline request', 'error');
        // Re-enable buttons on error
        const buttons = actionDiv.querySelectorAll('button');
        buttons.forEach(btn => btn.disabled = false);
      }
    }

    // Initialize
    loadUserInfo();
    loadNotifications();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Communities - Innovate</title>
  <link rel="stylesheet" href="/css/instagram.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
  <style>
    /* Community Card Animations */
    .community-banner {
      transition: transform 0.3s ease;
    }
    
    .ig-post:hover .community-banner {
      transform: scale(1.05);
    }
    
    /* Smooth scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: var(--ig-secondary-background);
    }
    
    ::-webkit-scrollbar-thumb {
      background: var(--ig-border);
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: var(--ig-secondary-text);
    }
    
    /* Loading animation */
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    .loading {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
  </style>
</head>
<body>
  <!-- Top Navigation -->
  <nav class="ig-top-nav">
    <div class="ig-nav-container">
      <a href="/home" class="ig-logo">Innovate</a>
      
      <div class="ig-search-box">
        <input type="text" class="ig-search-input" placeholder="Search communities..." id="search-input" oninput="searchCommunities()">
      </div>
      
      <div class="ig-nav-icons">
        <div class="ig-nav-icon" onclick="window.location.href='/home'">
          <svg aria-label="Home" fill="currentColor" height="24" viewBox="0 0 24 24" width="24">
            <path d="M9.005 16.545a2.997 2.997 0 0 1 2.997-2.997A2.997 2.997 0 0 1 15 16.545V22h7V11.543L12 2 2 11.543V22h7.005Z" fill="none" stroke="currentColor" stroke-linejoin="round" stroke-width="2"></path>
          </svg>
        </div>
        
        <div class="ig-nav-icon" onclick="openCreateModal()">
          <svg aria-label="New community" fill="currentColor" height="24" viewBox="0 0 24 24" width="24">
            <path d="M2 12v3.45c0 2.849.698 4.005 1.606 4.944.94.909 2.098 1.608 4.946 1.608h6.896c2.848 0 4.006-.7 4.946-1.608C21.302 19.455 22 18.3 22 15.45V8.552c0-2.849-.698-4.006-1.606-4.945C19.454 2.7 18.296 2 15.448 2H8.552c-2.848 0-4.006.699-4.946 1.607C2.698 4.547 2 5.703 2 8.552Z" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
            <line fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" x1="6.545" x2="17.455" y1="12.001" y2="12.001"></line>
            <line fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" x1="12.003" x2="12.003" y1="6.545" y2="17.455"></line>
          </svg>
        </div>
        
        <div class="ig-nav-icon" onclick="window.location.href='/notifications'">
          <svg aria-label="Notifications" fill="currentColor" height="24" viewBox="0 0 24 24" width="24">
            <path d="M16.792 3.904A4.989 4.989 0 0 1 21.5 9.122c0 3.072-2.652 4.959-5.197 7.222-2.512 2.243-3.865 3.469-4.303 3.752-.477-.309-2.143-1.823-4.303-3.752C5.141 14.072 2.5 12.167 2.5 9.122a4.989 4.989 0 0 1 4.708-5.218 4.21 4.21 0 0 1 3.675 1.941c.84 1.175.98 1.763 1.12 1.763s.278-.588 1.11-1.766a4.17 4.17 0 0 1 3.679-1.938m0-2a6.04 6.04 0 0 0-4.797 2.127 6.052 6.052 0 0 0-4.787-2.127A6.985 6.985 0 0 0 .5 9.122c0 3.61 2.55 5.827 5.015 7.97.283.246.569.494.853.747l1.027.918a44.998 44.998 0 0 0 3.518 3.018 2 2 0 0 0 2.174 0 45.263 45.263 0 0 0 3.626-3.115l.922-.824c.293-.26.59-.519.885-.774 2.334-2.025 4.98-4.32 4.98-7.94a6.985 6.985 0 0 0-6.708-7.218Z"></path>
          </svg>
        </div>
        
        <div class="ig-nav-icon" onclick="window.location.href='/profile'">
          <img id="navProfilePic" src="/images/default-avatar.svg" alt="Profile" style="width: 24px; height: 24px; border-radius: 50%; object-fit: cover;">
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="ig-main" style="max-width: 1200px; padding: 24px 20px;">
    <div style="margin-bottom: 32px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
      <div>
        <h1 style="margin: 0 0 8px 0; font-size: 28px; font-weight: 700; letter-spacing: -0.5px;">Communities</h1>
        <p style="margin: 0; color: var(--ig-secondary-text); font-size: 15px;">Discover and join communities that match your interests</p>
      </div>
      <button onclick="openCreateModal()" style="padding: 12px 24px; background: linear-gradient(135deg, var(--ig-blue), #0081e6); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 12px rgba(0, 149, 246, 0.3); transition: all 0.2s; display: flex; align-items: center; gap: 8px; font-size: 15px;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(0, 149, 246, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0, 149, 246, 0.3)'">
        <i class="fas fa-plus-circle"></i> Create Community
      </button>
    </div>
    <div id="communities-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 28px;">
      <!-- Communities will be loaded here -->
    </div>
  </main>

  <!-- Create Community Modal -->
  <div id="create-modal" class="ig-modal-overlay" style="display: none;" onclick="if(event.target === this) closeCreateModal()">
    <div class="ig-modal" style="max-width: 550px; max-height: 90vh; border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.4); overflow: hidden; display: flex; flex-direction: column;">
      <div style="flex: 1; overflow-y: auto; padding: 24px 28px; text-align: left; position: relative;">
        <!-- Header with close button -->
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; border-bottom: 1px solid var(--ig-border); padding-bottom: 16px;">
          <h3 style="margin: 0; font-size: 20px; font-weight: 700; letter-spacing: -0.3px;">âœ¨ Create Community</h3>
          <button onclick="closeCreateModal()" style="background: none; border: none; color: var(--ig-secondary-text); font-size: 24px; cursor: pointer; padding: 0; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.background='var(--ig-hover)'" onmouseout="this.style.background='none'">&times;</button>
        </div>
        
        <form id="create-form" onsubmit="createCommunity(event); return false;">
          <!-- Community Name -->
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 10px; font-size: 13px; font-weight: 600; color: var(--ig-primary-text); letter-spacing: 0.3px; text-transform: uppercase;">
              <i class="fas fa-users" style="margin-right: 6px; color: var(--ig-blue);"></i>Community Name
            </label>
            <input type="text" id="community-name" placeholder="Enter a unique name..." style="width: 100%; padding: 12px 16px; border: 2px solid var(--ig-border); border-radius: 10px; background: var(--ig-secondary-background); color: var(--ig-primary-text); font-size: 15px; transition: all 0.2s; outline: none;" onfocus="this.style.borderColor='var(--ig-blue)'" onblur="this.style.borderColor='var(--ig-border)'" required>
          </div>
          
          <!-- Team Name -->
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 10px; font-size: 13px; font-weight: 600; color: var(--ig-primary-text); letter-spacing: 0.3px; text-transform: uppercase;">
              <i class="fas fa-trophy" style="margin-right: 6px; color: #f59e0b;"></i>Team Name <span style="color: var(--ig-secondary-text); font-weight: 400; text-transform: none;">(Optional)</span>
            </label>
            <input type="text" id="team-name" placeholder="For sports communities..." style="width: 100%; padding: 12px 16px; border: 2px solid var(--ig-border); border-radius: 10px; background: var(--ig-secondary-background); color: var(--ig-primary-text); font-size: 15px; transition: all 0.2s; outline: none;" onfocus="this.style.borderColor='var(--ig-blue)'" onblur="this.style.borderColor='var(--ig-border)'">
          </div>
          
          <!-- Description -->
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 10px; font-size: 13px; font-weight: 600; color: var(--ig-primary-text); letter-spacing: 0.3px; text-transform: uppercase;">
              <i class="fas fa-align-left" style="margin-right: 6px; color: #10b981;"></i>Description
            </label>
            <textarea id="community-description" rows="4" placeholder="Tell people what this community is about..." style="width: 100%; padding: 12px 16px; border: 2px solid var(--ig-border); border-radius: 10px; background: var(--ig-secondary-background); color: var(--ig-primary-text); font-size: 15px; resize: vertical; transition: all 0.2s; outline: none; font-family: inherit;" onfocus="this.style.borderColor='var(--ig-blue)'" onblur="this.style.borderColor='var(--ig-border)'"></textarea>
          </div>
          
          <!-- Banner Image Upload -->
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 10px; font-size: 13px; font-weight: 600; color: var(--ig-primary-text); letter-spacing: 0.3px; text-transform: uppercase;">
              <i class="fas fa-image" style="margin-right: 6px; color: #ec4899;"></i>Banner Image <span style="color: var(--ig-secondary-text); font-weight: 400; text-transform: none;">(Optional)</span>
            </label>
            <div style="position: relative;">
              <input type="file" id="banner-image" accept="image/*" style="display: none;">
              <button type="button" onclick="document.getElementById('banner-image').click()" style="width: 100%; padding: 20px; border: 2px dashed var(--ig-border); border-radius: 10px; background: var(--ig-secondary-background); color: var(--ig-secondary-text); cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 14px;" onmouseover="this.style.borderColor='var(--ig-blue)'; this.style.background='var(--ig-hover)'" onmouseout="this.style.borderColor='var(--ig-border)'; this.style.background='var(--ig-secondary-background)'">
                <i class="fas fa-cloud-upload-alt" style="font-size: 20px;"></i>
                <span id="file-label">Click to upload or drag & drop</span>
              </button>
            </div>
            <div id="banner-preview" style="margin-top: 12px; display: none; position: relative;">
              <img id="banner-preview-img" style="width: 100%; height: 180px; object-fit: cover; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
              <button type="button" onclick="removeBannerImage(event)" style="position: absolute; top: 8px; right: 8px; width: 32px; height: 32px; border-radius: 50%; background: rgba(0,0,0,0.7); color: white; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px;" title="Remove image">
                <i class="fas fa-times"></i>
              </button>
            </div>
          </div>
          
          <!-- Privacy Toggle -->
          <div style="margin-bottom: 28px; padding: 16px; background: var(--ig-hover); border-radius: 10px; border: 1px solid var(--ig-border);">
            <label style="display: flex; align-items: center; justify-content: space-between; cursor: pointer;">
              <div style="display: flex; align-items: center; gap: 12px;">
                <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--ig-blue); display: flex; align-items: center; justify-content: center;">
                  <i class="fas fa-globe" id="privacy-icon" style="color: white; font-size: 18px;"></i>
                </div>
                <div>
                  <div style="font-size: 15px; font-weight: 600; margin-bottom: 2px;" id="privacy-label">Public Community</div>
                  <div style="font-size: 12px; color: var(--ig-secondary-text);" id="privacy-desc">Anyone can join instantly</div>
                </div>
              </div>
              <input type="checkbox" id="is-public" checked style="display: none;" onchange="updatePrivacyToggle(this)">
              <div class="ig-toggle-switch" id="privacy-toggle" onclick="togglePrivacy()">
                <div class="ig-toggle-slider"></div>
              </div>
            </label>
          </div>
          
          <!-- Action Buttons -->
          <div style="display: flex; gap: 12px;">
            <button type="button" onclick="closeCreateModal()" style="flex: 1; padding: 14px; border: 2px solid var(--ig-border); border-radius: 10px; background: transparent; color: var(--ig-primary-text); cursor: pointer; font-weight: 600; font-size: 15px; transition: all 0.2s;" onmouseover="this.style.background='var(--ig-hover)'" onmouseout="this.style.background='transparent'">
              Cancel
            </button>
            <button type="submit" style="flex: 1; padding: 14px; border: none; border-radius: 10px; background: linear-gradient(135deg, var(--ig-blue), #0081e6); color: white; font-weight: 600; cursor: pointer; font-size: 15px; box-shadow: 0 4px 12px rgba(0, 149, 246, 0.3); transition: all 0.2s;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 6px 16px rgba(0, 149, 246, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0, 149, 246, 0.3)'">
              <i class="fas fa-check-circle" style="margin-right: 8px;"></i>Create Community
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Bottom Navigation -->
  <nav class="ig-bottom-nav">
    <a href="/home" class="ig-bottom-nav-item">
      <svg aria-label="Home" viewBox="0 0 24 24" width="24">
        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
        <polyline points="9 22 9 12 15 12 15 22" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <span class="ig-bottom-nav-label">Home</span>
    </a>
    <a href="/communities" class="ig-bottom-nav-item active">
      <svg aria-label="Communities" viewBox="0 0 24 24" width="24">
        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
        <circle cx="9" cy="7" r="4" stroke="currentColor" stroke-width="2" fill="none"/>
        <path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <span class="ig-bottom-nav-label">Communities</span>
    </a>
    <a href="/events" class="ig-bottom-nav-item">
      <svg aria-label="Events" viewBox="0 0 24 24" width="24">
        <rect x="3" y="4" width="18" height="18" rx="2" ry="2" stroke="currentColor" stroke-width="2" fill="none"/>
        <line x1="16" y1="2" x2="16" y2="6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <line x1="8" y1="2" x2="8" y2="6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <line x1="3" y1="10" x2="21" y2="10" stroke="currentColor" stroke-width="2"/>
      </svg>
      <span class="ig-bottom-nav-label">Events</span>
    </a>
    <button class="ig-bottom-nav-item" onclick="openCreateModal()" style="background: none; border: none; cursor: pointer;">
      <svg aria-label="Create" viewBox="0 0 24 24" width="24">
        <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"/>
      </svg>
      <span class="ig-bottom-nav-label">Create</span>
    </button>
    <a href="/social-service" class="ig-bottom-nav-item">
      <svg aria-label="Social Service" viewBox="0 0 24 24" width="24">
        <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <span class="ig-bottom-nav-label">Service</span>
    </a>
    <a href="/search" class="ig-bottom-nav-item">
      <svg aria-label="Search" viewBox="0 0 24 24" width="24">
        <circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2" fill="none"/>
        <line x1="21" y1="21" x2="16.65" y2="16.65" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
      <span class="ig-bottom-nav-label">Search</span>
    </a>
    <a href="#" class="ig-bottom-nav-item" id="profileNavLink" onclick="navigateToProfile(event)">
      <svg aria-label="Profile" viewBox="0 0 24 24" width="24">
        <circle cx="12" cy="7" r="4" stroke="currentColor" stroke-width="2" fill="none"/>
        <path d="M5.5 21v-2a7.5 7.5 0 0 1 13 0v2" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/>
      </svg>
      <span class="ig-bottom-nav-label">Profile</span>
    </a>
  </nav>

  <script src="/js/app.js"></script>
  <script>
    function navigateToProfile(e) {
      e.preventDefault();
      const user = InnovateAPI.getCurrentUser();
      if (user && user.id) {
        window.location.href = `/profile/${user.id}`;
      }
    }
  </script>


  <script src="/socket.io/socket.io.js"></script>
  <script src="/js/instagram-theme.js"></script>
  <script>
    const socket = io();

    if (!localStorage.getItem('token')) {
      window.location.href = '/login';
    }

    async function loadCommunities() {
      try {
        const response = await fetch('/api/communities', {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          }
        });

        if (!response.ok) throw new Error('Failed to load communities');
        
        const data = await response.json();
        displayCommunities(data.communities || []);
      } catch (error) {
        console.error('Error loading communities:', error);
      }
    }

    function displayCommunities(communities) {
      const grid = document.getElementById('communities-grid');
      grid.innerHTML = '';

      if (communities.length === 0) {
        grid.innerHTML = `
          <div style="grid-column: 1/-1; text-align: center; padding: 80px 20px;">
            <div style="display: inline-flex; align-items: center; justify-content: center; width: 120px; height: 120px; border-radius: 50%; background: linear-gradient(135deg, var(--ig-blue), #0081e6); margin-bottom: 24px; box-shadow: 0 8px 24px rgba(0, 149, 246, 0.3);">
              <i class="fas fa-users" style="font-size: 56px; color: white;"></i>
            </div>
            <h2 style="margin: 0 0 12px 0; font-size: 24px; font-weight: 700;">No communities yet</h2>
            <p style="color: var(--ig-secondary-text); margin-bottom: 32px; font-size: 15px; max-width: 400px; margin-left: auto; margin-right: auto;">Be the first to create a community and bring people together around your interests</p>
            <button class="ig-action-btn" onclick="openCreateModal()" style="padding: 14px 32px; background: linear-gradient(135deg, var(--ig-blue), #0081e6); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 12px rgba(0, 149, 246, 0.3); display: inline-flex; align-items: center; gap: 10px; font-size: 15px; transition: all 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(0, 149, 246, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0, 149, 246, 0.3)'">
              <i class="fas fa-plus-circle"></i> Create Your First Community
            </button>
          </div>
        `;
        return;
      }

      communities.forEach(community => {
        const card = document.createElement('div');
        card.className = 'ig-post';
        card.style.cursor = 'pointer';
        card.style.transition = 'all 0.3s ease';
        card.style.overflow = 'hidden';
        card.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
        
        // Add hover effect
        card.onmouseenter = () => {
          card.style.transform = 'translateY(-4px)';
          card.style.boxShadow = '0 8px 24px rgba(0,0,0,0.15)';
        };
        card.onmouseleave = () => {
          card.style.transform = 'translateY(0)';
          card.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
        };
        
        // Determine button text and action based on community privacy, membership, and request status
        let buttonText = 'Join';
        let buttonAction = `toggleJoin(${community.id}, this, event, ${community.is_public})`;
        let buttonStyle = 'background: linear-gradient(135deg, var(--ig-blue), #0081e6); color: white; border: none; box-shadow: 0 2px 8px rgba(0, 149, 246, 0.3);';
        let buttonDisabled = '';
        
        if (community.is_member) {
          buttonText = '<i class="fas fa-check-circle"></i> Joined';
          buttonStyle = 'background: transparent; color: var(--ig-primary-text); border: 2px solid var(--ig-border);';
        } else if (community.join_request_status === 'pending') {
          buttonText = '<i class="fas fa-clock"></i> Pending';
          buttonStyle = 'background: linear-gradient(135deg, #f59e0b, #d97706); color: white; border: none; cursor: not-allowed; box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);';
          buttonDisabled = 'disabled';
        } else if (!community.is_public) {
          buttonText = '<i class="fas fa-lock"></i> Request to Join';
          buttonStyle = 'background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; border: none; box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);';
        }
        
        card.innerHTML = `
          <div style="padding: 0; overflow: hidden;">
            <div style="height: 180px; background: linear-gradient(135deg, ${getRandomColor()}, ${getRandomColor()}); display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden;">
              ${community.banner_image ? `<img src="${community.banner_image}" style="width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s ease;" class="community-banner">` : `<div style="font-size: 64px; opacity: 0.5; color: rgba(0,0,0,0.6); text-shadow: 0 2px 4px rgba(255,255,255,0.3);">ðŸ‘¥</div>`}
              ${!community.is_public ? '<div style="position: absolute; top: 12px; right: 12px; background: rgba(0,0,0,0.85); backdrop-filter: blur(10px); color: white; padding: 8px 14px; border-radius: 24px; font-size: 12px; font-weight: 600; display: flex; align-items: center; gap: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"><i class="fas fa-lock"></i> Private</div>' : ''}
              <div style="position: absolute; bottom: 0; left: 0; right: 0; padding: 16px 20px; background: linear-gradient(to top, rgba(0,0,0,0.85), rgba(0,0,0,0.4), transparent);">
                <h3 style="margin: 0; font-size: 20px; font-weight: 700; letter-spacing: -0.3px; line-height: 1.3; color: white; text-shadow: 0 2px 8px rgba(0,0,0,0.8);">${community.name}</h3>
                ${community.team_name ? `<div style="color: rgba(255,255,255,0.9); font-size: 13px; margin-top: 4px; display: flex; align-items: center; gap: 6px; font-weight: 600; text-shadow: 0 1px 4px rgba(0,0,0,0.6);"><i class="fas fa-trophy"></i> ${community.team_name}</div>` : ''}
              </div>
            </div>
            <div style="padding: 20px; background: var(--ig-primary-background);">
              <div style="display: flex; gap: 16px; margin-bottom: 14px; font-size: 13px; color: var(--ig-secondary-text);">
                <span style="display: flex; align-items: center; gap: 6px;"><i class="fas fa-users"></i> <strong style="color: var(--ig-primary-text);">${community.member_count || 0}</strong> members</span>
                ${community.is_public ? '<span style="display: flex; align-items: center; gap: 6px;"><i class="fas fa-globe"></i> Public</span>' : '<span style="display: flex; align-items: center; gap: 6px;"><i class="fas fa-lock"></i> Private</span>'}
              </div>
              ${community.description ? `<p style="color: var(--ig-secondary-text); font-size: 14px; margin: 0 0 18px 0; line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">${community.description}</p>` : '<div style="margin-bottom: 18px;"></div>'}
              <button class="ig-action-btn ${community.is_member ? 'joined' : ''}" onclick="${buttonAction}" style="width: 100%; padding: 12px; ${buttonStyle} border-radius: 10px; font-weight: 600; font-size: 14px; transition: all 0.2s;" ${buttonDisabled} onmouseover="if(!this.disabled) this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.2)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)';">
                ${buttonText}
              </button>
            </div>
          </div>
        `;
        
        card.onclick = (e) => {
          if (!e.target.classList.contains('ig-action-btn')) {
            window.location.href = `/community/${community.id}`;
          }
        };
        
        grid.appendChild(card);
      });
    }

    function getRandomColor() {
      const colors = ['#833AB4', '#FD1D1D', '#F77737', '#4F5BD5', '#962FBF', '#F09433'];
      return colors[Math.floor(Math.random() * colors.length)];
    }

    async function toggleJoin(communityId, button, event, isPublic) {
      event.stopPropagation();
      const isJoined = button.classList.contains('joined');

      try {
        // If user is already a member, allow them to leave
        if (isJoined) {
          const endpoint = `/api/communities/${communityId}/leave`;
          const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
          });

          if (!response.ok) throw new Error('Failed to leave community');
          
          button.classList.remove('joined');
          if (isPublic) {
            button.textContent = 'Join';
            button.style.background = 'var(--ig-blue)';
            button.style.color = 'white';
            button.style.border = 'none';
          } else {
            button.innerHTML = '<i class="fas fa-lock"></i> Request to Join';
            button.style.background = 'var(--ig-blue)';
            button.style.color = 'white';
            button.style.border = 'none';
          }
          return;
        }

        // If community is public, join immediately
        if (isPublic) {
          const endpoint = `/api/communities/${communityId}/join`;
          const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
          });

          if (!response.ok) throw new Error('Failed to join community');
          
          button.classList.add('joined');
          button.textContent = 'Joined';
          button.style.background = 'transparent';
          button.style.color = 'var(--ig-primary-text)';
          button.style.border = '1px solid var(--ig-border)';
        } else {
          // If community is private, create join request
          const endpoint = `/api/communities/${communityId}/request-join`;
          const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
          });

          if (!response.ok) {
            const data = await response.json();
            throw new Error(data.error || 'Failed to send join request');
          }
          
          // Update button to show request is pending
          button.innerHTML = '<i class="fas fa-clock"></i> Pending';
          button.style.background = '#f59e0b';
          button.style.color = 'white';
          button.style.border = 'none';
          button.disabled = true;
          button.style.cursor = 'not-allowed';
          
          InnovateAPI.showAlert('Join request sent! Waiting for admin approval.', 'success');
        }
      } catch (error) {
        console.error('Error toggling join:', error);
        InnovateAPI.showAlert(error.message || 'Failed to perform action', 'error');
      }
    }

    let searchTimeout;
    async function searchCommunities() {
      clearTimeout(searchTimeout);
      const query = document.getElementById('search-input').value.trim();

      searchTimeout = setTimeout(async () => {
        try {
          // If search is empty, reload all communities
          if (!query) {
            await loadCommunities();
            return;
          }
          
          const response = await fetch(`/api/search/communities?q=${encodeURIComponent(query)}`, {
            headers: {
              'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
          });

          if (!response.ok) throw new Error('Search failed');
          
          const data = await response.json();
          displayCommunities(data.communities || []);
        } catch (error) {
          console.error('Error searching:', error);
        }
      }, 300);
    }

    function openCreateModal() {
      document.getElementById('create-modal').style.display = 'flex';
    }

    function closeCreateModal() {
      document.getElementById('create-modal').style.display = 'none';
      document.getElementById('create-form').reset();
      document.getElementById('banner-preview').style.display = 'none';
      document.getElementById('file-label').textContent = 'Click to upload or drag & drop';
      // Reset privacy toggle
      document.getElementById('is-public').checked = true;
      updatePrivacyDisplay(true);
      // Reset cropped banner
      croppedBannerBlob = null;
    }

    // Remove banner image
    function removeBannerImage(event) {
      event.stopPropagation();
      document.getElementById('banner-image').value = '';
      croppedBannerBlob = null;
      document.getElementById('banner-preview').style.display = 'none';
      document.getElementById('file-label').textContent = 'Click to upload or drag & drop';
    }

    // Toggle privacy
    function togglePrivacy() {
      const checkbox = document.getElementById('is-public');
      checkbox.checked = !checkbox.checked;
      updatePrivacyDisplay(checkbox.checked);
    }

    function updatePrivacyToggle(checkbox) {
      updatePrivacyDisplay(checkbox.checked);
    }

    function updatePrivacyDisplay(isPublic) {
      const toggle = document.getElementById('privacy-toggle');
      const icon = document.getElementById('privacy-icon');
      const label = document.getElementById('privacy-label');
      const desc = document.getElementById('privacy-desc');
      
      if (isPublic) {
        toggle.classList.add('active');
        icon.className = 'fas fa-globe';
        label.textContent = 'Public Community';
        desc.textContent = 'Anyone can join instantly';
      } else {
        toggle.classList.remove('active');
        icon.className = 'fas fa-lock';
        label.textContent = 'Private Community';
        desc.textContent = 'Requires approval to join';
      }
    }

    // Banner image cropper
    let bannerCropper = null;
    let croppedBannerBlob = null;

    function showBannerCropper(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        // Create modal
        const modal = document.createElement('div');
        modal.id = 'banner-cropper-modal';
        modal.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0,0,0,0.95);
          z-index: 10000;
          display: flex;
          flex-direction: column;
        `;
        
        modal.innerHTML = `
          <div style="padding: 16px; background: var(--ig-secondary-background); border-bottom: 1px solid var(--ig-border); display: flex; align-items: center; justify-content: space-between;">
            <button onclick="closeBannerCropper(false)" style="background: none; border: none; color: var(--ig-primary-text); font-size: 16px; cursor: pointer; font-weight: 600;">Cancel</button>
            <h3 style="margin: 0; font-size: 16px; font-weight: 600;">Adjust Banner Image</h3>
            <button onclick="applyBannerCrop()" style="background: none; border: none; color: var(--ig-blue); font-size: 16px; cursor: pointer; font-weight: 600;">Done</button>
          </div>
          <div style="flex: 1; display: flex; align-items: center; justify-content: center; padding: 20px; overflow: hidden;">
            <div style="max-width: 100%; max-height: 100%; position: relative;">
              <img id="banner-crop-image" src="${e.target.result}" style="max-width: 100%; max-height: calc(100vh - 200px); display: block;">
            </div>
          </div>
          <div style="padding: 16px; background: var(--ig-secondary-background); border-top: 1px solid var(--ig-border); display: flex; gap: 12px; align-items: center; justify-content: center; flex-wrap: wrap;">
            <button onclick="rotateBannerCropper(-90)" style="padding: 10px 16px; background: var(--ig-hover); border: 1px solid var(--ig-border); border-radius: 8px; color: var(--ig-primary-text); cursor: pointer; display: flex; align-items: center; gap: 6px;">
              <i class="fas fa-undo"></i> Rotate Left
            </button>
            <button onclick="rotateBannerCropper(90)" style="padding: 10px 16px; background: var(--ig-hover); border: 1px solid var(--ig-border); border-radius: 8px; color: var(--ig-primary-text); cursor: pointer; display: flex; align-items: center; gap: 6px;">
              <i class="fas fa-redo"></i> Rotate Right
            </button>
            <button onclick="flipBannerCropper('horizontal')" style="padding: 10px 16px; background: var(--ig-hover); border: 1px solid var(--ig-border); border-radius: 8px; color: var(--ig-primary-text); cursor: pointer; display: flex; align-items: center; gap: 6px;">
              <i class="fas fa-arrows-alt-h"></i> Flip H
            </button>
            <button onclick="flipBannerCropper('vertical')" style="padding: 10px 16px; background: var(--ig-hover); border: 1px solid var(--ig-border); border-radius: 8px; color: var(--ig-primary-text); cursor: pointer; display: flex; align-items: center; gap: 6px;">
              <i class="fas fa-arrows-alt-v"></i> Flip V
            </button>
            <button onclick="resetBannerCropper()" style="padding: 10px 16px; background: var(--ig-hover); border: 1px solid var(--ig-border); border-radius: 8px; color: var(--ig-primary-text); cursor: pointer; display: flex; align-items: center; gap: 6px;">
              <i class="fas fa-sync"></i> Reset
            </button>
          </div>
        `;
        
        document.body.appendChild(modal);
        
        // Initialize Cropper.js with 16:9 aspect ratio for banner
        const image = document.getElementById('banner-crop-image');
        bannerCropper = new Cropper(image, {
          aspectRatio: 16 / 9,
          viewMode: 1,
          dragMode: 'move',
          autoCropArea: 1,
          restore: false,
          guides: true,
          center: true,
          highlight: false,
          cropBoxMovable: true,
          cropBoxResizable: true,
          toggleDragModeOnDblclick: false,
        });
      };
      reader.readAsDataURL(file);
    }

    function closeBannerCropper(keepBlob = false) {
      const modal = document.getElementById('banner-cropper-modal');
      if (modal) {
        if (bannerCropper) {
          bannerCropper.destroy();
          bannerCropper = null;
        }
        modal.remove();
      }
      
      // Only clear the file input and blob if keepBlob is false (Cancel was clicked)
      if (!keepBlob) {
        document.getElementById('banner-image').value = '';
        croppedBannerBlob = null;
        console.log('Banner cropper cancelled - blob cleared');
      } else {
        console.log('Banner cropper closed - blob kept:', croppedBannerBlob);
      }
    }

    function rotateBannerCropper(degree) {
      if (bannerCropper) {
        bannerCropper.rotate(degree);
      }
    }

    function flipBannerCropper(direction) {
      if (bannerCropper) {
        if (direction === 'horizontal') {
          bannerCropper.scaleX(-bannerCropper.getData().scaleX || -1);
        } else {
          bannerCropper.scaleY(-bannerCropper.getData().scaleY || -1);
        }
      }
    }

    function resetBannerCropper() {
      if (bannerCropper) {
        bannerCropper.reset();
      }
    }

    function applyBannerCrop() {
      console.log('applyBannerCrop called');
      if (!bannerCropper) {
        console.error('bannerCropper is null!');
        return;
      }
      
      console.log('Getting cropped canvas...');
      // Get cropped canvas
      const canvas = bannerCropper.getCroppedCanvas({
        width: 1600,
        height: 900,
        imageSmoothingEnabled: true,
        imageSmoothingQuality: 'high',
      });
      
      if (!canvas) {
        console.error('Failed to get cropped canvas!');
        return;
      }
      
      console.log('Canvas obtained, converting to blob...');
      // Convert to blob and store it
      canvas.toBlob((blob) => {
        console.log('Blob created:', blob);
        if (!blob) {
          console.error('Failed to create blob!');
          return;
        }
        
        croppedBannerBlob = blob;
        console.log('croppedBannerBlob set:', croppedBannerBlob);
        
        // Show preview
        const bannerPreview = document.getElementById('banner-preview');
        const bannerPreviewImg = document.getElementById('banner-preview-img');
        const fileLabel = document.getElementById('file-label');
        
        bannerPreviewImg.src = canvas.toDataURL('image/jpeg', 0.9);
        bannerPreview.style.display = 'block';
        fileLabel.innerHTML = `<i class="fas fa-check-circle" style="color: #10b981; margin-right: 6px;"></i>Banner adjusted`;
        
        console.log('Closing banner cropper...');
        closeBannerCropper(true); // Keep the blob!
        console.log('Banner crop complete! croppedBannerBlob size:', croppedBannerBlob?.size);
      }, 'image/jpeg', 0.9);
    }

    // Banner image preview with cropper
    document.addEventListener('DOMContentLoaded', () => {
      const bannerInput = document.getElementById('banner-image');
      
      bannerInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          // Check file size (max 5MB)
          if (file.size > 5 * 1024 * 1024) {
            alert('Image size should be less than 5MB');
            e.target.value = '';
            return;
          }
          
          // Check if it's an image
          if (!file.type.startsWith('image/')) {
            alert('Please select an image file');
            e.target.value = '';
            return;
          }
          
          // Show cropper
          showBannerCropper(file);
        }
      });

      // Initialize privacy display
      updatePrivacyDisplay(true);
    });

    async function createCommunity(event) {
      event.preventDefault();
      
      const name = document.getElementById('community-name').value;
      const teamName = document.getElementById('team-name').value;
      const description = document.getElementById('community-description').value;
      const isPublic = document.getElementById('is-public').checked;
      const bannerInput = document.getElementById('banner-image');

      console.log('=== CREATE COMMUNITY DEBUG ===');
      console.log('Creating community:', { name, teamName, description, isPublic });
      console.log('croppedBannerBlob:', croppedBannerBlob);
      console.log('bannerInput.files:', bannerInput.files);
      console.log('bannerInput.files[0]:', bannerInput.files[0]);

      try {
        const formData = new FormData();
        formData.append('name', name);
        if (teamName) formData.append('team_name', teamName);
        if (description) formData.append('description', description);
        formData.append('is_public', isPublic ? '1' : '0');
        
        // PRIORITY: Use cropped banner blob if available
        if (croppedBannerBlob) {
          console.log('âœ… Using cropped banner blob, size:', croppedBannerBlob.size);
          formData.append('banner', croppedBannerBlob, 'banner.jpg');
        } 
        // FALLBACK: Use original file if no cropped blob but file was selected
        else if (bannerInput.files && bannerInput.files[0]) {
          console.log('âœ… Using original banner file:', bannerInput.files[0].name);
          formData.append('banner', bannerInput.files[0]);
        } else {
          console.log('âš ï¸ No banner file selected');
        }
        
        // Log FormData contents
        console.log('FormData contents:');
        for (let pair of formData.entries()) {
          console.log(pair[0], ':', pair[1]);
        }

        console.log('Sending request to create community...');
        const response = await fetch('/api/communities', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
            // Do NOT set Content-Type - let browser set it with boundary for FormData
          },
          body: formData
        });

        console.log('Response status:', response.status);
        const responseText = await response.text();
        console.log('Response body:', responseText);
        
        if (!response.ok) {
          let error;
          try {
            error = JSON.parse(responseText);
          } catch (e) {
            error = { error: responseText || 'Failed to create community' };
          }
          console.error('Error response:', error);
          alert(error.error || 'Failed to create community');
          return;
        }
        
        const data = JSON.parse(responseText);
        console.log('Community created successfully:', data);
        
        // Close modal and reset
        closeCreateModal();
        croppedBannerBlob = null;
        
        // Reload communities
        await loadCommunities();
        
        // Show success message
        InnovateAPI.showAlert('ðŸŽ‰ Community created successfully!', 'success');
        
        // Navigate to the new community
        setTimeout(() => {
          window.location.href = `/community/${data.community.id}`;
        }, 1000);
      } catch (error) {
        console.error('Error creating community:', error);
        alert('Failed to create community: ' + error.message);
      }
    }

    // Initialize
    loadCommunities();
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
</body>
</html>

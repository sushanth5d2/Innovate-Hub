<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Communities - Innovate</title>
  <link rel="stylesheet" href="/css/instagram.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <!-- Top Navigation -->
  <nav class="ig-top-nav">
    <div class="ig-nav-container">
      <a href="/home" class="ig-logo">Innovate</a>
      
      <div class="ig-search-box">
        <input type="text" class="ig-search-input" placeholder="Search communities..." id="search-input" oninput="searchCommunities()">
      </div>
      
      <div class="ig-nav-icons">
        <div class="ig-nav-icon" onclick="window.location.href='/home'">
          <svg aria-label="Home" fill="currentColor" height="24" viewBox="0 0 24 24" width="24">
            <path d="M9.005 16.545a2.997 2.997 0 0 1 2.997-2.997A2.997 2.997 0 0 1 15 16.545V22h7V11.543L12 2 2 11.543V22h7.005Z" fill="none" stroke="currentColor" stroke-linejoin="round" stroke-width="2"></path>
          </svg>
        </div>
        
        <div class="ig-nav-icon" onclick="openCreateModal()">
          <svg aria-label="New community" fill="currentColor" height="24" viewBox="0 0 24 24" width="24">
            <path d="M2 12v3.45c0 2.849.698 4.005 1.606 4.944.94.909 2.098 1.608 4.946 1.608h6.896c2.848 0 4.006-.7 4.946-1.608C21.302 19.455 22 18.3 22 15.45V8.552c0-2.849-.698-4.006-1.606-4.945C19.454 2.7 18.296 2 15.448 2H8.552c-2.848 0-4.006.699-4.946 1.607C2.698 4.547 2 5.703 2 8.552Z" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
            <line fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" x1="6.545" x2="17.455" y1="12.001" y2="12.001"></line>
            <line fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" x1="12.003" x2="12.003" y1="6.545" y2="17.455"></line>
          </svg>
        </div>
        
        <div class="ig-nav-icon" onclick="window.location.href='/notifications'">
          <svg aria-label="Notifications" fill="currentColor" height="24" viewBox="0 0 24 24" width="24">
            <path d="M16.792 3.904A4.989 4.989 0 0 1 21.5 9.122c0 3.072-2.652 4.959-5.197 7.222-2.512 2.243-3.865 3.469-4.303 3.752-.477-.309-2.143-1.823-4.303-3.752C5.141 14.072 2.5 12.167 2.5 9.122a4.989 4.989 0 0 1 4.708-5.218 4.21 4.21 0 0 1 3.675 1.941c.84 1.175.98 1.763 1.12 1.763s.278-.588 1.11-1.766a4.17 4.17 0 0 1 3.679-1.938m0-2a6.04 6.04 0 0 0-4.797 2.127 6.052 6.052 0 0 0-4.787-2.127A6.985 6.985 0 0 0 .5 9.122c0 3.61 2.55 5.827 5.015 7.97.283.246.569.494.853.747l1.027.918a44.998 44.998 0 0 0 3.518 3.018 2 2 0 0 0 2.174 0 45.263 45.263 0 0 0 3.626-3.115l.922-.824c.293-.26.59-.519.885-.774 2.334-2.025 4.98-4.32 4.98-7.94a6.985 6.985 0 0 0-6.708-7.218Z"></path>
          </svg>
        </div>
        
        <div class="ig-nav-icon" onclick="window.location.href='/profile'">
          <img id="navProfilePic" src="/images/default-avatar.svg" alt="Profile" style="width: 24px; height: 24px; border-radius: 50%; object-fit: cover;">
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="ig-main">
    <div id="communities-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 24px; padding: 24px 0;">
      <!-- Communities will be loaded here -->
    </div>
  </main>

  <!-- Create Community Modal -->
  <div id="create-modal" class="ig-modal-overlay" style="display: none;">
    <div class="ig-modal">
      <div class="ig-modal-item" style="padding: 20px; text-align: left;">
        <h3 style="margin: 0 0 20px 0; font-size: 18px; font-weight: 600;">Create Community</h3>
        
        <form id="create-form" onsubmit="createCommunity(); return false;">
          <div style="margin-bottom: 16px;">
            <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 600;">Community Name</label>
            <input type="text" id="community-name" style="width: 100%; padding: 10px; border: 1px solid var(--ig-border); border-radius: 4px; background: var(--ig-secondary-background); color: var(--ig-primary-text);" required>
          </div>
          
          <div style="margin-bottom: 16px;">
            <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 600;">Team Name (optional)</label>
            <input type="text" id="team-name" placeholder="For sports communities" style="width: 100%; padding: 10px; border: 1px solid var(--ig-border); border-radius: 4px; background: var(--ig-secondary-background); color: var(--ig-primary-text);">
          </div>
          
          <div style="margin-bottom: 16px;">
            <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 600;">Description</label>
            <textarea id="community-description" rows="3" style="width: 100%; padding: 10px; border: 1px solid var(--ig-border); border-radius: 4px; background: var(--ig-secondary-background); color: var(--ig-primary-text);"></textarea>
          </div>
          
          <div style="margin-bottom: 20px;">
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input type="checkbox" id="is-public" checked style="margin-right: 10px;">
              <span style="font-size: 14px;">Public community</span>
            </label>
          </div>
          
          <div style="display: flex; gap: 10px;">
            <button type="button" onclick="closeCreateModal()" style="flex: 1; padding: 12px; border: 1px solid var(--ig-border); border-radius: 4px; background: transparent; color: var(--ig-primary-text); cursor: pointer;">Cancel</button>
            <button type="submit" style="flex: 1; padding: 12px; border: none; border-radius: 4px; background: var(--ig-blue); color: white; font-weight: 600; cursor: pointer;">Create</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Bottom Navigation -->
  <nav class="ig-bottom-nav">
    <a href="/home" class="ig-bottom-nav-item">
      <svg aria-label="Home" viewBox="0 0 24 24" width="24">
        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
        <polyline points="9 22 9 12 15 12 15 22" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <span class="ig-bottom-nav-label">Home</span>
    </a>
    <a href="/communities" class="ig-bottom-nav-item active">
      <svg aria-label="Communities" viewBox="0 0 24 24" width="24">
        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
        <circle cx="9" cy="7" r="4" stroke="currentColor" stroke-width="2" fill="none"/>
        <path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <span class="ig-bottom-nav-label">Communities</span>
    </a>
    <a href="/events" class="ig-bottom-nav-item">
      <svg aria-label="Events" viewBox="0 0 24 24" width="24">
        <rect x="3" y="4" width="18" height="18" rx="2" ry="2" stroke="currentColor" stroke-width="2" fill="none"/>
        <line x1="16" y1="2" x2="16" y2="6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <line x1="8" y1="2" x2="8" y2="6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <line x1="3" y1="10" x2="21" y2="10" stroke="currentColor" stroke-width="2"/>
      </svg>
      <span class="ig-bottom-nav-label">Events</span>
    </a>
    <button class="ig-bottom-nav-item" onclick="openCreateModal()" style="background: none; border: none; cursor: pointer;">
      <svg aria-label="Create" viewBox="0 0 24 24" width="24">
        <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"/>
      </svg>
      <span class="ig-bottom-nav-label">Create</span>
    </button>
    <a href="/social-service" class="ig-bottom-nav-item">
      <svg aria-label="Social Service" viewBox="0 0 24 24" width="24">
        <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <span class="ig-bottom-nav-label">Service</span>
    </a>
    <a href="/search" class="ig-bottom-nav-item">
      <svg aria-label="Search" viewBox="0 0 24 24" width="24">
        <circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2" fill="none"/>
        <line x1="21" y1="21" x2="16.65" y2="16.65" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
      <span class="ig-bottom-nav-label">Search</span>
    </a>
    <a href="#" class="ig-bottom-nav-item" id="profileNavLink" onclick="navigateToProfile(event)">
      <svg aria-label="Profile" viewBox="0 0 24 24" width="24">
        <circle cx="12" cy="7" r="4" stroke="currentColor" stroke-width="2" fill="none"/>
        <path d="M5.5 21v-2a7.5 7.5 0 0 1 13 0v2" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/>
      </svg>
      <span class="ig-bottom-nav-label">Profile</span>
    </a>
  </nav>

  <script>
    function navigateToProfile(e) {
      e.preventDefault();
      const user = InnovateAPI.getCurrentUser();
      if (user && user.id) {
        window.location.href = `/profile/${user.id}`;
      }
    }
  </script>


  <script src="/socket.io/socket.io.js"></script>
  <script src="/js/instagram-theme.js"></script>
  <script>
    const socket = io();

    if (!localStorage.getItem('token')) {
      window.location.href = '/login';
    }

    async function loadCommunities() {
      try {
        const response = await fetch('/api/communities', {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          }
        });

        if (!response.ok) throw new Error('Failed to load communities');
        
        const data = await response.json();
        displayCommunities(data.communities || []);
      } catch (error) {
        console.error('Error loading communities:', error);
      }
    }

    function displayCommunities(communities) {
      const grid = document.getElementById('communities-grid');
      grid.innerHTML = '';

      if (communities.length === 0) {
        grid.innerHTML = `
          <div style="grid-column: 1/-1; text-align: center; padding: 60px 20px;">
            <div style="font-size: 48px; margin-bottom: 16px;">ðŸ‘¥</div>
            <p style="color: var(--ig-secondary-text); margin-bottom: 24px;">No communities yet</p>
            <button class="ig-action-btn" onclick="openCreateModal()" style="padding: 10px 24px; background: var(--ig-blue); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">Create First Community</button>
          </div>
        `;
        return;
      }

      communities.forEach(community => {
        const card = document.createElement('div');
        card.className = 'ig-post';
        card.style.cursor = 'pointer';
        card.innerHTML = `
          <div style="padding: 0; overflow: hidden;">
            <div style="height: 150px; background: linear-gradient(135deg, ${getRandomColor()}, ${getRandomColor()}); display: flex; align-items: center; justify-content: center; position: relative;">
              ${community.banner_image ? `<img src="${community.banner_image}" style="width: 100%; height: 100%; object-fit: cover;">` : `<div style="font-size: 48px;">ðŸ‘¥</div>`}
            </div>
            <div style="padding: 16px;">
              <h3 style="margin: 0 0 8px 0; font-size: 16px; font-weight: 600;">${community.name}</h3>
              ${community.team_name ? `<div style="color: var(--ig-blue); font-size: 14px; margin-bottom: 8px;"><i class="fas fa-trophy"></i> ${community.team_name}</div>` : ''}
              <div style="display: flex; gap: 16px; margin-bottom: 12px; font-size: 14px; color: var(--ig-secondary-text);">
                <span><i class="fas fa-users"></i> ${community.member_count || 0} members</span>
                ${community.is_public ? '<span><i class="fas fa-globe"></i> Public</span>' : '<span><i class="fas fa-lock"></i> Private</span>'}
              </div>
              <p style="color: var(--ig-secondary-text); font-size: 14px; margin: 0 0 16px 0;">${community.description || ''}</p>
              <button class="ig-action-btn ${community.is_member ? 'joined' : ''}" onclick="toggleJoin(${community.id}, this, event)" style="width: 100%; padding: 10px; background: ${community.is_member ? 'transparent' : 'var(--ig-blue)'}; color: ${community.is_member ? 'var(--ig-primary-text)' : 'white'}; border: ${community.is_member ? '1px solid var(--ig-border)' : 'none'}; border-radius: 8px; font-weight: 600; cursor: pointer;">
                ${community.is_member ? 'Joined' : 'Join'}
              </button>
            </div>
          </div>
        `;
        card.onclick = (e) => {
          if (!e.target.classList.contains('ig-action-btn')) {
            window.location.href = `/community/${community.id}`;
          }
        };
        grid.appendChild(card);
      });
    }

    function getRandomColor() {
      const colors = ['#833AB4', '#FD1D1D', '#F77737', '#4F5BD5', '#962FBF', '#F09433'];
      return colors[Math.floor(Math.random() * colors.length)];
    }

    async function toggleJoin(communityId, button, event) {
      event.stopPropagation();
      const isJoined = button.classList.contains('joined');

      try {
        const endpoint = isJoined
          ? `/api/communities/${communityId}/leave`
          : `/api/communities/${communityId}/join`;

        const response = await fetch(endpoint, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          }
        });

        if (!response.ok) throw new Error('Failed to join/leave community');
        
        button.classList.toggle('joined');
        button.textContent = isJoined ? 'Join' : 'Joined';
        button.style.background = isJoined ? 'var(--ig-blue)' : 'transparent';
        button.style.color = isJoined ? 'white' : 'var(--ig-primary-text)';
        button.style.border = isJoined ? 'none' : '1px solid var(--ig-border)';
      } catch (error) {
        console.error('Error toggling join:', error);
      }
    }

    let searchTimeout;
    async function searchCommunities() {
      clearTimeout(searchTimeout);
      const query = document.getElementById('search-input').value;

      searchTimeout = setTimeout(async () => {
        try {
          const response = await fetch(`/api/search/communities?q=${encodeURIComponent(query)}`, {
            headers: {
              'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
          });

          if (!response.ok) throw new Error('Search failed');
          
          const data = await response.json();
          displayCommunities(data.communities || []);
        } catch (error) {
          console.error('Error searching:', error);
        }
      }, 300);
    }

    function openCreateModal() {
      document.getElementById('create-modal').style.display = 'flex';
    }

    function closeCreateModal() {
      document.getElementById('create-modal').style.display = 'none';
      document.getElementById('create-form').reset();
    }

    async function createCommunity() {
      event.preventDefault();
      
      const name = document.getElementById('community-name').value;
      const teamName = document.getElementById('team-name').value;
      const description = document.getElementById('community-description').value;
      const isPublic = document.getElementById('is-public').checked;

      try {
        const response = await fetch('/api/communities', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          },
          body: JSON.stringify({
            name,
            team_name: teamName,
            description,
            is_public: isPublic
          })
        });

        if (!response.ok) {
          const error = await response.json();
          alert(error.error || 'Failed to create community');
          return;
        }
        
        const data = await response.json();
        closeCreateModal();
        loadCommunities();
        alert('Community created successfully!');
      } catch (error) {
        console.error('Error creating community:', error);
        alert('Failed to create community');
      }
    }

    // Initialize
    loadCommunities();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Community - Innovate</title>
  <link rel="stylesheet" href="/css/instagram.css">
  <link rel="stylesheet" href="/css/workspace.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="/js/instagram-theme.js"></script>
  <style>
    /* WhatsApp Community Complete Styles */
    body { margin: 0; padding: 0; overflow: hidden; }
    
    .community-shell {
      display: grid;
      grid-template-columns: 380px 1fr 360px;
      height: 100vh;
      background: var(--ig-primary-background);
    }

    /* LEFT SIDEBAR - Groups & Announcements */
    .community-left {
      border-right: 1px solid var(--ig-border);
      background: var(--ig-primary-background);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .left-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--ig-border);
      background: var(--ig-secondary-background);
    }

    .community-title {
      font-size: 18px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 4px;
    }

    .community-subtitle {
      font-size: 13px;
      color: var(--ig-secondary-text);
    }

    .left-tabs {
      display: flex;
      border-bottom: 1px solid var(--ig-border);
    }

    .left-tab {
      flex: 1;
      padding: 12px;
      text-align: center;
      font-size: 14px;
      font-weight: 600;
      color: var(--ig-secondary-text);
      border-bottom: 2px solid transparent;
      cursor: pointer;
      background: none;
      border: none;
      transition: all 0.2s;
    }

    .left-tab.active {
      color: var(--ig-blue);
      border-bottom-color: var(--ig-blue);
    }

    .left-content {
      flex: 1;
      overflow-y: auto;
    }

    .group-item {
      padding: 12px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      border-bottom: 1px solid var(--ig-border);
      transition: background 0.2s;
    }

    .group-item:hover, .group-item.active {
      background: var(--ig-hover);
    }

    .group-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--ig-blue), #5B86E5);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 18px;
      flex-shrink: 0;
    }

    .group-info {
      flex: 1;
      min-width: 0;
    }

    .group-name {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .group-desc {
      font-size: 13px;
      color: var(--ig-secondary-text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .left-footer {
      padding: 16px;
      border-top: 1px solid var(--ig-border);
    }

    /* CENTER - Main Content */
    .community-center {
      display: flex;
      flex-direction: column;
      background: var(--ig-secondary-background);
      overflow: hidden;
    }

    .center-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--ig-border);
      background: var(--ig-primary-background);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .header-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--ig-blue);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
    }

    .header-title {
      font-size: 16px;
      font-weight: 600;
      margin: 0;
    }

    .header-subtitle {
      font-size: 13px;
      color: var(--ig-secondary-text);
      margin: 2px 0 0 0;
    }

    .center-tabs {
      display: flex;
      gap: 8px;
      padding: 12px 20px;
      border-bottom: 1px solid var(--ig-border);
      background: var(--ig-primary-background);
      overflow-x: auto;
    }

    .center-tab {
      padding: 8px 16px;
      border-radius: 20px;
      background: var(--ig-secondary-background);
      border: 1px solid var(--ig-border);
      color: var(--ig-secondary-text);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.2s;
    }

    .center-tab.active {
      background: var(--ig-blue);
      color: white;
      border-color: var(--ig-blue);
    }

    .center-content {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }

    .center-footer {
      padding: 12px 16px;
      border-top: 1px solid var(--ig-border);
      background: var(--ig-primary-background);
    }

    /* RIGHT SIDEBAR - Info & Settings */
    .community-right {
      border-left: 1px solid var(--ig-border);
      background: var(--ig-primary-background);
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }

    .right-header {
      padding: 24px 20px;
      text-align: center;
      border-bottom: 1px solid var(--ig-border);
    }

    .right-avatar {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--ig-blue), #5B86E5);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 48px;
      margin: 0 auto 16px;
    }

    .right-name {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .right-meta {
      font-size: 13px;
      color: var(--ig-secondary-text);
    }

    .right-actions {
      display: flex;
      justify-content: space-around;
      padding: 16px;
      border-bottom: 1px solid var(--ig-border);
    }

    .right-action {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      transition: opacity 0.2s;
    }

    .right-action:hover { opacity: 0.7; }

    .action-circle {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: var(--ig-blue);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
    }

    .action-label {
      font-size: 12px;
      color: var(--ig-secondary-text);
    }

    .right-section {
      padding: 20px;
      border-bottom: 1px solid var(--ig-border);
    }

    .section-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--ig-secondary-text);
      margin-bottom: 12px;
      letter-spacing: 0.5px;
    }

    .menu-item {
      padding: 14px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--ig-border);
      cursor: pointer;
      transition: background 0.2s;
    }

    .menu-item:hover {
      background: var(--ig-hover);
    }

    .menu-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .menu-icon {
      width: 24px;
      text-align: center;
      color: var(--ig-secondary-text);
    }

    /* Content Cards */
    .announcement-card {
      background: var(--ig-primary-background);
      border: 1px solid var(--ig-border);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
    }

    .card-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .card-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--ig-blue);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
    }

    .card-info {
      flex: 1;
    }

    .card-author {
      font-size: 14px;
      font-weight: 600;
    }

    .card-date {
      font-size: 12px;
      color: var(--ig-secondary-text);
    }

    .card-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .card-body {
      font-size: 14px;
      line-height: 1.6;
    }

    /* Call Interface */
    .call-view {
      display: flex;
      flex-direction: column;
      height: 100%;
      background: #1a1a1a;
    }

    .video-grid {
      flex: 1;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 8px;
      padding: 16px;
      overflow-y: auto;
    }

    .video-tile {
      background: #2a2a2a;
      border-radius: 12px;
      position: relative;
      aspect-ratio: 16/9;
      overflow: hidden;
    }

    .video-tile video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .video-name {
      position: absolute;
      bottom: 12px;
      left: 12px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
    }

    .call-controls {
      padding: 20px;
      background: #1a1a1a;
      display: flex;
      justify-content: center;
      gap: 16px;
    }

    .call-btn {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      color: white;
      font-size: 20px;
    }

    .call-btn.mute { background: #4a4a4a; }
    .call-btn.end { background: #e74c3c; }
    .call-btn.video { background: #4a4a4a; }
    .call-btn.screen { background: #4a4a4a; }

    .call-btn:hover {
      transform: scale(1.1);
    }

    /* Folder UI */
    .folder-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 12px;
    }

    .folder-item {
      padding: 16px;
      border: 1px solid var(--ig-border);
      border-radius: 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .folder-item:hover {
      background: var(--ig-hover);
      transform: translateY(-2px);
    }

    .folder-icon {
      font-size: 48px;
      margin-bottom: 8px;
    }

    .folder-name {
      font-size: 14px;
      font-weight: 500;
    }

    .folder-count {
      font-size: 12px;
      color: var(--ig-secondary-text);
      margin-top: 4px;
    }

    /* Task Card */
    .task-card {
      background: var(--ig-primary-background);
      border: 1px solid var(--ig-border);
      border-radius: 10px;
      padding: 14px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .task-card:hover {
      border-color: var(--ig-blue);
      transform: translateX(4px);
    }

    .task-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .task-title {
      font-size: 14px;
      font-weight: 600;
    }

    .task-priority {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }

    .priority-high { background: #ffebee; color: #c62828; }
    .priority-medium { background: #fff3e0; color: #ef6c00; }
    .priority-low { background: #e8f5e9; color: #2e7d32; }

    .task-desc {
      font-size: 13px;
      color: var(--ig-secondary-text);
      margin-bottom: 8px;
    }

    .task-meta {
      display: flex;
      gap: 12px;
      font-size: 12px;
      color: var(--ig-secondary-text);
    }

    /* Note Editor */
    .note-editor {
      background: var(--ig-primary-background);
      border: 1px solid var(--ig-border);
      border-radius: 12px;
      padding: 16px;
    }

    .note-editor textarea {
      width: 100%;
      min-height: 300px;
      border: none;
      background: transparent;
      color: var(--ig-primary-text);
      font-size: 14px;
      font-family: 'Monaco', 'Courier New', monospace;
      resize: vertical;
      outline: none;
    }

    /* Modals */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      animation: fadeIn 0.2s;
    }

    .modal-content {
      background: var(--ig-primary-background);
      border-radius: 16px;
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      padding: 24px;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-title {
      font-size: 20px;
      font-weight: 600;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--ig-secondary-text);
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .form-input,
    .form-textarea,
    .form-select {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--ig-border);
      border-radius: 8px;
      background: var(--ig-secondary-background);
      color: var(--ig-primary-text);
      font-size: 14px;
    }

    .form-textarea {
      min-height: 100px;
      resize: vertical;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary {
      background: var(--ig-blue);
      color: white;
    }

    .btn-secondary {
      background: var(--ig-secondary-background);
      color: var(--ig-primary-text);
      border: 1px solid var(--ig-border);
    }

    .btn-danger {
      background: var(--ig-error);
      color: white;
    }

    .btn:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }

    .btn-group {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }

    /* Empty States */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--ig-secondary-text);
    }

    .empty-icon {
      font-size: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .empty-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .empty-text {
      font-size: 14px;
    }

    /* Responsive */
    @media (max-width: 1200px) {
      .community-shell {
        grid-template-columns: 320px 1fr;
      }
      .community-right {
        display: none;
      }
    }

    @media (max-width: 768px) {
      .community-shell {
        grid-template-columns: 1fr;
      }
      .community-left {
        display: none;
      }
      .community-left.mobile-active {
        display: flex;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 1000;
      }
    }

    /* Loading */
    .loading {
      text-align: center;
      padding: 40px;
      color: var(--ig-secondary-text);
    }

    .spinner {
      border: 3px solid var(--ig-border);
      border-top-color: var(--ig-blue);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* File Upload */
    .file-upload {
      border: 2px dashed var(--ig-border);
      border-radius: 12px;
      padding: 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .file-upload:hover {
      border-color: var(--ig-blue);
      background: var(--ig-hover);
    }

    .file-upload.drag-over {
      border-color: var(--ig-blue);
      background: var(--ig-hover);
    }

    /* GitHub Integration */
    .github-connected {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: var(--ig-secondary-background);
      border: 1px solid var(--ig-border);
      border-radius: 10px;
      margin-bottom: 16px;
    }

    .github-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #24292e;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
    }

    .repo-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .repo-item {
      padding: 12px 16px;
      border: 1px solid var(--ig-border);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      transition: all 0.2s;
    }

    .repo-item:hover {
      border-color: var(--ig-blue);
      background: var(--ig-hover);
    }
  </style>
</head>
<body>
  <div class="community-shell">
    <!-- LEFT SIDEBAR -->
    <div class="community-left" id="communityLeft">
      <div class="left-header">
        <div style="display: flex; align-items: center; gap: 8px; justify-content: space-between; width: 100%;">
          <div style="display: flex; align-items: center; gap: 12px; flex: 1; min-width: 0;">
            <button onclick="window.location.href='/communities'" style="width: 40px; height: 40px; border-radius: 10px; background: var(--ig-blue); color: white; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; flex-shrink: 0; font-size: 18px; box-shadow: 0 2px 4px rgba(0, 149, 246, 0.3);" onmouseover="this.style.background='#0081d5'" onmouseout="this.style.background='var(--ig-blue)'" title="Back to Communities">
              <i class="fas fa-arrow-left"></i>
            </button>
            <div style="flex: 1; min-width: 0;">
              <div class="community-title">
                <i class="fas fa-users"></i>
                <span id="communityName">Loading...</span>
              </div>
              <div class="community-subtitle" id="communitySubtitle">Community</div>
            </div>
          </div>
          <button onclick="toggleTheme()" style="width: 40px; height: 40px; border-radius: 50%; background: #FFD700; color: #000; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; flex-shrink: 0; font-size: 18px; box-shadow: 0 2px 8px rgba(255, 215, 0, 0.4);" onmouseover="this.style.background='#FFC700'; this.style.transform='scale(1.05)'" onmouseout="this.style.background='#FFD700'; this.style.transform='scale(1)'" title="Toggle Theme">
            <i class="fas fa-moon" id="themeIcon"></i>
          </button>
        </div>
      </div>

      <div class="left-tabs">
        <button class="left-tab active" onclick="switchLeftTab('announcements')">Announcements</button>
        <button class="left-tab" onclick="switchLeftTab('groups')">Groups</button>
        <button class="left-tab" onclick="switchLeftTab('folders')">Folders</button>
        <button class="left-tab" onclick="switchLeftTab('github')">GitHub</button>
      </div>

      <div class="left-content" id="leftContent">
        <!-- Content loads here -->
      </div>

      <div class="left-footer" id="leftFooter">
        <button class="btn btn-primary" style="width: 100%;" onclick="showCreateAnnouncementModal()" id="leftFooterBtn">
          <i class="fas fa-plus"></i> Create Announcement
        </button>
      </div>
    </div>

    <!-- CENTER PANEL -->
    <div class="community-center">
      <div class="center-header">
        <div class="header-left">
          <button class="ws-icon-btn" onclick="toggleLeftSidebar()" style="margin-right: 8px; display: none;" id="menuBtn">
            <i class="fas fa-bars"></i>
          </button>
          <div class="header-icon" id="centerIcon">
            <i class="fas fa-bullhorn"></i>
          </div>
          <div>
            <h2 class="header-title" id="centerTitle">Announcements</h2>
            <p class="header-subtitle" id="centerSubtitle">Community updates and news</p>
          </div>
        </div>
        <div id="centerActions"></div>
      </div>

      <div class="center-tabs" id="centerTabs" style="display: none;">
        <!-- Tabs load dynamically -->
      </div>

      <div class="center-content" id="centerContent">
        <div class="empty-state">
          <div class="empty-icon"></div>
          <div class="empty-title">Welcome to your community!</div>
          <div class="empty-text">Select a group from the sidebar to start collaborating</div>
        </div>
      </div>

      <div class="center-footer" id="centerFooter" style="display: none;">
        <!-- Dynamic footer (chat input, etc.) -->
      </div>
    </div>

    <!-- RIGHT SIDEBAR -->
    <div class="community-right" id="communityRight">
      <div class="right-header">
        <div class="right-avatar" id="rightAvatar">
          <i class="fas fa-users"></i>
        </div>
        <div class="right-name" id="rightName">Community Name</div>
        <div class="right-meta" id="rightMeta">Community 路 0 groups</div>
      </div>

      <div class="right-actions">
        <div class="right-action" onclick="inviteMembers()">
          <div class="action-circle">
            <i class="fas fa-link"></i>
          </div>
          <div class="action-label">Invite</div>
        </div>

        <div class="right-action" onclick="addMembers()">
          <div class="action-circle">
            <i class="fas fa-user-plus"></i>
          </div>
          <div class="action-label">Add members</div>
        </div>

        <div class="right-action" onclick="showCreateGroupModal()">
          <div class="action-circle">
            <i class="fas fa-users-cog"></i>
          </div>
          <div class="action-label">Add groups</div>
        </div>
      </div>

      <div class="right-section">
        <div class="section-title">DESCRIPTION</div>
        <div id="rightDescription">Loading...</div>
      </div>

      <div class="menu-item" onclick="manageGroups()">
        <div class="menu-left">
          <div class="menu-icon"><i class="fas fa-users"></i></div>
          <div>Manage groups</div>
        </div>
        <i class="fas fa-chevron-right"></i>
      </div>

      <div class="menu-item" onclick="showCommunitySettings()">
        <div class="menu-left">
          <div class="menu-icon"><i class="fas fa-cog"></i></div>
          <div>Community settings</div>
        </div>
        <i class="fas fa-chevron-right"></i>
      </div>

      <div class="menu-item" onclick="viewAllGroups()">
        <div class="menu-left">
          <div class="menu-icon"><i class="fas fa-list"></i></div>
          <div>View groups</div>
        </div>
        <div id="groupCountBadge" style="color: var(--ig-secondary-text);">(0)</div>
      </div>

      <div class="menu-item" onclick="showGitHubIntegration()">
        <div class="menu-left">
          <div class="menu-icon"><i class="fab fa-github"></i></div>
          <div>GitHub Integration</div>
        </div>
        <i class="fas fa-chevron-right"></i>
      </div>
    </div>
  </div>

  <!-- Modals Container -->
  <div id="modalsContainer"></div>

  <script src="/socket.io/socket.io.js"></script>
  <script src="/js/app.js"></script>
  <script>
    // ==================== GLOBAL STATE ====================
    let state = {
      communityId: null,
      currentGroupId: null,
      currentAnnouncementId: null,
      currentView: 'announcements', // announcements, chat, calls, folders, tasks, notes
      socket: null,
      user: null,
      community: null,
      groups: [],
      currentCall: null,
      localStream: null,
      peerConnections: {},
      githubIntegration: null
    };

    // ==================== INITIALIZATION ====================
    document.addEventListener('DOMContentLoaded', async () => {
      if (!InnovateAPI.requireAuth()) return;
      
      state.user = InnovateAPI.getCurrentUser();
      state.socket = InnovateAPI.initSocket();
      
      // Initialize theme icon
      initializeThemeIcon();
      
      // Get community ID from URL
      const urlParams = new URLSearchParams(window.location.search);
      state.communityId = urlParams.get('id') || window.location.pathname.split('/').pop();
      
      // Check if there's a group parameter in URL
      const groupIdFromUrl = urlParams.get('groupId');
      console.log('=== DOMContentLoaded Initialization ===');
      console.log('Community ID:', state.communityId);
      console.log('Group ID from URL:', groupIdFromUrl);

      await Promise.all([
        loadCommunityData()
      ]);
      console.log('Community data loaded');

      // Load groups first
      await loadGroups();
      console.log('Groups loaded, count:', state.groups.length);
      
      // If groupId in URL or last selected group, auto-select it
      if (groupIdFromUrl) {
        console.log('=== AUTO-SELECTING GROUP ===');
        console.log('Auto-selecting group from URL:', groupIdFromUrl);
        
        // Switch to Groups tab FIRST
        console.log('Step 1: Switching to groups tab');
        switchLeftTab('groups');
        
        // Wait a bit for tab switch to complete
        await new Promise(resolve => setTimeout(resolve, 100));
        console.log('Step 2: Tab switch complete, now selecting group');
        
        // Select the group
        await selectGroup(parseInt(groupIdFromUrl));
        console.log('Step 3: Group selection complete');
      } else {
        console.log('No groupId in URL, showing announcements');
        // Show announcements by default (Announcements tab is active)
        await loadAnnouncements();
      }

      setupSocketListeners();
      setupResponsive();
    });

    // ==================== SOCKET LISTENERS ====================
    function setupSocketListeners() {
      if (!state.socket) return;

      state.socket.on('announcement:new', (data) => {
        if (data.communityId == state.communityId) loadAnnouncements();
      });

      state.socket.on('group:new', (data) => {
        if (data.communityId == state.communityId) loadGroups();
      });

      state.socket.on('group:message', (data) => {
        if (data.groupId == state.currentGroupId) appendChatMessage(data.message);
      });
      
      // Listen for community group posts (real-time messages)
      state.socket.on('community-group:post:new', (data) => {
        console.log('Real-time message received:', data);
        if (data.group_id == state.currentGroupId) {
          appendChatMessage(data);
        }
        // Update groups list to show latest message
        loadGroups();
      });
      
      state.socket.on('poll:voted', (data) => {
        // Update poll display in real-time if viewing this announcement
        const pollElement = document.getElementById(`poll-${data.announcementId}`);
        if (pollElement) {
          const poll = {
            question: data.results.options.join(' / '), // This will be replaced by actual poll data
            options: data.results.options,
            votes: [] // Backend sends counts directly, not individual votes
          };
          // Just reload the announcement to get fresh data
          if (state.currentLeftTab === 'announcements' && state.currentAnnouncementId === data.announcementId) {
            viewAnnouncement(data.announcementId);
          }
        }
      });

      state.socket.on('call:offer', handleCallOffer);
      state.socket.on('call:answer', handleCallAnswer);
      state.socket.on('call:ice-candidate', handleIceCandidate);
      state.socket.on('call:peer-joined', handlePeerJoined);
      state.socket.on('call:peer-left', handlePeerLeft);
    }

    // ==================== DATA LOADING ====================
    async function loadCommunityData() {
      try {
        const res = await InnovateAPI.apiRequest(`/communities/${state.communityId}`);
        if (res.success) {
          state.community = res.community;
          document.getElementById('communityName').textContent = res.community.name;
          document.getElementById('communitySubtitle').textContent = res.community.description || 'Community';
          document.getElementById('rightName').textContent = res.community.name;
          document.getElementById('rightDescription').textContent = res.community.description || 'No description';
          document.getElementById('rightMeta').textContent = `Community 路 ${res.community.member_count || 0} members`;
        }
      } catch (error) {
        console.error('Error loading community:', error);
      }
    }

    async function loadGroups() {
      try {
        const res = await InnovateAPI.apiRequest(`/communities/${state.communityId}/groups`);
        if (res.success) {
          state.groups = res.groups || [];
          
          // Fetch latest message for each group
          for (let group of state.groups) {
            try {
              const postsRes = await InnovateAPI.apiRequest(`/community-groups/${group.id}/posts`);
              if (postsRes.success && postsRes.posts && postsRes.posts.length > 0) {
                const sortedPosts = postsRes.posts.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                group.latest_message = sortedPosts[0].content || 'Attachment';
                group.unread_count = 0; // TODO: Implement unread tracking
              }
            } catch (err) {
              // No posts for this group
            }
          }
          
          document.getElementById('groupCountBadge').textContent = `(${state.groups.length})`;
          renderGroupsList();
        }
      } catch (error) {
        console.error('Error loading groups:', error);
      }
    }

    async function loadAnnouncements() {
      try {
        const res = await InnovateAPI.apiRequest(`/communities/${state.communityId}/announcements`);
        if (res.success) {
          renderAnnouncements(res.announcements || []);
        }
      } catch (error) {
        console.error('Error loading announcements:', error);
      }
    }

    // ==================== UI RENDERING ====================
    function renderGroupsList() {
      console.log('renderGroupsList called');
      console.log('Current groups count:', state.groups.length);
      
      // Only render if groups tab is active
      const groupsTab = document.querySelector('.left-tab[onclick*="groups"]');
      console.log('Groups tab element:', groupsTab);
      console.log('Groups tab active?:', groupsTab?.classList.contains('active'));
      
      if (!groupsTab || !groupsTab.classList.contains('active')) {
        console.log('Groups loaded but not displayed (wrong tab active) - EXITING renderGroupsList');
        return;
      }
      
      console.log('Groups tab is active, proceeding with render');
      
      const content = document.getElementById('leftContent');
      const centerContent = document.getElementById('centerContent');
      
      // Only show default center content if no group is currently selected
      if (!state.currentGroupId) {
        console.log('No group selected, showing default empty state');
        centerContent.innerHTML = `
          <div class="empty-state" style="height: 100%; display: flex; flex-direction: column; justify-content: center;">
            <div class="empty-icon"></div>
            <div class="empty-title">Select a group</div>
            <div class="empty-text">Choose from the left sidebar</div>
          </div>
        `;
      } else {
        console.log('Group is selected (ID:', state.currentGroupId, '), NOT clearing center content');
      }
      
      if (state.groups.length === 0) {
        content.innerHTML = `
          <div class="empty-state" style="padding: 60px 20px; text-align: center;">
            <div style="width: 80px; height: 80px; margin: 0 auto 20px; border-radius: 20px; background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 36px;">
              <i class="fas fa-users"></i>
            </div>
            <div style="font-size: 18px; font-weight: 700; margin-bottom: 8px; color: var(--ig-primary-text);">No groups yet</div>
            <div style="font-size: 14px; color: var(--ig-secondary-text); margin-bottom: 24px;">Create your first group to get started</div>
          </div>
        `;
        return;
      }

      content.innerHTML = state.groups.map(group => {
        const latestMsg = group.latest_message || '';
        const unreadCount = group.unread_count || 0;
        const truncatedMsg = latestMsg.length > 30 ? latestMsg.substring(0, 30) + '...' : latestMsg;
        
        return `
          <div class="group-item ${state.currentGroupId == group.id ? 'active' : ''}" onclick="selectGroup(${group.id})">
            <div class="group-avatar">${group.name.charAt(0).toUpperCase()}</div>
            <div class="group-info">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                <div class="group-name">${group.name}</div>
                ${unreadCount > 0 ? `<span style="background: var(--ig-blue); color: white; border-radius: 12px; padding: 2px 8px; font-size: 11px; font-weight: 600;">${unreadCount}</span>` : ''}
              </div>
              <div class="group-desc" style="color: ${latestMsg ? 'var(--ig-primary-text)' : 'var(--ig-secondary-text)'}; font-weight: ${unreadCount > 0 ? '600' : '400'};">
                ${latestMsg ? truncatedMsg : (group.description || 'No messages yet')}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderFoldersList() {
      const content = document.getElementById('leftContent');
      const centerContent = document.getElementById('centerContent');
      
      // Always show Announcements folder first
      let foldersHTML = `
        <div class="group-item" onclick="openAnnouncementsFolder()">
          <div class="group-avatar" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
            <i class="fas fa-bullhorn"></i>
          </div>
          <div class="group-info">
            <div class="group-name">Announcements</div>
            <div class="group-desc">Announcement files & attachments</div>
          </div>
          <i class="fas fa-chevron-right" style="color: var(--ig-secondary-text); font-size: 14px;"></i>
        </div>
      `;
      
      // Add group folders
      if (state.groups.length > 0) {
        foldersHTML += state.groups.map(group => `
          <div class="group-item" onclick="openGroupFolder(${group.id})">
            <div class="group-avatar" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
              <i class="fas fa-folder"></i>
            </div>
            <div class="group-info">
              <div class="group-name">${group.name}</div>
              <div class="group-desc">Group folder 路 Files & resources</div>
            </div>
            <i class="fas fa-chevron-right" style="color: var(--ig-secondary-text); font-size: 14px;"></i>
          </div>
        `).join('');
      }
      
      content.innerHTML = foldersHTML;

      // Show empty state in center
      centerContent.innerHTML = `
        <div class="empty-state" style="height: 100%; display: flex; flex-direction: column; justify-content: center;">
          <div class="empty-icon"></div>
          <div class="empty-title">Select a folder</div>
          <div class="empty-text">Click on a folder from the left to view its contents</div>
        </div>
      `;
    }
    
    function openAnnouncementsFolder() {
      const centerContent = document.getElementById('centerContent');
      
      centerContent.innerHTML = `
        <div style="padding: 24px; max-width: 900px; margin: 0 auto;">
          <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid var(--ig-border);">
            <div style="width: 56px; height: 56px; border-radius: 12px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 24px;">
              <i class="fas fa-bullhorn"></i>
            </div>
            <div style="flex: 1;">
              <h2 style="margin: 0; font-size: 22px;">Announcements</h2>
              <div style="color: var(--ig-secondary-text); font-size: 14px; margin-top: 4px;">
                All announcement attachments and files
              </div>
            </div>
            <button class="btn btn-primary" onclick="switchLeftTab('announcements')">
              <i class="fas fa-arrow-right"></i> View Announcements
            </button>
          </div>
          
          <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 16px;">
            <!-- Images Section -->
            <div onclick="loadAnnouncementFiles('images')" style="background: var(--ig-secondary-background); border: 1px solid var(--ig-border); border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 16px rgba(0,0,0,0.2)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
              <div style="width: 48px; height: 48px; border-radius: 12px; background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; margin-bottom: 12px;">
                <i class="fas fa-image"></i>
              </div>
              <h3 style="margin: 0 0 8px 0; font-size: 16px;">Images</h3>
              <p style="margin: 0; color: var(--ig-secondary-text); font-size: 13px;">Photos from announcements</p>
            </div>

            <!-- Videos Section -->
            <div onclick="loadAnnouncementFiles('videos')" style="background: var(--ig-secondary-background); border: 1px solid var(--ig-border); border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 16px rgba(0,0,0,0.2)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
              <div style="width: 48px; height: 48px; border-radius: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; margin-bottom: 12px;">
                <i class="fas fa-video"></i>
              </div>
              <h3 style="margin: 0 0 8px 0; font-size: 16px;">Videos</h3>
              <p style="margin: 0; color: var(--ig-secondary-text); font-size: 13px;">Video attachments</p>
            </div>

            <!-- Documents Section -->
            <div onclick="loadAnnouncementFiles('documents')" style="background: var(--ig-secondary-background); border: 1px solid var(--ig-border); border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 16px rgba(0,0,0,0.2)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
              <div style="width: 48px; height: 48px; border-radius: 12px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; margin-bottom: 12px;">
                <i class="fas fa-file-alt"></i>
              </div>
              <h3 style="margin: 0 0 8px 0; font-size: 16px;">Documents</h3>
              <p style="margin: 0; color: var(--ig-secondary-text); font-size: 13px;">PDFs, docs, and files</p>
            </div>

            <!-- Links Section -->
            <div onclick="loadAnnouncementFiles('links')" style="background: var(--ig-secondary-background); border: 1px solid var(--ig-border); border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 16px rgba(0,0,0,0.2)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
              <div style="width: 48px; height: 48px; border-radius: 12px; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; margin-bottom: 12px;">
                <i class="fas fa-link"></i>
              </div>
              <h3 style="margin: 0 0 8px 0; font-size: 16px;">Links</h3>
              <p style="margin: 0; color: var(--ig-secondary-text); font-size: 13px;">Shared links from announcements</p>
            </div>
          </div>

          <div style="margin-top: 24px; padding: 20px; background: var(--ig-secondary-background); border: 1px solid var(--ig-border); border-radius: 12px;">
            <h3 style="margin: 0 0 12px 0; font-size: 14px; font-weight: 600; color: var(--ig-secondary-text);">
              <i class="fas fa-info-circle"></i> About Announcements Folder
            </h3>
            <p style="margin: 0; font-size: 13px; color: var(--ig-secondary-text); line-height: 1.6;">
              All files, images, videos, and links shared in announcements are organized here for easy access.
              Click on any category above to view the files.
            </p>
          </div>
        </div>
      `;
    }

    function openGroupFolder(groupId) {
      const group = state.groups.find(g => g.id == groupId);
      if (!group) return;

      const centerContent = document.getElementById('centerContent');
      
      centerContent.innerHTML = `
        <div style="padding: 24px; max-width: 900px; margin: 0 auto;">
          <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid var(--ig-border);">
            <div style="width: 56px; height: 56px; border-radius: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 24px;">
              <i class="fas fa-folder-open"></i>
            </div>
            <div style="flex: 1;">
              <h2 style="margin: 0; font-size: 22px;">${group.name}</h2>
              <div style="color: var(--ig-secondary-text); font-size: 14px; margin-top: 4px;">
                Group folder 路 ${group.description || 'No description'}
              </div>
            </div>
            <button class="btn btn-primary" onclick="selectGroup(${group.id})">
              <i class="fas fa-arrow-right"></i> Open Group
            </button>
          </div>
          
          <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 16px;">
            <!-- Files Section -->
            <div style="background: var(--ig-secondary-background); border: 1px solid var(--ig-border); border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.2s;" onclick="selectGroup(${group.id}); switchCenterTab('folders');">
              <div style="width: 48px; height: 48px; border-radius: 12px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; margin-bottom: 12px;">
                <i class="fas fa-file-alt"></i>
              </div>
              <h3 style="margin: 0 0 8px 0; font-size: 16px;">Files</h3>
              <p style="margin: 0; color: var(--ig-secondary-text); font-size: 13px;">Documents, images, and more</p>
            </div>

            <!-- Links Section -->
            <div style="background: var(--ig-secondary-background); border: 1px solid var(--ig-border); border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.2s;" onclick="selectGroup(${group.id});">
              <div style="width: 48px; height: 48px; border-radius: 12px; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; margin-bottom: 12px;">
                <i class="fas fa-link"></i>
              </div>
              <h3 style="margin: 0 0 8px 0; font-size: 16px;">Links</h3>
              <p style="margin: 0; color: var(--ig-secondary-text); font-size: 13px;">Shared links and resources</p>
            </div>

            <!-- Tasks Section -->
            <div style="background: var(--ig-secondary-background); border: 1px solid var(--ig-border); border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.2s;" onclick="selectGroup(${group.id}); switchCenterTab('tasks');">
              <div style="width: 48px; height: 48px; border-radius: 12px; background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; margin-bottom: 12px;">
                <i class="fas fa-tasks"></i>
              </div>
              <h3 style="margin: 0 0 8px 0; font-size: 16px;">To-Do</h3>
              <p style="margin: 0; color: var(--ig-secondary-text); font-size: 13px;">Group tasks and assignments</p>
            </div>

            <!-- Notes Section -->
            <div style="background: var(--ig-secondary-background); border: 1px solid var(--ig-border); border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.2s;" onclick="selectGroup(${group.id}); switchCenterTab('notes');">
              <div style="width: 48px; height: 48px; border-radius: 12px; background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; margin-bottom: 12px;">
                <i class="fas fa-sticky-note"></i>
              </div>
              <h3 style="margin: 0 0 8px 0; font-size: 16px;">Notes</h3>
              <p style="margin: 0; color: var(--ig-secondary-text); font-size: 13px;">Collaborative documents</p>
            </div>
          </div>

          <div style="margin-top: 24px; padding: 20px; background: var(--ig-secondary-background); border: 1px solid var(--ig-border); border-radius: 12px;">
            <h3 style="margin: 0 0 12px 0; font-size: 14px; font-weight: 600; color: var(--ig-secondary-text);">
              <i class="fas fa-info-circle"></i> About Folders
            </h3>
            <p style="margin: 0; font-size: 13px; color: var(--ig-secondary-text); line-height: 1.6;">
              Each group has its own dedicated folder to organize files, links, tasks, and notes. 
              Click on any section above or use the "Open Group" button to access the full workspace.
            </p>
          </div>
        </div>
      `;
    }
    
    async function loadAnnouncementFiles(type) {
      try {
        const res = await InnovateAPI.apiRequest(`/communities/${state.communityId}/announcements`);
        const announcements = res.announcements || [];
        
        // Extract all files from announcements
        const allFiles = [];
        announcements.forEach(ann => {
          if (ann.attachments) {
            try {
              const attachments = JSON.parse(ann.attachments);
              if (attachments.files && Array.isArray(attachments.files)) {
                attachments.files.forEach(file => {
                  allFiles.push({
                    ...file,
                    announcementId: ann.id,
                    announcementTitle: ann.title,
                    createdAt: ann.created_at
                  });
                });
              }
              
              // Add links if type is 'links'
              if (type === 'links' && attachments.links && Array.isArray(attachments.links)) {
                attachments.links.forEach(link => {
                  allFiles.push({
                    ...link,
                    type: 'link',
                    announcementId: ann.id,
                    announcementTitle: ann.title,
                    createdAt: ann.created_at
                  });
                });
              }
            } catch (e) {
              console.error('Error parsing attachments:', e);
            }
          }
        });
        
        // Filter by type
        let filteredFiles = allFiles;
        if (type === 'images') {
          filteredFiles = allFiles.filter(f => f.type && f.type.startsWith('image/'));
        } else if (type === 'videos') {
          filteredFiles = allFiles.filter(f => f.type && f.type.startsWith('video/'));
        } else if (type === 'documents') {
          filteredFiles = allFiles.filter(f => f.type && (f.type.includes('pdf') || f.type.includes('document') || f.type.includes('msword')));
        } else if (type === 'links') {
          filteredFiles = allFiles.filter(f => f.type === 'link');
        }
        
        // Display files
        const centerContent = document.getElementById('centerContent');
        const typeIcon = type === 'images' ? 'fa-image' : type === 'videos' ? 'fa-video' : type === 'documents' ? 'fa-file-alt' : 'fa-link';
        const typeLabel = type.charAt(0).toUpperCase() + type.slice(1);
        
        centerContent.innerHTML = `
          <div style="padding: 24px; max-width: 1200px; margin: 0 auto;">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid var(--ig-border);">
              <div style="display: flex; align-items: center; gap: 16px;">
                <button onclick="openAnnouncementsFolder()" style="width: 44px; height: 44px; border-radius: 12px; background: var(--ig-blue); color: white; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 8px rgba(0,149,246,0.3);" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 12px rgba(0,149,246,0.4)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 8px rgba(0,149,246,0.3)'">
                  <i class="fas fa-arrow-left" style="font-size: 18px;"></i>
                </button>
                <div>
                  <h2 style="margin: 0; font-size: 22px; display: flex; align-items: center; gap: 12px;">
                    <i class="fas ${typeIcon}" style="color: var(--ig-blue);"></i>
                    ${typeLabel}
                  </h2>
                  <div style="color: var(--ig-secondary-text); font-size: 14px; margin-top: 4px;">
                    ${filteredFiles.length} ${filteredFiles.length === 1 ? 'item' : 'items'} found
                  </div>
                </div>
              </div>
              <button onclick="openAnnouncementsFolder()" style="padding: 10px 20px; background: var(--ig-secondary-background); color: var(--ig-primary-text); border: 1px solid var(--ig-border); border-radius: 10px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s;" onmouseover="this.style.background='var(--ig-hover)'" onmouseout="this.style.background='var(--ig-secondary-background)'">
                <i class="fas fa-arrow-left"></i> Back to Folders
              </button>
            </div>
            
            ${filteredFiles.length === 0 ? `
              <div class="empty-state">
                <div class="empty-icon"><i class="fas ${typeIcon}"></i></div>
                <div class="empty-title">No ${type} found</div>
                <div class="empty-text">Upload files in announcements to see them here</div>
              </div>
            ` : `
              <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(${type === 'links' ? '100%' : '280px'}, 1fr)); gap: 16px;">
                ${filteredFiles.map(file => {
                  if (type === 'links') {
                    return `
                      <a href="${file.url}" target="_blank" style="background: var(--ig-secondary-background); border: 1px solid var(--ig-border); border-radius: 12px; padding: 16px; text-decoration: none; transition: all 0.2s; display: flex; align-items: center; gap: 16px;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                        <div style="width: 48px; height: 48px; border-radius: 10px; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                          <i class="fas fa-external-link-alt" style="color: white; font-size: 20px;"></i>
                        </div>
                        <div style="flex: 1; min-width: 0;">
                          <div style="font-weight: 600; font-size: 15px; color: var(--ig-primary-text); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${file.title || 'Untitled Link'}</div>
                          <div style="font-size: 13px; color: var(--ig-blue); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin-top: 2px;">${file.url}</div>
                          <div style="font-size: 12px; color: var(--ig-secondary-text); margin-top: 4px;">From: ${file.announcementTitle}</div>
                        </div>
                        <i class="fas fa-chevron-right" style="color: var(--ig-secondary-text);"></i>
                      </a>
                    `;
                  }
                  
                  // Normalize URL
                  let fileUrl = file.url;
                  if (!fileUrl.startsWith('http')) {
                    fileUrl = window.location.origin + (fileUrl.startsWith('/') ? fileUrl : '/' + fileUrl);
                  } else {
                    try {
                      const urlObj = new URL(fileUrl);
                      urlObj.protocol = window.location.protocol;
                      urlObj.host = window.location.host;
                      fileUrl = urlObj.toString();
                    } catch (e) {
                      const pathMatch = fileUrl.match(/\/uploads\/.+$/);
                      if (pathMatch) {
                        fileUrl = window.location.origin + pathMatch[0];
                      }
                    }
                  }
                  
                  const extension = file.name.split('.').pop().toLowerCase();
                  const isImage = type === 'images';
                  const isVideo = type === 'videos';
                  
                  return `
                    <div style="background: var(--ig-secondary-background); border: 1px solid var(--ig-border); border-radius: 12px; overflow: hidden; transition: all 0.2s;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 16px rgba(0,0,0,0.2)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                      ${isImage ? `
                        <div onclick="window.open('${fileUrl}', '_blank')" style="width: 100%; aspect-ratio: 16/9; background: #000; overflow: hidden; cursor: pointer; position: relative;">
                          <img src="${fileUrl}" alt="${file.name}" style="width: 100%; height: 100%; object-fit: cover; display: block;" loading="lazy" onerror="this.parentElement.innerHTML='<div style=\\'display:flex;align-items:center;justify-content:center;height:100%;color:#888;\\'><i class=\\'fas fa-image\\' style=\\'font-size:48px;\\'></i></div>'">
                        </div>
                      ` : isVideo ? `
                        <div style="width: 100%; aspect-ratio: 16/9; background: #000; overflow: hidden;">
                          <video controls style="width: 100%; height: 100%; object-fit: contain; display: block;">
                            <source src="${fileUrl}" type="${file.type}">
                          </video>
                        </div>
                      ` : `
                        <div onclick="window.open('${fileUrl}', '_blank')" style="width: 100%; aspect-ratio: 16/9; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); display: flex; align-items: center; justify-content: center; cursor: pointer; flex-direction: column; gap: 12px;">
                          <i class="fas fa-file-pdf" style="font-size: 72px; color: rgba(255,255,255,0.95);"></i>
                          <span style="color: rgba(255,255,255,0.9); font-size: 14px; font-weight: 600;">Click to view</span>
                        </div>
                      `}
                      
                      <div style="padding: 12px;">
                        <div style="font-weight: 600; font-size: 14px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: var(--ig-primary-text); margin-bottom: 4px;" title="${file.name}">${file.name}</div>
                        <div style="font-size: 12px; color: var(--ig-secondary-text); margin-bottom: 8px;">${file.size || 'Unknown size'}</div>
                        <div style="font-size: 11px; color: var(--ig-secondary-text); border-top: 1px solid var(--ig-border); padding-top: 8px;">
                          From: ${file.announcementTitle}
                        </div>
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
            `}
          </div>
        `;
        
      } catch (error) {
        console.error('Error loading files:', error);
      }
    }

    function renderGitHubView() {
      const content = document.getElementById('leftContent');
      const centerContent = document.getElementById('centerContent');

      // Check if GitHub integration exists for this community
      content.innerHTML = `
        <div class="empty-state">
          <div class="empty-icon">
            <i class="fab fa-github" style="font-size: 48px;"></i>
          </div>
          <div class="empty-title">GitHub Integration</div>
          <div class="empty-text">Connect your GitHub repositories to this community</div>
        </div>
      `;

      centerContent.innerHTML = `
        <div style="padding: 24px; max-width: 900px; margin: 0 auto;">
          <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid var(--ig-border);">
            <div style="width: 56px; height: 56px; border-radius: 12px; background: linear-gradient(135deg, #24292e 0%, #586069 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 24px;">
              <i class="fab fa-github"></i>
            </div>
            <div style="flex: 1;">
              <h2 style="margin: 0; font-size: 22px;">GitHub Integration</h2>
              <div style="color: var(--ig-secondary-text); font-size: 14px; margin-top: 4px;">
                Sync repositories, issues, and pull requests
              </div>
            </div>
          </div>

          <div style="background: var(--ig-secondary-background); border: 1px solid var(--ig-border); border-radius: 12px; padding: 24px; margin-bottom: 20px;">
            <h3 style="margin: 0 0 16px 0; font-size: 16px;">
              <i class="fas fa-link"></i> Connect GitHub Repository
            </h3>
            <p style="margin: 0 0 20px 0; color: var(--ig-secondary-text); font-size: 14px; line-height: 1.6;">
              Link a GitHub repository to this community to automatically sync issues, pull requests, and commits. 
              Members can view repository activity directly in the community workspace.
            </p>
            
            <div style="display: grid; gap: 12px;">
              <input type="text" placeholder="Organization name (e.g., facebook)" style="width: 100%; padding: 12px; border: 1px solid var(--ig-border); border-radius: 8px; background: var(--ig-primary-background); color: var(--ig-primary-text);">
              <input type="text" placeholder="Repository name (e.g., react)" style="width: 100%; padding: 12px; border: 1px solid var(--ig-border); border-radius: 8px; background: var(--ig-primary-background); color: var(--ig-primary-text);">
              <input type="password" placeholder="GitHub Access Token (optional)" style="width: 100%; padding: 12px; border: 1px solid var(--ig-border); border-radius: 8px; background: var(--ig-primary-background); color: var(--ig-primary-text);">
              
              <button class="btn btn-primary" style="margin-top: 8px;">
                <i class="fab fa-github"></i> Connect Repository
              </button>
            </div>
          </div>

          <div style="background: var(--ig-secondary-background); border: 1px solid var(--ig-border); border-radius: 12px; padding: 24px;">
            <h3 style="margin: 0 0 12px 0; font-size: 16px;">
              <i class="fas fa-info-circle"></i> Features
            </h3>
            <ul style="margin: 0; padding-left: 20px; color: var(--ig-secondary-text); font-size: 14px; line-height: 1.8;">
              <li>View repository issues and pull requests</li>
              <li>Track commits and branch activity</li>
              <li>Create issues directly from community</li>
              <li>Link tasks to GitHub issues</li>
              <li>Receive notifications for repository updates</li>
              <li>Collaborate on code reviews</li>
            </ul>
          </div>
        </div>
      `;
    }

    function renderAnnouncements(announcements) {
      const content = document.getElementById('leftContent');
      const centerContent = document.getElementById('centerContent');
      const footer = document.getElementById('centerFooter');
      
      // Show create announcement button for admins/moderators
      footer.innerHTML = `
        <button class="btn btn-primary" style="width: 100%;" onclick="showCreateAnnouncementModal()">
          <i class="fas fa-bullhorn"></i> Create Announcement
        </button>
      `;
      footer.style.display = 'block';
      
      if (announcements.length === 0) {
        content.innerHTML = `
          <div class="empty-state" style="padding: 60px 20px; text-align: center;">
            <div style="width: 80px; height: 80px; margin: 0 auto 20px; border-radius: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 36px;">
              <i class="fas fa-bullhorn"></i>
            </div>
            <div style="font-size: 18px; font-weight: 700; margin-bottom: 8px; color: var(--ig-primary-text);">No announcements</div>
            <div style="font-size: 14px; color: var(--ig-secondary-text);">Admins can post important updates here</div>
          </div>
        `;
        centerContent.innerHTML = `
          <div class="empty-state" style="height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 40px;">
            <div style="width: 96px; height: 96px; margin-bottom: 24px; border-radius: 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 48px;">
              <i class="fas fa-bullhorn"></i>
            </div>
            <div style="font-size: 24px; font-weight: 700; margin-bottom: 12px; color: var(--ig-primary-text);">Welcome to Announcements</div>
            <div style="font-size: 15px; color: var(--ig-secondary-text); max-width: 500px; line-height: 1.6;">Create your first announcement with messages, attachments, links, and location</div>
          </div>
        `;
        return;
      }

      content.innerHTML = announcements.map(ann => `
        <div class="group-item ${state.currentAnnouncementId == ann.id ? 'active' : ''}" onclick="viewAnnouncement(${ann.id})">
          <div class="group-avatar"><i class="fas fa-bullhorn"></i></div>
          <div class="group-info">
            <div class="group-name">${ann.title || 'Announcement'}</div>
            <div class="group-desc">${InnovateAPI.formatDate(ann.created_at)} 路 ${ann.author_username}</div>
          </div>
          ${ann.is_pinned ? '<i class="fas fa-thumbtack" style="color: var(--ig-blue);"></i>' : ''}
        </div>
      `).join('');
      
      // Show first announcement by default
      if (announcements.length > 0 && !state.currentAnnouncementId) {
        viewAnnouncement(announcements[0].id);
      }
    }
    
    function viewAnnouncement(announcementId) {
      state.currentAnnouncementId = announcementId;
      const centerContent = document.getElementById('centerContent');
      
      // Find announcement
      InnovateAPI.apiRequest(`/communities/${state.communityId}/announcements`)
        .then(res => {
          const ann = res.announcements.find(a => a.id == announcementId);
          if (!ann) return;
          
          // Parse attachments
          let attachments = [];
          let links = [];
          let location = null;
          let poll = null;
          
          try {
            if (ann.attachments) {
              const parsed = JSON.parse(ann.attachments);
              attachments = parsed.files || [];
              links = parsed.links || [];
              location = parsed.location || null;
              poll = parsed.poll || null;
            }
          } catch (e) {}
          
          centerContent.innerHTML = `
            <div style="padding: 24px; max-width: 800px; margin: 0 auto;">
              <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid var(--ig-border);">
                <div style="width: 56px; height: 56px; border-radius: 14px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 24px;">
                  <i class="fas fa-bullhorn"></i>
                </div>
                <div style="flex: 1;">
                  <h2 style="margin: 0; font-size: 22px; font-weight: 700;">${ann.title}</h2>
                  <div style="color: var(--ig-secondary-text); font-size: 14px; margin-top: 6px; display: flex; align-items: center; gap: 8px;">
                    <span><i class="fas fa-user"></i> ${ann.author_username}</span>
                    <span></span>
                    <span><i class="far fa-clock"></i> ${InnovateAPI.formatDate(ann.created_at)}</span>
                    ${ann.is_pinned ? '<span></span><span style="color: var(--ig-blue);"><i class="fas fa-thumbtack"></i> Pinned</span>' : ''}
                  </div>
                </div>
                <div style="display: flex; gap: 8px;">
                  <button onclick="pinAnnouncement(${ann.id}, ${!ann.is_pinned})" style="padding: 10px 16px; background: ${ann.is_pinned ? 'var(--ig-secondary-background)' : 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'}; color: ${ann.is_pinned ? 'var(--ig-primary-text)' : 'white'}; border: ${ann.is_pinned ? '2px solid var(--ig-border)' : 'none'}; border-radius: 10px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                    <i class="fas fa-thumbtack"></i> ${ann.is_pinned ? 'Unpin' : 'Pin'}
                  </button>
                  <button onclick="deleteAnnouncement(${ann.id})" style="padding: 10px 16px; background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s; box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(220, 53, 69, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(220, 53, 69, 0.3)'">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </div>
              
              <div style="background: var(--ig-secondary-background); border: 2px solid var(--ig-border); border-radius: 12px; padding: 24px; margin-bottom: 20px;">
                <p style="white-space: pre-wrap; line-height: 1.8; margin: 0; font-size: 15px;">${ann.body || ann.content || 'No content'}</p>
              </div>
              
              ${attachments.length > 0 ? `
                <div style="margin-bottom: 20px;">
                  <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 12px; color: var(--ig-secondary-text);">
                    <i class="fas fa-paperclip"></i> Attachments (${attachments.length})
                  </h3>
                  <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px;">
                    ${attachments.map(file => {
                      // Extract file extension from name
                      const extension = file.name.split('.').pop().toLowerCase();
                      const mimeType = file.type || '';
                      
                      // Normalize URL - handle both full URLs and relative paths
                      let fileUrl = file.url;
                      if (!fileUrl.startsWith('http')) {
                        // Relative path - prepend origin
                        fileUrl = window.location.origin + (fileUrl.startsWith('/') ? fileUrl : '/' + fileUrl);
                      } else {
                        // Full URL - ensure it uses the correct protocol and host
                        try {
                          const urlObj = new URL(fileUrl);
                          // Replace the URL's origin with current origin to avoid protocol/host mismatches
                          urlObj.protocol = window.location.protocol;
                          urlObj.host = window.location.host;
                          fileUrl = urlObj.toString();
                        } catch (e) {
                          // If URL parsing fails, try to extract just the path
                          const pathMatch = fileUrl.match(/\/uploads\/.+$/);
                          if (pathMatch) {
                            fileUrl = window.location.origin + pathMatch[0];
                          }
                        }
                      }
                      
                      // Determine file type
                      const isImage = mimeType.startsWith('image/') || ['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg', 'bmp'].includes(extension);
                      const isVideo = mimeType.startsWith('video/') || ['mp4', 'mov', 'webm', 'avi', 'mkv', 'm4v'].includes(extension);
                      const isPDF = mimeType === 'application/pdf' || extension === 'pdf';
                      const isDoc = ['doc', 'docx', 'txt', 'xls', 'xlsx', 'ppt', 'pptx', 'odt', 'ods', 'odp'].includes(extension) || 
                                    mimeType.includes('document') || mimeType.includes('spreadsheet') || mimeType.includes('presentation');
                      
                      return `
                        <div style="background: var(--ig-secondary-background); border-radius: 12px; overflow: hidden; border: 1px solid var(--ig-border); transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                          ${isImage ? `
                            <div style="width: 100%; aspect-ratio: 16/9; background: #000; overflow: hidden; cursor: pointer; position: relative;" onclick="window.open('${fileUrl}', '_blank')">
                              <img src="${fileUrl}" alt="${file.name}" style="width: 100%; height: 100%; object-fit: contain; display: block;" loading="lazy" onerror="this.onerror=null; this.parentElement.innerHTML='<div style=\\'display:flex;align-items:center;justify-content:center;height:100%;color:#888;\\'><i class=\\'fas fa-image\\' style=\\'font-size:48px;\\'></i></div>'">
                            </div>
                          ` : isVideo ? `
                            <div style="width: 100%; aspect-ratio: 16/9; background: #000; overflow: hidden;">
                              <video controls style="width: 100%; height: 100%; object-fit: contain; display: block;" preload="metadata">
                                <source src="${fileUrl}#t=0.1" type="${mimeType || 'video/mp4'}">
                                Your browser does not support video playback.
                              </video>
                            </div>
                          ` : isPDF ? `
                            <div style="width: 100%; aspect-ratio: 16/9; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; cursor: pointer; flex-direction: column; gap: 12px;" onclick="window.open('${fileUrl}', '_blank')">
                              <i class="fas fa-file-pdf" style="font-size: 72px; color: rgba(255,255,255,0.95);"></i>
                              <span style="color: rgba(255,255,255,0.9); font-size: 14px; font-weight: 600;">Click to view PDF</span>
                            </div>
                          ` : isDoc ? `
                            <div style="width: 100%; aspect-ratio: 16/9; background: linear-gradient(135deg, ${extension.includes('xls') || extension.includes('ods') ? '#217346 0%, #4caf50 100%' : extension.includes('ppt') || extension.includes('odp') ? '#d24726 0%, #ff6b35 100%' : '#2b579a 0%, #4285f4 100%'}); display: flex; align-items: center; justify-content: center; cursor: pointer; flex-direction: column; gap: 12px;" onclick="window.open('${fileUrl}', '_blank')">
                              <i class="fas fa-file-${extension.includes('xls') || extension.includes('ods') ? 'excel' : extension.includes('ppt') || extension.includes('odp') ? 'powerpoint' : extension.includes('txt') ? 'alt' : 'word'}" style="font-size: 72px; color: rgba(255,255,255,0.95);"></i>
                              <span style="color: rgba(255,255,255,0.9); font-size: 14px; font-weight: 600;">Click to open document</span>
                            </div>
                          ` : `
                            <div style="width: 100%; aspect-ratio: 16/9; background: linear-gradient(135deg, #434343 0%, #000000 100%); display: flex; align-items: center; justify-content: center; cursor: pointer; flex-direction: column; gap: 12px;" onclick="window.open('${fileUrl}', '_blank')">
                              <i class="fas fa-file" style="font-size: 72px; color: rgba(255,255,255,0.95);"></i>
                              <span style="color: rgba(255,255,255,0.9); font-size: 14px; font-weight: 600;">Click to download</span>
                            </div>
                          `}
                          
                          <div style="padding: 12px;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                              <i class="fas fa-${isImage ? 'image' : isVideo ? 'video' : isPDF ? 'file-pdf' : isDoc ? 'file-alt' : 'file'}" style="color: var(--ig-blue); font-size: 16px;"></i>
                              <div style="flex: 1; min-width: 0;">
                                <div style="font-size: 14px; font-weight: 600; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: var(--ig-primary-text);">${file.name}</div>
                                <div style="font-size: 12px; color: var(--ig-secondary-text);">${file.size || 'Unknown size'}</div>
                              </div>
                            </div>
                            
                            <div style="display: flex; gap: 8px;">
                              ${isImage || isVideo ? `
                                <button onclick="event.stopPropagation(); window.open('${fileUrl}', '_blank')" style="flex: 1; padding: 8px 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; transition: opacity 0.2s;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
                                  <i class="fas fa-expand"></i> View
                                </button>
                              ` : ''}
                              <a href="${fileUrl}" download="${file.name}" style="flex: 1; padding: 8px 12px; background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; text-decoration: none; transition: opacity 0.2s;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
                                <i class="fas fa-download"></i> Save
                              </a>
                            </div>
                          </div>
                        </div>
                      `;
                    }).join('')}
                  </div>
                </div>
              ` : ''}
              
              ${links.length > 0 ? `
                <div style="margin-bottom: 20px;">
                  <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 12px; color: var(--ig-secondary-text);">
                    <i class="fas fa-link"></i> Links (${links.length})
                  </h3>
                  <div style="display: flex; flex-direction: column; gap: 8px;">
                    ${links.map(link => `
                      <a href="${link.url}" target="_blank" style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--ig-secondary-background); border-radius: 8px; text-decoration: none; color: var(--ig-blue); border: 1px solid var(--ig-border);">
                        <i class="fas fa-external-link-alt"></i>
                        <span style="flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${link.title || link.url}</span>
                      </a>
                    `).join('')}
                  </div>
                </div>
              ` : ''}
              
              ${location ? `
                <div style="margin-bottom: 20px;">
                  <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 12px; color: var(--ig-secondary-text);">
                    <i class="fas fa-map-marker-alt"></i> Location
                  </h3>
                  <a href="https://www.google.com/maps?q=${location.lat},${location.lng}" target="_blank" style="display: flex; align-items: center; gap: 12px; padding: 16px; background: var(--ig-secondary-background); border-radius: 8px; text-decoration: none; color: inherit; border: 1px solid var(--ig-border);">
                    <i class="fas fa-map-marked-alt" style="font-size: 32px; color: var(--ig-error);"></i>
                    <div>
                      <div style="font-weight: 600;">${location.name || 'Shared Location'}</div>
                      <div style="font-size: 13px; color: var(--ig-secondary-text);">${location.address || `${location.lat.toFixed(6)}, ${location.lng.toFixed(6)}`}</div>
                    </div>
                  </a>
                </div>
              ` : ''}
              
              ${poll ? `
                <div style="margin-bottom: 20px;" id="poll-${ann.id}">
                  <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 12px; color: var(--ig-secondary-text);">
                    <i class="fas fa-poll" style="color: #4facfe;"></i> Poll
                  </h3>
                  ${renderPollResults(ann.id, poll)}
                </div>
              ` : ''}
            </div>
          `;
          
          // Update active state
          renderAnnouncements(res.announcements);
        })
        .catch(err => {
          console.error('Error loading announcement:', err);
        });
    }

    // ==================== TAB SWITCHING ====================
    function switchLeftTab(tab) {
      console.log('switchLeftTab called with tab:', tab);
      
      // Remove active class from all tabs
      document.querySelectorAll('.left-tab').forEach(t => t.classList.remove('active'));
      
      // Add active class to the clicked tab
      // When called programmatically (no event), find the tab by matching the onclick attribute
      const clickedTab = event?.target || document.querySelector(`.left-tab[onclick*="'${tab}'"]`);
      console.log('clickedTab element:', clickedTab);
      
      if (clickedTab) {
        clickedTab.classList.add('active');
        console.log('Tab set to active:', clickedTab);
      } else {
        console.error('Could not find tab element for:', tab);
      }

      const leftFooterBtn = document.getElementById('leftFooterBtn');
      const leftFooter = document.getElementById('leftFooter');
      const centerFooter = document.getElementById('centerFooter');
      const centerTabs = document.getElementById('centerTabs');
      const centerTitle = document.getElementById('centerTitle');
      const centerSubtitle = document.getElementById('centerSubtitle');
      const centerIcon = document.getElementById('centerIcon');

      // Hide center tabs when switching to announcements or folders
      centerTabs.style.display = 'none';

      if (tab === 'announcements') {
        // Update center header
        centerIcon.innerHTML = '<i class="fas fa-bullhorn"></i>';
        centerTitle.textContent = 'Announcements';
        centerSubtitle.textContent = 'Community updates and news';
        
        // Show Create Announcement button in left footer
        leftFooter.style.display = 'block';
        leftFooterBtn.innerHTML = '<i class="fas fa-plus"></i> Create Announcement';
        leftFooterBtn.onclick = showCreateAnnouncementModal;
        
        // Load announcements (will also set centerFooter)
        loadAnnouncements();
      } else if (tab === 'groups') {
        // Groups tab
        centerIcon.innerHTML = '<i class="fas fa-users"></i>';
        centerTitle.textContent = 'Select a group';
        centerSubtitle.textContent = 'Choose from the left sidebar';
        
        // Show Create Group button in left footer
        leftFooter.style.display = 'block';
        leftFooterBtn.innerHTML = '<i class="fas fa-plus"></i> Create Group';
        leftFooterBtn.onclick = showCreateGroupModal;
        
        // Show Create Group button in center footer
        centerFooter.innerHTML = `
          <button class="btn btn-primary" style="width: 100%;" onclick="showCreateGroupModal()">
            <i class="fas fa-plus"></i> Create Group
          </button>
        `;
        centerFooter.style.display = 'block';
        
        // Load groups
        renderGroupsList();
      } else if (tab === 'folders') {
        // Update center header
        centerIcon.innerHTML = '<i class="fas fa-folder"></i>';
        centerTitle.textContent = 'Folders';
        centerSubtitle.textContent = 'Organized by groups';
        
        // Show Create Group button in left footer (folders are created with groups)
        leftFooter.style.display = 'block';
        leftFooterBtn.innerHTML = '<i class="fas fa-plus"></i> Create Group';
        leftFooterBtn.onclick = showCreateGroupModal;
        
        // Show Create Group button in center footer too
        centerFooter.innerHTML = `
          <button class="btn btn-primary" style="width: 100%;" onclick="showCreateGroupModal()">
            <i class="fas fa-plus"></i> Create Group
          </button>
        `;
        centerFooter.style.display = 'block';
        
        // Load folders
        renderFoldersList();
      } else if (tab === 'github') {
        // GitHub Integration tab
        centerIcon.innerHTML = '<i class="fab fa-github"></i>';
        centerTitle.textContent = 'GitHub Integration';
        centerSubtitle.textContent = 'Connect your repositories';
        
        // Hide both footers (GitHub has its own connect button in content)
        leftFooter.style.display = 'none';
        centerFooter.style.display = 'none';
        centerFooter.innerHTML = '';
        
        // Load GitHub view
        renderGitHubView();
      }
    }

    function switchCenterTab(view) {
      state.currentView = view;
      document.querySelectorAll('.center-tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');
      loadGroupView(state.currentGroupId);
    }

    // ==================== GROUP SELECTION ====================
    async function selectGroup(groupId) {
      console.log('selectGroup called with groupId:', groupId);
      state.currentGroupId = groupId;
      const group = state.groups.find(g => g.id == groupId);
      console.log('Found group:', group);
      if (!group) return;
      
      // Update URL to include groupId so it persists on refresh
      const url = new URL(window.location);
      url.searchParams.set('groupId', groupId);
      window.history.pushState({}, '', url);

      // Auto-join group if not already a member
      try {
        await InnovateAPI.apiRequest(`/community-groups/${groupId}/join`, {
          method: 'POST'
        });
        console.log('Joined group successfully');
      } catch (error) {
        console.log('Already a member or error joining:', error.message);
      }

      // Update header
      document.getElementById('centerTitle').textContent = group.name;
      document.getElementById('centerSubtitle').textContent = group.description || 'Group workspace';
      
      // Show tabs
      document.getElementById('centerTabs').style.display = 'flex';
      document.getElementById('centerTabs').innerHTML = `
        <button class="center-tab active" onclick="switchCenterTab('chat')">
          <i class="fas fa-comments"></i> Chat
        </button>
        <button class="center-tab" onclick="switchCenterTab('calls')">
          <i class="fas fa-video"></i> Calls
        </button>
        <button class="center-tab" onclick="switchCenterTab('folders')">
          <i class="fas fa-folder"></i> Folders
        </button>
        <button class="center-tab" onclick="switchCenterTab('tasks')">
          <i class="fas fa-tasks"></i> To-Do
        </button>
        <button class="center-tab" onclick="switchCenterTab('notes')">
          <i class="fas fa-file-alt"></i> Notes
        </button>
      `;

      // Show action button
      document.getElementById('centerActions').innerHTML = `
        <button class="btn btn-primary" onclick="showGroupActions()">
          <i class="fas fa-ellipsis-v"></i>
        </button>
      `;

      state.currentView = 'chat';
      console.log('About to call loadGroupView with groupId:', groupId);
      await loadGroupView(groupId);
      console.log('loadGroupView completed');
      renderGroupsList(); // Update active state
    }

    // ==================== VIEW LOADING ====================
    async function loadGroupView(groupId) {
      console.log('loadGroupView called, currentView:', state.currentView);
      const content = document.getElementById('centerContent');
      const footer = document.getElementById('centerFooter');

      switch (state.currentView) {
        case 'chat':
          await loadChatView(groupId);
          break;
        case 'calls':
          loadCallsView(groupId);
          break;
        case 'folders':
          await loadFoldersView(groupId);
          break;
        case 'tasks':
          await loadTasksView(groupId);
          break;
        case 'notes':
          await loadNotesView(groupId);
          break;
      }
    }

    // ==================== CHAT VIEW ====================
    async function loadChatView(groupId) {
      console.log('loadChatView called with groupId:', groupId);
      const content = document.getElementById('centerContent');
      const footer = document.getElementById('centerFooter');

      content.innerHTML = '<div class="loading"><div class="spinner"></div>Loading messages...</div>';
      footer.style.display = 'flex';
      footer.innerHTML = `
        <input type="file" id="fileInput" multiple style="display: none;" onchange="handleFileSelect(event)" accept="image/*,video/*,.pdf,.doc,.docx,.txt,.xls,.xlsx">
        <button class="ws-icon-btn" onclick="document.getElementById('fileInput').click()">
          <i class="fas fa-paperclip"></i>
        </button>
        <input type="text" class="form-input" id="chatInput" placeholder="Type a message..." style="flex: 1; margin: 0 12px;" onkeypress="if(event.key==='Enter')sendMessage()">
        <button class="btn btn-primary" onclick="sendMessage()">
          <i class="fas fa-paper-plane"></i>
        </button>
      `;

      // Load messages
      try {
        console.log('Fetching posts from:', `/community-groups/${groupId}/posts`);
        const res = await InnovateAPI.apiRequest(`/community-groups/${groupId}/posts`);
        console.log('Posts response:', res);
        console.log('Posts array:', res.posts);
        console.log('Posts length:', res.posts?.length);
        if (res.success && res.posts && res.posts.length > 0) {
          console.log('Rendering', res.posts.length, 'messages');
          
          // Sort messages by created_at (oldest first)
          const sortedPosts = res.posts.sort((a, b) => {
            return new Date(a.created_at) - new Date(b.created_at);
          });
          console.log('Messages sorted oldest first');
          
          // Render messages with error handling
          const messagesHTML = sortedPosts.map((msg, index) => {
            try {
              const html = renderMessage(msg);
              console.log(`Message ${index} rendered:`, html.substring(0, 50));
              return html;
            } catch (err) {
              console.error(`Error rendering message ${index}:`, err, msg);
              return `<div style="color: red;">Error rendering message</div>`;
            }
          }).join('');
          
          console.log('Messages HTML length:', messagesHTML.length);
          
          content.innerHTML = `
            <div id="messagesList" style="padding: 20px; overflow-y: auto; height: 100%; display: flex; flex-direction: column; gap: 12px;">
              ${messagesHTML}
            </div>
          `;
          
          console.log('Messages HTML set, checking element');
          const checkList = document.getElementById('messagesList');
          console.log('messagesList after setting:', checkList, 'children:', checkList?.children.length);
          
          // Scroll to bottom
          setTimeout(() => {
            const list = document.getElementById('messagesList');
            if (list) list.scrollTop = list.scrollHeight;
          }, 100);
        } else {
          content.innerHTML = `
            <div id="messagesList" style="padding: 20px; overflow-y: auto; height: 100%; display: flex; flex-direction: column; gap: 12px;">
              <div class="empty-state" style="flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;">
                <div style="width: 80px; height: 80px; margin-bottom: 20px; border-radius: 20px; background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 36px;">
                  <i class="fas fa-comments"></i>
                </div>
                <div style="font-size: 20px; font-weight: 700; margin-bottom: 8px; color: var(--ig-primary-text);">No messages yet</div>
                <div style="font-size: 14px; color: var(--ig-secondary-text);">Start the conversation!</div>
              </div>
            </div>
          `;
        }
      } catch (error) {
        console.error('Error loading messages:', error);
        content.innerHTML = `
          <div id="messagesList" style="padding: 20px; overflow-y: auto; height: 100%; display: flex; flex-direction: column; gap: 12px;">
            <div class="empty-state" style="flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center;">
              <div style="color: var(--ig-error);">Failed to load messages</div>
            </div>
          </div>
        `;
      }

      // Join room
      if (state.socket) {
        state.socket.emit('group:join', groupId);
      }
    }

    async function sendMessage() {
      const input = document.getElementById('chatInput');
      const fileInput = document.getElementById('fileInput');
      const message = input.value.trim();
      console.log('=== sendMessage called ===');
      console.log('Message text:', message);
      console.log('GroupId:', state.currentGroupId);
      console.log('Files:', fileInput?.files?.length || 0);
      
      if ((!message && (!fileInput || !fileInput.files || fileInput.files.length === 0)) || !state.currentGroupId) {
        console.log('Aborting: no message/files or no groupId');
        return;
      }

      try {
        console.log('Sending POST to:', `/community-groups/${state.currentGroupId}/posts`);
        
        const formData = new FormData();
        if (message) {
          formData.append('content', message);
          console.log('Added content to FormData:', message);
        }
        
        // Add files if any
        if (fileInput && fileInput.files && fileInput.files.length > 0) {
          for (let i = 0; i < fileInput.files.length; i++) {
            formData.append('attachments', fileInput.files[i]);
            console.log(`Added file ${i + 1}:`, fileInput.files[i].name);
          }
          console.log('Total files added:', fileInput.files.length);
        }
        
        const res = await fetch(`/api/community-groups/${state.currentGroupId}/posts`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${InnovateAPI.getToken()}`
          },
          body: formData
        });
        
        const data = await res.json();
        console.log('=== Send message response ===');
        console.log('Success:', data.success);
        console.log('Post data:', data.post);
        console.log('Post content:', data.post?.content);
        console.log('Post created_at:', data.post?.created_at);
        
        if (data.success) {
          input.value = '';
          if (fileInput) {
            fileInput.value = '';
            input.placeholder = 'Type a message...';
          }
          console.log('Message sent successfully, reloading groups...');
          
          // Message will appear via socket event
          // Reload groups to update latest message
          loadGroups();
        }
      } catch (error) {
        console.error('Error sending message:', error);
        InnovateAPI.showAlert('Failed to send message', 'error');
      }
    }

    // ==================== CALLS VIEW ====================
    function loadCallsView(groupId) {
      const content = document.getElementById('centerContent');
      const footer = document.getElementById('centerFooter');
      footer.style.display = 'none';

      content.innerHTML = `
        <div class="empty-state" style="height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 40px;">
          <div style="width: 96px; height: 96px; margin-bottom: 24px; border-radius: 24px; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 48px;">
            <i class="fas fa-phone-alt"></i>
          </div>
          <div style="font-size: 24px; font-weight: 700; margin-bottom: 8px; color: var(--ig-primary-text);">Start a call</div>
          <div style="font-size: 14px; color: var(--ig-secondary-text); margin-bottom: 32px;">Voice, video, or screen sharing</div>
          <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
            <button onclick="startVoiceCall()" style="padding: 14px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.3)'">
              <i class="fas fa-phone"></i> Voice Call
            </button>
            <button onclick="startVideoCall()" style="padding: 14px 24px; background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s; box-shadow: 0 4px 12px rgba(17, 153, 142, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(17, 153, 142, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(17, 153, 142, 0.3)'">
              <i class="fas fa-video"></i> Video Call
            </button>
            <button onclick="startScreenShare()" style="padding: 14px 24px; background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s; box-shadow: 0 4px 12px rgba(250, 112, 154, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(250, 112, 154, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(250, 112, 154, 0.3)'">
              <i class="fas fa-desktop"></i> Screen Share
            </button>
          </div>
        </div>
      `;
    }

    async function startVoiceCall() {
      try {
        state.localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
        renderCallInterface(false);
        // Implement WebRTC signaling
      } catch (error) {
        console.error('Error starting voice call:', error);
      }
    }

    async function startVideoCall() {
      try {
        state.localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: true });
        renderCallInterface(true);
        // Implement WebRTC signaling
      } catch (error) {
        console.error('Error starting video call:', error);
      }
    }

    async function startScreenShare() {
      try {
        state.localStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
        renderCallInterface(true);
        // Implement WebRTC signaling
      } catch (error) {
        console.error('Error starting screen share:', error);
      }
    }

    function renderCallInterface(hasVideo) {
      const content = document.getElementById('centerContent');
      content.innerHTML = `
        <div class="call-view">
          <div class="video-grid" id="videoGrid">
            <div class="video-tile">
              <video id="localVideo" autoplay muted ${hasVideo ? '' : 'style="display:none"'}></video>
              <div class="video-name">You</div>
            </div>
          </div>
          <div class="call-controls">
            <button class="call-btn mute" onclick="toggleMute()">
              <i class="fas fa-microphone"></i>
            </button>
            <button class="call-btn video" onclick="toggleVideo()" ${hasVideo ? '' : 'style="display:none"'}>
              <i class="fas fa-video"></i>
            </button>
            <button class="call-btn screen" onclick="toggleScreenShare()">
              <i class="fas fa-desktop"></i>
            </button>
            <button class="call-btn end" onclick="endCall()">
              <i class="fas fa-phone-slash"></i>
            </button>
          </div>
        </div>
      `;

      if (hasVideo) {
        document.getElementById('localVideo').srcObject = state.localStream;
      }
    }

    function toggleMute() {
      if (state.localStream) {
        const audioTrack = state.localStream.getAudioTracks()[0];
        audioTrack.enabled = !audioTrack.enabled;
        event.target.innerHTML = audioTrack.enabled ? '<i class="fas fa-microphone"></i>' : '<i class="fas fa-microphone-slash"></i>';
      }
    }

    function toggleVideo() {
      if (state.localStream) {
        const videoTrack = state.localStream.getVideoTracks()[0];
        videoTrack.enabled = !videoTrack.enabled;
        event.target.innerHTML = videoTrack.enabled ? '<i class="fas fa-video"></i>' : '<i class="fas fa-video-slash"></i>';
      }
    }

    function endCall() {
      if (state.localStream) {
        state.localStream.getTracks().forEach(track => track.stop());
        state.localStream = null;
      }
      loadCallsView(state.currentGroupId);
    }

    // ==================== FOLDERS VIEW ====================
    async function loadFoldersView(groupId) {
      const content = document.getElementById('centerContent');
      const footer = document.getElementById('centerFooter');
      footer.style.display = 'none';

      content.innerHTML = `
        <div class="folder-grid">
          <div class="folder-item" onclick="openFolder('images')">
            <div class="folder-icon">硷</div>
            <div class="folder-name">Images</div>
            <div class="folder-count">0 files</div>
          </div>
          <div class="folder-item" onclick="openFolder('videos')">
            <div class="folder-icon"></div>
            <div class="folder-name">Videos</div>
            <div class="folder-count">0 files</div>
          </div>
          <div class="folder-item" onclick="openFolder('documents')">
            <div class="folder-icon"></div>
            <div class="folder-name">Documents</div>
            <div class="folder-count">0 files</div>
          </div>
          <div class="folder-item" onclick="openFolder('links')">
            <div class="folder-icon"></div>
            <div class="folder-name">Links</div>
            <div class="folder-count">0 saved</div>
          </div>
          <div class="folder-item" onclick="openGitHubRepos()">
            <div class="folder-icon"></div>
            <div class="folder-name">GitHub</div>
            <div class="folder-count">Repositories</div>
          </div>
        </div>
        <div style="margin-top: 24px;">
          <div class="file-upload" onclick="uploadFile()">
            <i class="fas fa-cloud-upload-alt" style="font-size: 48px; color: var(--ig-blue); margin-bottom: 16px;"></i>
            <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">Upload Files</div>
            <div style="font-size: 14px; color: var(--ig-secondary-text);">Click to browse or drag and drop</div>
          </div>
        </div>
      `;

      // Load file counts (implement API call)
    }

    function openFolder(type) {
      console.log(`Opening ${type} folder...`);
      // Implement folder view
    }

    function uploadFile() {
      const input = document.createElement('input');
      input.type = 'file';
      input.multiple = true;
      input.onchange = async (e) => {
        const files = Array.from(e.target.files);
        console.log(`Uploading ${files.length} file(s)...`);
        // Implement file upload
      };
      input.click();
    }

    // ==================== TASKS VIEW ====================
    async function loadTasksView(groupId) {
      const content = document.getElementById('centerContent');
      const footer = document.getElementById('centerFooter');
      footer.style.display = 'none';

      try {
        const res = await InnovateAPI.apiRequest(`/community-groups/${groupId}/tasks`);
        const tasks = res.tasks || [];

        content.innerHTML = `
          <div style="margin-bottom: 16px; display: flex; gap: 12px;">
            <button class="btn btn-primary" onclick="createTaskFromText()">
              <i class="fas fa-plus"></i> Add Task
            </button>
            <button class="btn btn-secondary" onclick="createTaskFromImage()">
              <i class="fas fa-image"></i> From Image
            </button>
            <button class="btn btn-secondary" onclick="createTaskFromVoice()">
              <i class="fas fa-microphone"></i> From Voice
            </button>
          </div>
          <div id="tasksList">
            ${tasks.length === 0 ? `
              <div class="empty-state">
                <div class="empty-icon"></div>
                <div class="empty-title">No tasks yet</div>
                <div class="empty-text">Create tasks using text, image, or voice</div>
              </div>
            ` : tasks.map(task => `
              <div class="task-card" onclick="editTask(${task.id})">
                <div class="task-header">
                  <div class="task-title">${task.title}</div>
                  <span class="task-priority priority-${task.priority || 'medium'}">${task.priority || 'medium'}</span>
                </div>
                <div class="task-desc">${task.description || 'No description'}</div>
                <div class="task-meta">
                  <span><i class="fas fa-calendar"></i> ${task.due_date ? new Date(task.due_date).toLocaleDateString() : 'No due date'}</span>
                  <span><i class="fas fa-chart-line"></i> ${task.progress || 0}%</span>
                </div>
              </div>
            `).join('')}
          </div>
        `;
      } catch (error) {
        console.error('Error loading tasks:', error);
      }
    }

    async function createTaskFromText() {
      const title = prompt('Task title:');
      if (!title) return;
      const description = prompt('Description (optional):');

      try {
        await InnovateAPI.apiRequest(`/community-groups/${state.currentGroupId}/tasks/from-text`, {
          method: 'POST',
          body: JSON.stringify({ description: `${title}\n${description || ''}` })
        });
        console.log('Task created successfully');
        loadTasksView(state.currentGroupId);
      } catch (error) {
        console.error('Error creating task:', error);
      }
    }

    function createTaskFromImage() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append('image', file);

        try {
          const res = await fetch(`/community-groups/${state.currentGroupId}/tasks/from-image`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${InnovateAPI.getToken()}` },
            body: formData
          });
          const data = await res.json();
          console.log('Tasks extracted from image successfully');
          loadTasksView(state.currentGroupId);
        } catch (error) {
          console.error('Error:', error);
        }
      };
      input.click();
    }

    function createTaskFromVoice() {
      console.log('Voice-to-task feature coming soon!');
      // Implement voice recording and transcription
    }

    // ==================== NOTES VIEW ====================
    async function loadNotesView(groupId) {
      const content = document.getElementById('centerContent');
      const footer = document.getElementById('centerFooter');
      footer.style.display = 'none';

      try {
        const res = await InnovateAPI.apiRequest(`/community-groups/${groupId}/notes`);
        const notes = res.notes || [];

        content.innerHTML = `
          <div style="margin-bottom: 16px;">
            <button class="btn btn-primary" onclick="createNote()">
              <i class="fas fa-plus"></i> New Note
            </button>
          </div>
          ${notes.length === 0 ? `
            <div class="empty-state">
              <div class="empty-icon"></div>
              <div class="empty-title">No notes yet</div>
              <div class="empty-text">Create shared notes for your group</div>
            </div>
          ` : `
            <div style="display: flex; flex-direction: column; gap: 12px;">
              ${notes.map(note => `
                <div class="announcement-card" onclick="openNote(${note.id})">
                  <div class="card-header">
                    <div class="card-info">
                      <div class="card-author">${note.title}</div>
                      <div class="card-date">Updated ${InnovateAPI.formatDate(note.updated_at)} by ${note.updated_by_username || note.created_by_username}</div>
                    </div>
                  </div>
                </div>
              `).join('')}
            </div>
          `}
        `;
      } catch (error) {
        console.error('Error loading notes:', error);
      }
    }

    async function createNote() {
      const title = prompt('Note title:');
      if (!title) return;

      try {
        const res = await InnovateAPI.apiRequest(`/community-groups/${state.currentGroupId}/notes`, {
          method: 'POST',
          body: JSON.stringify({ title, content_md: '# Start writing...' })
        });
        console.log('Note created successfully');
        openNote(res.note.id);
      } catch (error) {
        console.error('Error creating note:', error);
      }
    }

    function openNote(noteId) {
      window.open(`/note-editor.html?id=${noteId}`, '_blank');
    }

    // ==================== MODALS ====================
    function showCreateGroupModal() {
      showModal(`
        <div class="modal-header" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; padding: 24px; border-radius: 12px 12px 0 0;">
          <div style="display: flex; align-items: center; gap: 12px;">
            <div style="width: 48px; height: 48px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px;">
              <i class="fas fa-users"></i>
            </div>
            <div>
              <div class="modal-title" style="font-size: 22px; font-weight: 700; margin-bottom: 4px;">Create New Group</div>
              <div style="font-size: 13px; opacity: 0.9;">Organize your community members</div>
            </div>
          </div>
          <button class="modal-close" onclick="closeModal()" style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); color: white; border: none; width: 36px; height: 36px; border-radius: 50%; font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;"></button>
        </div>
        <form onsubmit="createGroup(event)" style="padding: 24px;">
          <!-- Group Name Input -->
          <div style="margin-bottom: 20px;">
            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px; font-weight: 600; font-size: 14px; color: var(--ig-primary-text);">
              <i class="fas fa-tag" style="color: #11998e;"></i>
              <span>Group Name *</span>
            </label>
            <input type="text" id="groupName" placeholder="e.g., CSE A, Development Team, Study Group" required style="width: 100%; padding: 14px 16px; border: 2px solid var(--ig-border); border-radius: 12px; background: var(--ig-secondary-background); color: var(--ig-primary-text); font-size: 15px; transition: all 0.2s; outline: none;" onfocus="this.style.borderColor='#11998e'" onblur="this.style.borderColor='var(--ig-border)'">
          </div>
          
          <!-- Description Textarea -->
          <div style="margin-bottom: 24px;">
            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px; font-weight: 600; font-size: 14px; color: var(--ig-primary-text);">
              <i class="fas fa-align-left" style="color: #11998e;"></i>
              <span>Description</span>
              <span style="font-size: 12px; font-weight: 400; color: var(--ig-secondary-text);">(optional)</span>
            </label>
            <textarea id="groupDescription" rows="4" placeholder="What is this group about? Who should join?" style="width: 100%; padding: 14px 16px; border: 2px solid var(--ig-border); border-radius: 12px; background: var(--ig-secondary-background); color: var(--ig-primary-text); resize: vertical; font-size: 15px; line-height: 1.6; transition: all 0.2s; outline: none; font-family: inherit;" onfocus="this.style.borderColor='#11998e'" onblur="this.style.borderColor='var(--ig-border)'"></textarea>
          </div>
          
          <!-- Action Buttons -->
          <div style="display: flex; gap: 12px; padding-top: 20px; border-top: 1px solid var(--ig-border);">
            <button type="submit" style="flex: 1; padding: 14px 24px; background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; border: none; border-radius: 12px; font-weight: 700; font-size: 15px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; transition: all 0.2s; box-shadow: 0 4px 12px rgba(17, 153, 142, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(17, 153, 142, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(17, 153, 142, 0.3)'">
              <i class="fas fa-check-circle"></i> Create Group
            </button>
            <button type="button" onclick="closeModal()" style="padding: 14px 24px; background: var(--ig-secondary-background); color: var(--ig-primary-text); border: 2px solid var(--ig-border); border-radius: 12px; font-weight: 600; font-size: 15px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#f5576c'; this.style.background='rgba(245, 87, 108, 0.1)'" onmouseout="this.style.borderColor='var(--ig-border)'; this.style.background='var(--ig-secondary-background)'">
              Cancel
            </button>
          </div>
        </form>
      `);
    }

    async function createGroup(e) {
      e.preventDefault();
      const name = document.getElementById('groupName').value;
      const description = document.getElementById('groupDescription').value;

      try {
        const res = await InnovateAPI.apiRequest(`/communities/${state.communityId}/groups`, {
          method: 'POST',
          body: JSON.stringify({ name, description })
        });
        
        console.log('Group created successfully');
        closeModal();
        await loadGroups();
        
        if (state.socket) {
          state.socket.emit('group:new', { communityId: state.communityId });
        }
      } catch (error) {
        console.error('Error creating group:', error);
      }
    }
    
    // ==================== ANNOUNCEMENT FUNCTIONS ====================
    function showCreateAnnouncementModal() {
      showModal(`
        <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 24px; border-radius: 12px 12px 0 0;">
          <div style="display: flex; align-items: center; gap: 12px;">
            <div style="width: 48px; height: 48px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px;">
              <i class="fas fa-bullhorn"></i>
            </div>
            <div>
              <div class="modal-title" style="font-size: 22px; font-weight: 700; margin-bottom: 4px;">Create Announcement</div>
              <div style="font-size: 13px; opacity: 0.9;">Share important updates with your community</div>
            </div>
          </div>
          <button class="modal-close" onclick="closeModal()" style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); color: white; border: none; width: 36px; height: 36px; border-radius: 50%; font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;"></button>
        </div>
        <form onsubmit="createAnnouncement(event)" style="padding: 24px; max-height: 70vh; overflow-y: auto;">
          <!-- Title Input -->
          <div style="margin-bottom: 20px;">
            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px; font-weight: 600; font-size: 14px; color: var(--ig-primary-text);">
              <i class="fas fa-heading" style="color: #667eea;"></i>
              <span>Title *</span>
            </label>
            <input type="text" id="announcementTitle" placeholder="e.g., Important Update, New Event, Community News" required style="width: 100%; padding: 14px 16px; border: 2px solid var(--ig-border); border-radius: 12px; background: var(--ig-secondary-background); color: var(--ig-primary-text); font-size: 15px; transition: all 0.2s; outline: none;" onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='var(--ig-border)'">
          </div>
          
          <!-- Message Textarea -->
          <div style="margin-bottom: 20px;">
            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px; font-weight: 600; font-size: 14px; color: var(--ig-primary-text);">
              <i class="fas fa-align-left" style="color: #667eea;"></i>
              <span>Message *</span>
            </label>
            <textarea id="announcementMessage" rows="5" placeholder="Write your announcement message here... Be clear and concise." required style="width: 100%; padding: 14px 16px; border: 2px solid var(--ig-border); border-radius: 12px; background: var(--ig-secondary-background); color: var(--ig-primary-text); resize: vertical; font-size: 15px; line-height: 1.6; transition: all 0.2s; outline: none; font-family: inherit;" onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='var(--ig-border)'"></textarea>
          </div>
          
          <!-- Attachments -->
          <div style="margin-bottom: 20px;">
            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px; font-weight: 600; font-size: 14px; color: var(--ig-primary-text);">
              <i class="fas fa-paperclip" style="color: #667eea;"></i>
              <span>Attachments</span>
              <span style="font-size: 12px; font-weight: 400; color: var(--ig-secondary-text);">(optional)</span>
            </label>
            <div style="position: relative; border: 2px dashed var(--ig-border); border-radius: 12px; padding: 24px; text-align: center; background: var(--ig-secondary-background); transition: all 0.2s; cursor: pointer;" onmouseover="this.style.borderColor='#667eea'" onmouseout="this.style.borderColor='var(--ig-border)'">
              <input type="file" id="announcementFiles" multiple accept="image/*,video/*,.pdf,.doc,.docx" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer;" onchange="handleAnnouncementFilesChange(event)">
              <div style="pointer-events: none;">
                <div style="width: 56px; height: 56px; margin: 0 auto 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 14px; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px;">
                  <i class="fas fa-cloud-upload-alt"></i>
                </div>
                <div style="font-weight: 600; margin-bottom: 6px; color: var(--ig-primary-text);">Choose Files or Drag & Drop</div>
                <div style="font-size: 13px; color: var(--ig-secondary-text); display: flex; align-items: center; justify-content: center; gap: 6px; flex-wrap: wrap;">
                  <span><i class="fas fa-image"></i> Images</span>
                  <span></span>
                  <span><i class="fas fa-video"></i> Videos</span>
                  <span></span>
                  <span><i class="fas fa-file-pdf"></i> PDFs</span>
                  <span></span>
                  <span><i class="fas fa-file-word"></i> Documents</span>
                </div>
              </div>
            </div>
            
            <!-- Selected Files Preview -->
            <div id="announcementFilesPreview" style="display: none; margin-top: 16px; padding: 16px; background: var(--ig-primary-background); border: 1px solid var(--ig-border); border-radius: 12px;">
              <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                <div style="font-weight: 600; font-size: 14px; color: var(--ig-primary-text);">
                  <i class="fas fa-file-alt" style="color: #667eea;"></i>
                  <span id="announcementFilesCount">0 files selected</span>
                </div>
                <button type="button" onclick="clearAnnouncementFiles()" style="padding: 6px 12px; background: var(--ig-error); color: white; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; transition: opacity 0.2s;" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">
                  <i class="fas fa-times"></i> Clear All
                </button>
              </div>
              <div id="announcementFilesList" style="display: grid; gap: 8px; max-height: 200px; overflow-y: auto;"></div>
            </div>
          </div>
          
          <!-- Links Section -->
          <div style="margin-bottom: 20px;">
            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px; font-weight: 600; font-size: 14px; color: var(--ig-primary-text);">
              <i class="fas fa-link" style="color: #667eea;"></i>
              <span>Links</span>
              <span style="font-size: 12px; font-weight: 400; color: var(--ig-secondary-text);">(optional)</span>
            </label>
            <div id="announcementLinks" style="margin-bottom: 12px;"></div>
            <button type="button" onclick="addAnnouncementLink()" style="width: 100%; padding: 12px; background: var(--ig-secondary-background); border: 2px dashed var(--ig-border); border-radius: 10px; color: var(--ig-primary-text); font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px;" onmouseover="this.style.borderColor='#667eea'; this.style.background='rgba(102, 126, 234, 0.1)'" onmouseout="this.style.borderColor='var(--ig-border)'; this.style.background='var(--ig-secondary-background)'">
              <i class="fas fa-plus-circle"></i> Add Link
            </button>
          </div>
          
          <!-- Location Section -->
          <div style="margin-bottom: 24px; padding: 16px; background: var(--ig-secondary-background); border-radius: 12px; border: 1px solid var(--ig-border);">
            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
              <input type="checkbox" id="announcementAddLocation" onchange="toggleAnnouncementLocation()" style="width: 20px; height: 20px; cursor: pointer; accent-color: #667eea;">
              <div style="display: flex; align-items: center; gap: 8px; font-weight: 600; font-size: 14px;">
                <i class="fas fa-map-marker-alt" style="color: #f5576c;"></i>
                <span>Add Location</span>
              </div>
            </label>
            <div id="announcementLocationInput" style="display: none; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--ig-border);">
              <input type="text" id="announcementLocationName" placeholder="Location name (e.g., Main Campus, Conference Room)" style="width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid var(--ig-border); border-radius: 10px; background: var(--ig-primary-background); color: var(--ig-primary-text); outline: none;">
              <input type="text" id="announcementLocationAddress" placeholder="Full address" style="width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid var(--ig-border); border-radius: 10px; background: var(--ig-primary-background); color: var(--ig-primary-text); outline: none;">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                <input type="number" step="any" id="announcementLocationLat" placeholder="Latitude" style="padding: 12px; border: 1px solid var(--ig-border); border-radius: 10px; background: var(--ig-primary-background); color: var(--ig-primary-text); outline: none;">
                <input type="number" step="any" id="announcementLocationLng" placeholder="Longitude" style="padding: 12px; border: 1px solid var(--ig-border); border-radius: 10px; background: var(--ig-primary-background); color: var(--ig-primary-text); outline: none;">
              </div>
              <button type="button" onclick="getCurrentLocation()" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(245, 87, 108, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                <i class="fas fa-crosshairs"></i> Use Current Location
              </button>
            </div>
          </div>
          
          <!-- Poll Section -->
          <div style="margin-bottom: 24px; padding: 16px; background: var(--ig-secondary-background); border-radius: 12px; border: 1px solid var(--ig-border);">
            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
              <input type="checkbox" id="announcementAddPoll" onchange="toggleAnnouncementPoll()" style="width: 20px; height: 20px; cursor: pointer; accent-color: #667eea;">
              <div style="display: flex; align-items: center; gap: 8px; font-weight: 600; font-size: 14px;">
                <i class="fas fa-poll" style="color: #4facfe;"></i>
                <span>Add Poll</span>
              </div>
            </label>
            <div id="announcementPollInput" style="display: none; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--ig-border);">
              <input type="text" id="pollQuestion" placeholder="Poll question (e.g., What's your favorite feature?)" style="width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid var(--ig-border); border-radius: 10px; background: var(--ig-primary-background); color: var(--ig-primary-text); outline: none; font-weight: 600;">
              <div id="pollOptions" style="margin-bottom: 12px;"></div>
              <button type="button" onclick="addPollOption()" style="width: 100%; padding: 10px; background: var(--ig-secondary-background); border: 2px dashed var(--ig-border); border-radius: 8px; color: var(--ig-primary-text); font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 6px; font-size: 13px;" onmouseover="this.style.borderColor='#4facfe'; this.style.background='rgba(79, 172, 254, 0.1)'" onmouseout="this.style.borderColor='var(--ig-border)'; this.style.background='var(--ig-secondary-background)'">
                <i class="fas fa-plus-circle"></i> Add Option
              </button>
            </div>
          </div>
          
          <!-- Action Buttons -->
          <div style="display: flex; gap: 12px; padding-top: 20px; border-top: 1px solid var(--ig-border);">
            <button type="submit" style="flex: 1; padding: 14px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 12px; font-weight: 700; font-size: 15px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; transition: all 0.2s; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.3)'">
              <i class="fas fa-paper-plane"></i> Post Announcement
            </button>
            <button type="button" onclick="closeModal()" style="padding: 14px 24px; background: var(--ig-secondary-background); color: var(--ig-primary-text); border: 2px solid var(--ig-border); border-radius: 12px; font-weight: 600; font-size: 15px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#f5576c'; this.style.background='rgba(245, 87, 108, 0.1)'" onmouseout="this.style.borderColor='var(--ig-border)'; this.style.background='var(--ig-secondary-background)'">
              Cancel
            </button>
          </div>
        </form>
      `);
    }
    
    let announcementLinkCounter = 0;
    function addAnnouncementLink() {
      const container = document.getElementById('announcementLinks');
      announcementLinkCounter++;
      const linkId = `link_${announcementLinkCounter}`;
      
      const linkDiv = document.createElement('div');
      linkDiv.id = linkId;
      linkDiv.style.cssText = 'margin-bottom: 12px; padding: 16px; background: var(--ig-secondary-background); border-radius: 12px; border: 2px solid var(--ig-border);';
      linkDiv.innerHTML = `
        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
          <div style="flex: 1;">
            <input type="text" class="announcement-link-title" placeholder="Link title (e.g., Event Page, Registration Form)" style="width: 100%; padding: 12px; border: 1px solid var(--ig-border); border-radius: 10px; background: var(--ig-primary-background); color: var(--ig-primary-text); outline: none;">
          </div>
          <button type="button" onclick="document.getElementById('${linkId}').remove()" style="width: 44px; height: 44px; background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%); color: white; border: none; border-radius: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
            <i class="fas fa-trash"></i>
          </button>
        </div>
        <div style="position: relative;">
          <i class="fas fa-globe" style="position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: var(--ig-secondary-text);"></i>
          <input type="url" class="announcement-link-url" placeholder="https://example.com" style="width: 100%; padding: 12px 12px 12px 40px; border: 1px solid var(--ig-border); border-radius: 10px; background: var(--ig-primary-background); color: var(--ig-primary-text); outline: none;">
        </div>
      `;
      container.appendChild(linkDiv);
    }
    
    function toggleAnnouncementLocation() {
      const checkbox = document.getElementById('announcementAddLocation');
      const locationInput = document.getElementById('announcementLocationInput');
      locationInput.style.display = checkbox.checked ? 'block' : 'none';
    }
    
    function getCurrentLocation() {
      if (!navigator.geolocation) {
        console.error('Geolocation not supported');
        return;
      }
      
      navigator.geolocation.getCurrentPosition(
        (position) => {
          document.getElementById('announcementLocationLat').value = position.coords.latitude;
          document.getElementById('announcementLocationLng').value = position.coords.longitude;
          console.log('Location detected:', position.coords.latitude, position.coords.longitude);
        },
        (error) => {
          console.error('Could not get location:', error.message);
        }
      );
    }
    
    // Poll functions
    function toggleAnnouncementPoll() {
      const checkbox = document.getElementById('announcementAddPoll');
      const pollInput = document.getElementById('announcementPollInput');
      pollInput.style.display = checkbox.checked ? 'block' : 'none';
      
      // Add default 2 options when enabling poll
      if (checkbox.checked) {
        const container = document.getElementById('pollOptions');
        if (container.children.length === 0) {
          addPollOption();
          addPollOption();
        }
      }
    }
    
    let pollOptionCounter = 0;
    function addPollOption() {
      const container = document.getElementById('pollOptions');
      pollOptionCounter++;
      const optionId = `pollOption_${pollOptionCounter}`;
      
      const optionDiv = document.createElement('div');
      optionDiv.id = optionId;
      optionDiv.style.cssText = 'display: flex; gap: 8px; margin-bottom: 8px;';
      optionDiv.innerHTML = `
        <div style="width: 28px; height: 40px; display: flex; align-items: center; justify-content: center; background: var(--ig-secondary-background); border: 1px solid var(--ig-border); border-radius: 8px; font-size: 12px; font-weight: 700; color: var(--ig-secondary-text);">
          ${container.children.length + 1}
        </div>
        <input type="text" class="poll-option-text" placeholder="Option ${container.children.length + 1}" style="flex: 1; padding: 10px 12px; border: 1px solid var(--ig-border); border-radius: 8px; background: var(--ig-primary-background); color: var(--ig-primary-text); outline: none; font-size: 14px;">
        ${container.children.length >= 2 ? `
          <button type="button" onclick="document.getElementById('${optionId}').remove(); updatePollOptionNumbers()" style="width: 40px; height: 40px; background: var(--ig-error); color: white; border: none; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: opacity 0.2s;" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">
            <i class="fas fa-times"></i>
          </button>
        ` : ''}
      `;
      container.appendChild(optionDiv);
    }
    
    function updatePollOptionNumbers() {
      const container = document.getElementById('pollOptions');
      Array.from(container.children).forEach((div, index) => {
        const numberEl = div.querySelector('div');
        if (numberEl) numberEl.textContent = index + 1;
        const input = div.querySelector('input');
        if (input && !input.value) input.placeholder = `Option ${index + 1}`;
      });
    }
    
    // Poll voting functions
    function renderPollResults(announcementId, poll) {
      const votes = poll.votes || [];
      const totalVotes = votes.length;
      const voteCounts = new Array(poll.options.length).fill(0);
      
      // Count votes
      votes.forEach(vote => {
        if (vote.optionIndex >= 0 && vote.optionIndex < voteCounts.length) {
          voteCounts[vote.optionIndex]++;
        }
      });
      
      // Check if current user has voted
      const currentUserId = InnovateAPI.getCurrentUser()?.id;
      const userVote = votes.find(v => v.userId === currentUserId);
      const userVotedIndex = userVote ? userVote.optionIndex : -1;
      
      return `
        <div style="background: var(--ig-secondary-background); border: 2px solid var(--ig-border); border-radius: 12px; padding: 20px;">
          <div style="font-size: 16px; font-weight: 700; margin-bottom: 16px; color: var(--ig-primary-text);">${poll.question}</div>
          <div style="display: flex; flex-direction: column; gap: 12px;">
            ${poll.options.map((option, index) => {
              const count = voteCounts[index];
              const percentage = totalVotes > 0 ? Math.round((count / totalVotes) * 100) : 0;
              const isUserVote = index === userVotedIndex;
              const borderColor = isUserVote ? '#4facfe' : 'var(--ig-border)';
              
              return `
                <div 
                  onclick="votePoll(${announcementId}, ${index})" 
                  style="position: relative; background: var(--ig-primary-background); border: 2px solid ${borderColor}; border-radius: 10px; padding: 14px 16px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 12px; overflow: hidden;"
                  onmouseover="if (!${isUserVote}) this.style.borderColor='#4facfe'; this.style.transform='translateX(4px)'" 
                  onmouseout="if (!${isUserVote}) this.style.borderColor='var(--ig-border)'; this.style.transform='translateX(0)'"
                >
                  <!-- Progress bar background -->
                  <div style="position: absolute; left: 0; top: 0; height: 100%; width: ${percentage}%; background: linear-gradient(135deg, rgba(79, 172, 254, 0.15) 0%, rgba(0, 242, 254, 0.15) 100%); transition: width 0.3s ease; border-radius: 8px;"></div>
                  
                  <!-- Content -->
                  <div style="position: relative; width: 28px; height: 28px; border-radius: 50%; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 13px; flex-shrink: 0;">${index + 1}</div>
                  <div style="position: relative; flex: 1; font-size: 15px; font-weight: 500; color: var(--ig-primary-text);">${option}</div>
                  ${totalVotes > 0 ? `
                    <div style="position: relative; font-size: 14px; font-weight: 600; color: var(--ig-secondary-text); margin-right: 8px;">${count} (${percentage}%)</div>
                  ` : ''}
                  ${isUserVote ? `
                    <i class="fas fa-check-circle" style="position: relative; color: #4facfe; font-size: 18px;"></i>
                  ` : `
                    <i class="far fa-circle" style="position: relative; color: var(--ig-secondary-text); font-size: 18px;"></i>
                  `}
                </div>
              `;
            }).join('')}
          </div>
          <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--ig-border); font-size: 13px; color: var(--ig-secondary-text); text-align: center;">
            ${totalVotes === 0 ? `
              <i class="fas fa-info-circle"></i> Be the first to vote!
            ` : `
              <i class="fas fa-chart-bar"></i> ${totalVotes} ${totalVotes === 1 ? 'vote' : 'votes'} total
            `}
          </div>
        </div>
      `;
    }
    
    async function votePoll(announcementId, optionIndex) {
      try {
        const response = await InnovateAPI.apiRequest(
          `/communities/${state.communityId}/announcements/${announcementId}/vote`,
          {
            method: 'POST',
            body: JSON.stringify({ optionIndex })
          }
        );
        
        if (response.success) {
          console.log('Vote recorded successfully');
          
          // Reload the announcement to show updated results
          viewAnnouncement(announcementId);
        }
      } catch (error) {
        console.error('Error voting:', error);
        alert('Failed to record vote: ' + error.message);
      }
    }
    
    // File handling functions
    let accumulatedFiles = [];
    
    function handleAnnouncementFilesChange(event) {
      const newFiles = Array.from(event.target.files);
      
      if (newFiles.length === 0) {
        // User cancelled - keep existing files
        if (accumulatedFiles.length === 0) {
          document.getElementById('announcementFilesPreview').style.display = 'none';
        }
        return;
      }
      
      // Add new files to accumulated list (avoid duplicates by name)
      newFiles.forEach(newFile => {
        const isDuplicate = accumulatedFiles.some(f => f.name === newFile.name && f.size === newFile.size);
        if (!isDuplicate) {
          accumulatedFiles.push(newFile);
        }
      });
      
      // Update the file input with all accumulated files
      const dt = new DataTransfer();
      accumulatedFiles.forEach(file => dt.items.add(file));
      event.target.files = dt.files;
      
      // Update preview
      updateFilesPreview();
    }
    
    function updateFilesPreview() {
      const files = accumulatedFiles;
      
      if (files.length === 0) {
        document.getElementById('announcementFilesPreview').style.display = 'none';
        return;
      }
      
      const preview = document.getElementById('announcementFilesPreview');
      const filesList = document.getElementById('announcementFilesList');
      const filesCount = document.getElementById('announcementFilesCount');
      
      preview.style.display = 'block';
      filesCount.textContent = `${files.length} file${files.length > 1 ? 's' : ''} selected`;
      
      filesList.innerHTML = '';
      
      files.forEach((file, index) => {
        const fileDiv = document.createElement('div');
        fileDiv.style.cssText = 'display: flex; align-items: center; gap: 12px; padding: 10px 12px; background: var(--ig-secondary-background); border: 1px solid var(--ig-border); border-radius: 8px; transition: all 0.2s;';
        fileDiv.onmouseover = function() { this.style.background = 'var(--ig-hover)'; };
        fileDiv.onmouseout = function() { this.style.background = 'var(--ig-secondary-background)'; };
        
        // Determine file type icon
        const ext = file.name.split('.').pop().toLowerCase();
        let icon = 'fa-file';
        let iconColor = '#888';
        
        if (['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg'].includes(ext)) {
          icon = 'fa-image';
          iconColor = '#667eea';
        } else if (['mp4', 'mov', 'webm', 'avi'].includes(ext)) {
          icon = 'fa-video';
          iconColor = '#f5576c';
        } else if (ext === 'pdf') {
          icon = 'fa-file-pdf';
          iconColor = '#e74c3c';
        } else if (['doc', 'docx'].includes(ext)) {
          icon = 'fa-file-word';
          iconColor = '#2b579a';
        }
        
        const fileSize = (file.size / 1024).toFixed(1);
        const sizeUnit = fileSize > 1024 ? `${(fileSize / 1024).toFixed(1)} MB` : `${fileSize} KB`;
        
        fileDiv.innerHTML = `
          <div style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: ${iconColor}15; border-radius: 8px;">
            <i class="fas ${icon}" style="font-size: 18px; color: ${iconColor};"></i>
          </div>
          <div style="flex: 1; min-width: 0;">
            <div style="font-weight: 600; font-size: 13px; color: var(--ig-primary-text); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${file.name}">${file.name}</div>
            <div style="font-size: 12px; color: var(--ig-secondary-text);">${sizeUnit}</div>
          </div>
          <button type="button" onclick="removeAnnouncementFile(${index})" style="width: 32px; height: 32px; background: var(--ig-error); color: white; border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: opacity 0.2s; flex-shrink: 0;" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'" title="Remove file">
            <i class="fas fa-times"></i>
          </button>
        `;
        
        filesList.appendChild(fileDiv);
      });
    }
    
    function removeAnnouncementFile(index) {
      // Remove from accumulated files array
      accumulatedFiles.splice(index, 1);
      
      // Update the file input
      const filesInput = document.getElementById('announcementFiles');
      const dt = new DataTransfer();
      accumulatedFiles.forEach(file => dt.items.add(file));
      filesInput.files = dt.files;
      
      // Update preview
      updateFilesPreview();
    }
    
    function clearAnnouncementFiles() {
      const filesInput = document.getElementById('announcementFiles');
      filesInput.value = '';
      accumulatedFiles = [];
      document.getElementById('announcementFilesPreview').style.display = 'none';
      document.getElementById('announcementFilesList').innerHTML = '';
    }
    
    async function createAnnouncement(e) {
      e.preventDefault();
      
      const title = document.getElementById('announcementTitle').value;
      const message = document.getElementById('announcementMessage').value;
      const filesInput = document.getElementById('announcementFiles');
      
      // Collect links
      const links = [];
      document.querySelectorAll('#announcementLinks > div').forEach(linkDiv => {
        const titleInput = linkDiv.querySelector('.announcement-link-title');
        const urlInput = linkDiv.querySelector('.announcement-link-url');
        if (titleInput.value && urlInput.value) {
          links.push({ title: titleInput.value, url: urlInput.value });
        }
      });
      
      // Collect location
      let location = null;
      if (document.getElementById('announcementAddLocation').checked) {
        const name = document.getElementById('announcementLocationName').value;
        const address = document.getElementById('announcementLocationAddress').value;
        const lat = parseFloat(document.getElementById('announcementLocationLat').value);
        const lng = parseFloat(document.getElementById('announcementLocationLng').value);
        
        if (lat && lng) {
          location = { name, address, lat, lng };
        }
      }
      
      // Collect poll
      let poll = null;
      if (document.getElementById('announcementAddPoll').checked) {
        const question = document.getElementById('pollQuestion').value;
        const options = [];
        document.querySelectorAll('.poll-option-text').forEach(input => {
          if (input.value.trim()) {
            options.push(input.value.trim());
          }
        });
        
        if (question && options.length >= 2) {
          poll = { question, options };
        }
      }
      
      try {
        const formData = new FormData();
        formData.append('title', title);
        formData.append('body', message);
        
        // Add files
        if (filesInput.files.length > 0) {
          for (let i = 0; i < filesInput.files.length; i++) {
            formData.append('files', filesInput.files[i]);
          }
        }
        
        // Add structured data
        const attachmentsData = { links, location, poll, files: [] };
        formData.append('attachments', JSON.stringify(attachmentsData));
        
        const res = await fetch(`/api/communities/${state.communityId}/announcements`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${InnovateAPI.getToken()}` },
          body: formData
        });
        
        const data = await res.json();
        
        if (data.success) {
          console.log('Announcement posted successfully');
          
          // Clear the form
          document.getElementById('announcementTitle').value = '';
          document.getElementById('announcementMessage').value = '';
          clearAnnouncementFiles();
          document.getElementById('announcementLinks').innerHTML = '';
          document.getElementById('announcementAddLocation').checked = false;
          toggleAnnouncementLocation();
          document.getElementById('announcementAddPoll').checked = false;
          document.getElementById('pollOptions').innerHTML = '';
          toggleAnnouncementPoll();
          
          closeModal();
          await loadAnnouncements();
          
          if (state.socket) {
            state.socket.emit('announcement:new', { communityId: state.communityId });
          }
        } else {
          throw new Error(data.error || 'Failed to create announcement');
        }
      } catch (error) {
        console.error('Error creating announcement:', error);
      }
    }
    
    async function pinAnnouncement(announcementId, isPinned) {
      try {
        await InnovateAPI.apiRequest(`/communities/${state.communityId}/announcements/${announcementId}`, {
          method: 'PATCH',
          body: JSON.stringify({ is_pinned: isPinned })
        });
        
        console.log(isPinned ? 'Announcement pinned' : 'Announcement unpinned');
        await loadAnnouncements();
        
        if (state.socket) {
          state.socket.emit('announcement:pinned', { communityId: state.communityId, announcementId, isPinned });
        }
      } catch (error) {
        console.error('Error pinning announcement:', error);
      }
    }
    
    async function deleteAnnouncement(announcementId) {
      if (!confirm('Are you sure you want to delete this announcement?')) return;
      
      try {
        await InnovateAPI.apiRequest(`/communities/${state.communityId}/announcements/${announcementId}`, {
          method: 'DELETE'
        });
        
        console.log('Announcement deleted successfully');
        state.currentAnnouncementId = null;
        await loadAnnouncements();
      } catch (error) {
        console.error('Error deleting announcement:', error);
      }
    }

    function showModal(content) {
      const container = document.getElementById('modalsContainer');
      container.innerHTML = `
        <div class="modal-overlay" onclick="if(event.target===this) closeModal()">
          <div class="modal-content">
            ${content}
          </div>
        </div>
      `;
    }

    function closeModal() {
      document.getElementById('modalsContainer').innerHTML = '';
    }

    // ==================== GITHUB INTEGRATION ====================
    function showGitHubIntegration() {
      showModal(`
        <div class="modal-header" style="background: linear-gradient(135deg, #24292e 0%, #6e5494 100%); color: white; padding: 24px; border-radius: 12px 12px 0 0;">
          <div style="display: flex; align-items: center; gap: 12px;">
            <div style="width: 48px; height: 48px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px;">
              <i class="fab fa-github"></i>
            </div>
            <div>
              <div class="modal-title" style="font-size: 22px; font-weight: 700; margin-bottom: 4px;">GitHub Integration</div>
              <div style="font-size: 13px; opacity: 0.9;">Connect your repository</div>
            </div>
          </div>
          <button class="modal-close" onclick="closeModal()" style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); color: white; border: none; width: 36px; height: 36px; border-radius: 50%; font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;"></button>
        </div>
        <div style="padding: 24px;">
          ${state.githubIntegration ? `
            <div style="padding: 20px; background: var(--ig-secondary-background); border-radius: 12px; border: 2px solid #28a745; margin-bottom: 20px;">
              <div style="display: flex; align-items: center; gap: 16px;">
                <div style="width: 56px; height: 56px; background: linear-gradient(135deg, #24292e 0%, #6e5494 100%); border-radius: 14px; display: flex; align-items: center; justify-content: center; color: white; font-size: 28px;">
                  <i class="fab fa-github"></i>
                </div>
                <div style="flex: 1;">
                  <div style="font-weight: 700; font-size: 16px; margin-bottom: 4px; color: var(--ig-primary-text);">${state.githubIntegration.org || state.githubIntegration.repo}</div>
                  <div style="display: flex; align-items: center; gap: 6px; font-size: 14px; color: #28a745;">
                    <i class="fas fa-check-circle"></i>
                    <span style="font-weight: 600;">Connected</span>
                  </div>
                </div>
              </div>
            </div>
            <button onclick="disconnectGitHub()" style="width: 100%; padding: 14px 24px; background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white; border: none; border-radius: 12px; font-weight: 700; font-size: 15px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; transition: all 0.2s; box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(220, 53, 69, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(220, 53, 69, 0.3)'">
              <i class="fas fa-unlink"></i> Disconnect GitHub
            </button>
          ` : `
            <div style="text-align: center; padding: 40px 20px;">
              <div style="width: 96px; height: 96px; margin: 0 auto 20px; background: linear-gradient(135deg, #24292e 0%, #6e5494 100%); border-radius: 20px; display: flex; align-items: center; justify-content: center; color: white; font-size: 48px;">
                <i class="fab fa-github"></i>
              </div>
              <h3 style="margin-bottom: 12px; font-size: 20px; font-weight: 700; color: var(--ig-primary-text);">Connect GitHub Repository</h3>
              <p style="color: var(--ig-secondary-text); margin-bottom: 28px; font-size: 14px; line-height: 1.6; max-width: 400px; margin-left: auto; margin-right: auto;">
                Link your GitHub repository to manage code, issues, and pull requests directly from the community
              </p>
              <button onclick="connectGitHub()" style="padding: 14px 32px; background: linear-gradient(135deg, #24292e 0%, #6e5494 100%); color: white; border: none; border-radius: 12px; font-weight: 700; font-size: 15px; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 10px; transition: all 0.2s; box-shadow: 0 4px 12px rgba(36, 41, 46, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(36, 41, 46, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(36, 41, 46, 0.3)'">
                <i class="fab fa-github"></i> Connect GitHub
              </button>
            </div>
          `}
        </div>
      `);
    }

    function connectGitHub() {
      console.log('GitHub OAuth flow coming soon!');
      // Implement GitHub OAuth
    }

    function disconnectGitHub() {
      state.githubIntegration = null;
      console.log('GitHub disconnected');
      closeModal();
    }

    function openGitHubRepos() {
      if (!state.githubIntegration) {
        showGitHubIntegration();
        return;
      }
      console.log('Showing GitHub repositories...');
      // Implement GitHub repo browser
    }

    // ==================== UTILITY FUNCTIONS ====================
    async function inviteMembers() {
      const link = `${window.location.origin}/communities?join=${state.communityId}`;
      const title = state.community ? `Join ${state.community.name} on Innovate Hub` : 'Join Community on Innovate Hub';
      const text = state.community ? `Hey! Check out ${state.community.name} community on Innovate Hub` : 'Join this awesome community!';
      
      // Try native share API (works on mobile)
      if (navigator.share) {
        try {
          await navigator.share({
            title: title,
            text: text,
            url: link
          });
          console.log('Shared successfully');
        } catch (error) {
          // User cancelled or error
          if (error.name !== 'AbortError') {
            console.log('Share failed, copying to clipboard');
            navigator.clipboard.writeText(link);
            console.log('Invite link copied:', link);
          }
        }
      } else {
        // Fallback: Show share modal with options
        showShareModal(link, title, text);
      }
    }
    
    function showShareModal(link, title, text) {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div style="background: var(--ig-secondary-background); border-radius: 16px; padding: 24px; max-width: 450px; width: 90%;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="margin: 0; font-size: 18px; font-weight: 700;">Share Community</h3>
            <button onclick="this.closest('.modal-overlay').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--ig-secondary-text); padding: 0; width: 32px; height: 32px;">&times;</button>
          </div>
          
          <div style="background: var(--ig-primary-background); padding: 12px 16px; border-radius: 8px; margin-bottom: 20px; display: flex; align-items: center; gap: 12px; border: 1px solid var(--ig-border);">
            <input type="text" value="${link}" readonly style="flex: 1; background: none; border: none; color: var(--ig-primary-text); font-size: 14px; outline: none;">
            <button onclick="navigator.clipboard.writeText('${link}'); console.log('Link copied'); this.innerHTML='<i class=\\'fas fa-check\\'></i> Copied'; setTimeout(() => this.innerHTML='<i class=\\'fas fa-copy\\'></i> Copy', 2000)" style="padding: 8px 16px; background: var(--ig-blue); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; white-space: nowrap;">
              <i class="fas fa-copy"></i> Copy
            </button>
          </div>
          
          <div style="margin-bottom: 16px;">
            <div style="font-size: 14px; font-weight: 600; margin-bottom: 12px; color: var(--ig-secondary-text);">Share via</div>
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
              <a href="https://wa.me/?text=${encodeURIComponent(text + ' ' + link)}" target="_blank" style="display: flex; flex-direction: column; align-items: center; gap: 8px; text-decoration: none; color: var(--ig-primary-text); padding: 16px; background: var(--ig-primary-background); border-radius: 12px; border: 1px solid var(--ig-border); transition: all 0.2s;" onmouseover="this.style.borderColor='#25D366'; this.style.background='rgba(37, 211, 102, 0.1)'" onmouseout="this.style.borderColor='var(--ig-border)'; this.style.background='var(--ig-primary-background)'">
                <i class="fab fa-whatsapp" style="font-size: 28px; color: #25D366;"></i>
                <span style="font-size: 12px;">WhatsApp</span>
              </a>
              
              <a href="https://t.me/share/url?url=${encodeURIComponent(link)}&text=${encodeURIComponent(text)}" target="_blank" style="display: flex; flex-direction: column; align-items: center; gap: 8px; text-decoration: none; color: var(--ig-primary-text); padding: 16px; background: var(--ig-primary-background); border-radius: 12px; border: 1px solid var(--ig-border); transition: all 0.2s;" onmouseover="this.style.borderColor='#0088cc'; this.style.background='rgba(0, 136, 204, 0.1)'" onmouseout="this.style.borderColor='var(--ig-border)'; this.style.background='var(--ig-primary-background)'">
                <i class="fab fa-telegram" style="font-size: 28px; color: #0088cc;"></i>
                <span style="font-size: 12px;">Telegram</span>
              </a>
              
              <a href="https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(link)}" target="_blank" style="display: flex; flex-direction: column; align-items: center; gap: 8px; text-decoration: none; color: var(--ig-primary-text); padding: 16px; background: var(--ig-primary-background); border-radius: 12px; border: 1px solid var(--ig-border); transition: all 0.2s;" onmouseover="this.style.borderColor='#1DA1F2'; this.style.background='rgba(29, 161, 242, 0.1)'" onmouseout="this.style.borderColor='var(--ig-border)'; this.style.background='var(--ig-primary-background)'">
                <i class="fab fa-twitter" style="font-size: 28px; color: #1DA1F2;"></i>
                <span style="font-size: 12px;">Twitter</span>
              </a>
              
              <a href="mailto:?subject=${encodeURIComponent(title)}&body=${encodeURIComponent(text + '\n\n' + link)}" style="display: flex; flex-direction: column; align-items: center; gap: 8px; text-decoration: none; color: var(--ig-primary-text); padding: 16px; background: var(--ig-primary-background); border-radius: 12px; border: 1px solid var(--ig-border); transition: all 0.2s;" onmouseover="this.style.borderColor='#ea4335'; this.style.background='rgba(234, 67, 53, 0.1)'" onmouseout="this.style.borderColor='var(--ig-border)'; this.style.background='var(--ig-primary-background)'">
                <i class="fas fa-envelope" style="font-size: 28px; color: #ea4335;"></i>
                <span style="font-size: 12px;">Email</span>
              </a>
              
              <a href="https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(link)}" target="_blank" style="display: flex; flex-direction: column; align-items: center; gap: 8px; text-decoration: none; color: var(--ig-primary-text); padding: 16px; background: var(--ig-primary-background); border-radius: 12px; border: 1px solid var(--ig-border); transition: all 0.2s;" onmouseover="this.style.borderColor='#1877f2'; this.style.background='rgba(24, 119, 242, 0.1)'" onmouseout="this.style.borderColor='var(--ig-border)'; this.style.background='var(--ig-primary-background)'">
                <i class="fab fa-facebook" style="font-size: 28px; color: #1877f2;"></i>
                <span style="font-size: 12px;">Facebook</span>
              </a>
              
              <a href="https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(link)}" target="_blank" style="display: flex; flex-direction: column; align-items: center; gap: 8px; text-decoration: none; color: var(--ig-primary-text); padding: 16px; background: var(--ig-primary-background); border-radius: 12px; border: 1px solid var(--ig-border); transition: all 0.2s;" onmouseover="this.style.borderColor='#0077b5'; this.style.background='rgba(0, 119, 181, 0.1)'" onmouseout="this.style.borderColor='var(--ig-border)'; this.style.background='var(--ig-primary-background)'">
                <i class="fab fa-linkedin" style="font-size: 28px; color: #0077b5;"></i>
                <span style="font-size: 12px;">LinkedIn</span>
              </a>
              
              <a href="https://reddit.com/submit?url=${encodeURIComponent(link)}&title=${encodeURIComponent(title)}" target="_blank" style="display: flex; flex-direction: column; align-items: center; gap: 8px; text-decoration: none; color: var(--ig-primary-text); padding: 16px; background: var(--ig-primary-background); border-radius: 12px; border: 1px solid var(--ig-border); transition: all 0.2s;" onmouseover="this.style.borderColor='#FF4500'; this.style.background='rgba(255, 69, 0, 0.1)'" onmouseout="this.style.borderColor='var(--ig-border)'; this.style.background='var(--ig-primary-background)'">
                <i class="fab fa-reddit" style="font-size: 28px; color: #FF4500;"></i>
                <span style="font-size: 12px;">Reddit</span>
              </a>
              
              <button onclick="navigator.clipboard.writeText('${link}'); console.log('Link copied'); this.innerHTML='<i class=\\'fas fa-check\\'></i><br><span style=\\'font-size: 12px;\\'>Copied!</span>'; setTimeout(() => this.innerHTML='<i class=\\'fas fa-link\\'></i><br><span style=\\'font-size: 12px;\\'>Copy Link</span>', 2000)" style="display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px; padding: 16px; background: var(--ig-primary-background); border-radius: 12px; border: 1px solid var(--ig-border); cursor: pointer; transition: all 0.2s; color: var(--ig-primary-text);" onmouseover="this.style.borderColor='var(--ig-blue)'; this.style.background='rgba(0, 149, 246, 0.1)'" onmouseout="this.style.borderColor='var(--ig-border)'; this.style.background='var(--ig-primary-background)'">
                <i class="fas fa-link" style="font-size: 28px; color: var(--ig-blue);"></i>
                <span style="font-size: 12px;">Copy Link</span>
              </button>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      
      // Copy to clipboard as fallback
      navigator.clipboard.writeText(link);
      console.log('Invite link copied:', link);
    }

    function addMembers() {
      console.log('Add members feature coming soon');
    }

    function manageGroups() {
      console.log('Manage groups feature coming soon');
    }

    function showCommunitySettings() {
      console.log('Community settings coming soon');
    }

    function viewAllGroups() {
      switchLeftTab('community');
    }

    function showGroupActions() {
      console.log('Group actions coming soon');
    }

    function setupResponsive() {
      const menuBtn = document.getElementById('menuBtn');
      const leftSidebar = document.getElementById('communityLeft');

      if (window.innerWidth <= 768) {
        menuBtn.style.display = 'block';
      }

      window.addEventListener('resize', () => {
        if (window.innerWidth <= 768) {
          menuBtn.style.display = 'block';
        } else {
          menuBtn.style.display = 'none';
          leftSidebar.classList.remove('mobile-active');
        }
      });
    }

    function toggleLeftSidebar() {
      document.getElementById('communityLeft').classList.toggle('mobile-active');
    }

    // Theme toggle function
    function toggleTheme() {
      const currentTheme = document.documentElement.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', newTheme);
      localStorage.setItem('ig-theme', newTheme);
      
      // Update icon
      const themeIcon = document.getElementById('themeIcon');
      if (themeIcon) {
        themeIcon.className = newTheme === 'dark' ? 'fas fa-moon' : 'fas fa-sun';
      }
      
      console.log(`Switched to ${newTheme} mode`);
    }

    // Initialize theme icon on page load
    function initializeThemeIcon() {
      const currentTheme = document.documentElement.getAttribute('data-theme') || 'dark';
      const themeIcon = document.getElementById('themeIcon');
      if (themeIcon) {
        themeIcon.className = currentTheme === 'dark' ? 'fas fa-moon' : 'fas fa-sun';
      }
    }

    // WebRTC Handlers (placeholders)
    function handleCallOffer(data) { }
    
    // Format timestamp in IST (India Standard Time)
    function formatTimestampIST(dateString) {
      if (!dateString) return '';
      
      // Parse the date - SQLite returns UTC timestamps
      let date;
      if (dateString.includes('T') || dateString.includes('Z')) {
        // ISO format with timezone
        date = new Date(dateString);
      } else {
        // SQLite format without timezone - treat as UTC
        date = new Date(dateString + 'Z');
      }
      
      const now = new Date();
      
      // Debug logging
      console.log('Timestamp formatting:', {
        input: dateString,
        parsed: date.toISOString(),
        now: now.toISOString(),
        diffMs: now - date
      });
      
      // Calculate difference in milliseconds
      const diffMs = now - date;
      const diffSecs = Math.floor(diffMs / 1000);
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);
      
      // Less than 1 minute
      if (diffSecs < 60) return 'Just now';
      
      // Less than 1 hour
      if (diffMins < 60) return `${diffMins}m ago`;
      
      // Less than 24 hours
      if (diffHours < 24) return `${diffHours}h ago`;
      
      // Less than 7 days
      if (diffDays < 7) return `${diffDays}d ago`;
      
      // Show full date in IST
      const options = { 
        timeZone: 'Asia/Kolkata',
        day: '2-digit',
        month: 'short',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        hour12: true
      };
      
      return date.toLocaleString('en-IN', options);
    }
    
    function renderMessage(msg) {
      // Handle both group_messages (sender_id, sender_username) and community_group_posts (user_id, username)
      const senderId = msg.sender_id || msg.user_id;
      const senderName = msg.sender_username || msg.username || 'User';
      const profilePic = msg.profile_picture || msg.sender_profile_picture || '/images/default-avatar.svg';
      const isOwn = senderId == state.user?.id; // Use == for loose comparison
      
      console.log('=== renderMessage called ===');
      console.log('Message ID:', msg.id);
      console.log('Content:', msg.content);
      console.log('Attachments raw:', msg.attachments);
      console.log('Attachments type:', typeof msg.attachments);
      
      // Parse attachments FIRST
      let attachments = [];
      if (msg.attachments) {
        try {
          attachments = typeof msg.attachments === 'string' ? JSON.parse(msg.attachments) : msg.attachments;
          console.log('Parsed attachments:', attachments);
          console.log('Attachments is array:', Array.isArray(attachments));
          console.log('Attachments length:', attachments.length);
          if (attachments.length > 0) {
            console.log('First attachment:', attachments[0]);
          }
        } catch (e) {
          console.error('Error parsing attachments:', e);
        }
        }
      }
      
      // Render attachments HTML
      let attachmentsHTML = '';
      if (attachments && attachments.length > 0) {
        attachmentsHTML = attachments.map((att, index) => {
          console.log(`Rendering attachment ${index}:`, att);
          
          // Handle both formats: string URL or object with properties
          let filepath, filename, type;
          
          if (typeof att === 'string') {
            // Old format: just URL string
            filepath = att;
            filename = att.split('/').pop();
            type = getFileTypeFromUrl(att);
          } else {
            // New format: object with properties
            filepath = att.filepath || att.url || att.path;
            filename = att.filename || att.name || 'file';
            type = att.type || att.file_type || getFileTypeFromUrl(filepath);
          }
          
          console.log(`  filepath: ${filepath}`);
          console.log(`  filename: ${filename}`);
          console.log(`  type: ${type}`);
          
          const isImage = type === 'image' || /\.(jpg|jpeg|png|gif|webp)$/i.test(filename);
          const isVideo = type === 'video' || /\.(mp4|mov|webm)$/i.test(filename);
          
          if (isImage) {
            return `<img src="${filepath}" style="max-width: 100%; border-radius: 8px; margin-top: 8px; cursor: pointer;" onclick="window.open('${filepath}', '_blank')" alt="${filename}" />`;
          } else if (isVideo) {
            return `<video controls style="max-width: 100%; border-radius: 8px; margin-top: 8px;"><source src="${filepath}" type="video/mp4"></video>`;
          } else {
            return `
              <a href="${filepath}" target="_blank" style="display: flex; align-items: center; gap: 8px; margin-top: 8px; padding: 8px; background: rgba(0,0,0,0.1); border-radius: 8px; text-decoration: none; color: inherit;">
                <i class="fas fa-file"></i>
                <span>${filename}</span>
              </a>
            `;
          }
        }).join('');
      }
      
      // Helper function to determine file type from URL
      function getFileTypeFromUrl(url) {
        if (!url) return 'file';
        const ext = url.split('.').pop().toLowerCase();
        if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext)) return 'image';
        if (['mp4', 'mov', 'webm'].includes(ext)) return 'video';
        if (['pdf', 'doc', 'docx', 'txt', 'xls', 'xlsx'].includes(ext)) return 'document';
        return 'file';
      }
      
      // Get the actual content text, treating null/undefined as empty string
      const contentText = msg.content || '';
      const hasContent = contentText && contentText.trim() !== '';
      
      if (isOwn) {
        // Own message - on the right with gradient
        return `
          <div style="display: flex; justify-content: flex-end; align-items: flex-start; gap: 8px;">
            <div style="max-width: 70%; padding: 12px 16px; border-radius: 18px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
              ${hasContent ? `<div style="word-wrap: break-word; margin-bottom: 4px;">${contentText}</div>` : ''}
              ${attachmentsHTML}
              <div style="font-size: 11px; opacity: 0.8; text-align: right; margin-top: 4px;">${formatTimestampIST(msg.created_at)}</div>
            </div>
          </div>
        `;
      } else {
        // Other user's message - on the left with DP
        return `
          <div style="display: flex; justify-content: flex-start; align-items: flex-start; gap: 8px;">
            <img 
              src="${profilePic}" 
              alt="${senderName}"
              onclick="viewUserProfile(${senderId})"
              style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover; cursor: pointer; flex-shrink: 0;"
              title="View ${senderName}'s profile"
            />
            <div style="max-width: 70%; padding: 12px 16px; border-radius: 18px; background: var(--ig-secondary-background); color: var(--ig-primary-text);">
              <div 
                style="font-weight: 600; font-size: 13px; margin-bottom: 6px; opacity: 0.9; cursor: pointer; color: var(--ig-blue);"
                onclick="viewUserProfile(${senderId})"
                title="View profile"
              >
                ${senderName}
              </div>
              ${hasContent ? `<div style="word-wrap: break-word; margin-bottom: 4px;">${contentText}</div>` : ''}
              ${attachmentsHTML}
              <div style="font-size: 11px; opacity: 0.7; text-align: right; margin-top: 4px;">${formatTimestampIST(msg.created_at)}</div>
            </div>
          </div>
        `;
      }
    }
    
    function appendChatMessage(msg) {
      console.log('appendChatMessage called with:', msg);
      let list = document.getElementById('messagesList');
      console.log('messagesList element:', list);
      
      // If messagesList doesn't exist, don't append - wait for loadChatView to set it up
      if (!list) {
        console.log('messagesList not found - cannot append message yet');
        return;
      }
      
      const emptyState = list.querySelector('.empty-state');
      if (emptyState) {
        console.log('Removing empty state');
        emptyState.remove();
      }
      
      const messageEl = document.createElement('div');
      messageEl.innerHTML = renderMessage(msg);
      list.appendChild(messageEl.firstElementChild);
      list.scrollTop = list.scrollHeight;
      console.log('Message appended successfully');
    }
    
    // Handle file selection and show preview
    function handleFileSelect(event) {
      const files = event.target.files;
      if (files.length > 0) {
        const fileNames = Array.from(files).map(f => f.name).join(', ');
        const truncated = fileNames.length > 50 ? fileNames.substring(0, 50) + '...' : fileNames;
        const input = document.getElementById('chatInput');
        input.placeholder = `${files.length} file(s) selected: ${truncated}`;
        console.log('Files selected:', files.length);
      }
    }
    
    // Handle file selection
    function handleFileSelect(event) {
      const fileInput = event.target;
      const chatInput = document.getElementById('chatInput');
      
      if (!fileInput || !chatInput) return;
      
      if (fileInput.files && fileInput.files.length > 0) {
        const fileNames = Array.from(fileInput.files).map(f => f.name).join(', ');
        const truncated = fileNames.length > 40 ? fileNames.substring(0, 40) + '...' : fileNames;
        chatInput.placeholder = `${fileInput.files.length} file(s) selected: ${truncated}`;
      } else {
        chatInput.placeholder = 'Type a message...';
      }
    }
    
    // View user profile
    function viewUserProfile(userId) {
      if (!userId) {
        console.error('No userId provided');
        return;
      }
      
      console.log('Opening profile for user:', userId);
      
      // Open profile in new tab
      window.open(`/profile/${userId}`, '_blank');
    }
    
    function handleCallAnswer(data) { }
    function handleIceCandidate(data) { }
    function handlePeerJoined(data) { }
    function handlePeerLeft(data) { }
    function toggleScreenShare() { }
    function attachFile() {
      const input = document.createElement('input');
      input.type = 'file';
      input.multiple = true;
      input.accept = 'image/*,video/*,audio/*,.pdf,.doc,.docx,.txt';
      input.onchange = async (e) => {
        const files = Array.from(e.target.files);
        if (files.length === 0) return;
        
        try {
          const formData = new FormData();
          files.forEach(file => formData.append('attachments', file));
          
          const res = await fetch(`/api/community-groups/${state.currentGroupId}/posts`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${InnovateAPI.getToken()}`
            },
            body: formData
          });
          
          if (!res.ok) {
            console.error('Upload failed:', res.status);
            return;
          }
          
          const data = await res.json();
          if (data.success && data.post) {
            console.log('Files uploaded successfully');
            appendChatMessage(data.post);
          }
        } catch (error) {
          console.error('Error uploading files:', error);
        }
      };
      input.click();
    }
    function editTask(id) { }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Community - Innovate</title>
  <link rel="stylesheet" href="/css/instagram.css">
  <link rel="stylesheet" href="/css/workspace.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
  <!-- E2E Encryption Library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="/js/instagram-theme.js"></script>
  <script src="/js/group-management.js"></script>
  <style>
    /* WhatsApp Community Complete Styles */
    body { margin: 0; padding: 0; overflow: hidden; }
    
    .community-shell {
      display: grid;
      grid-template-columns: 380px 1fr 360px;
      height: 100vh;
      background: var(--ig-primary-background);
    }

    /* LEFT SIDEBAR - Groups & Announcements */
    .community-left {
      border-right: 1px solid var(--ig-border);
      background: var(--ig-primary-background);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .left-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--ig-border);
      background: var(--ig-secondary-background);
    }

    .community-title {
      font-size: 18px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 4px;
    }

    .community-subtitle {
      font-size: 13px;
      color: var(--ig-secondary-text);
    }

    .left-tabs {
      display: flex;
      border-bottom: 1px solid var(--ig-border);
    }

    .left-tab {
      flex: 1;
      padding: 12px;
      text-align: center;
      font-size: 14px;
      font-weight: 600;
      color: var(--ig-secondary-text);
      border-bottom: 2px solid transparent;
      cursor: pointer;
      background: none;
      border: none;
      transition: all 0.2s;
    }

    .left-tab.active {
      color: var(--ig-blue);
      border-bottom-color: var(--ig-blue);
    }

    .left-content {
      flex: 1;
      overflow-y: auto;
    }

    .group-item {
      padding: 12px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      border-bottom: 1px solid var(--ig-border);
      transition: background 0.2s;
    }

    .group-item:hover, .group-item.active {
      background: var(--ig-hover);
    }

    .group-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--ig-blue), #5B86E5);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 18px;
      flex-shrink: 0;
    }

    .group-info {
      flex: 1;
      min-width: 0;
    }

    .group-name {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .group-desc {
      font-size: 13px;
      color: var(--ig-secondary-text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .left-footer {
      padding: 16px;
      border-top: 1px solid var(--ig-border);
    }

    /* CENTER - Main Content */
    .community-center {
      display: flex;
      flex-direction: column;
      background: var(--ig-secondary-background);
      overflow: hidden;
    }

    .center-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--ig-border);
      background: var(--ig-primary-background);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .header-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--ig-blue);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
    }

    .header-title {
      font-size: 16px;
      font-weight: 600;
      margin: 0;
    }

    .header-subtitle {
      font-size: 13px;
      color: var(--ig-secondary-text);
      margin: 2px 0 0 0;
    }

    .center-tabs {
      display: flex;
      gap: 8px;
      padding: 12px 20px;
      border-bottom: 1px solid var(--ig-border);
      background: var(--ig-primary-background);
      overflow-x: auto;
    }

    .center-tab {
      padding: 8px 16px;
      border-radius: 20px;
      background: var(--ig-secondary-background);
      border: 1px solid var(--ig-border);
      color: var(--ig-secondary-text);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.2s;
    }

    .center-tab.active {
      background: var(--ig-blue);
      color: white;
      border-color: var(--ig-blue);
    }

    .center-content {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }

    .center-footer {
      padding: 12px 16px;
      border-top: 1px solid var(--ig-border);
      background: var(--ig-primary-background);
    }

    /* RIGHT SIDEBAR - Info & Settings */
    .community-right {
      border-left: 1px solid var(--ig-border);
      background: var(--ig-primary-background);
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }

    .right-header {
      padding: 24px 20px;
      text-align: center;
      border-bottom: 1px solid var(--ig-border);
    }

    .right-avatar {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--ig-blue), #5B86E5);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 48px;
      margin: 0 auto 16px;
    }

    .right-name {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .right-meta {
      font-size: 13px;
      color: var(--ig-secondary-text);
    }

    .right-actions {
      display: flex;
      justify-content: space-around;
      padding: 16px;
      border-bottom: 1px solid var(--ig-border);
    }

    .right-action {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      transition: opacity 0.2s;
    }

    .right-action:hover { opacity: 0.7; }

    .action-circle {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: var(--ig-blue);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
    }

    .action-label {
      font-size: 12px;
      color: var(--ig-secondary-text);
    }

    .right-section {
      padding: 20px;
      border-bottom: 1px solid var(--ig-border);
    }

    .section-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--ig-secondary-text);
      margin-bottom: 12px;
      letter-spacing: 0.5px;
    }

    .menu-item {
      padding: 14px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--ig-border);
      cursor: pointer;
      transition: background 0.2s;
    }

    .menu-item:hover {
      background: var(--ig-hover);
    }

    .menu-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .menu-icon {
      width: 24px;
      text-align: center;
      color: var(--ig-secondary-text);
    }

    /* Content Cards */
    .announcement-card {
      background: var(--ig-primary-background);
      border: 1px solid var(--ig-border);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
    }

    .card-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .card-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--ig-blue);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
    }

    .card-info {
      flex: 1;
    }

    .card-author {
      font-size: 14px;
      font-weight: 600;
    }

    .card-date {
      font-size: 12px;
      color: var(--ig-secondary-text);
    }

    .card-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .card-body {
      font-size: 14px;
      line-height: 1.6;
    }

    /* Call Interface */
    .call-view {
      display: flex;
      flex-direction: column;
      height: 100%;
      background: #1a1a1a;
    }

    .video-grid {
      flex: 1;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 8px;
      padding: 16px;
      overflow-y: auto;
    }

    .video-tile {
      background: #2a2a2a;
      border-radius: 12px;
      position: relative;
      aspect-ratio: 16/9;
      overflow: hidden;
    }

    .video-tile video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .video-name {
      position: absolute;
      bottom: 12px;
      left: 12px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
    }

    .call-controls {
      padding: 20px;
      background: #1a1a1a;
      display: flex;
      justify-content: center;
      gap: 16px;
    }

    .call-btn {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      color: white;
      font-size: 20px;
    }

    .call-btn.mute { background: #4a4a4a; }
    .call-btn.end { background: #e74c3c; }
    .call-btn.video { background: #4a4a4a; }
    .call-btn.screen { background: #4a4a4a; }

    .call-btn:hover {
      transform: scale(1.1);
    }

    /* Folder UI */
    .folder-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 12px;
    }

    .folder-item {
      padding: 16px;
      border: 1px solid var(--ig-border);
      border-radius: 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .folder-item:hover {
      background: var(--ig-hover);
      transform: translateY(-2px);
    }

    .folder-icon {
      font-size: 48px;
      margin-bottom: 8px;
    }

    .folder-name {
      font-size: 14px;
      font-weight: 500;
    }

    .folder-count {
      font-size: 12px;
      color: var(--ig-secondary-text);
      margin-top: 4px;
    }

    /* Task Card */
    .task-card {
      background: var(--ig-primary-background);
      border: 1px solid var(--ig-border);
      border-radius: 10px;
      padding: 14px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .task-card:hover {
      border-color: var(--ig-blue);
      transform: translateX(4px);
    }

    .task-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .task-title {
      font-size: 14px;
      font-weight: 600;
    }

    .task-priority {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }

    .priority-high { background: #ffebee; color: #c62828; }
    .priority-medium { background: #fff3e0; color: #ef6c00; }
    .priority-low { background: #e8f5e9; color: #2e7d32; }

    .task-desc {
      font-size: 13px;
      color: var(--ig-secondary-text);
      margin-bottom: 8px;
    }

    .task-meta {
      display: flex;
      gap: 12px;
      font-size: 12px;
      color: var(--ig-secondary-text);
    }
    
    /* ========== KANBAN BOARD STYLES ========== */
    .kanban-board {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-top: 16px;
    }
    
    @media (max-width: 1024px) {
      .kanban-board {
        grid-template-columns: 1fr;
      }
    }
    
    .kanban-column {
      background: var(--ig-secondary-background);
      border: 1px solid var(--ig-border);
      border-radius: 12px;
      overflow: hidden;
      min-height: 400px;
      display: flex;
      flex-direction: column;
    }
    
    .kanban-column-header {
      padding: 16px;
      border-bottom: 2px solid var(--ig-border);
      background: linear-gradient(135deg, rgba(0, 149, 246, 0.05), rgba(0, 149, 246, 0.02));
    }
    
    .kanban-column-title {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .kanban-column-title h3 {
      font-size: 16px;
      font-weight: 600;
      margin: 0;
      flex: 1;
    }
    
    .kanban-icon {
      font-size: 20px;
    }
    
    .kanban-count {
      background: var(--ig-blue);
      color: white;
      border-radius: 12px;
      padding: 2px 8px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .kanban-column-body {
      padding: 12px;
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
      min-height: 200px;
    }
    
    .kanban-empty {
      text-align: center;
      padding: 40px 20px;
      color: var(--ig-secondary-text);
      font-size: 14px;
      border: 2px dashed var(--ig-border);
      border-radius: 8px;
      margin: 20px 0;
    }
    
    .kanban-task {
      background: var(--ig-primary-background);
      border: 1px solid var(--ig-border);
      border-radius: 8px;
      padding: 12px;
      cursor: grab;
      transition: all 0.2s;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .kanban-task:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      border-color: var(--ig-blue);
    }
    
    .kanban-task:active {
      cursor: grabbing;
    }
    
    .kanban-task-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .kanban-task-title {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 6px;
      color: var(--ig-primary-text);
      line-height: 1.4;
    }
    
    .kanban-task-desc {
      font-size: 13px;
      color: var(--ig-secondary-text);
      margin-bottom: 8px;
      line-height: 1.4;
    }
    
    .kanban-task-subtasks {
      color: var(--ig-blue);
      font-size: 12px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 500;
    }

    .kanban-task-subtasks i {
      font-size: 14px;
    }
    
    .kanban-task-footer {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-top: 8px;
      flex-wrap: wrap;
    }
    
    .task-due {
      font-size: 12px;
      color: var(--ig-secondary-text);
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .task-progress-chip {
      background: var(--ig-blue);
      color: white;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 11px;
      font-weight: 600;
    }
    
    .task-delete {
      background: none;
      border: none;
      color: var(--ig-secondary-text);
      cursor: pointer;
      padding: 4px;
      opacity: 0;
      transition: opacity 0.2s;
    }
    
    .task-actions {
      display: flex;
      gap: 4px;
      align-items: center;
    }
    
    .task-edit {
      background: none;
      border: none;
      color: var(--ig-secondary-text);
      cursor: pointer;
      padding: 4px;
      opacity: 0;
      transition: opacity 0.2s;
    }
    
    .kanban-task:hover .task-delete,
    .kanban-task:hover .task-edit {
      opacity: 1;
    }
    
    .task-edit:hover {
      color: var(--ig-blue);
    }
    
    .task-delete:hover {
      color: #ed4956;
    }

    /* Due Date Warnings */
    .task-due.overdue {
      color: #ed4956;
      font-weight: 600;
      animation: pulse 2s infinite;
    }
    
    .task-due.due-today {
      color: #ff9500;
      font-weight: 600;
    }
    
    .task-due.due-soon {
      color: #ff9500;
    }
    
    .task-due.due-upcoming {
      color: var(--ig-secondary-text);
    }
    
    .kanban-task.overdue {
      border-left: 4px solid #ed4956;
    }
    
    .kanban-task.due-today {
      border-left: 4px solid #ff9500;
    }
    
    .kanban-task.due-soon {
      border-left: 4px solid #ff9500;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    /* Calendar View */
    .calendar-container {
      background: var(--ig-primary-background);
      border-radius: 12px;
      padding: 20px;
    }
    
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--ig-border);
    }
    
    .calendar-title {
      font-size: 18px;
      font-weight: 600;
    }
    
    .calendar-legend {
      display: flex;
      gap: 16px;
      font-size: 12px;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .legend-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }
    
    .legend-dot.overdue { background: #ed4956; }
    .legend-dot.today { background: #ff9500; }
    .legend-dot.soon { background: #ffcc00; }
    .legend-dot.upcoming { background: #34c759; }
    
    .calendar-tasks {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .calendar-date-group {
      background: var(--ig-secondary-background);
      border-radius: 8px;
      padding: 12px;
      border-left: 4px solid var(--ig-border);
    }
    
    .calendar-date-group.overdue {
      border-left-color: #ed4956;
    }
    
    .calendar-date-group.today {
      border-left-color: #ff9500;
    }
    
    .calendar-date-group.soon {
      border-left-color: #ffcc00;
    }
    
    .calendar-date-group.upcoming {
      border-left-color: #34c759;
    }
    
    .calendar-date-header {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .calendar-task-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .calendar-task-item {
      background: var(--ig-primary-background);
      padding: 10px;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .calendar-task-item:hover {
      background: var(--ig-hover);
    }
    
    .calendar-task-content {
      flex: 1;
    }
    
    .calendar-task-title {
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 4px;
    }
    
    .calendar-task-meta {
      font-size: 11px;
      color: var(--ig-secondary-text);
      display: flex;
      gap: 8px;
    }
    
    /* Calendar Grid View */
    .calendar-grid-container {
      background: var(--ig-primary-background);
      border-radius: 12px;
      padding: 20px;
      border: 1px solid var(--ig-border);
    }
    
    .calendar-grid-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 2px solid var(--ig-border);
    }
    
    .calendar-month-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--ig-primary-text);
    }
    
    .calendar-nav-btn {
      background: var(--ig-secondary-background);
      border: 1px solid var(--ig-border);
      border-radius: 8px;
      padding: 8px 16px;
      cursor: pointer;
      transition: all 0.2s;
      color: var(--ig-primary-text);
      font-size: 16px;
    }
    
    .calendar-nav-btn:hover {
      background: var(--ig-hover);
      border-color: var(--ig-blue);
    }
    
    .calendar-weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      margin-bottom: 8px;
      padding: 8px 0;
      border-bottom: 1px solid var(--ig-border);
    }
    
    .calendar-weekday {
      text-align: center;
      font-size: 12px;
      font-weight: 600;
      color: var(--ig-secondary-text);
      text-transform: uppercase;
      padding: 4px;
    }
    
    .calendar-days-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
    }
    
    .calendar-day {
      aspect-ratio: 1;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid var(--ig-border);
      background: var(--ig-primary-background);
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 80px;
    }
    
    .calendar-day:not(.empty):hover {
      background: var(--ig-hover);
      border-color: var(--ig-blue);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .calendar-day.empty {
      background: var(--ig-secondary-background);
      opacity: 0.3;
      cursor: default;
      border: 1px solid transparent;
    }
    
    .calendar-day.past {
      opacity: 0.5;
    }
    
    .calendar-day.today {
      border: 2px solid var(--ig-blue);
      background: rgba(0, 149, 246, 0.1);
      font-weight: 700;
    }
    
    .calendar-day.today .calendar-day-number {
      color: var(--ig-blue);
    }
    
    .calendar-day.has-overdue {
      border-color: #ed4956;
      background: rgba(237, 73, 86, 0.08);
    }
    
    .calendar-day.has-due-today {
      border-color: #ff9500;
      background: rgba(255, 149, 0, 0.08);
    }
    
    .calendar-day.has-upcoming {
      border-color: #34c759;
      background: rgba(52, 199, 89, 0.05);
    }
    
    .calendar-day-number {
      font-size: 14px;
      font-weight: 600;
      color: var(--ig-primary-text);
      margin-bottom: 4px;
    }
    
    .calendar-day-indicator {
      position: absolute;
      bottom: 6px;
      right: 6px;
      background: var(--ig-blue);
      color: white;
      font-size: 10px;
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 10px;
      min-width: 18px;
      text-align: center;
    }
    
    .calendar-day.has-overdue .calendar-day-indicator {
      background: #ed4956;
      animation: pulse 2s ease-in-out infinite;
    }
    
    .calendar-day.has-due-today .calendar-day-indicator {
      background: #ff9500;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.7; transform: scale(1.1); }
    }
    
    /* Mobile responsiveness for calendar */
    @media (max-width: 768px) {
      .calendar-grid-container {
        padding: 12px;
      }
      
      .calendar-month-title {
        font-size: 16px;
      }
      
      .calendar-nav-btn {
        padding: 6px 12px;
        font-size: 14px;
      }
      
      .calendar-weekday {
        font-size: 10px;
      }
      
      .calendar-day {
        min-height: 60px;
        padding: 4px;
      }
      
      .calendar-day-number {
        font-size: 12px;
      }
      
      .calendar-day-indicator {
        font-size: 9px;
        padding: 1px 4px;
      }
    }

    /* Task Modal */
    .task-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      animation: fadeIn 0.2s;
    }

    .task-modal {
      background: var(--ig-primary-background);
      border-radius: 12px;
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      animation: slideUp 0.3s;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideUp {
      from { transform: translateY(50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .task-modal-header {
      padding: 20px;
      border-bottom: 1px solid var(--ig-border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .task-modal-header h3 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
      color: var(--ig-primary-text);
    }

    .task-modal-close {
      background: none;
      border: none;
      font-size: 28px;
      color: var(--ig-secondary-text);
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: background 0.2s;
    }

    .task-modal-close:hover {
      background: var(--ig-hover);
    }

    .task-modal-body {
      padding: 20px;
      overflow-y: auto;
      flex: 1;
    }

    .task-form-group {
      margin-bottom: 20px;
    }

    .task-form-group label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
      font-weight: 600;
      color: var(--ig-primary-text);
    }

    .task-form-group input[type="text"],
    .task-form-group input[type="date"],
    .task-form-group select,
    .task-form-group textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--ig-border);
      border-radius: 8px;
      background: var(--ig-secondary-background);
      color: var(--ig-primary-text);
      font-size: 14px;
      font-family: inherit;
      outline: none;
      transition: border-color 0.2s;
    }

    .task-form-group input:focus,
    .task-form-group select:focus,
    .task-form-group textarea:focus {
      border-color: var(--ig-blue);
    }

    .task-form-group textarea {
      resize: vertical;
      min-height: 80px;
    }

    .subtasks-list {
      margin-bottom: 12px;
    }

    .subtask-item {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      padding: 8px;
      background: var(--ig-secondary-background);
      border-radius: 8px;
    }

    .subtask-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
      flex-shrink: 0;
    }

    .subtask-item input[type="text"] {
      flex: 1;
      padding: 8px;
      border: 1px solid var(--ig-border);
      border-radius: 6px;
      background: var(--ig-primary-background);
      color: var(--ig-primary-text);
      font-size: 14px;
    }

    .subtask-remove {
      background: none;
      border: none;
      color: var(--ig-secondary-text);
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s;
      flex-shrink: 0;
    }

    .subtask-remove:hover {
      background: var(--ig-hover);
      color: #ed4956;
    }

    .add-subtask-btn {
      background: var(--ig-secondary-background);
      border: 1px dashed var(--ig-border);
      color: var(--ig-blue);
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      transition: all 0.2s;
    }

    .add-subtask-btn:hover {
      background: var(--ig-hover);
      border-color: var(--ig-blue);
    }

    .progress-display {
      background: var(--ig-secondary-background);
      border: 1px solid var(--ig-border);
      border-radius: 8px;
      padding: 16px;
      text-align: center;
    }

    .progress-percentage {
      font-size: 32px;
      font-weight: 700;
      color: var(--ig-blue);
      margin-bottom: 4px;
    }

    .progress-label {
      font-size: 13px;
      color: var(--ig-secondary-text);
    }

    .task-modal-footer {
      padding: 20px;
      border-top: 1px solid var(--ig-border);
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    .task-btn {
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
    }

    .task-btn-secondary {
      background: var(--ig-secondary-background);
      color: var(--ig-primary-text);
    }

    .task-btn-secondary:hover {
      background: var(--ig-hover);
    }

    .task-btn-primary {
      background: var(--ig-blue);
      color: white;
    }

    .task-btn-primary:hover {
      background: #0081d6;
    }

    /* Note Editor */
    .note-editor {
      background: var(--ig-primary-background);
      border: 1px solid var(--ig-border);
      border-radius: 12px;
      padding: 16px;
    }

    .note-editor textarea {
      width: 100%;
      min-height: 300px;
      border: none;
      background: transparent;
      color: var(--ig-primary-text);
      font-size: 14px;
      font-family: 'Monaco', 'Courier New', monospace;
      resize: vertical;
      outline: none;
    }

    /* Modals */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      animation: fadeIn 0.2s;
    }

    .modal-content {
      background: var(--ig-primary-background);
      border-radius: 16px;
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      padding: 24px;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-title {
      font-size: 20px;
      font-weight: 600;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--ig-secondary-text);
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .form-input,
    .form-textarea,
    .form-select {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--ig-border);
      border-radius: 8px;
      background: var(--ig-secondary-background);
      color: var(--ig-primary-text);
      font-size: 14px;
    }

    .form-textarea {
      min-height: 100px;
      resize: vertical;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary {
      background: var(--ig-blue);
      color: white;
    }

    .btn-secondary {
      background: var(--ig-secondary-background);
      color: var(--ig-primary-text);
      border: 1px solid var(--ig-border);
    }

    .btn-danger {
      background: var(--ig-error);
      color: white;
    }

    .btn:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }

    .btn-icon {
      background: var(--ig-secondary-background);
      border: 1px solid var(--ig-border);
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .btn-icon:hover {
      background: var(--ig-hover);
      transform: translateY(-2px);
    }

    .btn-group {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }

    /* Empty States */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--ig-secondary-text);
    }

    .empty-icon {
      font-size: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .empty-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .empty-text {
      font-size: 14px;
    }

    /* Responsive */
    @media (max-width: 1200px) {
      .community-shell {
        grid-template-columns: 320px 1fr;
      }
      .community-right {
        display: none;
      }
    }

    @media (max-width: 768px) {
      .community-shell {
        grid-template-columns: 1fr;
      }
      .community-left {
        display: flex !important;
        position: relative;
        z-index: 1;
      }
      .community-center {
        display: none;
      }
      .community-center.mobile-active {
        display: flex;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 1000;
      }
      .community-right {
        display: none;
      }
      .community-right.mobile-active {
        display: flex;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 1000;
        background: var(--ig-primary-background);
      }
      .community-right.mobile-active .mobile-close-btn {
        display: block !important;
      }
      .mobile-back-btn {
        display: none !important;
      }
      .community-center.mobile-active .mobile-back-btn {
        display: flex !important;
      }
    }

    /* Loading */
    .loading {
      text-align: center;
      padding: 40px;
      color: var(--ig-secondary-text);
    }

    .spinner {
      border: 3px solid var(--ig-border);
      border-top-color: var(--ig-blue);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* File Upload */
    .file-upload {
      border: 2px dashed var(--ig-border);
      border-radius: 12px;
      padding: 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .file-upload:hover {
      border-color: var(--ig-blue);
      background: var(--ig-hover);
    }

    .file-upload.drag-over {
      border-color: var(--ig-blue);
      background: var(--ig-hover);
    }

    /* GitHub Integration */
    .github-connected {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: var(--ig-secondary-background);
      border: 1px solid var(--ig-border);
      border-radius: 10px;
      margin-bottom: 16px;
    }

    .github-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #24292e;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
    }

    .repo-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .repo-item {
      padding: 12px 16px;
      border: 1px solid var(--ig-border);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      transition: all 0.2s;
    }

    .repo-item:hover {
      border-color: var(--ig-blue);
      background: var(--ig-hover);
    }

    /* Responsive Members Modal */
    .members-modal {
      width: 90%;
      max-width: 900px;
      max-height: 90vh;
      border-radius: 16px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .members-modal-header {
      padding: 24px 28px;
      border-bottom: 1px solid var(--ig-border);
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      flex-shrink: 0;
    }

    .members-modal-body {
      padding: 20px;
      overflow-y: auto;
      flex: 1;
      background: var(--ig-secondary-background);
    }

    .members-modal-footer {
      padding: 20px 28px;
      border-top: 1px solid var(--ig-border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--ig-primary-background);
      flex-shrink: 0;
    }

    /* Members Grid - Uniform Cards */
    .members-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
      gap: 16px;
    }

    .member-card {
      background: var(--ig-primary-background);
      border: 2px solid var(--ig-border);
      border-radius: 12px;
      padding: 16px;
      transition: all 0.2s;
      display: flex;
      flex-direction: column;
      gap: 12px;
      min-height: 180px;
    }

    .member-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .member-card.member-admin {
      border-color: #667eea;
      background: linear-gradient(to bottom, rgba(102, 126, 234, 0.05) 0%, var(--ig-primary-background) 50%);
    }

    .member-card-header {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .member-avatar-wrapper {
      position: relative;
      cursor: pointer;
      flex-shrink: 0;
    }

    .member-avatar {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid var(--ig-border);
    }

    .member-admin .member-avatar {
      border-color: #667eea;
    }

    .member-online-dot {
      position: absolute;
      bottom: 0;
      right: 0;
      width: 16px;
      height: 16px;
      background: #44b700;
      border: 3px solid var(--ig-primary-background);
      border-radius: 50%;
    }

    .member-info {
      flex: 1;
      min-width: 0;
    }

    .member-name {
      font-weight: 600;
      font-size: 15px;
      color: var(--ig-primary-text);
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .member-badges {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .badge {
      padding: 2px 8px;
      border-radius: 6px;
      font-size: 10px;
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .badge-you {
      background: var(--ig-blue);
      color: white;
    }

    .badge-creator {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
    }

    .member-meta {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 8px 0;
      border-top: 1px solid var(--ig-border);
      border-bottom: 1px solid var(--ig-border);
    }

    .member-role {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 8px;
      font-size: 11px;
      font-weight: 600;
      flex-shrink: 0;
    }

    .role-admin {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .role-member {
      background: var(--ig-secondary-background);
      color: var(--ig-secondary-text);
    }

    .member-joined {
      color: var(--ig-secondary-text);
      font-size: 11px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .member-actions {
      display: flex;
      gap: 8px;
      margin-top: auto;
    }

    .member-btn {
      flex: 1;
      padding: 8px 12px;
      border: none;
      border-radius: 8px;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .btn-promote {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      color: white;
    }

    .btn-demote {
      background: var(--ig-secondary-background);
      color: var(--ig-primary-text);
      border: 1px solid var(--ig-border);
    }

    .btn-remove {
      background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%);
      color: white;
    }

    .member-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    .member-btn:active {
      transform: scale(0.98);
    }

    .member-protected {
      color: var(--ig-secondary-text);
      font-size: 11px;
      font-style: italic;
      text-align: center;
      padding: 8px;
      background: var(--ig-secondary-background);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      margin-top: auto;
    }

    /* Mobile: Full screen modal */
    @media (max-width: 768px) {
      .members-modal {
        width: 100%;
        max-width: 100%;
        height: 100vh;
        max-height: 100vh;
        border-radius: 0;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
      }

      .members-modal-header {
        padding: 20px 16px;
      }

      .members-modal-body {
        padding: 16px;
      }

      .members-grid {
        grid-template-columns: 1fr;
      }

      .member-actions {
        flex-direction: column;
      }

      .members-modal-footer {
        padding: 16px;
        flex-direction: column;
        gap: 12px;
      }

      .members-modal-footer > div {
        width: 100%;
        text-align: center;
      }

      .members-modal-footer button {
        width: 100%;
      }
    }

    /* Tablet: 2 columns */
    @media (min-width: 769px) and (max-width: 1024px) {
      .members-modal {
        width: 95%;
        max-width: 750px;
      }
      
      .members-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    /* Desktop: 2 columns */
    @media (min-width: 1025px) {
      .members-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
</head>
<body>
  <div class="community-shell">
    <!-- LEFT SIDEBAR -->
    <div class="community-left" id="communityLeft">
      <div class="left-header">
        <div style="display: flex; align-items: center; gap: 8px; justify-content: space-between; width: 100%;">
          <div style="display: flex; align-items: center; gap: 12px; flex: 1; min-width: 0;">
            <button onclick="window.location.href='/communities'" style="width: 40px; height: 40px; border-radius: 10px; background: var(--ig-blue); color: white; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; flex-shrink: 0; font-size: 18px; box-shadow: 0 2px 4px rgba(0, 149, 246, 0.3);" onmouseover="this.style.background='#0081d5'" onmouseout="this.style.background='var(--ig-blue)'" title="Back to Communities">
              <i class="fas fa-arrow-left"></i>
            </button>
            <img id="leftHeaderAvatar" src="" onclick="toggleRightSidebar()" style="width: 48px; height: 48px; border-radius: 50%; object-fit: cover; border: 2px solid var(--ig-border); flex-shrink: 0; display: none; cursor: pointer;">
            <div style="flex: 1; min-width: 0; cursor: pointer;" onclick="toggleRightSidebar()">
              <div class="community-title">
                <span id="communityName">Loading...</span>
              </div>
              <div class="community-subtitle" id="communitySubtitle">Community</div>
            </div>
          </div>
          <button onclick="toggleTheme()" style="width: 40px; height: 40px; border-radius: 50%; background: #FFD700; color: #000; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; flex-shrink: 0; font-size: 18px; box-shadow: 0 2px 8px rgba(255, 215, 0, 0.4);" onmouseover="this.style.background='#FFC700'; this.style.transform='scale(1.05)'" onmouseout="this.style.background='#FFD700'; this.style.transform='scale(1)'" title="Toggle Theme">
            <i class="fas fa-moon" id="themeIcon"></i>
          </button>
        </div>
      </div>

      <div class="left-tabs">
        <button class="left-tab active" onclick="switchLeftTab('announcements')">Announcements</button>
        <button class="left-tab" onclick="switchLeftTab('groups')">Groups</button>
        <button class="left-tab" onclick="switchLeftTab('folders')">Folders</button>
        <button class="left-tab" onclick="switchLeftTab('github')">GitHub</button>
      </div>

      <div class="left-content" id="leftContent">
        <!-- Content loads here -->
      </div>

      <div class="left-footer" id="leftFooter">
        <button class="btn btn-primary" style="width: 100%;" onclick="showCreateAnnouncementModal()" id="leftFooterBtn">
          <i class="fas fa-plus"></i> Create Announcement
        </button>
      </div>
    </div>

    <!-- CENTER PANEL -->
    <div class="community-center" id="communityCenter">
      <div class="center-header">
        <div class="header-left">
          <button class="ws-icon-btn mobile-back-btn" onclick="toggleLeftSidebar()" style="margin-right: 8px; display: none;" id="menuBtn">
            <i class="fas fa-arrow-left"></i>
          </button>
          <img id="centerHeaderAvatar" src="" style="width: 44px; height: 44px; border-radius: 50%; object-fit: cover; border: 2px solid var(--ig-border); margin-right: 8px; display: none;">
          <div>
            <h2 class="header-title" id="centerTitle">Announcements</h2>
            <p class="header-subtitle" id="centerSubtitle">Community updates and news</p>
          </div>
        </div>
        <div id="centerActions"></div>
      </div>

      <div class="center-tabs" id="centerTabs" style="display: none;">
        <!-- Tabs load dynamically -->
      </div>

      <div class="center-content" id="centerContent">
        <div class="empty-state">
          <div class="empty-icon">ðŸš€</div>
          <div class="empty-title">Welcome to your community!</div>
          <div class="empty-text">Select a group from the sidebar to start collaborating</div>
        </div>
      </div>

      <div class="center-footer" id="centerFooter" style="display: none;">
        <!-- Dynamic footer (chat input, etc.) -->
      </div>
    </div>

    <!-- RIGHT SIDEBAR -->
    <div class="community-right" id="communityRight">
      <!-- Mobile Close Button -->
      <button onclick="toggleRightSidebar()" style="display: none; position: fixed; top: 16px; right: 16px; width: 40px; height: 40px; border-radius: 50%; background: var(--ig-secondary-background); border: 1px solid var(--ig-border); color: var(--ig-primary-text); font-size: 20px; cursor: pointer; z-index: 10;" class="mobile-close-btn">
        <i class="fas fa-times"></i>
      </button>
      
      <div class="right-header">
        <div class="right-avatar" id="rightAvatar">
          <i class="fas fa-users"></i>
        </div>
        <div class="right-name" id="rightName">Community Name</div>
        <div class="right-meta" id="rightMeta">Community Â· 0 groups</div>
      </div>

      <div class="right-actions">
        <div class="right-action" onclick="inviteMembers()">
          <div class="action-circle">
            <i class="fas fa-link"></i>
          </div>
          <div class="action-label">Invite</div>
        </div>

        <div class="right-action" onclick="addMembers()">
          <div class="action-circle">
            <i class="fas fa-user-plus"></i>
          </div>
          <div class="action-label">Add members</div>
        </div>

        <div class="right-action" onclick="showCreateGroupModal()">
          <div class="action-circle">
            <i class="fas fa-users-cog"></i>
          </div>
          <div class="action-label">Add groups</div>
        </div>
      </div>

      <div class="right-section">
        <div class="section-title">DESCRIPTION</div>
        <div id="rightDescription" style="margin-bottom: 8px;">Loading...</div>
        <button class="btn-text" onclick="editCommunityProfile()" style="color: var(--ig-blue); font-size: 14px; font-weight: 600; background: none; border: none; cursor: pointer; padding: 0;">
          <i class="fas fa-edit"></i> Edit Profile
        </button>
      </div>

      <div class="menu-item" onclick="viewMembers()">
        <div class="menu-left">
          <div class="menu-icon"><i class="fas fa-users"></i></div>
          <div>View members</div>
        </div>
        <div id="memberCountBadge" style="color: var(--ig-secondary-text);">(0)</div>
      </div>

      <div class="menu-item" onclick="addMembers()">
        <div class="menu-left">
          <div class="menu-icon"><i class="fas fa-user-plus"></i></div>
          <div>Add members</div>
        </div>
        <i class="fas fa-chevron-right"></i>
      </div>

      <div class="menu-item" onclick="leaveCommunity()" style="color: var(--ig-error);">
        <div class="menu-left">
          <div class="menu-icon"><i class="fas fa-sign-out-alt"></i></div>
          <div>Leave community</div>
        </div>
        <i class="fas fa-chevron-right"></i>
      </div>

      <div class="menu-item" onclick="manageGroups()">
        <div class="menu-left">
          <div class="menu-icon"><i class="fas fa-users-cog"></i></div>
          <div>Manage groups</div>
        </div>
        <i class="fas fa-chevron-right"></i>
      </div>

      <div class="menu-item" onclick="viewAllGroups()">
        <div class="menu-left">
          <div class="menu-icon"><i class="fas fa-list"></i></div>
          <div>View groups</div>
        </div>
        <div id="groupCountBadge" style="color: var(--ig-secondary-text);">(0)</div>
      </div>

      <div class="menu-item" onclick="showCommunitySettings()">
        <div class="menu-left">
          <div class="menu-icon"><i class="fas fa-cog"></i></div>
          <div>Community settings</div>
        </div>
        <i class="fas fa-chevron-right"></i>
      </div>

      <div class="menu-item" onclick="showGitHubIntegration()">
        <div class="menu-left">
          <div class="menu-icon"><i class="fab fa-github"></i></div>
          <div>GitHub Integration</div>
        </div>
        <i class="fas fa-chevron-right"></i>
      </div>

      <!-- Admin Only Features -->
      <div id="adminOnlyFeatures" style="display: none;">
        <div style="margin: 16px 0; padding-top: 16px; border-top: 1px solid var(--ig-border);">
          <div class="section-title">ADMIN ACTIONS</div>
        </div>

        <div class="menu-item" onclick="showJoinRequests()" id="joinRequestsMenuItem" style="display: none;">
          <div class="menu-left">
            <div class="menu-icon"><i class="fas fa-user-check"></i></div>
            <div>Join Requests</div>
          </div>
          <div id="joinRequestsBadge" style="background: var(--ig-error); color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">0</div>
        </div>

        <div class="menu-item" onclick="clearAllAnnouncements()">
          <div class="menu-left">
            <div class="menu-icon"><i class="fas fa-trash-alt"></i></div>
            <div>Clear announcements</div>
          </div>
          <i class="fas fa-chevron-right"></i>
        </div>

        <div class="menu-item" onclick="deleteCommunity()" style="color: var(--ig-error);">
          <div class="menu-left">
            <div class="menu-icon" style="color: var(--ig-error);"><i class="fas fa-exclamation-triangle"></i></div>
            <div>Delete community</div>
          </div>
          <i class="fas fa-chevron-right"></i>
        </div>
      </div>
    </div>
  </div>

  <!-- Modals Container -->
  <div id="modalsContainer"></div>

  <script src="/socket.io/socket.io.js"></script>
  <script src="/js/app.js"></script>
  <script>
    // ==================== GLOBAL STATE ====================
    let state = {
      communityId: null,
      currentGroupId: null,
      currentAnnouncementId: null,
      currentView: 'announcements', // announcements, chat, calls, folders, tasks, notes
      socket: null,
      user: null,
      community: null,
      groups: [],
      currentCall: null,
      localStream: null,
      peerConnections: {},
      githubIntegration: null
    };

    // Expose state to window for external scripts (community-enhancements.js)
    window.state = state;

    // ==================== E2E ENCRYPTION MODULE ====================
    const E2EEncryption = {
      // Encryption key management
      keys: {},
      
      // Initialize encryption for a group - fetch shared key from server
      async initForGroup(groupId) {
        try {
          // Check if we already have the key cached
          if (this.keys[groupId]) {
            console.log(`ðŸ” E2E: Using cached key for group ${groupId}`);
            return true;
          }
          
          // Fetch the encryption key from server
          const response = await InnovateAPI.apiRequest(`/community-groups/${groupId}/encryption-key`);
          if (response.success && response.encryption_key) {
            this.keys[groupId] = response.encryption_key;
            console.log(`ðŸ” E2E: Fetched encryption key for group ${groupId}`);
            return true;
          } else {
            console.warn('E2E: No encryption key found for group', groupId);
            return false;
          }
        } catch (error) {
          console.error('E2E: Failed to fetch encryption key:', error);
          return false;
        }
      },
      
      // Encrypt message content
      encrypt(text, groupId) {
        try {
          if (!text || !groupId) return text;
          
          const key = this.keys[groupId];
          if (!key) {
            console.warn('E2E: No key found for group', groupId);
            return text;
          }
          
          const encrypted = CryptoJS.AES.encrypt(text, key).toString();
          console.log('ðŸ” E2E: Encrypted message');
          return encrypted;
        } catch (error) {
          console.error('E2E: Encryption failed:', error);
          return text; // Fallback to unencrypted
        }
      },
      
      // Decrypt message content
      decrypt(encryptedText, groupId) {
        try {
          if (!encryptedText || !groupId) return encryptedText;
          
          // Check if text looks like encrypted data
          if (!encryptedText.includes('U2FsdGVk')) {
            return encryptedText; // Not encrypted
          }
          
          // Use cached key
          const key = this.keys[groupId];
          if (!key) {
            console.warn('E2E: No key found for group', groupId);
            return encryptedText;
          }
          
          const decrypted = CryptoJS.AES.decrypt(encryptedText, key).toString(CryptoJS.enc.Utf8);
          console.log('ðŸ” E2E: Decrypted message');
          return decrypted || encryptedText; // Fallback if decryption fails
        } catch (error) {
          console.error('E2E: Decryption failed:', error);
          return encryptedText; // Return original if decryption fails
        }
      },
      
      // Encrypt file metadata
      encryptFileMetadata(filename, groupId) {
        try {
          return this.encrypt(filename, groupId);
        } catch (error) {
          console.error('E2E: File metadata encryption failed:', error);
          return filename;
        }
      },
      
      // Check if E2E is enabled for this group
      isEnabled(groupId) {
        return !!this.keys[groupId];
      },
      
      // Toggle E2E encryption for a group
      toggleForGroup(groupId, enabled) {
        if (enabled) {
          this.initForGroup(groupId);
        } else {
          delete this.keys[groupId];
          localStorage.removeItem(`e2e_key_${groupId}`);
        }
        console.log(`ðŸ” E2E: ${enabled ? 'Enabled' : 'Disabled'} for group ${groupId}`);
      }
    };

    // ==================== INITIALIZATION ====================
    document.addEventListener('DOMContentLoaded', async () => {
      if (!InnovateAPI.requireAuth()) return;
      
      state.user = InnovateAPI.getCurrentUser();
      state.socket = InnovateAPI.initSocket();
      
      // Initialize theme icon
      initializeThemeIcon();
      
      // Get community ID from URL
      const urlParams = new URLSearchParams(window.location.search);
      state.communityId = urlParams.get('id') || window.location.pathname.split('/').pop();
      
      // Check if there's a group parameter in URL
      const groupIdFromUrl = urlParams.get('groupId');
      console.log('=== DOMContentLoaded Initialization ===');
      console.log('Community ID:', state.communityId);
      console.log('Group ID from URL:', groupIdFromUrl);

      await Promise.all([
        loadCommunityData()
      ]);
      console.log('Community data loaded');

      // Load groups first
      await loadGroups();
      console.log('Groups loaded, count:', state.groups.length);
      
      // Always start with Announcements tab on page load/refresh
      // Clear any groupId from URL to start fresh
      if (groupIdFromUrl) {
        console.log('Clearing groupId from URL to start fresh');
        const url = new URL(window.location);
        url.searchParams.delete('groupId');
        window.history.replaceState({}, '', url);
      }
      
      // Initialize right sidebar with community view
      updateRightSidebarForCommunity();
      
      console.log('Starting with Announcements tab (default)');
      // Show announcements by default (Announcements tab is already active)
      await loadAnnouncements();

      setupSocketListeners();
      setupResponsive();
    });

    // ==================== SOCKET LISTENERS ====================
    function setupSocketListeners() {
      if (!state.socket) return;

      state.socket.on('announcement:new', (data) => {
        if (data.communityId == state.communityId) loadAnnouncements();
      });

      state.socket.on('group:new', (data) => {
        if (data.communityId == state.communityId) loadGroups();
      });

      state.socket.on('group:message', (data) => {
        if (data.groupId == state.currentGroupId) appendChatMessage(data.message);
      });
      
      // Listen for community group posts (real-time messages)
      state.socket.on('community-group:post:new', (data) => {
        console.log('Real-time message received:', data);
        if (data.group_id == state.currentGroupId) {
          appendChatMessage(data);
        }
        // Update groups list to show latest message
        loadGroups();
      });
      
      state.socket.on('poll:voted', (data) => {
        // Update poll display in real-time if viewing this announcement
        const pollElement = document.getElementById(`poll-${data.announcementId}`);
        if (pollElement) {
          const poll = {
            question: data.results.options.join(' / '), // This will be replaced by actual poll data
            options: data.results.options,
            votes: [] // Backend sends counts directly, not individual votes
          };
          // Just reload the announcement to get fresh data
          if (state.currentLeftTab === 'announcements' && state.currentAnnouncementId === data.announcementId) {
            viewAnnouncement(data.announcementId);
          }
        }
      });

      state.socket.on('call:offer', handleCallOffer);
      state.socket.on('call:answer', handleCallAnswer);
      state.socket.on('call:ice-candidate', handleIceCandidate);
      state.socket.on('call:peer-joined', handlePeerJoined);
      state.socket.on('call:peer-left', handlePeerLeft);
    }

    // ==================== DATA LOADING ====================
    async function loadCommunityData() {
      try {
        const res = await InnovateAPI.apiRequest(`/communities/${state.communityId}`);
        if (res.success) {
          state.community = res.community;
          document.getElementById('communityName').textContent = res.community.name;
          document.getElementById('communitySubtitle').textContent = res.community.description || 'Community';
          document.getElementById('rightName').textContent = res.community.name;
          document.getElementById('rightDescription').textContent = res.community.description || 'No description';
          
          // Load member count
          try {
            const membersRes = await InnovateAPI.apiRequest(`/communities/${state.communityId}/members`);
            if (membersRes.success) {
              const memberCount = membersRes.members.length;
              document.getElementById('rightMeta').textContent = `Community Â· ${memberCount} member${memberCount !== 1 ? 's' : ''}`;
              
              // Update member count badge
              const memberCountBadge = document.getElementById('memberCountBadge');
              if (memberCountBadge) {
                memberCountBadge.textContent = `(${memberCount})`;
              }
            }
          } catch (err) {
            console.error('Error loading member count:', err);
            document.getElementById('rightMeta').textContent = `Community Â· 0 members`;
          }
          
          // Update community avatar/banner in all locations
          const rightAvatar = document.getElementById('rightAvatar');
          const leftHeaderAvatar = document.getElementById('leftHeaderAvatar');
          const centerHeaderAvatar = document.getElementById('centerHeaderAvatar');
          
          if (res.community.banner_image && res.community.banner_image.trim() !== '') {
            // Only try to load if it's a valid path
            const imgSrc = res.community.banner_image.startsWith('/') ? res.community.banner_image : `/uploads/community/${res.community.banner_image}`;
            console.log('Loading community banner from:', imgSrc);
            
            // Right sidebar avatar
            rightAvatar.innerHTML = `<img src="${imgSrc}" 
              onerror="console.error('Failed to load banner:', this.src); this.parentElement.innerHTML='<i class=\\'fas fa-users\\'></i>'" 
              onload="console.log('Banner loaded successfully:', this.src)"
              style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
            
            // Left header avatar
            leftHeaderAvatar.src = imgSrc;
            leftHeaderAvatar.style.display = 'block';
            leftHeaderAvatar.onerror = () => {
              leftHeaderAvatar.style.display = 'none';
            };
            
            // Center header avatar
            centerHeaderAvatar.src = imgSrc;
            centerHeaderAvatar.style.display = 'block';
            centerHeaderAvatar.onerror = () => {
              centerHeaderAvatar.style.display = 'none';
            };
          } else {
            console.log('No banner image, using default icon');
            rightAvatar.innerHTML = '<i class="fas fa-users"></i>';
            leftHeaderAvatar.style.display = 'none';
            centerHeaderAvatar.style.display = 'none';
          }
          
          // Update admin features visibility
          updateAdminFeatures();
        }
      } catch (error) {
        console.error('Error loading community:', error);
      }
    }

    async function loadGroups() {
      try {
        const res = await InnovateAPI.apiRequest(`/communities/${state.communityId}/groups`);
        if (res.success) {
          state.groups = res.groups || [];
          
          // Fetch latest message for each group
          for (let group of state.groups) {
            try {
              const postsRes = await InnovateAPI.apiRequest(`/community-groups/${group.id}/posts`);
              if (postsRes.success && postsRes.posts && postsRes.posts.length > 0) {
                const sortedPosts = postsRes.posts.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                group.latest_message = sortedPosts[0].content || 'Attachment';
                group.unread_count = 0; // TODO: Implement unread tracking
              }
            } catch (err) {
              // No posts for this group
            }
          }
          
          document.getElementById('groupCountBadge').textContent = `(${state.groups.length})`;
          renderGroupsList();
        }
      } catch (error) {
        console.error('Error loading groups:', error);
      }
    }

    async function loadAnnouncements() {
      try {
        const res = await InnovateAPI.apiRequest(`/communities/${state.communityId}/announcements`);
        if (res.success) {
          renderAnnouncements(res.announcements || []);
        }
      } catch (error) {
        console.error('Error loading announcements:', error);
      }
    }

    // ==================== UI RENDERING ====================
    function renderGroupsList() {
      console.log('renderGroupsList called');
      console.log('Current groups count:', state.groups.length);
      
      // Only render if groups tab is active - use Array.from to avoid quote escaping issues
      const tabs = document.querySelectorAll('.left-tab');
      const groupsTab = Array.from(tabs).find(tab => tab.textContent.trim() === 'Groups');
      console.log('Groups tab element:', groupsTab);
      console.log('Groups tab active?:', groupsTab?.classList.contains('active'));
      
      if (!groupsTab || !groupsTab.classList.contains('active')) {
        console.log('Groups loaded but not displayed (wrong tab active) - EXITING renderGroupsList');
        return;
      }
      
      console.log('Groups tab is active, proceeding with render');
      
      const content = document.getElementById('leftContent');
      const centerContent = document.getElementById('centerContent');
      
      // Only show default center content if no group is currently selected
      if (!state.currentGroupId) {
        console.log('No group selected, showing default empty state');
        centerContent.innerHTML = `
          <div class="empty-state" style="height: 100%; display: flex; flex-direction: column; justify-content: center;">
            <div class="empty-icon">ðŸ‘¥</div>
            <div class="empty-title">Select a group</div>
            <div class="empty-text">Choose from the left sidebar</div>
          </div>
        `;
      } else {
        console.log('Group is selected (ID:', state.currentGroupId, '), NOT clearing center content');
      }
      
      if (state.groups.length === 0) {
        content.innerHTML = `
          <div class="empty-state" style="padding: 60px 20px; text-align: center;">
            <div style="width: 80px; height: 80px; margin: 0 auto 20px; border-radius: 20px; background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 36px;">
              <i class="fas fa-users"></i>
            </div>
            <div style="font-size: 18px; font-weight: 700; margin-bottom: 8px; color: var(--ig-primary-text);">No groups yet</div>
            <div style="font-size: 14px; color: var(--ig-secondary-text); margin-bottom: 24px;">Create your first group to get started</div>
          </div>
        `;
        return;
      }

      content.innerHTML = state.groups.map(group => {
        const latestMsg = group.latest_message || '';
        // Attempt decryption for preview if content appears encrypted
        const previewMsg = E2EEncryption.decrypt(latestMsg, group.id);
        const unreadCount = group.unread_count || 0;
        const truncatedMsg = previewMsg.length > 30 ? previewMsg.substring(0, 30) + '...' : previewMsg;
        
        // Check if description is a URL and make it clickable
        let displayDesc = group.description || 'No messages yet';
        const urlPattern = /^(https?:\/\/[^\s]+)$/;
        if (urlPattern.test(displayDesc)) {
          displayDesc = `<a href="${displayDesc}" target="_blank" onclick="event.stopPropagation()" style="color: var(--ig-blue); text-decoration: none; font-weight: 500;">ðŸ”— ${displayDesc}</a>`;
        }
        
        return `
          <div class="group-item ${state.currentGroupId == group.id ? 'active' : ''}" onclick="selectGroup(${group.id})">
            <div class="group-avatar">${group.name.charAt(0).toUpperCase()}</div>
            <div class="group-info">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                <div class="group-name">${group.name}</div>
                ${unreadCount > 0 ? `<span style="background: var(--ig-blue); color: white; border-radius: 12px; padding: 2px 8px; font-size: 11px; font-weight: 600;">${unreadCount}</span>` : ''}
              </div>
              <div class="group-desc" style="color: ${previewMsg ? 'var(--ig-primary-text)' : 'var(--ig-secondary-text)'}; font-weight: ${unreadCount > 0 ? '600' : '400'};">
                ${previewMsg ? truncatedMsg : displayDesc}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderFoldersList() {
      const content = document.getElementById('leftContent');
      const centerContent = document.getElementById('centerContent');
      
      // Always show Announcements folder first
      let foldersHTML = `
        <div class="group-item" onclick="openAnnouncementsFolder()">
          <div class="group-avatar" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
            <i class="fas fa-bullhorn"></i>
          </div>
          <div class="group-info">
            <div class="group-name">Announcements</div>
            <div class="group-desc">Announcement files & attachments</div>
          </div>
          <i class="fas fa-chevron-right" style="color: var(--ig-secondary-text); font-size: 14px;"></i>
        </div>
      `;
      
      // Add group folders
      if (state.groups.length > 0) {
        foldersHTML += state.groups.map(group => `
          <div class="group-item" onclick="openGroupFolder(${group.id})">
            <div class="group-avatar" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
              <i class="fas fa-folder"></i>
            </div>
            <div class="group-info">
              <div class="group-name">${group.name}</div>
              <div class="group-desc">Group folder Â· Files & resources</div>
            </div>
            <i class="fas fa-chevron-right" style="color: var(--ig-secondary-text); font-size: 14px;"></i>
          </div>
        `).join('');
      }
      
      content.innerHTML = foldersHTML;

      // Show empty state in center
      centerContent.innerHTML = `
        <div class="empty-state" style="height: 100%; display: flex; flex-direction: column; justify-content: center;">
          <div class="empty-icon">ðŸ“‚</div>
          <div class="empty-title">Select a folder</div>
          <div class="empty-text">Click on a folder from the left to view its contents</div>
        </div>
      `;
    }
    
    function openAnnouncementsFolder() {
      const centerContent = document.getElementById('centerContent');
      
      centerContent.innerHTML = `
        <div style="padding: 24px; max-width: 900px; margin: 0 auto;">
          <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid var(--ig-border);">
            <div style="width: 56px; height: 56px; border-radius: 12px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 24px;">
              <i class="fas fa-bullhorn"></i>
            </div>
            <div style="flex: 1;">
              <h2 style="margin: 0; font-size: 22px;">Announcements</h2>
              <div style="color: var(--ig-secondary-text); font-size: 14px; margin-top: 4px;">
                All announcement attachments and files
              </div>
            </div>
            <button class="btn btn-primary" onclick="switchLeftTab('announcements')">
              <i class="fas fa-arrow-right"></i> View Announcements
            </button>
          </div>
          
          <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 16px;">
            <!-- Images Section -->
            <div onclick="loadAnnouncementFiles('images')" style="background: var(--ig-secondary-background); border: 1px solid var(--ig-border); border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 16px rgba(0,0,0,0.2)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
              <div style="width: 48px; height: 48px; border-radius: 12px; background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; margin-bottom: 12px;">
                <i class="fas fa-image"></i>
              </div>
              <h3 style="margin: 0 0 8px 0; font-size: 16px;">Images</h3>
              <p style="margin: 0; color: var(--ig-secondary-text); font-size: 13px;">Photos from announcements</p>
            </div>

            <!-- Videos Section -->
            <div onclick="loadAnnouncementFiles('videos')" style="background: var(--ig-secondary-background); border: 1px solid var(--ig-border); border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 16px rgba(0,0,0,0.2)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
              <div style="width: 48px; height: 48px; border-radius: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; margin-bottom: 12px;">
                <i class="fas fa-video"></i>
              </div>
              <h3 style="margin: 0 0 8px 0; font-size: 16px;">Videos</h3>
              <p style="margin: 0; color: var(--ig-secondary-text); font-size: 13px;">Video attachments</p>
            </div>

            <!-- Documents Section -->
            <div onclick="loadAnnouncementFiles('documents')" style="background: var(--ig-secondary-background); border: 1px solid var(--ig-border); border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 16px rgba(0,0,0,0.2)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
              <div style="width: 48px; height: 48px; border-radius: 12px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; margin-bottom: 12px;">
                <i class="fas fa-file-alt"></i>
              </div>
              <h3 style="margin: 0 0 8px 0; font-size: 16px;">Documents</h3>
              <p style="margin: 0; color: var(--ig-secondary-text); font-size: 13px;">PDFs, docs, and files</p>
            </div>

            <!-- Links Section -->
            <div onclick="loadAnnouncementFiles('links')" style="background: var(--ig-secondary-background); border: 1px solid var(--ig-border); border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 16px rgba(0,0,0,0.2)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
              <div style="width: 48px; height: 48px; border-radius: 12px; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; margin-bottom: 12px;">
                <i class="fas fa-link"></i>
              </div>
              <h3 style="margin: 0 0 8px 0; font-size: 16px;">Links</h3>
              <p style="margin: 0; color: var(--ig-secondary-text); font-size: 13px;">Shared links from announcements</p>
            </div>
          </div>

          <div style="margin-top: 24px; padding: 20px; background: var(--ig-secondary-background); border: 1px solid var(--ig-border); border-radius: 12px;">
            <h3 style="margin: 0 0 12px 0; font-size: 14px; font-weight: 600; color: var(--ig-secondary-text);">
              <i class="fas fa-info-circle"></i> About Announcements Folder
            </h3>
            <p style="margin: 0; font-size: 13px; color: var(--ig-secondary-text); line-height: 1.6;">
              All files, images, videos, and links shared in announcements are organized here for easy access.
              Click on any category above to view the files.
            </p>
          </div>
        </div>
      `;
    }

    function openGroupFolder(groupId) {
      const group = state.groups.find(g => g.id == groupId);
      if (!group) return;

      const centerContent = document.getElementById('centerContent');
      
      centerContent.innerHTML = `
        <div style="padding: 24px; max-width: 900px; margin: 0 auto;">
          <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid var(--ig-border);">
            <div style="width: 56px; height: 56px; border-radius: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 24px;">
              <i class="fas fa-folder-open"></i>
            </div>
            <div style="flex: 1;">
              <h2 style="margin: 0; font-size: 22px;">${group.name}</h2>
              <div style="color: var(--ig-secondary-text); font-size: 14px; margin-top: 4px;">
                Group folder Â· ${group.description || 'No description'}
              </div>
            </div>
            <button class="btn btn-primary" onclick="selectGroup(${group.id})">
              <i class="fas fa-arrow-right"></i> Open Group
            </button>
          </div>
          
          <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 16px;">
            <!-- Files Section - FIXED: Goes directly to folders view -->
            <div style="background: var(--ig-secondary-background); border: 1px solid var(--ig-border); border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.2s;" onclick="openGroupFolderView(${group.id});">
              <div style="width: 48px; height: 48px; border-radius: 12px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; margin-bottom: 12px;">
                <i class="fas fa-file-alt"></i>
              </div>
              <h3 style="margin: 0 0 8px 0; font-size: 16px;">Files</h3>
              <p style="margin: 0; color: var(--ig-secondary-text); font-size: 13px;">Documents, images, and more</p>
            </div>

            <!-- Links Section -->
            <div style="background: var(--ig-secondary-background); border: 1px solid var(--ig-border); border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.2s;" onclick="state.currentGroupId=${group.id}; openFolder('links');">
              <div style="width: 48px; height: 48px; border-radius: 12px; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; margin-bottom: 12px;">
                <i class="fas fa-link"></i>
              </div>
              <h3 style="margin: 0 0 8px 0; font-size: 16px;">Links</h3>
              <p style="margin: 0; color: var(--ig-secondary-text); font-size: 13px;">Shared links and resources</p>
            </div>

            <!-- Tasks Section -->
            <div style="background: var(--ig-secondary-background); border: 1px solid var(--ig-border); border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.2s;" onclick="state.currentGroupId=${group.id}; state.currentView='tasks'; selectGroup(${group.id}); switchCenterTab('tasks');">
              <div style="width: 48px; height: 48px; border-radius: 12px; background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; margin-bottom: 12px;">
                <i class="fas fa-tasks"></i>
              </div>
              <h3 style="margin: 0 0 8px 0; font-size: 16px;">To-Do</h3>
              <p style="margin: 0; color: var(--ig-secondary-text); font-size: 13px;">Group tasks and assignments</p>
            </div>

            <!-- Notes Section -->
            <div style="background: var(--ig-secondary-background); border: 1px solid var(--ig-border); border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.2s;" onclick="state.currentGroupId=${group.id}; state.currentView='notes'; selectGroup(${group.id}); switchCenterTab('notes');">
              <div style="width: 48px; height: 48px; border-radius: 12px; background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; margin-bottom: 12px;">
                <i class="fas fa-sticky-note"></i>
              </div>
              <h3 style="margin: 0 0 8px 0; font-size: 16px;">Notes</h3>
              <p style="margin: 0; color: var(--ig-secondary-text); font-size: 13px;">Collaborative documents</p>
            </div>
          </div>

          <div style="margin-top: 24px; padding: 20px; background: var(--ig-secondary-background); border: 1px solid var(--ig-border); border-radius: 12px;">
            <h3 style="margin: 0 0 12px 0; font-size: 14px; font-weight: 600; color: var(--ig-secondary-text);">
              <i class="fas fa-info-circle"></i> About Folders
            </h3>
            <p style="margin: 0; font-size: 13px; color: var(--ig-secondary-text); line-height: 1.6;">
              Each group has its own dedicated folder to organize files, links, tasks, and notes. 
              Click on any section above or use the "Open Group" button to access the full workspace.
            </p>
          </div>
        </div>
      `;
    }
    
    async function loadAnnouncementFiles(type) {
      try {
        const res = await InnovateAPI.apiRequest(`/communities/${state.communityId}/announcements`);
        const announcements = res.announcements || [];
        
        // Extract all files from announcements
        const allFiles = [];
        announcements.forEach(ann => {
          if (ann.attachments) {
            try {
              const attachments = JSON.parse(ann.attachments);
              if (attachments.files && Array.isArray(attachments.files)) {
                attachments.files.forEach(file => {
                  allFiles.push({
                    ...file,
                    announcementId: ann.id,
                    announcementTitle: ann.title,
                    createdAt: ann.created_at
                  });
                });
              }
              
              // Add links if type is 'links'
              if (type === 'links' && attachments.links && Array.isArray(attachments.links)) {
                attachments.links.forEach(link => {
                  allFiles.push({
                    ...link,
                    type: 'link',
                    announcementId: ann.id,
                    announcementTitle: ann.title,
                    createdAt: ann.created_at
                  });
                });
              }
            } catch (e) {
              console.error('Error parsing attachments:', e);
            }
          }
        });
        
        // Filter by type
        let filteredFiles = allFiles;
        if (type === 'images') {
          filteredFiles = allFiles.filter(f => f.type && f.type.startsWith('image/'));
        } else if (type === 'videos') {
          filteredFiles = allFiles.filter(f => f.type && f.type.startsWith('video/'));
        } else if (type === 'documents') {
          filteredFiles = allFiles.filter(f => f.type && (f.type.includes('pdf') || f.type.includes('document') || f.type.includes('msword')));
        } else if (type === 'links') {
          filteredFiles = allFiles.filter(f => f.type === 'link');
        }
        
        // Display files
        const centerContent = document.getElementById('centerContent');
        const typeIcon = type === 'images' ? 'fa-image' : type === 'videos' ? 'fa-video' : type === 'documents' ? 'fa-file-alt' : 'fa-link';
        const typeLabel = type.charAt(0).toUpperCase() + type.slice(1);
        
        centerContent.innerHTML = `
          <div style="padding: 24px; max-width: 1200px; margin: 0 auto;">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid var(--ig-border);">
              <div style="display: flex; align-items: center; gap: 16px;">
                <button onclick="openAnnouncementsFolder()" style="width: 44px; height: 44px; border-radius: 12px; background: var(--ig-blue); color: white; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 8px rgba(0,149,246,0.3);" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 12px rgba(0,149,246,0.4)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 8px rgba(0,149,246,0.3)'">
                  <i class="fas fa-arrow-left" style="font-size: 18px;"></i>
                </button>
                <div>
                  <h2 style="margin: 0; font-size: 22px; display: flex; align-items: center; gap: 12px;">
                    <i class="fas ${typeIcon}" style="color: var(--ig-blue);"></i>
                    ${typeLabel}
                  </h2>
                  <div style="color: var(--ig-secondary-text); font-size: 14px; margin-top: 4px;">
                    ${filteredFiles.length} ${filteredFiles.length === 1 ? 'item' : 'items'} found
                  </div>
                </div>
              </div>
              <button onclick="openAnnouncementsFolder()" style="padding: 10px 20px; background: var(--ig-secondary-background); color: var(--ig-primary-text); border: 1px solid var(--ig-border); border-radius: 10px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s;" onmouseover="this.style.background='var(--ig-hover)'" onmouseout="this.style.background='var(--ig-secondary-background)'">
                <i class="fas fa-arrow-left"></i> Back to Folders
              </button>
            </div>
            
            ${filteredFiles.length === 0 ? `
              <div class="empty-state">
                <div class="empty-icon"><i class="fas ${typeIcon}"></i></div>
                <div class="empty-title">No ${type} found</div>
                <div class="empty-text">Upload files in announcements to see them here</div>
              </div>
            ` : `
              <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(${type === 'links' ? '100%' : '280px'}, 1fr)); gap: 16px;">
                ${filteredFiles.map(file => {
                  if (type === 'links') {
                    return `
                      <a href="${file.url}" target="_blank" style="background: var(--ig-secondary-background); border: 1px solid var(--ig-border); border-radius: 12px; padding: 16px; text-decoration: none; transition: all 0.2s; display: flex; align-items: center; gap: 16px;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                        <div style="width: 48px; height: 48px; border-radius: 10px; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                          <i class="fas fa-external-link-alt" style="color: white; font-size: 20px;"></i>
                        </div>
                        <div style="flex: 1; min-width: 0;">
                          <div style="font-weight: 600; font-size: 15px; color: var(--ig-primary-text); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${file.title || 'Untitled Link'}</div>
                          <div style="font-size: 13px; color: var(--ig-blue); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin-top: 2px;">${file.url}</div>
                          <div style="font-size: 12px; color: var(--ig-secondary-text); margin-top: 4px;">From: ${file.announcementTitle}</div>
                        </div>
                        <i class="fas fa-chevron-right" style="color: var(--ig-secondary-text);"></i>
                      </a>
                    `;
                  }
                  
                  // Normalize URL
                  let fileUrl = file.url;
                  if (!fileUrl.startsWith('http')) {
                    fileUrl = window.location.origin + (fileUrl.startsWith('/') ? fileUrl : '/' + fileUrl);
                  } else {
                    try {
                      const urlObj = new URL(fileUrl);
                      urlObj.protocol = window.location.protocol;
                      urlObj.host = window.location.host;
                      fileUrl = urlObj.toString();
                    } catch (e) {
                      const pathMatch = fileUrl.match(/\/uploads\/.+$/);
                      if (pathMatch) {
                        fileUrl = window.location.origin + pathMatch[0];
                      }
                    }
                  }
                  
                  const extension = file.name.split('.').pop().toLowerCase();
                  const isImage = type === 'images';
                  const isVideo = type === 'videos';
                  
                  return `
                    <div style="background: var(--ig-secondary-background); border: 1px solid var(--ig-border); border-radius: 12px; overflow: hidden; transition: all 0.2s;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 16px rgba(0,0,0,0.2)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                      ${isImage ? `
                        <div onclick="window.open('${fileUrl}', '_blank')" style="width: 100%; aspect-ratio: 16/9; background: #000; overflow: hidden; cursor: pointer; position: relative;">
                          <img src="${fileUrl}" alt="${file.name}" style="width: 100%; height: 100%; object-fit: cover; display: block;" loading="lazy" onerror="this.parentElement.innerHTML='<div style=\\'display:flex;align-items:center;justify-content:center;height:100%;color:#888;\\'><i class=\\'fas fa-image\\' style=\\'font-size:48px;\\'></i></div>'">
                        </div>
                      ` : isVideo ? `
                        <div style="width: 100%; aspect-ratio: 16/9; background: #000; overflow: hidden;">
                          <video controls style="width: 100%; height: 100%; object-fit: contain; display: block;">
                            <source src="${fileUrl}" type="${file.type}">
                          </video>
                        </div>
                      ` : `
                        <div onclick="window.open('${fileUrl}', '_blank')" style="width: 100%; aspect-ratio: 16/9; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); display: flex; align-items: center; justify-content: center; cursor: pointer; flex-direction: column; gap: 12px;">
                          <i class="fas fa-file-pdf" style="font-size: 72px; color: rgba(255,255,255,0.95);"></i>
                          <span style="color: rgba(255,255,255,0.9); font-size: 14px; font-weight: 600;">Click to view</span>
                        </div>
                      `}
                      
                      <div style="padding: 12px;">
                        <div style="font-weight: 600; font-size: 14px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: var(--ig-primary-text); margin-bottom: 4px;" title="${file.name}">${file.name}</div>
                        <div style="font-size: 12px; color: var(--ig-secondary-text); margin-bottom: 8px;">${file.size || 'Unknown size'}</div>
                        <div style="font-size: 11px; color: var(--ig-secondary-text); border-top: 1px solid var(--ig-border); padding-top: 8px;">
                          From: ${file.announcementTitle}
                        </div>
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
            `}
          </div>
        `;
        
      } catch (error) {
        console.error('Error loading files:', error);
      }
    }

    function renderGitHubView() {
      const content = document.getElementById('leftContent');
      const centerContent = document.getElementById('centerContent');

      // Check if GitHub integration exists for this community
      content.innerHTML = `
        <div class="empty-state">
          <div class="empty-icon">
            <i class="fab fa-github" style="font-size: 48px;"></i>
          </div>
          <div class="empty-title">GitHub Integration</div>
          <div class="empty-text">Connect your GitHub repositories to this community</div>
        </div>
      `;

      centerContent.innerHTML = `
        <div style="padding: 24px; max-width: 900px; margin: 0 auto;">
          <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid var(--ig-border);">
            <div style="width: 56px; height: 56px; border-radius: 12px; background: linear-gradient(135deg, #24292e 0%, #586069 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 24px;">
              <i class="fab fa-github"></i>
            </div>
            <div style="flex: 1;">
              <h2 style="margin: 0; font-size: 22px;">GitHub Integration</h2>
              <div style="color: var(--ig-secondary-text); font-size: 14px; margin-top: 4px;">
                Sync repositories, issues, and pull requests
              </div>
            </div>
          </div>

          <div style="background: var(--ig-secondary-background); border: 1px solid var(--ig-border); border-radius: 12px; padding: 24px; margin-bottom: 20px;">
            <h3 style="margin: 0 0 16px 0; font-size: 16px;">
              <i class="fas fa-link"></i> Connect GitHub Repository
            </h3>
            <p style="margin: 0 0 20px 0; color: var(--ig-secondary-text); font-size: 14px; line-height: 1.6;">
              Link a GitHub repository to this community to automatically sync issues, pull requests, and commits. 
              Members can view repository activity directly in the community workspace.
            </p>
            
            <div style="display: grid; gap: 12px;">
              <input type="text" placeholder="Organization name (e.g., facebook)" style="width: 100%; padding: 12px; border: 1px solid var(--ig-border); border-radius: 8px; background: var(--ig-primary-background); color: var(--ig-primary-text);">
              <input type="text" placeholder="Repository name (e.g., react)" style="width: 100%; padding: 12px; border: 1px solid var(--ig-border); border-radius: 8px; background: var(--ig-primary-background); color: var(--ig-primary-text);">
              <input type="password" placeholder="GitHub Access Token (optional)" style="width: 100%; padding: 12px; border: 1px solid var(--ig-border); border-radius: 8px; background: var(--ig-primary-background); color: var(--ig-primary-text);">
              
              <button class="btn btn-primary" style="margin-top: 8px;">
                <i class="fab fa-github"></i> Connect Repository
              </button>
            </div>
          </div>

          <div style="background: var(--ig-secondary-background); border: 1px solid var(--ig-border); border-radius: 12px; padding: 24px;">
            <h3 style="margin: 0 0 12px 0; font-size: 16px;">
              <i class="fas fa-info-circle"></i> Features
            </h3>
            <ul style="margin: 0; padding-left: 20px; color: var(--ig-secondary-text); font-size: 14px; line-height: 1.8;">
              <li>View repository issues and pull requests</li>
              <li>Track commits and branch activity</li>
              <li>Create issues directly from community</li>
              <li>Link tasks to GitHub issues</li>
              <li>Receive notifications for repository updates</li>
              <li>Collaborate on code reviews</li>
            </ul>
          </div>
        </div>
      `;
    }

    function renderAnnouncements(announcements) {
      const content = document.getElementById('leftContent');
      const centerContent = document.getElementById('centerContent');
      const footer = document.getElementById('centerFooter');
      
      // Show create announcement button for admins/moderators
      footer.innerHTML = `
        <button class="btn btn-primary" style="width: 100%;" onclick="showCreateAnnouncementModal()">
          <i class="fas fa-bullhorn"></i> Create Announcement
        </button>
      `;
      footer.style.display = 'block';
      
      if (announcements.length === 0) {
        content.innerHTML = `
          <div class="empty-state" style="padding: 60px 20px; text-align: center;">
            <div style="width: 80px; height: 80px; margin: 0 auto 20px; border-radius: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 36px;">
              <i class="fas fa-bullhorn"></i>
            </div>
            <div style="font-size: 18px; font-weight: 700; margin-bottom: 8px; color: var(--ig-primary-text);">No announcements</div>
            <div style="font-size: 14px; color: var(--ig-secondary-text);">Admins can post important updates here</div>
          </div>
        `;
        centerContent.innerHTML = `
          <div class="empty-state" style="height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 40px;">
            <div style="width: 96px; height: 96px; margin-bottom: 24px; border-radius: 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 48px;">
              <i class="fas fa-bullhorn"></i>
            </div>
            <div style="font-size: 24px; font-weight: 700; margin-bottom: 12px; color: var(--ig-primary-text);">Welcome to Announcements</div>
            <div style="font-size: 15px; color: var(--ig-secondary-text); max-width: 500px; line-height: 1.6;">Create your first announcement with messages, attachments, links, and location</div>
          </div>
        `;
        return;
      }

      content.innerHTML = announcements.map(ann => `
        <div class="group-item ${state.currentAnnouncementId == ann.id ? 'active' : ''}" onclick="viewAnnouncement(${ann.id})">
          <div class="group-avatar"><i class="fas fa-bullhorn"></i></div>
          <div class="group-info">
            <div class="group-name">${ann.title || 'Announcement'}</div>
            <div class="group-desc">${InnovateAPI.formatDate(ann.created_at)} Â· ${ann.author_username}</div>
          </div>
          ${ann.is_pinned ? '<i class="fas fa-thumbtack" style="color: var(--ig-blue);"></i>' : ''}
        </div>
      `).join('');
      
      // Show first announcement by default (but NOT on mobile to keep list view)
      if (announcements.length > 0 && !state.currentAnnouncementId) {
        // Only auto-show first announcement on desktop (width > 768px)
        if (window.innerWidth > 768) {
          viewAnnouncement(announcements[0].id);
        }
      }
    }
    
    function viewAnnouncement(announcementId) {
      // Show center panel on mobile when announcement is selected
      const centerPanel = document.getElementById('communityCenter');
      if (window.innerWidth <= 768 && centerPanel) {
        centerPanel.classList.add('mobile-active');
      }
      
      state.currentAnnouncementId = announcementId;
      const centerContent = document.getElementById('centerContent');
      
      // Find announcement
      InnovateAPI.apiRequest(`/communities/${state.communityId}/announcements`)
        .then(res => {
          const ann = res.announcements.find(a => a.id == announcementId);
          if (!ann) return;
          
          // Parse attachments
          let attachments = [];
          let links = [];
          let location = null;
          let poll = null;
          
          try {
            if (ann.attachments) {
              const parsed = JSON.parse(ann.attachments);
              attachments = parsed.files || [];
              links = parsed.links || [];
              location = parsed.location || null;
              poll = parsed.poll || null;
            }
          } catch (e) {}
          
          centerContent.innerHTML = `
            <div style="padding: 24px; max-width: 800px; margin: 0 auto;">
              <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid var(--ig-border);">
                <div style="width: 56px; height: 56px; border-radius: 14px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 24px;">
                  <i class="fas fa-bullhorn"></i>
                </div>
                <div style="flex: 1;">
                  <h2 style="margin: 0; font-size: 22px; font-weight: 700;">${ann.title}</h2>
                  <div style="color: var(--ig-secondary-text); font-size: 14px; margin-top: 6px; display: flex; align-items: center; gap: 8px;">
                    <span><i class="fas fa-user"></i> ${ann.author_username}</span>
                    <span>â€¢</span>
                    <span><i class="far fa-clock"></i> ${InnovateAPI.formatDate(ann.created_at)}</span>
                    ${ann.is_pinned ? '<span>â€¢</span><span style="color: var(--ig-blue);"><i class="fas fa-thumbtack"></i> Pinned</span>' : ''}
                  </div>
                </div>
                <div style="display: flex; gap: 8px;">
                  <button onclick="editAnnouncement(${ann.id})" style="padding: 10px 16px; background: linear-gradient(135deg, #00a8ff 0%, #0081cc 100%); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s; box-shadow: 0 4px 12px rgba(0, 168, 255, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(0, 168, 255, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0, 168, 255, 0.3)'">
                    <i class="fas fa-edit"></i> Edit
                  </button>
                  <button onclick="pinAnnouncement(${ann.id}, ${!ann.is_pinned})" style="padding: 10px 16px; background: ${ann.is_pinned ? 'var(--ig-secondary-background)' : 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'}; color: ${ann.is_pinned ? 'var(--ig-primary-text)' : 'white'}; border: ${ann.is_pinned ? '2px solid var(--ig-border)' : 'none'}; border-radius: 10px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                    <i class="fas fa-thumbtack"></i> ${ann.is_pinned ? 'Unpin' : 'Pin'}
                  </button>
                  <button onclick="deleteAnnouncement(${ann.id})" style="padding: 10px 16px; background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s; box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(220, 53, 69, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(220, 53, 69, 0.3)'">
                    <i class="fas fa-trash"></i> Delete
                  </button>
                </div>
              </div>
              
              <div style="background: var(--ig-secondary-background); border: 2px solid var(--ig-border); border-radius: 12px; padding: 24px; margin-bottom: 20px;">
                <p style="white-space: pre-wrap; line-height: 1.8; margin: 0; font-size: 15px;">${ann.body || ann.content || 'No content'}</p>
              </div>
              
              ${attachments.length > 0 ? `
                <div style="margin-bottom: 20px;">
                  <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 12px; color: var(--ig-secondary-text);">
                    <i class="fas fa-paperclip"></i> Attachments (${attachments.length})
                  </h3>
                  <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px;">
                    ${attachments.map(file => {
                      // Extract file extension from name
                      const extension = file.name.split('.').pop().toLowerCase();
                      const mimeType = file.type || '';
                      
                      // Normalize URL - handle both full URLs and relative paths
                      let fileUrl = file.url;
                      if (!fileUrl.startsWith('http')) {
                        // Relative path - prepend origin
                        fileUrl = window.location.origin + (fileUrl.startsWith('/') ? fileUrl : '/' + fileUrl);
                      } else {
                        // Full URL - ensure it uses the correct protocol and host
                        try {
                          const urlObj = new URL(fileUrl);
                          // Replace the URL's origin with current origin to avoid protocol/host mismatches
                          urlObj.protocol = window.location.protocol;
                          urlObj.host = window.location.host;
                          fileUrl = urlObj.toString();
                        } catch (e) {
                          // If URL parsing fails, try to extract just the path
                          const pathMatch = fileUrl.match(/\/uploads\/.+$/);
                          if (pathMatch) {
                            fileUrl = window.location.origin + pathMatch[0];
                          }
                        }
                      }
                      
                      // Determine file type
                      const isImage = mimeType.startsWith('image/') || ['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg', 'bmp'].includes(extension);
                      const isVideo = mimeType.startsWith('video/') || ['mp4', 'mov', 'webm', 'avi', 'mkv', 'm4v'].includes(extension);
                      const isPDF = mimeType === 'application/pdf' || extension === 'pdf';
                      const isDoc = ['doc', 'docx', 'txt', 'xls', 'xlsx', 'ppt', 'pptx', 'odt', 'ods', 'odp'].includes(extension) || 
                                    mimeType.includes('document') || mimeType.includes('spreadsheet') || mimeType.includes('presentation');
                      
                      return `
                        <div style="background: var(--ig-secondary-background); border-radius: 12px; overflow: hidden; border: 1px solid var(--ig-border); transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                          ${isImage ? `
                            <div style="width: 100%; aspect-ratio: 16/9; background: #000; overflow: hidden; cursor: pointer; position: relative;" onclick="window.open('${fileUrl}', '_blank')">
                              <img src="${fileUrl}" alt="${file.name}" style="width: 100%; height: 100%; object-fit: contain; display: block;" loading="lazy" onerror="this.onerror=null; this.parentElement.innerHTML='<div style=\\'display:flex;align-items:center;justify-content:center;height:100%;color:#888;\\'><i class=\\'fas fa-image\\' style=\\'font-size:48px;\\'></i></div>'">
                            </div>
                          ` : isVideo ? `
                            <div style="width: 100%; aspect-ratio: 16/9; background: #000; overflow: hidden;">
                              <video controls style="width: 100%; height: 100%; object-fit: contain; display: block;" preload="metadata">
                                <source src="${fileUrl}#t=0.1" type="${mimeType || 'video/mp4'}">
                                Your browser does not support video playback.
                              </video>
                            </div>
                          ` : isPDF ? `
                            <div style="width: 100%; aspect-ratio: 16/9; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; cursor: pointer; flex-direction: column; gap: 12px;" onclick="window.open('${fileUrl}', '_blank')">
                              <i class="fas fa-file-pdf" style="font-size: 72px; color: rgba(255,255,255,0.95);"></i>
                              <span style="color: rgba(255,255,255,0.9); font-size: 14px; font-weight: 600;">Click to view PDF</span>
                            </div>
                          ` : isDoc ? `
                            <div style="width: 100%; aspect-ratio: 16/9; background: linear-gradient(135deg, ${extension.includes('xls') || extension.includes('ods') ? '#217346 0%, #4caf50 100%' : extension.includes('ppt') || extension.includes('odp') ? '#d24726 0%, #ff6b35 100%' : '#2b579a 0%, #4285f4 100%'}); display: flex; align-items: center; justify-content: center; cursor: pointer; flex-direction: column; gap: 12px;" onclick="window.open('${fileUrl}', '_blank')">
                              <i class="fas fa-file-${extension.includes('xls') || extension.includes('ods') ? 'excel' : extension.includes('ppt') || extension.includes('odp') ? 'powerpoint' : extension.includes('txt') ? 'alt' : 'word'}" style="font-size: 72px; color: rgba(255,255,255,0.95);"></i>
                              <span style="color: rgba(255,255,255,0.9); font-size: 14px; font-weight: 600;">Click to open document</span>
                            </div>
                          ` : `
                            <div style="width: 100%; aspect-ratio: 16/9; background: linear-gradient(135deg, #434343 0%, #000000 100%); display: flex; align-items: center; justify-content: center; cursor: pointer; flex-direction: column; gap: 12px;" onclick="window.open('${fileUrl}', '_blank')">
                              <i class="fas fa-file" style="font-size: 72px; color: rgba(255,255,255,0.95);"></i>
                              <span style="color: rgba(255,255,255,0.9); font-size: 14px; font-weight: 600;">Click to download</span>
                            </div>
                          `}
                          
                          <div style="padding: 12px;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                              <i class="fas fa-${isImage ? 'image' : isVideo ? 'video' : isPDF ? 'file-pdf' : isDoc ? 'file-alt' : 'file'}" style="color: var(--ig-blue); font-size: 16px;"></i>
                              <div style="flex: 1; min-width: 0;">
                                <div style="font-size: 14px; font-weight: 600; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: var(--ig-primary-text);">${file.name}</div>
                                <div style="font-size: 12px; color: var(--ig-secondary-text);">${file.size || 'Unknown size'}</div>
                              </div>
                            </div>
                            
                            <div style="display: flex; gap: 8px;">
                              ${isImage || isVideo ? `
                                <button onclick="event.stopPropagation(); window.open('${fileUrl}', '_blank')" style="flex: 1; padding: 8px 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; transition: opacity 0.2s;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
                                  <i class="fas fa-expand"></i> View
                                </button>
                              ` : ''}
                              <a href="${fileUrl}" download="${file.name}" style="flex: 1; padding: 8px 12px; background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; text-decoration: none; transition: opacity 0.2s;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
                                <i class="fas fa-download"></i> Save
                              </a>
                            </div>
                          </div>
                        </div>
                      `;
                    }).join('')}
                  </div>
                </div>
              ` : ''}
              
              ${links.length > 0 ? `
                <div style="margin-bottom: 20px;">
                  <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 12px; color: var(--ig-secondary-text);">
                    <i class="fas fa-link"></i> Links (${links.length})
                  </h3>
                  <div style="display: flex; flex-direction: column; gap: 8px;">
                    ${links.map(link => `
                      <a href="${link.url}" target="_blank" style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--ig-secondary-background); border-radius: 8px; text-decoration: none; color: var(--ig-blue); border: 1px solid var(--ig-border);">
                        <i class="fas fa-external-link-alt"></i>
                        <span style="flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${link.title || link.url}</span>
                      </a>
                    `).join('')}
                  </div>
                </div>
              ` : ''}
              
              ${location ? `
                <div style="margin-bottom: 20px;">
                  <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 12px; color: var(--ig-secondary-text);">
                    <i class="fas fa-map-marker-alt"></i> Location
                  </h3>
                  <a href="https://www.google.com/maps?q=${location.lat},${location.lng}" target="_blank" style="display: flex; align-items: center; gap: 12px; padding: 16px; background: var(--ig-secondary-background); border-radius: 8px; text-decoration: none; color: inherit; border: 1px solid var(--ig-border);">
                    <i class="fas fa-map-marked-alt" style="font-size: 32px; color: var(--ig-error);"></i>
                    <div>
                      <div style="font-weight: 600;">${location.name || 'Shared Location'}</div>
                      <div style="font-size: 13px; color: var(--ig-secondary-text);">${location.address || `${location.lat.toFixed(6)}, ${location.lng.toFixed(6)}`}</div>
                    </div>
                  </a>
                </div>
              ` : ''}
              
              ${poll ? `
                <div style="margin-bottom: 20px;" id="poll-${ann.id}">
                  <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 12px; color: var(--ig-secondary-text);">
                    <i class="fas fa-poll" style="color: #4facfe;"></i> Poll
                  </h3>
                  ${renderPollResults(ann.id, poll)}
                </div>
              ` : ''}
              
              <!-- Reactions Section -->
              <div style="padding: 16px 0; border-top: 1px solid var(--ig-border); border-bottom: 1px solid var(--ig-border); margin-bottom: 16px;">
                <div id="reactions-announcement-${ann.id}" style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px; min-height: 36px;"></div>
                <div style="display: flex; gap: 12px;">
                  <button onclick="showReactionPicker(${ann.id}, 'announcement', event)" 
                    style="flex: 1; padding: 10px 16px; background: var(--ig-secondary-background); border: 1px solid var(--ig-border); border-radius: 8px; cursor: pointer; color: var(--ig-primary-text); font-size: 14px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.2s;"
                    onmouseover="this.style.background='var(--ig-hover)'; this.style.borderColor='var(--ig-blue)'"
                    onmouseout="this.style.background='var(--ig-secondary-background)'; this.style.borderColor='var(--ig-border)'">
                    <i class="far fa-smile"></i> React
                  </button>
                  <button onclick="showCommentSection(${ann.id})" 
                    style="flex: 1; padding: 10px 16px; background: var(--ig-secondary-background); border: 1px solid var(--ig-border); border-radius: 8px; cursor: pointer; color: var(--ig-primary-text); font-size: 14px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.2s;"
                    onmouseover="this.style.background='var(--ig-hover)'; this.style.borderColor='var(--ig-blue)'"
                    onmouseout="this.style.background='var(--ig-secondary-background)'; this.style.borderColor='var(--ig-border)'">
                    <i class="far fa-comment"></i> Comment
                  </button>
                </div>
              </div>
              
              <!-- Comments Section -->
              <div id="comments-${ann.id}"></div>
            </div>
          `;
          
          // Update active state
          renderAnnouncements(res.announcements);
          
          // Load reactions and comments after rendering
          setTimeout(() => {
            if (typeof loadAnnouncementReactions === 'function') {
              loadAnnouncementReactions(ann.id);
            }
          }, 100);
        })
        .catch(err => {
          console.error('Error loading announcement:', err);
        });
    }

    // ==================== TAB SWITCHING ====================
    function switchLeftTab(tab) {
      console.log('switchLeftTab called with tab:', tab);
      
      // Remove active class from all tabs
      document.querySelectorAll('.left-tab').forEach(t => t.classList.remove('active'));
      
      // Add active class to the clicked tab
      const clickedTab = event?.target || document.querySelector(`.left-tab[onclick*="'${tab}'"]`);
      console.log('clickedTab element:', clickedTab);
      
      if (clickedTab) {
        clickedTab.classList.add('active');
        console.log('Tab set to active:', clickedTab);
      } else {
        console.error('Could not find tab element for:', tab);
      }

      const leftFooterBtn = document.getElementById('leftFooterBtn');
      const leftFooter = document.getElementById('leftFooter');
      const centerFooter = document.getElementById('centerFooter');
      const centerTabs = document.getElementById('centerTabs');
      const centerTitle = document.getElementById('centerTitle');
      const centerSubtitle = document.getElementById('centerSubtitle');

      // Hide center tabs when switching to announcements or folders
      if (centerTabs) centerTabs.style.display = 'none';

      if (tab === 'announcements') {
        // Update center header
        if (centerTitle) centerTitle.textContent = 'Announcements';
        if (centerSubtitle) centerSubtitle.textContent = 'Community updates and news';
        
        // Show Create Announcement button in left footer
        if (leftFooter) leftFooter.style.display = 'block';
        if (leftFooterBtn) {
          leftFooterBtn.innerHTML = '<i class="fas fa-plus"></i> Create Announcement';
          leftFooterBtn.onclick = showCreateAnnouncementModal;
        }
        
        // Reset right sidebar to community view
        updateRightSidebarForCommunity();
        
        // Load announcements (will also set centerFooter)
        loadAnnouncements();
      } else if (tab === 'groups') {
        // Groups tab
        if (centerTitle) centerTitle.textContent = 'Select a group';
        if (centerSubtitle) centerSubtitle.textContent = 'Choose from the left sidebar';
        
        // Show Create Group button in left footer
        if (leftFooter) leftFooter.style.display = 'block';
        if (leftFooterBtn) {
          leftFooterBtn.innerHTML = '<i class="fas fa-plus"></i> Create Group';
          leftFooterBtn.onclick = showCreateGroupModal;
        }
        
        // Show Create Group button in center footer
        if (centerFooter) {
          centerFooter.innerHTML = `
            <button class="btn btn-primary" style="width: 100%;" onclick="showCreateGroupModal()">
              <i class="fas fa-plus"></i> Create Group
            </button>
          `;
          centerFooter.style.display = 'block';
        }
        
        // Clear current group selection when switching to Groups tab
        state.currentGroupId = null;
        
        // Reset right sidebar to community view when on Groups tab but no group selected
        updateRightSidebarForCommunity();
        
        // Load groups
        renderGroupsList();
      } else if (tab === 'folders') {
        // Update center header
        if (centerTitle) centerTitle.textContent = 'Folders';
        if (centerSubtitle) centerSubtitle.textContent = 'Organized by groups';
        
        // Show Create Group button in left footer (folders are created with groups)
        if (leftFooter) leftFooter.style.display = 'block';
        if (leftFooterBtn) {
          leftFooterBtn.innerHTML = '<i class="fas fa-plus"></i> Create Group';
          leftFooterBtn.onclick = showCreateGroupModal;
        }
        
        // Show Create Group button in center footer too
        if (centerFooter) {
          centerFooter.innerHTML = `
            <button class="btn btn-primary" style="width: 100%;" onclick="showCreateGroupModal()">
              <i class="fas fa-plus"></i> Create Group
            </button>
          `;
          centerFooter.style.display = 'block';
        }
        
        // Reset right sidebar to community view
        updateRightSidebarForCommunity();
        
        // Load folders
        renderFoldersList();
      } else if (tab === 'github') {
        // GitHub Integration tab
        if (centerTitle) centerTitle.textContent = 'GitHub Integration';
        if (centerSubtitle) centerSubtitle.textContent = 'Connect your repositories';
        
        // Reset right sidebar to community view
        updateRightSidebarForCommunity();
        
        // Hide both footers (GitHub has its own connect button in content)
        leftFooter.style.display = 'none';
        centerFooter.style.display = 'none';
        centerFooter.innerHTML = '';
        
        // Load GitHub view
        renderGitHubView();
      }
    }

    function switchCenterTab(view) {
      state.currentView = view;
      document.querySelectorAll('.center-tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');
      loadGroupView(state.currentGroupId);
    }

    // ==================== GROUP SELECTION ====================
    async function selectGroup(groupId) {
      console.log('selectGroup called with groupId:', groupId);
      
      // Show center panel on mobile when group is selected
      const centerPanel = document.getElementById('communityCenter');
      if (window.innerWidth <= 768 && centerPanel) {
        centerPanel.classList.add('mobile-active');
      }
      
      // Leave previous room if switching groups
      if (state.currentGroupId && state.currentGroupId != groupId && state.socket) {
        state.socket.emit('community-group:leave', state.currentGroupId);
        console.log('Left room for group:', state.currentGroupId);
      }
      
      state.currentGroupId = groupId;
      const group = state.groups.find(g => g.id == groupId);
      console.log('Found group:', group);
      if (!group) return;
      
      // Update URL to include groupId so it persists on refresh
      const url = new URL(window.location);
      url.searchParams.set('groupId', groupId);
      window.history.pushState({}, '', url);

      // Check if user is a member, if not and group is private, show join request
      try {
        const groupDetails = await InnovateAPI.apiRequest(`/community-groups/${groupId}`);
        
        // If user is not a member (is_member is 0 or undefined)
        if (!groupDetails.group.is_member || groupDetails.group.is_member === 0) {
          // Not a member
          if (groupDetails.group.is_public === 0) {
            // Private group - show join request button instead of auto-joining
            showPrivateGroupJoinRequest(groupId, groupDetails.group);
            return;
          } else {
            // Public group - try to auto join
            try {
              await InnovateAPI.apiRequest(`/community-groups/${groupId}/join`, {
                method: 'POST'
              });
              console.log('Joined group successfully');
            } catch (joinError) {
              // If join fails (already member, blocked, etc), continue anyway
              console.log('Join attempt:', joinError.message);
              // If blocked, show error and return
              if (joinError.message.includes('blocked')) {
                InnovateAPI.showAlert('You are blocked from this group', 'error');
                return;
              }
            }
          }
        }
      } catch (error) {
        console.log('Error checking group membership:', error.message);
        // Continue anyway - user might already be a member
      }

      // Update header
      document.getElementById('centerTitle').textContent = group.name;
      document.getElementById('centerSubtitle').textContent = group.description || 'Group workspace';
      
      // Show tabs
      document.getElementById('centerTabs').style.display = 'flex';
      document.getElementById('centerTabs').innerHTML = `
        <button class="center-tab active" onclick="switchCenterTab('chat')">
          <i class="fas fa-comments"></i> Chat
        </button>
        <button class="center-tab" onclick="switchCenterTab('calls')">
          <i class="fas fa-video"></i> Calls
        </button>
        <button class="center-tab" onclick="switchCenterTab('folders')">
          <i class="fas fa-folder"></i> Folders
        </button>
        <button class="center-tab" onclick="switchCenterTab('tasks')">
          <i class="fas fa-tasks"></i> To-Do
        </button>
        <button class="center-tab" onclick="switchCenterTab('notes')">
          <i class="fas fa-file-alt"></i> Notes
        </button>
      `;

      // Show action button
      document.getElementById('centerActions').innerHTML = `
        <button class="btn btn-primary" onclick="showGroupActions()">
          <i class="fas fa-ellipsis-v"></i>
        </button>
      `;

      state.currentView = 'chat';
      console.log('About to call loadGroupView with groupId:', groupId);
      
      // Update right sidebar with group information
      await updateRightSidebarForGroup(groupId, group);
      
      await loadGroupView(groupId);
      console.log('loadGroupView completed');
      renderGroupsList(); // Update active state
    }

    // ==================== UPDATE RIGHT SIDEBAR FOR GROUP ====================
    async function updateRightSidebarForGroup(groupId, group) {
      try {
        // Fetch full group details
        const response = await InnovateAPI.apiRequest(`/community-groups/${groupId}`);
        const groupData = response.group;
        const currentUser = InnovateAPI.getCurrentUser();
        
        // Update avatar with cache busting
        const rightAvatar = document.getElementById('rightAvatar');
        if (groupData.profile_picture) {
          const cacheBuster = `?t=${Date.now()}`;
          rightAvatar.innerHTML = `<img src="${groupData.profile_picture}${cacheBuster}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;" onerror="this.parentElement.innerHTML='<i class=\\'fas fa-users\\'></i>'">`;
        } else {
          rightAvatar.innerHTML = '<i class="fas fa-users"></i>';
        }
        
        // Update name and meta
        document.getElementById('rightName').textContent = groupData.name;
        const privacyLabel = groupData.is_public === 0 ? 'ðŸ”’ Private Group' : 'ðŸŒ Public Group';
        document.getElementById('rightMeta').textContent = privacyLabel;
        
        // Update description
        document.getElementById('rightDescription').textContent = groupData.description || 'No description';
        
        // Update action buttons for group context
        const rightActions = document.querySelector('.right-actions');
        const isAdmin = groupData.creator_id === currentUser.id;
        
        rightActions.innerHTML = `
          <div class="right-action" onclick="showInviteLinkModal(${groupId})">
            <div class="action-circle">
              <i class="fas fa-link"></i>
            </div>
            <div class="action-label">Invite Link</div>
          </div>

          <div class="right-action" onclick="addGroupMembers()">
            <div class="action-circle">
              <i class="fas fa-user-plus"></i>
            </div>
            <div class="action-label">Add members</div>
          </div>

          ${isAdmin ? `
          <div class="right-action" onclick="showGroupSettings()">
            <div class="action-circle">
              <i class="fas fa-cog"></i>
            </div>
            <div class="action-label">Settings</div>
          </div>
          ` : ''}
        `;
        
        // Update Edit Profile button
        const editBtn = document.querySelector('.right-section button.btn-text');
        if (isAdmin) {
          editBtn.style.display = 'block';
          editBtn.onclick = () => showGroupSettings();
          editBtn.innerHTML = '<i class="fas fa-edit"></i> Edit Group';
        } else {
          editBtn.style.display = 'none';
        }
        
        // Update member count
        document.getElementById('memberCountBadge').textContent = `(${groupData.member_count || 0})`;
        
        // Hide community-specific options, show group-specific options
        const menuItems = document.querySelectorAll('.community-right .menu-item');
        menuItems.forEach(item => {
          const text = item.textContent.toLowerCase();
          if (text.includes('leave community') || text.includes('manage groups') || 
              text.includes('view groups') || text.includes('community settings') || 
              text.includes('github integration')) {
            item.style.display = 'none';
          } else if (text.includes('view members')) {
            item.onclick = () => viewGroupMembers(groupId);
            item.style.display = 'flex';
          } else if (text.includes('add members')) {
            item.onclick = () => addGroupMembers();
            item.style.display = 'flex';
          }
        });
        
        // Add Leave Group option
        const leaveGroupItem = document.createElement('div');
        leaveGroupItem.className = 'menu-item';
        leaveGroupItem.style.color = 'var(--ig-error)';
        leaveGroupItem.onclick = () => leaveGroup(groupId);
        leaveGroupItem.innerHTML = `
          <div class="menu-left">
            <div class="menu-icon"><i class="fas fa-sign-out-alt"></i></div>
            <div>Leave group</div>
          </div>
          <i class="fas fa-chevron-right"></i>
        `;
        
        // Remove existing leave group item if any
        const existingLeaveGroup = Array.from(menuItems).find(item => item.textContent.toLowerCase().includes('leave group'));
        if (existingLeaveGroup) existingLeaveGroup.remove();
        
        // Add after the last visible menu item
        const lastVisibleItem = Array.from(menuItems).filter(item => item.style.display !== 'none').pop();
        if (lastVisibleItem) {
          lastVisibleItem.after(leaveGroupItem);
        }
        
        // Hide admin features section for now
        const adminFeatures = document.getElementById('adminOnlyFeatures');
        if (adminFeatures) {
          adminFeatures.style.display = 'none';
        }
        
      } catch (error) {
        console.error('Error updating right sidebar for group:', error);
      }
    }

    // Helper functions for group actions
    function startGroupVideoCall() {
      switchCenterTab('calls');
    }

    function addGroupMembers() {
      InnovateAPI.showAlert('Add members feature coming soon!', 'info');
    }

    function viewGroupMembers(groupId) {
      switchCenterTab('members');
    }

    async function leaveGroup(groupId) {
      if (!confirm('Are you sure you want to leave this group?')) {
        return;
      }

      try {
        await InnovateAPI.apiRequest(`/community-groups/${groupId}/leave`, {
          method: 'POST'
        });

        InnovateAPI.showAlert('Left group successfully', 'success');
        
        // Reload groups and switch back to community view
        await loadGroups();
        resetToCommunityView();
      } catch (error) {
        console.error('Error leaving group:', error);
        InnovateAPI.showAlert(error.message, 'error');
      }
    }

    async function showGroupSettings() {
      if (!state.currentGroupId) return;
      
      try {
        const response = await InnovateAPI.apiRequest(`/community-groups/${state.currentGroupId}`);
        const group = response.group;
        const currentUser = InnovateAPI.getCurrentUser();
        const isAdmin = group.creator_id === currentUser.id || group.role === 'admin' || group.role === 'creator';
        
        if (!isAdmin) {
          InnovateAPI.showAlert('Only admins can access group settings', 'error');
          return;
        }
        
        showGroupSettingsModal(group);
      } catch (error) {
        console.error('Error loading group settings:', error);
        InnovateAPI.showAlert(error.message, 'error');
      }
    }

    function showGroupSettingsModal(group) {
      const modal = document.createElement('div');
      modal.className = 'ig-modal-overlay';
      modal.innerHTML = `
        <div class="ig-modal" style="min-width: 600px; max-width: 90%; max-height: 90vh; overflow-y: auto;">
          <div class="modal-header" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; padding: 24px; border-radius: 12px 12px 0 0; position: sticky; top: 0; z-index: 10; position: relative;">
            <div style="display: flex; align-items: center; gap: 12px;">
              <i class="fas fa-cog" style="font-size: 24px;"></i>
              <div>
                <div style="font-size: 20px; font-weight: 700;">Group Settings</div>
                <div style="font-size: 13px; opacity: 0.9;">Manage ${group.name}</div>
              </div>
            </div>
            <button onclick="this.closest('.ig-modal-overlay').remove()" style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); color: white; border: none; width: 36px; height: 36px; border-radius: 50%; font-size: 28px; cursor: pointer; line-height: 1; display: flex; align-items: center; justify-content: center; font-weight: 300;">Ã—</button>
          </div>
          
          <div style="padding: 24px;">
            <!-- Tabs -->
            <div style="display: flex; gap: 8px; border-bottom: 2px solid var(--ig-border); margin-bottom: 24px; overflow-x: auto;">
              <button class="group-settings-tab active" data-tab="general" onclick="switchGroupSettingsTab('general')" style="padding: 12px 20px; background: none; border: none; border-bottom: 3px solid transparent; color: var(--ig-secondary-text); font-weight: 600; cursor: pointer; transition: all 0.2s; white-space: nowrap;">
                <i class="fas fa-info-circle"></i> General
              </button>
              <button class="group-settings-tab" data-tab="members" onclick="switchGroupSettingsTab('members')" style="padding: 12px 20px; background: none; border: none; border-bottom: 3px solid transparent; color: var(--ig-secondary-text); font-weight: 600; cursor: pointer; transition: all 0.2s; white-space: nowrap;">
                <i class="fas fa-users"></i> Members
              </button>
              <button class="group-settings-tab" data-tab="requests" onclick="switchGroupSettingsTab('requests')" style="padding: 12px 20px; background: none; border: none; border-bottom: 3px solid transparent; color: var(--ig-secondary-text); font-weight: 600; cursor: pointer; transition: all 0.2s; white-space: nowrap;">
                <i class="fas fa-user-clock"></i> Requests <span id="requestsBadge" style="display: none; background: var(--ig-error); color: white; padding: 2px 6px; border-radius: 10px; font-size: 11px; margin-left: 4px;">0</span>
              </button>
              <button class="group-settings-tab" data-tab="blocked" onclick="switchGroupSettingsTab('blocked')" style="padding: 12px 20px; background: none; border: none; border-bottom: 3px solid transparent; color: var(--ig-secondary-text); font-weight: 600; cursor: pointer; transition: all 0.2s; white-space: nowrap;">
                <i class="fas fa-ban"></i> Blocked
              </button>
            </div>
            
            <!-- General Tab -->
            <div id="generalTab" class="group-settings-content">
              <form id="groupSettingsForm" onsubmit="saveGroupSettings(event, ${group.id})">
                <!-- Profile Picture -->
                <div style="margin-bottom: 20px; text-align: center;">
                  <div style="position: relative; width: 120px; height: 120px; margin: 0 auto 16px;">
                    <img id="settingsGroupPicture" src="${group.profile_picture || '/images/default-avatar.svg'}" style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 3px solid var(--ig-border);">
                    <button type="button" onclick="document.getElementById('settingsProfilePicture').click()" style="position: absolute; bottom: 0; right: 0; width: 36px; height: 36px; background: var(--ig-blue); color: white; border: 2px solid var(--ig-primary-background); border-radius: 50%; cursor: pointer; font-size: 16px;">
                      <i class="fas fa-camera"></i>
                    </button>
                  </div>
                  <input type="file" id="settingsProfilePicture" accept="image/*" style="display: none;" onchange="previewSettingsGroupPictureWithCrop(event)">
                  <div style="font-size: 13px; color: var(--ig-secondary-text); margin-top: 8px;">Click camera to upload and adjust</div>
                </div>
                
                <!-- Group Name -->
                <div style="margin-bottom: 16px;">
                  <label style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 14px;"><i class="fas fa-tag"></i> Group Name *</label>
                  <input type="text" id="settingsGroupName" value="${group.name}" required style="width: 100%; padding: 12px; border: 2px solid var(--ig-border); border-radius: 8px; background: var(--ig-secondary-background); color: var(--ig-primary-text); font-size: 14px;">
                </div>
                
                <!-- Description -->
                <div style="margin-bottom: 16px;">
                  <label style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 14px;"><i class="fas fa-align-left"></i> Description</label>
                  <textarea id="settingsGroupDescription" rows="4" style="width: 100%; padding: 12px; border: 2px solid var(--ig-border); border-radius: 8px; background: var(--ig-secondary-background); color: var(--ig-primary-text); font-size: 14px; resize: vertical; font-family: inherit;">${group.description || ''}</textarea>
                </div>
                
                <!-- Privacy -->
                <div style="background: var(--ig-secondary-background); border: 2px solid var(--ig-border); border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                      <div style="font-weight: 600; margin-bottom: 4px;"><i class="fas fa-lock"></i> Public Group</div>
                      <div style="font-size: 13px; color: var(--ig-secondary-text);">Anyone in the community can see and join</div>
                    </div>
                    <div class="ig-toggle-switch ${group.is_public !== 0 ? 'active' : ''}" id="settingsPrivacyToggle" onclick="this.classList.toggle('active')">
                      <div class="ig-toggle-slider"></div>
                    </div>
                  </div>
                </div>
                
                <!-- Save Button -->
                <button type="submit" style="width: 100%; padding: 14px; background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 15px;">
                  <i class="fas fa-save"></i> Save Changes
                </button>
              </form>
            </div>
            
            <!-- Members Tab -->
            <div id="membersTab" class="group-settings-content" style="display: none;">
              <div id="membersList"></div>
            </div>
            
            <!-- Requests Tab -->
            <div id="requestsTab" class="group-settings-content" style="display: none;">
              <div id="requestsList"></div>
            </div>
            
            <!-- Blocked Tab -->
            <div id="blockedTab" class="group-settings-content" style="display: none;">
              <div id="blockedList"></div>
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Load initial data
      loadGroupMembers(group.id);
      loadJoinRequests(group.id);
      loadBlockedMembers(group.id);
      
      // Add CSS for active tab
      const style = document.createElement('style');
      style.textContent = `
        .group-settings-tab.active {
          color: var(--ig-primary-text) !important;
          border-bottom-color: #11998e !important;
        }
      `;
      document.head.appendChild(style);
    }

    function resetToCommunityView() {
      state.currentGroupId = null;
      
      // Update URL
      const url = new URL(window.location);
      url.searchParams.delete('groupId');
      window.history.pushState({}, '', url);
      
      // Reset center panel
      document.getElementById('centerTitle').textContent = state.community?.name || 'Community';
      document.getElementById('centerSubtitle').textContent = 'Select a group to start';
      document.getElementById('centerTabs').style.display = 'none';
      document.getElementById('centerContent').innerHTML = '<div style="text-align: center; padding: 60px 20px; color: var(--ig-secondary-text);"><i class="fas fa-users" style="font-size: 64px; margin-bottom: 16px; opacity: 0.3;"></i><h3>No Group Selected</h3><p>Choose a group from the sidebar to get started</p></div>';
      
      // Reset right sidebar to community view
      updateRightSidebarForCommunity();
    }

    function updateRightSidebarForCommunity() {
      if (!state.community) return;
      
      const rightAvatar = document.getElementById('rightAvatar');
      if (state.community.banner_image) {
        rightAvatar.innerHTML = `<img src="${state.community.banner_image}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
      } else {
        rightAvatar.innerHTML = '<i class="fas fa-users"></i>';
      }
      
      document.getElementById('rightName').textContent = state.community.name;
      document.getElementById('rightMeta').textContent = `Community Â· ${state.groups?.length || 0} groups`;
      document.getElementById('rightDescription').textContent = state.community.description || 'No description';
      
      // Reset action buttons
      const rightActions = document.querySelector('.right-actions');
      rightActions.innerHTML = `
        <div class="right-action" onclick="inviteMembers()">
          <div class="action-circle">
            <i class="fas fa-link"></i>
          </div>
          <div class="action-label">Invite</div>
        </div>

        <div class="right-action" onclick="addMembers()">
          <div class="action-circle">
            <i class="fas fa-user-plus"></i>
          </div>
          <div class="action-label">Add members</div>
        </div>

        <div class="right-action" onclick="showCreateGroupModal()">
          <div class="action-circle">
            <i class="fas fa-users-cog"></i>
          </div>
          <div class="action-label">Add groups</div>
        </div>
      `;
      
      // Show all community menu items
      const menuItems = document.querySelectorAll('.community-right .menu-item');
      menuItems.forEach(item => {
        const text = item.textContent.toLowerCase();
        if (text.includes('leave group')) {
          item.remove();
        } else {
          item.style.display = 'flex';
          
          // Reset onclick handlers
          if (text.includes('view members')) {
            item.onclick = () => viewMembers();
          } else if (text.includes('add members')) {
            item.onclick = () => addMembers();
          } else if (text.includes('leave community')) {
            item.onclick = () => leaveCommunity();
          } else if (text.includes('manage groups')) {
            item.onclick = () => manageGroups();
          } else if (text.includes('view groups')) {
            item.onclick = () => viewAllGroups();
          } else if (text.includes('community settings')) {
            item.onclick = () => showCommunitySettings();
          } else if (text.includes('github')) {
            item.onclick = () => showGitHubIntegration();
          }
        }
      });
      
      // Reset Edit Profile button
      const editBtn = document.querySelector('.right-section button.btn-text');
      if (editBtn) {
        editBtn.style.display = 'block';
        editBtn.onclick = () => editCommunityProfile();
        editBtn.innerHTML = '<i class="fas fa-edit"></i> Edit Profile';
      }
    }

    // ==================== VIEW LOADING ====================
    async function loadGroupView(groupId) {
      console.log('loadGroupView called, currentView:', state.currentView);
      const content = document.getElementById('centerContent');
      const footer = document.getElementById('centerFooter');

      switch (state.currentView) {
        case 'chat':
          await loadChatView(groupId);
          break;
        case 'calls':
          loadCallsView(groupId);
          break;
        case 'folders':
          await loadFoldersView(groupId);
          break;
        case 'tasks':
          await loadTasksView(groupId);
          break;
        case 'notes':
          await loadNotesView(groupId);
          break;
      }
    }

    // ==================== CHAT VIEW ====================
    async function loadChatView(groupId) {
      console.log('loadChatView called with groupId:', groupId);
      const content = document.getElementById('centerContent');
      const footer = document.getElementById('centerFooter');

      content.innerHTML = '<div class="loading"><div class="spinner"></div>Loading messages...</div>';
      footer.style.display = 'flex';
      footer.innerHTML = `
        <input type="file" id="fileInput" multiple style="display: none;" onchange="handleFileSelect(event)" accept="image/*,video/*,.pdf,.doc,.docx,.txt,.xls,.xlsx">
        <button class="ws-icon-btn" onclick="document.getElementById('fileInput').click()" title="Attach files">
          <i class="fas fa-paperclip"></i>
        </button>
        <button class="ws-icon-btn" onclick="showPollCreator()" title="Create a poll" style="color: var(--ig-blue);">
          <i class="fas fa-poll"></i>
        </button>
        <input type="text" class="form-input" id="chatInput" placeholder="Type a message..." style="flex: 1; margin: 0 12px;" onkeypress="if(event.key==='Enter')sendMessage()">
        <button class="btn btn-primary" onclick="sendMessage()">
          <i class="fas fa-paper-plane"></i>
        </button>
      `;

      // Load messages
      try {
        console.log('Fetching posts from:', `/community-groups/${groupId}/posts`);
        
        // Initialize E2E encryption for this group BEFORE fetching messages
        await E2EEncryption.initForGroup(groupId);
        console.log('ðŸ” E2E initialized for group', groupId);
        
        const res = await InnovateAPI.apiRequest(`/community-groups/${groupId}/posts`);
        console.log('Posts response:', res);
        console.log('Posts array:', res.posts);
        console.log('Posts length:', res.posts?.length);
        if (res.success && res.posts && res.posts.length > 0) {
          console.log('Rendering', res.posts.length, 'messages');
          
          // Sort messages by created_at (oldest first)
          const sortedPosts = res.posts.sort((a, b) => {
            return new Date(a.created_at) - new Date(b.created_at);
          });
          console.log('Messages sorted oldest first');
          
          // Render messages with error handling
          const messagesHTML = sortedPosts.map((msg, index) => {
            try {
              const html = renderMessage(msg);
              console.log(`Message ${index} rendered:`, html.substring(0, 50));
              return html;
            } catch (err) {
              console.error(`Error rendering message ${index}:`, err, msg);
              return `<div style="color: red;">Error rendering message</div>`;
            }
          }).join('');
          
          console.log('Messages HTML length:', messagesHTML.length);
          
          content.innerHTML = `
            <div id="messagesList" style="padding: 20px; overflow-y: auto; height: 100%; display: flex; flex-direction: column; gap: 12px;">
              ${messagesHTML}
            </div>
          `;
          
          console.log('Messages HTML set, checking element');
          const checkList = document.getElementById('messagesList');
          console.log('messagesList after setting:', checkList, 'children:', checkList?.children.length);
          
          // Scroll to bottom
          setTimeout(() => {
            const list = document.getElementById('messagesList');
            if (list) list.scrollTop = list.scrollHeight;
          }, 100);
          
          // Load reactions for all messages
          sortedPosts.forEach(msg => {
            if (msg.id) {
              loadMessageReactions(msg.id);
            }
          });
        } else {
          content.innerHTML = `
            <div id="messagesList" style="padding: 20px; overflow-y: auto; height: 100%; display: flex; flex-direction: column; gap: 12px;">
              <div class="empty-state" style="flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;">
                <div style="width: 80px; height: 80px; margin-bottom: 20px; border-radius: 20px; background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 36px;">
                  <i class="fas fa-comments"></i>
                </div>
                <div style="font-size: 20px; font-weight: 700; margin-bottom: 8px; color: var(--ig-primary-text);">No messages yet</div>
                <div style="font-size: 14px; color: var(--ig-secondary-text);">Start the conversation!</div>
              </div>
            </div>
          `;
        }
      } catch (error) {
        console.error('Error loading messages:', error);
        content.innerHTML = `
          <div id="messagesList" style="padding: 20px; overflow-y: auto; height: 100%; display: flex; flex-direction: column; gap: 12px;">
            <div class="empty-state" style="flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center;">
              <div style="color: var(--ig-error);">Failed to load messages</div>
            </div>
          </div>
        `;
      }

      // Join room
      if (state.socket) {
        state.socket.emit('community-group:join', groupId);
      }
    }

    async function sendMessage() {
      const input = document.getElementById('chatInput');
      const fileInput = document.getElementById('fileInput');
      const message = input.value.trim();
      console.log('=== sendMessage called ===');
      console.log('Message text:', message);
      console.log('GroupId:', state.currentGroupId);
      console.log('Accumulated files:', accumulatedFiles.length);
      console.log('Replying to:', window.replyingTo);
      
      if ((!message && accumulatedFiles.length === 0) || !state.currentGroupId) {
        console.log('Aborting: no message/files or no groupId');
        return;
      }

      try {
        console.log('Sending POST to:', `/community-groups/${state.currentGroupId}/posts`);
        
        // Initialize E2E encryption for this group
        await E2EEncryption.initForGroup(state.currentGroupId);
        
        // Encrypt message content
        const encryptedMessage = E2EEncryption.encrypt(message, state.currentGroupId);
        
        // Extract URLs from message for links folder
        const urlRegex = /(https?:\/\/[^\s<]+)/g;
        const urls = message.match(urlRegex);
        if (urls && urls.length > 0) {
          // Save links to backend
          for (const url of urls) {
            try {
              await InnovateAPI.apiRequest(`/community-groups/${state.currentGroupId}/links`, {
                method: 'POST',
                body: JSON.stringify({ url, title: url })
              });
              console.log('ðŸ”— Saved link:', url);
            } catch (err) {
              console.error('Failed to save link:', err);
            }
          }
        }
        
        const formData = new FormData();
        if (message) {
          formData.append('content', encryptedMessage);
          console.log('ðŸ” Added ENCRYPTED content to FormData');
        }
        
        // Add reply_to if replying
        if (window.replyingTo) {
          formData.append('reply_to', window.replyingTo);
          console.log('ðŸ“© Added reply_to:', window.replyingTo);
        }
        
        // Add accumulated files (CUMULATIVE)
        if (accumulatedFiles.length > 0) {
          for (let i = 0; i < accumulatedFiles.length; i++) {
            formData.append('attachments', accumulatedFiles[i]);
            console.log(`Added file ${i + 1}:`, accumulatedFiles[i].name);
          }
          console.log('Total files added:', accumulatedFiles.length);
        }
        
        const res = await fetch(`/api/community-groups/${state.currentGroupId}/posts`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${InnovateAPI.getToken()}`
          },
          body: formData
        });
        
        const data = await res.json();
        console.log('=== Send message response ===');
        console.log('Success:', data.success);
        console.log('Post data:', data.post);
        console.log('Post content:', data.post?.content);
        console.log('Post created_at:', data.post?.created_at);
        
        if (data.success) {
          input.value = '';
          if (fileInput) {
            fileInput.value = '';
            input.placeholder = 'Type a message...';
          }
          // Clear reply
          if (window.replyingTo && typeof cancelReply === 'function') {
            cancelReply();
          }
          // Clear accumulated files after successful send
          accumulatedFiles = [];
          console.log('Message sent successfully, cleared accumulated files, reloading groups...');
          
          // Message will appear via socket event
          // Reload groups to update latest message
          loadGroups();
        }
      } catch (error) {
        console.error('Error sending message:', error);
        InnovateAPI.showAlert('Failed to send message', 'error');
      }
    }

    // ==================== CALLS VIEW ====================
    function loadCallsView(groupId) {
      const content = document.getElementById('centerContent');
      const footer = document.getElementById('centerFooter');
      footer.style.display = 'none';

      content.innerHTML = `
        <div class="empty-state" style="height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 40px;">
          <div style="width: 96px; height: 96px; margin-bottom: 24px; border-radius: 24px; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 48px;">
            <i class="fas fa-phone-alt"></i>
          </div>
          <div style="font-size: 24px; font-weight: 700; margin-bottom: 8px; color: var(--ig-primary-text);">Start a call</div>
          <div style="font-size: 14px; color: var(--ig-secondary-text); margin-bottom: 32px;">Voice, video, or screen sharing</div>
          <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
            <button onclick="startVoiceCall()" style="padding: 14px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.3)'">
              <i class="fas fa-phone"></i> Voice Call
            </button>
            <button onclick="startVideoCall()" style="padding: 14px 24px; background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s; box-shadow: 0 4px 12px rgba(17, 153, 142, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(17, 153, 142, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(17, 153, 142, 0.3)'">
              <i class="fas fa-video"></i> Video Call
            </button>
            <button onclick="startScreenShare()" style="padding: 14px 24px; background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s; box-shadow: 0 4px 12px rgba(250, 112, 154, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(250, 112, 154, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(250, 112, 154, 0.3)'">
              <i class="fas fa-desktop"></i> Screen Share
            </button>
          </div>
        </div>
      `;
    }

    async function startVoiceCall() {
      try {
        state.localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
        renderCallInterface(false);
        // Implement WebRTC signaling
      } catch (error) {
        console.error('Error starting voice call:', error);
      }
    }

    async function startVideoCall() {
      try {
        state.localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: true });
        renderCallInterface(true);
        // Implement WebRTC signaling
      } catch (error) {
        console.error('Error starting video call:', error);
      }
    }

    async function startScreenShare() {
      try {
        state.localStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
        renderCallInterface(true);
        // Implement WebRTC signaling
      } catch (error) {
        console.error('Error starting screen share:', error);
      }
    }

    function renderCallInterface(hasVideo) {
      const content = document.getElementById('centerContent');
      content.innerHTML = `
        <div class="call-view">
          <div class="video-grid" id="videoGrid">
            <div class="video-tile">
              <video id="localVideo" autoplay muted ${hasVideo ? '' : 'style="display:none"'}></video>
              <div class="video-name">You</div>
            </div>
          </div>
          <div class="call-controls">
            <button class="call-btn mute" onclick="toggleMute()">
              <i class="fas fa-microphone"></i>
            </button>
            <button class="call-btn video" onclick="toggleVideo()" ${hasVideo ? '' : 'style="display:none"'}>
              <i class="fas fa-video"></i>
            </button>
            <button class="call-btn screen" onclick="toggleScreenShare()">
              <i class="fas fa-desktop"></i>
            </button>
            <button class="call-btn end" onclick="endCall()">
              <i class="fas fa-phone-slash"></i>
            </button>
          </div>
        </div>
      `;

      if (hasVideo) {
        document.getElementById('localVideo').srcObject = state.localStream;
      }
    }

    function toggleMute() {
      if (state.localStream) {
        const audioTrack = state.localStream.getAudioTracks()[0];
        audioTrack.enabled = !audioTrack.enabled;
        event.target.innerHTML = audioTrack.enabled ? '<i class="fas fa-microphone"></i>' : '<i class="fas fa-microphone-slash"></i>';
      }
    }

    function toggleVideo() {
      if (state.localStream) {
        const videoTrack = state.localStream.getVideoTracks()[0];
        videoTrack.enabled = !videoTrack.enabled;
        event.target.innerHTML = videoTrack.enabled ? '<i class="fas fa-video"></i>' : '<i class="fas fa-video-slash"></i>';
      }
    }

    function endCall() {
      if (state.localStream) {
        state.localStream.getTracks().forEach(track => track.stop());
        state.localStream = null;
      }
      loadCallsView(state.currentGroupId);
    }

    // ==================== FOLDERS VIEW ====================
    async function loadFoldersView(groupId) {
      const content = document.getElementById('centerContent');
      const footer = document.getElementById('centerFooter');
      footer.style.display = 'none';

      // Initial loading state
      content.innerHTML = `
        <div class="folder-grid">
          <div class="folder-item" onclick="openFolder('image')">
            <div class="folder-icon">ðŸ–¼ï¸</div>
            <div class="folder-name">Images</div>
            <div class="folder-count" id="images-count">Loading...</div>
          </div>
          <div class="folder-item" onclick="openFolder('video')">
            <div class="folder-icon">ðŸŽ¥</div>
            <div class="folder-name">Videos</div>
            <div class="folder-count" id="videos-count">Loading...</div>
          </div>
          <div class="folder-item" onclick="openFolder('document')">
            <div class="folder-icon">ðŸ“„</div>
            <div class="folder-name">Documents</div>
            <div class="folder-count" id="documents-count">Loading...</div>
          </div>
          <div class="folder-item" onclick="openFolder('links')">
            <div class="folder-icon">ðŸ”—</div>
            <div class="folder-name">Links</div>
            <div class="folder-count" id="links-count">Loading...</div>
          </div>
          <div class="folder-item" onclick="openGitHubRepos()">
            <div class="folder-icon">ðŸ’»</div>
            <div class="folder-name">GitHub</div>
            <div class="folder-count">Repositories</div>
          </div>
        </div>
        <div id="folder-files-view" style="margin-top: 24px; display: none;">
          <!-- Files will be displayed here when folder is opened -->
        </div>
      `;

      // Load actual file counts from API
      try {
        console.log('Loading file counts for group:', groupId);
        
        // Load images count
        const imagesRes = await InnovateAPI.apiRequest(`/community-groups/${groupId}/files?type=image`);
        document.getElementById('images-count').textContent = `${imagesRes.files?.length || 0} files`;
        console.log('Images count:', imagesRes.files?.length);
        
        // Load videos count
        const videosRes = await InnovateAPI.apiRequest(`/community-groups/${groupId}/files?type=video`);
        document.getElementById('videos-count').textContent = `${videosRes.files?.length || 0} files`;
        console.log('Videos count:', videosRes.files?.length);
        
        // Load documents count
        const documentsRes = await InnovateAPI.apiRequest(`/community-groups/${groupId}/files?type=document`);
        document.getElementById('documents-count').textContent = `${documentsRes.files?.length || 0} files`;
        console.log('Documents count:', documentsRes.files?.length);
        
        // Load links count
        const linksRes = await InnovateAPI.apiRequest(`/community-groups/${groupId}/links`);
        document.getElementById('links-count').textContent = `${linksRes.links?.length || 0} saved`;
        console.log('Links count:', linksRes.links?.length);
        
      } catch (error) {
        console.error('Error loading file counts:', error);
        document.getElementById('images-count').textContent = '0 files';
        document.getElementById('videos-count').textContent = '0 files';
        document.getElementById('documents-count').textContent = '0 files';
        document.getElementById('links-count').textContent = '0 saved';
      }
    }

    // NEW FUNCTION: Open group folder view directly (for Folders tab navigation)
    // This bypasses chat view and goes straight to folders
    async function openGroupFolderView(groupId) {
      console.log('openGroupFolderView called for group:', groupId);
      
      // Set current group and view
      state.currentGroupId = groupId;
      state.currentView = 'folders';
      
      const group = state.groups.find(g => g.id == groupId);
      if (!group) {
        console.error('Group not found:', groupId);
        return;
      }
      
      // Update header to show group name
      document.getElementById('centerTitle').textContent = group.name + ' - Folders';
      document.getElementById('centerSubtitle').textContent = 'Files organized by type';
      
      // Hide tabs since we're in folder-specific view
      document.getElementById('centerTabs').style.display = 'none';
      
      // Load the folders view directly
      await loadFoldersView(groupId);
      
      console.log('Folder view loaded for group:', group.name);
    }
    
    async function openFolder(type) {
      console.log(`Opening ${type} folder...`);
      const filesView = document.getElementById('folder-files-view');
      filesView.style.display = 'block';
      filesView.innerHTML = '<div class="loading"><div class="spinner"></div>Loading files...</div>';

      try {
        if (type === 'links') {
          // Load links
          const res = await InnovateAPI.apiRequest(`/community-groups/${state.currentGroupId}/links`);
          const links = res.links || [];
          
          if (links.length === 0) {
            filesView.innerHTML = `
              <div class="empty-state">
                <div class="empty-icon">ðŸ”—</div>
                <div class="empty-title">No links saved</div>
                <div class="empty-text">Share links in chat to see them here</div>
              </div>
            `;
            return;
          }
          
          filesView.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
              <button class="btn btn-secondary" onclick="document.getElementById('folder-files-view').style.display='none'; loadFoldersView(state.currentGroupId);" style="margin-right: 12px;">
                <i class="fas fa-arrow-left"></i> Back
              </button>
              <h3 style="margin: 0; flex: 1;">Links (${links.length})</h3>
              <button class="btn btn-secondary" onclick="document.getElementById('folder-files-view').style.display='none'">
                <i class="fas fa-times"></i> Close
              </button>
            </div>
            <div style="display: grid; gap: 12px;">
              ${links.map(link => `
                <div class="file-card" style="padding: 16px; border: 1px solid var(--ig-border); border-radius: 12px; cursor: pointer;" onclick="window.open('${link.url}', '_blank')">
                  <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="font-size: 32px;">ðŸ”—</div>
                    <div style="flex: 1;">
                      <div style="font-weight: 600; margin-bottom: 4px;">${link.title || link.url}</div>
                      <div style="font-size: 13px; color: var(--ig-secondary-text);">${link.url}</div>
                      <div style="font-size: 12px; color: var(--ig-secondary-text); margin-top: 4px;">
                        Saved by ${link.username} â€¢ ${InnovateAPI.formatDate(link.created_at)}
                      </div>
                    </div>
                  </div>
                </div>
              `).join('')}
            </div>
          `;
        } else {
          // Load files (images, videos, documents)
          const res = await InnovateAPI.apiRequest(`/community-groups/${state.currentGroupId}/files?type=${type}`);
          const files = res.files || [];
          
          console.log(`${type} files loaded:`, files.length);
          
          if (files.length === 0) {
            const emptyMessages = {
              image: 'ðŸ“· No images uploaded yet',
              video: 'ðŸŽ¥ No videos uploaded yet',
              document: 'ðŸ“„ No documents uploaded yet'
            };
            filesView.innerHTML = `
              <div class="empty-state">
                <div class="empty-icon">${emptyMessages[type]}</div>
                <div class="empty-title">No files found</div>
                <div class="empty-text">Upload files in chat to see them here</div>
              </div>
            `;
            return;
          }
          
          // Display files in grid
          filesView.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
              <h3 style="margin: 0;">${type.charAt(0).toUpperCase() + type.slice(1)}s (${files.length})</h3>
              <button class="btn btn-secondary" onclick="document.getElementById('folder-files-view').style.display='none'">
                <i class="fas fa-times"></i> Close
              </button>
            </div>
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px;">
              ${files.map(file => {
                const isImage = type === 'image';
                const isVideo = type === 'video';
                const fileIcon = type === 'document' ? (
                  file.filename.endsWith('.pdf') ? 'ðŸ“„' :
                  file.filename.match(/\.(doc|docx)$/) ? 'ðŸ“' :
                  file.filename.match(/\.(xls|xlsx)$/) ? 'ðŸ“Š' : 'ðŸ“Ž'
                ) : 'ðŸ“Ž';
                
                return `
                  <div class="file-card" style="border: 1px solid var(--ig-border); border-radius: 12px; overflow: hidden; cursor: pointer;" onclick="window.open('${file.filepath}', '_blank')">
                    ${isImage ? `
                      <img src="${file.filepath}" alt="${file.filename}" style="width: 100%; height: 150px; object-fit: cover; background: var(--ig-secondary-background);">
                    ` : isVideo ? `
                      <video src="${file.filepath}" style="width: 100%; height: 150px; object-fit: cover; background: var(--ig-secondary-background);" controls></video>
                    ` : `
                      <div style="width: 100%; height: 150px; display: flex; align-items: center; justify-content: center; background: var(--ig-secondary-background); font-size: 48px;">
                        ${fileIcon}
                      </div>
                    `}
                    <div style="padding: 12px;">
                      <div style="font-size: 13px; font-weight: 600; margin-bottom: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${file.filename}">
                        ${file.filename}
                      </div>
                      <div style="font-size: 11px; color: var(--ig-secondary-text);">
                        ${file.username} â€¢ ${InnovateAPI.formatDate(file.created_at)}
                      </div>
                      <div style="font-size: 11px; color: var(--ig-secondary-text);">
                        ${(file.filesize / 1024).toFixed(1)} KB
                      </div>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          `;
        }
      } catch (error) {
        console.error('Error loading folder contents:', error);
        filesView.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">âŒ</div>
            <div class="empty-title">Error loading files</div>
            <div class="empty-text">${error.message}</div>
          </div>
        `;
      }
    }

    function uploadFile() {
      const input = document.createElement('input');
      input.type = 'file';
      input.multiple = true;
      input.onchange = async (e) => {
        const files = Array.from(e.target.files);
        console.log(`Uploading ${files.length} file(s)...`);
        // Implement file upload
      };
      input.click();
    }

    // ==================== TASKS VIEW (KANBAN BOARD) ====================
    async function loadTasksView(groupId) {
      const content = document.getElementById('centerContent');
      const footer = document.getElementById('centerFooter');
      footer.style.display = 'none';

      try {
        const res = await InnovateAPI.apiRequest(`/community-groups/${groupId}/tasks`);
        const tasks = res.tasks || [];
        
        // Group tasks by status
        const tasksByStatus = {
          todo: tasks.filter(t => t.status === 'todo'),
          in_progress: tasks.filter(t => t.status === 'in_progress'),
          done: tasks.filter(t => t.status === 'done')
        };

        content.innerHTML = `
          <div style="margin-bottom: 16px; display: flex; gap: 12px; flex-wrap: wrap; align-items: center;">
            <button class="btn btn-primary" onclick="createTaskFromText()">
              <i class="fas fa-plus"></i> Add Task
            </button>
            <button class="btn btn-secondary" onclick="createTaskFromImage()">
              <i class="fas fa-image"></i> From Image
            </button>
            <button class="btn btn-secondary" onclick="createTaskFromVoice()">
              <i class="fas fa-microphone"></i> From Voice
            </button>
            <button class="btn btn-secondary" onclick="showTaskCalendar(${groupId})">
              <i class="fas fa-calendar"></i> Calendar View
            </button>
            <button class="btn btn-secondary" onclick="loadTasksView(${groupId})">
              <i class="fas fa-th"></i> Board View
            </button>
          </div>
          
          <div class="kanban-board">
            <!-- TO DO Column -->
            <div class="kanban-column" data-status="todo">
              <div class="kanban-column-header">
                <div class="kanban-column-title">
                  <span class="kanban-icon">ðŸ“‹</span>
                  <h3>To Do</h3>
                  <span class="kanban-count">${tasksByStatus.todo.length}</span>
                </div>
              </div>
              <div class="kanban-column-body" id="column-todo" ondrop="handleDrop(event, 'todo')" ondragover="handleDragOver(event)">
                ${renderKanbanTasks(tasksByStatus.todo)}
              </div>
            </div>
            
            <!-- IN PROGRESS Column -->
            <div class="kanban-column" data-status="in_progress">
              <div class="kanban-column-header">
                <div class="kanban-column-title">
                  <span class="kanban-icon">âš¡</span>
                  <h3>In Progress</h3>
                  <span class="kanban-count">${tasksByStatus.in_progress.length}</span>
                </div>
              </div>
              <div class="kanban-column-body" id="column-in_progress" ondrop="handleDrop(event, 'in_progress')" ondragover="handleDragOver(event)">
                ${renderKanbanTasks(tasksByStatus.in_progress)}
              </div>
            </div>
            
            <!-- DONE Column -->
            <div class="kanban-column" data-status="done">
              <div class="kanban-column-header">
                <div class="kanban-column-title">
                  <span class="kanban-icon">âœ…</span>
                  <h3>Done</h3>
                  <span class="kanban-count">${tasksByStatus.done.length}</span>
                </div>
              </div>
              <div class="kanban-column-body" id="column-done" ondrop="handleDrop(event, 'done')" ondragover="handleDragOver(event)">
                ${renderKanbanTasks(tasksByStatus.done)}
              </div>
            </div>
          </div>
          
          ${tasks.length === 0 ? `
            <div class="empty-state" style="margin-top: 40px;">
              <div class="empty-icon">âœ…</div>
              <div class="empty-title">No tasks yet</div>
              <div class="empty-text">Create your first task to get started!</div>
            </div>
          ` : ''}
        `;
      } catch (error) {
        console.error('Error loading tasks:', error);
      }
    }
    
    function renderKanbanTasks(tasks) {
      if (tasks.length === 0) {
        return '<div class="kanban-empty">Drop tasks here</div>';
      }
      
      return tasks.map(task => {
        let subtasks = [];
        try {
          subtasks = task.subtasks ? (typeof task.subtasks === 'string' ? JSON.parse(task.subtasks) : task.subtasks) : [];
        } catch (e) {
          console.error('Error parsing subtasks:', e);
        }
        
        const totalSubtasks = subtasks.length;
        const completedSubtasks = subtasks.filter(st => st.completed).length;
        
        // Calculate due date status
        let dueDateClass = '';
        let dueDateText = '';
        if (task.due_date) {
          const dueDate = new Date(task.due_date);
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          dueDate.setHours(0, 0, 0, 0);
          
          const diffTime = dueDate - today;
          const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
          
          if (diffDays < 0) {
            dueDateClass = 'overdue';
            dueDateText = `Overdue by ${Math.abs(diffDays)} day${Math.abs(diffDays) > 1 ? 's' : ''}`;
          } else if (diffDays === 0) {
            dueDateClass = 'due-today';
            dueDateText = 'Due today';
          } else if (diffDays === 1) {
            dueDateClass = 'due-soon';
            dueDateText = 'Due tomorrow';
          } else if (diffDays <= 3) {
            dueDateClass = 'due-soon';
            dueDateText = `Due in ${diffDays} days`;
          } else if (diffDays <= 7) {
            dueDateClass = 'due-upcoming';
            dueDateText = `Due in ${diffDays} days`;
          } else {
            dueDateText = dueDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
          }
        }
        
        return `
        <div class="kanban-task ${dueDateClass}" draggable="true" ondragstart="handleDragStart(event, ${task.id})" onclick="editTask(${task.id})">
          <div class="kanban-task-header">
            <span class="task-priority priority-${task.priority || 'medium'}">${task.priority || 'medium'}</span>
            <div class="task-actions">
              <button class="task-edit" onclick="event.stopPropagation(); editTask(${task.id})" title="Edit">
                <i class="fas fa-edit"></i>
              </button>
              <button class="task-delete" onclick="event.stopPropagation(); deleteTask(${task.id})" title="Delete">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
          <div class="kanban-task-title">${task.title}</div>
          ${task.description ? `<div class="kanban-task-desc">${task.description.substring(0, 80)}${task.description.length > 80 ? '...' : ''}</div>` : ''}
          ${totalSubtasks > 0 ? `<div class="kanban-task-subtasks"><i class="fas fa-check-circle"></i> ${completedSubtasks}/${totalSubtasks} steps</div>` : ''}
          <div class="kanban-task-footer">
            ${task.due_date ? `<span class="task-due ${dueDateClass}"><i class="fas fa-calendar"></i> ${dueDateText}</span>` : ''}
            ${task.progress !== null && task.progress !== undefined ? `<span class="task-progress-chip">${task.progress}%</span>` : ''}
          </div>
        </div>
      `}).join('');
    }
    
    let draggedTaskId = null;
    
    function handleDragStart(event, taskId) {
      draggedTaskId = taskId;
      event.target.style.opacity = '0.5';
    }
    
    function handleDragOver(event) {
      event.preventDefault();
      event.currentTarget.style.background = 'rgba(0, 149, 246, 0.1)';
    }
    
    async function handleDrop(event, newStatus) {
      event.preventDefault();
      event.currentTarget.style.background = '';
      
      if (!draggedTaskId) return;
      
      try {
        await InnovateAPI.apiRequest(`/community-groups/${state.currentGroupId}/tasks/${draggedTaskId}`, {
          method: 'PATCH',
          body: JSON.stringify({ status: newStatus })
        });
        
        loadTasksView(state.currentGroupId);
        InnovateAPI.showAlert('Task moved to ' + newStatus.replace('_', ' '), 'success');
      } catch (error) {
        console.error('Error updating task:', error);
        InnovateAPI.showAlert('Failed to move task', 'error');
      } finally {
        draggedTaskId = null;
      }
    }

    window.createTaskFromText = function() {
      openTaskModal();
    };

    window.openTaskModal = function(task = null) {
      const isEdit = !!task;
      let subtasks = [];
      
      if (task?.subtasks) {
        try {
          subtasks = typeof task.subtasks === 'string' ? JSON.parse(task.subtasks) : task.subtasks;
        } catch (e) {
          console.error('Error parsing subtasks:', e);
          subtasks = [];
        }
      }
      
      const modalHTML = `
        <div class="task-modal-overlay" id="taskModalOverlay">
          <div class="task-modal">
            <div class="task-modal-header">
              <h3>${isEdit ? 'Edit Task' : 'Create Task'}</h3>
              <button class="task-modal-close" onclick="closeTaskModal()">&times;</button>
            </div>
            <div class="task-modal-body">
              <form id="taskForm">
                <div class="task-form-group">
                  <label>Title *</label>
                  <input type="text" id="taskTitle" placeholder="Enter task title" value="${task?.title || ''}" required>
                </div>
                
                <div class="task-form-group">
                  <label>Description</label>
                  <textarea id="taskDescription" placeholder="Add details about this task">${task?.description || ''}</textarea>
                </div>
                
                <div class="task-form-group">
                  <label>Due Date</label>
                  <input type="date" id="taskDueDate" value="${task?.due_date ? task.due_date.split('T')[0] : ''}">
                </div>
                
                <div class="task-form-group">
                  <label>Priority</label>
                  <select id="taskPriority">
                    <option value="low" ${task?.priority === 'low' ? 'selected' : ''}>Low</option>
                    <option value="medium" ${task?.priority === 'medium' || !task ? 'selected' : ''}>Medium</option>
                    <option value="high" ${task?.priority === 'high' ? 'selected' : ''}>High</option>
                  </select>
                </div>
                
                <div class="task-form-group">
                  <label>Subtasks (Steps)</label>
                  <div class="subtasks-list" id="subtasksList">
                    ${subtasks.map((st, i) => `
                      <div class="subtask-item">
                        <input type="checkbox" ${st.completed ? 'checked' : ''} onchange="updateTaskProgress()">
                        <input type="text" value="${st.text}" placeholder="Step ${i + 1}">
                        <button type="button" class="subtask-remove" onclick="removeSubtask(this)">Ã—</button>
                      </div>
                    `).join('')}
                  </div>
                  <button type="button" class="add-subtask-btn" onclick="addSubtask()">+ Add Step</button>
                </div>
                
                <div class="task-form-group">
                  <label>Progress</label>
                  <div class="progress-display">
                    <div class="progress-percentage" id="progressPercentage">${task?.progress || 0}%</div>
                    <div class="progress-label" id="progressLabel">0 of 0 steps completed</div>
                  </div>
                </div>
              </form>
            </div>
            <div class="task-modal-footer">
              <button class="task-btn task-btn-secondary" onclick="closeTaskModal()">Cancel</button>
              <button class="task-btn task-btn-primary" onclick="saveTask(${task?.id || null})">${isEdit ? 'Update' : 'Create'} Task</button>
            </div>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', modalHTML);
      updateTaskProgress();
    }

    window.closeTaskModal = function() {
      const modal = document.getElementById('taskModalOverlay');
      if (modal) modal.remove();
    };

    window.addSubtask = function() {
      const list = document.getElementById('subtasksList');
      const count = list.querySelectorAll('.subtask-item').length + 1;
      const html = `
        <div class="subtask-item">
          <input type="checkbox" onchange="updateTaskProgress()">
          <input type="text" placeholder="Step ${count}">
          <button type="button" class="subtask-remove" onclick="removeSubtask(this)">Ã—</button>
        </div>
      `;
      list.insertAdjacentHTML('beforeend', html);
      updateTaskProgress();
    };

    window.removeSubtask = function(btn) {
      btn.closest('.subtask-item').remove();
      updateTaskProgress();
    };

    window.updateTaskProgress = function() {
      const subtaskItems = document.querySelectorAll('.subtask-item');
      const total = subtaskItems.length;
      const completed = Array.from(subtaskItems).filter(item => 
        item.querySelector('input[type="checkbox"]').checked
      ).length;
      
      const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
      
      document.getElementById('progressPercentage').textContent = percentage + '%';
      document.getElementById('progressLabel').textContent = `${completed} of ${total} steps completed`;
    };

    window.saveTask = async function(taskId) {
      const title = document.getElementById('taskTitle').value.trim();
      if (!title) {
        InnovateAPI.showAlert('Please enter a task title', 'error');
        return;
      }
      
      const description = document.getElementById('taskDescription').value.trim();
      const dueDate = document.getElementById('taskDueDate').value;
      const priority = document.getElementById('taskPriority').value;
      
      // Collect subtasks
      const subtaskItems = document.querySelectorAll('.subtask-item');
      const subtasks = Array.from(subtaskItems).map(item => ({
        text: item.querySelector('input[type="text"]').value.trim(),
        completed: item.querySelector('input[type="checkbox"]').checked
      })).filter(st => st.text);
      
      // Calculate progress
      const total = subtasks.length;
      const completed = subtasks.filter(st => st.completed).length;
      const progress = total > 0 ? Math.round((completed / total) * 100) : 0;
      
      try {
        if (taskId) {
          // Update existing task
          await InnovateAPI.apiRequest(`/community-groups/${state.currentGroupId}/tasks/${taskId}`, {
            method: 'PATCH',
            body: JSON.stringify({
              title,
              description,
              due_date: dueDate || null,
              priority,
              subtasks: JSON.stringify(subtasks),
              progress
            })
          });
          InnovateAPI.showAlert('Task updated!', 'success');
        } else {
          // Create new task
          await InnovateAPI.apiRequest(`/community-groups/${state.currentGroupId}/tasks/from-text`, {
            method: 'POST',
            body: JSON.stringify({
              text: title,
              description,
              due_date: dueDate || null,
              priority,
              subtasks: JSON.stringify(subtasks),
              progress
            })
          });
          InnovateAPI.showAlert('Task created!', 'success');
        }
        
        closeTaskModal();
        loadTasksView(state.currentGroupId);
      } catch (error) {
        console.error('Save task error:', error);
        InnovateAPI.showAlert('Failed to save task', 'error');
      }
    };
    
    window.editTask = async function(taskId) {
      try {
        // Fetch the task details
        const tasks = await InnovateAPI.apiRequest(`/community-groups/${state.currentGroupId}/tasks`);
        const task = tasks.tasks.find(t => t.id === taskId);
        if (!task) {
          InnovateAPI.showAlert('Task not found', 'error');
          return;
        }
        openTaskModal(task);
      } catch (error) {
        console.error('Edit task error:', error);
        InnovateAPI.showAlert('Failed to load task', 'error');
      }
    };
    
    window.deleteTask = async function(taskId) {
      if (!confirm('Delete this task? This cannot be undone.')) return;
      
      try {
        await InnovateAPI.apiRequest(`/community-groups/${state.currentGroupId}/tasks/${taskId}`, {
          method: 'DELETE'
        });
        loadTasksView(state.currentGroupId);
        InnovateAPI.showAlert('Task deleted successfully', 'success');
      } catch (error) {
        console.error('Delete task error:', error);
        InnovateAPI.showAlert('Failed to delete task: ' + (error.message || 'Unknown error'), 'error');
      }
    };

    function createTaskFromImage() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append('image', file);

        try {
          await InnovateAPI.apiRequest(`/community-groups/${state.currentGroupId}/tasks/from-image`, {
            method: 'POST',
            body: formData
          });

          console.log('Tasks extracted from image successfully');
          loadTasksView(state.currentGroupId);
        } catch (error) {
          console.error('Error:', error);
          InnovateAPI.showAlert(error.message || 'Failed to create tasks from image', 'error');
        }
      };
      input.click();
    }

    function createTaskFromVoice() {
      console.log('Voice-to-task feature coming soon!');
      // Implement voice recording and transcription
    }

    // Calendar View for Tasks
    window.showTaskCalendar = async function(groupId, viewMode = 'list') {
      const content = document.getElementById('centerContent');
      
      try {
        const res = await InnovateAPI.apiRequest(`/community-groups/${groupId}/tasks`);
        const tasks = res.tasks || [];
        
        // Persist calendar state per group so month navigation works
        const taskCalendarState = (window.taskCalendarState = window.taskCalendarState || {});
        const calendarKey = String(groupId);
        const savedState = taskCalendarState[calendarKey] || {};
        const now = new Date();
        let currentMonth = Number.isInteger(savedState.month) ? savedState.month : now.getMonth();
        let currentYear = Number.isInteger(savedState.year) ? savedState.year : now.getFullYear();
        taskCalendarState[calendarKey] = { ...savedState, month: currentMonth, year: currentYear, viewMode };
        
        const renderCalendar = (month, year) => {
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          
          // Get first day of month and days in month
          const firstDay = new Date(year, month, 1);
          const lastDay = new Date(year, month + 1, 0);
          const daysInMonth = lastDay.getDate();
          const startingDayOfWeek = firstDay.getDay();
          
          // Group tasks by date
          const tasksByDate = {};
          tasks.filter(t => t.due_date && t.status !== 'done').forEach(task => {
            const dueDate = new Date(task.due_date);
            const dateKey = `${dueDate.getFullYear()}-${dueDate.getMonth()}-${dueDate.getDate()}`;
            if (!tasksByDate[dateKey]) tasksByDate[dateKey] = [];
            tasksByDate[dateKey].push(task);
          });
          
          // Month names
          const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
            'July', 'August', 'September', 'October', 'November', 'December'];
          
          // Build calendar grid
          let calendarHTML = `
            <div class="calendar-grid-container">
              <div class="calendar-grid-header">
                <button class="calendar-nav-btn" onclick="changeMonth(-1)">
                  <i class="fas fa-chevron-left"></i>
                </button>
                <div class="calendar-month-title">${monthNames[month]} ${year}</div>
                <button class="calendar-nav-btn" onclick="changeMonth(1)">
                  <i class="fas fa-chevron-right"></i>
                </button>
              </div>
              
              <div class="calendar-weekdays">
                <div class="calendar-weekday">Sun</div>
                <div class="calendar-weekday">Mon</div>
                <div class="calendar-weekday">Tue</div>
                <div class="calendar-weekday">Wed</div>
                <div class="calendar-weekday">Thu</div>
                <div class="calendar-weekday">Fri</div>
                <div class="calendar-weekday">Sat</div>
              </div>
              
              <div class="calendar-days-grid">
          `;
          
          // Empty cells for days before month starts
          for (let i = 0; i < startingDayOfWeek; i++) {
            calendarHTML += '<div class="calendar-day empty"></div>';
          }
          
          // Days of month
          for (let day = 1; day <= daysInMonth; day++) {
            const dateObj = new Date(year, month, day);
            const dateKey = `${year}-${month}-${day}`;
            const tasksForDay = tasksByDate[dateKey] || [];
            
            const isToday = dateObj.getTime() === today.getTime();
            const isPast = dateObj < today;
            const hasTasks = tasksForDay.length > 0;
            
            // Determine urgency class
            let urgencyClass = '';
            if (hasTasks) {
              const overdue = tasksForDay.some(t => new Date(t.due_date) < today);
              const dueToday = tasksForDay.some(t => {
                const td = new Date(t.due_date);
                return td.getTime() === today.getTime();
              });
              
              if (overdue) urgencyClass = 'has-overdue';
              else if (dueToday) urgencyClass = 'has-due-today';
              else urgencyClass = 'has-upcoming';
            }
            
            calendarHTML += `
              <div class="calendar-day ${isToday ? 'today' : ''} ${isPast ? 'past' : ''} ${urgencyClass}" 
                   onclick="showTasksForDate('${dateKey}', '${monthNames[month]} ${day}, ${year}')">
                <div class="calendar-day-number">${day}</div>
                ${hasTasks ? `<div class="calendar-day-indicator">${tasksForDay.length}</div>` : ''}
              </div>
            `;
          }
          
          calendarHTML += `
              </div>
            </div>
          `;
          
          return calendarHTML;
        };
        
        window.changeMonth = function(direction) {
          currentMonth += direction;
          if (currentMonth > 11) {
            currentMonth = 0;
            currentYear++;
          } else if (currentMonth < 0) {
            currentMonth = 11;
            currentYear--;
          }
          taskCalendarState[calendarKey] = { ...taskCalendarState[calendarKey], month: currentMonth, year: currentYear, viewMode: 'grid' };
          showTaskCalendar(groupId, 'grid');
        };
        
        window.showTasksForDate = function(dateKey, dateString) {
          const [year, month, day] = dateKey.split('-').map(Number);
          const targetDate = new Date(year, month, day);
          targetDate.setHours(0, 0, 0, 0);
          
          const tasksForDate = tasks.filter(t => {
            if (!t.due_date) return false;
            const dueDate = new Date(t.due_date);
            dueDate.setHours(0, 0, 0, 0);
            return dueDate.getTime() === targetDate.getTime();
          });
          
          const statusColors = {
            todo: '#8e8e8e',
            in_progress: '#0095f6',
            done: '#34c759'
          };
          
          const modal = document.createElement('div');
          modal.className = 'task-modal-overlay';
          modal.innerHTML = `
            <div class="task-modal" style="max-width: 600px;">
              <div class="task-modal-header">
                <h3>ðŸ“… Tasks for ${dateString}</h3>
                <button class="task-modal-close" onclick="this.closest('.task-modal-overlay').remove()">&times;</button>
              </div>
              <div class="task-modal-body" style="max-height: 60vh; overflow-y: auto;">
                ${tasksForDate.length === 0 ? `
                  <div class="empty-state" style="padding: 40px;">
                    <div class="empty-icon">ðŸ“…</div>
                    <div class="empty-title">No tasks for this date</div>
                  </div>
                ` : `
                  <div class="calendar-task-list">
                    ${tasksForDate.map(task => {
                      const subtasks = task.subtasks ? (typeof task.subtasks === 'string' ? JSON.parse(task.subtasks) : task.subtasks) : [];
                      const totalSubtasks = subtasks.length;
                      const completedSubtasks = subtasks.filter(st => st.completed).length;
                      
                      return `
                        <div class="calendar-task-item" onclick="this.closest('.task-modal-overlay').remove(); editTask(${task.id});" style="margin-bottom: 12px;">
                          <div style="width: 4px; height: 60px; border-radius: 2px; background: ${statusColors[task.status] || '#8e8e8e'};"></div>
                          <div class="calendar-task-content">
                            <div class="calendar-task-title" style="font-size: 14px; margin-bottom: 6px;">${task.title}</div>
                            ${task.description ? `<div style="font-size: 12px; color: var(--ig-secondary-text); margin-bottom: 4px;">${task.description.substring(0, 100)}</div>` : ''}
                            <div class="calendar-task-meta">
                              <span class="priority-${task.priority || 'medium'}" style="padding: 3px 8px; border-radius: 4px; font-size: 11px;">${task.priority || 'medium'}</span>
                              ${totalSubtasks > 0 ? `<span><i class="fas fa-check-circle"></i> ${completedSubtasks}/${totalSubtasks} steps</span>` : ''}
                              ${task.progress ? `<span>${task.progress}%</span>` : ''}
                              <span style="text-transform: capitalize; color: ${statusColors[task.status]};">${task.status.replace('_', ' ')}</span>
                            </div>
                          </div>
                        </div>
                      `;
                    }).join('')}
                  </div>
                `}
              </div>
              <div class="task-modal-footer">
                <button class="task-btn task-btn-secondary" onclick="this.closest('.task-modal-overlay').remove()">Close</button>
                <button class="task-btn task-btn-primary" onclick="this.closest('.task-modal-overlay').remove(); createTaskFromText();">Add Task</button>
              </div>
            </div>
          `;
          document.body.appendChild(modal);
        };
        
        // Filter tasks with due dates and not completed
        const tasksWithDueDates = tasks
          .filter(t => t.due_date && t.status !== 'done')
          .sort((a, b) => new Date(a.due_date) - new Date(b.due_date));
        
        // Group tasks by date category
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        const groupedTasks = {
          overdue: [],
          today: [],
          tomorrow: [],
          thisWeek: [],
          later: []
        };
        
        tasksWithDueDates.forEach(task => {
          const dueDate = new Date(task.due_date);
          dueDate.setHours(0, 0, 0, 0);
          
          const diffTime = dueDate - today;
          const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
          
          if (diffDays < 0) {
            groupedTasks.overdue.push(task);
          } else if (diffDays === 0) {
            groupedTasks.today.push(task);
          } else if (diffDays === 1) {
            groupedTasks.tomorrow.push(task);
          } else if (diffDays <= 7) {
            groupedTasks.thisWeek.push(task);
          } else {
            groupedTasks.later.push(task);
          }
        });
        
        const renderTaskGroup = (tasks, title, category, icon) => {
          if (tasks.length === 0) return '';
          
          const statusColors = {
            todo: '#8e8e8e',
            in_progress: '#0095f6',
            done: '#34c759'
          };
          
          return `
            <div class="calendar-date-group ${category}">
              <div class="calendar-date-header">
                <span>${icon} ${title}</span>
                <span style="font-weight: normal; font-size: 12px;">${tasks.length} task${tasks.length > 1 ? 's' : ''}</span>
              </div>
              <div class="calendar-task-list">
                ${tasks.map(task => {
                  const subtasks = task.subtasks ? (typeof task.subtasks === 'string' ? JSON.parse(task.subtasks) : task.subtasks) : [];
                  const totalSubtasks = subtasks.length;
                  const completedSubtasks = subtasks.filter(st => st.completed).length;
                  
                  // Format due date
                  const dueDate = new Date(task.due_date);
                  const formattedDate = dueDate.toLocaleDateString('en-US', { 
                    weekday: 'short', 
                    month: 'short', 
                    day: 'numeric', 
                    year: 'numeric' 
                  });
                  
                  return `
                    <div class="calendar-task-item" onclick="editTask(${task.id})">
                      <div style="width: 4px; height: 50px; border-radius: 2px; background: ${statusColors[task.status] || '#8e8e8e'};"></div>
                      <div class="calendar-task-content">
                        <div class="calendar-task-title">${task.title}</div>
                        <div class="calendar-task-meta">
                          <span class="priority-${task.priority || 'medium'}" style="padding: 2px 6px; border-radius: 4px; font-size: 10px;">${task.priority || 'medium'}</span>
                          <span style="color: var(--ig-secondary-text);"><i class="fas fa-calendar"></i> ${formattedDate}</span>
                          ${totalSubtasks > 0 ? `<span><i class="fas fa-check-circle"></i> ${completedSubtasks}/${totalSubtasks}</span>` : ''}
                          ${task.progress ? `<span>${task.progress}%</span>` : ''}
                        </div>
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
            </div>
          `;
        };
        // Render based on view mode
        if (viewMode === 'grid') {
          // Grid calendar view
          content.innerHTML = `
            <div style="margin-bottom: 16px; display: flex; gap: 12px; flex-wrap: wrap; align-items: center;">
              <button class="btn btn-primary" onclick="createTaskFromText()">
                <i class="fas fa-plus"></i> Add Task
              </button>
              <button class="btn btn-secondary" onclick="createTaskFromImage()">
                <i class="fas fa-image"></i> From Image
              </button>
              <button class="btn btn-secondary" onclick="createTaskFromVoice()">
                <i class="fas fa-microphone"></i> From Voice
              </button>
              <button class="btn btn-secondary" onclick="showTaskCalendar(${groupId}, 'list')">
                <i class="fas fa-list"></i> List View
              </button>
              <button class="btn btn-secondary" onclick="loadTasksView(${groupId})">
                <i class="fas fa-th"></i> Board View
              </button>
            </div>
            
            ${renderCalendar(currentMonth, currentYear)}
          `;
        } else {
          // List view (default)
          content.innerHTML = `
            <div style="margin-bottom: 16px; display: flex; gap: 12px; flex-wrap: wrap; align-items: center;">
              <button class="btn btn-primary" onclick="createTaskFromText()">
                <i class="fas fa-plus"></i> Add Task
              </button>
              <button class="btn btn-secondary" onclick="createTaskFromImage()">
                <i class="fas fa-image"></i> From Image
              </button>
              <button class="btn btn-secondary" onclick="createTaskFromVoice()">
                <i class="fas fa-microphone"></i> From Voice
              </button>
              <button class="btn btn-secondary" onclick="showTaskCalendar(${groupId}, 'grid')">
                <i class="fas fa-calendar"></i> Calendar View
              </button>
              <button class="btn btn-secondary" onclick="loadTasksView(${groupId})">
                <i class="fas fa-th"></i> Board View
              </button>
            </div>
            
            <div class="calendar-container">
              <div class="calendar-header">
                <div class="calendar-title">ðŸ“… Task Calendar - Upcoming Deadlines</div>
                <div class="calendar-legend">
                  <div class="legend-item"><div class="legend-dot overdue"></div><span>Overdue</span></div>
                  <div class="legend-item"><div class="legend-dot today"></div><span>Today</span></div>
                  <div class="legend-item"><div class="legend-dot soon"></div><span>This Week</span></div>
                  <div class="legend-item"><div class="legend-dot upcoming"></div><span>Later</span></div>
                </div>
              </div>
              
              ${tasksWithDueDates.length === 0 ? `
                <div class="empty-state" style="margin-top: 40px;">
                  <div class="empty-icon">ðŸ“…</div>
                  <div class="empty-title">No upcoming deadlines</div>
                  <div class="empty-text">All your tasks are up to date!</div>
                </div>
              ` : `
                <div class="calendar-tasks">
                  ${renderTaskGroup(groupedTasks.overdue, 'Overdue', 'overdue', 'ðŸš¨')}
                  ${renderTaskGroup(groupedTasks.today, 'Due Today', 'today', 'âš¡')}
                  ${renderTaskGroup(groupedTasks.tomorrow, 'Due Tomorrow', 'soon', 'ðŸ“Œ')}
                  ${renderTaskGroup(groupedTasks.thisWeek, 'Due This Week', 'soon', 'ðŸ“')}
                  ${renderTaskGroup(groupedTasks.later, 'Due Later', 'upcoming', 'ðŸ“†')}
                </div>
              `}
            </div>
          `;
        }
        
      } catch (error) {
        console.error('Error loading calendar:', error);
        InnovateAPI.showAlert('Failed to load calendar', 'error');
      }
    };

    // ==================== NOTES VIEW ====================
    async function loadNotesView(groupId) {
      const content = document.getElementById('centerContent');
      const footer = document.getElementById('centerFooter');
      footer.style.display = 'none';
      
      // Set current view
      state.currentView = 'notes';
      state.showArchivedNotes = state.showArchivedNotes || false;

      try {
        console.log('Loading notes for group:', groupId);
        // Add timestamp to prevent caching
        const timestamp = new Date().getTime();
        const res = await InnovateAPI.apiRequest(`/community-groups/${groupId}/notes?_t=${timestamp}`);
        let notes = res.notes || [];
        console.log('Loaded notes:', notes.length);
        
        // Log first note to check timestamp
        if (notes.length > 0) {
          console.log('First note updated_at:', notes[0].updated_at);
          console.log('Formatted:', InnovateAPI.formatDate(notes[0].updated_at));
        }
        
        // Sort: Pinned first, then by updated_at
        notes.sort((a, b) => {
          if (a.is_pinned && !b.is_pinned) return -1;
          if (!a.is_pinned && b.is_pinned) return 1;
          return new Date(b.updated_at) - new Date(a.updated_at);
        });
        
        // Filter archived notes based on toggle
        const activeNotes = state.showArchivedNotes ? notes : notes.filter(n => !n.is_archived);
        const archivedCount = notes.filter(n => n.is_archived).length;

        content.innerHTML = `
          <div style="display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap;">
            <button class="btn btn-primary" onclick="showCreateNoteModal()">
              <i class="fas fa-plus"></i> New Note
            </button>
            <div style="flex: 1; position: relative; min-width: 200px;">
              <input 
                type="text" 
                id="note-search-input"
                placeholder="ðŸ” Search notes..." 
                style="width: 100%; padding: 10px 16px; border: 1px solid var(--ig-border); border-radius: 8px; background: var(--ig-secondary-background); color: var(--ig-primary-text);"
                oninput="filterNotes()"
              />
            </div>
            ${archivedCount > 0 ? `
              <button class="btn btn-secondary" onclick="toggleArchivedNotes()" style="white-space: nowrap;">
                ${state.showArchivedNotes ? 'ðŸ“¤' : 'ðŸ“¥'} ${state.showArchivedNotes ? 'Hide' : 'Show'} Archived (${archivedCount})
              </button>
            ` : ''}
          </div>
          ${activeNotes.length === 0 ? `
            <div class="empty-state">
              <div class="empty-icon">ðŸ“</div>
              <div class="empty-title">No notes ${state.showArchivedNotes ? 'in archive' : 'yet'}</div>
              <div class="empty-text">${state.showArchivedNotes ? 'Archived notes will appear here' : 'Create shared notes for your group'}</div>
            </div>
          ` : `
            <div id="notes-list" style="display: flex; flex-direction: column; gap: 12px;">
              ${activeNotes.map(note => renderNoteCard(note)).join('')}
            </div>
          `}
        `;
      } catch (error) {
        console.error('Error loading notes:', error);
      }
    }
    
    function toggleArchivedNotes() {
      state.showArchivedNotes = !state.showArchivedNotes;
      loadNotesView(state.currentGroupId);
    }

    function renderNoteCard(note) {
      const isPinned = note.is_pinned === 1 || note.is_pinned === true;
      const isLocked = note.is_locked === 1 || note.is_locked === true;
      const isArchived = note.is_archived === 1 || note.is_archived === true;
      
      return `
        <div class="announcement-card note-card" data-note-id="${note.id}" data-note-title="${note.title.toLowerCase()}" style="position: relative; ${isPinned ? 'border-left: 4px solid #FFD700;' : ''} ${isArchived ? 'opacity: 0.6;' : ''}">
          ${isPinned ? '<div style="position: absolute; top: 12px; right: 12px; color: #FFD700; font-size: 18px;">ðŸ“Œ</div>' : ''}
          ${isLocked ? '<div style="position: absolute; top: 12px; right: ' + (isPinned ? '40px' : '12px') + '; color: #ff6b6b; font-size: 18px;">ðŸ”’</div>' : ''}
          <div class="card-header" onclick="openNote(${note.id})">
            <div class="card-info">
              <div class="card-author" style="display: flex; align-items: center; gap: 8px;">
                ${note.title}
                ${isArchived ? '<span style="font-size: 12px; background: var(--ig-secondary-text); padding: 2px 8px; border-radius: 4px; color: var(--ig-primary-background);">ARCHIVED</span>' : ''}
              </div>
              <div class="card-date">${InnovateAPI.formatDate(note.updated_at)} by ${note.updated_by_username || note.created_by_username}</div>
            </div>
          </div>
          <div style="padding: 12px; border-top: 1px solid var(--ig-border); display: flex; gap: 8px; flex-wrap: wrap;">
            ${!isLocked ? `<button onclick="event.stopPropagation(); openNote(${note.id})" class="btn-icon" title="Edit">âœï¸</button>` : ''}
            <button onclick="event.stopPropagation(); togglePinNote(${note.id}, ${!isPinned})" class="btn-icon" title="${isPinned ? 'Unpin' : 'Pin'}">${isPinned ? 'ðŸ“Œ' : 'ðŸ“'}</button>
            <button onclick="event.stopPropagation(); toggleLockNote(${note.id}, ${!isLocked})" class="btn-icon" title="${isLocked ? 'Unlock' : 'Lock'}">${isLocked ? 'ðŸ”“' : 'ðŸ”’'}</button>
            <button onclick="event.stopPropagation(); duplicateNote(${note.id})" class="btn-icon" title="Duplicate">ðŸ“‹</button>
            <button onclick="event.stopPropagation(); shareNote(${note.id})" class="btn-icon" title="Share">ðŸ”—</button>
            <button onclick="event.stopPropagation(); toggleArchiveNote(${note.id}, ${!isArchived})" class="btn-icon" title="${isArchived ? 'Unarchive' : 'Archive'}">${isArchived ? 'ðŸ“¤' : 'ðŸ“¥'}</button>
            <button onclick="event.stopPropagation(); deleteNote(${note.id})" class="btn-icon" title="Delete" style="color: #ff6b6b;">ðŸ—‘ï¸</button>
          </div>
        </div>
      `;
    }

    function filterNotes() {
      const searchInput = document.getElementById('note-search-input');
      if (!searchInput) return;
      
      const searchTerm = searchInput.value.toLowerCase();
      const noteCards = document.querySelectorAll('.note-card');
      
      noteCards.forEach(card => {
        const title = card.getAttribute('data-note-title') || '';
        if (title.includes(searchTerm)) {
          card.style.display = 'block';
        } else {
          card.style.display = 'none';
        }
      });
    }

    async function togglePinNote(noteId, isPinned) {
      try {
        await InnovateAPI.apiRequest(`/community-groups/notes/${noteId}/pin`, {
          method: 'PUT',
          body: JSON.stringify({ is_pinned: isPinned })
        });
        InnovateAPI.showAlert(isPinned ? 'Note pinned!' : 'Note unpinned!', 'success');
        await loadNotesView(state.currentGroupId);
      } catch (error) {
        InnovateAPI.showAlert('Failed to pin note', 'error');
      }
    }

    async function toggleLockNote(noteId, isLocked) {
      try {
        await InnovateAPI.apiRequest(`/community-groups/notes/${noteId}/lock`, {
          method: 'PUT',
          body: JSON.stringify({ is_locked: isLocked })
        });
        InnovateAPI.showAlert(isLocked ? 'Note locked!' : 'Note unlocked!', 'success');
        await loadNotesView(state.currentGroupId);
      } catch (error) {
        InnovateAPI.showAlert('Failed to lock note', 'error');
      }
    }

    async function toggleArchiveNote(noteId, isArchived) {
      try {
        await InnovateAPI.apiRequest(`/community-groups/notes/${noteId}/archive`, {
          method: 'PUT',
          body: JSON.stringify({ is_archived: isArchived })
        });
        InnovateAPI.showAlert(isArchived ? 'Note archived!' : 'Note unarchived!', 'success');
        await loadNotesView(state.currentGroupId);
      } catch (error) {
        InnovateAPI.showAlert('Failed to archive note', 'error');
      }
    }

    async function duplicateNote(noteId) {
      try {
        const res = await InnovateAPI.apiRequest(`/community-groups/notes/${noteId}/duplicate`, {
          method: 'POST'
        });
        InnovateAPI.showAlert('Note duplicated!', 'success');
        await loadNotesView(state.currentGroupId);
      } catch (error) {
        InnovateAPI.showAlert('Failed to duplicate note', 'error');
      }
    }

    async function shareNote(noteId) {
      const noteUrl = `${window.location.origin}/note-editor.html?id=${noteId}`;
      try {
        await navigator.clipboard.writeText(noteUrl);
        InnovateAPI.showAlert('Note link copied to clipboard!', 'success');
      } catch (error) {
        prompt('Copy this link:', noteUrl);
      }
    }

    async function deleteNote(noteId) {
      if (!confirm('Are you sure you want to delete this note? This cannot be undone.')) return;
      
      try {
        await InnovateAPI.apiRequest(`/community-groups/notes/${noteId}`, {
          method: 'DELETE'
        });
        InnovateAPI.showAlert('Note deleted!', 'success');
        await loadNotesView(state.currentGroupId);
      } catch (error) {
        InnovateAPI.showAlert('Failed to delete note', 'error');
      }
    }

    function showCreateNoteModal() {
      showModal(`
        <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 24px; border-radius: 12px 12px 0 0;">
          <div style="display: flex; align-items: center; gap: 12px;">
            <div style="width: 48px; height: 48px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px;">
              ðŸ“
            </div>
            <div>
              <div class="modal-title" style="font-size: 22px; font-weight: 700; margin-bottom: 4px;">Create New Note</div>
              <div style="font-size: 13px; opacity: 0.9;">Add a collaborative note for your group</div>
            </div>
          </div>
          <button class="modal-close" onclick="closeModal()" style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); color: white; border: none; width: 36px; height: 36px; border-radius: 50%; font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;">Ã—</button>
        </div>
        <form onsubmit="createNote(event)" style="padding: 24px;">
          <div style="margin-bottom: 20px;">
            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px; font-weight: 600; font-size: 14px; color: var(--ig-primary-text);">
              <span>ðŸ“Œ</span>
              <span>Note Title *</span>
            </label>
            <input 
              type="text" 
              id="note-title-input" 
              placeholder="e.g., Meeting Notes, Project Ideas, Resources" 
              required 
              autofocus
              style="width: 100%; padding: 14px 16px; border: 2px solid var(--ig-border); border-radius: 12px; background: var(--ig-secondary-background); color: var(--ig-primary-text); font-size: 15px; transition: all 0.2s; outline: none;" 
              onfocus="this.style.borderColor='#667eea'" 
              onblur="this.style.borderColor='var(--ig-border)'"
            />
          </div>
          
          <div style="display: flex; gap: 12px; padding-top: 20px; border-top: 1px solid var(--ig-border);">
            <button type="submit" style="flex: 1; padding: 14px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 12px; font-weight: 700; font-size: 15px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; transition: all 0.2s; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);">
              <i class="fas fa-check-circle"></i> Create Note
            </button>
            <button type="button" onclick="closeModal()" style="padding: 14px 24px; background: var(--ig-secondary-background); color: var(--ig-primary-text); border: 2px solid var(--ig-border); border-radius: 12px; font-weight: 600; font-size: 15px; cursor: pointer; transition: all 0.2s;">
              Cancel
            </button>
          </div>
        </form>
      `);
    }
    
    async function createNote(e) {
      e.preventDefault();
      const title = document.getElementById('note-title-input').value.trim();
      if (!title) return;

      try {
        const res = await InnovateAPI.apiRequest(`/community-groups/${state.currentGroupId}/notes`, {
          method: 'POST',
          body: JSON.stringify({ title, content_md: '' })
        });
        console.log('Note created successfully');
        closeModal();
        openNote(res.note.id);
      } catch (error) {
        console.error('Error creating note:', error);
        InnovateAPI.showAlert('Failed to create note', 'error');
      }
    }

    function openNote(noteId) {
      window.open(`/note-editor.html?id=${noteId}`, '_blank');
    }

    // ==================== MODALS ====================
    function showCreateGroupModal() {
      showModal(`
        <div class="modal-header" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; padding: 24px; border-radius: 12px 12px 0 0;">
          <div style="display: flex; align-items: center; gap: 12px;">
            <div style="width: 48px; height: 48px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px;">
              <i class="fas fa-users"></i>
            </div>
            <div>
              <div class="modal-title" style="font-size: 22px; font-weight: 700; margin-bottom: 4px;">Create New Group</div>
              <div style="font-size: 13px; opacity: 0.9;">Organize your community members</div>
            </div>
          </div>
          <button class="modal-close" onclick="closeModal()" style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); color: white; border: none; width: 36px; height: 36px; border-radius: 50%; font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;">Ã—</button>
        </div>
        <form onsubmit="createGroup(event)" style="padding: 24px;">
          <!-- Group Profile Picture -->
          <div style="margin-bottom: 20px;">
            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px; font-weight: 600; font-size: 14px; color: var(--ig-primary-text);">
              <i class="fas fa-image" style="color: #11998e;"></i>
              <span>Group Picture</span>
              <span style="font-size: 12px; font-weight: 400; color: var(--ig-secondary-text);">(optional)</span>
            </label>
            <div style="display: flex; flex-direction: column; gap: 16px; align-items: center;">
              <div style="position: relative; width: 120px; height: 120px;">
                <img id="groupPicturePreview" src="/images/default-avatar.svg" style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 3px solid var(--ig-border);">
                <button type="button" onclick="document.getElementById('groupPicture').click()" style="position: absolute; bottom: 0; right: 0; width: 36px; height: 36px; background: var(--ig-blue); color: white; border: 2px solid var(--ig-primary-background); border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; transition: all 0.2s;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
                  <i class="fas fa-camera"></i>
                </button>
              </div>
              <input type="file" id="groupPicture" accept="image/*" style="display: none;" onchange="previewGroupPictureWithCrop(event)">
              <div style="text-align: center;">
                <div style="font-size: 13px; color: var(--ig-secondary-text); margin-bottom: 4px;">Click camera to upload and adjust</div>
                <div style="font-size: 12px; color: var(--ig-tertiary-text);">You can crop and rotate your image</div>
              </div>
            </div>
          </div>
          
          <!-- Group Name Input -->
          <div style="margin-bottom: 20px;">
            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px; font-weight: 600; font-size: 14px; color: var(--ig-primary-text);">
              <i class="fas fa-tag" style="color: #11998e;"></i>
              <span>Group Name *</span>
            </label>
            <input type="text" id="groupName" placeholder="e.g., CSE A, Development Team, Study Group" required style="width: 100%; padding: 14px 16px; border: 2px solid var(--ig-border); border-radius: 12px; background: var(--ig-secondary-background); color: var(--ig-primary-text); font-size: 15px; transition: all 0.2s; outline: none;" onfocus="this.style.borderColor='#11998e'" onblur="this.style.borderColor='var(--ig-border)'">
          </div>
          
          <!-- Description Textarea -->
          <div style="margin-bottom: 20px;">
            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px; font-weight: 600; font-size: 14px; color: var(--ig-primary-text);">
              <i class="fas fa-align-left" style="color: #11998e;"></i>
              <span>Description</span>
              <span style="font-size: 12px; font-weight: 400; color: var(--ig-secondary-text);">(optional)</span>
            </label>
            <textarea id="groupDescription" rows="4" placeholder="What is this group about? Who should join?" style="width: 100%; padding: 14px 16px; border: 2px solid var(--ig-border); border-radius: 12px; background: var(--ig-secondary-background); color: var(--ig-primary-text); resize: vertical; font-size: 15px; line-height: 1.6; transition: all 0.2s; outline: none; font-family: inherit;" onfocus="this.style.borderColor='#11998e'" onblur="this.style.borderColor='var(--ig-border)'"></textarea>
          </div>
          
          <!-- Privacy Setting -->
          <div style="margin-bottom: 24px;">
            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px; font-weight: 600; font-size: 14px; color: var(--ig-primary-text);">
              <i class="fas fa-lock" style="color: #11998e;"></i>
              <span>Privacy</span>
            </label>
            <div style="background: var(--ig-secondary-background); border: 2px solid var(--ig-border); border-radius: 12px; padding: 16px;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <div style="font-weight: 600; font-size: 15px; margin-bottom: 4px; color: var(--ig-primary-text);">Public Group</div>
                  <div style="font-size: 13px; color: var(--ig-secondary-text);">Anyone in the community can see and join this group</div>
                </div>
                <div class="ig-toggle-switch active" id="groupPrivacyToggle" onclick="toggleGroupPrivacy()" style="cursor: pointer;">
                  <div class="ig-toggle-slider"></div>
                </div>
              </div>
              <div id="privacyHelpText" style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--ig-border); font-size: 13px; color: var(--ig-secondary-text); display: flex; align-items: start; gap: 8px;">
                <i class="fas fa-globe" style="color: #11998e; margin-top: 2px;"></i>
                <span>This group will be visible in the community groups list</span>
              </div>
            </div>
          </div>
          
          <!-- Action Buttons -->
          <div style="display: flex; gap: 12px; padding-top: 20px; border-top: 1px solid var(--ig-border);">
            <button type="submit" style="flex: 1; padding: 14px 24px; background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; border: none; border-radius: 12px; font-weight: 700; font-size: 15px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; transition: all 0.2s; box-shadow: 0 4px 12px rgba(17, 153, 142, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(17, 153, 142, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(17, 153, 142, 0.3)'">
              <i class="fas fa-check-circle"></i> Create Group
            </button>
            <button type="button" onclick="closeModal()" style="padding: 14px 24px; background: var(--ig-secondary-background); color: var(--ig-primary-text); border: 2px solid var(--ig-border); border-radius: 12px; font-weight: 600; font-size: 15px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#f5576c'; this.style.background='rgba(245, 87, 108, 0.1)'" onmouseout="this.style.borderColor='var(--ig-border)'; this.style.background='var(--ig-secondary-background)'">
              Cancel
            </button>
          </div>
        </form>
      `);
    }

    function previewGroupPicture(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          document.getElementById('groupPicturePreview').src = e.target.result;
        };
        reader.readAsDataURL(file);
      }
    }

    // Create group with crop functionality
    let createGroupCropper = null;
    let croppedCreateGroupImageBlob = null;

    function previewGroupPictureWithCrop(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        showCreateGroupImageCropModal(e.target.result, (croppedBlob) => {
          // Update preview with cropped image
          const previewUrl = URL.createObjectURL(croppedBlob);
          document.getElementById('groupPicturePreview').src = previewUrl;
          croppedCreateGroupImageBlob = croppedBlob;
        });
      };
      reader.readAsDataURL(file);
    }

    function showCreateGroupImageCropModal(imageSrc, onCropComplete) {
      const modal = document.createElement('div');
      modal.className = 'ig-modal-overlay';
      modal.style.zIndex = '10001';
      modal.innerHTML = `
        <div class="ig-modal" style="min-width: 600px; max-width: 90%; max-height: 90vh; overflow: hidden;">
          <div class="modal-header" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; padding: 20px; border-radius: 12px 12px 0 0;">
            <div style="font-size: 18px; font-weight: 700; text-align: center;">
              <i class="fas fa-crop"></i> Adjust Group Picture
            </div>
          </div>
          
          <div style="padding: 20px; background: #000;">
            <div style="max-height: 400px; overflow: hidden;">
              <img id="createGroupCropperImage" src="${imageSrc}" style="max-width: 100%; display: block;">
            </div>
          </div>
          
          <div style="padding: 16px; display: flex; gap: 12px; justify-content: center; background: var(--ig-secondary-background); border-top: 1px solid var(--ig-border);">
            <button onclick="rotateCreateGroupCropperLeft()" style="padding: 10px 16px; background: var(--ig-secondary-background); border: 2px solid var(--ig-border); color: var(--ig-primary-text); border-radius: 8px; cursor: pointer; font-weight: 600;">
              <i class="fas fa-undo"></i> Rotate Left
            </button>
            <button onclick="rotateCreateGroupCropperRight()" style="padding: 10px 16px; background: var(--ig-secondary-background); border: 2px solid var(--ig-border); color: var(--ig-primary-text); border-radius: 8px; cursor: pointer; font-weight: 600;">
              <i class="fas fa-redo"></i> Rotate Right
            </button>
            <button onclick="zoomCreateGroupCropperIn()" style="padding: 10px 16px; background: var(--ig-secondary-background); border: 2px solid var(--ig-border); color: var(--ig-primary-text); border-radius: 8px; cursor: pointer; font-weight: 600;">
              <i class="fas fa-search-plus"></i> Zoom In
            </button>
            <button onclick="zoomCreateGroupCropperOut()" style="padding: 10px 16px; background: var(--ig-secondary-background); border: 2px solid var(--ig-border); color: var(--ig-primary-text); border-radius: 8px; cursor: pointer; font-weight: 600;">
              <i class="fas fa-search-minus"></i> Zoom Out
            </button>
          </div>
          
          <div style="padding: 20px; display: flex; gap: 12px; justify-content: flex-end; border-top: 1px solid var(--ig-border);">
            <button onclick="closeCreateGroupCropModal()" style="padding: 12px 24px; background: var(--ig-secondary-background); border: 2px solid var(--ig-border); color: var(--ig-primary-text); border-radius: 8px; cursor: pointer; font-weight: 600;">
              Cancel
            </button>
            <button onclick="applyCreateGroupCrop()" style="padding: 12px 24px; background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 700;">
              <i class="fas fa-check"></i> Apply
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Initialize cropper
      const image = document.getElementById('createGroupCropperImage');
      createGroupCropper = new Cropper(image, {
        aspectRatio: 1,
        viewMode: 2,
        dragMode: 'move',
        autoCropArea: 1,
        restore: false,
        guides: true,
        center: true,
        highlight: false,
        cropBoxMovable: true,
        cropBoxResizable: true,
        toggleDragModeOnDblclick: false,
      });
      
      // Store callback
      modal.onCropComplete = onCropComplete;
    }

    function rotateCreateGroupCropperLeft() {
      if (createGroupCropper) {
        createGroupCropper.rotate(-90);
      }
    }

    function rotateCreateGroupCropperRight() {
      if (createGroupCropper) {
        createGroupCropper.rotate(90);
      }
    }

    function zoomCreateGroupCropperIn() {
      if (createGroupCropper) {
        createGroupCropper.zoom(0.1);
      }
    }

    function zoomCreateGroupCropperOut() {
      if (createGroupCropper) {
        createGroupCropper.zoom(-0.1);
      }
    }

    function closeCreateGroupCropModal() {
      const modal = document.querySelector('.ig-modal-overlay[style*="10001"]');
      if (modal) {
        if (createGroupCropper) {
          createGroupCropper.destroy();
          createGroupCropper = null;
        }
        modal.remove();
      }
      // Clear file input
      const fileInput = document.getElementById('groupPicture');
      if (fileInput) fileInput.value = '';
    }

    function applyCreateGroupCrop() {
      if (!createGroupCropper) return;
      
      const modal = document.querySelector('.ig-modal-overlay[style*="10001"]');
      
      createGroupCropper.getCroppedCanvas({
        width: 400,
        height: 400,
        imageSmoothingQuality: 'high'
      }).toBlob((blob) => {
        if (modal && modal.onCropComplete) {
          modal.onCropComplete(blob);
        }
        
        if (createGroupCropper) {
          createGroupCropper.destroy();
          createGroupCropper = null;
        }
        
        if (modal) {
          modal.remove();
        }
      }, 'image/jpeg', 0.9);
    }

    // Image crop functionality for group settings
    let groupPictureCropper = null;
    let croppedGroupImageBlob = null;

    function previewSettingsGroupPictureWithCrop(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        showImageCropModal(e.target.result, (croppedBlob) => {
          // Update preview with cropped image
          const previewUrl = URL.createObjectURL(croppedBlob);
          document.getElementById('settingsGroupPicture').src = previewUrl;
          croppedGroupImageBlob = croppedBlob;
        });
      };
      reader.readAsDataURL(file);
    }

    function showImageCropModal(imageSrc, onCropComplete) {
      const modal = document.createElement('div');
      modal.className = 'ig-modal-overlay';
      modal.style.zIndex = '10000';
      modal.innerHTML = `
        <div class="ig-modal" style="min-width: 600px; max-width: 90%; max-height: 90vh; overflow: hidden;">
          <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px 12px 0 0;">
            <div style="font-size: 18px; font-weight: 700; text-align: center;">
              <i class="fas fa-crop"></i> Adjust Image
            </div>
          </div>
          
          <div style="padding: 20px; background: #000;">
            <div style="max-height: 400px; overflow: hidden;">
              <img id="cropperImage" src="${imageSrc}" style="max-width: 100%; display: block;">
            </div>
          </div>
          
          <div style="padding: 16px; display: flex; gap: 12px; justify-content: center; background: var(--ig-secondary-background); border-top: 1px solid var(--ig-border);">
            <button onclick="rotateCropperLeft()" style="padding: 10px 16px; background: var(--ig-secondary-background); border: 2px solid var(--ig-border); color: var(--ig-primary-text); border-radius: 8px; cursor: pointer; font-weight: 600;">
              <i class="fas fa-undo"></i> Rotate Left
            </button>
            <button onclick="rotateCropperRight()" style="padding: 10px 16px; background: var(--ig-secondary-background); border: 2px solid var(--ig-border); color: var(--ig-primary-text); border-radius: 8px; cursor: pointer; font-weight: 600;">
              <i class="fas fa-redo"></i> Rotate Right
            </button>
            <button onclick="zoomCropperIn()" style="padding: 10px 16px; background: var(--ig-secondary-background); border: 2px solid var(--ig-border); color: var(--ig-primary-text); border-radius: 8px; cursor: pointer; font-weight: 600;">
              <i class="fas fa-search-plus"></i> Zoom In
            </button>
            <button onclick="zoomCropperOut()" style="padding: 10px 16px; background: var(--ig-secondary-background); border: 2px solid var(--ig-border); color: var(--ig-primary-text); border-radius: 8px; cursor: pointer; font-weight: 600;">
              <i class="fas fa-search-minus"></i> Zoom Out
            </button>
          </div>
          
          <div style="padding: 20px; display: flex; gap: 12px; justify-content: flex-end; border-top: 1px solid var(--ig-border);">
            <button onclick="closeCropModal()" style="padding: 12px 24px; background: var(--ig-secondary-background); border: 2px solid var(--ig-border); color: var(--ig-primary-text); border-radius: 8px; cursor: pointer; font-weight: 600;">
              Cancel
            </button>
            <button onclick="applyCrop()" style="padding: 12px 24px; background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 700;">
              <i class="fas fa-check"></i> Apply
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Initialize cropper
      const image = document.getElementById('cropperImage');
      groupPictureCropper = new Cropper(image, {
        aspectRatio: 1,
        viewMode: 2,
        dragMode: 'move',
        autoCropArea: 1,
        restore: false,
        guides: true,
        center: true,
        highlight: false,
        cropBoxMovable: true,
        cropBoxResizable: true,
        toggleDragModeOnDblclick: false,
      });
      
      // Store callback
      modal.onCropComplete = onCropComplete;
    }

    function rotateCropperLeft() {
      if (groupPictureCropper) {
        groupPictureCropper.rotate(-90);
      }
    }

    function rotateCropperRight() {
      if (groupPictureCropper) {
        groupPictureCropper.rotate(90);
      }
    }

    function zoomCropperIn() {
      if (groupPictureCropper) {
        groupPictureCropper.zoom(0.1);
      }
    }

    function zoomCropperOut() {
      if (groupPictureCropper) {
        groupPictureCropper.zoom(-0.1);
      }
    }

    function closeCropModal() {
      const modal = document.querySelector('.ig-modal-overlay[style*="10000"]');
      if (modal) {
        if (groupPictureCropper) {
          groupPictureCropper.destroy();
          groupPictureCropper = null;
        }
        modal.remove();
      }
      // Clear file input
      const fileInput = document.getElementById('settingsProfilePicture');
      if (fileInput) fileInput.value = '';
    }

    function applyCrop() {
      if (!groupPictureCropper) return;
      
      const modal = document.querySelector('.ig-modal-overlay[style*="10000"]');
      
      groupPictureCropper.getCroppedCanvas({
        width: 400,
        height: 400,
        imageSmoothingQuality: 'high'
      }).toBlob((blob) => {
        if (modal && modal.onCropComplete) {
          modal.onCropComplete(blob);
        }
        
        if (groupPictureCropper) {
          groupPictureCropper.destroy();
          groupPictureCropper = null;
        }
        
        if (modal) {
          modal.remove();
        }
      }, 'image/jpeg', 0.9);
    }

    // Save group settings function
    async function saveGroupSettings(event, groupId) {
      event.preventDefault();
      
      try {
        const name = document.getElementById('settingsGroupName').value;
        const description = document.getElementById('settingsGroupDescription').value;
        const isPublic = document.getElementById('settingsPrivacyToggle').classList.contains('active') ? 1 : 0;
        
        const formData = new FormData();
        formData.append('name', name);
        formData.append('description', description);
        formData.append('is_public', isPublic);
        
        // Add cropped image if available
        if (croppedGroupImageBlob) {
          formData.append('profile_picture', croppedGroupImageBlob, 'profile_picture.jpg');
        }
        
        const res = await fetch(`${InnovateAPI.API_URL}/community-groups/${groupId}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${InnovateAPI.getToken()}`
          },
          body: formData
        });
        
        const data = await res.json();
        
        if (!res.ok) {
          throw new Error(data.error || 'Failed to update group settings');
        }
        
        InnovateAPI.showAlert('Group settings updated successfully!', 'success');
        
        // Close modal
        const modal = document.querySelector('.ig-modal-overlay');
        if (modal) modal.remove();
        
        // Reset cropped image
        croppedGroupImageBlob = null;
        
        // Reload groups and refresh view
        await loadGroups();
        if (state.currentGroupId === groupId) {
          await selectGroup(groupId);
        }
        
        // Notify via socket
        if (state.socket) {
          state.socket.emit('group:updated', { groupId, communityId: state.communityId });
        }
      } catch (error) {
        console.error('Error saving group settings:', error);
        InnovateAPI.showAlert(error.message, 'error');
      }
    }

    // Switch tabs in group settings
    function switchGroupSettingsTab(tabName) {
      // Update tab buttons
      document.querySelectorAll('.group-settings-tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.dataset.tab === tabName) {
          tab.classList.add('active');
        }
      });
      
      // Show/hide content
      document.querySelectorAll('.group-settings-content').forEach(content => {
        content.style.display = 'none';
      });
      document.getElementById(`${tabName}Tab`).style.display = 'block';
    }

    // Load group members for settings
    async function loadGroupMembers(groupId) {
      try {
        const res = await fetch(`${InnovateAPI.API_URL}/community-groups/${groupId}/members`, {
          headers: {
            'Authorization': `Bearer ${InnovateAPI.getToken()}`
          }
        });
        
        const data = await res.json();
        if (!res.ok) throw new Error(data.error);
        
        const membersList = document.getElementById('membersList');
        if (data.members && data.members.length > 0) {
          membersList.innerHTML = data.members.map(member => `
            <div style="display: flex; align-items: center; gap: 12px; padding: 12px; border: 2px solid var(--ig-border); border-radius: 12px; margin-bottom: 12px;">
              <img src="${member.profile_picture || '/images/default-avatar.svg'}" style="width: 48px; height: 48px; border-radius: 50%; object-fit: cover;">
              <div style="flex: 1;">
                <div style="font-weight: 600;">${member.username}</div>
                <div style="font-size: 13px; color: var(--ig-secondary-text);">${member.role}</div>
              </div>
              ${member.role !== 'admin' ? `
                <button onclick="removeMember(${groupId}, ${member.user_id})" style="padding: 8px 16px; background: var(--ig-error); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                  <i class="fas fa-times"></i> Remove
                </button>
              ` : '<span style="color: var(--ig-secondary-text); font-size: 12px;">Admin</span>'}
            </div>
          `).join('');
        } else {
          membersList.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--ig-secondary-text);">No members yet</div>';
        }
      } catch (error) {
        console.error('Error loading members:', error);
      }
    }

    // Load join requests for settings
    async function loadJoinRequests(groupId) {
      try {
        const res = await fetch(`${InnovateAPI.API_URL}/community-groups/${groupId}/join-requests`, {
          headers: {
            'Authorization': `Bearer ${InnovateAPI.getToken()}`
          }
        });
        
        const data = await res.json();
        if (!res.ok) throw new Error(data.error);
        
        const requestsList = document.getElementById('requestsList');
        const badge = document.getElementById('requestsBadge');
        
        if (data.requests && data.requests.length > 0) {
          badge.textContent = data.requests.length;
          badge.style.display = 'inline';
          
          requestsList.innerHTML = data.requests.map(request => `
            <div style="display: flex; align-items: center; gap: 12px; padding: 12px; border: 2px solid var(--ig-border); border-radius: 12px; margin-bottom: 12px;">
              <img src="${request.profile_picture || '/images/default-avatar.svg'}" style="width: 48px; height: 48px; border-radius: 50%; object-fit: cover;">
              <div style="flex: 1;">
                <div style="font-weight: 600;">${request.username}</div>
                <div style="font-size: 13px; color: var(--ig-secondary-text);">Requested ${InnovateAPI.formatDate(request.created_at)}</div>
              </div>
              <button onclick="approveJoinRequest(${groupId}, ${request.user_id})" style="padding: 8px 16px; background: var(--ig-blue); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; margin-right: 8px;">
                <i class="fas fa-check"></i> Approve
              </button>
              <button onclick="rejectJoinRequest(${groupId}, ${request.user_id})" style="padding: 8px 16px; background: var(--ig-error); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                <i class="fas fa-times"></i> Reject
              </button>
            </div>
          `).join('');
        } else {
          badge.style.display = 'none';
          requestsList.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--ig-secondary-text);">No pending requests</div>';
        }
      } catch (error) {
        console.error('Error loading join requests:', error);
      }
    }

    // Load blocked members for settings
    async function loadBlockedMembers(groupId) {
      try {
        const res = await fetch(`${InnovateAPI.API_URL}/community-groups/${groupId}/blocked`, {
          headers: {
            'Authorization': `Bearer ${InnovateAPI.getToken()}`
          }
        });
        
        const data = await res.json();
        if (!res.ok) throw new Error(data.error);
        
        const blockedList = document.getElementById('blockedList');
        if (data.blocked && data.blocked.length > 0) {
          blockedList.innerHTML = data.blocked.map(user => `
            <div style="display: flex; align-items: center; gap: 12px; padding: 12px; border: 2px solid var(--ig-border); border-radius: 12px; margin-bottom: 12px;">
              <img src="${user.profile_picture || '/images/default-avatar.svg'}" style="width: 48px; height: 48px; border-radius: 50%; object-fit: cover;">
              <div style="flex: 1;">
                <div style="font-weight: 600;">${user.username}</div>
                <div style="font-size: 13px; color: var(--ig-secondary-text);">Blocked ${InnovateAPI.formatDate(user.blocked_at)}</div>
              </div>
              <button onclick="unblockMember(${groupId}, ${user.user_id})" style="padding: 8px 16px; background: var(--ig-blue); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                <i class="fas fa-unlock"></i> Unblock
              </button>
            </div>
          `).join('');
        } else {
          blockedList.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--ig-secondary-text);">No blocked users</div>';
        }
      } catch (error) {
        console.error('Error loading blocked members:', error);
      }
    }

    // Remove member from group
    async function removeMember(groupId, userId) {
      if (!confirm('Are you sure you want to remove this member?')) return;
      
      try {
        const res = await fetch(`${InnovateAPI.API_URL}/community-groups/${groupId}/members/${userId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${InnovateAPI.getToken()}`
          }
        });
        
        const data = await res.json();
        if (!res.ok) throw new Error(data.error);
        
        InnovateAPI.showAlert('Member removed successfully', 'success');
        await loadGroupMembers(groupId);
      } catch (error) {
        console.error('Error removing member:', error);
        InnovateAPI.showAlert(error.message, 'error');
      }
    }

    // Approve join request
    async function approveJoinRequest(groupId, userId) {
      try {
        const res = await fetch(`${InnovateAPI.API_URL}/community-groups/${groupId}/join-requests/${userId}/approve`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${InnovateAPI.getToken()}`
          }
        });
        
        const data = await res.json();
        if (!res.ok) throw new Error(data.error);
        
        InnovateAPI.showAlert('Join request approved', 'success');
        await loadJoinRequests(groupId);
        await loadGroupMembers(groupId);
      } catch (error) {
        console.error('Error approving request:', error);
        InnovateAPI.showAlert(error.message, 'error');
      }
    }

    // Reject join request
    async function rejectJoinRequest(groupId, userId) {
      try {
        const res = await fetch(`${InnovateAPI.API_URL}/community-groups/${groupId}/join-requests/${userId}/reject`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${InnovateAPI.getToken()}`
          }
        });
        
        const data = await res.json();
        if (!res.ok) throw new Error(data.error);
        
        InnovateAPI.showAlert('Join request rejected', 'success');
        await loadJoinRequests(groupId);
      } catch (error) {
        console.error('Error rejecting request:', error);
        InnovateAPI.showAlert(error.message, 'error');
      }
    }

    // Unblock member
    async function unblockMember(groupId, userId) {
      try {
        const res = await fetch(`${InnovateAPI.API_URL}/community-groups/${groupId}/blocked/${userId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${InnovateAPI.getToken()}`
          }
        });
        
        const data = await res.json();
        if (!res.ok) throw new Error(data.error);
        
        InnovateAPI.showAlert('Member unblocked successfully', 'success');
        await loadBlockedMembers(groupId);
      } catch (error) {
        console.error('Error unblocking member:', error);
        InnovateAPI.showAlert(error.message, 'error');
      }
    }

    // Invite Link Modal
    function showInviteLinkModal(groupId) {
      const group = state.groups.find(g => g.id === groupId);
      if (!group) return;
      
      const inviteLink = `${window.location.origin}/community/${state.communityId}?groupId=${groupId}`;
      
      const modal = document.createElement('div');
      modal.className = 'ig-modal-overlay';
      modal.innerHTML = `
        <div class="ig-modal" style="min-width: 500px; max-width: 90%; overflow: hidden;">
          <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 24px; border-radius: 12px 12px 0 0;">
            <div style="text-align: center;">
              <i class="fas fa-link" style="font-size: 32px; margin-bottom: 8px;"></i>
              <div style="font-size: 20px; font-weight: 700;">Invite to ${group.name}</div>
              <div style="font-size: 13px; opacity: 0.9; margin-top: 4px;">Share this link to invite members</div>
            </div>
            <button onclick="this.closest('.ig-modal-overlay').remove()" style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); color: white; border: none; width: 36px; height: 36px; border-radius: 50%; font-size: 24px; cursor: pointer;">Ã—</button>
          </div>
          
          <div style="padding: 24px;">
            <!-- Invite Link -->
            <div style="margin-bottom: 24px;">
              <label style="display: block; font-weight: 600; margin-bottom: 12px; font-size: 14px; color: var(--ig-primary-text);">
                <i class="fas fa-link"></i> Group Invite Link
              </label>
              <div style="display: flex; gap: 12px;">
                <input type="text" id="inviteLinkInput" value="${inviteLink}" readonly style="flex: 1; padding: 12px; border: 2px solid var(--ig-border); border-radius: 8px; background: var(--ig-secondary-background); color: var(--ig-primary-text); font-size: 14px; font-family: monospace;">
                <button onclick="copyInviteLink()" style="padding: 12px 20px; background: var(--ig-blue); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; white-space: nowrap;">
                  <i class="fas fa-copy"></i> Copy
                </button>
              </div>
            </div>
            
            <!-- Share via Apps -->
            <div>
              <label style="display: block; font-weight: 600; margin-bottom: 12px; font-size: 14px; color: var(--ig-primary-text);">
                <i class="fas fa-share-alt"></i> Share via
              </label>
              <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
                <!-- WhatsApp -->
                <div onclick="shareViaWhatsApp('${inviteLink}', '${group.name}')" style="display: flex; flex-direction: column; align-items: center; gap: 8px; padding: 16px; border: 2px solid var(--ig-border); border-radius: 12px; cursor: pointer; transition: all 0.2s; background: var(--ig-secondary-background);" onmouseover="this.style.borderColor='#25D366'; this.style.transform='scale(1.05)'" onmouseout="this.style.borderColor='var(--ig-border)'; this.style.transform='scale(1)'">
                  <div style="width: 48px; height: 48px; background: #25D366; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px;">
                    <i class="fab fa-whatsapp"></i>
                  </div>
                  <div style="font-size: 12px; font-weight: 600; color: var(--ig-primary-text);">WhatsApp</div>
                </div>
                
                <!-- Telegram -->
                <div onclick="shareViaTelegram('${inviteLink}', '${group.name}')" style="display: flex; flex-direction: column; align-items: center; gap: 8px; padding: 16px; border: 2px solid var(--ig-border); border-radius: 12px; cursor: pointer; transition: all 0.2s; background: var(--ig-secondary-background);" onmouseover="this.style.borderColor='#0088cc'; this.style.transform='scale(1.05)'" onmouseout="this.style.borderColor='var(--ig-border)'; this.style.transform='scale(1)'">
                  <div style="width: 48px; height: 48px; background: #0088cc; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px;">
                    <i class="fab fa-telegram-plane"></i>
                  </div>
                  <div style="font-size: 12px; font-weight: 600; color: var(--ig-primary-text);">Telegram</div>
                </div>
                
                <!-- Email -->
                <div onclick="shareViaEmail('${inviteLink}', '${group.name}')" style="display: flex; flex-direction: column; align-items: center; gap: 8px; padding: 16px; border: 2px solid var(--ig-border); border-radius: 12px; cursor: pointer; transition: all 0.2s; background: var(--ig-secondary-background);" onmouseover="this.style.borderColor='#ea4335'; this.style.transform='scale(1.05)'" onmouseout="this.style.borderColor='var(--ig-border)'; this.style.transform='scale(1)'">
                  <div style="width: 48px; height: 48px; background: #ea4335; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px;">
                    <i class="fas fa-envelope"></i>
                  </div>
                  <div style="font-size: 12px; font-weight: 600; color: var(--ig-primary-text);">Email</div>
                </div>
                
                <!-- Twitter/X -->
                <div onclick="shareViaTwitter('${inviteLink}', '${group.name}')" style="display: flex; flex-direction: column; align-items: center; gap: 8px; padding: 16px; border: 2px solid var(--ig-border); border-radius: 12px; cursor: pointer; transition: all 0.2s; background: var(--ig-secondary-background);" onmouseover="this.style.borderColor='#1DA1F2'; this.style.transform='scale(1.05)'" onmouseout="this.style.borderColor='var(--ig-border)'; this.style.transform='scale(1)'">
                  <div style="width: 48px; height: 48px; background: #1DA1F2; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px;">
                    <i class="fab fa-twitter"></i>
                  </div>
                  <div style="font-size: 12px; font-weight: 600; color: var(--ig-primary-text);">Twitter</div>
                </div>
              </div>
            </div>
            
            <!-- QR Code Section -->
            <div style="margin-top: 24px; padding: 20px; background: var(--ig-secondary-background); border: 2px solid var(--ig-border); border-radius: 12px; text-align: center;">
              <div style="font-weight: 600; margin-bottom: 12px; color: var(--ig-primary-text);">
                <i class="fas fa-qrcode"></i> Or scan QR Code
              </div>
              <div id="qrcode" style="display: flex; justify-content: center; margin: 16px 0;"></div>
              <div style="font-size: 12px; color: var(--ig-secondary-text);">
                Scan this code to join the group
              </div>
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Generate QR Code
      if (typeof QRCode !== 'undefined') {
        new QRCode(document.getElementById('qrcode'), {
          text: inviteLink,
          width: 160,
          height: 160,
          colorDark: getComputedStyle(document.documentElement).getPropertyValue('--ig-primary-text').trim(),
          colorLight: getComputedStyle(document.documentElement).getPropertyValue('--ig-secondary-background').trim(),
        });
      }
    }

    function copyInviteLink() {
      const input = document.getElementById('inviteLinkInput');
      input.select();
      document.execCommand('copy');
      InnovateAPI.showAlert('Invite link copied to clipboard!', 'success');
    }

    function shareViaWhatsApp(link, groupName) {
      const text = `Join "${groupName}" group on Innovate Hub: ${link}`;
      const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(text)}`;
      window.open(whatsappUrl, '_blank');
    }

    function shareViaTelegram(link, groupName) {
      const text = `Join "${groupName}" group on Innovate Hub`;
      const telegramUrl = `https://t.me/share/url?url=${encodeURIComponent(link)}&text=${encodeURIComponent(text)}`;
      window.open(telegramUrl, '_blank');
    }

    function shareViaEmail(link, groupName) {
      const subject = `Join "${groupName}" on Innovate Hub`;
      const body = `I'd like to invite you to join the "${groupName}" group on Innovate Hub.\n\nClick here to join: ${link}`;
      const mailtoUrl = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
      window.location.href = mailtoUrl;
    }

    function shareViaTwitter(link, groupName) {
      const text = `Join "${groupName}" group on Innovate Hub`;
      const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(link)}`;
      window.open(twitterUrl, '_blank');
    }

    function toggleGroupPrivacy() {
      const toggle = document.getElementById('groupPrivacyToggle');
      const helpText = document.getElementById('privacyHelpText');
      toggle.classList.toggle('active');
      
      if (toggle.classList.contains('active')) {
        helpText.innerHTML = '<i class="fas fa-globe" style="color: #11998e; margin-top: 2px;"></i><span>This group will be visible in the community groups list</span>';
      } else {
        helpText.innerHTML = '<i class="fas fa-lock" style="color: #f5576c; margin-top: 2px;"></i><span>Only members can see this group. Invite-only access.</span>';
      }
    }

    async function createGroup(e) {
      e.preventDefault();
      const name = document.getElementById('groupName').value;
      const description = document.getElementById('groupDescription').value;
      const isPublic = document.getElementById('groupPrivacyToggle').classList.contains('active') ? 1 : 0;

      try {
        const formData = new FormData();
        formData.append('name', name);
        formData.append('description', description);
        formData.append('is_public', isPublic);
        
        // Use cropped image if available, otherwise use file input
        if (croppedCreateGroupImageBlob) {
          formData.append('profile_picture', croppedCreateGroupImageBlob, 'profile_picture.jpg');
        } else {
          const profilePicture = document.getElementById('groupPicture').files[0];
          if (profilePicture) {
            formData.append('profile_picture', profilePicture);
          }
        }

        const res = await fetch(`${InnovateAPI.API_URL}/communities/${state.communityId}/groups`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${InnovateAPI.getToken()}`
          },
          body: formData
        });

        const data = await res.json();

        if (!res.ok) {
          throw new Error(data.error || 'Failed to create group');
        }
        
        console.log('Group created successfully');
        InnovateAPI.showAlert('Group created successfully!', 'success');
        
        // Reset cropped image blob
        croppedCreateGroupImageBlob = null;
        
        closeModal();
        await loadGroups();
        
        if (state.socket) {
          state.socket.emit('group:new', { communityId: state.communityId });
        }
      } catch (error) {
        console.error('Error creating group:', error);
        InnovateAPI.showAlert(error.message, 'error');
      }
    }
    
    // ==================== ANNOUNCEMENT FUNCTIONS ====================
    function showCreateAnnouncementModal() {
      showModal(`
        <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 24px; border-radius: 12px 12px 0 0;">
          <div style="display: flex; align-items: center; gap: 12px;">
            <div style="width: 48px; height: 48px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px;">
              <i class="fas fa-bullhorn"></i>
            </div>
            <div>
              <div class="modal-title" style="font-size: 22px; font-weight: 700; margin-bottom: 4px;">Create Announcement</div>
              <div style="font-size: 13px; opacity: 0.9;">Share important updates with your community</div>
            </div>
          </div>
          <button class="modal-close" onclick="closeModal()" style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); color: white; border: none; width: 36px; height: 36px; border-radius: 50%; font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;">Ã—</button>
        </div>
        <form onsubmit="createAnnouncement(event)" style="padding: 24px; max-height: 70vh; overflow-y: auto;">
          <!-- Title Input -->
          <div style="margin-bottom: 20px;">
            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px; font-weight: 600; font-size: 14px; color: var(--ig-primary-text);">
              <i class="fas fa-heading" style="color: #667eea;"></i>
              <span>Title *</span>
            </label>
            <input type="text" id="announcementTitle" placeholder="e.g., Important Update, New Event, Community News" required style="width: 100%; padding: 14px 16px; border: 2px solid var(--ig-border); border-radius: 12px; background: var(--ig-secondary-background); color: var(--ig-primary-text); font-size: 15px; transition: all 0.2s; outline: none;" onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='var(--ig-border)'">
          </div>
          
          <!-- Message Textarea -->
          <div style="margin-bottom: 20px;">
            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px; font-weight: 600; font-size: 14px; color: var(--ig-primary-text);">
              <i class="fas fa-align-left" style="color: #667eea;"></i>
              <span>Message *</span>
            </label>
            <textarea id="announcementMessage" rows="5" placeholder="Write your announcement message here... Be clear and concise." required style="width: 100%; padding: 14px 16px; border: 2px solid var(--ig-border); border-radius: 12px; background: var(--ig-secondary-background); color: var(--ig-primary-text); resize: vertical; font-size: 15px; line-height: 1.6; transition: all 0.2s; outline: none; font-family: inherit;" onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='var(--ig-border)'"></textarea>
          </div>
          
          <!-- Attachments -->
          <div style="margin-bottom: 20px;">
            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px; font-weight: 600; font-size: 14px; color: var(--ig-primary-text);">
              <i class="fas fa-paperclip" style="color: #667eea;"></i>
              <span>Attachments</span>
              <span style="font-size: 12px; font-weight: 400; color: var(--ig-secondary-text);">(optional)</span>
            </label>
            <div style="position: relative; border: 2px dashed var(--ig-border); border-radius: 12px; padding: 24px; text-align: center; background: var(--ig-secondary-background); transition: all 0.2s; cursor: pointer;" onmouseover="this.style.borderColor='#667eea'" onmouseout="this.style.borderColor='var(--ig-border)'">
              <input type="file" id="announcementFiles" multiple accept="image/*,video/*,.pdf,.doc,.docx" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer;" onchange="handleAnnouncementFilesChange(event)">
              <div style="pointer-events: none;">
                <div style="width: 56px; height: 56px; margin: 0 auto 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 14px; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px;">
                  <i class="fas fa-cloud-upload-alt"></i>
                </div>
                <div style="font-weight: 600; margin-bottom: 6px; color: var(--ig-primary-text);">Choose Files or Drag & Drop</div>
                <div style="font-size: 13px; color: var(--ig-secondary-text); display: flex; align-items: center; justify-content: center; gap: 6px; flex-wrap: wrap;">
                  <span><i class="fas fa-image"></i> Images</span>
                  <span>â€¢</span>
                  <span><i class="fas fa-video"></i> Videos</span>
                  <span>â€¢</span>
                  <span><i class="fas fa-file-pdf"></i> PDFs</span>
                  <span>â€¢</span>
                  <span><i class="fas fa-file-word"></i> Documents</span>
                </div>
              </div>
            </div>
            
            <!-- Selected Files Preview -->
            <div id="announcementFilesPreview" style="display: none; margin-top: 16px; padding: 16px; background: var(--ig-primary-background); border: 1px solid var(--ig-border); border-radius: 12px;">
              <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                <div style="font-weight: 600; font-size: 14px; color: var(--ig-primary-text);">
                  <i class="fas fa-file-alt" style="color: #667eea;"></i>
                  <span id="announcementFilesCount">0 files selected</span>
                </div>
                <button type="button" onclick="clearAnnouncementFiles()" style="padding: 6px 12px; background: var(--ig-error); color: white; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; transition: opacity 0.2s;" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">
                  <i class="fas fa-times"></i> Clear All
                </button>
              </div>
              <div id="announcementFilesList" style="display: grid; gap: 8px; max-height: 200px; overflow-y: auto;"></div>
            </div>
          </div>
          
          <!-- Links Section -->
          <div style="margin-bottom: 20px;">
            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px; font-weight: 600; font-size: 14px; color: var(--ig-primary-text);">
              <i class="fas fa-link" style="color: #667eea;"></i>
              <span>Links</span>
              <span style="font-size: 12px; font-weight: 400; color: var(--ig-secondary-text);">(optional)</span>
            </label>
            <div id="announcementLinks" style="margin-bottom: 12px;"></div>
            <button type="button" onclick="addAnnouncementLink()" style="width: 100%; padding: 12px; background: var(--ig-secondary-background); border: 2px dashed var(--ig-border); border-radius: 10px; color: var(--ig-primary-text); font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px;" onmouseover="this.style.borderColor='#667eea'; this.style.background='rgba(102, 126, 234, 0.1)'" onmouseout="this.style.borderColor='var(--ig-border)'; this.style.background='var(--ig-secondary-background)'">
              <i class="fas fa-plus-circle"></i> Add Link
            </button>
          </div>
          
          <!-- Location Section -->
          <div style="margin-bottom: 24px; padding: 16px; background: var(--ig-secondary-background); border-radius: 12px; border: 1px solid var(--ig-border);">
            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
              <input type="checkbox" id="announcementAddLocation" onchange="toggleAnnouncementLocation()" style="width: 20px; height: 20px; cursor: pointer; accent-color: #667eea;">
              <div style="display: flex; align-items: center; gap: 8px; font-weight: 600; font-size: 14px;">
                <i class="fas fa-map-marker-alt" style="color: #f5576c;"></i>
                <span>Add Location</span>
              </div>
            </label>
            <div id="announcementLocationInput" style="display: none; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--ig-border);">
              <input type="text" id="announcementLocationName" placeholder="Location name (e.g., Main Campus, Conference Room)" style="width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid var(--ig-border); border-radius: 10px; background: var(--ig-primary-background); color: var(--ig-primary-text); outline: none;">
              <input type="text" id="announcementLocationAddress" placeholder="Full address" style="width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid var(--ig-border); border-radius: 10px; background: var(--ig-primary-background); color: var(--ig-primary-text); outline: none;">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                <input type="number" step="any" id="announcementLocationLat" placeholder="Latitude" style="padding: 12px; border: 1px solid var(--ig-border); border-radius: 10px; background: var(--ig-primary-background); color: var(--ig-primary-text); outline: none;">
                <input type="number" step="any" id="announcementLocationLng" placeholder="Longitude" style="padding: 12px; border: 1px solid var(--ig-border); border-radius: 10px; background: var(--ig-primary-background); color: var(--ig-primary-text); outline: none;">
              </div>
              <button type="button" onclick="getCurrentLocation()" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(245, 87, 108, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                <i class="fas fa-crosshairs"></i> Use Current Location
              </button>
            </div>
          </div>
          
          <!-- Poll Section -->
          <div style="margin-bottom: 24px; padding: 16px; background: var(--ig-secondary-background); border-radius: 12px; border: 1px solid var(--ig-border);">
            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
              <input type="checkbox" id="announcementAddPoll" onchange="toggleAnnouncementPoll()" style="width: 20px; height: 20px; cursor: pointer; accent-color: #667eea;">
              <div style="display: flex; align-items: center; gap: 8px; font-weight: 600; font-size: 14px;">
                <i class="fas fa-poll" style="color: #4facfe;"></i>
                <span>Add Poll</span>
              </div>
            </label>
            <div id="announcementPollInput" style="display: none; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--ig-border);">
              <input type="text" id="pollQuestion" placeholder="Poll question (e.g., What's your favorite feature?)" style="width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid var(--ig-border); border-radius: 10px; background: var(--ig-primary-background); color: var(--ig-primary-text); outline: none; font-weight: 600;">
              <div id="pollOptions" style="margin-bottom: 12px;"></div>
              <button type="button" onclick="addPollOption()" style="width: 100%; padding: 10px; background: var(--ig-secondary-background); border: 2px dashed var(--ig-border); border-radius: 8px; color: var(--ig-primary-text); font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 6px; font-size: 13px;" onmouseover="this.style.borderColor='#4facfe'; this.style.background='rgba(79, 172, 254, 0.1)'" onmouseout="this.style.borderColor='var(--ig-border)'; this.style.background='var(--ig-secondary-background)'">
                <i class="fas fa-plus-circle"></i> Add Option
              </button>
            </div>
          </div>
          
          <!-- Action Buttons -->
          <div style="display: flex; gap: 12px; padding-top: 20px; border-top: 1px solid var(--ig-border);">
            <button type="submit" style="flex: 1; padding: 14px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 12px; font-weight: 700; font-size: 15px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; transition: all 0.2s; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.3)'">
              <i class="fas fa-paper-plane"></i> Post Announcement
            </button>
            <button type="button" onclick="closeModal()" style="padding: 14px 24px; background: var(--ig-secondary-background); color: var(--ig-primary-text); border: 2px solid var(--ig-border); border-radius: 12px; font-weight: 600; font-size: 15px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#f5576c'; this.style.background='rgba(245, 87, 108, 0.1)'" onmouseout="this.style.borderColor='var(--ig-border)'; this.style.background='var(--ig-secondary-background)'">
              Cancel
            </button>
          </div>
        </form>
      `);
    }
    
    let announcementLinkCounter = 0;
    function addAnnouncementLink() {
      const container = document.getElementById('announcementLinks');
      announcementLinkCounter++;
      const linkId = `link_${announcementLinkCounter}`;
      
      const linkDiv = document.createElement('div');
      linkDiv.id = linkId;
      linkDiv.style.cssText = 'margin-bottom: 12px; padding: 16px; background: var(--ig-secondary-background); border-radius: 12px; border: 2px solid var(--ig-border);';
      linkDiv.innerHTML = `
        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
          <div style="flex: 1;">
            <input type="text" class="announcement-link-title" placeholder="Link title (e.g., Event Page, Registration Form)" style="width: 100%; padding: 12px; border: 1px solid var(--ig-border); border-radius: 10px; background: var(--ig-primary-background); color: var(--ig-primary-text); outline: none;">
          </div>
          <button type="button" onclick="document.getElementById('${linkId}').remove()" style="width: 44px; height: 44px; background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%); color: white; border: none; border-radius: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
            <i class="fas fa-trash"></i>
          </button>
        </div>
        <div style="position: relative;">
          <i class="fas fa-globe" style="position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: var(--ig-secondary-text);"></i>
          <input type="url" class="announcement-link-url" placeholder="https://example.com" style="width: 100%; padding: 12px 12px 12px 40px; border: 1px solid var(--ig-border); border-radius: 10px; background: var(--ig-primary-background); color: var(--ig-primary-text); outline: none;">
        </div>
      `;
      container.appendChild(linkDiv);
    }
    
    function toggleAnnouncementLocation() {
      const checkbox = document.getElementById('announcementAddLocation');
      const locationInput = document.getElementById('announcementLocationInput');
      locationInput.style.display = checkbox.checked ? 'block' : 'none';
    }
    
    function getCurrentLocation() {
      if (!navigator.geolocation) {
        console.error('Geolocation not supported');
        return;
      }
      
      navigator.geolocation.getCurrentPosition(
        (position) => {
          document.getElementById('announcementLocationLat').value = position.coords.latitude;
          document.getElementById('announcementLocationLng').value = position.coords.longitude;
          console.log('Location detected:', position.coords.latitude, position.coords.longitude);
        },
        (error) => {
          console.error('Could not get location:', error.message);
        }
      );
    }
    
    // Poll functions
    function toggleAnnouncementPoll() {
      const checkbox = document.getElementById('announcementAddPoll');
      const pollInput = document.getElementById('announcementPollInput');
      pollInput.style.display = checkbox.checked ? 'block' : 'none';
      
      // Add default 2 options when enabling poll
      if (checkbox.checked) {
        const container = document.getElementById('pollOptions');
        if (container.children.length === 0) {
          addPollOption();
          addPollOption();
        }
      }
    }
    
    let pollOptionCounter = 0;
    function addPollOption() {
      const container = document.getElementById('pollOptions');
      pollOptionCounter++;
      const optionId = `pollOption_${pollOptionCounter}`;
      
      const optionDiv = document.createElement('div');
      optionDiv.id = optionId;
      optionDiv.style.cssText = 'display: flex; gap: 8px; margin-bottom: 8px;';
      optionDiv.innerHTML = `
        <div style="width: 28px; height: 40px; display: flex; align-items: center; justify-content: center; background: var(--ig-secondary-background); border: 1px solid var(--ig-border); border-radius: 8px; font-size: 12px; font-weight: 700; color: var(--ig-secondary-text);">
          ${container.children.length + 1}
        </div>
        <input type="text" class="poll-option-text" placeholder="Option ${container.children.length + 1}" style="flex: 1; padding: 10px 12px; border: 1px solid var(--ig-border); border-radius: 8px; background: var(--ig-primary-background); color: var(--ig-primary-text); outline: none; font-size: 14px;">
        ${container.children.length >= 2 ? `
          <button type="button" onclick="document.getElementById('${optionId}').remove(); updatePollOptionNumbers()" style="width: 40px; height: 40px; background: var(--ig-error); color: white; border: none; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: opacity 0.2s;" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">
            <i class="fas fa-times"></i>
          </button>
        ` : ''}
      `;
      container.appendChild(optionDiv);
    }
    
    function updatePollOptionNumbers() {
      const container = document.getElementById('pollOptions');
      Array.from(container.children).forEach((div, index) => {
        const numberEl = div.querySelector('div');
        if (numberEl) numberEl.textContent = index + 1;
        const input = div.querySelector('input');
        if (input && !input.value) input.placeholder = `Option ${index + 1}`;
      });
    }
    
    // Poll voting functions
    function renderPollResults(announcementId, poll) {
      const votes = poll.votes || [];
      const totalVotes = votes.length;
      const voteCounts = new Array(poll.options.length).fill(0);
      
      // Count votes
      votes.forEach(vote => {
        if (vote.optionIndex >= 0 && vote.optionIndex < voteCounts.length) {
          voteCounts[vote.optionIndex]++;
        }
      });
      
      // Check if current user has voted
      const currentUserId = InnovateAPI.getCurrentUser()?.id;
      const userVote = votes.find(v => v.userId === currentUserId);
      const userVotedIndex = userVote ? userVote.optionIndex : -1;
      
      return `
        <div style="background: var(--ig-secondary-background); border: 2px solid var(--ig-border); border-radius: 12px; padding: 20px;">
          <div style="font-size: 16px; font-weight: 700; margin-bottom: 16px; color: var(--ig-primary-text);">${poll.question}</div>
          <div style="display: flex; flex-direction: column; gap: 12px;">
            ${poll.options.map((option, index) => {
              const count = voteCounts[index];
              const percentage = totalVotes > 0 ? Math.round((count / totalVotes) * 100) : 0;
              const isUserVote = index === userVotedIndex;
              const borderColor = isUserVote ? '#4facfe' : 'var(--ig-border)';
              
              return `
                <div 
                  onclick="votePoll(${announcementId}, ${index})" 
                  style="position: relative; background: var(--ig-primary-background); border: 2px solid ${borderColor}; border-radius: 10px; padding: 14px 16px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 12px; overflow: hidden;"
                  onmouseover="if (!${isUserVote}) this.style.borderColor='#4facfe'; this.style.transform='translateX(4px)'" 
                  onmouseout="if (!${isUserVote}) this.style.borderColor='var(--ig-border)'; this.style.transform='translateX(0)'"
                >
                  <!-- Progress bar background -->
                  <div style="position: absolute; left: 0; top: 0; height: 100%; width: ${percentage}%; background: linear-gradient(135deg, rgba(79, 172, 254, 0.15) 0%, rgba(0, 242, 254, 0.15) 100%); transition: width 0.3s ease; border-radius: 8px;"></div>
                  
                  <!-- Content -->
                  <div style="position: relative; width: 28px; height: 28px; border-radius: 50%; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 13px; flex-shrink: 0;">${index + 1}</div>
                  <div style="position: relative; flex: 1; font-size: 15px; font-weight: 500; color: var(--ig-primary-text);">${option}</div>
                  ${totalVotes > 0 ? `
                    <div style="position: relative; font-size: 14px; font-weight: 600; color: var(--ig-secondary-text); margin-right: 8px;">${count} (${percentage}%)</div>
                  ` : ''}
                  ${isUserVote ? `
                    <i class="fas fa-check-circle" style="position: relative; color: #4facfe; font-size: 18px;"></i>
                  ` : `
                    <i class="far fa-circle" style="position: relative; color: var(--ig-secondary-text); font-size: 18px;"></i>
                  `}
                </div>
              `;
            }).join('')}
          </div>
          <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--ig-border); font-size: 13px; color: var(--ig-secondary-text); text-align: center;">
            ${totalVotes === 0 ? `
              <i class="fas fa-info-circle"></i> Be the first to vote!
            ` : `
              <i class="fas fa-chart-bar"></i> ${totalVotes} ${totalVotes === 1 ? 'vote' : 'votes'} total
            `}
          </div>
        </div>
      `;
    }
    
    async function votePoll(announcementId, optionIndex) {
      try {
        const response = await InnovateAPI.apiRequest(
          `/communities/${state.communityId}/announcements/${announcementId}/vote`,
          {
            method: 'POST',
            body: JSON.stringify({ optionIndex })
          }
        );
        
        if (response.success) {
          console.log('Vote recorded successfully');
          
          // Reload the announcement to show updated results
          viewAnnouncement(announcementId);
        }
      } catch (error) {
        console.error('Error voting:', error);
        alert('Failed to record vote: ' + error.message);
      }
    }
    
    // File handling functions for announcements
    let announcementFiles = [];
    
    function handleAnnouncementFilesChange(event) {
      const newFiles = Array.from(event.target.files);
      
      if (newFiles.length === 0) {
        // User cancelled - keep existing files
        if (announcementFiles.length === 0) {
          document.getElementById('announcementFilesPreview').style.display = 'none';
        }
        return;
      }
      
      // Add new files to accumulated list (avoid duplicates by name)
      newFiles.forEach(newFile => {
        const isDuplicate = announcementFiles.some(f => f.name === newFile.name && f.size === newFile.size);
        if (!isDuplicate) {
          announcementFiles.push(newFile);
        }
      });
      
      // Update the file input with all accumulated files
      const dt = new DataTransfer();
      announcementFiles.forEach(file => dt.items.add(file));
      event.target.files = dt.files;
      
      // Update preview
      updateFilesPreview();
    }
    
    function updateFilesPreview() {
      const files = announcementFiles;
      
      if (files.length === 0) {
        document.getElementById('announcementFilesPreview').style.display = 'none';
        return;
      }
      
      const preview = document.getElementById('announcementFilesPreview');
      const filesList = document.getElementById('announcementFilesList');
      const filesCount = document.getElementById('announcementFilesCount');
      
      preview.style.display = 'block';
      filesCount.textContent = `${files.length} file${files.length > 1 ? 's' : ''} selected`;
      
      filesList.innerHTML = '';
      
      files.forEach((file, index) => {
        const fileDiv = document.createElement('div');
        fileDiv.style.cssText = 'display: flex; align-items: center; gap: 12px; padding: 10px 12px; background: var(--ig-secondary-background); border: 1px solid var(--ig-border); border-radius: 8px; transition: all 0.2s;';
        fileDiv.onmouseover = function() { this.style.background = 'var(--ig-hover)'; };
        fileDiv.onmouseout = function() { this.style.background = 'var(--ig-secondary-background)'; };
        
        // Determine file type icon
        const ext = file.name.split('.').pop().toLowerCase();
        let icon = 'fa-file';
        let iconColor = '#888';
        
        if (['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg'].includes(ext)) {
          icon = 'fa-image';
          iconColor = '#667eea';
        } else if (['mp4', 'mov', 'webm', 'avi'].includes(ext)) {
          icon = 'fa-video';
          iconColor = '#f5576c';
        } else if (ext === 'pdf') {
          icon = 'fa-file-pdf';
          iconColor = '#e74c3c';
        } else if (['doc', 'docx'].includes(ext)) {
          icon = 'fa-file-word';
          iconColor = '#2b579a';
        }
        
        const fileSize = (file.size / 1024).toFixed(1);
        const sizeUnit = fileSize > 1024 ? `${(fileSize / 1024).toFixed(1)} MB` : `${fileSize} KB`;
        
        fileDiv.innerHTML = `
          <div style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: ${iconColor}15; border-radius: 8px;">
            <i class="fas ${icon}" style="font-size: 18px; color: ${iconColor};"></i>
          </div>
          <div style="flex: 1; min-width: 0;">
            <div style="font-weight: 600; font-size: 13px; color: var(--ig-primary-text); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${file.name}">${file.name}</div>
            <div style="font-size: 12px; color: var(--ig-secondary-text);">${sizeUnit}</div>
          </div>
          <button type="button" onclick="removeAnnouncementFile(${index})" style="width: 32px; height: 32px; background: var(--ig-error); color: white; border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: opacity 0.2s; flex-shrink: 0;" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'" title="Remove file">
            <i class="fas fa-times"></i>
          </button>
        `;
        
        filesList.appendChild(fileDiv);
      });
    }
    
    function removeAnnouncementFile(index) {
      // Remove from accumulated files array
      announcementFiles.splice(index, 1);
      
      // Update the file input
      const filesInput = document.getElementById('announcementFiles');
      const dt = new DataTransfer();
      announcementFiles.forEach(file => dt.items.add(file));
      filesInput.files = dt.files;
      
      // Update preview
      updateFilesPreview();
    }
    
    function clearAnnouncementFiles() {
      const filesInput = document.getElementById('announcementFiles');
      filesInput.value = '';
      accumulatedFiles = [];
      document.getElementById('announcementFilesPreview').style.display = 'none';
      document.getElementById('announcementFilesList').innerHTML = '';
    }
    
    async function createAnnouncement(e) {
      e.preventDefault();
      
      const title = document.getElementById('announcementTitle').value;
      const message = document.getElementById('announcementMessage').value;
      const filesInput = document.getElementById('announcementFiles');
      
      // Collect links
      const links = [];
      document.querySelectorAll('#announcementLinks > div').forEach(linkDiv => {
        const titleInput = linkDiv.querySelector('.announcement-link-title');
        const urlInput = linkDiv.querySelector('.announcement-link-url');
        if (titleInput.value && urlInput.value) {
          links.push({ title: titleInput.value, url: urlInput.value });
        }
      });
      
      // Collect location
      let location = null;
      if (document.getElementById('announcementAddLocation').checked) {
        const name = document.getElementById('announcementLocationName').value;
        const address = document.getElementById('announcementLocationAddress').value;
        const lat = parseFloat(document.getElementById('announcementLocationLat').value);
        const lng = parseFloat(document.getElementById('announcementLocationLng').value);
        
        if (lat && lng) {
          location = { name, address, lat, lng };
        }
      }
      
      // Collect poll
      let poll = null;
      if (document.getElementById('announcementAddPoll').checked) {
        const question = document.getElementById('pollQuestion').value;
        const options = [];
        document.querySelectorAll('.poll-option-text').forEach(input => {
          if (input.value.trim()) {
            options.push(input.value.trim());
          }
        });
        
        if (question && options.length >= 2) {
          poll = { question, options };
        }
      }
      
      try {
        const formData = new FormData();
        formData.append('title', title);
        formData.append('body', message);
        
        // Add files
        if (filesInput.files.length > 0) {
          for (let i = 0; i < filesInput.files.length; i++) {
            formData.append('files', filesInput.files[i]);
          }
        }
        
        // Add structured data
        const attachmentsData = { links, location, poll, files: [] };
        formData.append('attachments', JSON.stringify(attachmentsData));
        
        const res = await fetch(`/api/communities/${state.communityId}/announcements`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${InnovateAPI.getToken()}` },
          body: formData
        });
        
        const data = await res.json();
        
        if (data.success) {
          console.log('Announcement posted successfully');
          
          // Clear the form
          document.getElementById('announcementTitle').value = '';
          document.getElementById('announcementMessage').value = '';
          clearAnnouncementFiles();
          announcementFiles = []; // Clear accumulated announcement files
          document.getElementById('announcementLinks').innerHTML = '';
          document.getElementById('announcementAddLocation').checked = false;
          toggleAnnouncementLocation();
          document.getElementById('announcementAddPoll').checked = false;
          document.getElementById('pollOptions').innerHTML = '';
          toggleAnnouncementPoll();
          
          closeModal();
          await loadAnnouncements();
          
          if (state.socket) {
            state.socket.emit('announcement:new', { communityId: state.communityId });
          }
        } else {
          throw new Error(data.error || 'Failed to create announcement');
        }
      } catch (error) {
        console.error('Error creating announcement:', error);
      }
    }
    
    async function pinAnnouncement(announcementId, isPinned) {
      try {
        await InnovateAPI.apiRequest(`/communities/${state.communityId}/announcements/${announcementId}`, {
          method: 'PATCH',
          body: JSON.stringify({ is_pinned: isPinned })
        });
        
        console.log(isPinned ? 'Announcement pinned' : 'Announcement unpinned');
        await loadAnnouncements();
        
        if (state.socket) {
          state.socket.emit('announcement:pinned', { communityId: state.communityId, announcementId, isPinned });
        }
      } catch (error) {
        console.error('Error pinning announcement:', error);
      }
    }
    
    async function deleteAnnouncement(announcementId) {
      if (!confirm('Are you sure you want to delete this announcement?')) return;
      
      try {
        await InnovateAPI.apiRequest(`/communities/${state.communityId}/announcements/${announcementId}`, {
          method: 'DELETE'
        });
        
        console.log('Announcement deleted successfully');
        state.currentAnnouncementId = null;
        await loadAnnouncements();
      } catch (error) {
        console.error('Error deleting announcement:', error);
      }
    }

    async function editAnnouncement(announcementId) {
      try {
        // Get current announcement data
        const response = await InnovateAPI.apiRequest(`/communities/${state.communityId}/announcements`);
        const ann = response.announcements.find(a => a.id == announcementId);
        
        if (!ann) {
          alert('Announcement not found');
          return;
        }

        // Show edit modal
        showModal(`
          <div class="modal-header" style="background: linear-gradient(135deg, #00a8ff 0%, #0081cc 100%); color: white; padding: 24px; border-radius: 12px 12px 0 0;">
            <div style="display: flex; align-items: center; gap: 12px;">
              <div style="width: 48px; height: 48px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px;">
                <i class="fas fa-edit"></i>
              </div>
              <div>
                <div class="modal-title" style="font-size: 22px; font-weight: 700; margin-bottom: 4px;">Edit Announcement</div>
                <div style="font-size: 13px; opacity: 0.9;">Update announcement content</div>
              </div>
            </div>
            <button class="modal-close" onclick="closeModal()" style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); color: white; border: none; width: 36px; height: 36px; border-radius: 50%; font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;">Ã—</button>
          </div>
          <div style="padding: 24px;">
            <form id="editAnnouncementForm" onsubmit="event.preventDefault(); saveEditedAnnouncement(${announcementId})">
              <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--ig-primary-text);">
                  <i class="fas fa-heading"></i> Title
                </label>
                <input 
                  type="text" 
                  id="editTitle" 
                  value="${ann.title.replace(/"/g, '&quot;')}" 
                  required
                  style="width: 100%; padding: 12px; border: 2px solid var(--ig-border); border-radius: 10px; background: var(--ig-secondary-background); color: var(--ig-primary-text); font-size: 15px;"
                />
              </div>
              
              <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--ig-primary-text);">
                  <i class="fas fa-align-left"></i> Content
                </label>
                <textarea 
                  id="editBody" 
                  rows="6" 
                  style="width: 100%; padding: 12px; border: 2px solid var(--ig-border); border-radius: 10px; background: var(--ig-secondary-background); color: var(--ig-primary-text); font-size: 15px; resize: vertical; font-family: inherit;"
                >${ann.body || ''}</textarea>
              </div>
              
              <div style="display: flex; gap: 12px; justify-content: flex-end;">
                <button type="button" onclick="closeModal()" style="padding: 12px 24px; background: var(--ig-secondary-background); border: 2px solid var(--ig-border); border-radius: 10px; color: var(--ig-primary-text); font-weight: 600; cursor: pointer;">
                  Cancel
                </button>
                <button type="submit" style="padding: 12px 24px; background: linear-gradient(135deg, #00a8ff 0%, #0081cc 100%); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                  <i class="fas fa-save"></i> Save Changes
                </button>
              </div>
            </form>
          </div>
        `);
      } catch (error) {
        console.error('Error loading announcement for edit:', error);
        alert('Failed to load announcement');
      }
    }

    async function saveEditedAnnouncement(announcementId) {
      const title = document.getElementById('editTitle').value.trim();
      const body = document.getElementById('editBody').value.trim();

      if (!title) {
        alert('Title is required');
        return;
      }

      try {
        await InnovateAPI.apiRequest(`/communities/${state.communityId}/announcements/${announcementId}`, {
          method: 'PATCH',
          body: JSON.stringify({ title, body })
        });

        console.log('Announcement updated successfully');
        closeModal();
        await loadAnnouncements();
        viewAnnouncement(announcementId);
      } catch (error) {
        console.error('Error updating announcement:', error);
        alert('Failed to update announcement');
      }
    }

    function showModal(content) {
      const container = document.getElementById('modalsContainer');
      container.innerHTML = `
        <div class="modal-overlay" onclick="if(event.target===this) closeModal()">
          <div class="modal-content">
            ${content}
          </div>
        </div>
      `;
    }

    function closeModal() {
      document.getElementById('modalsContainer').innerHTML = '';
    }

    // ==================== GITHUB INTEGRATION ====================
    function showGitHubIntegration() {
      showModal(`
        <div class="modal-header" style="background: linear-gradient(135deg, #24292e 0%, #6e5494 100%); color: white; padding: 24px; border-radius: 12px 12px 0 0;">
          <div style="display: flex; align-items: center; gap: 12px;">
            <div style="width: 48px; height: 48px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px;">
              <i class="fab fa-github"></i>
            </div>
            <div>
              <div class="modal-title" style="font-size: 22px; font-weight: 700; margin-bottom: 4px;">GitHub Integration</div>
              <div style="font-size: 13px; opacity: 0.9;">Connect your repository</div>
            </div>
          </div>
          <button class="modal-close" onclick="closeModal()" style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); color: white; border: none; width: 36px; height: 36px; border-radius: 50%; font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;">Ã—</button>
        </div>
        <div style="padding: 24px;">
          ${state.githubIntegration ? `
            <div style="padding: 20px; background: var(--ig-secondary-background); border-radius: 12px; border: 2px solid #28a745; margin-bottom: 20px;">
              <div style="display: flex; align-items: center; gap: 16px;">
                <div style="width: 56px; height: 56px; background: linear-gradient(135deg, #24292e 0%, #6e5494 100%); border-radius: 14px; display: flex; align-items: center; justify-content: center; color: white; font-size: 28px;">
                  <i class="fab fa-github"></i>
                </div>
                <div style="flex: 1;">
                  <div style="font-weight: 700; font-size: 16px; margin-bottom: 4px; color: var(--ig-primary-text);">${state.githubIntegration.org || state.githubIntegration.repo}</div>
                  <div style="display: flex; align-items: center; gap: 6px; font-size: 14px; color: #28a745;">
                    <i class="fas fa-check-circle"></i>
                    <span style="font-weight: 600;">Connected</span>
                  </div>
                </div>
              </div>
            </div>
            <button onclick="disconnectGitHub()" style="width: 100%; padding: 14px 24px; background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white; border: none; border-radius: 12px; font-weight: 700; font-size: 15px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; transition: all 0.2s; box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(220, 53, 69, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(220, 53, 69, 0.3)'">
              <i class="fas fa-unlink"></i> Disconnect GitHub
            </button>
          ` : `
            <div style="text-align: center; padding: 40px 20px;">
              <div style="width: 96px; height: 96px; margin: 0 auto 20px; background: linear-gradient(135deg, #24292e 0%, #6e5494 100%); border-radius: 20px; display: flex; align-items: center; justify-content: center; color: white; font-size: 48px;">
                <i class="fab fa-github"></i>
              </div>
              <h3 style="margin-bottom: 12px; font-size: 20px; font-weight: 700; color: var(--ig-primary-text);">Connect GitHub Repository</h3>
              <p style="color: var(--ig-secondary-text); margin-bottom: 28px; font-size: 14px; line-height: 1.6; max-width: 400px; margin-left: auto; margin-right: auto;">
                Link your GitHub repository to manage code, issues, and pull requests directly from the community
              </p>
              <button onclick="connectGitHub()" style="padding: 14px 32px; background: linear-gradient(135deg, #24292e 0%, #6e5494 100%); color: white; border: none; border-radius: 12px; font-weight: 700; font-size: 15px; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 10px; transition: all 0.2s; box-shadow: 0 4px 12px rgba(36, 41, 46, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(36, 41, 46, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(36, 41, 46, 0.3)'">
                <i class="fab fa-github"></i> Connect GitHub
              </button>
            </div>
          `}
        </div>
      `);
    }

    function connectGitHub() {
      console.log('GitHub OAuth flow coming soon!');
      // Implement GitHub OAuth
    }

    function disconnectGitHub() {
      state.githubIntegration = null;
      console.log('GitHub disconnected');
      closeModal();
    }

    function openGitHubRepos() {
      if (!state.githubIntegration) {
        showGitHubIntegration();
        return;
      }
      console.log('Showing GitHub repositories...');
      // Implement GitHub repo browser
    }

    // ==================== UTILITY FUNCTIONS ====================
    async function inviteMembers() {
      const link = `${window.location.origin}/communities?join=${state.communityId}`;
      const title = state.community ? `Join ${state.community.name} on Innovate Hub` : 'Join Community on Innovate Hub';
      const text = state.community ? `Hey! Check out ${state.community.name} community on Innovate Hub` : 'Join this awesome community!';
      
      // Try native share API (works on mobile)
      if (navigator.share) {
        try {
          await navigator.share({
            title: title,
            text: text,
            url: link
          });
          console.log('Shared successfully');
        } catch (error) {
          // User cancelled or error
          if (error.name !== 'AbortError') {
            console.log('Share failed, copying to clipboard');
            navigator.clipboard.writeText(link);
            console.log('Invite link copied:', link);
          }
        }
      } else {
        // Fallback: Show share modal with options
        showShareModal(link, title, text);
      }
    }
    
    function showShareModal(link, title, text) {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div style="background: var(--ig-secondary-background); border-radius: 16px; padding: 24px; max-width: 450px; width: 90%;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="margin: 0; font-size: 18px; font-weight: 700;">Share Community</h3>
            <button onclick="this.closest('.modal-overlay').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--ig-secondary-text); padding: 0; width: 32px; height: 32px;">&times;</button>
          </div>
          
          <div style="background: var(--ig-primary-background); padding: 12px 16px; border-radius: 8px; margin-bottom: 20px; display: flex; align-items: center; gap: 12px; border: 1px solid var(--ig-border);">
            <input type="text" value="${link}" readonly style="flex: 1; background: none; border: none; color: var(--ig-primary-text); font-size: 14px; outline: none;">
            <button onclick="navigator.clipboard.writeText('${link}'); console.log('Link copied'); this.innerHTML='<i class=\\'fas fa-check\\'></i> Copied'; setTimeout(() => this.innerHTML='<i class=\\'fas fa-copy\\'></i> Copy', 2000)" style="padding: 8px 16px; background: var(--ig-blue); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; white-space: nowrap;">
              <i class="fas fa-copy"></i> Copy
            </button>
          </div>
          
          <div style="margin-bottom: 16px;">
            <div style="font-size: 14px; font-weight: 600; margin-bottom: 12px; color: var(--ig-secondary-text);">Share via</div>
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
              <a href="https://wa.me/?text=${encodeURIComponent(text + ' ' + link)}" target="_blank" style="display: flex; flex-direction: column; align-items: center; gap: 8px; text-decoration: none; color: var(--ig-primary-text); padding: 16px; background: var(--ig-primary-background); border-radius: 12px; border: 1px solid var(--ig-border); transition: all 0.2s;" onmouseover="this.style.borderColor='#25D366'; this.style.background='rgba(37, 211, 102, 0.1)'" onmouseout="this.style.borderColor='var(--ig-border)'; this.style.background='var(--ig-primary-background)'">
                <i class="fab fa-whatsapp" style="font-size: 28px; color: #25D366;"></i>
                <span style="font-size: 12px;">WhatsApp</span>
              </a>
              
              <a href="https://t.me/share/url?url=${encodeURIComponent(link)}&text=${encodeURIComponent(text)}" target="_blank" style="display: flex; flex-direction: column; align-items: center; gap: 8px; text-decoration: none; color: var(--ig-primary-text); padding: 16px; background: var(--ig-primary-background); border-radius: 12px; border: 1px solid var(--ig-border); transition: all 0.2s;" onmouseover="this.style.borderColor='#0088cc'; this.style.background='rgba(0, 136, 204, 0.1)'" onmouseout="this.style.borderColor='var(--ig-border)'; this.style.background='var(--ig-primary-background)'">
                <i class="fab fa-telegram" style="font-size: 28px; color: #0088cc;"></i>
                <span style="font-size: 12px;">Telegram</span>
              </a>
              
              <a href="https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(link)}" target="_blank" style="display: flex; flex-direction: column; align-items: center; gap: 8px; text-decoration: none; color: var(--ig-primary-text); padding: 16px; background: var(--ig-primary-background); border-radius: 12px; border: 1px solid var(--ig-border); transition: all 0.2s;" onmouseover="this.style.borderColor='#1DA1F2'; this.style.background='rgba(29, 161, 242, 0.1)'" onmouseout="this.style.borderColor='var(--ig-border)'; this.style.background='var(--ig-primary-background)'">
                <i class="fab fa-twitter" style="font-size: 28px; color: #1DA1F2;"></i>
                <span style="font-size: 12px;">Twitter</span>
              </a>
              
              <a href="mailto:?subject=${encodeURIComponent(title)}&body=${encodeURIComponent(text + '\n\n' + link)}" style="display: flex; flex-direction: column; align-items: center; gap: 8px; text-decoration: none; color: var(--ig-primary-text); padding: 16px; background: var(--ig-primary-background); border-radius: 12px; border: 1px solid var(--ig-border); transition: all 0.2s;" onmouseover="this.style.borderColor='#ea4335'; this.style.background='rgba(234, 67, 53, 0.1)'" onmouseout="this.style.borderColor='var(--ig-border)'; this.style.background='var(--ig-primary-background)'">
                <i class="fas fa-envelope" style="font-size: 28px; color: #ea4335;"></i>
                <span style="font-size: 12px;">Email</span>
              </a>
              
              <a href="https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(link)}" target="_blank" style="display: flex; flex-direction: column; align-items: center; gap: 8px; text-decoration: none; color: var(--ig-primary-text); padding: 16px; background: var(--ig-primary-background); border-radius: 12px; border: 1px solid var(--ig-border); transition: all 0.2s;" onmouseover="this.style.borderColor='#1877f2'; this.style.background='rgba(24, 119, 242, 0.1)'" onmouseout="this.style.borderColor='var(--ig-border)'; this.style.background='var(--ig-primary-background)'">
                <i class="fab fa-facebook" style="font-size: 28px; color: #1877f2;"></i>
                <span style="font-size: 12px;">Facebook</span>
              </a>
              
              <a href="https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(link)}" target="_blank" style="display: flex; flex-direction: column; align-items: center; gap: 8px; text-decoration: none; color: var(--ig-primary-text); padding: 16px; background: var(--ig-primary-background); border-radius: 12px; border: 1px solid var(--ig-border); transition: all 0.2s;" onmouseover="this.style.borderColor='#0077b5'; this.style.background='rgba(0, 119, 181, 0.1)'" onmouseout="this.style.borderColor='var(--ig-border)'; this.style.background='var(--ig-primary-background)'">
                <i class="fab fa-linkedin" style="font-size: 28px; color: #0077b5;"></i>
                <span style="font-size: 12px;">LinkedIn</span>
              </a>
              
              <a href="https://reddit.com/submit?url=${encodeURIComponent(link)}&title=${encodeURIComponent(title)}" target="_blank" style="display: flex; flex-direction: column; align-items: center; gap: 8px; text-decoration: none; color: var(--ig-primary-text); padding: 16px; background: var(--ig-primary-background); border-radius: 12px; border: 1px solid var(--ig-border); transition: all 0.2s;" onmouseover="this.style.borderColor='#FF4500'; this.style.background='rgba(255, 69, 0, 0.1)'" onmouseout="this.style.borderColor='var(--ig-border)'; this.style.background='var(--ig-primary-background)'">
                <i class="fab fa-reddit" style="font-size: 28px; color: #FF4500;"></i>
                <span style="font-size: 12px;">Reddit</span>
              </a>
              
              <button onclick="navigator.clipboard.writeText('${link}'); console.log('Link copied'); this.innerHTML='<i class=\\'fas fa-check\\'></i><br><span style=\\'font-size: 12px;\\'>Copied!</span>'; setTimeout(() => this.innerHTML='<i class=\\'fas fa-link\\'></i><br><span style=\\'font-size: 12px;\\'>Copy Link</span>', 2000)" style="display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px; padding: 16px; background: var(--ig-primary-background); border-radius: 12px; border: 1px solid var(--ig-border); cursor: pointer; transition: all 0.2s; color: var(--ig-primary-text);" onmouseover="this.style.borderColor='var(--ig-blue)'; this.style.background='rgba(0, 149, 246, 0.1)'" onmouseout="this.style.borderColor='var(--ig-border)'; this.style.background='var(--ig-primary-background)'">
                <i class="fas fa-link" style="font-size: 28px; color: var(--ig-blue);"></i>
                <span style="font-size: 12px;">Copy Link</span>
              </button>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      
      // Copy to clipboard as fallback
      navigator.clipboard.writeText(link);
      console.log('Invite link copied:', link);
    }

    // ==================== COMMUNITY MANAGEMENT ====================
    
    // Edit Community Profile
    function editCommunityProfile() {
      const currentBanner = state.community.banner_image || '';
      const bannerSrc = currentBanner && currentBanner.trim() !== '' 
        ? (currentBanner.startsWith('/') ? currentBanner : `/uploads/community/${currentBanner}`)
        : '';
      
      const modal = document.createElement('div');
      modal.className = 'ig-modal-overlay';
      modal.innerHTML = `
        <div class="ig-modal" style="max-width: 600px;">
          <div style="padding: 24px; border-bottom: 1px solid var(--ig-border);">
            <h3 style="margin: 0; font-size: 20px;">Edit Community Profile</h3>
          </div>
          <div style="padding: 24px;">
            <div style="margin-bottom: 20px;">
              <label style="display: block; font-weight: 600; margin-bottom: 8px;">Community Name</label>
              <input type="text" id="editCommunityName" value="${state.community.name}" 
                style="width: 100%; padding: 12px; border: 1px solid var(--ig-border); border-radius: 8px; background: var(--ig-secondary-background); color: var(--ig-primary-text);">
            </div>
            
            <div style="margin-bottom: 20px;">
              <label style="display: block; font-weight: 600; margin-bottom: 8px;">Description</label>
              <textarea id="editCommunityDesc" rows="4" 
                style="width: 100%; padding: 12px; border: 1px solid var(--ig-border); border-radius: 8px; background: var(--ig-secondary-background); color: var(--ig-primary-text); resize: vertical;">${state.community.description || ''}</textarea>
            </div>
            
            <div style="margin-bottom: 20px;">
              <label style="display: block; font-weight: 600; margin-bottom: 12px;">Community Profile Picture</label>
              ${bannerSrc ? `<div style="position: relative; margin-bottom: 12px; display: flex; justify-content: center;">
                <img src="${bannerSrc}" onerror="this.style.display='none'" style="width: 120px; height: 120px; object-fit: cover; border-radius: 50%; border: 3px solid var(--ig-border);">
              </div>` : ''}
              <button type="button" onclick="selectCommunityBanner()" style="width: 100%; padding: 14px; border: 2px dashed var(--ig-border); border-radius: 8px; background: var(--ig-secondary-background); color: var(--ig-blue); cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; font-weight: 600;">
                <i class="fas fa-camera"></i> ${bannerSrc ? 'Change Profile Picture' : 'Upload Profile Picture'}
              </button>
              <div style="font-size: 12px; color: var(--ig-secondary-text); margin-top: 4px;">Circular profile image. You can adjust the position after uploading.</div>
            </div>
            
            <div style="display: flex; gap: 12px; justify-content: flex-end;">
              <button onclick="this.closest('.ig-modal-overlay').remove()" 
                style="padding: 12px 24px; border: 1px solid var(--ig-border); border-radius: 8px; background: transparent; color: var(--ig-primary-text); cursor: pointer;">
                Cancel
              </button>
              <button onclick="saveCommunityProfile()" 
                style="padding: 12px 24px; border: none; border-radius: 8px; background: var(--ig-blue); color: white; cursor: pointer; font-weight: 600;">
                Save Changes
              </button>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    let communityBannerBlob = null;
    
    function selectCommunityBanner() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
          if (file.size > 5 * 1024 * 1024) {
            InnovateAPI.showAlert('Image size should be less than 5MB', 'error');
            return;
          }
          showCommunityBannerCropper(file);
        }
      };
      input.click();
    }
    window.selectCommunityBanner = selectCommunityBanner;

    let bannerCropper = null;

    function showCommunityBannerCropper(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        const cropperModal = document.createElement('div');
        cropperModal.id = 'banner-cropper-modal';
        cropperModal.style.cssText = `position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.95); z-index: 10001; display: flex; flex-direction: column;`;
        
        cropperModal.innerHTML = `
          <div style="padding: 16px; background: var(--ig-secondary-background); border-bottom: 1px solid var(--ig-border); display: flex; align-items: center; justify-content: space-between;">
            <button onclick="closeBannerCropper()" style="background: none; border: none; color: var(--ig-primary-text); font-size: 16px; cursor: pointer; font-weight: 600;">Cancel</button>
            <h3 style="margin: 0; font-size: 16px; font-weight: 600;">Adjust Profile Photo</h3>
            <button onclick="uploadCroppedBanner()" style="background: none; border: none; color: var(--ig-blue); font-size: 16px; cursor: pointer; font-weight: 600;">Done</button>
          </div>
          <div style="flex: 1; display: flex; align-items: center; justify-content: center; padding: 20px; overflow: hidden;">
            <div style="max-width: 100%; max-height: 100%;">
              <img id="banner-crop-image" src="${e.target.result}" style="max-width: 100%; max-height: calc(100vh - 150px); display: block;">
            </div>
          </div>
          <div style="padding: 16px; background: var(--ig-secondary-background); border-top: 1px solid var(--ig-border); display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
            <button onclick="bannerCropper.rotate(-90)" style="padding: 10px 16px; background: var(--ig-hover); border: 1px solid var(--ig-border); border-radius: 8px; color: var(--ig-primary-text); cursor: pointer; display: flex; align-items: center; gap: 6px;">
              <i class="fas fa-undo"></i> Rotate Left
            </button>
            <button onclick="bannerCropper.rotate(90)" style="padding: 10px 16px; background: var(--ig-hover); border: 1px solid var(--ig-border); border-radius: 8px; color: var(--ig-primary-text); cursor: pointer; display: flex; align-items: center; gap: 6px;">
              <i class="fas fa-redo"></i> Rotate Right
            </button>
            <button onclick="bannerCropper.scaleX(-bannerCropper.getData().scaleX || -1)" style="padding: 10px 16px; background: var(--ig-hover); border: 1px solid var(--ig-border); border-radius: 8px; color: var(--ig-primary-text); cursor: pointer; display: flex; align-items: center; gap: 6px;">
              <i class="fas fa-arrows-alt-h"></i> Flip
            </button>
            <button onclick="bannerCropper.reset()" style="padding: 10px 16px; background: var(--ig-hover); border: 1px solid var(--ig-border); border-radius: 8px; color: var(--ig-primary-text); cursor: pointer; display: flex; align-items: center; gap: 6px;">
              <i class="fas fa-sync"></i> Reset
            </button>
          </div>
        `;
        
        document.body.appendChild(cropperModal);
        
        const image = document.getElementById('banner-crop-image');
        bannerCropper = new Cropper(image, {
          aspectRatio: 1,
          viewMode: 1,
          dragMode: 'move',
          autoCropArea: 1,
          restore: false,
          guides: true,
          center: true,
          highlight: false,
          cropBoxMovable: true,
          cropBoxResizable: true,
        });
      };
      reader.readAsDataURL(file);
    }

    function closeBannerCropper() {
      const modal = document.getElementById('banner-cropper-modal');
      if (modal) {
        if (bannerCropper) {
          bannerCropper.destroy();
          bannerCropper = null;
        }
        modal.remove();
      }
    }
    window.closeBannerCropper = closeBannerCropper;
    window.closeBannerCropper = closeBannerCropper;

    function uploadCroppedBanner() {
      if (!bannerCropper) return;
      
      const canvas = bannerCropper.getCroppedCanvas({
        width: 400,
        height: 400,
        imageSmoothingEnabled: true,
        imageSmoothingQuality: 'high',
      });
      
      canvas.toBlob((blob) => {
        communityBannerBlob = blob;
        closeBannerCropper();
        InnovateAPI.showAlert('Profile photo ready! Click "Save Changes" to update.', 'success');
      }, 'image/jpeg', 0.9);
    }
    window.uploadCroppedBanner = uploadCroppedBanner;
    window.uploadCroppedBanner = uploadCroppedBanner;

    async function saveCommunityProfile() {
      const name = document.getElementById('editCommunityName').value.trim();
      const description = document.getElementById('editCommunityDesc').value.trim();
      
      if (!name) {
        InnovateAPI.showAlert('Community name is required', 'error');
        return;
      }

      try {
        const formData = new FormData();
        formData.append('name', name);
        formData.append('description', description);
        
        if (communityBannerBlob) {
          formData.append('banner', communityBannerBlob, 'banner.jpg');
          console.log('Uploading banner with form data');
        }

        const res = await fetch(`${InnovateAPI.API_URL}/communities/${state.communityId}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${InnovateAPI.getToken()}`
          },
          body: formData
        });

        const data = await res.json();
        console.log('Update response:', data);
        
        if (data.success) {
          // If banner was updated, update state immediately
          if (data.banner_image) {
            console.log('New banner path:', data.banner_image);
            state.community.banner_image = data.banner_image;
          }
          
          InnovateAPI.showAlert('Community profile updated!', 'success');
          document.querySelector('.ig-modal-overlay').remove();
          communityBannerBlob = null;
          
          // Reload community data to reflect changes
          await loadCommunityData();
        } else {
          throw new Error(data.error || 'Failed to update');
        }
      } catch (error) {
        InnovateAPI.showAlert(error.message || 'Failed to update community', 'error');
      }
    }
    window.saveCommunityProfile = saveCommunityProfile;

    // Add Members
    function addMembers() {
      const modal = document.createElement('div');
      modal.className = 'ig-modal-overlay';
      modal.innerHTML = `
        <div class="ig-modal" style="max-width: 500px;">
          <div style="padding: 24px; border-bottom: 1px solid var(--ig-border);">
            <h3 style="margin: 0; font-size: 20px;">Add Members</h3>
          </div>
          <div style="padding: 24px;">
            <div style="margin-bottom: 20px;">
              <label style="display: block; font-weight: 600; margin-bottom: 8px;">Search Users</label>
              <input type="text" id="searchUsers" placeholder="Type username to search..." 
                oninput="searchUsersToAdd()"
                style="width: 100%; padding: 12px; border: 1px solid var(--ig-border); border-radius: 8px; background: var(--ig-secondary-background); color: var(--ig-primary-text);">
            </div>
            
            <div id="searchResults" style="max-height: 300px; overflow-y: auto;"></div>
            
            <div style="display: flex; justify-content: flex-end; margin-top: 20px;">
              <button onclick="this.closest('.ig-modal-overlay').remove()" 
                style="padding: 12px 24px; border: 1px solid var(--ig-border); border-radius: 8px; background: transparent; color: var(--ig-primary-text); cursor: pointer;">
                Close
              </button>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    async function searchUsersToAdd() {
      const query = document.getElementById('searchUsers').value.trim();
      const resultsDiv = document.getElementById('searchResults');
      
      if (query.length < 2) {
        resultsDiv.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--ig-secondary-text);">Type at least 2 characters</div>';
        return;
      }

      try {
        const res = await InnovateAPI.apiRequest(`/search/users?q=${encodeURIComponent(query)}`);
        if (res.success && res.users.length > 0) {
          resultsDiv.innerHTML = res.users.map(user => `
            <div style="display: flex; align-items: center; gap: 12px; padding: 12px; border-bottom: 1px solid var(--ig-border);">
              <img src="${user.profile_picture || '/images/default-avatar.svg'}" 
                style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">
              <div style="flex: 1;">
                <div style="font-weight: 600;">${user.username}</div>
                <div style="font-size: 12px; color: var(--ig-secondary-text);">${user.bio || ''}</div>
              </div>
              <button onclick="inviteUserToCommunity(${user.id})" 
                style="padding: 8px 16px; border: none; border-radius: 6px; background: var(--ig-blue); color: white; cursor: pointer; font-weight: 600;">
                Invite
              </button>
            </div>
          `).join('');
        } else {
          resultsDiv.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--ig-secondary-text);">No users found</div>';
        }
      } catch (error) {
        resultsDiv.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--ig-error);">Error searching users</div>';
      }
    }

    async function inviteUserToCommunity(userId) {
      try {
        const res = await InnovateAPI.apiRequest(`/communities/${state.communityId}/invite`, {
          method: 'POST',
          body: JSON.stringify({ userId })
        });
        
        if (res.success) {
          InnovateAPI.showAlert('Invitation sent!', 'success');
        }
      } catch (error) {
        InnovateAPI.showAlert('Failed to send invitation', 'error');
      }
    }

    // Manage Groups
    function manageGroups() {
      const modal = document.createElement('div');
      modal.className = 'ig-modal-overlay';
      modal.innerHTML = `
        <div class="ig-modal" style="max-width: 700px; max-height: 80vh;">
          <div style="padding: 24px; border-bottom: 1px solid var(--ig-border); display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0; font-size: 20px;">Manage Groups</h3>
            <button onclick="showCreateGroupModal(); this.closest('.ig-modal-overlay').remove();" 
              style="padding: 8px 16px; border: none; border-radius: 6px; background: var(--ig-blue); color: white; cursor: pointer; font-weight: 600;">
              <i class="fas fa-plus"></i> Create Group
            </button>
          </div>
          <div style="padding: 24px; overflow-y: auto; max-height: calc(80vh - 140px);" id="manageGroupsList">
            Loading groups...
          </div>
          <div style="padding: 24px; border-top: 1px solid var(--ig-border); display: flex; justify-content: flex-end;">
            <button onclick="this.closest('.ig-modal-overlay').remove()" 
              style="padding: 12px 24px; border: 1px solid var(--ig-border); border-radius: 8px; background: transparent; color: var(--ig-primary-text); cursor: pointer;">
              Close
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      loadManageGroupsList();
    }

    async function loadManageGroupsList() {
      const listDiv = document.getElementById('manageGroupsList');
      
      if (state.groups.length === 0) {
        listDiv.innerHTML = `
          <div style="padding: 40px; text-align: center; color: var(--ig-secondary-text);">
            <i class="fas fa-users" style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;"></i>
            <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">No groups yet</div>
            <div>Create your first group to get started</div>
          </div>
        `;
        return;
      }

      listDiv.innerHTML = state.groups.map(group => `
        <div style="display: flex; align-items: center; gap: 16px; padding: 16px; border: 1px solid var(--ig-border); border-radius: 12px; margin-bottom: 12px;">
          <div style="width: 48px; height: 48px; border-radius: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 20px;">
            <i class="fas fa-users"></i>
          </div>
          <div style="flex: 1;">
            <div style="font-weight: 600; font-size: 16px;">${group.name}</div>
            <div style="font-size: 13px; color: var(--ig-secondary-text);">${group.description || 'No description'}</div>
          </div>
          <div style="display: flex; gap: 8px;">
            <button onclick="editGroup(${group.id})" 
              style="padding: 8px 16px; border: 1px solid var(--ig-border); border-radius: 6px; background: transparent; color: var(--ig-primary-text); cursor: pointer;">
              <i class="fas fa-edit"></i> Edit
            </button>
            <button onclick="deleteGroup(${group.id}, '${group.name}')" 
              style="padding: 8px 16px; border: 1px solid var(--ig-error); border-radius: 6px; background: transparent; color: var(--ig-error); cursor: pointer;">
              <i class="fas fa-trash"></i> Delete
            </button>
          </div>
        </div>
      `).join('');
    }

    function editGroup(groupId) {
      const group = state.groups.find(g => g.id === groupId);
      if (!group) return;

      const modal = document.createElement('div');
      modal.className = 'ig-modal-overlay';
      modal.innerHTML = `
        <div class="ig-modal" style="max-width: 500px;">
          <div style="padding: 24px; border-bottom: 1px solid var(--ig-border);">
            <h3 style="margin: 0; font-size: 20px;">Edit Group</h3>
          </div>
          <div style="padding: 24px;">
            <div style="margin-bottom: 20px;">
              <label style="display: block; font-weight: 600; margin-bottom: 8px;">Group Name</label>
              <input type="text" id="editGroupName" value="${group.name}" 
                style="width: 100%; padding: 12px; border: 1px solid var(--ig-border); border-radius: 8px; background: var(--ig-secondary-background); color: var(--ig-primary-text);">
            </div>
            
            <div style="margin-bottom: 20px;">
              <label style="display: block; font-weight: 600; margin-bottom: 8px;">Description</label>
              <textarea id="editGroupDesc" rows="3" 
                style="width: 100%; padding: 12px; border: 1px solid var(--ig-border); border-radius: 8px; background: var(--ig-secondary-background); color: var(--ig-primary-text); resize: vertical;">${group.description || ''}</textarea>
            </div>
            
            <div style="display: flex; gap: 12px; justify-content: flex-end;">
              <button onclick="this.closest('.ig-modal-overlay').remove()" 
                style="padding: 12px 24px; border: 1px solid var(--ig-border); border-radius: 8px; background: transparent; color: var(--ig-primary-text); cursor: pointer;">
                Cancel
              </button>
              <button onclick="saveGroupEdit(${groupId})" 
                style="padding: 12px 24px; border: none; border-radius: 8px; background: var(--ig-blue); color: white; cursor: pointer; font-weight: 600;">
                Save
              </button>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    async function saveGroupEdit(groupId) {
      const name = document.getElementById('editGroupName').value.trim();
      const description = document.getElementById('editGroupDesc').value.trim();
      
      if (!name) {
        InnovateAPI.showAlert('Group name is required', 'error');
        return;
      }

      try {
        const res = await InnovateAPI.apiRequest(`/community-groups/${groupId}`, {
          method: 'PUT',
          body: JSON.stringify({ name, description })
        });
        
        if (res.success) {
          InnovateAPI.showAlert('Group updated!', 'success');
          document.querySelector('.ig-modal-overlay').remove();
          await loadGroups();
          loadManageGroupsList();
        }
      } catch (error) {
        InnovateAPI.showAlert('Failed to update group', 'error');
      }
    }

    async function deleteGroup(groupId, groupName) {
      if (!confirm(`Are you sure you want to delete "${groupName}"? This will delete all messages, files, and notes in this group. This action cannot be undone.`)) {
        return;
      }

      try {
        const res = await InnovateAPI.apiRequest(`/community-groups/${groupId}`, {
          method: 'DELETE'
        });
        
        if (res.success) {
          InnovateAPI.showAlert('Group deleted successfully', 'success');
          await loadGroups();
          
          // Close manage groups modal if open and reload
          const manageModal = document.getElementById('manageGroupsList');
          if (manageModal) {
            loadManageGroupsList();
          }
          
          // If deleted group was selected, clear selection
          if (state.currentGroupId === groupId) {
            state.currentGroupId = null;
            switchLeftTab('groups');
          }
        }
      } catch (error) {
        InnovateAPI.showAlert('Failed to delete group', 'error');
      }
    }

    // Community Settings
    function showCommunitySettings() {
      const modal = document.createElement('div');
      modal.className = 'ig-modal-overlay';
      modal.innerHTML = `
        <div class="ig-modal" style="max-width: 600px;">
          <div style="padding: 24px; border-bottom: 1px solid var(--ig-border);">
            <h3 style="margin: 0; font-size: 20px;">Community Settings</h3>
          </div>
          <div style="padding: 24px;">
            <div style="margin-bottom: 24px;">
              <label style="display: flex; align-items: center; justify-content: space-between; cursor: pointer;">
                <div>
                  <div style="font-weight: 600; margin-bottom: 4px;">Private Community</div>
                  <div style="font-size: 13px; color: var(--ig-secondary-text);">Require approval for new members</div>
                </div>
                <input type="checkbox" id="isPrivate" ${state.community.is_public === 0 ? 'checked' : ''} 
                  style="width: 20px; height: 20px; cursor: pointer;">
              </label>
            </div>
            
            <div style="margin-bottom: 24px;">
              <label style="display: block; font-weight: 600; margin-bottom: 8px;">Team Name (Optional)</label>
              <input type="text" id="teamName" value="${state.community.team_name || ''}" placeholder="e.g., Manchester United"
                style="width: 100%; padding: 12px; border: 1px solid var(--ig-border); border-radius: 8px; background: var(--ig-secondary-background); color: var(--ig-primary-text);">
              <div style="font-size: 12px; color: var(--ig-secondary-text); margin-top: 4px;">Display a sports team or organization name</div>
            </div>
            
            <div style="display: flex; gap: 12px; justify-content: flex-end;">
              <button onclick="this.closest('.ig-modal-overlay').remove()" 
                style="padding: 12px 24px; border: 1px solid var(--ig-border); border-radius: 8px; background: transparent; color: var(--ig-primary-text); cursor: pointer;">
                Cancel
              </button>
              <button onclick="saveCommunitySettings()" 
                style="padding: 12px 24px; border: none; border-radius: 8px; background: var(--ig-blue); color: white; cursor: pointer; font-weight: 600;">
                Save Settings
              </button>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    async function saveCommunitySettings() {
      const isPrivate = document.getElementById('isPrivate').checked;
      const teamName = document.getElementById('teamName').value.trim();

      try {
        const res = await InnovateAPI.apiRequest(`/communities/${state.communityId}`, {
          method: 'PUT',
          body: JSON.stringify({
            is_public: isPrivate ? 0 : 1,
            team_name: teamName
          })
        });
        
        if (res.success) {
          InnovateAPI.showAlert('Settings saved!', 'success');
          document.querySelector('.ig-modal-overlay').remove();
          await loadCommunityData();
          
          // Show/hide join requests menu if privacy changed
          updateAdminFeatures();
        }
      } catch (error) {
        InnovateAPI.showAlert('Failed to save settings', 'error');
      }
    }

    // View Members
    function viewMembers() {
      const modal = document.createElement('div');
      modal.className = 'ig-modal-overlay';
      modal.innerHTML = `
        <div class="ig-modal members-modal">
          <div class="members-modal-header">
            <h3 style="margin: 0; font-size: 22px; color: white; font-weight: 700; display: flex; align-items: center; gap: 12px;">
              <i class="fas fa-users"></i>
              Community Members
            </h3>
            <p style="margin: 8px 0 0 0; color: rgba(255,255,255,0.9); font-size: 14px;">Manage your community members and roles</p>
          </div>
          <div class="members-modal-body" id="membersList">
            <div style="text-align: center; padding: 40px;">
              <div class="ig-spinner"></div>
            </div>
          </div>
          <div class="members-modal-footer">
            <div style="font-size: 13px; color: var(--ig-secondary-text);">
              <i class="fas fa-info-circle"></i> Admins have full permissions
            </div>
            <button onclick="this.closest('.ig-modal-overlay').remove()" 
              style="padding: 12px 28px; border: none; border-radius: 10px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; cursor: pointer; font-weight: 600; transition: all 0.2s; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);"
              onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.4)'"
              onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.3)'">
              Close
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      loadMembersList();
    }

    async function loadMembersList() {
      const listDiv = document.getElementById('membersList');
      
      try {
        const res = await InnovateAPI.apiRequest(`/communities/${state.communityId}/members`);
        
        if (res.success && res.members.length > 0) {
          const currentUser = InnovateAPI.getCurrentUser();
          const currentUserMember = res.members.find(m => m.user_id === currentUser.id);
          const isCurrentUserAdmin = currentUserMember && currentUserMember.role === 'admin';
          
          // Helper to format join date properly
          function formatJoinDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { 
              month: 'short', 
              day: 'numeric', 
              year: 'numeric' 
            });
          }
          
          listDiv.innerHTML = `
            <div class="members-grid">
              ${res.members.map(member => {
                const isAdmin = member.role === 'admin';
                const isSelf = member.user_id === currentUser.id;
                const isCreator = member.user_id === state.community.admin_id;
                
                return `
                  <div class="member-card ${isAdmin ? 'member-admin' : ''}">
                    <div class="member-card-header">
                      <div class="member-avatar-wrapper" onclick="window.location.href='/profile/${member.user_id}'">
                        <img src="${member.profile_picture || '/images/default-avatar.svg'}" class="member-avatar">
                        ${member.is_online ? '<div class="member-online-dot"></div>' : ''}
                      </div>
                      
                      <div class="member-info">
                        <div class="member-name">${member.username}</div>
                        <div class="member-badges">
                          ${isSelf ? '<span class="badge badge-you">YOU</span>' : ''}
                          ${isCreator ? '<span class="badge badge-creator"><i class="fas fa-star"></i> CREATOR</span>' : ''}
                        </div>
                      </div>
                    </div>
                    
                    <div class="member-meta">
                      ${isAdmin ? 
                        '<div class="member-role role-admin"><i class="fas fa-crown"></i> ADMIN</div>' 
                        : 
                        '<div class="member-role role-member"><i class="fas fa-user"></i> Member</div>'
                      }
                      <div class="member-joined">
                        <i class="fas fa-calendar-check"></i> ${formatJoinDate(member.joined_at)}
                      </div>
                    </div>
                    
                    ${isCurrentUserAdmin && !isSelf && !isCreator ? `
                      <div class="member-actions">
                        <button onclick="toggleMemberRole(${member.user_id}, '${member.role}', '${member.username}', event)" 
                          class="member-btn ${isAdmin ? 'btn-demote' : 'btn-promote'}">
                          <i class="fas ${isAdmin ? 'fa-user-minus' : 'fa-user-shield'}"></i>
                          ${isAdmin ? 'Demote' : 'Make Admin'}
                        </button>
                        <button onclick="removeMember(${member.user_id}, '${member.username}', event)" 
                          class="member-btn btn-remove">
                          <i class="fas fa-user-times"></i>
                          Remove
                        </button>
                      </div>
                    ` : isCreator && isCurrentUserAdmin ? `
                      <div class="member-protected">
                        <i class="fas fa-lock"></i> Creator cannot be modified
                      </div>
                    ` : ''}
                  </div>
                `;
              }).join('')}
            </div>
          `;
          
          // Update member count badge
          const memberCountBadge = document.getElementById('memberCountBadge');
          if (memberCountBadge) {
            memberCountBadge.textContent = `(${res.members.length})`;
          }
        } else {
          listDiv.innerHTML = `
            <div style="text-align: center; padding: 60px 20px;">
              <div style="font-size: 64px; margin-bottom: 16px; opacity: 0.5;">ðŸ‘¥</div>
              <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px; color: var(--ig-primary-text);">No members found</div>
              <div style="font-size: 14px; color: var(--ig-secondary-text);">Invite members to grow your community</div>
            </div>
          `;
        }
      } catch (error) {
        console.error('Error loading members:', error);
        listDiv.innerHTML = `
          <div style="text-align: center; padding: 60px 20px;">
            <div style="font-size: 64px; margin-bottom: 16px;">âš ï¸</div>
            <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px; color: var(--ig-error);">Failed to load members</div>
            <div style="font-size: 14px; color: var(--ig-secondary-text);">Please try again later</div>
          </div>
        `;
      }
    }

    // Toggle member role (promote/demote)
    async function toggleMemberRole(userId, currentRole, username, event) {
      event.stopPropagation();
      
      const newRole = currentRole === 'admin' ? 'member' : 'admin';
      const action = newRole === 'admin' ? 'promote' : 'demote';
      
      if (!confirm(`Are you sure you want to ${action} ${username} ${newRole === 'admin' ? 'to admin' : 'from admin'}?`)) {
        return;
      }

      try {
        const res = await InnovateAPI.apiRequest(`/communities/${state.communityId}/members/${userId}/role`, {
          method: 'PUT',
          body: JSON.stringify({ role: newRole })
        });
        
        if (res.success) {
          InnovateAPI.showAlert(res.message || `${username} ${action}d successfully!`, 'success');
          loadMembersList(); // Reload the list
        }
      } catch (error) {
        console.error('Error updating role:', error);
        InnovateAPI.showAlert(error.message || 'Failed to update role', 'error');
      }
    }

    // Remove member from community
    async function removeMember(userId, username, event) {
      event.stopPropagation();
      
      if (!confirm(`Are you sure you want to remove ${username} from this community? They will need to be re-invited to join again.`)) {
        return;
      }

      try {
        const res = await InnovateAPI.apiRequest(`/communities/${state.communityId}/members/${userId}`, {
          method: 'DELETE'
        });
        
        if (res.success) {
          InnovateAPI.showAlert(`${username} removed from community`, 'success');
          loadMembersList(); // Reload the list
          await loadCommunityData(); // Update member count
        }
      } catch (error) {
        console.error('Error removing member:', error);
        InnovateAPI.showAlert(error.message || 'Failed to remove member', 'error');
      }
    }

    // Leave Community
    async function leaveCommunity() {
      if (!confirm(`Are you sure you want to leave "${state.community.name}"? You'll need to be re-invited to join again.`)) {
        return;
      }

      try {
        const res = await InnovateAPI.apiRequest(`/communities/${state.communityId}/leave`, {
          method: 'POST'
        });
        
        if (res.success) {
          InnovateAPI.showAlert('You left the community', 'success');
          setTimeout(() => {
            window.location.href = '/communities';
          }, 1000);
        }
      } catch (error) {
        console.error('Error leaving community:', error);
        InnovateAPI.showAlert(error.message || 'Failed to leave community', 'error');
      }
    }

    // Join Requests (Private Communities)
    function showJoinRequests() {
      const modal = document.createElement('div');
      modal.className = 'ig-modal-overlay';
      modal.innerHTML = `
        <div class="ig-modal" style="max-width: 600px; max-height: 80vh;">
          <div style="padding: 24px; border-bottom: 1px solid var(--ig-border);">
            <h3 style="margin: 0; font-size: 20px;">Join Requests</h3>
          </div>
          <div style="padding: 24px; overflow-y: auto; max-height: calc(80vh - 140px);" id="joinRequestsList">
            Loading requests...
          </div>
          <div style="padding: 24px; border-top: 1px solid var(--ig-border); display: flex; justify-content: flex-end;">
            <button onclick="this.closest('.ig-modal-overlay').remove()" 
              style="padding: 12px 24px; border: 1px solid var(--ig-border); border-radius: 8px; background: transparent; color: var(--ig-primary-text); cursor: pointer;">
              Close
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      loadJoinRequests();
    }

    async function loadJoinRequests() {
      const listDiv = document.getElementById('joinRequestsList');
      
      try {
        const res = await InnovateAPI.apiRequest(`/communities/${state.communityId}/join-requests`);
        
        if (res.success && res.requests.length > 0) {
          listDiv.innerHTML = res.requests.map(request => `
            <div style="display: flex; align-items: center; gap: 12px; padding: 16px; border: 1px solid var(--ig-border); border-radius: 12px; margin-bottom: 12px;">
              <img src="${request.profile_picture || '/images/default-avatar.svg'}" 
                style="width: 48px; height: 48px; border-radius: 50%; object-fit: cover;">
              <div style="flex: 1;">
                <div style="font-weight: 600;">${request.username}</div>
                <div style="font-size: 13px; color: var(--ig-secondary-text);">Requested ${InnovateAPI.formatDate(request.requested_at)}</div>
              </div>
              <div style="display: flex; gap: 8px;">
                <button onclick="approveJoinRequest(${request.user_id})" 
                  style="padding: 8px 16px; border: none; border-radius: 6px; background: #10b981; color: white; cursor: pointer; font-weight: 600;">
                  <i class="fas fa-check"></i> Accept
                </button>
                <button onclick="declineJoinRequest(${request.user_id})" 
                  style="padding: 8px 16px; border: 1px solid var(--ig-error); border-radius: 6px; background: transparent; color: var(--ig-error); cursor: pointer;">
                  <i class="fas fa-times"></i> Decline
                </button>
              </div>
            </div>
          `).join('');
        } else {
          listDiv.innerHTML = `
            <div style="padding: 40px; text-align: center; color: var(--ig-secondary-text);">
              <i class="fas fa-user-check" style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;"></i>
              <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">No pending requests</div>
              <div>Join requests will appear here</div>
            </div>
          `;
        }
      } catch (error) {
        listDiv.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--ig-error);">Error loading requests</div>';
      }
    }

    async function approveJoinRequest(userId) {
      try {
        const res = await InnovateAPI.apiRequest(`/communities/${state.communityId}/join-requests/${userId}/approve`, {
          method: 'POST'
        });
        
        if (res.success) {
          InnovateAPI.showAlert('Request approved!', 'success');
          loadJoinRequests();
          updateJoinRequestsBadge();
        }
      } catch (error) {
        InnovateAPI.showAlert('Failed to approve request', 'error');
      }
    }

    async function declineJoinRequest(userId) {
      try {
        const res = await InnovateAPI.apiRequest(`/communities/${state.communityId}/join-requests/${userId}/decline`, {
          method: 'POST'
        });
        
        if (res.success) {
          InnovateAPI.showAlert('Request declined', 'success');
          loadJoinRequests();
          updateJoinRequestsBadge();
        }
      } catch (error) {
        InnovateAPI.showAlert('Failed to decline request', 'error');
      }
    }

    async function updateJoinRequestsBadge() {
      try {
        const res = await InnovateAPI.apiRequest(`/communities/${state.communityId}/join-requests`);
        const badge = document.getElementById('joinRequestsBadge');
        const menuItem = document.getElementById('joinRequestsMenuItem');
        
        if (res.success) {
          const count = res.requests.length;
          badge.textContent = count;
          
          // Show menu item for private communities (even if count is 0)
          if (state.community && state.community.is_public === 0) {
            menuItem.style.display = 'flex';
            
            // Visual indicator: highlight if there are pending requests
            if (count > 0) {
              badge.style.background = 'var(--ig-error)';
              badge.style.display = 'block';
            } else {
              badge.textContent = '0';
              badge.style.background = 'var(--ig-secondary-text)';
              badge.style.display = 'block';
            }
          } else {
            menuItem.style.display = 'none';
          }
        }
      } catch (error) {
        console.error('Error updating join requests badge:', error);
        // Still show the menu for private communities even if request fails
        const menuItem = document.getElementById('joinRequestsMenuItem');
        if (state.community && state.community.is_public === 0 && state.community.admin_id === state.user.id) {
          menuItem.style.display = 'flex';
        }
      }
    }

    // Clear All Announcements
    async function clearAllAnnouncements() {
      if (!confirm('Are you sure you want to delete ALL announcements? This action cannot be undone.')) {
        return;
      }

      try {
        const res = await InnovateAPI.apiRequest(`/communities/${state.communityId}/announcements/clear`, {
          method: 'DELETE'
        });
        
        if (res.success) {
          InnovateAPI.showAlert('All announcements cleared!', 'success');
          await loadAnnouncements();
        }
      } catch (error) {
        InnovateAPI.showAlert('Failed to clear announcements', 'error');
      }
    }

    // Delete Community
    async function deleteCommunity() {
      const communityName = state.community.name;
      
      if (!confirm(`âš ï¸ WARNING: This will permanently delete "${communityName}" and ALL its data including:\n\n- All groups and their messages\n- All announcements\n- All files and notes\n- All member associations\n\nThis action CANNOT be undone!\n\nType the community name to confirm deletion.`)) {
        return;
      }

      const modal = document.createElement('div');
      modal.className = 'ig-modal-overlay';
      modal.innerHTML = `
        <div class="ig-modal" style="max-width: 500px;">
          <div style="padding: 24px; border-bottom: 1px solid var(--ig-border);">
            <h3 style="margin: 0; font-size: 20px; color: var(--ig-error);">
              <i class="fas fa-exclamation-triangle"></i> Delete Community
            </h3>
          </div>
          <div style="padding: 24px;">
            <div style="background: #fee2e2; border: 1px solid var(--ig-error); border-radius: 8px; padding: 16px; margin-bottom: 20px;">
              <div style="font-weight: 600; margin-bottom: 8px; color: #991b1b;">This is permanent and cannot be undone!</div>
              <div style="font-size: 13px; color: #7f1d1d;">Type <strong style="color: #7f1d1d;">${communityName}</strong> to confirm</div>
            </div>
            
            <input type="text" id="confirmCommunityName" placeholder="Type community name here" 
              style="width: 100%; padding: 12px; border: 1px solid var(--ig-border); border-radius: 8px; background: #fef3c7; color: #000000; margin-bottom: 20px; font-weight: 500;">
            
            <div style="display: flex; gap: 12px; justify-content: flex-end;">
              <button onclick="this.closest('.ig-modal-overlay').remove()" 
                style="padding: 12px 24px; border: 1px solid var(--ig-border); border-radius: 8px; background: transparent; color: var(--ig-primary-text); cursor: pointer;">
                Cancel
              </button>
              <button onclick="confirmDeleteCommunity(decodeURIComponent('${encodeURIComponent(communityName)}'))" 
                style="padding: 12px 24px; border: none; border-radius: 8px; background: var(--ig-error); color: white; cursor: pointer; font-weight: 600;">
                <i class="fas fa-trash"></i> Delete Forever
              </button>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    async function confirmDeleteCommunity(expectedName) {
      const inputName = document.getElementById('confirmCommunityName').value.trim();
      
      if (inputName !== expectedName) {
        InnovateAPI.showAlert('Community name does not match', 'error');
        return;
      }

      try {
        const res = await InnovateAPI.apiRequest(`/communities/${state.communityId}`, {
          method: 'DELETE'
        });
        
        if (res.success) {
          InnovateAPI.showAlert('Community deleted', 'success');
          setTimeout(() => {
            window.location.href = '/communities';
          }, 1500);
        }
      } catch (error) {
        InnovateAPI.showAlert('Failed to delete community', 'error');
      }
    }

    // Update admin features visibility
    function updateAdminFeatures() {
      const adminSection = document.getElementById('adminOnlyFeatures');
      const isAdmin = state.community && state.community.admin_id === state.user.id;
      
      if (isAdmin) {
        adminSection.style.display = 'block';
        
        // Show join requests only if community is private
        if (state.community.is_public === 0) {
          updateJoinRequestsBadge();
        }
      } else {
        adminSection.style.display = 'none';
      }
    }

    function viewAllGroups() {
      switchLeftTab('groups');
    }

    function showGroupActions() {
      console.log('Group actions coming soon');
    }

    function setupResponsive() {
      const menuBtn = document.getElementById('menuBtn');
      const leftSidebar = document.getElementById('communityLeft');

      if (window.innerWidth <= 768) {
        menuBtn.style.display = 'block';
      }

      window.addEventListener('resize', () => {
        if (window.innerWidth <= 768) {
          menuBtn.style.display = 'block';
        } else {
          menuBtn.style.display = 'none';
          leftSidebar.classList.remove('mobile-active');
        }
      });
    }

    function toggleLeftSidebar() {
      const centerPanel = document.getElementById('communityCenter');
      if (window.innerWidth <= 768 && centerPanel) {
        centerPanel.classList.toggle('mobile-active');
      }
    }

    function toggleRightSidebar() {
      const rightSidebar = document.getElementById('communityRight');
      if (rightSidebar) {
        rightSidebar.classList.toggle('mobile-active');
      }
    }

    // Theme toggle function
    function toggleTheme() {
      const currentTheme = document.documentElement.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', newTheme);
      localStorage.setItem('ig-theme', newTheme);
      
      // Update icon
      const themeIcon = document.getElementById('themeIcon');
      if (themeIcon) {
        themeIcon.className = newTheme === 'dark' ? 'fas fa-moon' : 'fas fa-sun';
      }
      
      console.log(`Switched to ${newTheme} mode`);
    }

    // Initialize theme icon on page load
    function initializeThemeIcon() {
      const currentTheme = document.documentElement.getAttribute('data-theme') || 'dark';
      const themeIcon = document.getElementById('themeIcon');
      if (themeIcon) {
        themeIcon.className = currentTheme === 'dark' ? 'fas fa-moon' : 'fas fa-sun';
      }
    }

    // WebRTC Handlers (placeholders)
    function handleCallOffer(data) { }
    
    // Format timestamp in IST (India Standard Time)
    function formatTimestampIST(dateString) {
      if (!dateString) return '';
      
      // Parse the date - SQLite returns UTC timestamps
      let date;
      if (dateString.includes('T') || dateString.includes('Z')) {
        // ISO format with timezone
        date = new Date(dateString);
      } else {
        // SQLite format without timezone - treat as UTC
        date = new Date(dateString + 'Z');
      }
      
      const now = new Date();
      
      // Debug logging
      console.log('Timestamp formatting:', {
        input: dateString,
        parsed: date.toISOString(),
        now: now.toISOString(),
        diffMs: now - date
      });
      
      // Calculate difference in milliseconds
      const diffMs = now - date;
      const diffSecs = Math.floor(diffMs / 1000);
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);
      
      // Less than 1 minute
      if (diffSecs < 60) return 'Just now';
      
      // Less than 1 hour
      if (diffMins < 60) return `${diffMins}m ago`;
      
      // Less than 24 hours
      if (diffHours < 24) return `${diffHours}h ago`;
      
      // Less than 7 days
      if (diffDays < 7) return `${diffDays}d ago`;
      
      // Show full date in IST
      const options = { 
        timeZone: 'Asia/Kolkata',
        day: '2-digit',
        month: 'short',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        hour12: true
      };
      
      return date.toLocaleString('en-IN', options);
    }
    
    // Convert URLs in text to clickable links
    function linkify(text, isOwnMessage = false) {
      if (!text) return '';
      
      // URL regex pattern
      const urlRegex = /(https?:\/\/[^\s<]+)/g;
      
      // Use white for own messages, bright cyan for received messages
      const linkColor = isOwnMessage ? '#ffffff' : '#00d4ff';
      const fontWeight = isOwnMessage ? '700' : '600';
      const textShadow = isOwnMessage ? 'text-shadow: 0 1px 2px rgba(0,0,0,0.3);' : '';
      
      return text.replace(urlRegex, (url) => {
        return `<a href="${url}" target="_blank" rel="noopener noreferrer" style="color: ${linkColor}; text-decoration: underline; word-break: break-all; font-weight: ${fontWeight}; ${textShadow}">${url}</a>`;
      });
    }
    
    function renderMessage(msg) {
      // Handle both group_messages (sender_id, sender_username) and community_group_posts (user_id, username)
      const senderId = msg.sender_id || msg.user_id;
      const senderName = msg.sender_username || msg.username || 'User';
      const profilePic = msg.profile_picture || msg.sender_profile_picture || '/images/default-avatar.svg';
      const isOwn = senderId == state.user?.id; // Use == for loose comparison
      const isAdmin = state.userRole === 'admin';
      
      console.log('=== renderMessage called ===');
      console.log('Message ID:', msg.id);
      console.log('Content:', msg.content);
      console.log('Attachments raw:', msg.attachments);
      console.log('Attachments type:', typeof msg.attachments);
      
      // Parse attachments FIRST
      let attachments = [];
      if (msg.attachments) {
        try {
          attachments = typeof msg.attachments === 'string' ? JSON.parse(msg.attachments) : msg.attachments;
          console.log('Parsed attachments:', attachments);
          console.log('Attachments is array:', Array.isArray(attachments));
          console.log('Attachments length:', attachments.length);
          if (attachments.length > 0) {
            console.log('First attachment:', attachments[0]);
          }
        } catch (e) {
          console.error('Error parsing attachments:', e);
        }
      }
      
      // Render attachments HTML
      let attachmentsHTML = '';
      if (attachments && attachments.length > 0) {
        attachmentsHTML = attachments.map((att, index) => {
          console.log(`Rendering attachment ${index}:`, att);
          
          // Handle both formats: string URL or object with properties
          let filepath, filename, type;
          
          if (typeof att === 'string') {
            // Old format: just URL string - clean up any duplicate extensions
            filepath = att.replace(/\.(jpg|jpeg|png|gif|webp)\.[0-9]+$/i, '.$1');
            filename = filepath.split('/').pop();
            type = getFileTypeFromUrl(filepath);
          } else {
            // New format: object with properties
            filepath = (att.filepath || att.url || att.path || '').replace(/\.(jpg|jpeg|png|gif|webp)\.[0-9]+$/i, '.$1');
            filename = att.filename || att.name || 'file';
            type = att.type || att.file_type || getFileTypeFromUrl(filepath);
          }
          
          console.log(`  filepath: ${filepath}`);
          console.log(`  filename: ${filename}`);
          console.log(`  type: ${type}`);
          
          const isImage = type === 'image' || /\.(jpg|jpeg|png|gif|webp)$/i.test(filename);
          const isVideo = type === 'video' || /\.(mp4|mov|webm)$/i.test(filename);
          
          if (isImage) {
            return `<img src="${filepath}" style="max-width: 100%; border-radius: 8px; margin-top: 8px; cursor: pointer;" onclick="window.open('${filepath}', '_blank')" alt="${filename}" />`;
          } else if (isVideo) {
            return `<video controls style="max-width: 100%; border-radius: 8px; margin-top: 8px;"><source src="${filepath}" type="video/mp4"></video>`;
          } else {
            return `
              <a href="${filepath}" target="_blank" style="display: flex; align-items: center; gap: 8px; margin-top: 8px; padding: 8px; background: rgba(0,0,0,0.1); border-radius: 8px; text-decoration: none; color: inherit;">
                <i class="fas fa-file"></i>
                <span>${filename}</span>
              </a>
            `;
          }
        }).join('');
      }
      
      // Helper function to determine file type from URL
      function getFileTypeFromUrl(url) {
        if (!url) return 'file';
        const ext = url.split('.').pop().toLowerCase();
        if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext)) return 'image';
        if (['mp4', 'mov', 'webm'].includes(ext)) return 'video';
        if (['pdf', 'doc', 'docx', 'txt', 'xls', 'xlsx'].includes(ext)) return 'document';
        return 'file';
      }
      
      // Get the actual content text, treating null/undefined as empty string
      let contentText = msg.content || '';
      
      // Decrypt message content if E2E is enabled
      if (contentText && state.currentGroupId) {
        const originalText = contentText;
        contentText = E2EEncryption.decrypt(contentText, state.currentGroupId);
        if (originalText !== contentText) {
          console.log('ðŸ”“ Decrypted message:', originalText.substring(0, 20) + '... â†’ ' + contentText);
        }
      }
      
      const hasContent = contentText && contentText.trim() !== '';
      const editedBadge = msg.is_edited ? '<span style="font-style: italic; opacity: 0.6; margin-left: 4px;">(edited)</span>' : '';
      
      if (isOwn) {
        // Own message - on the right with gradient
        return `
          <div data-post-id="${msg.id}" style="display: flex; justify-content: flex-end; align-items: flex-start; gap: 8px; margin-bottom: 12px;">
            <div style="max-width: 70%;">
              <div style="padding: 12px 16px; border-radius: 18px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <div class="message-content" style="word-wrap: break-word; margin-bottom: 4px;">${hasContent ? linkify(contentText, true) : ''}</div>
                ${attachmentsHTML}
                <div class="message-time" style="font-size: 11px; opacity: 0.8; text-align: right; margin-top: 4px;">
                  ${formatTimestampIST(msg.created_at)}${editedBadge}
                </div>
              </div>
              <div style="display: flex; gap: 8px; justify-content: flex-end; margin-top: 6px;">
                <button onclick="showReactionPicker(${msg.id}, 'message', event)" style="background: none; border: none; color: var(--ig-secondary-text); cursor: pointer; font-size: 16px; padding: 4px 8px;" title="React">
                  <i class="far fa-smile"></i>
                </button>
                <button onclick="showMessageMenu(${msg.id}, true, ${isAdmin}, event)" style="background: none; border: none; color: var(--ig-secondary-text); cursor: pointer; font-size: 16px; padding: 4px 8px;" title="Options">
                  â‹¯
                </button>
              </div>
              <div id="reactions-message-${msg.id}" style="display: flex; gap: 6px; flex-wrap: wrap; margin-top: 6px; justify-content: flex-end;"></div>
            </div>
          </div>
        `;
      } else {
        // Other user's message - on the left with DP
        return `
          <div data-post-id="${msg.id}" class="message-item" style="display: flex; justify-content: flex-start; align-items: flex-start; gap: 8px; margin-bottom: 12px;">
            <img 
              src="${profilePic}" 
              alt="${senderName}"
              onclick="viewUserProfile(${senderId})"
              style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover; cursor: pointer; flex-shrink: 0;"
              title="View ${senderName}'s profile"
            />
            <div style="max-width: 70%;">
              <div style="padding: 12px 16px; border-radius: 18px; background: var(--ig-secondary-background); color: var(--ig-primary-text);">
                <div class="message-author"
                  style="font-weight: 600; font-size: 13px; margin-bottom: 6px; opacity: 0.9; cursor: pointer; color: var(--ig-blue);"
                  onclick="viewUserProfile(${senderId})"
                  title="View profile"
                >
                  ${senderName}
                </div>
                <div class="message-content" style="word-wrap: break-word; margin-bottom: 4px;">${hasContent ? linkify(contentText) : ''}</div>
                ${attachmentsHTML}
                <div class="message-time" style="font-size: 11px; opacity: 0.7; text-align: right; margin-top: 4px;">
                  ${formatTimestampIST(msg.created_at)}${editedBadge}
                </div>
              </div>
              <div style="display: flex; gap: 8px; justify-content: flex-start; margin-top: 6px;">
                <button onclick="showReactionPicker(${msg.id}, 'message', event)" style="background: none; border: none; color: var(--ig-secondary-text); cursor: pointer; font-size: 16px; padding: 4px 8px;" title="React">
                  <i class="far fa-smile"></i>
                </button>
                <button onclick="showMessageMenu(${msg.id}, false, ${isAdmin}, event)" style="background: none; border: none; color: var(--ig-secondary-text); cursor: pointer; font-size: 16px; padding: 4px 8px;" title="Options">
                  â‹¯
                </button>
              </div>
              <div id="reactions-message-${msg.id}" style="display: flex; gap: 6px; flex-wrap: wrap; margin-top: 6px;"></div>
            </div>
          </div>
        `;
      }
    }
    
    function appendChatMessage(msg) {
      console.log('appendChatMessage called with:', msg);
      let list = document.getElementById('messagesList');
      console.log('messagesList element:', list);
      
      // If messagesList doesn't exist, don't append - wait for loadChatView to set it up
      if (!list) {
        console.log('messagesList not found - cannot append message yet');
        return;
      }
      
      const emptyState = list.querySelector('.empty-state');
      if (emptyState) {
        console.log('Removing empty state');
        emptyState.remove();
      }
      
      const messageEl = document.createElement('div');
      messageEl.innerHTML = renderMessage(msg);
      list.appendChild(messageEl.firstElementChild);
      list.scrollTop = list.scrollHeight;
      console.log('Message appended successfully');
    }
    
    // Handle file selection and show preview
    // State to store accumulated files
    let accumulatedFiles = [];
    
    // Handle file selection - CUMULATIVE (adds files instead of replacing)
    function handleFileSelect(event) {
      const fileInput = event.target;
      const chatInput = document.getElementById('chatInput');
      
      if (!fileInput || !chatInput) return;
      
      if (fileInput.files && fileInput.files.length > 0) {
        // ADD new files to existing accumulated files (CUMULATIVE)
        const newFiles = Array.from(fileInput.files);
        accumulatedFiles = accumulatedFiles.concat(newFiles);
        
        console.log(`Added ${newFiles.length} file(s). Total now: ${accumulatedFiles.length}`);
        
        // Show total count in placeholder (no alert popup)
        const fileNames = accumulatedFiles.map(f => f.name).join(', ');
        const truncated = fileNames.length > 40 ? fileNames.substring(0, 40) + '...' : fileNames;
        chatInput.placeholder = `${accumulatedFiles.length} file(s) selected: ${truncated}`;
      } else {
        chatInput.placeholder = 'Type a message...';
      }
    }
    
    // View user profile
    function viewUserProfile(userId) {
      if (!userId) {
        console.error('No userId provided');
        return;
      }
      
      console.log('Opening profile for user:', userId);
      
      // Open profile in new tab
      window.open(`/profile/${userId}`, '_blank');
    }
    
    function handleCallAnswer(data) { }
    function handleIceCandidate(data) { }
    function handlePeerJoined(data) { }
    function handlePeerLeft(data) { }
    function toggleScreenShare() { }
    function attachFile() {
      const input = document.createElement('input');
      input.type = 'file';
      input.multiple = true;
      input.accept = 'image/*,video/*,audio/*,.pdf,.doc,.docx,.txt';
      input.onchange = async (e) => {
        const files = Array.from(e.target.files);
        if (files.length === 0) return;
        
        try {
          const formData = new FormData();
          files.forEach(file => formData.append('attachments', file));
          
          const res = await fetch(`/api/community-groups/${state.currentGroupId}/posts`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${InnovateAPI.getToken()}`
            },
            body: formData
          });
          
          if (!res.ok) {
            console.error('Upload failed:', res.status);
            return;
          }
          
          const data = await res.json();
          if (data.success && data.post) {
            console.log('Files uploaded successfully');
            appendChatMessage(data.post);
          }
        } catch (error) {
          console.error('Error uploading files:', error);
        }
      };
      input.click();
    }
    function editTask(id) { }

    // Listen for note updates from child window (note-editor.html)
    window.addEventListener('message', (event) => {
      if (event.data && event.data.type === 'note-updated') {
        console.log('Note updated message received, refreshing list...');
        console.log('Current view:', state.currentView);
        console.log('Current group:', state.currentGroupId);
        // Refresh notes view if currently viewing notes
        if (state.currentView === 'notes' && state.currentGroupId) {
          // Add small delay to ensure backend has saved
          setTimeout(() => {
            loadNotesView(state.currentGroupId);
          }, 500);
        }
      }
    });
  </script>
  
  <!-- Community Enhancements: Reactions, Comments, Message Actions, Polls -->
  <script src="/js/community-enhancements.js"></script>
  <script>
    // Initialize enhanced features when socket connects
    if (typeof socket !== 'undefined' && socket) {
      setupEnhancedSocketListeners(socket);
    }
  </script>
  
  <!-- Animation CSS for enhanced features -->
  <style>
    @keyframes slideUpFade {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</body>
</html>
